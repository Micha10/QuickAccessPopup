;===============================================
/*

Quick Access Popup
Written using AutoHotkey v1.1.28.00+ (http://autohotkey.com)
By Jean Lalonde (JnLlnd on AHKScript.org forum)

Based on FoldersPopup from the same author
https://github.com/JnLlnd/FoldersPopup
initialy inspired by Robert Ryan's script DirMenu v2 (rbrtryn on AutoHotkey.com forum)
http://www.autohotkey.com/board/topic/91109-favorite-folders-popup-menu-with-gui/
who was maybe inspired by Savage's script FavoriteFolders
http://www.autohotkey.com/docs/scripts/FavoriteFolders.htm
or Rexx version Folder Menu
http://www.autohotkey.com/board/topic/13392-folder-menu-a-popup-menu-to-quickly-change-your-folders/

Copyright 2013-2017 Jean Lalonde
--------------------------------
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

HISTORY
=======

Version BETA: 9.9.2 (2019-07-10)
(Beta 9.9.2.x -> v10)
 
Settings window menu bar
- add a menu bar with "File", "Favorite", "Tools", "Options" and "Help" menus
- make these menus available from the the QAP system menu (right click on QAP icon in Notification zone)
- remove from Settings window various buttons for features and links now available in the menu bar
- remove program title/version at the top of window (keep it in the window title)
 
Settings window keyboard shortcuts
- Ctrl-O opens the new Options window
- Ctrl-E edits selected item (menu or favorites)
- Ctrl-Right now changes the menu in Settings window if a menu is selected or opens the selected favorite
 
Settings window various improvements
- hide the Search box under the submenus dropdown list and add a Search button to show the Search box (the "X" button shows the submenu dropdown list)
- the Search box now filters items from current menu instead of from the top menu (main)
- in items list, remove the "parent menu" item ("..") and make parent menu (up) and previous menu (back) arrows more visible
- add an option under "General" section of the "Options" dialog box to open the "Settings" window at startup (default on)
- when saving a favorite of type folder, document or application, check if the file exists (except if location includes a placeholder {...})
- give feedback to user if a Sort command must stop at a line or column separator
 
Settings Folder
(these changes impact only usera who installed QAP using the Setup executable file)
- for new installations, the default settings folder is now under "My Documents\Quick Access Popup" (instead of user's AppData folder)
- register the Settings Folder in a user's registry key under "HKEY_CURRENT_USER\Software\Jean Lalonde\WorkingFolder"
- Settings folder can be changed in "Options", "General" section, with dialog box asking if user wants to copy actual settings to the new folder or use the settings already in this new location (or create new settings, if necessary)
- after the settings folder content is copied, if an error is detected, display an error message; if it succeded, confirm it and inform user that the original files were *not* deleted
 
Sponsoring
- new dialog box to enter Sponsor code and add the "Enter your sponsor code" menu item to "Help" menu
- Donor code must now matched the sponsor's name displayed at bottom of Settings window (the sponsor name cannot be changed except to change upper/lower case of name)
- remove donation reminders shown at startup for users who did not make a donation
- display a sponsoring reminder when launching a new release for the first time (not in beta releases), for portable installation only (setup installation see a reminder in the setup program)
 
Install/Uninstall
- Setup mode: use the Registry Run key to set QAP as a startup program (delete startup file shortcut)
- Setup mode: when uninstalling QAP, delete from Registry the QAP Run key and QAP Settings folder key
- Portable mode: keep startup file shortcut
 
Various changes
- when in portable mode, add "Run at Startup" menu in QAP system menu (right click on QAP icon in Notification zone)
- in "Options" dialog box, show "Sponsor this software" button only if user is not a sponsor
- when switching Settings file, stop asking for confirmation
- stop display tooltip when refreshing some menus
- support environment variables (like %TEMP%) in new temporary, working and backup folders
 
Internal changes
- implement object oriented data model (using classes, etc.) for favorites data
- keyboard shortcut in QAP menus or dialog boxes (using ampersand "&") are now assigned automatically in any language (except Korean and Chineese); this will simplify the insertion of ampersands (&) in these labels when translating labels
 
Bug fixes
- fix bug ampersand lost in Recent items when numeric shorcuts are enabled
- fix bug about Total Commander ini file not found when saving options
- clean up temporary folders older than 7 days not deleted when quitting QAP (as it should be normally done)
- fix bug when launching a folder with Directory Opus as active file manager but when DOpus is not running, launch DOpus keeping previously saved folders

Version ALPHA: 9.9.1.4 (2019-07-08)
(Alpha: 9.9.0.8 -> 9.9.0.9 -> 9.9.0.10 -> 9.9.1.x (private) -> Beta 9.9.2.x (to be released) -> v10)
- support environment variables in new temporary, working and backup folders
- add "Open QAP Settings Folder" to File menu
- in Setup installation mode only, when moving the settings folder, check that the new folder is not under the current folder (preventing recursive copy)
- in Setup installation mode only, when moving the settings folder, check that settings quickaccesspopup.ini file has same size and that the number of files in the new folder is at least as in old folder; if error, give error message and restore backup folder (if it was changed); if success, confirm the copy and inform user that original files are *not* deleted
- do not reload if moving settings folder was cancelled
- when saving a file favorite, do not check if the file exists if its location includes placeholders
- debug alternative menu features
- debug empty menu label in BuildMenu
- when checking the Donor code, use the Sponsor name case insensitive (allowing user to change the case of the displayed name)

Version ALPHA: 9.9.1.3 (2019-06-24)
- use parameter instead of a global variable to flag if display tooltip when loading favorites or builing menus;
- stop display tooltip when refreshing some menus
- make sure tooltip is removed
- fix bug ampersand lost in Recent items when Numeric shorcuts are enabled (fixed in alpha - will not fix in v9.5)

Version ALPHA: 9.9.1.2 (2019-06-19)
- for pre-v10 users upgrading to this release, stop offering to move settings files and keep it under appdata

Version ALPHA: 9.9.0.10 (2019-06-19)
- fix bug giving error message about Total Commander ini file when saving options

Version: 9.9.0.9 (2019-06-11) 
(pre v9.9.2 and v10 release)
- in anticipation of the launch of Quick Access Popup Alpha release v9.9.2 (expected in the next weeks), changes in release v9.9.0.9 will make things smoother if user installing QAP with the "Setup executable file" needs to revert to previous release after having run v9.9.2 release (this will not be required for users installing QAP with the "portable zip file")
- FYI, only the startup process needed changes in regard with v9.9.2 new startup process
- v9.9.2 settings file will be backward compatible with v9.9.0.9 settings files

Version: 9.5 (2019-06-11)
(Prod: 9.4.1.5 -> 9.5.n -> v10)
- changes to startup process to make this release forward/backward compatible with future release v10 (and alpha v9.9.2)
- add in "Options", "Icon" tab, new chekbox "Retrieve icon when refreshing Frequent folders and Frequent files menus (avoid if you often have offline files)" to bypass icon retrieval when refreshing Frequent items menu; enable this option if you never have offline network files in your Recent Items Windows folder
- fix bug, update the short name for menu when browsing the list of running application in "Add Favorite" for "Application" type
- for Directory Opus users, check if DOpus lister exists before opening a folder in order to protect the last used folders

Version ALPHA: 9.9.1.1 (2019-06-10)
 
Settings window
- add an option under "General" section of "Options" dialog box to open the "Settings" window at startup (default on)
- add a menu bar with "File", "Favorite", "Tools", "Options" and "Help" menus
- give access to menus from menu bar in the QAP system menu (right click on QAP icon in Notification zone)
- add menu entries under "Tools" to activate "Search" and toggle "Extended search"
- Ctrl-O opens the new Options window
- Ctrl-Right now changes the menu in Settings window if a menu is selected or opens the selected favorite
- Ctrl-E edits selected item (menu or favorites)
- give feedback tpo user if sort command must stop at a line or column separator
- when saving a favorite of type folder, document or application, validate if file exists (except if location includes a placeholder {...})
 
Sponsoring
- new dialog box to enter sponsor code and add the "Enter your sponsor code" menu item to "Help" menu
- adapt "Donate" dialog box to new sponsoring language
 
Install/Uninstall
- show startup sponsor message only in portable mode (sponsoring message is also shown in Setup last dialog box)
- Setup mode: replace startup shortcut by using user's registry Run key and delete startup file shortcut and, when unstalling QAP, delete user's QAP Run and QAP Settings folder registry keys
- Portable mode: keep startup file shortcut
 
Internal changes
- keyboard shortcut in QAP menus or dialog boxes (using ampersand "&") are now assigned automatically in any language (except Korean and Chineese); this will simplify the insertion of ampersands (&) in these labels when translating labels
 
Various
- when in portabler mode show "Startup" menu option in QAP system menu (right click on QAP icon in Notification zone)
- in "Options" dialog box, show "Sponsor this software" button only if user is not a sponsor
- when switching Settings file, stop asking for confirmation
 
Bug fixes
- when launching a folder with Directory Opus the active file manager not running, keep previously saved folders in DOpus when launching it

Version ALPHA: 9.9.1 (2019-05-28)
 
Settings window
- remove "parent menu" item (".."), enlarge parent menu (up) and previous menu (back) arrows
- add a Search button to show the Search filter text box instead of the Menu dropdown list
- search box filters item from current menu instead of from main menu
- remove various buttons for features that will be available in the menu bar, remove help links and program title/version at the top of window
 
Settings Folder (Setup installation only - no impact for portable installation)
- for new installations, the default settings folder is now under "My Documents\Quick Access Popup" (instead of user's AppData folder)
- offer pre-v10 user to move settings to the new location (this option will be removed in v9.9.1.1 for safer backward compatibility)
- register the settings folder in a user's registry key under "HKEY_CURRENT_USER\Software\Jean Lalonde\WorkingFolder"
- Settings folder can now be changed in Options, "General" section, with dialog box asking if user wants to copy actual settings to the new folder or use the settings already in this new location (or create new settings, if necessary)
 
Sponsoring
- remove donation reminders shown every n startups
- display a donation reminder when launching a new release for the first time (not for beta or alpha releases)
- add sponsor message at bottom of window with name of sponsor

Internal changes
- implement object oriented data model (using classes, etc.) for favorites data
 
Bug fixes
- fix bug about Total Commander ini file not found when saving options
- clean up temporary folders older than 7 days not deleted when quitting QAP as it should be normally done

Version ALPHA: 9.9.0.8 (2019-04-03)
- changes from master v9.4.1.6 to be released soon)
  - add in "Menu Icon" section of options a new chekbox "Retrieve icons when refreshing Frequent folders and Frequent files menus (avoid if some files are often offline)" to bypass icon retrieval when refreshing Frequent items menu; enable this option if you never have offline network files in your Recent Items Windows folder
  - fix bug: update the short name for menu when browsing the list of running application in "Add Favorite" for "Application" type
- fix bug: display "Collection and refresh interval" option in Database section of Options
- fix broken links in Options
- adjust tray tip if there is only one hotkey (mouse or keyboard) to open popup menu
- rework how settings (ini) file is backuped for main, alternative (using Switch Settings file) and Shared menu ini files: if a value BackupFolder= (under [Global]) is found in the current ini file, make backup in this folder, else make backup in the current ini file folder
- the BackupFolder= value could now be used in Shared menu ini files (under [Global])
- fix bug: favorite type not showing in "Add/Edit Favorite" dialog box header

Version ALPHA: 9.9.0.7 (2019-03-20)
- improvements to the Options dialog box: adding buttons to switch groups of options (similar to tabs, but vertically)
- improve paths validation  for temp folder, backup folder and tray icon file when saving options
- make modal error messages dialog boxes from secondary dialog boxes (like Options or Edit Favorite)
- fix bug not showing hotstring in settings window after editing a favorite
- various internal changes (mostly variable renaming) to classes code

Version ALPHA: 9.9.0.6 (2019-02-28)
- first alpha release with changes in feature
 
Options
- convert Options data structure using OOP approach (class)
- replace the tabs Options dialog box with sepearate dialog boxes for 14 groups of options: "General", "Settings Window", "Menu Icons", "Menu Appearance", "Popup Menu", "Popup Hotkeys", "Alternative Menu Features Hotkeys", "File Managers", "Snippets", "User Variables", "Database" and "Advanced Options" sub menu with "Menus Advanced Options", "Launch Advanced Options" and "Various Advanced Options"
- in Options group dialog box, implement "Save" and "Cancel" buttons with cancel validation if user close the window with unsaved changes
- add to the Options groups some values that were only in the quickaccesspopup.ini file before
- make the "Options" QAP Feature open a menu with options groups
- add option "Align reminders to the right" (default true) in Menu Appearance group to right align shortcut and hotstrings reminders in menus (instead of left align between parenthesis
 
Settings window and Menu bar
- add a menu bar to the Settings window with submenus: "File", "Insert", "Favorite", "Tools", "Options" (the only submenu completely developped for now) and "Help"
- remove the "Options" button and label in Settings window
 
Various
- when QAPconnect is selected in FileManagers group, add a "Refresh list" button to reload the applications list from the QAPconnect.ini file
- fix two Windows 7 Special Folders initialization commands causing a runtime error
- merge changes from regular release v9.4.1.4 and v9.4.1.5

Version: 9.4.1.5 (2019-02-27)
- fix bug when filtering apps in List Applications window and in Current Windows menu when running with a language other than English
- update dropdown menu labels in "List Applications" window (dropdown menu not localized at this time)
- when copying a favorite, keep the original favorite in the item position dropdown list
- make sure the default theme Windows is selected when the value is empty in ini file
- fix link to website in "Check for update" dialog box
- fix bug when searching for "Live" folders type in Settings Extended Search
- fix bug when checking if a favorite app is already running to activate it instead of launching it
- exclude some "ghost" Windows Apps from Current Windows menu (aka Switch menu)

Version: 9.4.1.4 (2019-02-17)
- in the "Easy Setup" installer, removed the optional task to import settings from Folders Popup (ancestor of Quick Access Popup, latest version v5.2.3, September 2016)
- Folders Popup users wanting to convert their settings to Quick Access Popup must first install QAP version v9.4.1.3 (or before), and then upgrade to the latest QAP version
- no change for users doing portable installation with the ZIP file

Version ALPHA: 9.9.0.5 (2019-02-15)
- fix bug in non-English language management
- fix bug with "Use tabs instead of opening new window" option in Directory Opus and Total Commander
- fix bug when moving a Shared menu using the Move button (will be fixed in next regular release too)
- in "Check for update", fix "Visit website" link (will to be fixed in next regular release too)
- in "Check for update", fix change "Change log" link for beta and alpha releases

Version ALPHA: 9.9.0.4 (2019-02-14)
- merge changes from prod release v9.4.1.3

Version: 9.4.1.3 (2019-02-14)
- use custom folder icon from desktop.ini in Live folders top menu item; if there is no dektop.ini file, use the icon defined for the parent Live folder favorite; else use the default icon for Live folders
- in dynamic menus "Current Windows" and "Reopen a folder", use the custom folder icon from desktop.ini if it exists
- fix bug when excluding mouse trigger in a file dialog box and when process name is used as an exclusion criteria
- update to German, Spanish, French, Italian, Korean, Dutch, Portuguese and Brazilian Portuguese language files

Version ALPHA: 9.9.0.3 (2019-02-12)
- rewrite portions of code using object oriented programming (OOP) approach (classes):
  - Settings
  - Language
  - Favorites (types list only)
- adjustments or improvements to existing classes
- enable for all classes debug function to check number of class functions parameters

Version ALPHA: 9.9.0.2 (2019-01-28)
- rewrite portions of code using object oriented programming (OOP) approach (classes):
  - SpecialFolders
  - QAPfeatures
- adjustments or improvements to existing classes
- add a debug function to check number of class functions parameters

Version ALPHA: 9.9.0.1 (2019-01-21)
- first Alpha release including regular release features up to v9.4.1.2
- rewrite portions of code using object oriented programming (OOP) approach (classes):
  - QAP menu popup hotkeys
  - QAP icons (JLicons.dll)
  - File Managers management (Windows Explorer, Directory Opus, Total Commander and others with QAPconnect)
  - Mouse button names
  - Command line parameters

Version: 9.4.1.2 (2019-01-21)
- display a clean error message if user who installed QAP v9.4+ with portable zip file did not update JLicons.dll file to v1.5 (QAP loading icon missing error)
- fix bug when opening group of folders in Directory Opus or Total Commander and the "Use tabs" option is disabled, now open each folder in a new window
- when opening the first folder of a group in Directory Opus, if the app is not running, add a delay after launching it to prevent an intermittent bug leaving the new tab empty
- fix bug when changing hotkey for Alternative menu features leaving previous hotkeys alive until QAP was reloaded
- in "QAP Icon Replacements", support replacement with another QAP icon from JLicons (e.g. "iconFolderLive=iconFolder")
- in "Check for update", add support for Alpha branch, in addition to Beta and Master (prod) branches

Version: 9.4.1.1 (2019-01-10)
- fix bug introduced in v9.4.1 in the "Switch Settings file" command found under the QAP system menu "Settings file options" (right click the QAP icon in the Notification zone)
- when filtering the "Current Windows" menu for exclusions (intruduced in v9.4.1), fix a bug when excluding Windows Applications (Universal Application Platform)
- fix URL of the help link in the "QAP Icons Replacement" dialog box under the "More" tab of "Options"
- fix small bug with localized labels for modifiers in "Change shortcut" dialog box

Version: 9.4.1 (2019-01-04)
 
New features
- QAP Icon Replacements: add new section under the "More" tab of "Options" to set replacements for QAP icons (found in JLicons.dll)
- Current Windows Exclusions: add new section under the "More" tab of "Options" to set application exclusions for the "Current Windows" menu (aka "Switch")
 
Bug fixes
- fix bug in Add/Edit favorite" dialog box "Windows Options" tab having wrong label and "Advanced Settings" being not available
- fix bug when, in "Options", open change shortcut dialog box for alternative menu and hit cancel
 
Other changes
- in "More" tab of "Options" dialog box, remane the "Exclusions list" button "QAP Mouse Button Exclusions"
- for Folders favorite, when "Live Folders" is selected, show info in some tabs of "Add/Edit favorite" dialog box explaining why some options are not available
- internal changes converting icons, command line parameters and mouse button names using class objects
- update to Dutch language file

Version: 9.4 (2018-12-21)
* Note: User installing the portable version (ZIP file) must update the JLicons.dll file to v1.5. *
 
Opening Explorer windows on multi-monitor systems
- if the default file manager in "File Managers" tab is Windows Explorer, the tab includes a new option "On a multi-monitor system, always open the Explorer window on the active monitor" when system has more than one monitor
- detect the active monitor based on the mouse position (if favorite folder was launched with mouse trigger) or else based on the active window position
 
Maximize folder on multiple-monitors systems
- show the "Window Options" tab in "Add/Edit favorite" dialog box for favorites of types Folder, Special and FTP when Explorer or Total Commander is the active file manager (Directory Opus users should use DOpus Layouts instead)
- when, in the "Window Options" tab, the window state is "Maximized" or "Minimized", allow to select on which monitor to open the new Explorer or Total Commander window (monitor 1 by default)
 
QAP windows position
- on "General" tab of the "Options" window, new option "Open Settings window on Active monitor" to open the QAP "Settings" window on the active monitor when system has more than one monitor
- detect the active monitor based on mouse or active window position
- always position other QAP windows relative to the center of the main "Settings" window or of their parent window
- remember width of the "Add/Edit/Copy/Move Favorite" window in ini file (useful when menu paths become long)
- remove tray menu command to "Restore dialog box position"
- add the "TryWindowPosition=1" option in quickaccesspopup.ini to show the "Add/Edit Favorite" tab "Window Options" for favorite types "Document", "Application", "URL" and "Windows Apps"; but there is no official support for these options because most applications for these favorite types block window positioning; you can try this option and... all the better if it works for some apps!
 
QAP icons
- new version of JLicons.dll v1.5 with new icons for the QAP app itself (regular icon, loading icon, admin icon, etc.)
- use icons QAP loading, QAP master and QAP beta from JLicons.dll instead of from the QAP temporary folder
- JLicons.dll v1.5 also includes improved "Live Folder" and "Live Folder opened" icons
 
Other changes and bug fixes
- in "Options", "Basic" tab, add the option "Main settings file backup folder" to select a destination folder for backups of the main settings file (quickaccesspopup.ini); backup are created only for main ini file; Shared menu settings files and Alternative settings files (open with the "Switch Settings file...") are still backuped in their own folder
- in "Live Folders" and in "Add/Edit Favorite", when resolving a Windows File Shortcut (.lnk file) that does not return a target location, keep the .lnk file name as location
- add copyright and company name, and update description in file version info of QAP executable and setup files
- update language files for French, German, Spanish, Brazilian Portuguese, Italian, Portuguese and Korean

Version BETA: 9.3.2.9.6 (2018-12-20)
* Note: User installing the portable version (ZIP file) must update AGAIN the JLicons.dll file to v1.5. *
- new version of JLicons.dll (keeping v1.5 during this beta phase) with an improved Live Folder and Live Folder opened icons
- adapting Add/Edit favorite fialog box and Live Folder menu building to include the new Live Folder icons

Version BETA: 9.3.2.9.5 (2018-12-19)
* Note: User installing the portable version (ZIP file) must update the JLicons.dll file to v1.5. *
- new version of JLicons.dll v1.5 with new icons for QAP (regular, beta, dev, loading, admin); stop copying these QAP icon files to temporary folder
- use QAP loading, QAP master and QAP beta icons from JLicons.dll inhstead of from the QAP temporary folder
- add copyright, company name to file version info of QAP .exe files and setup file, update description

Version BETA: 9.3.2.9.4 (2018-12-13)
- in Live Folders and in Add/Edit Favorite, when resolving a .lnk file that does not return a target location, keep the .lnk file name as location

Version BETA: 9.3.2.9.3 (2018-12-13)
- in "Options", "Basic" tab, add an option to select a destination folder for backups of the main Settings file (quickaccesspopup.ini)
- create the backups in this folder only for main ini file
- Shared menu settings files and alternative settings files (open with the "Switch Settings file...") are backuped in their own folder

Version BETA: 9.3.2.9.2 (2018-12-07)
- merge bug fixes and changes from master release v9.3.2.1 (no new features related to this beta test phase)

Version: 9.3.2.1 (2018-12-11)
- in "Add/Edit Favorite" dialog box for type Snippet, moved "Fix width font" and "Font size" controls under the content box
- fix bug introduced in v9.3.2 when moving a favorite of types Folder, Document or Application or when copying multiple favorites of the same types
- fix bug title not shown in Select Shortcut and Select Hotstring dialog boxes
- fix bug in Select Shortcut and Select Hotstring dialog boxes when user cancels by hitting the Escape key instead of clicking the Cancel button
- fix label missing for Live Folders in Settings
- pause 50 ms when restoring from Wait to Normal cursor after menu refresh to give time to Windows to pass the change to other apps in some situatione (for example, when video recording is running)
- update Portuguese language file

Version BETA: 9.3.2.9.1 (2018-12-07)
- add ini value TryWindowPosition=1 to show the "Add/Edit Favorite" tab "Window Options" for favorite types Document, Application, URL and WindowsApp;
- when TryWindowPosition=1, get the new window ID and "try" to position the window of these favorites (if the target application accepts to be repositioned - which has proven to be fully reliable only in Windows Explorer and Total Commander)

Version: 9.3.2 (2018-12-07)
 
Windows file shortcuts in Live Folders
- retrieve "Name" (without .lnk extension), "Start In" and "Arguments" (parameters) properties from file shortscuts when building Live folders
- fix bug retrieving icon from file shortcut in Live folders
 
Import Windows file shortcuts to menu
- add context menu entry "Import Shortcut to Quick Access Popup menu" to import a Windows file shortcut into a new favorite with its name (without the .lnk extension), its icon and, for applications, its "Start In" and "Arguments" (parameters) properties
- add registry keys for the "Import Shortcut" command in the ManageContextMenu.bat batch used by portable installation users to enable or disable context menus
- removed the QuickAccessPopup-InstallContextMenus.reg and QuickAccessPopup-RemoveContextMenus.bat (replaced by ManageContextMenu.bat) from portable installation zip file
 
Various improvements
- before saving a new favorite of types Folder, Document and Application, check if location exists and, if not, return to the "Add/Edit favorite" dialog box
- in "Add/Edit favorite" dialog box for types Folder, Document and Application, trim unneeded double quotes if they enclose the favorite location
- remove exclamation marks enclosing Live folder names in menu; replace "!Folder!" with "Live Folder" in Settings window "Type" column
- user variables (like "{Dropbox}") are now supported in every file path where environmemnnt variables (like "%TEMP%") are supported in QAP (icon files, shared menu names, etc.)
 
Bug fixes
- handle correctly the situation where user cancels the command when asked for admin prvivilege after enabling or disabling the context menus (in "Options", "Menu" tab)
- set icon for "Repeat Last Actions" menu when dynamic menu items are open
- center buttons correctly in some dialog boxes
- when Explorer is selected as file manager, display Directory Opus icon for DOpus Favorites and Total Commander icon for TC Hotlists
- when displaying the "Menu key" hotkey text, replace internal name "AppsKey" with "Menu key" as well as the other internal name "sc15D"

Version BETA: 9.3.1.9.4 (2018-12-06)
 
Windows File Shortcuts
- add context menu entry "Import Shortcut to Quick Access Popup menu" to import a Windows file shortcut into a new favorite with its icon, name and, for applications, its "Start In" and "Arguments" (parameters) properties
- add entries to add or delete "Import Shortcut" regitry keys when enabling or disabling context menus in "Options", "Menu" tab (must use HKLM entries because HKCR not supported for "lnkfile" in Inno Setup)
- handle the situation where user cancels the enable/disable context menu batch when asked for admin prvivilege
- update with the "Import Shortcut" registry keys the ManageContextMenu.bat batch used by portable installation users to enable or disable context menus
- removed the QuickAccessPopup-InstallContextMenus.reg and QuickAccessPopup-RemoveContextMenus.bat (replaced by ManageContextMenu.bat) from portable installation zip file
 
Folders window position (Explorer and Total Commander)
- show the "Window Options" tab in "Add/Edit favorite" dialog box only for favorites of types Folder, Special and FTP when Explorer or Total Commander is the active file manager
- select on which monitor to position the new Explorer or Total Commander window (monitor 1 by default) when window state is "Maximized" or "Minimized" in "Window Options" tab
- when opening a new Explorer or Total Commander window maximimized or minimize, position it (even if it is hidden) at top left of the selected monitor
- if sected monitor is not available, position the window on the primary monitor
- fix bug stop showing minimized favorites
 
Various improvements
- check if location exists before saving a new favorite, return to add/edit favorite dialog box if location not found
- for folders, documents and applications, trim unneeded double quotes if location is enclosed with double quotes
- remove exclamation marks enclosing live folder names in menu; replace "!Folder!" with "Live Folder" in Settings window Type column
- expand user variables when expanding environement variables in EnvVars
- when displaying the AppsKey hotkey text, replace "AppsKey" with "Menu key" (localized string) in addition to the keyboard scan code for Menu key "sc15D"
 
Bug fixes
- remove ampersand (menu shortcut) from menu name when an item is added to the "Repeat Last Actions" menus

Version BETA: 9.3.1.9.3 (2018-12-03)
- center the following dialog boxes on top of the parent dialog box: Select shortcut, Select hotstring, Close computer, Close all windows, Update and Import-export
- avoid top-left of dialog boxes to be displayed outside of active monitor
- fix bug retrieving icon from file shortcut in Live Folders
- retrieve "Start In" and "Arguments" (parameters) properties from file shortcuts when building Live Folders
- fix bug buttons not centered in some dialog boxes
- fix bug set icon for Repeat actions menu when dynamic menu items are open
- fix bug display Directory Opus icon for DOpus Favorites or Total Commander icon for TC Hotlists when Explorer is selected as file manager
- fix bug in dynamic menus when menu numeric shortcuts are enabled (merge from master release v9.3.1.3)

Version: 9.3.1.3 (2018-12-01)
- fix bug in dynamic menus when menu numeric shortcuts are enabled

Version BETA: 9.3.1.9.2 (2018-11-30)
- center Options third level dialog boxes on top of the Options window
- fix bug positioning the Settings window or new Explorer window when the secondary monitor is at the left of, or above the primary monitor

Version BETA: 9.3.1.9.1 (2018-11-30)
 
Opening Explorer windows on multi-monitor systems
- new option in "File Managers" tab to open new Explorer windows on the active monitor when system has more than one monitor
- detect the active monitor based on the mouse position (if favorite launched with mouse trigger) or else based on the active window's position
 
QAP windows position
- add option "Open Settings window on Active monitor" on "General" tab to open the Settings window on the active monitor when system has more than one monitor
- detect the active monitor based on mouse or active window position (as above)
- always position secondary QAP windows (Options, Select favorite type, Add/Edit/Copy/Move Favorite, Add Shared menu from catalogue, Manage Hotkeys, Manage Icons, About, Donate and Help) relative to the center of the main Settings window
- remember width of Add/Edit/Copy/Move Favorite window in ini file
- remove tray menu command to restore dialog box position

Version: 9.3.1.2 (2018-11-29)
- also fix bug when items in Live Folders menus contained an ampersand

Version: 9.3.1.1 (2018-11-29)
- add command line parameter "/Working:[path]" used to set QAP working directory (useful when creating a "Run" registry key to autostart QAP without using Startup shortcut file)
- fix bug when items in dynamic menus (like "Recent Folders", "Last Actions", etc.) contained an ampersand
- fix bug when displaying default QAP feature or Special folder icon in Edit favorite dialog box

Version: 9.3.1 (2018-11-22)
 
QAP windows management 
- restore Add, Edit, Copy or Move Favorites dialog boxes and Settings window to their default position (center of main monitor) after screen configuration changes to make sure QAP windows remain visible in the new configuration; screen configuration changes are adding or removing monitor, changing screen resolution and changing primary monitor
- resetting the dialog box positions from QAP tray menu does not require a QAP reboot anymore
 
Directory Opus
- add "Layouts" submenu to QAP Feature "Directory Opus Favorites" menu
- add option to add or not the "Layouts" submenu to "Directory Opus Favorites" menu
- fix bug when setting up icons for the QAP features "Directory Opus Favorites"
 
Total Commander
- fix bug when setting up icons for the QAP features "Total Commander Hotlist"
 
Bug fixes and other improvements
- change load sequence to fix bug when showing the donate dialog box at startup (aka "Invalid owner error")
- optimize writing to database when collecting usage data from Windows Recent Items

Version: 9.3 (2018-11-14)
 
Directory Opus Favorites menu
- add the new QAP feature "Directory Opus Favorites" under the "Dynamic Menus" category
- at first QAP launch, add the QAP feature "Directory Opus Favorites" to main menu if DOpus is selected as supported manager (NOTE: users upgrading to this release must add the QAP feature manualy)
- fix bug when opening a group of folders in Directory Opus and DOpus is not launched, or when the first group item is not a folder
 
Total Commander Hotlist menu
- when builing Total Commander Hotlist menu, support path redirected by "RedirectSection=" value under [DirMenu] (in addition to supporting "AlternateUserIni=" under [Configuration]), with path relative to folder of wincmd.ini
- at first QAP launch, detect Total Commander ini file location and save it to the settings file
- fix bug when opening a group of folders in Total Commander when the first group item is not a folder
 
Various improvements
- add the option "Start Numeric Menu Shortcuts at 1 (instead of 0)" in "Options", "Menu" tab
- add "Refresh Live Folders and Shared menus" and "Open QAP working directory" items to Tray menu (QAP system menu)
- always close the "Update Quick Access Popup" dialog box after any buttons is clicked
- change QAP icon to gray "loading" icon at the beginning of QAP load sequence and set the normal blue icon when loading is complete and menu can be open
 
Performance improvements
- when checking if a path in Windows Recent Items is a document, if path is on a server (starting with "\\"), check if server is offline and if yes avoid trying to retreive info from the file
- when checking if a file in Windows Recent Items exists, if path is on a server, return that file does not exist if server is offline
- stop refreshing the Windows Apps list at each startup, do it at first QAP launch before adding the "My Windows Apps" menu to ini file, on demand when user adds a Windows App favorite or when RefreshWindowsAppsListAtStartup=1 in settings file
- when refreshing the "Clipboard" menu, do not refresh the menu if the Clipboard size is greater than 10,000 bytes to avoid too long delay before showing the menu (the maximum value can be changed using "ClipboardMaxSize=" in settings file)
 
Bug fixes
- fix bug in "Options", stop changing the QAP temporary folder from %TEMP% to QAP working folder by error
- after Settings import, reset the QAP temporary folder to %TEMP% to avoid dependency on local folder from other system
- fix bug in "Settings" tool tips labels were inversed for "Sort" and "Always on top" buttons

Version BETA: 9.2.9.11 (2018-11-13)
- fix loading icon bug by moving build gui before setting temporary loading icon
- keep custom tray icon when running QAP as admin
- free database record set in background task to preprocess dynamic menu (potential source of memory leak)
- free database record set in startup task updating usage data in favorites objects (potential source of memory leak)
- free variables in background task

Version BETA: 9.2.9.10 (2018-11-12)
- small improvements in diag and timers code

Version BETA: 9.2.9.9 (2018-11-09)
- undo skip custom icon retrieving if folder is on a network share (in v9.2.9.7/8)
- when checking if a path in Recent Items is a document, if path is on a server (starting with "\\"), check if server is offline and if yes check if path has an extension to determine if it is a document (instead of checking the "D" attribute of folders)
- when checking if a file in Recent Items exists, if path is on a server, return that file does not exist if server is offline
- when retrieving file info when adding an item from Recent Items to the database, if path is on an offline server, return file type (file or folder) based on path extension, empty date and emptu unknown attributes

Version BETA: 9.2.9.8 (2018-11-08)
- skip custom icon retrieving if folder is on a network share (all paths starting with "\\")

Version BETA: 9.2.9.7 (2018-11-06)
- skip custom icon retrieving if folder path ends with "$" (administrative share)

Version BETA: 9.2.9.6 (2018-11-06)
- add diag code for preprocess popular and recent menus

Version BETA: 9.2.9.5 (2018-11-05)
- fix bug in v9.2.9.3 when collecting data

Version BETA: 9.2.9.4 (2018-11-05)
- add diag code for preprocess drive menu

Version BETA: 9.2.9.3 (2018-11-04)
- in background task, when checking file info (file exist, file is document, file info) for file on network drive ("\\..."), return available info without accessing the network (this release is to validate that delays were caused by accessing offline network drives; in future version, QAP with check file info only if network drive is online)
- remove debug code forgotten in check for update dialog box

Version BETA: 9.2.9.2 (2018-11-01)
- fix bug Settings window icon tool tips inversed between Sort and Always on top
- make the ClipboardMaxSize an option in the ini file (not in the Options dialog box) with a default value of 10000
- change QAP icon to gray "loading" icon at the beginning of QAP load sequence and set the normal blue (et beta green) icon when loading is complete and menu can be open
- add diag code to GetUsageDbTargetFileInfo

Version BETA: 9.2.9.1 (2018-10-31)
 
Directory Opus Favorites menu
- add QAP feature "Directory Opus Favorites" under the "Dynamic Menus" category
- build Directory Opus menu parsing the DOPus favorites XML file using Maestrith XML_Class
- at first QAP launch, add the QAP feature "Directory Opus Favorites" to main menu if DOpus is selected as supported manager (users upgrading must add the QAP feature manualy)
- in DOpus Favorites menu, show custom folder icons and special folders default icons
- when parsing DOpus favorites, replace PIDL entries with CLSID for special folders like "Computer", "Network" or "Recycle Bin"
- refresh DOpus favorites menu before showing QAP menu
- fix bug when opening a group of folders in Directory Opus and DOpus is not launched, or when the first group item is not a folder
 
Total Commander
- when builing Total Commander Hotlist menu, support path redirected by "RedirectSection=" value under [DirMenu] (in addition to supporting "AlternateUserIni=" under [Configuration]), with path relative to folder of wincmd.ini
- stop refreshing the Total Commander Hotlist menu if this QAP Feature is not in menu
- at first QAP launch, detect Total Commander ini file location and save it to settings
- fix bug when opening a group of folders in Total Commander when the first group item is not a folder
 
Various improvements and bug fixes
- add "Refresh Live Folders and Shared menus" item to Tray (system) menu
- stop refreshing the Windows Apps list at each startup, do it at first startup before adding the Windows Apps menu to ini file, when RefreshWindowsAppsListAtStartup=1 or on demand when user adds a Windows App favorite
- when saving options and favorites, stop refreshing some dynamic menus that will be refreshed before showing menu
- display Update dialog box (with list of changes) when check for update detects a new beta version
- always close Update dialog box after one of the buttons is clicked
- fix bug in Options, stop changing QAP temporary folder from %TEMP% to QAP working folder by error
- after Settings import, reset QAP temporary folder to %TEMP% to avoid dependency on local folder from other system
- clarify label for the file manager preference "when clicking outside the file manager" with distinction between window and tab
- clarify label for group option "replace existing windows", targeting specifically folders

Version: 9.2.1 (2018-10-23)
- optimized the code refreshing QAP menus using new tools offered by the SQLite database
- refresh "Recent folders", "Recent files", "Frequent folders", "Frequent files" and "Drives" menus from a preprocessed field in the database
- refactor the background task collecting recent items to also preprocess "Recent folders", "Recent files", "Frequent folders", "Frequent files" and "Drives" menus
- in "Options", change database options button name in the "More" tab from "Frequent Items database" to "Quick Access Popup database"
- the option to attach dynamic menus to main menu is now true by default ("Settings", "Options" button, "Menu" tab, first check box in second column)
- when refreshing the "Clipboard" menu, reduce the maximum size accepted to handle Windows Clipboard data from 50,000 to 10,000 characters (this could become an option in future release) and display specific messages in "Clipboard" menu if Clipboard is empty, too large or has no path/url
- fix bug creating SQLite files on 64-bit system when user runs QAP with 32-bit executable
- update to German, Korean, Portuguese, Brazilian Portuguese, Italian, Spanish, Dutch and French language files

Version BETA: 9.2.0.6/9.2.0.7 (2018-10-18)
- fix bug when refreshing Frequent menus when running QAP in non-English language
- fix display bug when tabs in Options dialog box take more than one row
- Italian language update

Version BETA: 9.2.0.5 (2018-10-18)
- refresh Recent Folders and Recent Files from a preprocessed field in the database
- refactor the background task collecting recent items to also preprocess Recent Folders and Recent Files menus
- fix bug when returning to database options after enabling or disabling the database
- French, German, Korean and Portuguese-Brazilian language updates

Version BETA: 9.2.0.4 (2018-10-17)
- fix bug when preprocessing dynamic menus and QAP menu contains none of the "Frequent folders", "Frequent files" and "Drives" menus

Version BETA: 9.2.0.2 and 9.2.0.3 (2018-10-12)
- add diagnostic code and timers to measure menu refresh performance
- refactor the background task collecting recent items to also preprocess Frequent menus and Drives menu
- refresh Frequent menus and Drives menu from a field of the zMetadata table in SQLite database
- add columns to zMetadata table to hold preprocessed dynamic menus data
- escape quotes when saving to zMetadata
- in refresh clipboard menu, reduce max size from 50000 to 10000 and display various messages in Clipboard menu if Clipboard empy, too large or has no path/url
- clean up calls to SetWaitCursor, keep them in all show refreshed submenus launched by shortcuts and at begin/end of show main menu
- in Options, database options dialog box, update labels as QAP database instead of Freuent Items menus database
- default attach dynamic menus to true
- fix bug update dynamic menu names when attached/detached before reloading after saving options
- fix bug creating SQLite files on 64-bit system when user runs QAP with 32-bit ecevutable; fix bug when creating zMetadata file

Version: 9.2.0.1 (2018-10-08)
- change attached/detached menu option to include "Frequent Folders", "Frequent Files", "Recent Folders", "Recent Files" and "Drives" menus
- disable controls in Options instead of hiding when UsageDb is disabled
- add diagnostic code and timers for to UsageDb, refresh dynamyc menus and refresh full menu
- add diagnostic at first launch of the application saved to a specific diag file
- do not show error message on error closing the database when exiting and do not backup if the database is not closed properly
- when initializing User Variables, stop display an error message in case of database error when getting Google Drive root
- prevent re-entering in refresh menu when refresh is already in progress
- stop Total Commander Hotlist menu refresh if it is not used in menu

Version: 9.2 (2018-10-02)
 
FREQUENT ITEMS
 
Frequent Items QAP Features
- new "Frequent Folders" and "Frequent Files" QAP Features showing a menu with the ten most frequently used folders or files (excluding folders or files not found) sorted by frequency
- categorize "Frequent Folders" and "Frequent Files" QAP Features under the section "Dynamic Menus" of the QAP features list in the "Add/Edit Favorite" dialog box
- if, in early usage, "Frequent Folders" and "Frequent Files" menus are incomplete, a notice is added to explain that the menus will improve with QAP usage
 
Frequent Items menus options
- reorganize "Options" dialog box tabs: remove "Exclusions" tab and add the "More" tab with buttons for "Exclusions list", "Frequent Items Dabatase" and "User Variables" options dialog boxes
- in the "Frequent Items Database" options dialog box:
  - show QAP Privacy Statement
  - enable/disable Frequent Items database checkbox
  - collection interval for Windows Recent Items (in seconds, minimum 60, default 60)
  - number of days covered by the Frequent Items menus (default 30 days)
  - maximum size of the database in MB, decimal values allowed (default 3 MB)
  - checkbox to show the favorites frequency index in Frequent Items menus and in "Settings" window
  - button to "Flush Recent Items database"
 
Frequent Items database technical notes
- a background task collects (for user's usage only) Windows Recent Items and QAP usage in an SQLite local database named QAP_Frequent.DB
- QAP is now distributed with files sqlite3.dll and sqlite3.def (32-bit or 64-bit - appropriate version is used according to user's system)
- when maximal database size is exceeded, QAP removes oldest items until the maximal size minus 10% is respected
- when exiting QAP, it creates a backup of the database under the name QAP_Frequent.DB-BK, always overwriting the previous copy (this allows scheduled backup programs to copy the backup file even when the live database is locked by QAP)
 
"In the Works" menu
- at first launch of QAP, a new "In the Works" menu is added to Main menu including items "Frequent Folders", "Frequent Files", "Recent Folders", "Recent Files" and "Current Windows" (aka "Switch")
- this menu is added at the top of Main menu for new users or at the bottom of Main menu for users upgrading to v9.2+
- assign to the "In the Works" menu the QAP icon and the Shift + Control + W shortcut
- users upgrading to v9.2 can remove the duplicates "Recent Folders", "Recent Files" and "Current Windows" (aka "Switch") items previously in the "My QAP Essentials" menu
 
Recent Items menus
- "Recent Folders" and "Recent Files" are now refreshed from the Frequent Items database (keeping the previous method if Frequent Items database is disabled)
- Recent Items menus are now always attached to the Main menu (because they are now built more reliably from the database)
 
PLACEHOLDERS
 
New {Clipboard} and {SEL_LOC} Placeholders
- the new "{Clipboard}" placeholder can be used to insert in favorites paths and snippets content the current content of the Windows Clipboard (if it contains text)
- the new placeholders "{SEL_LOC}" inserts in favorites paths and snippets the path of the item currently under the mouse pointer or the item selected in the the file manager window
- the "{SEL_LOC}" placeholder variants are: "{SEL_LOC}" (full path), "{SEL_NAME}" (file name only), "{SEL_DIR}" (directory), "{SEL_EXT}" (extension), "{SEL_NOEXT}" (file name without extension) and "{SEL_DRIVE}" (drive letter)
- the "{SEL_LOC}" placeholder is supported when using Windows Explorer and Directory Opus (this feature is currently not available in Total Commander)
 
Improved Placeholders
- replace all placeholders ("{Clipboard}", "{LOC}", "{CUR_LOC}" and "{SEL_LOC}" and their variants) in favorite's "Location", "Parameters" and "Start In" fields (for all types of favorites supporting these options)
- also replace these placeholders in Windows Apps parameters
 
Placeholders in Snippets
- placeholders "{Clipboard}", current location "{CUR_LOC}", selected item "{SEL_LOC}" and their variants are now replaced in Snippet content
- placeholders can be inserted in both in "Text" and "Macro" modes Snippets
- when displaying a prompt before launching a Snippet, placeholders in prompt text are expanded
- tip: if a Snippet includes a location placeholder, use the "Prompt before launching the snippet" option in "Advanced Settigns" to allow moving from the Explorer window to the window where the snippet must be pasted
- tip: if you need to insert the name of a placeholder "as-is" in a Snippet, preceeds the opening bracket with backtick (eg: "`{Clipboard}")
 
User Variables and Cloud Drives Placeholders
- user variables are custom placeholders that can be inserted in favorites properties and snippet content
- the button "User Variables" under the "More" tab of the "Options" dialog box opens the "User Variables" dialog box
- at its first launch (or when user variables list is empty), QAP creates user variables for these cloud drives (if detected): "{Dropbox}", "{Google Drive}", "{OneDrive}" (SkyDrive) and "{iCoudDrive}"
 
VARIOUS
 
Improvements
- allow sorting of favorites list when filtered using the Search field
- language of QAPmessenger v1.2 (used to send Windows Explorer contect menu commands to QAP) is now translated
- when an error message is displayed because a Shared menu ini file is not found, offer to skip future error messages for this Shared menu file
- add "NeverQuotes=1" to QAPconnect file manager properties to skip enclosing of location path between double-quotes when it includes space(s)
- rename the QAP feature "Switch" to "Current Windows"
 
Language
- addition of Korean translation, thanks to Maeng Bong Kyun (https://blog.naver.com/meangkim)
- update of Brazilian Portugueze, Dutch, French, German, Italian, Portuguese and Spanish language files
- language files include text of QAP Messenger v1.2
- add Korean and Dutch languages to Setup program

Version BETA: 9.1.9.11 (2018-09-22)
 
Placeholders
- add options dialog box under More to manage User Variables used as placeholders in favorites locations and snippets content
- at first usage (or when user variables list is empty), create user variables for these cloud drives (if detected): Dropbox, Google Drive, OneDrive (SkyDrive) and iCoudDrive
- expand placeholders (user variables and previously existing placeholders) in snippets of type macro
- allow to insert placeholders themselves in the content of snippet of type text by preceeding the opening bracket with backtick (eg: "`{Clipboard}");
 
Frequent Items Menus (aka Popular Menus)
- change the default size limit of the database to 3 MB
- support for decimals in maximal database size
- when maximal database size is exceeded, remove old items until the max size minus 10% is respected, also after reducing the maximum in options
- create a backup of the database, always overwriting the previous copy, allowing scheduled backup programs to copy the backup file even if the live database is locked by QAP
 
Bug fixes
- fix bug to avoid database lock error message
- when loading a favorite with iconUnknown, get default icon (occurs if an error occured when saving favorites earlier)
 
Language
- new name "In the Works" for new top menu (instead of "Dynamic Menus") with new shortcut Shift + Control + W (for new users only)
- new names "Frequent Folders" and "Frequent Files" (instead of "Popular ...") and new name "Current Windows) for the "Switch" QAP feature
- in user interface and documentation name SQLite database "Frequent Items database" and rename SQLite database file to "QAP_Frequent.DB"
- language files update for Korean, Dutch, German, Italian, Portuguese and French

Version BETA: 9.1.9.10 (2018-09-14)
 
Popular Menus
- reorganize "Options" dialog box tabs:
  - remove "Exclusions" tab
  - add "More" tab with buttons for "Exclusions list" and "Popular Menus Dabatase" options dialog boxes
- options for "Popular Menus Database":
  - enable Popular Menus database checkbox
  - recent items collection interval (in seconds, minimum 60, default 60)
  - number of days to take into account in Popular Menus (default 30)
  - maximum size of the database in MB (default 1)
  - checkbox to show popularity index in Popular Menus and Settings window
  - button to Flush Popular Menus database
  - privacy statement
- SQLite files are not required if Popular Menus Database option is disabled
- if Popular Menus database is disabled, recent items are collected directly from Windows when refreshing the Recent items menus
- when building Popular Menus, hide files or folders not found
- implement number of days taken into account when building the Popular Menus
- when launching QAP, delete 10% oldest entries of Popular Menus database if its size exceeds the maximum value
- for this release only:
  - convert dates columns in database to SQLite date format (for users of previous beta releases, this could take a few minutes the first time you execute this version of QAP)
  - rename database file from "QAP_Usage.DB" to "QAP_Popular.DB" after dates are converted (keep old file as backup)
  - IMPORTANT: users of previous beta v9.1.9.x versions MUST RUN THIS VERSION to keep their historical data (if they don't, the next version of QAP will create a new, empty database)
 
Placeholders
- in "Basic Settings" and "Advanced Settings" tab of "Add/Edit Favorite" dialog box, replace placeholders help text with links to FAQ on web site
- in Snippet "Basic Settings" tab, add a link for placeholder help
- when using placeholders "{SEL_...}", get selected file in DOpus using a more reliable DOpus internal command (DOpusRt)
- remove support for selected file in Total Commander because this was not enough reliable
- display an error message if user try to use selected file placeholders in Total Commander or in a dialog box
- when displaying prompt before launching a Snippet, expand placeholders in prompt text for current location "{CUR_...}" and selected item "{SEL_...}"
 
Other
- fix bug in shortcut of "Popular Folders" and "Popular Files" menus
- fix bug when using Popular Menus QAP features in other language than English
- update QAP Messenger v1.1.9 BETA: English language for QAPmessenger that can now be localized; only French translation is included in this release

Version BETA: 9.1.9.9 (2018-09-07)
 
Changes that will soon be released in master v9.1.2 (some changes were already included in previous beta releases)

Version: 9.1.2 (2018-09-10)
 
Placeholders in file and folder paths
- in favorite's "Location", "Parameters" and "Start In" fields (for all types of favorites supporting these options):
  - [NEW] replace the placeholder "{Clipboard}" with the current content of the Windows Clipboard (if it contains text)
  - [IMPROVED] now replace the placeholders "{LOC}", "{NAME}", "{DIR}", "{EXT}", "{NOEXT}" and "{DRIVE}" with favorite's location (etc.) in all fields listed above
  - [IMPROVED] now replace the placeholders "{CUR_LOC}", etc. with current location (Explorer window under mouse pointer or active Explorer window) in all fields listed above
- also replace these placeholders in Windows Apps parameters and in Snippet's content
 
Bug fixes
- fix bug with shared menu catalogue path and environment variables
- when extracting the "Short name for menu" of a favorite folder from its location, stop stripping the text after the last dot of the folder name
 
Language files
- addition of Korean translation, thanks to Maeng Bong Kyun (https://blog.naver.com/meangkim)
- update of Dutch, German, Italian and French language files
- add Korean and Dutch language to setup program

Version BETA: 9.1.9.8 (2018-09-05)
 
Usage DB and Recent menus
- refresh recent items menus (folders and files) with usage db if SQLite is enabled (keeping the previous method otherwise)
- store "File" in usage DB instead of "Document" and update existing values
- disable recent items collection if UsageDbIntervalSeconds=0 (will be in Options in future release)
- change default usage db collection interval to 1 minute (was done in v9.1.9.7 but not documented here)
 
Popular menus
- improvements for Popular menus on new installations
- display only items with popularity index greater than 1 (to avoid random recent items in early executions of QAP)
- if items in Popular menus were skipped because of a small index, add to the menu a notice saying that the menu is incomplete and will improve
- append the popularity index between parenthesis to menu names in Popular menus if UsageDbDebug > 0 (will be an option in a future release)
 
Various
- add shortcuts to items added automatically to menu only when the menu is created at first launch
- German, Dutch, Italian, Korean and French language update

Version BETA: 9.1.9.7 (2018-09-03)
 
Usage DB
- fix a bug preventing the "Recent Folders" and "Recent Files" dynamic menus from being populated and refreshed
- change default usage db collection interval to 1 minute

Version BETA: 9.1.9.6 (2018-08-30)
 
Usage DB
- rename the "Popular Stuff" menu to "Dynamic Menus" (still created at top of the menu for new installations or at the bottom for those upgrading)
- assign QAP icon and Shift+Control+D shortcut to "Dynamic Menus"
- move "Recent Folders", "Recent Files", and "Switch" menus from "My QAP Essentials" to "Dynamic Menus"
- always attach "Recent Folders" and "Recent Files" submenus to main menu (because they will now be built more reliably with UsageDB in the next release)
- remove "Popular Applications" QAP Feature
 
Various
- replace the placeholder "{Clipboard}" (not case sensitive) with the current content of the Windows Clipboard in "Location", "Parameters" and "Start In" fields, for all types of favorites supporting these options
- expand placeholders "{SEL_LOC}" with the full path of item currently under the mouse pointer or selected in the current file manager window
- expand parts of the selected item with placeholders "{SEL_NAME}" (file name only), "{SEL_DIR}" (directory), "{SEL_EXT}" (extension), "{SEL_NOEXT}" (file name without extension) or "{SEL_DRIVE}" (drive letter)
- support placeholders in parameters for Windows Apps favorites
 
Bug fixes
- fix bug with shared menu catalogue path and environment variables
- when extractiong the default name of a favorite folder from its location, stop stripping after the last dot of the folder name
 
Language
- addition of Korean translation, thanks to Maeng Bong Kyun
- update to NL language file

Version BETA: 9.1.9.5 (2018-08-27)
- add QAP features "Popular Files" and "Popular Applications"
- add "Popular Stuff" menu at the top of default menu created at first launch with sub menus "Popular Folders", Popular Files" and "Popular Applications"
- add "Popular Stuff" menu at the end of menu for existing users upgrading to this (or future) version
- process relative location, files in PATH and system variables before logging to usage database
- validate minimum interval to 60 seconds for usage database recent items collection
- display QAP ready notification only after usagedb launch work is finished
- add favorite date created and date modified to Usage database (for future use)
- some changes introduced in master version v9.1.1 that were forgotten in v9.1.9.3

Version BETA: 9.1.9.4 (2018-08-24)
- fix bug in Popular Folders menu when menu numeric shortcuts are enabled
- add diagnostic code when collecting recent items
- execute first recent items collection and favorites properties update at launch time (before making the popup menu available) instead of using a timer
- stop saving favorites when existing if favorites usage was updated

Version BETA: 9.1.9.3 (2018-08-23)
- update with some changes introduced in master version v9.1.1

Version: 9.1.1 (2018-08-24)
 
Various
- add an option in "Alternative Hotkeys" tab of the "Options" dialog box to determine if notifications are displayed or not when using the Atlernative Menu (default true)
- add a "Play" button beside the play sound optino in "Add/Edit favorite" dialog box, "Advanced Settings" tab
- add to date created and date modified properties to favorites, using universal time (UTC), allowing in a future version to sort favorites by created or last modified date
- rename the QAP feature "Add This Folder or Link" to "Add Active Folder or Web page"
- update to Spanish language file
 
Bug fixes
- support for environment variables (like %TEMP%) and relative paths (relative to QAP working directory) in "Start In" option, in "Advanced Settings" of favorites of "Application" type
- fix bug when file manager option is always in current window and DOpus or TC are active window

Version BETA: 9.1.9.2 (2018-08-21)
 
Usage DB
- add a background task to collect (for personel user's usage) Windows Recent Items and QAP usage in an SQLite local database named QAP_Usage.DB, using Class_SQLiteDB.ahk library
- collect periodically the last 150 recent items info, rejecting files not found
- collect QAP actions with target info and various indicators on the favorite and options used to launch it
- add FavoriteUsageDb favorite property with a value of one point per occurence of the favorite location in usage database (RecentItems or Menu)
- add "Popular Folders" QAP feature (add it from the "Dynamic Menus" section of QAP features
- when launching QAP, update the favorite's FavoriteUsageDb property and saving values to ini file when exiting the app if user never saved favorites before
- ini variable for recent items collect interval (UsageDbIntervalSecond, 600 by default)
- ini variables to set debugging (UsageDbDebug 0 off, 1 tooltips or 2 tooltips and beep, 0 by default)
- if UsageDbDebug is on, display current number of points of favorites in Settings window after favorite names
- add SQLite views vMenuItemsShort to view only menu items and vLocationTop25 to view top 25 locations (use the free app http://sqlitebrowser.org/ to browse the database - not required for normal users)
- QAP is now distributed with files sqlite3.dll and sqlite3.def in 32-bit or 64-bit (appropriate version is used according to system)
 
Various
- add date created and date modified to favorite properties, using UTC time (for future use, aloowing to sort favorites by date)
- add a Play button beside the play sound option in "Add/Edit favorite" dialog box, "Advanced Settings" tab;
- fix bug when file manager option is "the current Window Explorer" and DOpus or TC are active window

Version BETA: 9.1.9.1 (2018-08-14)
 
Usage DB
- ground work; see v9.1.9.2 for details

Version: 9.1 (2018-08-10)
 
Windows Apps
- support Windows Apps (downloaded from Windows Store or pre-installed in Windows 10, also called Metro Apps under Windows 8, Universal Applications, UWP applications)
- automatically add the submenu "My Windows Apps" to your Main menu with sample of Windows Apps installed with Windows 10 (created only if you run QAP under Windows 10; you can move or delete this submenu if you wish)
- new favorite type "Windows App" in the "Select Favorite Type " dialog box
- adapt the "Add/Edit Favorite" dialog box for a Windows Apps:
  - select the Windows App to add in a dropdown list of Windows Apps installed on your system
  - click the "Refresh" button to include freshly installed Windows Apps
  - select the last dropdown list entry "Custom Windows App" to add manualy a Windows App identifier
  - in the "Advanced Settings" tab, the "Parameter" option is available
  - known limitations: at this time, QAP could not retrieve the "friendly" localized app name and its icon, but you can change the app's name or icon as you wish
  - technical note: the Windows Apps list is refreshed by a PowerShell script running silently; the list is automatically refreshed at QAP launch, unless the [Global] value "RefreshWindowsAppsListAtStartup=0" is added to the QAP ini file
 
Favorite Sound
- add capability to play a sound after any menu item is launched
- the favorite sound location field is added to "Advanced Settings" tab of "Add/Edit Favorite" dialog box for all types of favorites
- support for sounds from a sound as file (wave, mp3, midi, etc. depending on your system configuration), a system sound or your own sound sequence
- see help https://www.quickaccesspopup.com/can-i-play-a-sound-when-i-launch-a-favorite/
 
Various improvements and bug fixes
- add QAP Feature "List Applications" used to analyse properties of currently open applications and windows (mostly for debugging use)
- sort favorite in Settings window without considering the ampersand (&) in their names
- optimize "Recent Folders" and "Recent Files" menus refresh when these menus are attached to the Main menu
- fix bug to prevent shared menu file name to be empty or only ".ini"
- set default icons when adding Shared menu from Catalogue
- update links to QAP website from http:// to https:// (Yes! QAP website is now more secure with an SSL certficate.)
- update of all language files, thanks to translators

Version BETA: 9.0.9.12 (2018-08-09)
- create the sample "My Windows Apps" menu only the first time launching QAP on Windows 10
- make QAP menu available by left-clicking the QAP icon in the Notification before refreshing Windows Apps list, checking for updates and refreshing startup shortcut
- fix bug adding duplicates "Settings" and "Add This Folder or Link" if they already existed in the main menu (this should not happen except if DefaultMenuBuilt value is removed form ini file)
- when saving a favorite, before saving check if icon resource is empty, if yes, set default icon for type (safety check)

Version BETA: 9.0.9.11 (2018-08-05)
 
Sound
- add capability to play a sound after a favorite is launched
- favorite sound location field added to "Advanced Settings" tab of "Add/Edit Favorite" dialog box
- support for sounds from a sound as file (wave, mp3, .mid, etc.), a system sound or your own sequence (see help https://www.quickaccesspopup.com/can-i-play-a-sound-when-i-launch-a-favorite/)
- default file sound %WinDir%\media\tada.wav
- sound is played after the favorite or group is launched
- add "Advanced Settings" tab to QAP features for sound property
 
Windows Apps
- add QAP feature "Add Favorite - Windows App" at top of the menu "My Windows Apps" created at first execution of QAP
- save the PowerShell script collecting the list of Windows Apps in the QAP working directory instead of under a QAP temp folder (allowing easier whitelisting by protection software) and stop deleting the script after its execution
 
Bug fixes
- sort favorite in Settings window without considering the ampersand (&) in their names
- set default icons when adding shared menu from catalogue
- adding a shared menu from the catalogue
- reporting shared menu added even when error occured
- updating the expanded parameters preview in Add Favorite when using placeholders {CUR_LOC} and other {CUR_...}

Version BETA: 9.0.9.10 (2018-07-30)
- in "Add/Edit favorite" for Windows Apps, add the "Ccustom Windows App" item to the drop down list of installed Windows Apps (allowing user to add app not collected by the PowerShell script, if any)
- for custom Windows Apps, display location text box for custom app code (AUMID); internally prefix custom AUMID with "Custom:"; remove prefix before running or displaying the code
- run Windows Apps using a new technique (IApplicationActivationManager) allowing to pass a parameter (argument) to the app
- add "Advanced Settings" tab to "Add/Edit Favorite" dialog box for Windows Apps with "Parameter" option only; support for placeholders in parameter
- add notes to "Application" and "Windows Apps" favorite types help text in "Select Favorite Type" dialog box
- merge otehr changes from master v9.0.7

Version: 9.0.7 (2018-07-27)
- fix bug remembering window position and size when moving the "Move favorite" dialog box when used for only one favorite
- when using drag-and-drop to add a favorite to a menu in the "Settings" window, insert the new favorite after the selected one (instead of before)
- in the "Add/Edit Favorite" dialog box for QAP Features, add help links for all remaining features
- change English labels "Remember window position" to "Remember Settings window position" (in "Options") and "Hide this favorite in menu" to "Disable this favorite" (in Add/Edit Favorite dialog box)
- update to all localized language files

Version BETA: 9.0.9.9 (2018-06-20)
- update FR, DE and NL (partial) languages for v9.0.9.8
- addition of Win App short label for all languages
- in Add/Edit favorite dialog bnox, remplace "Hide this favorite" with "Disable this favorite"

Version BETA: 9.0.9.8 (2018-06-20)
- refresh Windows Apps list at QAP startup using PowerShell script, unless ini [Global] value RefreshWindowsAppsListAtStartup=0
- do not display success or error feedback when refresh is done at startup
- when refreshing Windows Apps list, save temporary PowerShell script and temporary apps list in QAP temporary folder
- remove pause at the end of PowerShell script execution
- run PowerShell script hidden
- change delimiter in Windows Apps list file to tab instead of "=" and rename the file WindowsAppsList.tsv
- in Add/Edit Windows App favorite, hide location text box (holding the Winsdows App ID), move dropdown list after short name
- set default value of Windows Apps dropdown list to the current Windows App, if any
- at startup, make QAP menu available before refreshing Windows Apps list, checking for updates and refreshing startup shortcut (in case these operations take some time)

Version BETA: 9.0.9.7 (2018-06-16)
- fix bug making Windows Apps ID wrong
- differentiate Windows Apps name when there are more than one ID for the same app name (for example, see: microsoft.windowscommunicationsapps)
- remove unneeded language for Windows Apps PowerShell script (keeping only final success or error message)
- when running a beta release, pause at the end of execution of the PS script and save this script file is QAP working directory

Version BETA: 9.0.9.6 (2018-06-15)
- avoid the red error message in PowerShell script and stop listing the apps in the PowerShell window
- display message to user after succesful refresh of list
- moved the Windows Apps drop down list at the top of the Basic Settings tab
- label button "Populate" if the list is empty
- added some missing help URLs for QAP features in Add/Edit Favorite dialog box

Version BETA: 9.0.9.5 (2018-06-13)
- when launching the PowerShell script, use its 8.3 short path/file name to avoid an error if path or file name include space(s)
- there may still be an issue if the filesystem does not support 8.3 naming (Google "NtfsDisable8dot3NameCreation") and the name include space(s); in this case a specific error message is displayed, suggesting the user to change QAP temp folder

Version BETA: 9.0.9.4 (2018-06-12)
 
Windows Apps
- in Add/Edit Favorite dialog box, add a dropdown list with Windows Apps installed on the system allowing to select a Windows App and set its ID (ID can still be entered manualy)
- add a "Refreh" button running a PowerShell script collecting the list of Windows Apps on the system; the script is executed in the QAP temporary folder; the list of WIndows Apps is cached in a file saved in the QAP working directory
 
Various
- when showing a hotkey in Main menu, Alternative menu, Settings window and Settings list filtering, replace modifiers text "Control" with "Ctrl" and "Windows" with "Win"
- revert exclusion of hotkey Windows + L (this Windows default hotkey it is locking the system before QAP can intercept the hotkey but can be disabled by editing a registry key - see https://www.quickaccesspopup.com/can-i-launch-my-favorites-with-keyboard-or-mouse-shortcuts/)
- fix bug prevent shared menu file to be empty or ".ini"

Version: 9.0.6 (2018-06-10)
 
Shared menus and Time zones
- shared menus now fully support menus saved on cloud shared drive (Dropbox, etc.) when users are working accross different time zones
  - note 1: before v9.0.6, sharing menus on cloud drives was possible but some modification alerts could be skipped or sent at inapropriate time
  - note 2: there never was issue when sharing menus using network drives because the file's timestamp is the same for all users regardless of time zone
- add to add/edit shared menu the "Drive hosting the shared menu":
  - "Network" (default option, backward compatible pre-v9.0.6), get last modified time of shared menu from file's date-time
  - "Cloud" option (Dropbox, Gogle Drive, OneDrive, etc.), get modification time from each PC's UTC time (for better sync messaging, users shold sync their clocks on a time server)
 
Shared menus refreshing
- before showing the "Settings" window, refresh all external menus that were changed since last load and rebuild main menu
- in "Settings", when opening a shared menu, check if the menu was modified by another user and, if yes, refresh it before displaying it and rebuild the main menu
- when changing a favorite in a shared menu and the menu was modified by another user since last load (should be very rare), refresh and reload the menu, rebuild the main menu and inform user that its last change cannot be saved
- when loading a shared menu, if it is already locked by the current user (because something unexpected happened and the lock was not released previously), unlock the menu immediately
 
Various
- display tooltips during saving favorites and rebuilding the menu (not only when rebuilding)
- sound debug beep also when refreshing shared menus and live folders on-demand

Version BETA: 9.0.9.2/9.0.9.3 (2018-06-07)
 
Shared menus and Time zones
- shared menus now fully support menus saved on cloud shared drive (Dropbox, etc.) when users are working accross different time zones
  - note 1: before v9.0.6, sharing menus on cloud drives was working but some modification alerts could be skipped or sent at inapropriate time
  - note 2: there never was issue when sharing menus using network drives because the file's timestamp is the same for all users regardless of time zone
- add to add/edit shared menu the "Type of shared menu":
  - "Network" (default option and backward compatible value for pre-v9.0.6), get last modified time of shared menu from file's date-time
  - "Cloud" option (Dropbox, Gogle Drive, OneDrive, etc.), get modification time from each PC's UTC time (for better sync messaging, users shold sync their clocks on a time server)
 
Shared menus refreshing
- before showing the "Settings" window, refresh all external menus that were changed since last load and rebuild main menu
- in "Settings", when opening a shared menu, check if the menu was modified by another user and, if yes, refresh it before displaying it and rebuild the main menu
- when changing a favorite in a shared menu and the menu was modified by another user since last load (should be very rare), refresh and reload the menu, rebuild the main menu and inform user that its last change cannot be saved
- when loading a shared menu, if it is already locked by the current user (because something unexpected happened and the lock was not released previously), unlock the menu immediately
 
Various
- display tooltips during saving favorites and rebuilding the menu (not only when rebuilding)
- change tooltips language when rebuilding menu;
- sound debug beep also when refreshing shared menus and live folders on-demand
- do not save settings window position if ini file has been deleted when QAP was running (user can do it to create a fresh ini file)
- in select hotkey, reject Windows + L hotkey because it is locking the system before QAP can intercept the hotkey

Version: 9.0.5 (2018-06-03)
- fix bug with icon when adding a link (URL) favorite with the "Add this Folder or Link Express" command
- minor language updates for all languages

Version BETA: 9.0.9.1 (2018-05-22)
- support Windows Apps (aka Universal Applications, UWP applications or Metro Apps)
- add favorite type "Windows App"
- add menu "My Windows Apps" at the end of Main menu, if it is not already built;
- add QAP Feature "List Applications" used to analyse properties of currently open applications and windows (for debugging use)
- implement KeepThisWIndow for Switch menu, Close all windows and Add application (list of running apps)

Version: 9.0.4 (2018-05-20)
- fix bug subfolders of Live folders are now also sorted according to Live folder's options
- fix bug default icon is now set when adding a file with the "Add File to Quick Access Popup menu Express" extended context menu (Shift + Right click a file in Windows Explorer to show the "extended" context menu)
- show "Set Windows folder icon" link in "Add/Edit favorite" only for Folder favorites and only if a location has been entered (use this command to sync Windows folder icon with favorite's icon)
- remove unsupported hotstrings options "Do not conform to case" and "Do not keep ending key"
- Spanish language update (QAP Features descrptions in "Add/Edit Favorite")

Version: 9.0.3 (2018-05-12)
- optimize recent folders and recent files menu refresh when these menus are attached to the main menu (refresh time will be shorter when only one of the "Recent Folders" or "Recent Files" is used)
- close all windows now default each line unchecked
- Hotstrings: remove unsupported options "Do not keep Ending key" and "Do not conform to typed case"
- Hotstrings: restart QAP automatically when an hotstring's options are changed, display an alert for the first change
- Dutch language file update and minor updates to EN, DE and ES language files; add Dutch language to Setup script

Version BETA: 9.0.2.9.1 (2018-05-10)
- optimize recent folders and recent files refresh

Version BETA: 9.0.2.9 (2018-05-10)
- debugging code for recent folders refresh
- debugging code for full location when launching application

Version: 9.0.2 (2018-05-06)
- fix bug showing the Settings window empty or with wrong content under certain conditions, especialy when used in non-English language
- fix display bug when adding line separators of column breaks in Settings
- Italian language update

Version: 9.0.1 (2018-04-28)
 
Scheduled refresh
- new option to refresh periodically the Live Folders menus and Shared Menus (during the short refresh period, the menu is not available)
- set the "Interval between refresh (seconds)" in "Menu" tab of "Options" windows
- recommended interval is 300 seconds (5 minutes) or more and minimal interval is 30 seconds
- use the check box "Beep before and after refresh (debug)" to help estimate the time required to refresh the menu
 
Tree views when adding QAP features and Windows Special folders
- in "Add/Edit Favorite" dialog box, replace dropdown lists new tree view lists help selecting new QAP features or Windows Special folders
- QAP Features and Windows Special folders are grouped in the tree view by categories
- each QAP features has a description and is linked to a FAQ page on QAP web site
- you can double click an item in the tree view to add immediately the new QAP feature or Windows Special folder
 
Hotstrings
- an hotstring is a small sequence of characters used as trigger to expand an abbreviation into the full text of a Snippet (auto-replace) or to launch any type of favorite
- a new "Hotstrings" section is added to the "Menu Options" tab in "Add/Edit Favorite" dialog box
- in the "Change hotstring" dialog box, you set the trigger (abbreviation) and options: Case sensitive, Do not conform to typed case, Expand inside other words, Keep hotstring abbreviation, Do not wait for Ending key, Do not keep Ending key (see FAQ page for explanations of options: https://www.quickaccesspopup.com/what-are-hotstrings/)
- due to large number of options combinations (taking into account case-sensitivity and other options), QAP does not validate that hotstring triggers are unique; in case of duplication, depending on various options, only one of the favorites having the same hotstring will be triggered
- in "Options", "Hotkeys" tab, a new button "Hotstrings default options" opens a dialog box where you can set default values for options of newly created hotstrings (these defaults do not impact existing hotstrings)
- the "Manage Hotkeys" window now has two tabs: the existing list of Favorite Shortcuts is inserted in a first tab and a second tab now lists the Favorites Hotstrings
- a new QAP feature named "Hotstrings" opens the "Manage Hotkeys" window in the "Hotstrings" tab
- the QAP feature "Hotkeys" has been renamed "Shortcuts"
 
Settings window improvements
- a new "Sort" button on the left side of the "Settings" window to "Sort all or selected favorites in list"; sorting stops at the first line separator or column break, if present
- a new "Move" button on the right side of the "Settings" window to move one or multiple favorites to another sub menu (no more need to edit a favorite to move it to another menu)
- the "Hotkeys" button has been moved to the bottom of the "Settings" window and now has two distinct labels: "Shortcuts" to manage shortcuts and "Hotstrings" to open directly the Hotstrings tab
- remove support for old black and white buttons (already deprecated since v8.1.1)
 
Extended Search in favorites
- in "Settings" window, a new check box "Extended Search" beside the "Search" text box gives more power to the Search tool
- by default, with the "Extended Search" not checked, the Search tool only filters favorites based on their name
- if the "Extended Search" is checked, search also covers favorite type, shortcut text, hotstring trigger, location (file or folder path), snippet content, FTP login and advanced settings "Parameters" and "Start in" folder
 
Sort Live folders
- new "Sort" options in "Live Folders Options" of favorite folders allow to sort the content of Live folders by file name, extension, size or modified date
- Live folder content can be sorted ascending or descending
- default sort order is alphabetically by file name
 
Close computer QAP Features
- new QAP Feature "Close Computer Control Center", a dialog box giving full control on the way you close or suspend your computer with commands "Power down", "Shutdown", "Restart" and "Logoff", with option to force closing or not; "Sleep" or "Hibernate", with options to suspend immediately or not, or to disable wake events or not; "Turn monitor off", "Put monitor in low-power mode" or "Start screen saver"
- new individual QAP Features to "Restart computer", "Logoff user", "Sleep computer", "Hibernate computer", "Turn monitor off", "Put monitor in low-power mode" and "Start screen saver"
 
Add Favorites QAP Features
- twelve new QAP features to add a favorite for each type of favorite
- when adding a favorite using any of the "Add Favorite" QAP features (including "Add this Folder or Link"), the default parent menu of the new favorite is now the same menu where the QAP feature was launched
- when adding a favorite with "Add this Folder or Link Express" QAP feature, the new favorite is immediately added to the same menu where the QAP feature was launched
- the position of the new favorite is set accordingly to the options "When adding automatically, add a favorite at..." top or bottom, in the "Menu" tab of the "Options" window
- at first QAP launch, when creating the default QuickAccessPopup.ini file, the item "Add Feature - QAP Feature" is added at the top of the "My QAP Essentials" menu and the item "Add Feature - Special" is added at the top of the "My Special Folders" menu
 
Other new QAP Features
- "Close All Windows" shows a list of all the windows of running application where you can close all or selected windows in one click
- "Reopen Current Folder from Dialog Box" will open a new Windows Explorer window and load the folder that is active in the dialog box
- "Switch to default settings file" reloads the normal QAP settings file QuickAccessPopup.ini
- various QAP features for existing features that were available only in Tray menu but can now be added in any menu: "Restore Settings Position", "Check for update" and "Edit Settings file"
 
Tray menu (right-click on QAP icon in Notification zone)
- group some Tray menu options under a new sub menu "Settings file options"
- add the item "Switch to default settings file" to the Tray sub menu "Settings file options"
 
Keyboard shortcuts (internal changes)
- internal keyboard shortcuts management has been simplified and now allows to have various shortcuts for the same location with different parameters
- in the settings file QuickAccessPopup.ini, shortcuts are now saved with the favorites info (in the [Favorites] section instead of the separate [LocationHotkeys] section as before)
- the existing shortcuts in the [LocationHotkeys] section are automatically upgraded to the new favorites shortcuts format
- IMPORTANT NOTE: once you upgraded to a version greater than v9.0 (or beta release v8.7.1.92), you should not revert to an earlier version (if whenever you have to do it, your keyboard shortcuts will be lost)
 
Other  minor improvements
- Shared menus: prevent user from changing the location or file name of a Shared menu (avoiding errors); if the file for a shared menu has been renamed or moved, first remove the shared menu and create a new one with the moved or renamed file
- Snippets: when displaying a prompt waiting to send a text snippet or execute a macro snippet, QAP now accepts Escape to cancel the snippet
- Drag & Drop: when adding a file shortcut (.lnk) using drag and drop, set the default name of the favorite to the name of the shortcut
- File Shortcuts (.lnk): when adding a file shortcut with the "Add favorite" dialog box or using drag and drop, get the favorite default icon value and, for applications, the "Parameters" (command line arguments) and "Start In" working directory values from the file shortcut (this is already done that way when adding the shortcut using the Explorer context menu)
- Add favorite: reorder the types of favorites radio buttons in the "Select Type" dialog box when you add a favorite
- Windows Explorer: opening a folder that is already open in another Explorer window now brings the existing window to front (instead of creating a new window) except, of course, if you click inside an existing Explorer window, in which case it changes the folder inside this window
- Windows Explorer instances: before this release, opening a folder in a new window was creating a new Explorer instance for every new folder; now, the window for a new folder is created under the existing Explorer instance and only one Explorer instance is created by QAP (unless user open the Alternative menu "Open in new window" or if user adds an argument to the folder in "Advanced Settings" in which cases QAP must create new Explorer instances)
- Exclusions: add the capability to exclude menu mouse trigger (by default, Middle mouse button) by process name in addition to window title and class name (the process name is usually the name of the executable file of an application, for example: NOTEPAD.EXE) and add detection of process name when using the "Get window info" button below exclusion list in "Exclusion" tab of the "Options" window
- make sure location ends with backslash for app's Save As dialog box (like with Notepad++ v7.5.6) trying to save instead of navigating if location does not end with backslash
- QAP development framework AutoHotkey has been upgraded to v1.1.28.00
 
Language
- language updates for Brazilian Portuguese, Dutch, French, German, Italian, Portuguese, Spanish
- removed Sweedish language (not updated since v8.0)

Version BETA: 8.9.1.10 (2018-04-28)
- fix bug no menu selected in Settings when opening the Settings window from QAP icon
- add Ctrl-M hotkey in Settings to move the selected favorite(s)
- fix bug disabling hotkey Enter in Settings when multiple favorites are selected
- encode snippet content when dislayed in Select hotkey or Select hotstring dialog boxes
- add QAP feature "Restore dialog boxes window position" and add it to System menu (Tray)
- fix bug in System menu (Tray) to display the correct settings file name if settings file has been switched
- add menu item for QAP support group in Tray menu

Version BETA: 8.9.1.9 (2018-04-19)
- in "Options", "File Managers" tab, replace the "Always navigate" check box with clearer radio buttons "When opening the QAP menu outside of file manager, open folders in:" with two options "the current Windows Explorer window" or "a new Windows Explorer window", keeping the actual user's value; default value "new window" is unchanged
- in "Options", add a check box to enable or disable scheduled refresh instead of setting interval to 0 second to disable it (no change in the functionality itself)
- fix bug with Live folders sorting for folders created before v9, now existing live folders are sorted by alphabetical order
- fix bug when adding a Link favorite with "Express" QAP feature and added web page did not return a title
- fix bug when getting a web page title and the opening title HTML tag of that page is formated like "<title id=... >" instead of "<title>"
- when adding favorite from QAP features "Add favorite...", the default parent menu is set to the menu where the QAP feature was called (now also for "Add This Folder or Link")
- fix bug when using the Alternative menu "Open in a new window" and the folder was already open in Windows Explorer (now it always creates a new Explorer instance)
- update to language files for German, Italian, Portuguese, Brazilian Portuguese, Spanish and French

Version BETA: 8.9.1.8 (2018-04-08)
 
Close computer QAP Features
- add QAP Feature "Close Computer Control Center" with commands Power down, Shutdown, Restart and Logoff, forced or not; Sleep or Hibernate, immediately or not, disabling wake events or not; Turn monitor off, Put monitor in low-power mode or Start screen saver
- add QAP Features "Restart computer", "Logoff user", "Sleep computer", "Hibernate computer", "Turn monitor off", "Put monitor in low-power mode" and "Start screen saver"
- add QAP tree view sub category "Close Computer Commands" under "Windows Features" for close computer QAP features
 
Various improvements and bug fixes
- add capacity to exclude menu mouse trigger (MButton) by process name (exe file name) in addition to window title and class name
- add detection of process name when using the "Get window info" button below exclusion list
- fix bug in menu item position when adding favorites with any of the "Add Favorite" QAP features if user selected a different parent menu in "Menu Options" tab
- language updates for Spanish, Brazilian Portuguese, German and French, removed Sweedish language (not updated since v8.0)

Version BETA: 8.9.1.7 (2018-03-30)
 
QAP Features
- add QAP feature "Reopen Current Folder from Dialog Box" (when you are in a dialog box and wish to browse this folder in Explorer)
- add QAP features for existing features that were available only in Tray menu (they cannow be added in any menu): "Restore Settings Position", "Check for update" and "Edit Settings file"
- add category "Window Management" in QAP features tree view and move some features from category "Windows Feature" to "Window Management"
- fix bug with "TC Hotlist" QAP feature being displayed twice in QAP features tree view (same issue fixed with Special folders tree view)
 
Various improvements
- add "Sort" button to left side of Settings window to "Sort all or selected favorites in list"; if a separator is part of the selected rows, sorting stops at first separator
- add "Sort" option for "Live folders" with ascending or descending sort by file name, extension, size of modified date, default sort order is file name ascending
- when a file shortcut (.lnk file) is added to QAP menu with Drag and Drop, keep the shortcut's file name as default favorite name (instead target's file name)
- move "Edit Settings file" from "Settings file options" tray submenu back to main Tray menu
 
Bug fixes
- fix bug item position in menu dropdown not set when adding a QAP feature with type
- fix bug with tooltips in Settings window for left hand column that were offset by 2

Version BETA: 8.9.1.6 (2018-03-24)
 
Close All Windows
- add the QAP feature "Close All Windows" with a dialog box to select which of the currently open windows to close
- add a button to select or deselect all windows to close
- double-click or press Enter to close one window only or see its details
 
Options
- when adding a favorite automatically using one of the "Express" commands or "Add Favorite" QAP features, change default position of new favorites from top to bottom of the menu
- rename option "Add automatically at the top of menu" to "When adding automatically, add a favorite at..." and change it from a check box to radio buttons with options "Bottom of menu" and "Top of menu"
- in "Options" dialog box, move the "When adding automatically, add a favorite at..." option from "General" to "Menu" tab
 
QAP Features
- new QAP features to add a favorite for each type of favorite (12 types)
- add these new features to the QAP Features tree view under 2nd level list "Add Favorite of Type"
- when adding a favorite using QAP features "Add Favorite" (with or without type), add it at top or bottom of menu according to option "When adding automatically, add a favorite at..."
- also, when adding with "Add favorite" QAP features, add the new favorite to the top or bottom of the menu where the "Add Favorite" command was launched
- at first QAP launch (when creating the QuickAccessPopup.ini file), add default items "Add Feature - QAP" at top of menu "My QAP Essentials" and "Add Feature - Special" at top of menu "My Special Folders"
- stop saving the QAP features name to ini file (this was done by error in the previous beta release)
 
Add Express command
- when using the "Add this Folder or Link Express", add favorite to menu where the "Express" command was launched
- when adding a favorite using "Express" command, add it at top or bottom of menu according to option "When adding automatically, add a favorite at...".
 
Bug fixes
- fix bug when double-clicking a tree view header (when adding QAP Features or Special Folders)
- show Settings window and check for read-only status of Shared menus when adding favorites using QAP feature "Add favorite - Type"

Version BETA: 8.9.1.5 (2018-03-17)
 
Windows Special folders
- categorize Windows Special folders, one special folder to 1-to-n categories
- replace Windows Special folders dropdown list with a tree view containing Special folders grouped by categories
- support double click in treeview to add immediately a new Windows Special folder (also when adding from the QAP features tree view)
- when editing a new Windows Special (or QAP feature) favorite, in the tree view, expand the branch of the first occurence of the edited favorite (it can be available in more than one branch)
- remove duplicate Windows Special folder "Favorites (Internet)" and keep {323CA680-C24D-4099-B94D-446DD2D7249E}
 
Various
- reorder types of favorites radio buttons in "Select Type" dialog box when adding a favorite
- before this release, opening a folder in a new window was creating a new Explorer instance for every window; now, the new window is created under the same Explorer instance and only one Explorer instance is created by QAP unless user adds an argument to the folder in Advanced settings (low probability) in which case QAP must create a new instance for this window
- opening a folder that is already open in another Explorer window now brings the existing window to front instead of creating a new window (except if you click inside an existing Explorer window, in which case it will change the folder inside this window)
- rename "Refresh Live Folders menus" to "Refresh Live Folders and Shared menus"
 
Bug fixes
- fix bug with default shortcut when adding or editing a QAP feature favorite
- when adding a file shortcut (.lnk) using drag and drop, set default name based on the target file (not the file shortcut name) to be consistent with other ways of adding file shortcuts
- when adding a file shortcut from the "Add favorite" dialog box or using drag and drop, get from file shortcut the favorite default for the icon and, for applications, for Parameters (command line arguments) and working directory (this is already done when adding unsing the Explorer context menu)

Version BETA: 8.9.1.4 (2018-03-13)
- categorize QAP features, one feature to 1-to-n categories
- init QAP features with one help URL for each feature
- replace QAP Features dropdown list with a tree view containing QAP featurees grouped by categories
- add a description for each QAP features and display it in the tree view
- add help link to QAP features in the tree view
- internal changes allowing some QAP features (those that will have options in a future release) to have a custom name

Version BETA: 8.9.1.3 (2018-03-04)
 
Settings window
- add a "Move" button to move one or multiple favorites to another submenu
- disable the "Edit" button if multiple favorites are selected
- adapt Copy/Move commands language to singular/plural depending on number of favorites selected
- move the "Shortcuts"/"Hotstrings" button to the right of "Close" button
- rename the "Support" button to "Donate" and move it up to the left of "Options" button
- remove support for old classic black and white Settings buttons (already deprecated since v8.1.1 )
 
Sheduled refresh
- the "Refresh Live Folders menus" now also refresh Shared menus from external settings files (including when running scheduled)
- do not execute scheduled menu refresh if there are unsaved changes in "Settings"
 
Hotstrings
- reload favorites in "Settings" after changes in "Manage hotstrings" (as well as in "Manage Shortcuts")
- fix bug in display hotstrings options when "Do not conform to types case" was selected
 
QAP features
- new QAP feature "Switch to default settings file" to reload the normal QAP settings file QuickAccessPopup.ini
 
Tray menu (QAP icon in Notification zone)
- group some Tray menu options under the new submenu "Settings file options"
- add "Switch to default settings file" to Tray submenu "Settings file options"
- add "Refresh Live folder menus" to the Tray menu

Version BETA: 8.9.1.2 (2018-02-23)
- add in "Menu" tab of "Options" windows an option to set the number of seconds between scheduled refresh of the QAP menu including Live Folders (during refresh the menu is not available)
- add a checkbox "Beep before and after refresh (debug)" to help estimate the time required to refresh the menu
- add value "RefreshQAPMenuIntervalSec" to quickaccesspopup.ini file with the number of seconds between scheduled refresh
- add debug value "RefreshQAPMenuDebugBeep" to quickaccesspopup.ini file to sound beep before and after scheduled menu refresh
- fix bug with checking favorite type in Extended Filter
- plus changes from master release v8.7.1.2 (see below)
 
Version: 8.7.1.2 (2018-02-23)
- prevent user from changing the location or file name of a Shared menu (avoiding errors); if the file for a shared menu has been renamed or moved, first remove the shared menu and create a new one for the moved or renamed file
- message to confirm before creating a new (empty) external menu
- using Snippets, when waiting to send a text snippet or execute a macro snippet, accept Escape to cancel the snippet

Version BETA: 8.9.1.1 (2018-02-20)
(summary of changes in private beta releases v8.7.1.94 to v8.7.1.98)
 
Hotstrings
- see FAQ page https://www.quickaccesspopup.com/what-are-hotstrings/
- add "Hotstrings" section to "Menu Options" tab in "Add/Edit Favorite" dialog box
- add "Change hotstring" dialog box to set the trigger (or abbreviation) of an hotstring and its options
- checkbox options in "Change hotstring" dialog box are: Case sensitive, Do not conform to typed case, Expand inside other words, Keep hotstring abbreviation, Do not wait for Ending key, Do not keep Ending key (see FAQ page for explanations of options: https://www.quickaccesspopup.com/what-are-hotstrings/#options)
- hotstrings can trigger any type of favorites, most useful with "Text Snippets" to use an abbreviation (the trigger) to expand in the longer replacement text of a Text Snippet
- due to large number of options combinations (taking into account case-sensitivity and other options), QAP does not validate that hotstring triggers are unique; in case of duplication, depending on various options, only one of the favorites having the same hotstring will be triggered
- in "Options", "Hotkeys" tab, add the "Hotstrings default options" button to to set default hotstrings options for newly created hotstrings (these defaults do not impact existing hotstrings)
- to "Manage Hotkeys" window, add the "Hotstrings" tab with a list of all favorites having an hotstring
- in "Settings" window, add a label under the "Hotkeys" (renamed "Shortcuts, see below) to open the "Manage Hotkeys" dialog box in the "Hotstrings" tab
- add a new QAP feature named "Hotstrings" to open the "Manage Hotkeys" dialog box in the "Hotstrings" tab
 
Keyboard shortcuts
- rename button and labels "Hotkeys" to "Shortcuts" in windows "Settings", "Add/Edit Favorites", "Manage Hotkeys", etc. (in QAP, the term "Hotkeys" now encompass both "Shortcuts" (mostly keyboard shortcuts, but also mouse shortcuts) and the new "Hotstrings" (described above)
- simplified management of favorites keyboard and mouse shortcuts (internal changes only)
- in the settings file QuickAccessPopup.ini, shortcuts are now saved in the favorites lines in the [Favorites] section (instead of the separate [LocationHotkeys] section as before)
- the existing shortcuts in the [LocationHotkeys] section are automatically upgraded to the new favorites shortcuts format
- NOTE: once you upgraded to a version greater than 8.7.1.92, you should not revert to an earlier version (if whenever you have to do it, your keyboard shortcuts will be lost)
 
Extended Search
- add the "Extended Search" checkbox after the "Search" text box in the "Settings" window
- by default, the "Extended Search" is not checked, and search filters only based on the favorites name
- if the "Extended Search" is checked, search covers favorite name, type, shortcut, hotstring trigger, location (file or folder path), snippet content, FTP login name and password, and advanced settings "Parameters" and "Start in" folder
 
Bug fixes and minor changes
- enable some keyboard shortcuts in the "Settings" window that were disabled by error when favorite list was filtered by the Search
- stop offering to edit a favorite when its location is not found for items from dynamic menus (like "Recent Folder")
- in the "Settings" window, change the default button to "Close" (instead of "Save & Close") and, if user hits the Enter key when the focus is not in the favorites list, send the Enter key to the default "Close" button

Version BETA: 8.7.1.98 (2018-02-19)
 
Hotstrings
- stop escaping backticks and some semi-colon in trigger; remove deprecated comments
- limit length of hotstring trigger to 40 characters in change hotstring dialog box
- encode pipe ("|") symbols in hotstring trigger in QuickAccessPopup.ini settings file
- fix bug in v8.7.1.94, hotstring from previously edited favorite being reused by error in next added favorite
 
Extended Search
- add "Extended Search" checkbox to Settings window
- if not checked, search filters only on favorite name
- if checked, "Extended Search" covers favorite name, type, shortcut, hotstring trigger, location (file or folder path), snippet content, FTP login name and password, and advanced settings "Parameters" and "Start in" folder
 
Bug fixes
- enable some keyboard shortcuts in Settings window that were disabled by error when favorite list was filtered
- stop offering to edit a favorite when location is not found for items from a dynamic menus (like "Recent Folder")
- in Settings window, change the default button to "Close" and, if user hits the Enter key when the focus is not in the favorites list or filtered favorites list, send the Enter key to the default Close button
- fix change shortcut dialog box window size error

Version BETA: 8.7.1.97 (2018-02-16)
- always send snippet with PasteSnippet command (stop using slower AHK built-in replacement hotstrings)
- QAP hotstrings are now always of type "X" (Execute) using the "OpenFavoriteFromHotstring" command

Version BETA: 8.7.1.96 (2018-02-15)
 
Hotstrings
- complete rewrite using new built-in Hostring Function, using AHK format ":options:trigger" (requires AHK v1.1.28.00+)
- in Options, remove "Enable Hotstrings" (always enabled now) and add "Default hotstrings options" in "Hotkeys" tab
- always use options "T" for replacement hotstring or "X" for execute hotstrings
- new hotstrings options "Expand inside other words", "Do not conform to typed case" and "Do not keep Ending key"
- rename hotstring options "Keep hotstring abbreviation" and "Do not wait for Ending key"
- validate hotstring trigger maximum length of 40 characters
- stop validating if new or changed hotstring trigger already exists
- display an error message if cannot get favorite object from a hotkey (most probably hotstring) suggesting is it a temporary issue and to restart QAP
- rename "Hotkeys" button in "Settings" to "Shortcuts" (but keep internal code "{Hotkeys}" for backward compatibility)
- add label in "Settings" and QAP feature "Hotstrings" to open Manage Hotkeys dialog box in "Hotstrings" tab
 
Shortcuts
- fix bug when changing shortcut for one favorite and assigning the old shortcut to another another, was still considered as used

Version BETA: 8.7.1.94/8.7.1.95 (2018-02-09)
 
Hotstrings
- new checkbox "Enable Hotstrings" in "Options", "General" tab
- when hotstrings are enabled, monitor keyboard and launch triggered favorites when an hotstring is typed (regardless of the running application)
- add "Hotstring" section to "Add/Edit Favorite" dialog box ("Menu Options" tab)
- add new "Hotstrings" tab to the "Manage Hotkeys" window
- new "Change hotstring" dialog box to set the hotstring trigger and options
- stop monitoring hotstrings when the "Change hotstring" dialog box is open
- when saving hotstring, monitor that hotstrings triggers are unique
- valid characters in trigger are letters (a-z), numbers (0-9) and these symbols: # $ % & * + < = > @ ^ _ ` | ~`n- ( ) ' : `; "" / , . ? ! [ ] { } \
- option "Case sensitive" to launch favorite only if typed characters match a trigger with upper/lower case
- option "Keep hotstring" to keep (or delete) the typed trigger after the favorite is launched
- option "Wait ending key" when an hotstring trigger is matched, wait for one of theses keys before launching the favorite: Enter, Tab and the keys - ( ) ' : ; " / , . ? ! [ ] { } 
 
Bug fixes and minor changes
- fix bug in v8.7.1.93 loosing target window id when opening a favorite in dialog box
- add three configurable delays in ini file applied when paste snippets (see FAQ page on Text Snippets)
- validate that source or destination file is set when importing or exporting settings
- remove the Hotkeys option when importing or exporting settings

Version BETA: 8.7.1.93 (2018-01-31)
- internal changes for a simplified management of favorites keyboard and mouse shortcuts
- in the settings file (quickaccesspopup.ini), shortcuts are now saved in the favorites lines in the [Favorites] section instead of the separate [LocationHotkeys] section
- upgrade previous settings file to the new favorites shortcuts format; NOTE: new version of the settings file should not be used with older version of QAP

Version BETA: 8.7.1.92 (2018-01-21)
- merge bux fixes from master release v8.7.1.1

Version: 8.7.1.1 (2018-01-21)
- fix bug introduced in v8.7.1 making the menu miss the QAP features names after user saved changes in the Hotkeys dialog box
- fix bug "unknown" icons displayed for some favorites in menu after saving favorites for the first time after first launch after installation
- fix bug write file version number to executable files (32-bit and 64-bit)
- add executable files version number to setup executable file
- compiled with new AHK runtime v1.1.27.03 and display AHK runtime version in About dialog box
- update to traditional Chinese (ZH-TW) language file
 
Version BETA: 8.7.1.91 (2018-01-09)
- compiled with new AHK runtime v1.1.27.03
- display AHK runtime version number in about dialog box
- use new object A_Args to parse arguments; requires AHK v1.1.27+
- remove hotkeys exceptions for Russian keyboard solved by new runtime v1.1.27
- fix bug writing file version number to executable files (32-bit and 64-bit)
- add QAP executable file number to setup executable file

Version: 8.7.1 (2017-12-30)
 
Run as administrator
- new checkbox "Run as administrator" in Options, first tab, to launch QAP as an admnistrator (ie: with elevated privileges)
- display a security alert when selecting the "Run as administrator" option and when launching QAP as administrator
- when running as administrator, embed the Windows UAC (User Access Control) logo in QAP icon in the Notification zone
- add the "[admin]" tag to QAP application name when running as administrator
- administrator security alert, "[admin]" tag and QAP tray icon with UAC logo are displayed only if QAP is running as admin because of the "Run as administrator" option (ie: not if user launched QAP as administrator by other means)
- launch QAP with normal privileges if user decline elevation (ie: do not enter the admin password when requested)
- more info here: https://www.quickaccesspopup.com/can-i-launch-qap-with-administrator-privileges/
 
Various
- Italian, Portuguese, Brazilian Portuguese, Dutch, German, Spanish and French language update
- the QAP startup shortcut (created when user select the "Run at startup" option) now includes the "/Settings:" parameter if user switched settings file (QAP will reload with the changed settings file)
- add a random number to QAP temporary folder name to make sure we have distinct folders in case multiple QAP instances are launched
- use the Windows UAC (User Access Control) logo as default icon for the Alternative menu "Run as administrator"
- new JLicons.dll icons file v1.4 including Windows UAC logo icon and QAP icon with UAC logo
* User installing QAP in PORTABLE mode, make sure you update your JLicons.dll file
 
Bug fixes
- in Live Folders, fix icons for items with extension .url (links) or .lnk (shortcuts)
- fix bug when Directory Opus had multiple listers and wrong lister was sometimes activated after opening a folder in new tab
- fix bug in French version to remember the "Add/Edit favorite" dialog box width

Version BETA: 8.7.0.9.5 (2017-12-27)
- small change to fix in v8.7.0.9.4, using internal DOpus command to bring lister to front

Version BETA: 8.7.0.9.4 (2017-12-27)
- fix bug when DOpus has multiple listers, wrong lister being sometimes activated after open in new window
- add the "[admin]" tag to QAP application name only if QAP is running as admin because of the "Run as administrator" option
- change the QAP tray icon for version embedding the UAC logo only if QAP is running as admin because of the "Run as administrator" option

Version BETA: 8.7.0.9.3 (2017-12-23)
- show running as admin alert only if QAP is running as admin because of the "Run as administrator" option

Version BETA: 8.7.0.9.2 (2017-12-22)
- fix icons for items with extension .url (link) or .lnk (shortcuts) in Live Folders
- add a random number to temp folder name to make sure we have distinct folders in case multiple QAP instances are launched
- optimize refresh Recent folders and Recent files menus when user enabled the attached options enabled (this has no impact on detached menus)
- augment height of "Add/Edit favorite" dialog box to show the {cur_loc} tip for all types of favorites
- fix bug in French version to remember the "Add/Edit favorite" dialog box width
- refactor code to convert command-line params from object to string and code to create a startup shortcut
- QAP startup shortcut now includes the changed "/Settings:" parameter if user switched settings file
- German language typo fix

Version BETA: 8.7.0.9.1 (2017-12-20)
- add the "Run as administrator" checkbox option to Options, first tab, to launch QAP as an admnistrator (ie: with elevated UAC privileges)
- display Windows UAC logo in Options dialog box for the "Run as administrator" option
- save this option to variable RunAsAdmin in settings ini file (default false)
- display a security alert when selecting the "Run as administrator" option
- after saving options with "Run as administrator" on, offer to reload QAP in Admin mode
- after saving options with "Run as administrator" OFF, offer to exit app (but QAP could not reload itself in normal mode because the reloaded instance would inherit admin privileges)
- display a security alert when launching QAP as Admin and support the command-line option "/AdminSilent" for power users wanting to skip this alert 
- change the QAP tray icon for version embedding the UAC logo when QAP is running as administrator
- display an alert message if refused to elevation (ie: did not enter the admin password when requested) and running as normal user
- distribute a new JLicons.dll icons file v1.4 including UAC logo icon and QAP icon with UAC logo
- use the UAC logo as default icon for the Alternative menu "Run as administrator"
- add the "[admin]" tag to QAP application name when running as administrator

Version: 8.7 (2017-12-06)
 
New QAP Features
- new QAP feature "Repeat Last Actions" displaying a submenu with the last 10 items selected in the popup menu
- adding a new submenu "Repeat Last Actions" to the "My QAP Essentials" menu for new installation only (* existing users must add it themselves *)
- when an item is selected from the "Repeat Last Actions" menu, it is moved to the top of the menu
- new option in "Options", "Menu" tab, to select the number of items in "Repeat Last Actions" menu (default 10)
- new QAP feature "Repeat Last Action" (singular) to repeat the last item selected in the popup menu (* users must add it themselves to their menu *)
 
- new QAP Feature "Recent Files" displaying a submenu with recent files as remembered by Windows
- adding a new submenu "Recent Files" to the "My QAP Essentials" menu for new installation only (* existing users must add it themselves *)
- adding a new submenu "Repeat Last Actions" to the "My QAP Essentials" menu for new installation only (* existing users must add it themselves *)
- the "Recent Files" submenu contains the same number of items as the "Recent Folders" submenu
 
- new option in "Options", "Menu" tab, to display the refreshed folders "Recent Folders", "Recent Files" and "Drives" attached to the main menu (with a refresh delay that may vary at each menu popup) or detached as stand-alone menus refreshed on demand (as before this release)
 
Russian keyboard support
- various adjustments for systems where current input language (keyboard) is Russian (language code 0419)
- if Russian keyboard is detected, replace Windows + W and Shift + Windows + W menu keyboard hotkeys with equivalent keys on Russian keyboard (ASCII Unicode 1094)
- at first execution, do not assign default hotkeys to favorites if running on a system with Russian keyboard
- change method of initialization of shortcuts in "Settings" window to avoid errors with Russian keyboard
 
Temporary folder
- add an option in "General" tab to select the folder where the QAP temporary folder is created (and deleted when you exit QAP)
- for new installation starting with this version, the default temporary folder is created in Windows %TEMP% folder (e.g. C:\Users\UserName\AppData\Local\Temp)
 
Other improvements
- support navigation (change folder) in PowerShell window as in the command-line console (CMD)
- add an item to the QAP system menu (richt-click on QAP icon menu in Notification zone) labeled "Restore Settings window position" that move the "Settings" window to its default position and size, in case it would become invisible following changes by user in screens configuration
- when activating a running application with Applications favorite option "If the application is already running, activate it instead of launching", activate it only if it has the requested admnin (UAC) level (elevated or normal), if not, launch a new instance with the required admin level (if the application supports multiple instances)
- allow resize of dialog box shown when selecting a destination menu for copied or moved multiple favorites, allowing to see longer destination menus and save window last position to ini file to restore it when using this dialog box again
- add code to be more specific when detecting a file dialog box (Open, Save As, etc.) and exclude non-file dialog boxes (Preferences, Options, etc.)
 
Bug fixes
- changes in Manage Icons window were not saved if favorites were part of a shared menu
- could not use the Alternative menu feature "Edit a favorite" for running apps favorites if the "If this application is already running, activate..." option was enabled
- default hotkeys for QAP features in "My QAP Essentials" were not correctly initializes when creating the settings file at first execution
- bug in error message when a hotkey was not available in current keyboard layout
- opening Special folder "Control panel" in Directory Opus was causing a blank tab to be added
- make sure the application window does not stay minimized when activating a running application with Applications favorite option "If the application is already running, activate it instead of launching"
 
Language updates
- update to Traditional Chinese (ZH-TW, back to v8.1), Italian, Portuguese, Brazilian Portuguese, German, Spanish, Dutch and French language files
- English language revision (thanks to Richard for proofreading)

Version BETA: 8.6.9.11 (2017-12-05)
- fix bug when Restore Settings position if Settings was never displayed before;
- make sure the application window does not stay minimized when activating a running application with Applications favorite option "If the application is already running, activate it instead of launching"

Version BETA: 8.6.9.10 (2017-12-01)
- add an item t the QAP icon menu in Notification zone labeled "Restore Settings window position" that reposition the Settings window to the top left of main screen, in case it would become invisible following changes in screen configuration
- when activating a running application with Applications favorite option "If the application is already running, activate it instead of launching", it will be activated only if it has the requested admnin (UAC) level (elevated or normal)

Version: 8.6.4 (2017-11-29)
- fix bug - changes in Manage Icons window were not saved if menu was part of a shared menu
- fix bug - could not use the Alternative menu feature "Edit a favorite" for running apps favorites if the "If this application is already running, activate..." option was enabled
- give temporary menu name to unknown QAP feature (this should only happen if switching back from a version with a new QAP feature to an earlier version where this QAP feature is unknown)
- Simplified Chinese (ZH-TW) translation update (back to v8.1, thanks fo Jess) and English language proofreading (thanks to Richard)
 
Version BETA: 8.6.9.9 (2017-11-27)
- do not allow to use the Alternative menu feature "Edit a favorite" to edit items from the "Repeat Last Actions" menu
- give temporary menu name to unknown QAP feature (this should only happen if switching back from beta to master versions)
- fix bug changes in Manage Icons window were not saved if menu was part of a shared menu
- fix bug cannot use the Alternative menu feature "Edit a favorite" for running apps favorites if the "If this application is already running, activate..." option is enabled
- Simplified Chinese (ZH-TW) translation update (back to v8.1, thanks fo Jess) and English language proof reading (thanks to Richard for proofreading)

Version BETA: 8.6.9.8 (2017-11-22)
- fix small bug when launching repeated action

Version BETA: 8.6.9.7 (2017-11-22)
- implement shortcuts for Repeat last actions menu and Repeat last action
- fix bug wit last actions menu when numeric shortcuts are enabled
- fix bug with last action when QAP feature menu item has a shortcut
- stop collecting text separators in last actions

Version BETA: 8.6.9.6 (2017-11-19)
- fix bug with Drives menu when dynamically refreshed menus are attached to QAP popup menu
- adding a new item "Repeat Last Actions" to "My QAP Essentials" menu for new installation only (existing users must add it themselves)

Version BETA: 8.6.9.5 (2017-11-19)
- limit number of items in Repeat Last Actions menu
- default to 10 item in the Repeat Last Actions
- add option to select the number of items in Repeat Last Actions in Options, Menu tab

Version BETA: 8.6.9.4 (2017-11-17)
 
Repeat Last Actions
- collect opened favorites to "Repeat Last Actions" menu (excluding Alternative menu features)
- display "Repeat Last Actions" menu with fix number of 5 last opened items (will be configurable)
- when an item is repeated, it is moved to the top of the "Repeat Last Actions" menu
 
Bug fixes from release v8.6.3
- make "Add this Folder or Line" work with recent versions of Firefox (tested with v56)
- fix bug when adding a link with "Add this Folder or Link" from the QAP icon menu
- fix display bug in "Edit favorite" dialog box when very long web page title is retrieved as favorite name
- fix bug when assigning an hotkey to an Alternative menu feature for the first time
- update to Brazilian Portuguese language file

Version: 8.6.3 (2017-11-16)
- make "Add this Folder or Line" work with recent versions of Firefox (tested with v56)
- fix bug when adding a link with "Add this Folder or Link" from the QAP icon menu
- fix display bug in "Edit favorite" dialog box when very long web page title is retrieved as favorite name
- fix bug when assigning an hotkey to an Alternative menu feature for the first time
- update to Brazilian Portuguese language file

Version BETA: 8.6.9.3 (2017-11-06)
 
Russian keyboard support
- various adjustments for systems where current input language (keyboard) is Russian (language code 0419)
- if Russian keyboard is detected, replace Windows + W and Shift + Windows + W menu keyboard hotkeys with equivalents keys on Russian keyboard (ASCII Unicode 1094)
- at first execution on a system with Russian keyboard, do not assign hotkeys to favorites of the default menu
- change method of initialization of Settings window hotkeys to avoid errors with Russian keyboard
 
Other
- update default hotkeys for QAP features in "My QAP Essentials" when creating the settings file at first execution
- fix bug in error message when a hotkey is not available in current keyboard layout
- update to German, Spanish, French, Italian and Dutch language files

Version BETA: 8.6.9.2 (2017-11-02)
- add QAP Feature to list "Recent Files" as remembered by Windows
- add option to display the refreshed folders "Recent Folders", "Recent Files" and "Drives" attached to the main menu (with a slight refresh delay at each menu popup) or detached as stand-alone menus refreshed on demand
- add an option in "General" tab to select the folder where the QAP temporary folder is created (and deleted when you exit QAP)
- for new installation starting with this version, the default temporary folder is created in Windows %TEMP% folder (e.g. C:\Users\UserName\AppData\Local\Temp)
- update to Italian, Portuguese and Brazilian Portuguese language files

Version BETA: 8.6.9.1 (2017-10-29)
- support change folder in PowerShell window as well as in command-line console (CMD)
- allow resize of window when selecting the destination menu for copied or moved multiple favorites, allowing to see longer menu destinations and save window last position to ini file and restore previous position
- add code to be more specific when detecting a file dialog box (Open, Save As, etc.) and exclude non-file dialog boxes (Preferences, Options, etc.)

Version: 8.6.2 (2017-11-06)
- for new inslallations only, add default hotkeys to QAP features:
  "Add This Folder or Link" -> Shift + Control + A
  "Reopen Current Folder in Dialog Box" -> Shift + Control + C
  "Clipboard" -> change from Shift + Control + C to Shift + Control + V
  (existing users can add it themselves in the Edit Favorite dialog box, Menu Options tab)
- fix bug display hotkey title in error messages when a hotkey is not available in current keyboard layout
- update to Italian, Portuguese, Brazilian Portuguese, German, Spanish, French and Dutch language files

Version: 8.6.1 (2017-10-29)
- fix bug default icon not set properly when adding a favorite (update RECOMMENDED for all users)
- block popup menu during menu refresh launched with QAP feature Refresh Live menus
- add link for monthly donations in Support freeware dialog box

Version: 8.6 (2017-10-26)
 
Add this Link
- the QAP Feature "Add This Folder" has been renamed "Add this Folder or Link" and now detects URL locations in browsers as well as folder locations in supported file managers
- when adding a link, QAP retrieves the web page title automatically as default favorite name; if the URL returns an error (this can happen even for valid pages), it leaves the favorite name empty
- when adding or editing a favorite link, a button allows to retrieve the page title from the web page
- a tooltip is displayed when retrieving web page title (in case fetching the tile takes some time)
 
Copy multiple favorites
- support copy multiple favorites (still excluding menus and groups)
- multiple copy stops when an existing favorite in the destination menu has the same name as the coped favorite (as for multiple move in previous versions)
- an error message is displayed when user ask to move or copy multiple favorites to their actual location
 
Text Separators
- a new favorite type "Text Separator" allows to insert text entries as headers or sub-headers in the QAP menu (selecting these entries in the menu has no effect)
- a new "T" icon in the left column of Settings window can be clicked to add Text Separators
- by default, Text Separators have no icon but one can be selected in the "Menu Options" tab
 
Favorites icons management 
- QAP now allows favorites to have "no icon"
- in add/edit favorite dialog box "Menu Options" tab, a new link labeled "no icon" selects the "no icon" pseudo-icon (the "forbidden" sign with a diagonal bar)
- the "no icon" icon can also be selected in the JLicons.dll file
- the favorite icons taken in JLicons.dll are now saved in the settings file by their name (e.g. "iconFolder") instead of the "file,index" format used for icons from other files
- current icons from JLindex.dll in the settings file are be converted from "file,index" format to names (e.g. "iconFolder") the first time settings are saved with this version (and future versions)
- in add/edit favorite dialog box "Menu Options" tab, a new link labeled "select in JLicons.dll"
- a new icon file named JLicons.dll v1.3 including the new iconNoIcon pseudo-icon will be automatically updated for Setup users (for portable installation, make sure the previous file is replaced)
 
Unicode conversion
- QAP now save its settings (QuickAccessPopup.ini) with Unicode encoding, allowing more international and special charactes to be saved in favorites location, snippets content or favorites names
- QAP still supports existing settings file saved in ANSI encoding but it offers to do the conversion QAP is loaded with this version (and future versions)
- if settings file is encoded in ANSI, QAP displays a dialog box offering the user to:
  1) convert its settings file to Unicode encoding (for better int'l and special characters support);
  2) not convert (value "DoNotConvertSettingsToUnicode=1" is added to settings to remember this choice);
  3) or ask again at next startup.
- the dialog box includes a link to a FAQ web page for explanation and help (https://www.quickaccesspopup.com/why-converting-the-settings-file-to-unicode-and-conversion-troubleshooting/)
 
Various
- the option "Always open folders in current file manager window" in Options, "Files mamagers" tab is added to always change folder in the current Explorer, Total Commander or Directory Opus window, except when using the Alternative menu "Open in new window"; this applies to favorites of types Folder, Special Folder and FTP
- improve visibility of the "Explorer context menu" option in Options "Menu" tab
- new value SendToConsoleWithAlt in Global settings, default 1 (true), to use the ALT+0nnn ASCII codes when changing folder in a command-line window (CMD)
- partial update of all language files (complete updates in next versions), full update of the French language file
 
Bug fixes
- fix bug when changing folder in command-line window (CMD) with some international keyboard input language (by using the ALT+0nnn ASCII codes)
- fix bug when opening an application favorite with {CUR_LOC} and when location is empty (this was happening when the current window was not an Explorer window)
- fix bug when user cancels the pick icon dialog box, now QAP keeps the selected icon

Version BETA: 8.5.9.4 (2017-10-26)
- fix bug when changing folder in command-line window (CMD) with some international keyboard input language (by using the ALT+0nnn ASCII codes)
- new value SendToConsoleWithAlt in Global settings, default 1 (true), to use the ALT+0nnn ASCII codes when changing folder in a command-line window (CMD)
- change internal processing of version number when comparing running vs latest version number

Version BETA: 8.5.9.3 (2017-09-30)
- add option "Always open folders in current file manager window" in Options, file managers tab, to allow always change folder in the current file manager (Explorer, Total Commander or Directory Opus) for favorites of types Folder, Special and FTP (except when using the Alternative menu "Open in new window")
- support copy multiple favorites (excluding menus and groups)
- multiple copy stops when a favorite has the same name in the destination menu (as for multiple move in previsous versions)
- error message when user ask to move or copy multiople favorites to their actual location
- add tooltip when retrieving web page title (in case fetching the tile takes time)
- improve visibility for Explorer context menu option in Menu tab

Version BETA: 8.5.9.2 (2017-09-24)
- Add this Folder or Link now works for links when called from the menu in the Notification zone (Tray icon)
- add diagnostic code

Version BETA: 8.5.9.1 (2017-09-19)
 
Text Separators
- new favorite type "Text Separator" allowing to insert text entries as headers in the QAP menu (selecting these entries does just nothing)
- new "T" icon in the left column of Settings window to add Text Separators
- by default, Text Separators have no icon but you can select one in the "Menu Options" tab
 
Favorites icons management 
- allow favorites to have "no icon"
- new link labeled "no icon" in add/edit favorite dialog box, "Menu Options", selecting the "no icon" pseudo-icon (the "forbidden" sign with a diagonal bar) for this favorite
- the "no icon" icon can also be selected in the JLicons.dll file
- the icons from JLicons.dll are now saved in the settings file by their name (e.g. "iconFolder") instead of the "file,index" format used for icons from other files
- current icons from JLindex.dll in the settings file will be converted from "file,index" format to names (e.g. "iconFolder") next time you save your settings
- new link labeled "select in JLicons.dll" in add/edit favorite dialog box, "Menu Options", shown only if current icon is not already picked from this file
- new JLicons.dll v1.3 including iconNoIcon will automatically replace the current JLicons.dll file for Setup users (user preferinf portable installation, make sure you unzip and update this file)
 
Add this Link
- rename QAP Feature "Add This Folder" to "Add this Folder or Link" and detect URL location as well as folder location
- when using "Add this Folder or Link" to add a link, retrieve the web page title automatically as default favorite name; it the URL returns an error (this can happen even for valid pages), leave the favorite name empty
- when adding or editing a favorite link, add a button to get the page title from the we page and put it as default for the favorite name
 
Unicode conversion
- if QAP settings file (QuickAccessPopup.ini) is encoded using ANSI standard, display a dialog box offering the user to:
  1) convert its settings file to Unicode (for better int'l and special characters support);
  2) not convert (value DoNotConvertSettingsToUnicode=1 is added to settings to remember this choice);
  3) or ask user next startup.
- dialog box includes a link to a FAQ web page for explanation and help (https://www.quickaccesspopup.com/why-converting-the-settings-file-to-unicode-and-conversion-troubleshooting/)
 
Various
- fix bug when opening an application favorite with {CUR_LOC} and when location is empty (when the current window is not an Explorer window)
- fix bug when user cancel the pick icon dialog box, now it always keep the selected icon
- Duth language file updated

Version: 8.5.2/8.5.3 (2017-09-08)
- v8.5.3 fixes a comment typo in v8.5.2 preventing the app to load
- reverting change from v8.5.1 causing issues for users having special characters in their favorites paths : at QAP startup, STOPS converting QuickAccessPopup.ini to Unicode encoding if it is is ANSI (until more tests are done)
- for new installations, this change is maintained: create new settings file QuickAccessPopup.ini with Unicode encoding

Version: 8.5.1 (2017-09-07)
- create new settings file QuickAccessPopup.ini with  Unicode encoding; this change allows the use of extended characters in favorite's name, location or content
- at QAP startup, check if QuickAccessPopup.ini encoding is ANSI and, if yes, convert it to Unicode encoding and inform user
- fix bug expand placeholder {CUR_LOC} in application favorite's working directory before checking if directory exists
- fix bug display "Reset default hotkey" in "Select hotkey" dialog box when there is no default

Version: 8.5 (2017-09-04)
  
Menu key
- you can now use the Menu key (also called Context menu key or Application key) to pop up the QAP menu or launch any favorite
- to select the Menu key, in the "Select Hotkey" dialog box, click on the "menu key (application)" link below the hotkey selector
- this hotkey can be combined with any modifiers (Shift, Alt, Ctrl or Win)
  
Snippets
- major improvements to make Snippets easier to create and edit
- a button in snippet add/edit favorite dialog box to enlarge the snippet content text box
- font size selector for snippet text box
- check box to display a snippet with fixed font (useful for code snippets)
- display preferences saved with each snippet
- default preferences for snippets can be selected in Options, General tab
- when launching a snippet with the "Prompt before" option, QAP also accepts Space to kick-off a snippet (in addition to Enter)
- change help link to new FAQ page about snippets (see improved FAQ content about Snippets)
  
Reopen Current Folder in dialog box
- a feature I should have included much earlier... Warning: to take advantage of it, existing users must add themselves this new feature to their menu
- new QAP feature "Reopen Current Folder in dialog box" allowing to reopen in a dialog box the current location in Windows Explorer
- the current location is the folder currently displayed in the active (or in the last active) Windows Explorer window
- current location is also detected in Directory Opus or Total Commander if one of these file magagers is enabled
  
Hotkeys
- set QAP feature default hotkeys for "Reopen Current Folder" to Shift+Ctrl+C  (of course, you can change it at any time)
- change QAP feature "Clipboard" default hotkeys from Shift+Ctrl+C to Shift+Ctrl+V
- this change is only for new installations - exising users must do this change themselves, if they wish
  
Various
- the "Ctrl + Ctrl" option has been moved to the "Alternative menu" tab in Options dialog box, and its presentation has been improved
- add a link beside the "Check for update" checkbox in the Options dialog box to check for update immediately
- check if the "Start in" folder location exists before launching a favorite and do not launch it if the location is not found
- offer to edit the favorite when one of these folder locations is not found: folder, document or application location, "Launch with" application location or "Start in" folder location
  
Language
- new! Dutch language is now available, thanks to Ric Roggeveen
- German translation update for changes since v8
- updates for Spanish, Italian and French language files, thanks to translators
  
Bug fixes
- fix an error in QAP 32-bit executable file preventing the Windows Explorer context menus to work with QAP installed in portable mode
- allow favorite location to be a UNC root path (like \\127.0.0.1\ or \\MyDomain\) assuming the location is online because Windows does not allow to check if an UNC root location is available (on my system, Windows 10 defaults to the "Documents" folder if the UNC drive is not mounted)
- fix bug when adding a QAP feature and when its default hotkey is already in use for another favorite
- fix bug when processing backtick (accent grave) in snippets (used for code snippets) and add help about backticks in add/edit dialog box
- fix bug Alternative menu hotkey reappearing after delete when returning to Options dialog box until QAP is restarted
- fix bug && displayed in Drag & Drop help window title instead of &
- add diagnostic code to track the "71 hotkeys limit" bug - if someone encounter this error message, please contact me

Version BETA: 8.4.9.5 (2017-09-03)
- fix bug Alternative menu hotkey reappearing after delete and returning to Options dialog box
- make backup of Alternative menu hotkey when opening Options dialog box in case user chancels changes
- add to default My Essentials menu the QAP feature "Reopen current folder in dialog box"
- Ctrl+Ctrl option presentation improved in Options diaolog box
- remove default hotkey +^V for Alternative menu Copy Favorite Location
- update to Spanish, Italian, Dutch and French language files

Version BETA: 8.4.9.4 (2017-08-26)
 
Snippets
- add button in snippet add/edit favorite dialog box to enlarge or restore the initial size of the snippet content text box
- default snippet to automatically encode
- save encode value for each snippet
- add fixed font and font size options and save value for each snippet
- add default snippet encode, fixed font, font size and macro mode default values to options General tab, save and retrieve values to ini file
 
Various
- allow favorite location to be a UNC path (like \\127.0.0.1\ or \\MyDomain) assuming the location exists (if network location is offline, it could give an error or open the default Document folder)
- remove tip about {CUR_LOC} in Add/Edit dialog box for snippets because this option is irrelevent for this type of favorite
- Dutch translation (thanks to Ric Roggeveen!)

Version BETA: 8.4.9.3 (2017-08-23)
 
Snippets
- fix bug with processing of backtick in snippets and add help about backticks in add/edit dialog box
- change method to kick-off a snippet when the "Prompt before pasting" option is used (using the Input command instead of KeyWait)
- also accept Space to kick-off a snippet (in addition to Enter)
- change help link to new FAQ page about snippets (see imprioved FAQ content about Snippets)
 
Menu key
- new approach for menu key, more integrated with existing hotkey management, menu key can now be used with modifiers
- in select hotkey dialog box, add "menu key (application)" to options for invisible characters
- when displaying hotkey as text, replace "sc15D" (keyboard scan code for Menu key) with "Menu key"
 
Various
- renamed menu label "Reopen Current Folder" to "Reopen Current Folder in Dialog Box" (because it is of use only in dialog boxes)
- fix bug in "Reopen Current Folder in Dialog Box" if no file manager is running
- fix bug && displayed in Drag & Drop help window title instead of &
- fix bug when adding a QAP feature and its default hotkey is already in use for another favorite
- merge change from v8.4.2 about Explorer context menu for Windows Shortcuts (see change log)
- German translation update for v8.0.4 to v8.3

Version: 8.4.2 (2017-08-18)
- stop creating Windows Explorer context menu for Windows Shortcuts (.lnk files) because of potential security issue
- if you need to remove this context menu see the FAQ (https://www.quickaccesspopup.com/how-can-i-remove-the-windows-explorer-contextual-menu-for-windows-shortcuts-lnk-files/)

Version BETA: 8.4.9.2 (2017-08-09)
- Menu key hotkey now removed properly checkbox is turned off
- Menu key now navigate in active Explorer or open in a new window as would do the regular keyboard hotkey

Version BETA: 8.4.9.1 (2017-08-07)
- set QAP feature default hotkeys for "Reopen Current Folder" to Shift + Ctrl + C
- change QAP feature "Clipboard" default hotkeys from Shift + Ctrl + C to Shift + Ctrl + V
- add a link beside "Check for update" checkbox in the Options dialog box to check for update now
- add an option to use "Menu key" (aka Context menu key or AppsKey) to open the QAP pop menu
- move "Ctrl + Ctrl" and "Menu key" options to tab Alternative menu tab in Options dialog box
- check if the "Start in" folder location exists and do not open the favorite if location is not found
- when favorite's location, "Launch with" application location or "Start in" folder location not found, edit the favorite if user answers yes when prompted
- add diagnostic code to track the "71 hotkeys limit" bug

Version BETA: 8.4.9 (2017-08-05)
- new QAP feature "Reopen Current Folder" allowing to reopen the current location in the last active file manager (Windows Explorer or, if enabled, Directory Opus/Total Commander), most useful in file dialog boxes Open, Save As, etc.
- rewrite of internal functions used to detect more reliably the current location in hew active file manager (Windows Explorer, dialog boxes or, if enabled, Directory Opus/Total Commander); potential impacts on Add this folder, drag & drop files to Settings window, Reopen a Folder, Reopen Current Folder, {CUR_LOC} and other {CUR_...} placeholders in favorite location and advanced parameters

Version: 8.4.1 (2017-08-05)
- fix bug maximum of Live Folders items exceeded (500 items limit) by error
- fix bug last Live folder item duplicated when numeric shortcuts are enabled
 
Version: 8.4 (2017-08-01)
- add "Always on top" option to Settings window to ease drag and drop
- update drag & drop help message
- remember window location when drag & drop a folder favorite to Settings window
- add a tab about Shared Menus in Help window
- add tooltips over left column buttons in Settings window
- fix bug when icon resource filename includes a coma
- fix links in Options tabs and fix links to Shared menu FAQ page on website
- Spanish, Brazilian-Portuguese, Italian and French language updates

Version: 8.3 (2017-07-20)
  
Changes already published in beta version v8.2.9 to v8.2.9.4.
  
Search
- add search text box to filter favorites in all submenus in Settings window
- add an X button to empty the filter text box and restore the full favorites list
- filtering is done based on the existence of the search string in the favorites name (only) in all menus and submenus
- filtering is case insensitive
- filtered favorites are displayed in the order they were found, starting from top main menu
- in filtered favorites list, the Edit button, Enter key or double-click open the edit favorite dialog box with the selected favorite
- double-clicking a menu favorite in filtered favorites list opens this menu unfiltered
- after edition of a favorite, the regular favorites list is restored in the location of the edited favorite
- the Remove button or Delete key removes a favorite from the filtered list (with confirmation before deleting a menu and its submenus); after deletion, the filtered list remains active
- in filtered list, only single selection is available, allowing edition or deletion of only one favorite at a time
- left columns buttons to move favorites or insert separator buttons (and their associated hotkeys) are disabled in filtered list
- in filtered list, the Add button (and its associated hotkey Ctrl-N) adds a new favorite at the top of the main menu
- changing menu using the dropdown list, using back or top arrows and closing and re-opening the Settings window restore the regular unfiltered list
- in Settings window, the new shortcut Ctrl-F moves the cursor to search box
  
Shared menus
- complete rewrite of Shared menus file locking (reservation to avoid conflictual changes by simulatneous users)
- when opening the add/edit favorite dialog box, QAP checks if the favorites belongs to a Shared menu and displays a message if the menu is read-only, locked (reserved) by another user or if it was changed since QAP was launched
- when saving a favorite (or when moving a favorite using arrows in Settings, or when adding a separator or a column break), QAP checks if the favorites belongs to a Shared menu and, if yes, checks if the shared menu was locked or modified since the dialog box was opened and, if yes, displays a message
- after a favorite in a shared menu is saved in QAP "internal" memory, QAP locks (reserves) the shared menu file until the changes in shared menu are actualy saved to the settings file QuickAccessPopup.ini, preventing other users from editing this shared menu
- QAP display "Read-only" in the Settings window's content column and prevent opening this menu in the Settings window if it is saved in a folder where the user has no write access and for shared menus of type "Centralized" where user does not have write-access for this menu
- when creating a Shared menu of type "Centralized", QAP automatically adds the current username to the write-access list (preventing the user to be locked out of its own new menu)
- in "Centralized" Shared menus write-access list, names can also be separated by semicolon (in addition to comma)
- a shared menu cannot be added under another shared menu
- QAP now supports Shared menu file locking when changes are done using the "Manage icons" window
- in Settings window column labeled "Content", QAP now displays the Shared menu settings file location
  
New Explorer Context menu for Windows shortcuts
- add an Explorer context menu for Windows shortcuts file (.lnk files) labeled "Import Windows shortcut to Quick Access Popup menu" to import shortcut settings to QAP favorites
- QAP imports the following settings from Windows shortcut: working directory (for application favorites), window state (for folder favorites) and icon settings (for any type of favorites)
- note for user of portable version: the file ManageContextMenu.bat has been updated to include the new context menu "Import Windows shortcut to Quick Access Popup menu"
  
Various
- add Settings shortcut F1 to open the Help window
- add Settings shortcut Ctrl-H to display the Favorites Shortcuts Help window
- update the Favorites Shortcuts Help window
  
Bug fixes
- fix bug having various side effects after user made changes to Settings and cancelled these changes with the Cancel button
- fix bug when opening a folder and active window is QAP Settings window

Version BETA: 8.2.9.4 (2017-07-20)
- fix bug losing current position in favorites list when adding a favorite in Settings window

Version BETA: 8.2.9.3 (2017-07-15)
- add Explorer context menu labeled "Import Windows shortcut to Quick Access Popup menu" to import .lnk files to QAP favorites
- import following settings from Windows shortcut: working directory (for application favorites), window state (for folder favorites) and icon settings (for any type)
- reset Search label in empty search box when Settings is shown
- fix bug with search filter when showing the gui from add favorite QAP feature
- fix bug when add favorite from QAP showing shared menu error at fresh start only
- fix bug when opening a folder and active window is QAP Settings window
 
Version BETA: 8.2.9.2 (2017-06-26)
 
Search in Settings
- add search text box to Settings window above favorites list with an x button to empty the filter text box
- add a filtered favorites list shown automatically over the regular favorites list when text is typed in the filter text box and hidden when the search text box is emptied
- filtering is done based on the existence of the search string in the name (only) of favorites in all menus and submenus, starting from top main menu
- in filtered favorites list, show the same columns as in the regular list plus the menu path in second column, after favorite name
- Edit button, Enter key or double-click in the filtered list open the edit favorite dialog box with the selected favorite, except if it is a menu where the double-click will open the submenu
- when edited favorites is saved (or cancelled), the regular favorites list is restored in the location of the edited favorite
- Remove button or Delete key removes a favorite from the filtered list (with confirmation before deleting a menu and its submenus); after deletion, the filtered list remains active
- in filtered list, only single selection is available, allowinf edit or deletion of only one favorite at a time (support for multiple deletion or multiple move could be added but requires more work)
- disable left columns move and separator buttons (and associated hotkeys) in Settings when filtered list is active
- in filtered list, the Add button (and its associated hotkey Ctrl-N) adds a new favorite at the top of the main menu
- hide filtered list anjd restore regular favorite list, when changing menu using the dropdown list or back or top arrows in Settings, and when closing and re-opening the Settings window
- add Settings shortcut Ctrl-F to move the cursor to search box
 
Other
- add Settings shortcuts F1 to open Help window
- add Settings shortcut Ctrl-H to display the Favorites Shortcuts Help window
- update the Favorites Shortcuts Help window
- fix bugs having various side effects after user made changes to Settings and cancelled these changes (with the Cancel button), breaking the backlinks ("..") to parent menu, breaking the check for shared menus changes in since menu was loaded
 
Bug fixes from master branch v8.2.3
- fix bug blocking removal of multiple favorites when user answers no when asked to confirm removal of a submenu
- fix label display bug under Remove button preventing showing the number of selected favorites

Version BETA: 8.2.9.1 (2017-06-24)
- include read-only external menu in menus dropdown list in Settings for navigation (not in the same list when in Add/Edit favorite or move favorites)
- fix bug declare a menu read-only when menu is under a read-only shared menu, in save favorite, remove favorite, add separator or column

Version BETA: 8.2.9 (2017-06-19)
- complete rewrite of Shared menus file locking (reservation to avoid conflicutal changes by simulatneous users)
- when opening the add/edit favorite dialog box, QAP checks if the favorites belongs to a Shared menu and displays a message if the menu is read-only, locked (reserved) by another user or if it was changed since QAP was launched
- when saving a new or edited favorite (or when moving a favorite using arrows in Settings, or when adding a separator or a column break), QAP checks if the favorites belongs to a Shared menu and, if yes, checks if the shared menu was locked or modified since the dialog box was opened and, if yes, displays a message
- after the new or edited favorite in a shared menu is saved in QAP "internal" memory, QAP locks (reserves) the shared menu file until the changes in shared menu are actualy saved to its settings file, preventing other users to edit this shared menu
- QAP handles scenarios where the parent menu in the favorites dialog box "Menu Options" tab is changed, handling file locking if one or both menus are shared menus
- QAP display "Read-only" in the Settings window's content column and prevent opening this menu in the Settings window if it is saved in a folder where the user has no write access and for shared menus of type "Centralized" where user does not appear in the write-access users list
- QAP checks if a shared menu is in a read-only folder by attempting to create a temporary settings file in this folder, test filename being "~$_QAP_Test_file_nnn.ini", where "nnn" is a random number (by convention file sync tools like Dropbox ignore file starting with "~$")
- QAP checks if folders containing Shared menus files are read-only only once in a session; if the read-only setting of a folder is changed during QAP is running, QAP will consider it can be written to until QAP is restarted (this could cause a file write error, visible or not)
- when creating a Shared menu of type "Centralized", QAP automatically adds the current username to the write-access list (preventing the user to be locked out of its own new menu)
- in "Centralized" Shared menus write-access list, names can also be separated by semicolon (in addition to comma)
- QAP checks that an external settings file cannot be added under another external settings file (this is not supported in current version)
- QAP now supports Shared menu file locking in the "Manage icons" window (in previous QAP versions, this window was not properly handling shared menu file locking)
- in Settings window's "Content" column, QAP now displays the Shared menu settings file location

Version: 8.2.3 (2017-06-24)
- fix bug blocking removal of multiple favorites when user answers no when asked to confirm removal of a submenu
- fix label display bug under Remove button preventing showing the number of selected favorites

Version: 8.2.2 (2017-06-08)
- Test if user has write access when opening a collaborative Shared menu in Settings and give appropriate error message if user has no access
- In Shared Menus Catalogue, replace "&&" in menu names with single "&"
- Change QAP feature label "Add shared favorites menu from catalogue"
- In the Add Favorite dialog box, add info about Live Folder Options in Folder tip
- Fix display bug in Settings, change cursor to hand when mouse over some icons and labels

Version: 8.2.1 (2017-05-19)
- Multi-user change collision bug fixed (menu loaded on machine A; menu loaded on machine B; shared menu edited and saved on machine B; menu other than the shared menu edited on machine A
  -> BUG: machine A overwrites changes done on machine B; shared menu are now saved only if changes were done to the menu)
- when create Shared menu, force to select shared menu type
- support relative paths and environmenet variables for external menu file path
- fix bug when Add/Edit Favorite of type Shared menu, browse for external file and cancel browse
- add QAP feature to get direct access to the catalogue (Add a Shared menu from the catalogue)
- add tip below Shared menu catalogue list about double-click on a line to view the shared menu info

Version: 8.2 (2017-05-14)
 
Shared menus revamped
- three type of Shared menus
  1) Personal: menu shared on different computers by the same user
  2) Collaborative: menu on a shared drive for a team or a workgroup (every member can edit the menu)
  3) Centralized: menu on a shared drive maintained by one or more menu administrator(s)
- new "Shared menu" tab in shared menu favorites to select shared menu type (radio buttons), name and options
- options for "Centralized" shared menus: list of users with right to edit the shared menu (coma separated list), message about shared menu access shown to users without access
- Shared menu options are saved in the "[Global]" section of the share menu ini file, in variables "MenuName", "WriteAccessUsers", "WriteAccessMessage" and "MenuType"
- in favorites list, display Shared menu name and display "Read-only" if current user does not have write access to the centralized menu
- when adding a Shared menu, get the favorite name from the menu ini file if the variable "MenuName" exists
- deprecate the option "Number of the first favorite" in shared menu files (now favorites always starting at 1 but starting number in old menu are still supported)
 
Shared menus catalogue
- new option in "General" tab to "Enable Shared Menu Catalogue" and select the "Catalogue root folder"
- when user adds a Shared menu and when the catalogue is enabled, give user the option to select the Shared menu from a dialog box
- new Shared menu dialog box containing the shared menu files under the catalogue root with menu names, paths and checkboxes to select menu(s) to add to QAP popup menu
- in Shared menu dialog box, button "Add selected shared menu(s)" to add selected menu(s) from catalogue to the QAP menu at the current menu and position in favorites list
- in Shared menu dialog box, button "Add another shared menu" to browse the file system for any Shared menu settings file and add it to current position in favorites list
- in Shared menu dialog box, respond to double-click on a row by showing Shared menu info and a button to open the settings file in a text editor if it is not read-only
- new "ExternalMenusCataloguePathReadOnly" variable (in QAP ini file only) to prevent user from changing the catalogue root folder when value is 1, and display an error message if user tries to change the root if read-only
 
Shared menus mutli-user edition
- alert message when user tries to edit an external menu that was modified by another user or on another computer, based on last modification date-time
- reserve external menu when user loads a Shared menu in Settings or when user add or move favorites to a Shared menu, user and computer name are savec in the Shared menu variable "MenuReservedBy"
- release Shared menu reservation when user saves or cancels settings changes or quits QAP
- store and read last modified date in Shared menu ini file and update it only when favorites or external menu properties are changed, not when only reserved without changes
- in "About" dialog box, display user name and computer name
 
Other changes
- new Alternative menu QAP features "Open the Containing Folder in the Current Window" and "Open the Containing Folder in a New Window" to open the folder containing the selected document, application  or folder favorite in the current window or in a new window
- in Export file name, translate placeholder "%A_Now%" to current local date-time and "%A_NowUTC%" to current Coordinated Universal Time (based on computer time), using "YYYYMMDDHH24MISS" format
- in "Import/Export Settings", remember lats destination file in quickaccesspopup.ini when exporting and restore last used file name in when exporting settings
- in "Live folders", exclude folders with the Hidden (H) attribute (keeping those having System attribute without the Hidden attribute)
- enlarge submenus dropdown lists to 500 px in "Add/Edit Favorite" dialog box
- disable the popup menu during settings saving
- remove Patreon donation option; add Paypal links to make donations in EUR and CAD funds
- update to Spanish, Portuguese and Brazilian Portuguese language files
 
Bug fixes and improvements
- fix bug in Setup program when updating QAP causing QAP Explorer context menus to be re-enabled even if user turned them off in Settings
- fix bug "Open this menu" button missing in "Edit favorite" dialog box for Shared menus favorites

Version BETA: 8.1.9.6 (2017-04-01)
- in add/edit favorite, shared menu tab, change external type only if a value exists in external file loaded (no more default to type 1)
- adapt Shared menu note depending if we are in Add or Edit dialog box
- during saving settings, do nothing if user tries to open the popup menu
- fix bug in Setup program when updating QAP causing QAP Explorer context menus to be re-enabled even if user turned them off in settings

Version BETA: 8.1.9.5 (2017-03-28)
- when Shared Menu Catalogue root path is set in Options, display the Catalogue when user add Shared menu
- list all shared menu under the root path (excluding backups) to the Catalogue dialog box with shared menu names, shared menu paths and checkboxes to select shared menu to add to current menu at the current position in favorites list
- button Add selected shared menus
- button Add another shared menu to browse the file system for any shared menu settings file
- respond to double-click on a shared menu row by showing shared menu info with a button to open the shared menu settings file if it is not read-only
- update to Spanish, Portuguese and Brazilian Portuguese language files

Version BETA: 8.1.9.4 (2017-03-15)
 
Shared Menus
- in Add/Edit Favorite for external menus, replace the "Advanced Settings" tab with "Shared Menu" tab
- in the "Shared Menu" tab, add radio buttons for external menu types 1) Personal, 2) Collaborative (show menu name only) or 3) Centralized (show menu name, write access users and message)
- display alert message about write access when user change type for type 3
- store external menu type in external menu [Global] value "MenuType"
- for collaborative external menu, save "MenuReservedBy" value as "user (computer)" and prevent access if reserved
- for personal external menu, save "MenuReservedBy" value as "computer (user)" and display only alert and allow access if reserved
- in Options, improve Shared Menu Catalogue root path selection with text box and browse button
- in About, display user name and computer name

Version BETA: 8.1.9.3 (2017-03-10)
 
Shared menus (see updated FAQ page https://www.quickaccesspopup.com/can-a-submenu-be-shared-on-different-pcs-or-by-different-users/)
- error message when user tries to load an external menu that was modified based on file last modified date-time
- store and read last modified date of external file in ini file and update it only when favorites or external menu properties are changed, not when only reserved without changes
- update the last modified date-time of external ini file and in external menu object when user save changes
- reserve external menu when user loads the external menu in Settings or when user selects parent menu menu in add/edit favorite or move dialog boxes
- track user reserving an external menu writing his username in variable MenuReservedBy
- block external menu editing if menu is reserved except if reserved by current user
- release reserved external menus when user saves or cancels settings changes or quits QAP
- fix bug prevent editing favorites in read-only external menu from the Edit Favorite Alternative menu
 
Other changes
- enlarge submenus dropdown lists to 500 px in Add/Edit Favorite dialog box
- remove Patreon donation option; add Paypal links to make donations in EUR and CAD funds

Version BETA: 8.1.9.2 (2017-02-28)
 
Shared menus
- add to Options general tab the "Enable Shared Menu Satalogue" checkbox and prompt user for catalogue root when enabling
- add "ExternalMenusCataloguePathReadOnly" variable to QAP ini file to prevent user from changing the catalogue root and display an error message if user tries to change rthe root when read-only
- when user adds a favorite of type Shared menu and Shared Menu Catalogue root exists, give user the option to select the Shared menu from the catalogue (using file select dialog box at this time - to be improved)
- when adding a Shared menu, get the favorite name from the shared menu file if variable "MenuName" exists
 
Version BETA: 8.1.9.1 (2017-02-28)
 
Shared menus
- in Advanced settings tab, add "Read-only" checkbox and text boxes for "Shared menu name", "Users with write access to this shared menu" (coma separated list) and "Shared menu write access message"
- saving these values to shared menu ini file as soon as user click OK in "Add/Edit favorite" dialog box (not waiting for when user saves the favorites)
- values are saved in "[Global]" section under "MenuName", "WriteAccessUsers" and "WriteAccessMessage"
- grant write access to read-only shared menu to users having their Windows logon name in the "Users with write access to this shared menu" text box
- display shared menu name and write access message in error message when user tries to edit a read-only shared menu
- display shared menu name in content column of shared menu entries in Settings
- deprecate first line number value in external menu files, now always starting at 1 (starting number in old menu still supported; please advise me if this cause issue)

Version: 8.1.1 (2017-03-19)
 
Import/Export
- in Import/Export Settings, save destination file to quickaccesspopup.ini when exporting and restore last used file name in Export dialog dox
- in Export file name, translate placeholder "%A_Now%" to current local date-time and "%A_NowUTC%" to current Coordinated Universal Time (based on computer time), using "YYYYMMDDHH24MISS" format
 
Alternative menu
- new Alternative menu QAP features to open the folder containing the selected document, application  or folder favorite in the current window or in a new window
 
Various improvements
- in Live folders, exclude folders with the Hidden (H) attribute (keeping those having System attribute without the Hidden attribute)
- in Edit Favorite dialog box for a favorite of type Group, add a button to open the group in the Settings window
- enlarge submenus dropdown lists to 500 px in Add/Edit Favorite dialog box
- split Options dialog box first tab in two tabls (General and Menu options) to make some room for future options
- remove "Use Classic buttons" option in General tab ([Global] value "UseClassicButtons" still supported if present in ini file)
- remove Patreon donation option; add Paypal links to make donations in EUR and CAD funds
- tooltip "Saving..." and disable Cancel button in Settings during saving
 
Bug fixes
- support relative paths and environment variables in Live Folders
- fix bug prevent editing favorites in read-only external menu from the Edit Favorite Alternative menu

Version: 8.1 (2017-02-20)
 
Shortcuts
- display favorites shortcuts in a new column in the Settings
- when creating a favorites shortcut, support left only or right only keyboard modifiers for Shift, Alt, Ctrl and Win keys
- support different shortcuts for favorites with the same location (if they have different names), allowing them to have different options (in other words, favorite shortcuts are now linked to "name + location")
- update menu and dialog box labels to include menu shortcuts (underlined character, using the & special character)
 
Various
- in QAP Mouse Hotkey exclusion list, also exclude hotkey in app's dialog boxes when the app's title or class name is prefix an asterisk (*)
- add the QAP Features "Run as administrator" to the Alternative menu (Shift + Middle mouse button or Shift + Windows + W)
- new batch file from Dogan Celik to install/uninstall Windows Explorer context menus registry keys, working as-is with portable version (see instructions in batch file)
- group members can now be disabled (same as favorites being hidden in menu), change disable checkbox label for group members
- renamed the icon file iconQAP.ico to QuickAccessPopup.ico using the same ico file name for context menu registry keys in app, setup and portable batch
 
Bug fixes
- cover exceptional situation where icon "file,index" for an extension is badly encoded in registry (including ")
- fix bug when double-clicking on empty line in Hotkeys list
- fix bug in Hotkeys list, when change hotkey, enable save button only if a hotkey was changed
- fix bug when Menu hotkey in Options is changed from None to a keyboard shortcut
- add delay when changing folder in dialog box to help with an intermittent issue in in some apps like Firefox (delay in milliseconds stored in quickaccesspopup.ini "[Global]" variable "WaitDelayInDialogBox" with default 100)

Version BETA: 8.0.9.2 (2017-02-14)
- exclude QAP mouse hotkey in dialog boxes based on the title or the class name of the dialog boxes parent window; for title or class prefixed with "*" in exclusion list, QAP will also exclude app's dialog box
- group members can now be disabled (same as favorites being hidden in menu), change disable checkbox label for group members
- add delay in navigate dialog box to solve (partly?) an intermittent issue in Firefox (and other apps?) dialog box; store delay in ini file variable WaitDelayInDialogBox (default 100 ms)
- add separator before RunAs in Alternative menu

Version BETA: 8.0.9.1 (2017-02-05)
- add the Run as administrator command to the Alternative menu (Shift + MMB or Shift + Windows + W)
- display shortcuts in a new column in the Settings
- in favorites shortcuts, support left only or right only keyboard modifiers for Shift, Alt, Ctrl and Win keys
- support different shortcuts for favorites with the same location with different options, if they have different names (hotkeys are now linked to "name + location")
- update menu and dialog box labels to include menu shortcuts (underlined character, using the & special character)
- new batch file from Dogan Celik to install/uninstall Windows Explorer context menus registry keys, working with portable version without editing
- renamed the icon file iconQAP.ico to QuickAccessPopup.ico using this ico file for context menu registry keys in app, setup and portable batch
- fix bug double-click on empty line in Hotkeys list stop opening an empty Change hotkey dialog box
- fix bug in Hotkeys list, when change hotkey, enable save button only if a hotkey was changed
- fix bug when Menu hotkey in Options is changed from None to a keyboard shortcut
- cover exceptional situation where icon file,index for an extension is badly encoded in registry (including ")

Version: 8.0.4 (2017-01-11)
- fix bug in Manage Hotkeys list not retrieving correct favorite on double-click
- alert about menu shortcuts to user when inserting ampersand (&) in short name for the menu
- update to Chinese and French language file

Version: 8.0.3 (2017-01-09)
- fix small issue with check for update command

Version: 8.0.2 (2017-01-08)
- fix Settings dialog box issue with Chinese translation
- update current year in About dialog box
- update to Sweeden, Italian, Portuguese, French and Spanish language files

Version: 8.0.1 (2017-01-07)
- add NbLiveFolderItemsMax default value to QuickAccessPopup.ini to make it easier to change this value
- links updated in Support freeware dialog box

Version: 8 (2017-01-03)

Live Folder options
- To enable a Live Folder favorite, add or edit a Folder favorite and go to the new tab "Live Folders Options". In this tab you can select:
  - the checkbox "Live Folder" to transform this favorite into a menu (and submenus) refreshed with the current content of the folder (and its subfolders)
  - an option to set the "Number of subfolders levels to include in the Live Folder menu" (1 by default - keep it low for large folders)
  - an option to "Include Documents" in the Live Folder
  - an option to "Include" or "Exclude" documents by file extensions
  - an option to split Live Folder menu in columns of a given "Number of items per column (0 for no column break)"
- Add the new QAP Feature "Refresh Live Folders menus" to your menu to refresh Live Folder on-demand (normally, Live Folder menus are refreshed when you launch QAP of when you save changes in Settings)
- QAP adds items to Live Folders up to a maximum of 500 items; if this number is exceeded, it displays an alert message
- You can edit a Live Folder favorite in the "Settings" window or using the Alternative menu "Edit a Favorite" (Shift+Middle Mouse Button or Shift+Win+W) and also by clicking any item in a Live Folder menu with Shift+Ctrl menu modifiers pressed
- More info: https://www.quickaccesspopup.com/can-a-menu-be-updated-as-the-content-of-a-folder-changes/

New menu icons
- QAP now uses new color icons from the shared file JLicons.dll installed with QAP
- In "Easy Setup" mode, this file JLicons.dll is saved in the shared applications folder "C:\ProgramData\JeanLalonde"
- In "Portable" mode, the file JLicons.dll is included in the portable ZIP file and must be kept in the same folder as QAP executable file
- This change frees QAP from its dependency on Windows files shell32.dll and imageres.dll
- Using this icons library, menu icons can now be enabled on Windows Server versions.
- Icons from: www.icons8.com

Manage Icons
- The new "Manage Icons" dialog box gives an overview of your current favorites menu icons with buttons to pick a new icon or reset the default icon for each favorite
- Click the new button "Icons" in the Settings window (lower right) or add to your menu the QAP Feature named "Icons"
- In Options (General tab), the numeric value "Manage Icons window rows" alloow to set the height of the window in case the height is calculated based on inaccurate info returned by Windows (this happens sometimes)

Various improvements

Settings window
- New color buttons in Settings window and a new option (first tab) to "Use  classic QAP buttons" (black & white) if you prefer the old style buttons
- Stop rebuilding all menus after each add or edit favorite
- Replace the "Save" button in Settings with two buttons: "Save & Close" and "Save & Reload", the latter keeping the Settings window open after reloading the menu (this replaces holding the Shift or Alt modifier keys when clicking the Save button in previous versions)
- When changes are unsaved in the Settings window, if the QAP menu is called or if a favorite is launched via hotkey, QAP will prompt user for one of these actions: "Save" - save settings, "Settings" - go to settings or "Cancel" - just cancel the requested action
- Add a confirmation prompt before deleting a group in Settings

Manage Hotkeys window
- New item order column in Hotkeys list to sort initialy favorites with hotkeys following the QAP menu order
- Stop displaying group members in Hotkeys list (this was useless since hotkeys could not be assigned to individual group members)
- In the "Change hotkey" dialog box, new links "Enter" and "Escape" allow to select Enter or Escape as hotkey (idealy associated with keyboard modifiers like Shift, Alt or Ctrl)

Shared menus
- When saving a Shared menu settings file, compare the last modified date after saving and display an error message if the date was not updated (probably because the target file is read-only)
- Display an error message if a new Shared menu settings file cannot be created (probably because the target folder is read-only)
- Automatically append the .ini extension when selecting a Shared menu settings file
- Note that Quick Access Popup still does not manage conflicts if a Shared menu is modified by different users at the same time (see Shared menu help page for more info)

Other improvements
- New option in Options window (Menu hotkeys tab) to enable left or right double Ctrl hotkey (press left or right Control key twice) to open main QAP menu
- Add .cmd extension to the list of supported application extensions (with .exe, .com, .bat, .ahk and .vbs) when adding a favorite by drag and drop or using Explorer context menus
- Append .ini extension if destination export file has no extension when exporting settings
- Replace the "QAP working" notification when rebuilding menu with a small popup message listing the updated menus, close to mouse cursor location
- Record Windows Explorer window position when adding a folder from Windows Explorer context menu (allowing to restore this window position in the "Window Options" tab when launching the folder)
- Add to QuickAccessPopup.ini the setting "AlternativeTrayIcon" under "[Global]" section to set a tray icon replacement (replacement file must be an .ico file)
- In Options, General tab, the new checkbox "Add automatically at the top of menu" makes sure favorites added automatically with "Add this folder", "Add this folder Express" or "Add favorite" from Windows Explorer context menus are added at the top of main menu (by default they are added at the top and, if unchecked, they are added at the bottom)
- Support the new placeholder "{CUR_LOC}" in folder, document and application favorites locations allowing to create favorite with a location relative to the folder where the QAP menu is opened
- Add up/down buttons to numeric values in various settings in Options and Add/Edit favorite windows
- When installing an update with the "Easy Setup" mode, reduce the number of pages (clicks) in setup procedure from 7 to 3

Bug fixes
- Fix bug working directory not being shown in edit favorite advanced setting tab for application favorites
- Changes made in Hotkeys list window are now properly cancelled if user cancels changes in Settings window
- Fix bug when editing a QAP Feature or Special folder favorite from Alternative menu, QAP Feature or Special folders drop down list is now correctly initialized

Language updates
- Update to Spanish, French, Italian, Portuguese, Chineese (TW), Brazilian-Portuguese and German language files

Version BETA: 7.9.2.4 (2017-01-02)
- re-enable menu icons on Windows Server versions
- translate Left and Right words for Ctrl-Ctrl option in Options 2nd tab
- rework compile and setup tools, change beta app icon

Version BETA: 7.9.2.3 (2016-12-12)
- support {CUR_LOC} placeholder for folder, document and application favorites
- update to PT, ES, FR, IT, PT-BR language files

Version BETA: 7.9.2.2 (2016-12-04)
- in Manage Icons, display default icon as current when current icon is empty in Settings
- fix favorite name header in Manage Icons window
- make bold the parent menu column header in manage icons
- add Paste and Paste Special icons and use the as default icons for text and macro Snippet favorites
- add to Options a numeric value to set the Manage Icons number of rows (in case the number calculated automatically is wrong)
- allow to edit a live folder favorite using Alternative menu or Shift+Ctrl menu modifiers by selecting any item in a live folder
- add up/down buttons to numeric values in options and edit favorite windows
- fix old bug when edit a QAP or Special folder favorite from Alternative menu, QAP feature or Special folders drop down list is now correctly initialized

Version BETA: 7.9.2.1 (2016-11-29)
- add option to add folder automatically at top or bottom of main menu (default at top) when added with Add this folder, Add this folder Express and Add favorite from Explorer context menus
- fix icon for Add Favorite QAP feature
- change approach to getting screen height for Manage Icons window
- add diagnostic code for screen height detection in Manage Icons

Version BETA: 7.9.2 (2016-11-24)
- add Manage Icons dialog box giving an overview of current icons of favorites with buttons to pick a new icon of set the default icon for each favorite
- add Manage icons button in Settings window and rearrange buttons layout in Settings
- add Manage icons QAP feature allowing to add the feature to QAP menu
- new JLicons.dll version 1.1, moved to shared app folder in setup mode

Version BETA: 7.9.1.5 (2016-11-19)
- fix small display bug in Live folder tab of Edit Favorite dialog box

Version BETA: 7.9.1.4 (2016-11-18)
- fix bug with Live folder filtering
- stop building live folders if max number exceeded (default 500 menu items)
- add "NbLiveFolderItems" setting under "[Global]" section of QuickAccessPopup ini file
- display an alert message if Live folders limit is exceeded
- reset live folder options when Live folder checkbox is turned off

Version BETA: 7.9.1.3 (2016-11-17)
- fix bug with language switching
- fix bug with Live folder filtering

Version BETA: 7.9.1.2 (2016-11-16)
- in Live folders, stop showing a virtual sub-menu if folder does not contain sub folders or documents of desired extensions
- add QAP feature Refresh QAP menu (useful when using Live folders - must be added to menu)
- add ini setting AlternativeTrayIcon in Global section to set a tray icon replacement (file must be .ico)
- use new QAP icon for QAP exe files and setup file, add new icon file to portable zip file
- add links allowing to select Enter and Escape as hotkey in the Change hotkey dialog box

Version BETA: 7.9.1.1 (2016-11-13)
- use icons from new JLicons.dll file installed with QAP or included in the portable ZIP file
- save favorite icons reference in ini file using index name for icons from JLicon.dll
- when settings changes are unsaved and menu is called or favorite is launched via hotkey, ask user if save settings, go to settings or cancel requested action
- add cmd extension to supported application when adding favorite by drag and drop or using context menu
- record window position when adding a folder from context menu

Version BETA: 7.5.9.8 (2016-11-06)
Settings window:
- stop launching favorites with hotkeys if changes are unsaved in Settings window
- confirm before deleting a group in Settings
Hotkeys:
- changes done in Hotkeys list are now properly cancelled if user cancel changes in settings
- display item order column in Hotkeys list and sort initialy on this column following the QAP menu order
- stop displaying group members in Hotkeys list
Shared menus:
- compare last modified date after saving shared settings file and display an error message if date is identical (probably because the target file is read-only)
- display an error message if a new shared settings file cannot be created (probably because target folder is read-only)
- append .ini extension if destination export file has no extension when exporting settings
- append .ini extension when browsing/creating a shared settings file
- stop prompting to create file when selecting shared menu file

Version BETA: 7.5.9.7 (2016-11-02)
- fix bug when after creating a menu, saving Settings and stay in Settings, the new menu was not properly reloaded
- stop showing the main menu if changes are unsaved in Settings window

Version BETA: 7.5.9.6 (2016-10-30)
- new color buttons for Settings window
- new option (first tab) to keep classic black & white buttons
- reload if classic buttons option changed
- change spacing for big buttons in gui
- disable or hide controls in windows options tab when selecting live folder
- language update for German, Spanish, French, Brazilian-Portuguese

Version: 7.5.4.3 (2016-10-30)
- reduce the number of pages (clicks) in setup procedure from 7 to 3 when installing an update
- language update for German, Spanish, French, Italian, Portuguese, Brazilian-Portuguese and Chineese (TW)
- fix bug working directory not being shown in edit favorite advanced tab for application favorites

Version BETA: 7.5.9.5 (2016-10-23)
- add Save & reload button to Settings (this replaces holding a modifier key when clicking the save button)
- rename existing Save button to Save & Close
- fix bug working directory not being shown in edit fav adv tab for application favorites

Version BETA: 7.5.9.4 (2016-10-18)
- Avoid editing folder favorite in live folder from Alternative menu
- Finish move live folder settings to a new tab in Add/Edit Favorite folders
- Simplified version comparison in Check for updates
- Spanish and Brazilian Portuguese language updates

Version BETA: 7.5.9.3 (2016-10-16)
- Merge changes from master version v7.5.4.2 (update RECOMMENDED: improvements against risk of QAP submenus favorites data loss)
- Move live folder settings to a new tab in Add/Edit Favorite folders
- Add an option in live folder to include or exclude files by extensions
- Italian, Portuguese and Chineese (TW) language updated
- Reduce the number of pages (clicks) in setup procedure from 7 to 3 when installing an update

Version: 7.5.4.2 (2016-10-13)
- Update RECOMMENDED: improvements against risk of QAP submenus favorites data loss
- add external menu values external path and loaded in menu object backup;
- when loading submenu favorite from ini file, recreate menu path in case the value is empty (possible for settings saved with v7.4.0.2 to v7.4.2)

Version BETA: 7.5.9.2 (2016-10-09)
- Update MANDATORY: risk of data loss!
- From v7.5.4.1: Fix bug when canceling changes to Favorites list in Settings, that could then potentially cause loss of data if saving new changes to settings file after cancellation
- Related to this bug: add live folder settings to backup in case user cancels settings changes
 
Live Folders
- Remove Refresh option
- Add Documents option to include files in live folders
- Add Columns option to set the number of items per columns in liove folder menu (empty for no column)
- Sort live folders content with folders first, then files
- Replace the "QAP working" rebuild notification with a tooltip displayed at mouse location and listing the updated menus;
- Stop rebuilding all menus after each add or edit favorite
- Language for live folder options, English and French
 
Other
- Fix bug after favorites saved with Shift-Save

Version BETA: 7.5.9.1 (2016-10-02)
 
Live Folder favorites
- Option in Add favorite dialog box to display a favorite of type Folder as a subfolders menu
- In Advanced Settings, an option to set the number of subfolders levels included in the Live Folder menu, 1 by default (keep it low for large folders)
- In Advanced Settings, an option to refresh the Live Folder every time the menu is displayed, off by default (disabled in this version)
 
Other new feature
- Add left or right Ctrl + Ctrl (press left or right Control twice) to open main QAP menu (enable this in Options, tab 2).
 
Language updates
- Spanish and French

Version: 7.5.4.1 (2016-10-09)
- Fix bug when canceling changes to Favorites list in Settings, that could then potentially cause loss of data if saving new changes to settings file after cancellation

Version: 7.5.4 (2016-09-21)
 
Application favorites
- in advanced settings, support placeholders {CUR_...} for current location where this favorite is launched: {CUR_LOC} (full folder), {CUR_NAME} (last folder), {CUR_DIR} (folder containing last folder) or {CUR_DRIVE}
- in advanced settings, add a check box to set the "Start In" directory (working directory) to the current location where this favorite is launched
 
Various bux fixes or little improvements
- backup [Favorites] under the name [Favorites-backup] section in settings file before save the new favorites
- when using Add this folder command, if folder path starts with "ftp://", add an FTP favorite
- in Settings, block backdoors allowing to enter in read-only shared menu or to move items to these menus
 
Total Commander
- in TC Directory Hotlist, support folders relying on file system plugins like VirtualPanel (stop checking if file exist before launching these folders with TC)
 
Directory Opus
- fix bug then folder includes special characters (like &apos;) when getting the current lister in DOpus (used in Add this folder and in current location placeholders)
 
Language updates
- German, Sweeden, Portuguese, Brazilian-Portuguese and Italian

Version: 7.5.3 (2016-09-15)
(release for translators only)

Version: 7.5.2 (2016-09-12)
- fix bug backup files being deleted/overwritten when the main menu includes a shared menu
 
Version: 7.5.1 (2016-09-11)
- fix bug after switching settings hotkeys could not be read and modified in Options
 
Version: 7.5 (2016-09-11)
 
Import/Export Settings
- add "Import/Export Settings" menu to Tray menu (right-click QAP icon in Notification zone)
- add "Import/Export Settings" to QAP Features list allowing to insert this feature to your QAP menu
- choose to import or export any or all of these settings groups: favorites, hotkeys, alternative menu hotkeys, global settings and themes
- export QuickAccessPopup.ini sections to any existing or to a new configuration (.ini) file
- import from any existing .ini file complying with QuickAccessPopup.ini structure
- replace or append favorites to the destination settings file
- check for unsaved settings before importing or exporting setings
- reload QAP after settings import
 
Switch Settings file
- add "Switch Settings file" menu to Tray menu (right-click QAP icon in Notification zone)
- add "Switch Settings" feature to QAP Features list allowing to insert this feature to your QAP menu
- change the settings file (.ini) to any file complying with QuickAccessPopup.ini structure
- check for unsaved settings before switching settings file
- reload QAP after switching to a new settings file
- settings file can be configured from command-line parameter "/Settings:", for example: QuickAccessPopup.exe "/Settings:C:\My Folder\My Settings.ini"
- settings fle name can include environment variable and support relative paths based on the QAP working directory
 
Other changes or bug fixes
- Total Commander "TC Hotlist" menu can be updated when AlternateUserIni parameter is used in [Configuration] section of wincmd.ini
- QAP feature to "Switch" applications now excludes "ghost" Windows 10 apps (pre-loaded by Windows but never used)
- context menus now use QAPmessenger.exe v1.1 with diagnostic code saved to QAP working directory when debugging is activated
- addition of xplorer2 (v3.2.0.2) to list of supported alternative file managers in QAPconnect.ini
- include external menus in hotkeys manager list
- display localized favorite type in hotkeys manager list
- German language update

Version BETA: 7.4.3.3 (2016-09-08)
- Add "Import/Export Settings" and "Switch Settings" features to QAP Features list (allowing to insert these features to any menu)
- Test for code signing certificate

Version BETA: 7.4.3.2 (2016-09-05)
 
Import/Export Settings:
- add "Import/Export Settings" menu to Tray menu (right-click QAP icon in Notification zone)
- choose to import or export any or all of favorites, hotkeys, alternative menu hotkeys, global settings and themes
- import from any existing .ini file complying with QuickAccessPopup.ini structure
- export QuickAccessPopup.ini sections to any existing or new Windows configuration (.ini) file
- replace or append favorites to the destination settings file
- check for unsaved settings before importing or exporting setings
- reload QAP after settings import
 
Switch Settings file:
- add "Switch Settings file" menu to Tray menu (right-click QAP icon in Notification zone)
- change the settings file (.ini) to any file complying with QuickAccessPopup.ini structure
- check for unsaved settings before switching settings file
- reload QAP after switching to a new settings file
- settings file can be configured from command-line parameter "/Settings:<file>", for example: QuickAccessPopup.exe "/Settings:C:\My Folder\My Settings.ini"
- fle name can include environment variable and support relative paths based on the QAP working directory
 
Other:
- Total Commander "TC Hotlist" menu can now read hotlist data when AlternateUserIni parameter is used in [Configuration] section of wincmd.ini
- QAP feature "Switch" excludes Windows 10 apps auto-loaded from Switch app menu (work in progress)

Version BETA: 7.4.3.1 (2016-09-01)
- add diagnostic code to test active window when opening a favorite and context menu messaging

Version: 7.4.3 (2016-08-23)
Bug fix
- revert change done in in v7.4.0.2 and save again to settings the path (for example: "> submenu-1 > submenu-2") for favorites of thypes Menu, Group and Shared; this fixes the broken shortcuts for favorite of these types.
- NOTE for users of Shared menus: favorite shortcuts for items inside shared menus will work only if shared menus has same path from main menu (Main > submenu-1 > submenu-2) on all QAP installations that include this shared menu (this does not impact read-only external menus)
 
Version: 7.4.2 (2016-08-22)
 
New features:
- keyboard modifiers when selecting a favorite in the popup menu (Shift for "Open in New Window", Control for "Copy Favorite Location" and Shift+Control for "Edit Favorite")
- when clicking the "Save" button in the "Settings" window, save the favorites without closing the "Settings" window when one of these keys is pressed: Shift, Control or Alt
 
Icons and desktop.ini (Windows icons)
- when building a menu, if an icon has a relative path, make it absolute based on the QAP working directory
- when retrieving an icon from a desktop.ini file, if the folder location has a relative path, make it absolute based on the QAP working directory before reading desktop.ini
- when retrieving an icon from a desktop.ini file, if the icon resource file has a relative path, make it absolute based on the favorite folder (not the QAP working directory)
- when creating a desktop.ini file if the icon resource file is located in the favorite folder itself, create the icon resource file without its path in order to make it relative to the folder and movable with the folder
 
Language files
- updated Spanish, French, Italian, Portuguese, Portuguese-Brazilian, German and Sweden language files
 
Other improvements or bug fixes
- feature change: when using "Add This Folder", QAP still records the current window position but keep the "Use default window position" checked (user must uncheck it to restore window position when opening the favorite folder)
- simplifiy "Change folder in dialog boxes" option (no more double checkbox)
- show the "Change folder in dialog boxes" alert just before opening a favorite instead of before showing the menu
- show the "Change folder in dialog boxes" alert (only) the first time the user selects a favorite folder over a dialog box
- display proper error message when trying to launch a Link favorite with invalid URL
- fix bug check4update prompt not skipped for beta version after user asked to skipped
- fix bug introduced in v7.4.0.2: save group location to ini file
- fix a bug in v7.4.1 not showing some icons for favorite of type "Special"

Version: 7.4.1 (2016-08-21)
Same features as v7.4.2 minus:
- fix a bug in v7.4.1 not showing some icons for favorite of type "Special"

Version BETA: 7.4.0.2 (2016-08-16)
- show the "change folder in dialog boxes" alert just before opening a favorite instead of before showing the menu
- show the "change folder in dialog boxes" alert (only) the first time the user selects a favorite folder over a dialog box
- simplifiy "change folder in dialog boxes" option (no more double checkbox)
- do not save submenu path to ini file - this is not required and could be misleading when external menu are saved in different locations
- updated Spanish, French, Italian, Portuguese, Portuguese-Brazilian, German and Sweden language files

Version BETA: 7.4.0.1 (2016-08-05)
- keybord modifiers when selecting a favorite in the popup menu (Shift for "Open in New Window", Control for "Copy Favorite Location" and Shift+Control for "Edit Favorite")
- save settings without closing window when one of the keys Shift, Control or Alt is pressed when clicking the Save button
Bug fixes
- when just added a shared menu, location column in Settings favorites now show  ">>" instead of ">"
- display proper error message when trying to launch a Link favorite with invalid URL

Version: 7.4 (2016-07-31)
Hidden (disabled) favorites)
- add favorite option "Hide this favorite in menu" in all types of favorites
- hidden favorites are displayed in favorites list and hotkeys list with type name between parenthesis
Bug fixes
- fix bug when column breaks are inserted in submenus
- make Total commander open folders in new window in the TC active pane instead of always in the left pane
- close QAP automatically if it is running when updating or uninstalling with setup tool

Version BETA: 7.3.9.2 (2016-07-29)
- in hotkeys list, display disabled favorite type between parenthesis
- make Total commander open folders in new window in the TC active pane instead of always in the left pane
- close QAP automatically if it is running when updating with setup tool
- close QAP automatically when uninstalling with setup tool (to prevent restoring the Explorer context menus after uninstall if app is still running)

Version BETA: 7.3.9.1 (2016-07-26)
- add favorite option "Hide this favorite in menu" in all types of favorites
- hidden favorites are displayed in favorites list with type name between parenthesis
- fix bug when column breaks are inserted in submenus

Version: 7.3.2 (2016-07-03)
- completely fix bug Directory Opus and Total Commander path not saved to ini file
- add a note to dialog box about Windows delay when changing folder icon with desktop.ini
- update to Spanish, French, Portuguese and Brazilian Portuguese language files

Version: 7.3.1 (2016-06-26)
- adapted icons management to new icon file imageres.dll dated 2015-10-30 in Windows 10
- adapted QAPupdateIconsWin10 (now v1.1) to new icon file imageres.dll dated 2015-10-30 in Windows 10
- fix GIT sync error impacting code management
- fix bug path not saved until reload after changing file manager from/to Directory Opud or Total Commander
- fix bug preventing to show QAP menu from context menus when a QAP dialog box is open

Version: 7.3 (2016-06-22)
 
Context menus
- context menus for: Explorer folders and files icons, Explorer background (white space) and Desktop background
- context menu actions (right-click): Add Folder to menu, Add File to menu, Show menu
- context menu advanced actions (Shift + right-click): Add Folder to menu Express, Add File to menu Express, Show Alternative menu
 
For the standard "Easy one-step" installation users (Setup)
- change to setup procedure to create registry keys for QAP context menu at installation and removed them when user uninstalls the app (using Inno Setup tool)
- add a check box in Option ("General" tab) to enable/disable QAP Explorer context menus (enabling or disabling scripts will ask to run with elevated administrator privileges)
- creation of the context menus help page (https://www.quickaccesspopup.com/what-else-should-i-know-about-explorer-context-menus/)
- fix bug in the uninstall procedure that was not properly checking that QAP was not running before uninstalling it (now, QAP must be closed by the user before installing and uninstalling it)
- fix bug that prevented the Startup folder shortcut to be removed when uninstalling the app 
 
Changes for portable installation users
- addition to the portable package of the scripts to add and delete manually QAP Explorer context menus: QuickAccessPopup-InstallContextMenus_reg.txt and QuickAccessPopup-RemoveContextMenus_bat.txt (see instructions in these files)
- addition of the executable file QAPmessenger-1_0-32-bit.exe required to send commands from the Explorer context menus to QAP (this file should be saved in the same folder as the QAP executable file)
 
Other changes (all users)
- add a check box in Add Application favorite dialog box (in "Advanced Settings" tab) to run favorite application with elevated privileges using the "Run as" command
- for QAP users upgrading from Windows 7 to Windows 10, add the utility to adapt references to icons in the new Windows 10 icons files (see the startup menu "Update QAP Icons from Window 7 to Windows 10" or run the file "QAPupdateIconsWin10-1_0-32-bit.exe")
- when "Add This Folder" command is called from QAP icon in the Notification zone, reactivate the last used file manager window to detect the folder to add
- when called from QAP icon in the Notification zone, display the popup menu a little higher than the taskbar area (preventing occasional overlap)
- disable QAP hotkeys when changing hotkeys, solving assignement issues in some situation

Version BETA: 7.2.3.6 (2016-06-20)
- when called from QAP icon in the Notification zone, display the popup menu higher than the taskbar area
- remove extra & in Language in change language dialog box message
- disable QAP hotkeys when changing hotkeys solving assignement issues in some situation

Version BETA: 7.2.3.5 (2016-06-16)
- fix bug when adding folder from context menu and target folder is a drive root (e.g. C:\)
- reactivate the last file manager window (Explorer, DOpus or TC) before getting the current folder when "Add This Folder" command is called from QAP icon in the Notification zone
- add tip dialog box if "Add This Folder" command failed after being called from QAP icon in the Notification zone

Version BETA: 7.2.3.4 (2016-06-13)
- No change to the main QAP executable file
- Addition od the context menus help page (https://www.quickaccesspopup.com/what-else-should-i-know-about-explorer-context-menus/)
 
Changes for portable installation users
- Addition to the portable setup zip file of the executable file QAPmessenger-0_4-32-bit.exe used to send commands from the Explorer context menus to QAP (this file should be saved in the same folder as the QAP executable file)
- Addition to the portable setup zip file of the text files used to add or remove QAP Explorer context menus: QuickAccessPopup-ContextMenus_reg.txt and QuickAccessPopup-RemoveContextMenus_bat.txt (see instructions in these files on how to rename, edit and execute these script files)
 
Change for the standard installation
- fix bug in the uninstall procedure that was not properly checking that QAP was not running before uninstalling it (now, QAP must be closed before uninstall)

Version BETA: 7.2.3.3 (2016-06-08)
- Registry keys for QAP context menu are now created during setup (by Inno Setup tool) and removed when user uninstalls the app
- Context menu registry keys can also be removed or recreated using the "Enable Context menus" checkbox in Options (first tab)
- Create context menus for: Explorer folders and files icons, Explorer background (white space) and Desktop background
- Context menu actions: Add Folder to Quick Access Popup menu (regular and express), Add File to Quick Access Popup menu (regular and express), Show Quick Access Popup menu, Show Quick Access Popup Alternative menu
- Fix bug that prevented the Startup folder shortcut to be remeved when uninstalling the app 

Version BETA: 7.2.3.2 (2016-05-30)
- fix a path bug, now using custom path selected in setup program
 
Version BETA: 7.2.3.1 (2016-05-29)
 
Context menus
- add an option to enable/disable QAP Explorer context menus (enabling or disabling requires running with administrator privileges)
- at first QAP execution (when ini file is absent), if running in setup mode, check the ExplorerContextMenus value in setup ini file and enable context menu if required, and set ExplorerContextMenus value in QAP ini file
- context menu localized language
 
Other
- add advanced option for application favorite to run apps with elevated privileges using the run as command
- remove unused DynamicMenusRefreshRate ini value

Version: 7.2.2.1 (2016-05-25)
- change Add This Folder icon for an icon identical in previous and current Windows 10 icons file (imageres.dll)

Version: 7.2.2 (2016-05-24)
Snippets:
- implement macro snippet commands Sleep, SetKeyDelay and KeyWait
- add configurable prompt before pasting a text snippet or launching a macro snippet
- fix bug Alternative menu Edit a favorite and Copy favorite location not working with snippets
- fix bug when launching Snippet using Alternative menu "Open in new window"
 
Shared menus (aka External menus)
- in Add Favorite dialog and other boxes, change "External menu" to "Shared menu"
 
Other:
- new language Portuguese (PT), thanks to Luis Neves
- new language Simplified Chinese language (ZH-CN), thanks to Jess Yang
- do not display "None" in startup notification if mouse or keyboard hotkey is not used
- in What's new dialog box, add a vertical scroll bar when the text zone is very long
- if a startup shortcut for FoldersPopup exists after QAP installation, remove it
- fix bug double-click on separator was displaying wrong message "cannot be copied"

Version BETA: 7.2.1.3 (2016-05-18)
- fix bug in v7.2.1.2 preventing editing and running macro snippets

Version: 7.2.1.2 BETA (2016-05-12)
Snippets:
- add configurable prompt before pasting a text snippet or launching a macro snippet
- fix bug Alternative menu Edit a favorite and Copy favorite location not working with snippets
- fix bug when launching Snippet using Alternative menu "Open in new window"
 
Shared menus (aka External menus)
- in Add Favorite dialog and other boxes, change "External menu" to "Shared menu"
 
Other:
- new language Portuguese, thanks to Luis Neves
- do not display "None" in startup notification if mouse or keyboard hotkey is not used
- in What's new dialog box, add a vertical scroll bar when the text zone is very long
- if a startup shortcut for FoldersPopup exists after QAP installation, remove it
- fix bug double-click on separator display wrong message "cannot be copied"

Version: 7.2.1.1 BETA (2016-05-03)
- implement macro snippet commands Sleep, SetKeyDelay and KeyWait

Version: 7.2.1 (2016-05-03)
 
SNIPPETS
- add new favorite type "Snippet" to paste pieces of text from the QAP popup menu or hotkeys
- snippet is pasted to the active window at the current insertion point
- an option in "Advanced settings" can make a snippet be sent as "Text" (default) or as "Macro"
- snippets of type "Text" are pasted to the active window using the clipboard (the original clipboard content is preserved)
- snippets of type "Macro" are sent as keystrokes supporting AHK special characters (handle with care - see help page)
- if snippet is selected by clicking on Taskbar, on QAP icon in Notification area (Tray icon) or on Desktop, a keyboard pause allows user to select the insertion point and press the Enter key to start pasting (timeout after 10 seconds)
- in snippet text, end-of-line and tab characters can be processed automatically or entered as special codes (`n for new line and `t for tab)
- add help link in Add/Edit favorite for snippets
 
EXTERNAL MENUS
- add "External menu" favorite type allowing to load favorites from a shared .ini file
- external menu can be modified as regular submenus
- external menu can be made read-only by adding the value "MenuReadOnly=1" in the ini file "[Global]" section
- first favorite number in external settings file can be configured in "Advanced settings"
- external menu settings file path supports relative paths, environment variables, UNC and HTTP paths
- if external menu settings file cannot be loaded properly, give an error message, display menu as unavailable in Settings favorites list and block menu editing
- removing an external menu from QAP menu does not delete the external menu settings file
- add help link in Add/Edit favorite for external menus
 
Bug fixes
- fix bug Settings window occasionally opening inavertandly when clicking on the QAP tray icon (when Total Commander and Directory Opus as file manager only)
- option "Open Menu on Taskbar" is now considered
- column breaks now inserted in menu when called from a hotkey and now inserted at the correct position in submenus
- stop checking for prod update if user decide to download the newest beta version
- stop launching Directory Opus when refreshing the list of open folders in listers if Directory Opus is not running
- add the auto-detection of .ahk and .vbs extensions when user add a favorite using drag-and-drop to the Settings window
 
Other
- French, Italian and Swedish language update new v7.2 features
- new runtime v1.1.23.5 from AHK

Version: 7.2 (2016-05-03)
- incomplete release, fixed in v7.2.1

Version BETA: 7.1.99.11 (2016-05-01)
- fix bug Settings window opening when clicking on the QAP tray icon
- fix bug when trying to get a Snippet location using Alternative menu feature "Copy a Favorite's Path or URL"
- add auto-detection of .ahk and .vbs extensions when user add a favorite using drag-and-drop to the Settings window

Version BETA: 7.1.99.10 (2016-04-30)
- new runtime v1.1.23.5 from AHK
- same features

Version BETA: 7.1.99.9 (2016-04-29)
- fix bug when trying to edit an external submenu just created
- validate that external settings file is an .ini file or add .ini extension if no extension is provided
- completely delete old favorites in external menu settings files when saving current favorites
- stop launching Directory Opus when refreshing the list of open folders in listers if Directory Opus is not running
- update to Portuguese-Brazilian and Swedish language files

Version BETA: 7.1.99.8 (2016-04-23)
- fix bug column breaks now inserted in menu when called from hotkey
- fix bug column breaks now inserted at the correct position in submenus
- fix bug option Open Menu on Tarskbar is now considered
- refactor processing/filtering mouse clicks on taskbar and tray icon, remove unused code
- paste snippet with keyboard pause if menu clicekd on taskbar, on tray icon or on Desktop
- encode external menu settings file path from http to unc format; refactor http to unc transformation as a function
- validate that external menu settings file exists
- do not abort menu load if error is in an external settings file, instead, give adapted error message
- if external settings file did not load, display unavailable in settings gui list, block editing external menu in settings and do not save external menu
- add help link in add/edit favorite for external menus
- italian language update for v7.1.10 features
- french language update for v7.1.99.8 features

Version BETA: 7.1.99.7 (2016-04-17)
External menu:
- add External menu favorite type, label, etc.
- load external menu settings ini file using working directory field for external file location and group settings field for external menu starting line
- manage error reading settings file
- save external menu to external settings ini file
- adapt Add/Edit favorite dialog box to external menus
- adapt settings window to manage external menus (listview, buttons, etc.)
- items in external menu with "[Global]" value "MenuReadOnly=1" cannot be modified
- init read-only value to 0 in new external menu settings file
- removing external menu (does not delete the external menu settings file)
- build menu including external menu
- support relative paths and env vars in external menu settings file path
- make starting line in external ini file read-only when editing favorite (cause error if allowed)
Snippet:
- wait for Enter up to 10 seconds (instead of 5) when paste a snippet with QAP menu popped from QAP icon on the Tray (Notification area)
- wait for Enter when QAP menu is popped from anywhere on the taskbar (Shell_TrayWnd) using the middle mouse button
- improve reliability by inserting 0.1 secs delays before and after modifying or pasting the clipboard's content
- additional code to keep the target active window after QAP menu is closed

Version BETA: 7.1.99.6 (2016-04-07)
- fix bug when pasting snippet from the QAP icon in notification zone (paste must be processes as done using the mouse)
- remove keyboard delay when pasting a snippet from a menu triggered by the mouse
- remove new line created after waiting for the Enter key when pasting snippet using mouse
- decode end-of-line to CR/LF instead of only LF for compatibility with some targets applications
- encode ` character (backtick ) to `` allowing to include backticks in snippets
- insert a 1/10 sec. delay before sending Control-V to paste the snippet content to increase paste reliability

Version BETA: 7.1.99.5 (2016-04-06)
- for snippets of type Text, use clipboard to paste content faster (the original clipboard content is preserved)
- when pasting a snippet from a mouse trigger, pause to ask confirmation of insertion point until user press Enter
- in Settings, limit the displayed length of snippet content to 250 characters
- in Change Hotkey dialog box, limit the displayed length of snippet content to 150 characters
- in Manage Hotkeys list, limit the displayed length of snippet content to 50 characters
- change Send mode to Input globally, except for sending Ctrl-V (use Event mode)


Version BETA: 7.1.99.3/7.1.99.4 (2016-04-05)
Snippets
- add Snippet favorite type, labels, help text and default icons for snippets
- add snippet to add/edit favorite dialog box with help text, checkbox to process end-of-line and tab characters and advanced setting radio buttons to send snippet in text or macro mode
- encode snippet before saving and decode when editing
Hotfix check4update
- fix bug now remember if user skipped the latest beta version
- stop checking for prod update if user decide to download the newest beta version
- remove code checking for alpha version and unused commented code
- add comments to check for update code

Version: 7.1.10 (2016-04-03)
- stop adding the "Close this menu" QAP feature to the default menu created at first QAP execution
- stop changing mouse cursor to hand over buttons in Settings when running uncompiled

Version BETA: 7.1.99.2 (2016-03-31)
- fix bug with application favorite Start in folder (Working directory)
- fix bug exclusion list is now considered only for QAP mouse button (middle mouse button by default)
- fix bug set window info and menu position for alternative menu hotkey command
- fix bug set menu position when menu is called from a hotkey
- fix bug target window now correctly indentified when favorite is called from a favorite hotkey or when submenu is called from a menu favorite hotkey
- fix bug clipboard menu had empty lines at end of menu
- better error messages if a "target app name unknown" occurs when trying to navigate a favorite or open it in a new window

Tried but not retained:
- when menu is called from main hotkey, implemented SwitchToThisWindow and restore active window before open favorite

Version: 7.1.99.1 BETA (2016-03-28)
- add the option "Add Close to menus" and save/retrieve to ini file
- add "Close this menu" to main, alternative menu and dynamic menus if option Add Close to menus is on

Version: 7.1.9 (2016-03-28)
- reverting to v7.1.4 before tentative patches to fix the "close menu issue", keeping the following changes in v7.1.5 to v7.1.8:
- add the QAP feature "Close this menu" to force closing the menu when the issue is present
- add the "Close this menu" to the default menu created at first QAP execution (actual users must add it manually - Settings, Add buton, QAP Feature, Close this menu)
- fix bug Open Menu on Taskbar option not being considered (menu was always shown regardless of the option)
- keep command line parameters when reloading after changing language or theme in options
- stop display the popup menu on unsupported "Select Folder" dialog boxes (with TreeView)
- fix bug in Add This Folder Express window position not correctly saved
- avoid writing diag info if diag mode is off
- additional code to fix bug mouse pointer staying in "wait" state by error when saving options
- addition of Chineese Traditional (Taiwanese Mandarin, ZH-TW), thanks to Jess Yang
- update to language files

Version: 7.1.8 (2016-03-25)
- before showing the menu, keep focus on scripts hidden window and on script's popup menu to avoid the "close menu issue"
- before opening the favorite, give back the focus to the target window 
- fix bug in Add This Folder Express window position not correctly saved
- addition of debugging code about active window id
- avoid writing diag info if diag mode is off
- fix bug Open Menu on Taskbar option not being considered (menu was always shown regardless of the option)
- fix Traditional Chinese language mention in about text

Version: 7.1.7 (2016-03-22)
- addition of Chineese Traditional (Taiwanese Mandarin, ZH-TW), thanks to Jess Yang
- update to Spanish and Swedish language files
- fix Add This Folder bug caused by safety coded introduced in v7.1.5

Version: 7.1.5/7.1.6 (2016-03-20)
- safety code to keep the focus on the popup menu, preventing the issue where, in some situations, the menu was not closing when clicking elsewhere or hitting Escape
- add the QAP feature "Close this menu" to force closing the menu if the issue mentionned above is still present
- add the "Close this menu" to the default menu created at first QAP execution (actual users must add it manually - Settings, Add buton, QAP Feature, Close this menu)
- keep command line parameters when reloading after changing language or theme in options
- stop display the popup menu on unsupported "Select Folder" dialog boxes (with TreeView)
- additional code to fix bug mouse pointer staying in "wait" state by error when saving options
- group calls to show popup menu in a centralized command ShowMenu
- update of Spanish, French, Italian and Portuguese language files

Version: 7.1.3/7.1.4 (2016-03-14)
- fix bug menu icons being unchecked be error after saving options
- fix bug mouse pointer staying in "wait" state by error when saving options

Version: 7.1.2 (2016-02-21)
- stop quitting QAP before downloading the new setup or portable install file (let user quit QAP during install)
- fix website landing plage URL if user checks for update, is already at the current version and visit site
- fix bug disable Display icons checkbox in Option when running on a server OS (icons are only supported on workstations)

Version: 7.1.1 (2016-02-15)
- fix black background bug on check for update screen
- fix wincmd.ini validation bug when adding a QAP feature

Version: 7.1 (2016-02-14)
 
NEW FEATURES:
- more friendly upgrade process with dialog box, direct download links and easy access to change log (will be visible when upgrading from 7.1 to next version)
- add "Shutdown Computer" and "Restart Computer" QAP features (existing users, select in "Add favorite" dialog box, and select favorite type "QAP Feature")
- add a "Restart Quick Access Popup" menu in the QAP system menu (right-click on the QAP icon in the Notification Area) to reload QAP after changes to the ini file
- create the QAPconnect.ini file from a default master if it does not already exist in the working directory (QAPconnect.ini will not be overwritten anymore when installing a new version)
 
TOTAL COMMANDER USERS:
- add the "TC Directory Hotlist" QAP feature showing the TC hotlist content in a hierarchical submenu
  > for new users, "TC Directory Hotlist" menu is added to QAP main menu at the very first use of QAP if Total Commander is detected during installation
  > existig users select in "Add favorite" dialog box, and select favorite type "QAP Feature" and choose "TC Directory Hotlist"
- add an option in "Options", "File Managers" tab, to set the TotalCommander WinCmd.ini file location
- support relative path and environment variables for WinCmd.ini path
- support Windows environment variables in TC Directory hotlist locations
 
BUG FIXES
- fix a bug in code refreshing Clipboard menu causing crash in some situations
- fix a bug in check for update, not remembering when user want to skip the new version
- make Total Commander and Directory Opus application paths saved in ini file as portable values (relative path including environment variables)
- make Total Commander and Directory Opus application paths saved in ini file as portable values (including environment variables)

Version: 7.0.9.7 BETA (2016-02-13)
- add Total Commander icon to QAP feature "TC Directory hotlist"
- support for special folders (starting with "::") in TC Directory hotlist, incuding Windows default icon
- if WinCmd.ini file is not found, give an error message when user try to add the QAP feature "TC Directory Hotlist"
- support relative path and environment variables for WinCmd.ini path
- support Windows environment variables in TC Directory hotlist locations

Version: 7.0.9.6 BETA (2016-02-12)
- add an option in Options, File Managers tab, to remember the TotalCommander WinCmd.ini file location
- save/retrieve option to/from QAP ini file

Version: 7.0.9.5 BETA (2016-02-12)
- add diagnostic code to investigate TC hotlist not opening favorite for some users
- remove/comment unused diagnostic code

Version: 7.0.9.3/7.0.9.4 BETA (2016-02-11)
- add a Restart QAP menu item to the Tray menu to reload QAP after changes in the ini file
- fix a bug in check for update, not remembering when user want to skip the new version
- more friendly upgrade process with dialog box, direct download links and easy access to change log
- add Shutdown and Restart QAP features (select in "Add favorite" dialog box, favorite type "QAP Feature")
- create QAPconnect.ini file from a default master only if it does not exist in the working directory (not overwritten anymore when installing a new version)
- add TC Directory hotlist QAP feature showing the hotlist content a hierarchical submenu (add a QAP feature favorite and select "TC Directory Hotlist")
- adding "TC Directory Hotlist" menu to QAP main menu at first QAP launch if Total Commander is activated
- removed Edit QAPconnect.ini item in tray menu
- fix bug found in v7.0.1 in code refreshing Clipboard menu

Version: 7.0.6 (2016-02-07)
- added Italian translation (thanks to Riccardo Leone!) and fixes to German translation
- add a one-time message informing users who open the QAP menu in a dialog box that an option has to be enabled in order to change folder in a dialog box

Version: 7.0.4/7.0.5 (2016-02-03)
- run at startup option enabled by default only when using the setup install mode (not enabled in portable install mode)
- enable check for updates option enabled by default only when using the setup install mode (not enabled in portable install mode)
- allow top and left positions to be negative in Add/Edit favorite dialog box, Window Options
- fixes in English text and German translation
- in v7.0.5 only version number was incremented

Version: 7.0.3 (2016-02-02)
- fix a typo in Paypal code making QAP donation being sent as Folders Popup donation
- support negative window positions which are normal in multi monitor workspaces
- updated translation tool for production version

Version: 7.0.2 (2016-02-01)
- temporarily removed code supporting PATH in Clipboard menu refresh causing slow down or crash when Clipboard contains URL

Version: 7.0.1 (2016-02-01)
- first production release
- removed languages not yet adapted from Folders Popup (Dutch, Corean and Italian)
- removed favorite windows options for document, application and link favorite types
- refresh dynamic menus "Drives" and "Recent Folders" after Options saved

Version: 6.5.4.1 beta (2016-01-30)
- remove "Drives" and "Recent Folders" from the main menu (back to separate menu) until background refresh solution is ready
- add "Add this Folder Express" QAP feature added
- enable mouse cursor to hand image when hovering buttons image or text in QAP GUI
- add error checking if g_strQAPconnectIniPath is missing
- fix buttons labels alignment in Settings
- v6.5.4.1 fix an error slowing down the menu display

Version: 6.5.3 beta (2016-01-24)
- addition of German translation

Version: 6.5.2 beta (2016-01-24)
- change the mouse cursor to the "wait" image during "Recent Folders" and "Drives" submenus refresh
- make "Recent Folders" and "Drives" submenus back integrated to the main menu (not a separate menu anymore)
- removed tooltip messages when refreshing Recent Folders and Drives menus

Version: 6.5.1 beta (2016-01-18)
- compiled with AHK binary of version 1.1.23.00 (fixing the broken dynamic submenus issue)
- disabled dynamic menus refresh background task ("Recent folders" and "Drives")
- reverted "Recent folders" menu to external menu (not integrated) until the refresh background task is fixed
- changed the "Drives" menu to external menu (not integrated) until the refresh background task is fixed
- update to Swedish and Spanish language

Version: 6.4.4 beta (2016-01-10)
- little changes in the code refreshing the Clipboard menu, trying to find the source of the issue causing a crash of QAP during dynamic menus refresh
- fix bug with numeric shorcuts in Clipboard menu when there are more than 36 items in the menu

Version: 6.4.3 beta (2016-01-06)
- fix bug numeric shortcuts in submenu now always begin at 0
- fix bug icon not set properly when saving after edit favorite
- fix bug when setting alternative menu item hotkey to none, hotkey was not disabled before reboot of QAP
- remove unnecessary values in default ini file
- Addition of browsers to QAPconnect.ini list: ExplorerXP (v1.07), Far Manager (v3.0.4040), IrfanView (v4.38), SpeedCommander (v15.40.7700), Tablacus Explorer (v14.12.30), WinNC (v6.5) and XnView (v2.25)
  (thanks to Roland Toth (tpr) for his help maintaining these settings - https://github.com/rolandtoth)

Version: 6.4.2 beta (2015-12-31)
- add numeric shortcuts to alternative menu
- fix bug when opening Alternative menu item having a shortcut reminder
- refresh alternative menu after options saved
- fix bug when moving multiple submenus or groups from one submenu to another, location was not updated properly
- fix bug hotkey to menu showing error if menu empty
- fix bug when trying to add favorite without selecting a favorite type
- remove support for FTP sites in Reopen menu (still supported in Switch menu)

Version: 6.4.1 beta (2015-12-29)
- new QAP feature "Drives" to show a menu listing drives on the system with label, free space, capacity and icon showing the drive type
- add the Drives QAP ferature to My QAP Essentials (for new users - old usrs must add it themselves)
- in default popup menu (for new users), move Add this folder QAP feature to main menu, below Settings
- refactor build and refresh of Clipboard, Drives, Recent Folders, Switch, and Reopen a Folder (aka Current Folders) submenus
- rename "Reuse an Open Folder" menu to "Reopen a Folder"
- rename "Switch to an open folder or application" menu to "Switch"
- add default hotkey +^W to Switch QAP feature menu (old users must add it themselves)
- make Recent Folders submenu integrated to the main menu (not a separate menu anymore)
- refresh Clipboard, Reopen a Folder, and Switch menus at each call to the main menu
- when submenu called open using its shortcut, check if it contains Clipboard, Reopen a Folder or Switch submenus and, if yes, refresh them
- abort Clipboard menu refresh if clipboard is too big (> 50 K)
- refresh Drives and Recent Folders in a background task and when the menu is called by its shortcut
- add the variable "DynamicMenusRefreshRate=10000" in ini file to set the refresh background task rate in milliseconds (by default 10 seconds)
- add diag code to save refresh times in the diag ini file (set DiagMode in folderspopup.ini to DiagMode=1)
- increase vertical distance between Add / Edit / Remove / Copy buttons in Settings
- create Startup shortcut at first execution (previously, users had to set the "
- removed debugging code in refresh Switch menu

Version: 6.3.2 beta (2015-12-21)
- fix FTP password label alignement in Add/Edit favorite dialog box
- addition of Spanish, Brazilian Portuguese and Swedish translations
- stop showing hidden apps in the running apps dropdown in Add/Edit application favorite
- fix misaligned label in FTP favorite
- add an option in Add/Edit application favorite to flag if we activate an exsiting instance instead of launching a new instance of the application
- add QAP feature Switch to an open folder (supporting Explorer and DOpus) or application
- reorder in main menu My QAP Essentials first before My Special Folders and reorder items insite My QAP Essentials menu

Version: 6.3.1 beta (2015-12-14)
- reading Windows folder icon in desktop.ini supporting IconResource (Vista+) and IconFile,IconIndex format (deprecated after XP)
- save Windows folder icon in desktop.ini using IconResource (Vista+), removing IconFile,IconIndex values deprecated after XP
- set folder to R attribute instead of S to show the custom icon in desktop.ini
- display numeric shortcuts and hotkey reminders in Alternative menu
- remove unused help links in Alternative menu tab in Options
- fix bug when reusing an open folder on a network drive
- does not show icon options in add/edit favorite if running on server OS (actually, icons are supported only on workstations)
- fix bug set Windows folder icon now detect if location is empty
- fix bug when cancelling assign hotkey, the previous hotkey was assigned
- fix bug Add Favorite QAP must show Settings window before Add favorite dialog box to set default destination menu and position

Version: 6.2.5 beta (2015-12-10)
- language files prepared for translators
- implement language debugging tool for translators
- change Settings header to include links to website help pages

Version: 6.2.4 beta (2015-12-07)
- fix bug unable to create folder, document or application favorite on read-only support
- French language translation and adjustments to original English language while translating to French
- rename "Power" menu/hotkey/features to "Alternative" menu/hotkey/features
- when adding favorite transform HTTP (WebDAV) folder and document location to network path (UNC format) for compatibility with Windows Explorer
- get current Windows folder icon (from desktop.ini file) and assign it as default for new folder favorites
- add link to Menu options tab of Add favorite window to set Windows folder icon to the icon currently selected for the favorite
- add link to Menu options tab of Add favorite window to remove Windows folder icon
- limit notification duration to 3 seconds for the message menu has been updated

Version: 6.2.3 beta (2015-11-21)
- more explicit error message if user try to copy submenu, group, separator or column break in settings
- add QAP feature "Get window title and class" and copy info to clipboard
- add button to launch this feature from the Exclusions list in Options
- add help line in favorite advanced settings about double-quotes for parameters
- support favorite locations with relative path, envvars and anywhere in PATH environment variables directories
- Clipboard feature supports relative path, envvars and files in PATH
- icons files support relative path, envvars and files in PATH
- favorite advanced setting "launch with" supports relative path, envvars and files in PATH
- external file managers configuration support relative path, envvars and apps in PATH
- detect Dopus at launch if dopus.exe in PATH or registry App Path key
- allow to edit favorite icon resource in input box (in format "iconfile,index")
- fix bug ghost variable values when add favorite is cancelled


Version: 6.2.2 beta (2015-11-12)
- fix bug minimal value for top/left window position can be 0, not 1
- improve exclusion lists management in Options, add help text and link, support exclusion based on window title or class
- trim each line in exclusion list when saving Options
- remove exclusions for keyboard QAP menu trigger
- change dev icon to red (beta is green, prod will be white)

Version: 6.2.1 beta (2015-11-08)
- renumbered and adapted for beta test phase
- same features as v6.1.7

Version: 6.1.7 alpha (2015-11-07)
- fix bug in Settings, after renaming a submenu, menus index was not updated causing errors when adding fav to submenus or browsing to parent menu
- refactor create a daily backup and keep the 20 last copies for alpha stage, last 10 for beta stage and last 5 for production version
- improve text for Change folder option and move it in first position of General tab
- fix bug when opening folder from popup menu in Settings
- fix bug invalid window position values when Add this folder from a dialog box
- remove default settings checkbox in fav advanced settings and adapt default FTP settings and label for TC
- fix bug path of folder on network (WebDAV) must not be expanded to absolute path

Version: 6.1.6 alpha (2015-11-05)
- sort entries in QAP feature Clipboard menu with files names and URLs merged
- open groups in Total Commander and Directory Opus in a new instance only if group is set to Replace existing windows; remove unnecessary /S switch for TC
- review how first group item is managed in TC and DOpus
- when copying a Special folder or a QAP Feature favorites in Settings, set properly the drop down to the copied value in first tab

Version: 6.1.5 alpha (2015-11-01)
- stop loading not updated translation files until they alre ready, causing error when upgrading from FP
- add Add This Folder QAP feature to My QAP Essentials menu
- fix title in Manage hotkeys dialog box
- add a 20 ms delay after TrayTip to improve display on Windows 10
- add option to TrayTip to stop sound (on Win 10 and maybe before)
- shorten TrayTip texts for better display on Win 10
- shorten executable file description for Win 10
- add a function to return OS version up to WIN_10
- update some menu icons for Windows 10
- update special folders initialization for Windows 10
- adaptation for the new approach implemented setup program using the common AppData folder as repository allowing system admin to setup QAP for end users
- fix bug locations with system variable (like %APPDATA%) not being expanded before sent to Explorer 

Version: 6.1.4 alpha (2015-10-18)
- add copy favorite button to Settings gui; copied favorite inherit all properties except hotkey
- add Ctrl+C hotkey to Settings gui to copy favorite, update gui hotkeys help text
- in groups, with Directory Opus or Total Commander, set in folders and FTP favorites in which side (left or right) display the favorite
- Ctrl+Right on a group in Settings gui now open the group

Version: 6.1.3 alpha (2015-10-17)
- remove Navigate Dialog from QAP features, now in Power menu
- remove Copy location to clipboard from QAP features, now in Power menu
- fix bug list of QAP features in Add Favorite including Power menu features by error
- fix bug validating window position for items without window position like menus
- fix bug after changing a hotkey twice before saving
- fix bug Power menu Copy Location was launching group
- fix bug Power menu Copy Location was copying inexsting favorite path for groups and QAP features items
- fix bug Power menu Open in new window was launching dummy folder
- improved Option, File managers intro text

Version: 6.1.2 alpha (2015-10-13)
- fix bug with file manager detection at startup
- fix bug in setup program installing QAPconnect.ini in the app folder instead of userapp folder

Version: 6.1.1 alpha (2015-10-12)
- support for custom file managers (in addition to Directory Opus and Total Commander) using the settings file QAPconnect.ini; thanks to Roland Toth (tpr) for his help maintaining these settings (https://github.com/rolandtoth)
- refactoring of custom file managers support (including Directory Opus and Total Commander), with a new user interface in Options to select the custom file manager
- add Edit QAPconnect.ini menu to Tray menu
- when running QAP under Win XP or Vista, show a message inviting user to run Folders Popup and qui QAP
- in Add/Edit Favorite dialog box, reword the checkbox label "Remember window position" to "Use default window position" and revert the checkbox behaviour

Version: 6.0.7 alpha (2015-10-01)
- support relative paths for icon file (but they have to be made relative in the ini file)
- fix bug when checking if a file exitst and location has relative path
- empty group settings when favorite is not a group
- stop making FTP favorite always open in a new window or tab
- QA that relative paths are fully supported in: folders, documents, applications, custom icons (relative path must be edited in ini file) and in advanced settings "launch with" and apps "start in" directory
- add windows identification parameter in FPconnect properties for the active file manager.

Version: 6.0.6 alpha (2015-09-27)
- open group completed but not fuly tested
- add an option in groups to determine if folder will be open with Explorer or the active alternative file manager (Directory Opus, Total Commander or FPconnect), FPconnect not fully supported yet
- making default URL encoding to true for FTP favorites, except for Total Commander always set FTP encoding to false
- fix bug, when folder name from DOpus includes HTML entities like apostrophe replaced by "apos;"
- current folders menu now supports FTP listers in DOpus 

Version: 6.0.5 alpha (2015-09-25)
- create a daily backup of ini file for alpha versions users
- fix bug some special folders not working with TC and DOpus
- fix bug prevent inserting separator/column added before back link in menus
- fix bug when accepting change folder in dialog option with checkbox unchecked
- fix bug when DOpus or TC are not supported and we open menu in DOpus or TC window
- fix bug phantom defaut value in group advanced settings after another group has been edited
- fix bugs when moving multiple favorites to another menu
- fix bug power menu Edit a favorite can now edit a Group favorite

Version: 6.0.4 alpha (2015-09-23)
- disable non folder menu items (except QAP features) when power menu features "Change folder in dialog" and "Open in new window" are selected
- re-enable non folder menu items after power menu features is executed
- add an option to enable Change folder in dialog boxes with main QAP hotkeys and make sure user understands the risk of changing folder in non-file dialog boxes
- fix a bug with special folders when using class IDs in Total Commander

Version: 6.0.3 alpha (2015-09-20)
* New tab in Option to set power menu hotkeys
* Show Power menu hotkeys in Manage hotkeys dialog box
* Implement Power key feature "Edit favorite"
* Add Power menu feature "Copy location"
* Add power menu feature "Change folder in dialog box"
* Disable "Change folder in dialog box" in Power menu if target is not dialog box
* Stop changing folder in dialog with regular popup hotkeys (prevent changing values in a non-file dialog box)
* Enable favorite hotkey for sub-menus
* Implement check for update for alpha versions

Version 6.0.2 alpha (2015-09-15)
- First alpha test release. List of work done since v6.0.1:

Initialisation
--------------
System variables
Special folders
Popup menu hotkeys
Themes

Favorite Types
--------------
Convert favorite types: Folder, Document, Application, Special, URL, and Menu
Add favorite types: FTP, QAP and Group

QAP Features
------------
Implement QAP features as favorite type with features:
About: about dialog box
 - Add This Folder: add the current folder to popup menu
 - Clipboard: list of file paths or URL in clipboard
 - Copy Favorite Location: copy location to clipboard
 - Current Folders: list of folders open in Explorer or supported file managers
 - Exit: quit QAP
 - Help: help dialog box
 - Hotkeys: list of favorite hotkeys and edit dialog box
 - Options: options dialog box
 - Recent Folders: list of Windows recent folders
 - Settings: setting dialog box
 - Support: support freeware dialog box
Use default language for QAP features name
Default hotkey to QAP features

Settings dialog box
-------------------
Build Settings dialog box
Open submenu when double-click in favorite list (use the Edit button to edit the menu item)
Add "back" navigation with ".." item in favorite list
Dialog box to manage favorite hotkeys
Remove one or muptiple favorites, remove submenu and underlying items
Add/Edit groups and manage them similarely to sub menus
Save Settings position when exiting

Favorites dialog box
--------------------
Add/Edit favorites dialog box with tabs: Basic Settings, Menu Options, Window Options and Advanced Settings
Add/Edit QAP features
Favorites hotkeys for all favorite types
Parameters advanced setting for all favorite types (except QAP features, Menus and Groups): 
Launch with application advanced setting for all favorite types (except Application, QAP features, Menus and Groups)
Working directory advanced setting for application favorites
Add an application favorite by selecting its path form a dropdown list of running apps
Edit window position for favorite types Folder, Special folders and Application, with a configurable delay when resizing or moving
Remember current window position when using "Add this folder"
Implementy FTP favorite type with login name, password and an option to encode login name and password in URL
Implement Group favorite with configurable delay when opening group (restoring groupe not done yet)

Options
-------
Convert all FP options
Add an exclusion list to disable QAP mouse popup menu hotkey in the selected type of windows
Option to display or not the favorite shortcuts reminders in popup menu (full name or abbreviated name)

Menus
-----
Build main menu
Build Current Folders menu
Build Recent Folders menu
Build Tray menu
Add default "My Special folders" menu at first QAP use
Add default "Essential QAP Features" menu at first QAP use
Convert startup tray tip
Test if current target window can navigate folder
Test if current window is on exclusion list before showing popup up
When Current Folders and Clipboard are empty, attach an "empty" sub menu
Add group indicator [[]] to popup menu with nb of items in groups

Popup menu Hotkeys
------------------
New hotkey approach with two triggers:
 1) QAP hotkey (mouse and keyboard), available in all windows, opens the popup menu to choose the favoriteto launch; if the favorite is a folder and the target app supports it (Explorer, dialog box or other file managers), the window is changed (navigate) to this folder
 2) Alternative hotkey available in all windows, showing a menu of special features before showing the favorites menu (see "Alternative menu features" below)
Replace default keyboard FP hotkey Windows+A (#A) to Windows+W(#W) because #A is now a reserved shortcut in Windows 10

Actions
-------
Open favorite folders and special folders in current window (navigate) or in a new window (launch) if the target window supports navigation (Explorer, Dialog boxes, Directory Opus, TotalCommander, FPconnect and Console)
Navigate favorite with Clover (using keyboard input)
Run application wit working directory and parameters
Launch documents or URL with "launch with" application and parameters
Support location placeholders in parameters
Implement QAP features "Add this folder" and "Copy Location"
Add this folder remembers window position (for use when open the folder in a new window)
Add this folder supports known special folders (50 known special folders)
Open FTP favorite with login name and password in Explorer, Directory Opus and Total Commander
Resize and move window to remembered position when opening folder in a new window (working with Explorer, DOpus, TC, not working with FPconnect yet)
Resize and move window to remembered position when launching application, document or URL (working with some apps, not all, not fully tested)

Alternative menu features
-------------------------
Open folder in a new window (even if the target window could navigate to this folder)
(more to be implemented)

Third party file managers
-------------------------
Support for Directory Opus
Support for Total Commander
Support for other file managers via FPconnect

Transition
----------
ImportFPsettings.ahk:
 - import favorites from Folders Popup and convert them to QAP format(replace all favorites)
 - import options settings from Folders Popup to QAP (overwrite existing options)

InnoSetup installer
-------------------
Prepare the QAP setup file, including ImportFPsettings.exe


Version: 6.0.1 alpha (2015-05-11)
* Replace "FoldersPopup" with "QuickAccessPopup"
* Update @Ahk2Exe-SetVersion with "6.0.1 alpha"
* Update strCurrentVersion with "6.0.1 alpha"
* Update @Ahk2Exe-SetDescription with "Most handy Windows launcher. Freeware!"
* Distinct variables strAppNameFile for "QuickAccessPopup" and strAppNameText for "Quick Access Popup"
* Update strCurrentBranch with "alpha"
* Adapt for alpha version without version checking for alpha branch
* Replace "FoldersPopup" with "QuickAccessPopup" in InitFileInstall, and language variable names
* Replace "strTempDir" with "g_strTempDir"

SEE PREVIOUS HISTORY on FoldersPopup's GitHub or in FoldersPopup.ahk file


VARIABLES NAMING CONVENTION
---------------------------

typNameOfVariable
^^^^^^^^^^^^^^^^^
	description of the variable content, with name sections from general to specific
 
typeNameOfVariable
^^^^
	type of variable, str for strings, int for integers (any size), dbl for reals (not used in this app),
	arr for pseudo-arrays (see OBJECTS), obj for objects (see OBJECTS), menu for menus, etc.
  
g_typNameOfVariable
	g_ for global, nothing for local

f_typNameOfVariable
	f_ for form (Gui) variables

s_typNameOfVariable
	s_ for static variables variables


OBJECTS NAMING CONVENTIONS
--------------------------
.AA		associative arrays of a class
.SA		simple arrays of a class
.P_var	class properties, with first letters of variable showing its type (as for other variables)
aaVar	other associative array variable
dicVar	Scripting.Dictionary object (used for case-sensitive keys)
o_Var	class object (always make o_Var variables global)
oVar	object variable, inside a class or elsewhere (not global)
pVar	Pointer variable returned by a Windows object like ComObjCreate("Shell.Application")
saVar	other simple array variable

- to be replaced
objVar	REPLACE with one of the others
arrVar	refactror pseudo-array to simple array

*/ 
;========================================================================================================================
!_010_COMPILER_DIRECTIVES:
;========================================================================================================================

; Doc: http://fincs.ahk4.net/Ahk2ExeDirectives.htm
; Note: prefix comma with `

;@Ahk2Exe-SetVersion 9.9.2.1
;@Ahk2Exe-SetName Quick Access Popup
;@Ahk2Exe-SetDescription Quick Access Popup (Windows freeware)
;@Ahk2Exe-SetOrigFilename QuickAccessPopup.exe
;@Ahk2Exe-SetCopyright (c) Jean Lalonde since 2013
;@Ahk2Exe-SetCompanyName Jean Lalonde


;========================================================================================================================
!_011_INITIALIZATION:
;========================================================================================================================

#NoEnv
#SingleInstance force
#KeyHistory 0
#MaxHotkeysPerInterval 200
ListLines, Off
DetectHiddenWindows, On ; On required for button centering function GuiCenterButtons
SendMode, Input
StringCaseSense, Off
ComObjError(False) ; we will do our own error handling

#Include %A_ScriptDir%\XML_Class.ahk ; by Maestrith (Chad) https://autohotkey.com/boards/viewtopic.php?f=62&t=33114

; avoid error message when shortcut destination is missing
; see http://ahkscript.org/boards/viewtopic.php?f=5&t=4477&p=25239#p25236
DllCall("SetErrorMode", "uint", SEM_FAILCRITICALERRORS := 1)

; make sure the default system mouse pointer are used after a QAP reload
SetWaitCursor(false)

;---------------------------------
; App Name

global g_strAppNameFile := "QuickAccessPopup"
global g_strAppNameText := "Quick Access Popup"

;---------------------------------
; Init class for command line parameters
; "/Settings:file_path" (must end with ".ini"), "/AdminSilent" and "/Working:path"
global o_CommandLineParameters := new CommandLineParameters()

global g_blnPortableMode
Gosub, SetQAPWorkingDirectory
; To test Setup mode in dev environement:
; 1- rename !!_do_not_remove_or_rename.txt to _do_not_remove_or_rename.txt
; 2- Below ;@Ahk2Exe-IgnoreBegin, comment out line "SetWorkingDir, %A_ScriptDir%"
; 3- In class Settings, uner __New(), comment out lines changing "this.strIniFile := ..."

; Force A_WorkingDir to A_ScriptDir if uncomplied (development environment)
;@Ahk2Exe-IgnoreBegin
; Start of code for development environment only - won't be compiled
; see http://fincs.ahk4.net/Ahk2ExeDirectives.htm
SetWorkingDir, %A_ScriptDir%
ListLines, On
; #### BuildUserAhkApi(A_ScriptFullPath,1) ; used for index of type ahead? From Joe Glines
; to test user data directory: SetWorkingDir, %A_AppData%\Quick Access Popup
; / End of code for developement enviuronment only - won't be compiled
;@Ahk2Exe-IgnoreEnd

OnExit, CleanUpBeforeExit ; must be positioned before InitFileInstall to ensure deletion of temporary files

;---------------------------------
; Init Settings instance
global o_Settings := new Settings

;---------------------------------
; Check if we received an alternative settings file in parameter /Settings:

if StrLen(o_CommandLineParameters.AA["Settings"])
	o_Settings.strIniFile := PathCombine(A_WorkingDir, EnvVars(o_CommandLineParameters.AA["Settings"]))

;---------------------------------
; Create temporary folder

o_Settings.ReadIniOption("Launch", "strQAPTempFolderParent", "QAPTempFolder", " ", "General"
	, "f_strQAPTempFolderParentPath|f_lblQAPTempFolderParentPath|f_btnQAPTempFolderParentPath") ; g_strQAPTempFolderParent

if !StrLen(o_Settings.Launch.strQAPTempFolderParent.IniValue)
	if StrLen(EnvVars("%TEMP%")) ; make sure the environment variable exists
		o_Settings.Launch.strQAPTempFolderParent.IniValue := "%TEMP%" ; for new installation v8.6.9.2+
	else
		o_Settings.Launch.strQAPTempFolderParent.IniValue := A_WorkingDir ; for installations installed before v8.6.9.2

; remove temporary folders older than 7 days
global g_strTempDir := PathCombine(A_WorkingDir, EnvVars(o_Settings.Launch.strQAPTempFolderParent.IniValue))
Loop, Files, %g_strTempDir%\_QAP_temp_*,  D
{
	strDate := A_Now
	EnvSub, strDate, %A_LoopFileTimeModified%, D
	if (strDate > 5)
		FileRemoveDir, %A_LoopFileFullPath%, 1 ; Remove all files and subdirectories
}

; add a random number between 0 and 2147483647 to generate a unique temp folder in case multiple QAP instances are running
g_strTempDir .= "\_QAP_temp_" . RandomBetween()
FileCreateDir, %g_strTempDir%

;---------------------------------
; Init temporary folder

Gosub, InitFileInstall

; --- Global variables

global g_strCurrentVersion := "9.9.2.1" ; "major.minor.bugs" or "major.minor.beta.release", currently support up to 5 levels (1.2.3.4.5)
global g_strCurrentBranch := "beta" ; "prod", "beta" or "alpha", always lowercase for filename
global g_strAppVersion := "v" . g_strCurrentVersion . (g_strCurrentBranch <> "prod" ? " " . g_strCurrentBranch : "")
global g_strJLiconsVersion := "v1.5"

global g_strDiagFile := A_WorkingDir . "\" . g_strAppNameFile . "-DIAG.txt"

;---------------------------------
; Init language variables (must be after g_strCurrentBranch init)
global g_strEscapeReplacement := "!r4nd0mt3xt!"
global o_L := new Language
o_Settings.InitOptionsGroupsLabelNames() ; init options groups labels after language is initialized

;---------------------------------
; Init class for JLicons
if (g_blnPortableMode)
	global o_JLicons := new JLIcons(A_ScriptDir . "\JLicons.dll") ; in portable mode, same folder as QAP exe file or script directory in developement environment
else ; setup mode
	global o_JLicons := new JLIcons(A_AppDataCommon . "\JeanLalonde\JLicons.dll") ; in setup mode, shared data folder

global g_intGuiDefaultWidth := 636
global g_intGuiDefaultHeight := 496 ; was 601

global g_blnMenuReady := false
global g_blnChangeShortcutInProgress := false
global g_blnChangeHotstringInProgress := false

global g_saSubmenuStack := Object() ; simple array of menu path opened in gui
global g_saSubmenuStackPosition := Object() ; simple array of menu position in gui for each path in g_saSubmenuStack

global g_strMenuPathSeparator := ">" ; spaces before/after are added only when submenus are added, separate submenu levels, not allowed in menu and group names
global g_strMenuPathSeparatorWithSpaces := " " . g_strMenuPathSeparator . " "
global g_strGuiMenuSeparator := "----------------" ;  single-line displayed as line separators, allowed in item names
global g_strGuiMenuSeparatorShort := "---" ;  short single-line displayed as line separators, allowed in item names
global g_strGuiDoubleLine := "===" ;  double-line displayed in column break and end of menu indicators, allowed in item names
global g_strGroupIndicatorPrefix := Chr(171) ; group item indicator, not allolowed in any item name
global g_strGroupIndicatorSuffix := Chr(187) ; displayed in Settings with g_strGroupIndicatorPrefix, and with number of items in menus, allowed in item names
global g_intListW := "" ; Gui width captured by GuiSize and used to adjust columns in fav list
global g_strEscapePipe := "" ; used to escape pipe in ini file, should not be in item names or location but not checked

global g_strSnippetCommandStart := "{&" ; start of command in macro snippets
global g_strSnippetCommandEnd := "}" ; end of command (including options) in macro snippets
global g_strSnippetOptionsSeparator := ":" ; separator between command and options in macro snippets

global g_strHotstringOptionsSeparator := ":" ; separator between trigger and options in hotstrings
global g_strHotstringOptionsLongSeparator := " / " ; separator between hotstrings options long text
global g_strHotstringOptionsExecute := "X"

global g_saGuiControls := Object() ; to build Settings gui

global g_aaItemsByShortcut := Object()
global g_dicItemsByHotstring := ComObjCreate("Scripting.Dictionary") ; use Scripting.Dictionary instead of Object() to support case sensitive keys

global g_saExternaleMenuToRelease := Object() ; simple array of file path of External menu reserved by user to release when saving/cancelling Settings changes or quitting QAP
global g_aaExternalMenuFolderIsReadOnly := Object() ; associative array of folders containing external settings files, registering if these folders are read-only (true) or not (false)

global g_aaToolTipsMessages := Object() ; messages to display by ToolTip when mouse is over selected buttons in Settings

global g_strModernBrowsers := "ApplicationFrameWindow,Chrome_WidgetWin_0,Chrome_WidgetWin_1,Maxthon3Cls_MainFrm,Slimjet_WidgetWin_1,MozillaWindowClass"
global g_strLegacyBrowsers := "IEFrame,OperaWindowClass"

global g_aaLastActions := Object()

global g_strWindosListAppsCacheFile := A_WorkingDir . "\WindowsAppsList.tsv"
global g_aaWindowsAppsIDsByName := Object()

global g_blnFavoritesListFilterNeverFocused := true ; init before showing gui

global g_intNewWindowOffset := -1 ; to offset multiple Explorer windows positioned at center of screen

global g_strLastConfiguration ; last screen configuration updated by GetScreenConfiguration

;---------------------------------
; Used in OpenFavorite
global g_blnAlternativeMenu
global g_strAlternativeMenu
global g_blnLaunchFromTrayIcon
global g_strTargetWinId
global g_strTargetClass
global g_strHotkeyTypeDetected
global g_strNewWindowId
global g_intOriginalMenuPosition
global o_EditedFavorite ; was g_objEditedFavorite
global o_MenuInGui ; replace g_objMenuInGui, back item added at top when first loaded in gui
global g_intMenuPosX
global g_intMenuPosY

;---------------------------------
; Initial validation

if InStr("WIN_VISTA|WIN_2003|WIN_XP|WIN_2000", A_OSVersion)
{
	MsgBox, 4, %g_strAppNameText%, % L(o_L["OopsOSVerrsionError"], g_strAppNameText)
	IfMsgBox, Yes
		Run, http://code.jeanlalonde.ca/folderspopup/
	ExitApp
}

; if the app runs from a zip file, the script directory is created under the system Temp folder
if InStr(A_ScriptDir, A_Temp) ; must be positioned after g_strAppNameFile is created
{
	Oops(o_L["OopsZipFileError"], g_strAppNameFile)
	ExitApp
}

;---------------------------------
; Init routines

; Keep gosubs in this order
Gosub, InitLanguageArrays
Gosub, InitGuiControls

;---------------------------------
; Init class for Triggers (must be before LoadIniFile)
global o_MouseButtons := new Triggers.MouseButtons
global o_PopupHotkeys := new Triggers.PopupHotkeys ; load QAP menu triggers from ini file
global o_PopupHotkeyNavigateOrLaunchHotkeyMouse := o_PopupHotkeys.SA[1]
global o_PopupHotkeyNavigateOrLaunchHotkeyKeyboard := o_PopupHotkeys.SA[2]
global o_PopupHotkeyAlternativeHotkeyMouse := o_PopupHotkeys.SA[3]
global o_PopupHotkeyAlternativeHotkeyKeyboard := o_PopupHotkeys.SA[4]

;---------------------------------
; Init class for Favorites (types) - must be before new QAPfeatures
global o_Favorites := new Favorites

;---------------------------------
; Init class for QAP Features
global o_QAPfeatures := new QAPfeatures

;---------------------------------
; Init class for Special Folders
global o_SpecialFolders := new SpecialFolders

;---------------------------------
; Load Settings file

Gosub, LoadIniFile ; load options, load/enable popup hotkeys, load favorites to menu object

;---------------------------------
; Must be after LoadIniFile

if (o_Settings.LaunchAdvanced.blnRunAsAdmin.IniValue and !A_IsAdmin)
	gosub, ReloadAsAdmin
if (A_IsAdmin and !o_CommandLineParameters.AA.HasKey("AdminSilent")
	and o_Settings.LaunchAdvanced.blnRunAsAdmin.IniValue)
	; show alert only if running as admin because of the o_Settings.LaunchAdvanced.blnRunAsAdmin.IniValue option, except if "/AdminSilent" command-line option is used
	Oops(o_L["OptionsRunAsAdminAlert"], g_strAppNameText)
if (A_IsAdmin and o_Settings.LaunchAdvanced.blnRunAsAdmin.IniValue)
	; add [admin] tag only if running as admin because of the o_Settings.LaunchAdvanced.blnRunAsAdmin.IniValue option
	g_strAppNameText .= " [" . o_L["OptionsRunAsAdminShort"] . "]"

intStartups := o_Settings.ReadIniValue("Startups", 1)
strLastVersionUsed := o_Settings.ReadIniValue("LastVersionUsed" . (g_strCurrentBranch = "alpha" ? "Alpha" : (g_strCurrentBranch = "beta" ? "Beta" : "Prod")), 0.0)

; not sure it is required to have a physical file with .html extension - but keep it as is by safety
g_strURLIconFileIndex := GetIcon4Location(g_strTempDir . "\default_browser_icon.html")

Gosub, InitDynamicMenus

; Build main menus
Gosub, BuildMainMenu
Gosub, BuildAlternativeMenu

if (o_Settings.Launch.blnDiagMode.IniValue)
	Gosub, InitDiagMode
if (g_blnUseColors)
	Gosub, LoadThemeGlobal

; Build menu used in Settings Gui
Gosub, BuildGuiMenuBar ; must be before BuildMainMenu
Gosub, BuildTrayMenu

; Build Settings Gui
Gosub, BuildGui
if (o_Settings.Launch.blnCheck4Update.IniValue) ; must be after BuildGui
	Gosub, Check4Update

; Must be after BuildGui
; Sponsor message when launching a portable prod release for the first time and user is not a sponsor
if (g_blnPortableMode and g_strCurrentBranch = "prod" and !o_Settings.Launch.blnDonor.IniValue
	and FirstVsSecondIs(g_strCurrentVersion, strLastVersionUsed) = 1) ; FirstVsSecondIs() returns -1 if first smaller, 0 if equal, 1 if first greater
{
	MsgBox, 36, % l(o_L["DonateCheckTitle"], intStartups, g_strAppNameText)
		, % L(o_L["DonateCheckPrompt"] . "`n`n" . L(o_L["DonateCheckPrompt2"], o_L["DonateCheckPrompt3"] . " " . o_L["DonateCheckPrompt5"]), g_strAppNameText, intStartups)
	IfMsgBox, Yes
		Gosub, GuiDonate
}

; after sponsor message, we can update these values in ini file
IniWrite, % (intStartups + 1), % o_Settings.strIniFile, Global, Startups
IniWrite, %g_strCurrentVersion%, % o_Settings.strIniFile, Global, % "LastVersionUsed" . (g_strCurrentBranch = "alpha" ? "Alpha" : (g_strCurrentBranch = "beta" ? "Beta" : "Prod"))

; now that the Gui is built, temporary change the tray icon to loading icon
Menu, Tray, UseErrorLevel
Menu, Tray, Icon, % o_JLicons.strFileLocation, % (g_strCurrentBranch = "alpha" ? 59 : 60), 1 ; 60 is iconQAPloading, 59 is iconQAPdev (red) if loading alpha branch, last 1 to freeze icon during pause or suspend
g_blnTrayIconError := ErrorLevel
Menu, Tray, UseErrorLevel, Off

o_Settings.ReadIniOption("MenuAdvanced", "intRefreshQAPMenuIntervalSec", "RefreshQAPMenuIntervalSec", 0, "MenuAdvanced"
	, "f_blnRefreshQAPMenuEnable|f_intRefreshQAPMenuIntervalSecEdit|f_intRefreshQAPMenuIntervalSec|f_lblRefreshQAPMenuIntervalSec") ; g_intRefreshQAPMenuIntervalSec
o_Settings.ReadIniOption("MenuAdvanced", "blnRefreshQAPMenuDebugBeep", "RefreshQAPMenuDebugBeep", 0, "MenuAdvanced", "f_blnRefreshQAPMenuDebugBeep") ; g_blnRefreshQAPMenuDebugBeep

if (o_Settings.MenuAdvanced.intRefreshQAPMenuIntervalSec.IniValue > 0)
	SetTimer, RefreshQAPMenuScheduled, % o_Settings.MenuAdvanced.intRefreshQAPMenuIntervalSec.IniValue * 1000

;---------------------------------
; Init SQLite database to collect recent items

; SQLite wrapper from just_me for UsageDb
; https://autohotkey.com/boards/viewtopic.php?t=1064
#Include %A_ScriptDir%\Class_SQLiteDB.ahk

g_strUsageDbFile := A_WorkingDir . "\QAP_Frequent.DB"
g_strUsageDbFileOld := A_WorkingDir . "\QAP_Popular.DB"
g_intUsageDbRecentLimit := 150

if (g_blnUsageDbEnabled)
	gosub, UsageDbInit ; creates o_UsageDb

if (g_blnUsageDbEnabled) ;  repeat if because g_blnUsageDbEnabled could change in UsageDbInit
{
	; collect recent items and dynamic menus data
	Gosub, UsageDbCollectMenuData

	; Update FavoriteUsageDb properties with data from UsageDb
	o_MainMenu.UpdateUsageDbFrequency() ; was UsageDbUpdateFavorites
}

if !StrLen(o_Settings.UserVariables.strUserVariablesList.IniValue)
	gosub, DetectCloudUserVariables ; must be after UsageDbInit because it uses SQLite files for Google Drive database

;---------------------------------
; Refresh Windows Apps list

if (o_Settings.LaunchAdvanced.blnRefreshWindowsAppsListAtStartup.IniValue)
	Gosub, ButtonRefreshWindowsAppsListAtStartup

;---------------------------------
g_blnMenuReady := true

Gosub, SetTrayMenuIcon

if (o_Settings.Launch.blnDisplayTrayTip.IniValue)
{
	TrayTip, % L(o_L["TrayTipInstalledTitle"], g_strAppNameText)
		, % L(o_L["TrayTipInstalledDetail"]
			, (HasShortcut(o_PopupHotkeyNavigateOrLaunchHotkeyMouse.AA.strPopupHotkeyText)
				? o_PopupHotkeyNavigateOrLaunchHotkeyMouse.AA.strPopupHotkeyText : "") ; "NavigateOrLaunchHotkeyMouse"
				. (HasShortcut(o_PopupHotkeyNavigateOrLaunchHotkeyMouse.AA.strPopupHotkeyText)
					and HasShortcut(o_PopupHotkeyNavigateOrLaunchHotkeyKeyboard.AA.strPopupHotkeyText)
					? " " . o_L["DialogOr"] . " " : "")
				. (HasShortcut(o_PopupHotkeyNavigateOrLaunchHotkeyKeyboard.AA.strPopupHotkeyText)
					? o_PopupHotkeyNavigateOrLaunchHotkeyKeyboard.AA.strPopupHotkeyText : "")) ; "NavigateOrLaunchHotkeyKeyboard"
		, , 17 ; 1 info icon + 16 no sound
	Sleep, 20 ; tip from Lexikos for Windows 10 "Just sleep for any amount of time after each call to TrayTip" (http://ahkscript.org/boards/viewtopic.php?p=50389&sid=29b33964c05f6a937794f88b6ac924c0#p50389)
}

;---------------------------------

; To popup menu when left click on the tray icon - See AHK_NOTIFYICON function below
OnMessage(0x404, "AHK_NOTIFYICON")

; the next gosubs can be done after menu is declared ready

If FileExist(A_Startup . "\" . g_strAppNameFile . ".lnk")
{
	FileDelete, %A_Startup%\%g_strAppNameFile%.lnk ; delete file if portable or setup
	if (g_blnPortableMode)
	{
		; the startup shortcut was created at first execution of LoadIniFile (if ini file did not exist)
		; if the startup shortcut exists, update it at each execution in case the exe filename changed
		Gosub, CreateStartupShortcut
		Menu, Tray, Check, % g_aaMenuTrayL["MenuRunAtStartup"]
	}
}

; if the startup shortcut for FoldersPopup still exist after QAP installation, delete it
IfExist, %A_Startup%\FoldersPopup.lnk
	FileDelete, %A_Startup%\FoldersPopup.lnk

;---------------------------------
; Load the cursor and start the "hook" to change mouse cursor in Settings - See WM_MOUSEMOVE function below

g_objHandCursor := DllCall("LoadCursor", "UInt", NULL, "Int", 32649, "UInt") ; IDC_HAND
OnMessage(0x200, "WM_MOUSEMOVE")

; To prevent double-click on image static controls to copy their path to the clipboard - See WM_LBUTTONDBLCLK function below
; see http://www.autohotkey.com/board/topic/94962-doubleclick-on-gui-pictures-puts-their-path-in-your-clipboard/#entry682595
OnMessage(0x203, "WM_LBUTTONDBLCLK")

; Respond to SendMessage sent by ImportFPsettings to signal that QAP is running
; No specific reason for 0x2224, except that is is > 0x1000 (http://ahkscript.org/docs/commands/OnMessage.htm)
OnMessage(0x2224, "REPLY_QAPISRUNNING")

; Respond to SendMessage sent by QAPmessenger after execution of the requested action from Explorer context menu
OnMessage(0x4a, "RECEIVE_QAPMESSENGER")

; Create a mutex to allow Inno Setup to detect if FP is running before uninstall or update
DllCall("CreateMutex", "uint", 0, "int", false, "str", g_strAppNameFile . "Mutex")

;---------------------------------
; Setting window hotkey conditional assignment

Hotkey, If, WinActive(QAPSettingsString()) ; main Gui title

	Hotkey, ^Up, SettingsUp, On UseErrorLevel
	Hotkey, ^Down, SettingsDown, On UseErrorLevel
	Hotkey, ^Right, SettingsRight, On UseErrorLevel
	Hotkey, ^Left, SettingsLeft, On UseErrorLevel
	Hotkey, ^A, SettingsCtrlA, On UseErrorLevel
	Hotkey, ^N, SettingsCtrlN, On UseErrorLevel
	Hotkey, Del, SettingsDel, On UseErrorLevel
	Hotkey, ^M, SettingsCtrlM, On UseErrorLevel
	Hotkey, ^C, SettingsCtrlC, On UseErrorLevel
	Hotkey, ^F, SettingsCtrlF, On UseErrorLevel
	Hotkey, ^E, SettingsCtrlE, On UseErrorLevel
	Hotkey, ^H, SettingsCtrlH, On UseErrorLevel
	Hotkey, ^O, SettingsCtrlO, On UseErrorLevel
	Hotkey, F1, SettingsF1, On UseErrorLevel

Hotkey, If

;---------------------------------
; Start task collecting recent items

; Diag("SetTimer:UsageDbCollectMenuData", o_Settings.Database.intUsageDbIntervalSeconds.IniValue)
if (g_blnUsageDbEnabled)
	SetTimer, UsageDbCollectMenuData, % (o_Settings.Database.intUsageDbIntervalSeconds.IniValue * 1000), -100 ; delay before repeating UsageDbCollectMenuData / priority -100 (not sure?)

if (o_Settings.SettingsWindow.blnDisplaySettingsStartup.IniValue)
	gosub, GuiShow

return

;========================================================================================================================
; Handles for the "Hotkey, If" condition
;========================================================================================================================

;------------------------------------------------------------
;------------------------------------------------------------
#If, CanNavigate(A_ThisHotkey)
; empty - act as a handle for the "Hotkey, If, Expression" condition in PopupHotkey.__New() (and elsewhere)
; ("Expression must be an expression which has been used with the #If directive elsewhere in the script.")
#If
;------------------------------------------------------------
;------------------------------------------------------------


;------------------------------------------------------------
;------------------------------------------------------------
#If, CanLaunch(A_ThisHotkey)
; empty - act as a handle for the "Hotkey, If, Expression" condition in PopupHotkey.__New() (and elsewhere)
; ("Expression must be an expression which has been used with the #If directive elsewhere in the script.")
#If
;------------------------------------------------------------
;------------------------------------------------------------


;------------------------------------------------------------
;------------------------------------------------------------
#If, WinActive(QAPSettingsString()) ; main Gui title
; empty - act as a handle for the "Hotkey, If, Expression" condition in PopupHotkey.__New() (and elsewhere)
; ("Expression must be an expression which has been used with the #If directive elsewhere in the script.")
#If
;------------------------------------------------------------
;------------------------------------------------------------


;========================================================================================================================
!_012_GUI_HOTKEYS:
;========================================================================================================================

; Settings Gui Hotkeys

; see Hotkey, If, WinActive(QAPSettingsString())

SettingsUp: ; ^Up::
GuiControlGet, strFocusedControl, FocusV
if InStr(strFocusedControl, "FavoritesListFilter")
	return
if (LV_GetCount("Selected") > 1)
	Gosub, GuiMoveMultipleFavoritesUp
else
	Gosub, GuiMoveFavoriteUp
return

SettingsDown: ; ^Down::
GuiControlGet, strFocusedControl, FocusV
if InStr(strFocusedControl, "FavoritesListFilter")
	return
if (LV_GetCount("Selected") > 1)
	Gosub, GuiMoveMultipleFavoritesDown
else
	Gosub, GuiMoveFavoriteDown
return

SettingsRight: ; ^Right::
GuiControlGet, strFocusedControl, FocusV
if InStr(strFocusedControl, "FavoritesListFilter")
	return
Gosub, HotkeyEnterMenuOrFavorite
return

SettingsLeft: ; ^Left::
GuiControlGet, strFocusedControl, FocusV
if InStr(strFocusedControl, "FavoritesListFilter")
	return
GuiControlGet, blnUpMenuVisible, Visible, f_picUpMenu
if (blnUpMenuVisible)
	Gosub, GuiGotoPreviousMenu
return

SettingsCtrlA: ; ^A::
GuiControlGet, strFocusedControl, FocusV
if (strFocusedControl = "f_strFavoritesListFilter")
	Send, ^a ; select all search control
else
	LV_Modify(0, "Select") ; select all in listview
return

SettingsCtrlN: ; ^N::
Gosub, GuiAddFavoriteSelectType
return

SettingsDel: ; Del::
GuiControlGet, strFocusedControl, FocusV
if (strFocusedControl = "f_strFavoritesListFilter")
	Send, {Del}
else
	if (LV_GetCount("Selected") > 1)
		Gosub, GuiRemoveMultipleFavorites
	else
		Gosub, GuiRemoveFavorite
return

SettingsCtrlM: ; ^M::
if (LV_GetCount("Selected") > 1)
	Gosub, GuiMoveMultipleFavoritesToMenu
else
	Gosub, GuiMoveFavoriteToMenu
return

SettingsCtrlC: ; ^C::
GuiControlGet, strFocusedControl, FocusV
if (strFocusedControl = "f_strFavoritesListFilter")
	Send, ^c
else
	if (LV_GetCount("Selected") > 1)
		Gosub, GuiCopyMultipleFavoritesToMenu
	else
		Gosub, GuiCopyFavorite
return

SettingsCtrlF: ; ^F::
GuiControlGet, strFocusedControl, FocusV
if (strFocusedControl = "f_strFavoritesListFilter")
	return
Gosub, GuiFocusFilter
return

SettingsCtrlE: ; ^E::
GuiControlGet, strFocusedControl, FocusV
if (strFocusedControl = "f_strFavoritesListFilter")
	return
Gosub, GuiEditFavorite
return

SettingsCtrlH: ; ^H::
Gosub, GuiHotkeysHelpClicked
return

SettingsCtrlO: ; ^O::
Gosub, GuiOptionsGroupGeneral
return

SettingsF1: ; F1::
Gosub, GuiHelp
return

; End of Gui Hotkeys


;========================================================================================================================
; END OF GUI HOTKEYS
;========================================================================================================================



;========================================================================================================================
!_015_INITIALIZATION_SUBROUTINES:
;========================================================================================================================

;-----------------------------------------------------------
SetQAPWorkingDirectory:
;-----------------------------------------------------------

; WORKING PARAMETER

; If the "/Working:" parameter is used from the command line (i.e. "c:\path\quickaccesspopup.exe /working:c:\path"),
; set it as A_WorkingDir and return after setting the portable or setup mode below.

; FYI, the "/Working:" parameter can be set by the user at the command line, in a Windows file shortcut or in the
; current user registry Run key. It has precedence on the Working Folder value in settings file.

if StrLen(o_CommandLineParameters.AA["Working"])
{
	SetWorkingDir, % o_CommandLineParameters.AA["Working"]
	; ###_V(A_ThisLabel . " - /Working: parameter", A_WorkingDir)
}

; DETECT INSTALL MODE

; Check in what mode QAP is running:
; - if the file "_do_not_remove_or_rename.txt" is in A_ScriptDir, we are in Setup mode
; - else we are in Portable mode.

g_blnPortableMode := !FileExist(A_ScriptDir . "\_do_not_remove_or_rename.txt")

; IF PORTABLE MODE

; If we are in Portable mode and the parameter "/Working:" is absent, keep the current A_WorkingDir and return. The
; A_WorkingDir is equal to A_ScriptDir except if the user set the "Start In" folder in a Windows file shortcut.
; For example, if the "Run at startup" is enabled with QAP in portable mode, a shortcut is created in the user's
; startup folder with "Start In" set to the current A_WorkingDir.

if (g_blnPortableMode)
	return ; keep current A_WorkingDir

; FIRST LAUNCH IN SETUP MODE

; The first time QAP is launched after an install (and also for re-install or upgrade), QAP completes its setup.
; To detect if this is the first launch, check if the A_WorkingDir is "C:\ProgramData\Quick Access Popup".
; Note: when launched from the Start menu shortcut, A_WorkingDir can also be "C:\ProgramData\Quick Access Popup".

if (A_WorkingDir = A_AppDataCommon . "\" . g_strAppNameText) ; this is first launch after installation or update
{
	; Check if pre-v10 settings exist by searching for the "%A_AppData%\Quick Access Popup" folder
	; (e.g. C:\Users\Jean\AppData\Roaming\Quick Access Popup) and if v10 has never run by checking if the
	; registry key "HKEY_CURRENT_USER\Software\Jean Lalonde\Quick Access Popup\WorkingFolder") exists.
	
	if (FileExist(A_AppData . "\" . g_strAppNameText)
		and !RegistryExist("HKEY_CURRENT_USER\Software\Jean Lalonde\" . g_strAppNameText, "WorkingFolder"))
		; Pre-v10 settings are found and v10 has never run.
	{
		; Keep pre-v10 working folder and settings location ("%A_AppData%\Quick Access Popup").
		; Create the registry value to register QAP working folder ("HKEY_CURRENT_USER\Software\Jean Lalonde\Quick Access Popup\WorkingFolder").
		; The key "HKEY_CURRENT_USER\Software\Jean Lalonde\" is key is removed when uninstalling QAP.
		strWorkingFolder := A_AppData . "\" . g_strAppNameText
		SetRegistry(strWorkingFolder, "HKEY_CURRENT_USER\Software\Jean Lalonde\" . g_strAppNameText, "WorkingFolder")
		; ###_V(A_ThisLabel . " - setup mode, first run after install, keep pre-v10 working folder, set working folder registry key"
			; , "*WorkingFolder registry key", GetRegistry("HKEY_CURRENT_USER\Software\Jean Lalonde\" . g_strAppNameText, "WorkingFolder"))
		
		; If pre-v10 autostart option is enabled, create the Run registry key and remove the old startup file shortcut.
		if FileExist(A_Startup . "\" . g_strAppNameFile . ".lnk")
		{
			SetRegistry("QuickAccessPopup.exe", "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run", g_strAppNameText)
			FileDelete, %A_Startup%\%g_strAppNameFile%.lnk
			; ###_V(A_ThisLabel . " - setup mode, first run after install, startup shortcut file replaced with Run registry key"
				; , "*FileExist(A_Startup...", FileExist(A_Startup . "\" . g_strAppNameFile . ".lnk")
				; , "*Run registry key", GetRegistry("HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run", g_strAppNameText))
		}
	}
	else
	{
		; This is the first run after installing or re-installing v10 for user who never used pre-v10 (or QAP was launched from the Start menu shortcut).
		
		if !RegistryExist("HKEY_CURRENT_USER\Software\Jean Lalonde\" . g_strAppNameText, "WorkingFolder")
		{
			; This is the first install (the "WorkingFolder" registry does not exist), set the default autostart key
			; (check if the "WorkingFolder" key exists to avoid setting Run again at next install if user turned it off).
			SetRegistry("QuickAccessPopup.exe", "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run", g_strAppNameText)
			; ###_V(A_ThisLabel . " - setup mode, first run after FIRST install, set Run registry key"
				; , "*Run registry key", GetRegistry("HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run", g_strAppNameText))
			
			; If the "WorkingFolder" registry value does not exists, create it under the user's "My Documents" folder
			; (e.g. "C:\Users\UserName\Documents\Quick Access Popup\"). Create this folder before if required.
			strWorkingFolder := A_MyDocuments . "\" . g_strAppNameText
			if !FileExist(strWorkingFolder) ; must be created before setting the registry key
				FileCreateDir, %strWorkingFolder%
			
			; Create the registry value to register QAP working folder ("HKEY_CURRENT_USER\Software\Jean Lalonde\Quick Access Popup\WorkingFolder").
			; The key "HKEY_CURRENT_USER\Software\Jean Lalonde\" is key is removed when uninstalling QAP.
			SetRegistry(strWorkingFolder, "HKEY_CURRENT_USER\Software\Jean Lalonde\" . g_strAppNameText, "WorkingFolder")
			; ###_V(A_ThisLabel . " - setup mode, first run after FIRST install, created (probably) working folder under A_MyDocuments and set working folder registry key"
				; , "*WorkingFolder registry key", GetRegistry("HKEY_CURRENT_USER\Software\Jean Lalonde\" . g_strAppNameText, "WorkingFolder"))
		}
		else
		{
			; This is first run after re-install or QAP was launched from the Start menu shortcut. The working folder registry value exists.
			strWorkingFolder := GetRegistry("HKEY_CURRENT_USER\Software\Jean Lalonde\" . g_strAppNameText, "WorkingFolder")
			; ###_V(A_ThisLabel . " - setup mode, first run after RE-install or launched from Start menu, get working folder registry key"
				; , "*WorkingFolder registry key", GetRegistry("HKEY_CURRENT_USER\Software\Jean Lalonde\" . g_strAppNameText, "WorkingFolder"))
		}
	}
}
else ; NOT first launch
{
	; Set working folder by reading the working folder in the registry key:
	; "HKEY_CURRENT_USER\Software\Jean Lalonde\Quick Access Popup\WorkingFolder".
	strWorkingFolder := GetRegistry("HKEY_CURRENT_USER\Software\Jean Lalonde\" . g_strAppNameText, "WorkingFolder")
	; ###_V(A_ThisLabel . " - setup mode, not first run after install, get working folder registry key"
		; , "*WorkingFolder registry key", GetRegistry("HKEY_CURRENT_USER\Software\Jean Lalonde\" . g_strAppNameText, "WorkingFolder"))
}

; At each launch, copy templates files if they do not exist and set the working folder as A_WorkingDir.
if StrLen(strWorkingFolder) 
{
	; Recreate the folder in case the WorkingFolder registry key exists but the folder was deleted
	if !FileExist(strWorkingFolder) 
	{
		FileCreateDir, %strWorkingFolder%
		; ###_V(A_ThisLabel . " - each run, SHOULD NOT happen, created working folder", strWorkingFolder)
	}
	
	; If they do not exist in the working folder, copy the files "quickaccesspopup-setup.ini" (indicating in what language to run QAP)
	; created by the setup script in the "Common Application Data" folder (e.g. "C:\ProgramData\Quick Access Popup") and, if they exist, 
	; the template files for new installations on the same machine/server created by a sysadmin for "quickaccesspopup.ini" and "QAPconnect.ini".
	if !FileExist(strWorkingFolder . "\quickaccesspopup-setup.ini")
		FileCopy, %A_AppDataCommon%\Quick Access Popup\quickaccesspopup-setup.ini, %strWorkingFolder%
	if !FileExist(strWorkingFolder . "\quickaccesspopup.ini")
		FileCopy, %A_AppDataCommon%\quickaccesspopup.ini, %strWorkingFolder%
	if !FileExist(strWorkingFolder . "\QAPconnect.ini")
		FileCopy, %A_AppDataCommon%\QAPconnect.ini, %strWorkingFolder%

	; If working folder exists, sets the A_WorkingDir to this folder.
	; If this folder does not exist, displays an error message and exits the application.
	SetWorkingDir, %strWorkingFolder%
	; ###_V(A_ThisLabel . " - each run, working folder exists, set it as working folder", "*A_WorkingDir", A_WorkingDir)
}
else ; This could happen if the working folder registry value exist but is empty. Ask user to re-install QAP and quit.
{
	Oops("The Quick Access Popup settings folder could not be found.`n`nPlease, re-install Quick Access Popup.") ; language file is not available yet
	ExitApp
}

strWorkingFolder := ""

return
;-----------------------------------------------------------


;-----------------------------------------------------------
InitFileInstall:
;-----------------------------------------------------------

; Adding a new language:
; 1- add the FileInstall line below
; 2- update g_objOptionsLanguageCodes
; 3- edit o_L["OptionsLanguageLabels"] in all languages

FileInstall, FileInstall\QuickAccessPopup_LANG_DE.txt, %g_strTempDir%\QuickAccessPopup_LANG_DE.txt, 1
FileInstall, FileInstall\QuickAccessPopup_LANG_FR.txt, %g_strTempDir%\QuickAccessPopup_LANG_FR.txt, 1
; FileInstall, FileInstall\QuickAccessPopup_LANG_SV.txt, %g_strTempDir%\QuickAccessPopup_LANG_SV.txt, 1
FileInstall, FileInstall\QuickAccessPopup_LANG_ES.txt, %g_strTempDir%\QuickAccessPopup_LANG_ES.txt, 1
FileInstall, FileInstall\QuickAccessPopup_LANG_PT-BR.txt, %g_strTempDir%\QuickAccessPopup_LANG_PT-BR.txt, 1
FileInstall, FileInstall\QuickAccessPopup_LANG_IT.txt, %g_strTempDir%\QuickAccessPopup_LANG_IT.txt, 1
FileInstall, FileInstall\QuickAccessPopup_LANG_ZH-TW.txt, %g_strTempDir%\QuickAccessPopup_LANG_ZH-TW.txt, 1
FileInstall, FileInstall\QuickAccessPopup_LANG_PT.txt, %g_strTempDir%\QuickAccessPopup_LANG_PT.txt, 1
FileInstall, FileInstall\QuickAccessPopup_LANG_ZH-CN.txt, %g_strTempDir%\QuickAccessPopup_LANG_ZH-CN.txt, 1
FileInstall, FileInstall\QuickAccessPopup_LANG_NL.txt, %g_strTempDir%\QuickAccessPopup_LANG_NL.txt, 1
FileInstall, FileInstall\QuickAccessPopup_LANG_KO.txt, %g_strTempDir%\QuickAccessPopup_LANG_KO.txt, 1

FileInstall, FileInstall\default_browser_icon.html, %g_strTempDir%\default_browser_icon.html, 1

FileInstall, FileInstall\about-32_c.png, %g_strTempDir%\about-32_c.png
FileInstall, FileInstall\add_property-48_c.png, %g_strTempDir%\add_property-48_c.png
FileInstall, FileInstall\delete_property-48_c.png, %g_strTempDir%\delete_property-48_c.png
FileInstall, FileInstall\play_property-48_c.png, %g_strTempDir%\play_property-48_c.png
FileInstall, FileInstall\copy-48_c.png, %g_strTempDir%\copy-48_c.png
FileInstall, FileInstall\keyboard-48_c.png, %g_strTempDir%\keyboard-48_c.png
FileInstall, FileInstall\details-48_c.png, %g_strTempDir%\details-48_c.png
FileInstall, FileInstall\separator-26_c.png, %g_strTempDir%\separator-26_c.png
FileInstall, FileInstall\generic_sorting-26_c.png, %g_strTempDir%\generic_sorting-26_c.png
FileInstall, FileInstall\column-26_c.png, %g_strTempDir%\column-26_c.png
FileInstall, FileInstall\down_circular-26_c.png, %g_strTempDir%\down_circular-26_c.png
FileInstall, FileInstall\edit_property-48_c.png, %g_strTempDir%\edit_property-48_c.png
FileInstall, FileInstall\edit_property-48d_c.png, %g_strTempDir%\edit_property-48d_c.png
FileInstall, FileInstall\help-32_c.png, %g_strTempDir%\help-32_c.png
FileInstall, FileInstall\left-24_c.png, %g_strTempDir%\left-24_c.png
FileInstall, FileInstall\settings-32_c.png, %g_strTempDir%\settings-32_c.png
FileInstall, FileInstall\left2-24_c.png, %g_strTempDir%\left2-24_c.png
FileInstall, FileInstall\up_circular-26_c.png, %g_strTempDir%\up_circular-26_c.png
FileInstall, FileInstall\QAP-pin-off-26_c.png, %g_strTempDir%\QAP-pin-off-26_c.png
FileInstall, FileInstall\QAP-pin-on-26_c.png, %g_strTempDir%\QAP-pin-on-26_c.png
FileInstall, FileInstall\text-26_c.png, %g_strTempDir%\text-26_c.png
FileInstall, FileInstall\search-24_c.png, %g_strTempDir%\search-24_c.png

FileInstall, FileInstall\thumbs_up-32_c.png, %g_strTempDir%\thumbs_up-32_c.png
FileInstall, FileInstall\solutions-32_c.png, %g_strTempDir%\solutions-32_c.png
FileInstall, FileInstall\handshake-32_c.png, %g_strTempDir%\handshake-32_c.png
FileInstall, FileInstall\conference-32_c.png, %g_strTempDir%\conference-32_c.png
FileInstall, FileInstall\gift-32_c.png, %g_strTempDir%\gift-32_c.png

FileInstall, FileInstall\uac_logo-16.png, %g_strTempDir%\uac_logo-16.png

if FileExist(A_WorkingDir . "\QAPconnect.ini")
	FileInstall, FileInstall\QAPconnect-default.ini, %A_WorkingDir%\QAPconnect-default.ini, 1 ; overwrite
else
	FileInstall, FileInstall\QAPconnect-default.ini, %A_WorkingDir%\QAPconnect.ini ; no overwrite required
	
return
;-----------------------------------------------------------


;------------------------------------------------------------
InitLanguageArrays:
;------------------------------------------------------------

; ----------------------
; OPTIONS
g_objOptionsLanguageCodes := StrSplit("EN|FR|DE|ES|PT-BR|IT|ZH-TW|PT|ZH-CN|NL|KO", "|") ;  g_arrOptionsLanguageCodes
g_objOptionsLanguageLabels := StrSplit(o_L["OptionsLanguageLabels"], "|") ; g_arrOptionsLanguageLabels
loop, % g_objOptionsLanguageCodes.Length()
	if (g_objOptionsLanguageCodes[A_Index] = o_Settings.Launch.strLanguageCode.IniValue)
		{
			g_strLanguageLabel := g_objOptionsLanguageLabels[A_Index]
			break
		}

; 1 Basic Settings, 2 Menu Options, 3 Window Options, 4 Advanced Settings
g_objFavoriteGuiTabs := StrSplit(o_L["DialogAddFavoriteTabs"], "|") ; g_arrFavoriteGuiTabs

return
;------------------------------------------------------------


;------------------------------------------------------------
InitGuiControls:
; Order of controls important to avoid drawgins gliches when resizing
;------------------------------------------------------------

; InsertGuiControlPos(strControlName, intX, intY, blnCenter := false, blnDraw := false)

InsertGuiControlPos("f_picGuiAddFavorite",				 -44,   54, true, true)
InsertGuiControlPos("f_picGuiEditFavorite",				 -44,  127, true)
InsertGuiControlPos("f_picGuiEditFavorited",			 -44,  127, true)
InsertGuiControlPos("f_picGuiRemoveFavorite",			 -44,  202, true)
InsertGuiControlPos("f_picGuiMoveFavorite",				 -44,  277, true)
InsertGuiControlPos("f_picGuiCopyFavorite",				 -44,  352, true)

InsertGuiControlPos("f_picAddTextSeparator",			  10,  209)
InsertGuiControlPos("f_picAddColumnBreak",				  10,  174)
InsertGuiControlPos("f_picAddSeparator",				  10,  144)
InsertGuiControlPos("f_picMoveFavoriteDown",			  10,  113)
InsertGuiControlPos("f_picMoveFavoriteUp",				  10,   85)

InsertGuiControlPos("f_picUpMenu",						  10,   22)
InsertGuiControlPos("f_picPreviousMenu",				  10,   56)

InsertGuiControlPos("f_picGuiAlwaysOnTopOn",			  10,  -105, , true)
InsertGuiControlPos("f_picGuiAlwaysOnTopOff",			  10,  -105, , true)
InsertGuiControlPos("f_picSortFavorites",				  10,  -135, , true)
InsertGuiControlPos("f_picSearch",						-111,    23, , true)

InsertGuiControlPos("f_btnGuiSaveAndCloseFavorites",	  0,  -70, , true)
InsertGuiControlPos("f_btnGuiSaveAndStayFavorites",		  0,  -70, , true)
InsertGuiControlPos("f_btnGuiCancel",					  0,  -70, , true)

InsertGuiControlPos("f_drpMenusList",					  40, 23)
	
InsertGuiControlPos("f_lblGuiAddFavorite",				 -44,  100, true)
InsertGuiControlPos("f_lblGuiEditFavorite",				 -44,  175, true)
InsertGuiControlPos("f_lblGuiRemoveFavorite",			 -44,  250, true)
InsertGuiControlPos("f_lblGuiMoveFavorite",				 -44,  325, true)
InsertGuiControlPos("f_lblGuiCopyFavorite",				 -44,  400, true)
InsertGuiControlPos("f_lblMenuDropdownOrSearchLabel",	  40,    5)

InsertGuiControlPos("f_strFavoritesListFilter",			  40,   23)
InsertGuiControlPos("f_lvFavoritesList",				  40,   57)
InsertGuiControlPos("f_lvFavoritesListFiltered",		  40,   57)

InsertGuiControlPos("f_lnkSponsoredBy",             	  10,  -25)

return
;------------------------------------------------------------


;------------------------------------------------------------
InsertGuiControlPos(strControlName, intX, intY, blnCenter := false, blnDraw := false)
;------------------------------------------------------------
{
	aaGuiControl := Object()
	aaGuiControl.Name := strControlName
	aaGuiControl.X := intX
	aaGuiControl.Y := intY
	aaGuiControl.Center := blnCenter
	aaGuiControl.Draw := blnDraw
	
	g_saGuiControls.Push(aaGuiControl)
}
;------------------------------------------------------------


;-----------------------------------------------------------
LoadIniFile:
; load options, load favorites to menu object
;-----------------------------------------------------------

; reinit after Settings save if already exist
o_MenuInGui := Object() ; object of menu currently in Gui

g_blnIniFileCreation := !FileExist(o_Settings.strIniFile)
if (g_blnIniFileCreation) ; if it exists, it is not first launch or it was created by ImportFavoritesFP2QAP.ahk during install
{
	g_strIniBefore := "NEW"

	blnExplorerContextMenus := (g_blnPortableMode ? 0 : 1) ; context menus enabled if installed with the setup program (not if portable)

	strLanguageCode := o_Settings.Launch.strLanguageCode.IniValue
	strNavigateOrLaunchHotkeyMouseDefault := g_arrPopupHotkeyDefaults1 ; "MButton"
	strNavigateOrLaunchHotkeyKeyboardDefault := g_arrPopupHotkeyDefaults2 ; "W"
	strAlternativeHotkeyMouseDefault := g_arrPopupHotkeyDefaults3 ; "+MButton"
	strAlternativeHotkeyKeyboardDefault := g_arrPopupHotkeyDefaults4 ; "+#W"
	strMenuDynamicMenus := o_L["MenuDynamicMenus"]
	
	FileAppend,
		(LTrim Join`r`n
			[Global]
			LanguageCode=%strLanguageCode%
			ExplorerContextMenus=%blnExplorerContextMenus%
			AvailableThemes=Windows|Grey|Light Blue|Light Green|Light Red|Yellow
			Theme=Windows
			NameLocationHotkeysUpgraded=1
			WaitDelayInSnippet=40|80|180
			DefaultDynamicMenusBuilt=1
			[Gui-Grey]
			WindowColor=E0E0E0
			TextColor=000000
			ListviewBackground=FFFFFF
			ListviewText=000000
			MenuBackgroundColor=FFFFFF
			[Gui-Yellow]
			WindowColor=f9ffc6
			TextColor=000000
			ListviewBackground=fcffe0
			ListviewText=000000
			MenuBackgroundColor=fcffe0
			[Gui-Light Blue]
			WindowColor=e8e7fa
			TextColor=000000
			ListviewBackground=e7f0fa
			ListviewText=000000
			MenuBackgroundColor=e7f0fa
			[Gui-Light Red]
			WindowColor=fddcd7
			TextColor=000000
			ListviewBackground=fef1ef
			ListviewText=000000
			MenuBackgroundColor=fef1ef
			[Gui-Light Green]
			WindowColor=d6fbde
			TextColor=000000
			ListviewBackground=edfdf1
			ListviewText=000000
			MenuBackgroundColor=edfdf1
			[Favorites]
			Favorite1=Menu|%strMenuDynamicMenus%|> %strMenuDynamicMenus%|iconQAP||||||||||0||||||+^w
			Favorite2=QAP||{Popular Folders}
			Favorite3=QAP||{Popular Files}
			Favorite4=X
			Favorite5=QAP||{Recent Folders}
			Favorite6=QAP||{Recent Files}
			Favorite7=X
			Favorite8=QAP||{Switch Folder or App}
			Favorite9=Z
			Favorite10=X
			Favorite11=Folder|C:\|C:\
			Favorite12=Folder|Windows|%A_WinDir%
			Favorite13=Folder|Program Files|%A_ProgramFiles%
			Favorite14=Folder|User Profile|`%USERPROFILE`%
			Favorite15=Application|Notepad|%A_WinDir%\system32\notepad.exe
			Favorite16=URL|%g_strAppNameText% web site|https://www.quickaccesspopup.com|||||||||||||||||+^q
			Favorite17=Z

) ; leave the last extra line above
			, % o_Settings.strIniFile, % (A_IsUnicode ? "UTF-16" : "")
}
else
{
	Settings.BackupIniFile(o_Settings.strIniFile) ; backup main ini file

	g_strIniBefore := "DONT"
	o_Settings.ReadIniOption("SettingsFile", "blnDoNotConvertSettingsToUnicode", "DoNotConvertSettingsToUnicode", 0) ; blnDoNotConvertSettingsToUnicode
	if !(o_Settings.SettingsFile.blnDoNotConvertSettingsToUnicode.IniValue)
	{
		; check if the ini file is Unicode
		objIniFile := FileOpen(o_Settings.strIniFile, "r") ; open the file read-only
		strFileEncoding := (InStr(objIniFile.Encoding, "UTF-") ? objIniFile.Encoding : "")
		objIniFile.Close()
		g_strIniBefore := strFileEncoding
		if !StrLen(strFileEncoding) ; this is an ANSI file
		{
			g_strConvertSettingsEncodingYes := "Yes convert to Unicode"
			g_strConvertSettingsEncodingNo := "No keep ANSI encoding"
			g_strConvertSettingsEncodingLater := "Ask me next time"
			strGuiTitle := g_strAppNameText . " " . g_strAppVersion
			Gui, New, , %strGuiTitle%
			Gui, Color, White
			Gui, Font, w700 s9, Segoe UI
			Gui, Add, Text, w500 , % L("~1~ ""one-time"" maintenance", g_strAppNameText)
			Gui, Font, w400 s9, Segoe UI
			Gui, Add, Text, w500 , % L("~1~ is about to convert your settings file`n~2~`nfrom ANSI to Unicode encoding."
				, g_strAppNameText, o_Settings.strIniFile)
			Gui, Add, Text, w500 , This change will allow the use of extended characters in favorite's name, location or content, etc.
			Gui, Add, Text, w500 , If you encounter issues with special characters in your menu after the conversion, you can revert to the previous file.
			Gui, Add, Link, w500 , % L("See this <a href=""~1~"">FAQ page</a> for help now. Or search the <a href=""~1~"">FAQ</a> for ""Unicode"" later."
				, "https://www.quickaccesspopup.com/why-converting-the-settings-file-to-unicode-and-conversion-troubleshooting/"
				, "https://www.quickaccesspopup.com/frequently-asked-questions/")
			Gui, Font
			Gui, Add, Button, y+20 gConvertSettingsEncoding vf_btnConvertSettingsEncodingYes, %g_strConvertSettingsEncodingYes%
			Gui, Add, Button, yp x+10 gConvertSettingsEncoding vf_btnConvertSettingsEncodingNo, %g_strConvertSettingsEncodingNo%
			Gui, Add, Button, yp x+10 gConvertSettingsEncoding vf_btnConvertSettingsEncodingLater default, %g_strConvertSettingsEncodingLater%
			Gui, Add, Text
			GuiCenterButtons(strGuiTitle, 10, 5, 20, "f_btnConvertSettingsEncodingYes", "f_btnConvertSettingsEncodingNo", "f_btnConvertSettingsEncodingLater")
			Gui, Show, AutoSize Center
		}
	}
}

Gosub, LoadIniAlternativeMenuFeaturesHotkeys ; load from ini file and enable Alternative menu features hotkeys

; ---------------------
; Load Options

; Group General
o_Settings.ReadIniOption("Launch", "blnRunAtStartup", "", , "General", "f_blnOptionsRunAtStartup") ; blnRunAtStartup is not used but strGuiControls is
o_Settings.ReadIniOption("MenuPopup", "blnChangeFolderInDialog", "ChangeFolderInDialog", 0, "General", "f_blnChangeFolderInDialog") ; g_blnChangeFolderInDialog
if (o_Settings.MenuPopup.blnChangeFolderInDialog.IniValue)
	o_Settings.ReadIniOption("MenuPopup", "blnChangeFolderInDialog", "UnderstandChangeFoldersInDialogRisk", 0) ; keep same ini instance but replace value if false
o_Settings.ReadIniOption("Launch", "blnDisplayTrayTip", "DisplayTrayTip", 1, "General", "f_blnDisplayTrayTip") ; g_blnDisplayTrayTip
o_Settings.ReadIniOption("Launch", "blnCheck4Update", "Check4Update", (g_blnPortableMode ? 0 : 1), "General", "f_blnCheck4Update|f_lnkCheck4Update") ; g_blnCheck4Update ; enable by default only in setup install mode
o_Settings.ReadIniOption("Launch", "strTheme", "Theme", "Windows", "General", "f_drpTheme|f_lblTheme") ; g_strTheme
if !StrLen(o_Settings.Launch.strTheme.IniValue) ; in case value is found but empty
	o_Settings.Launch.strTheme.IniValue := "Windows"
global g_blnUseColors := (o_Settings.Launch.strTheme.IniValue <> "Windows")
o_Settings.ReadIniOption("SettingsWindow", "strAvailableThemes", "AvailableThemes") ; g_strAvailableThemes

; Group SettingsWindow
o_Settings.ReadIniOption("SettingsWindow", "blnDisplaySettingsStartup", "DisplaySettingsStartup", 1, "SettingsWindow", "f_blnDisplaySettingsStartup")
o_Settings.ReadIniOption("SettingsWindow", "blnRememberSettingsPosition", "RememberSettingsPosition", 1, "SettingsWindow", "f_blnRememberSettingsPosition") ; g_blnRememberSettingsPosition
o_Settings.ReadIniOption("SettingsWindow", "blnOpenSettingsOnActiveMonitor", "OpenSettingsOnActiveMonitor", 1, "SettingsWindow", "f_blnOpenSettingsOnActiveMonitor") ; g_blnOpenSettingsOnActiveMonitor
o_Settings.ReadIniOption("SettingsWindow", "blnAddAutoAtTop", "AddAutoAtTop", 0, "SettingsWindow", "f_lblAddAutoAtTop|f_blnAddAutoAtTop0|f_blnAddAutoAtTop1") ; g_blnAddAutoAtTop

; Group DisplayIcons
o_Settings.ReadIniOption("MenuIcons", "blnDisplayIcons", "DisplayIcons", 1, "MenuIcons", "f_blnDisplayIcons") ; g_blnDisplayIcons
o_Settings.ReadIniOption("MenuIcons", "intIconSize", "IconSize", 32, "MenuIcons", "f_lblIconSize|f_drpIconSize") ; g_intIconSize
o_Settings.ReadIniOption("MenuIcons", "intIconsManageRowsSettings", "IconsManageRows", 0, "MenuIcons", "f_intIconsManageRowsSettingsEdit|f_intIconsManageRowsSettings|f_lblIconsManageRows") ; g_intIconsManageRowsSettings
o_Settings.ReadIniOption("MenuIcons", "blnRetrieveIconInFrequentMenus", "RetrieveIconInFrequentMenus", 0, "MenuIcons", "f_blnRetrieveIconInFrequentMenus") ; avoid offline delay when retrieving icons for Frequent items menus
o_Settings.ReadIniOption("MenuIcons", "strIconReplacementList", "IconReplacementList", " ", "MenuIcons", "f_lnkIconReplacementList1|f_lnkIconReplacementList2|f_strIconReplacementList") ; g_strIconReplacementList
o_JLicons.ProcessReplacements(o_Settings.MenuIcons.strIconReplacementList.IniValue)

; Group MenuAppearance
o_Settings.ReadIniOption("Menu", "intHotkeyReminders", "HotkeyReminders", 3, "MenuAppearance", "f_lblHotkeyReminders|f_radHotkeyReminders1|f_radHotkeyReminders2|f_radHotkeyReminders3") ; g_intHotkeyReminders
o_Settings.ReadIniOption("Menu", "blnHotkeyRemindersRightAlign", "HotkeyRemindersRightAlign", 1, "MenuAppearance", "f_blnHotkeyRemindersRightAlign")
o_Settings.ReadIniOption("Menu", "blnDisplayNumericShortcuts", "DisplayMenuShortcuts", 0, "MenuAppearance", "f_blnDisplayNumericShortcuts") ; g_blnDisplayNumericShortcuts
o_Settings.ReadIniOption("Menu", "blnDisplayNumericShortcutsFromOne", "DisplayMenuShortcutsFromOne", 1, "MenuAppearance", "f_blnDisplayNumericShortcutsFromOne") ; g_blnDisplayNumericShortcutsFromOne
o_Settings.ReadIniOption("Menu", "intRecentFoldersMax", "RecentFoldersMax", 10, "MenuAppearance", "f_lblRecentFoldersMax|f_intRecentFoldersMaxEdit|f_intRecentFoldersMax|f_lblRecentFoldersMaxTitle") ; g_intRecentFoldersMax
o_Settings.ReadIniOption("Menu", "intNbLastActions", "NbLastActions", 10, "MenuAppearance", "f_lblNbLastActionsMaxTitle|f_lblNbLastActionsMax|f_intNbLastActionsMaxEdit|f_intNbLastActions") ; g_intNbLastActions
o_Settings.ReadIniOption("Menu", "blnAddCloseToDynamicMenus", "AddCloseToDynamicMenus", 1, "MenuAppearance", "f_blnAddCloseToDynamicMenus") ; g_blnAddCloseToDynamicMenus

; Group PopupMenu
o_Settings.ReadIniOption("MenuPopup", "intPopupMenuPosition", "PopupMenuPosition", 1, "PopupMenu", "f_radPopupMenuPositionTitle|f_radPopupMenuPosition1|f_radPopupMenuPosition2|f_radPopupMenuPosition3") ; g_intPopupMenuPosition
o_Settings.ReadIniOption("MenuPopup", "arrPopupFixPosition", "PopupFixPosition", "20,20", "PopupMenu"
	, "f_lblPopupFixPositionX|f_intPopupFixPositionXEdit|f_intPopupFixPositionX|f_lblPopupFixPositionY|f_intPopupFixPositionYEdit|f_intPopupFixPositionY") ; g_arrPopupFixPosition
o_Settings.MenuPopup.arrPopupFixPosition.IniValue := StrSplit(o_Settings.MenuPopup.arrPopupFixPosition.IniValue, ",")
o_Settings.ReadIniOption("MenuPopup", "blnExplorerContextMenus", "ExplorerContextMenus", 1, "PopupMenu", "f_blnExplorerContextMenus") ; g_blnExplorerContextMenus
if (g_blnPortableMode)
	o_Settings.MenuPopup.blnExplorerContextMenus.IniValue := 0 ; always disabled in portable mode, regardless of value in ini file
o_Settings.ReadIniOption("MenuPopup", "strExclusionMouseList", "ExclusionMouseList", " ", "PopupMenu"
	, "f_lnkExclusionMouseList1|f_lnkExclusionMouseList2|f_lnkExclusionMouseList3|f_strExclusionMouseList|f_btnGetWinInfoMouseExclusions") ; g_strExclusionMouseList
o_Settings.MenuPopup.strExclusionMouseList.SplitExclusionList()

; Group PopupHotkeys
o_Settings.ReadIniOption("MenuPopup", "blnLeftControlDoublePressed", "LeftControlDoublePressed", 0, "PopupHotkeys", "f_lblChangeShortcutTitle|f_lblControlDoublePressedTitle|f_blnLeftControlDoublePressed") ; g_blnLeftControlDoublePressed
o_Settings.ReadIniOption("MenuPopup", "blnRightControlDoublePressed", "RightControlDoublePressed", 0, "PopupHotkeys", "f_blnRightControlDoublePressed") ; g_blnRightControlDoublePressed

; Group PopupHotkeysAlternative
o_Settings.ReadIniOption("MenuPopup", "blnAlternativeMenuShowNotification", "AlternativeMenuShowNotification", 1, "PopupHotkeysAlternative"
	, "f_lblAlternativeMenu|f_blnAlternativeMenuShowNotification") ; g_blnAlternativeMenuShowNotification

; Group Filemanagers
; load ini values when init instance of FileManagers (must be after init of o_JLicons)
global o_FileManagers := new FileManagers
global g_aaFileManagerExplorer := o_FileManagers.SA[1].AA
global g_aaFileManagerDirectoryOpus := o_FileManagers.SA[2].AA
global g_aaFileManagerTotalCommander := o_FileManagers.SA[3].AA
global g_aaFileManagerQAPconnect := o_FileManagers.SA[4].AA

; Group Snippets
o_Settings.ReadIniOption("Snippets", "blnSnippetDefaultProcessEOLTab", "SnippetDefaultProcessEOLTab", 1, "Snippets", "f_lblSnippetDefaultIntro|f_blnSnippetDefaultProcessEOLTab") ; g_blnSnippetDefaultProcessEOLTab
o_Settings.ReadIniOption("Snippets", "blnSnippetDefaultFixedFont", "SnippetDefaultFixedFont", 0, "Snippets", "f_blnSnippetDefaultFixedFont") ; g_blnSnippetDefaultFixedFont
o_Settings.ReadIniOption("Snippets", "intSnippetDefaultFontSize", "SnippetDefaultFontSize", 10, "Snippets", "f_lblSnippetDefaultFontSize|f_intSnippetDefaultFontSizeEdit|f_intSnippetDefaultFontSize") ; g_intSnippetDefaultFontSize
o_Settings.ReadIniOption("Snippets", "blnSnippetDefaultMacro", "SnippetDefaultMacro", 0, "Snippets", "f_blnSnippetDefaultMacro") ; g_blnSnippetDefaultMacro
o_Settings.ReadIniOption("Hotstrings", "strHotstringsDefaultOptions", "HotstringsDefaultOptions", " ", "Snippets"
	, "f_lblSelectHotstringDefaultOptions|f_btnSelectHotstringDefaultOptions") ; g_strHotstringsDefaultOptions

; Group User Variables (DetectCloudUserVariables will be executed after UsageDbInit), IconReplacement and SwitchExclusion
o_Settings.ReadIniOption("UserVariables", "strUserVariablesList", "UserVariablesList", " ", "UserVariables", "f_lnkUserVariablesList|f_lnkUserVariablesListTitle|f_strUserVariablesList") ; g_strUserVariablesList

; Group Database
o_Settings.ReadIniOption("Database", "intUsageDbIntervalSeconds", "UsageDbIntervalSeconds", 60, "Database"
	, "f_lblOptionUsageDbEnableStatement|f_lblOptionUsageDbEnableStatementTitle|f_blnOptionUsageDbEnable|f_lblUsageDbIntervalSeconds|f_intUsageDbIntervalSecondsEdit|f_intUsageDbIntervalSeconds") ; g_intUsageDbIntervalSeconds
o_Settings.Database.intUsageDbIntervalSeconds.IniValue := ((o_Settings.Database.intUsageDbIntervalSeconds.IniValue <> 0
	and o_Settings.Database.intUsageDbIntervalSeconds.IniValue < 60 and A_ComputerName <> "JEAN-PC")
	? 60 : o_Settings.Database.intUsageDbIntervalSeconds.IniValue)
global g_blnUsageDbEnabled := (o_Settings.Database.intUsageDbIntervalSeconds.IniValue > 0)
o_Settings.ReadIniOption("Database", "intUsageDbDaysInPopular", "UsageDbDaysInPopular", 30, "Database", "f_lblUsageDbDaysInPopular|f_intUsageDbDaysInPopularEdit|f_intUsageDbDaysInPopular") ; g_intUsageDbDaysInPopular
o_Settings.ReadIniOption("Database", "fltUsageDbMaximumSize", "UsageDbMaximumSize", 3, "Database", "f_lblUsageDbMaximumSize|f_fltUsageDbMaximumSize|f_btnUsageDbFlush") ; g_fltUsageDbMaximumSize
o_Settings.ReadIniOption("Database", "blnUsageDbShowPopularityIndex", "UsageDbShowPopularityIndex", 0, "Database", "f_blnUsageDbShowPopularityIndex") ; g_blnUsageDbShowPopularityIndex
o_Settings.ReadIniOption("Database", "intUsageDbDebug", "UsageDbDebug", 0, "Database", "") ; g_intUsageDbDebug (not in Gui)
global g_blnUsageDbDebug := (g_intUsageDbDebug > 0)
global g_blnUsageDbDebugBeep := (g_intUsageDbDebug > 1)

; Group MenuAdvanced
o_Settings.ReadIniOption("MenuAdvanced", "intNbLiveFolderItemsMax", "NbLiveFolderItemsMax", "", "MenuAdvanced", "f_lblNbLiveFolderItemsMax|f_intNbLiveFolderItemsMax") ; ERROR if not found ; g_intNbLiveFolderItemsMax
if (o_Settings.MenuAdvanced.intNbLiveFolderItemsMax.IniValue = "ERROR")
	o_Settings.MenuAdvanced.intNbLiveFolderItemsMax.WriteIni(500)
o_Settings.ReadIniOption("MenuPopup", "blnOpenMenuOnTaskbar", "OpenMenuOnTaskbar", 1, "MenuAdvanced", "f_blnOpenMenuOnTaskbar") ; g_blnOpenMenuOnTaskbar
o_Settings.ReadIniOption("MenuAdvanced", "intClipboardMaxSize", "ClipboardMaxSize", 10000, "MenuAdvanced", "f_lblClipboardMaxSize|f_intClipboardMaxSize") ; default 10000 chars ; g_intClipboardMaxSize

; Group AdvancedLaunch
o_Settings.ReadIniOption("LaunchAdvanced", "blnRunAsAdmin", "RunAsAdmin", 0, "AdvancedLaunch", "f_blnRunAsAdmin|f_picRunAsAdmin") ; default false, if true reload QAP as admin ; g_blnRunAsAdmin
o_Settings.ReadIniOption("LaunchAdvanced", "blnRefreshWindowsAppsListAtStartup", "RefreshWindowsAppsListAtStartup", 0, "AdvancedLaunch", "f_blnRefreshWindowsAppsListAtStartup") ; g_blnRefreshWindowsAppsListAtStartup

; Group AdvancedOther
o_Settings.ReadIniOption("DialogBoxes", "intWaitDelayInDialogBox", "WaitDelayInDialogBox", 100, "AdvancedOther", "f_lblWaitDelayInDialogBox|f_intWaitDelayInDialogBox") ; default 100 ms ; g_intWaitDelayInDialogBox
o_Settings.ReadIniOption("Execution", "blnSendToConsoleWithAlt", "SendToConsoleWithAlt", 1, "AdvancedOther", "f_blnSendToConsoleWithAlt") ; default true, send ANSI values to CMD with ALT+0nnn ASCII codes ; g_blnSendToConsoleWithAlt
o_Settings.ReadIniOption("SettingsFile", "strExternalMenusCataloguePath", "ExternalMenusCataloguePath", " ", "AdvancedOther"
	, "f_blnEnableExternalMenusCatalogue|f_lnkEnableExternalMenusCatalogue|f_lblExternalMenusCataloguePathPrompt|f_strExternalMenusCataloguePath|f_btnExternalMenusCataloguePath") ; g_strExternalMenusCataloguePath
o_Settings.ReadIniOption("Snippets", "arrWaitDelayInSnippet", "WaitDelayInSnippet", "40|80|180", "AdvancedOther"
	, "f_lblWaitDelayInSnippet|f_intWaitDelayInSnippet1|f_intWaitDelayInSnippet2|f_intWaitDelayInSnippet3") ; default 300 ms (split in three sleep commands) ; strWaitDelayInSnippet
o_Settings.Snippets.arrWaitDelayInSnippet.IniValue := StrSplit(o_Settings.Snippets.arrWaitDelayInSnippet.IniValue, "|")
o_Settings.ReadIniOption("Execution", "strSwitchExclusionList", "SwitchExclusionList", " ", "AdvancedOther"
	, "f_lnkSwitchExclusionList|f_strSwitchExclusionList|f_lnkGetWinInfoSwitchExclusion|f_btnGetWinInfoSwitchExclusion") ; g_strSwitchExclusionList

; not in Options Gui
o_Settings.ReadIniOption("SettingsFile", "blnExternalMenusCataloguePathReadOnly", "ExternalMenusCataloguePathReadOnly", 0) ; false by default
o_Settings.ReadIniOption("Execution", "blnTryWindowPosition", "TryWindowPosition", 0) ; g_blnTryWindowPosition
o_Settings.ReadIniOption("Launch", "blnDiagMode", "DiagMode", 0) ; g_blnDiagMode
o_Settings.ReadIniOption("Launch", "blnDonor", "Donor", 0)
o_Settings.ReadIniOption("Launch", "strSponsorName", "Sponsor", " ")
Gosub, ProcessSponsorName

o_Settings.ReadIniOption("Launch", "strUserBanner", "UserBanner", " ") ; g_strUserBanner
o_Settings.ReadIniOption("Launch", "blnDefaultDynamicMenusBuilt", "DefaultDynamicMenusBuilt", 0) ; blnDefaultDynamicMenusBuilt
if !(o_Settings.Launch.blnDefaultDynamicMenusBuilt.IniValue)
 	Gosub, AddToIniDynamicDefaultMenu ; modify the ini file Favorites section before reading it
o_Settings.ReadIniOption("Launch", "blnDefaultWindowsAppsMenuBuilt", "DefaultWindowsAppsMenuBuilt", 0) ; blnDefaultWindowsAppsMenuBuilt
if !(o_Settings.Launch.blnDefaultWindowsAppsMenuBuilt.IniValue) and (GetOSVersion() = "WIN_10")
 	Gosub, AddToIniWindowsAppsDefaultMenu ; modify the ini file Favorites section before reading it
o_Settings.ReadIniOption("Launch", "blnDefaultMenuBuilt", "DefaultMenuBuilt", 0) ; blnDefaultMenuBuilt
if !(o_Settings.Launch.blnDefaultMenuBuilt.IniValue)
 	Gosub, AddToIniDefaultMenu ; modify the ini file Favorites section before reading it
o_Settings.ReadIniOption("SettingsFile", "strBackupFolder", "BackupFolder", A_WorkingDir, "General", "f_lblBackupFolder|f_strBackupFolder|f_btnBackupFolder|f_lblWorkingFolder|f_strWorkingFolder|f_btnWorkingFolder")

; ---------------------
; Load favorites

Gosub, LoadMenuFromIni

Gosub, ConvertLocationHotkeys ; if pre v8.8, convert name|location hotkeys to favorites shorcut

strLanguageCode := ""
blnExplorerContextMenus := ""
ResetArray("arrMainMenu")
strNavigateOrLaunchHotkeyMouseDefault := ""
strNavigateOrLaunchHotkeyKeyboard := ""
strAlternativeHotkeyMouseDefault := ""
strAlternativeHotkeyKeyboardDefault := ""
objThisFavorite := ""
objLoadIniFavorite := ""
ResetArray("arrSubMenu")
strFileList := ""
intNumberOfBackups := ""
objIniFile := ""
strFileEncoding := ""
strIniFileContent := ""
strGuiTitle := ""
strMenuDynamicMenus := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
ProcessSponsorName:
;------------------------------------------------------------

if (o_Settings.Launch.blnDonor.IniValue = 1) ; equals exact 1
; donor code need to be updated
	g_SponsoredMessage := "<a id=""update"">" . o_L["SponsoredUpdate"] . "</a>"
else if (o_Settings.Launch.blnDonor.IniValue = SubStr(MD5(g_strEscapePipe . StrLower(o_Settings.Launch.strSponsorName.IniValue) . g_strEscapePipe, true), 13, 8)) ; lower case starting 2019-06-27
	or (o_Settings.Launch.blnDonor.IniValue = SubStr(MD5(g_strEscapePipe . o_Settings.Launch.strSponsorName.IniValue . g_strEscapePipe, true), 13, 8)) ; for backward compatibiity for donors in 201905-201906
; donor code matching the sponsor name
{
	g_SponsoredMessage := L(o_L["SponsoredName"], o_Settings.Launch.strSponsorName.IniValue)
	o_Settings.Launch.blnDonor.IniValue := 1 ; boolean value used later
}
else
; no donor code or donor code not matching the sponsor name
{
	g_SponsoredMessage := "<a id=""none"">" . o_L["SponsoredNone"] . "</a>"
	o_Settings.Launch.blnDonor.IniValue := 0
}

return
;------------------------------------------------------------


;------------------------------------------------------------
ConvertSettingsEncoding:
;------------------------------------------------------------

if (A_GuiControl = "f_btnConvertSettingsEncodingYes")
{
	FileCopy, % o_Settings.strIniFile, % o_Settings.strIniFile . "-ANSI-BK", 1 ; the backup file should not exist but, in case, overwrite it
	FileRead, strIniFileContent, % o_Settings.strIniFile ; read the actual ANSI file
	FileDelete, % o_Settings.strIniFile ; delete the ini file
	Sleep, 20 ; safety
	FileAppend, %strIniFileContent%, % o_Settings.strIniFile, UTF-16 ; rewrite the ini file in Unicode UTF-16 (little endian)
	
	MsgBox, 48, % L(o_L["OopsTitle"], g_strAppNameText, g_strAppVersion)
		, % "Your settings file has been converted to the Unicode encoding.`n`n"
		. "This change allows the use of extended characters in favorite's name, location or content.`n`n"
		. L("You must restart ~1~ and load the new settings now.", g_strAppNameText)
		
	g_strIniAfter := "DONE"
	Gosub, ReloadQAP
}
else if (A_GuiControl = "f_btnConvertSettingsEncodingNo")
	
	o_Settings.SettingsFile.blnDoNotConvertSettingsToUnicode.WriteIni(1)

; else do nothing

g_strIniAfter := "SKIP"
Gui, Destroy

return
;------------------------------------------------------------


;------------------------------------------------------------
LoadMenuFromIni:
LoadMenuFromIniWithStatus:
;------------------------------------------------------------

if !FileExist(o_Settings.strIniFile)
{
	Oops(o_L["OopsWriteProtectedError"], g_strAppNameText)
	ExitApp
}
else
{
	; reinit after Settings save if already exist
	; g_objMainMenu := Object() ; object of menu structure entry point
	; g_objMainMenu.MenuPath := o_L["MainMenuName"] ; localized name of the main menu
	; g_objMainMenu.MenuType := "Menu" ; main menu is not a group

	; global g_objMenusIndex := Object() ; index of menus path used in Gui menu dropdown list and to access the menu object for a given menu path
	
	o_QAPfeatures.aaQAPfeaturesInMenus := Object() ; re-init

	global o_Containers := new Containers() ; replace g_objMenusIndex index of menus path used in Gui menu dropdown list and to access the menu object for a given menu path
	global o_MainMenu := new Container("Menu", o_L["MainMenuName"]) ; init o_MainMenu that replace g_objMainMenu, object of menu structure entry point
	if (o_MainMenu.LoadFavoritesFromIniFile((A_ThisLabel = "LoadMenuFromIniWithStatus")) <> "EOM")
		ExitApp
	if (A_ThisLabel = "LoadMenuFromIniWithStatus")
		ToolTip ; clear tooltip after refresh

}

return
;------------------------------------------------------------


;------------------------------------------------------------
AddToIniWindowsAppsDefaultMenu:
; Technical debt: this menu is created with IDs found in Windows 10 Version 1803 (same as in 1709) as-of 2018-08-01.
; We have no way to check if these IDs are OK on users' system (IDs in future releases may change). 
;------------------------------------------------------------

Gosub, ButtonRefreshWindowsAppsListAtStartup

g_strAddThisMenuName := o_L["MenuMyWindowsAppsMenu"]
Gosub, AddToIniGetMenuName ; find next favorite number in ini file and check if g_strAddThisMenuName menu name exists
g_intNextFavoriteNumber -= 1 ; minus one to overwrite the existing end of main menu marker

AddToIniOneDefaultMenu("", "", "X")
AddToIniOneDefaultMenu(g_strMenuPathSeparator . " " . g_strAddThisMenuNameWithInstance, g_strAddThisMenuNameWithInstance, "Menu")

AddToIniOneDefaultMenu("{Add Favorite - WindowsApp}", "", "QAP", true)
AddToIniOneDefaultMenu("", "", "X")
AddToIniOneDefaultMenu("Microsoft.MicrosoftSolitaireCollection_8wekyb3d8bbwe!App", "Solitaire", "WindowsApp")
AddToIniOneDefaultMenu("", "", "X")
AddToIniOneDefaultMenu("Microsoft.WindowsCalculator_8wekyb3d8bbwe!App", "Calculator", "WindowsApp")
AddToIniOneDefaultMenu("microsoft.windowscommunicationsapps_8wekyb3d8bbwe!microsoft.windowslive.calendar", "Calendar", "WindowsApp")
AddToIniOneDefaultMenu("", "", "X")
AddToIniOneDefaultMenu("Microsoft.MSPaint_8wekyb3d8bbwe!Microsoft.MSPaint", "MS Paint", "WindowsApp")
AddToIniOneDefaultMenu("Microsoft.SkypeApp_kzf8qxf38zg5c!App", "Skype", "WindowsApp")
AddToIniOneDefaultMenu("", "", "X")
AddToIniOneDefaultMenu("Microsoft.MicrosoftEdge_8wekyb3d8bbwe!MicrosoftEdge", "Microsoft Edge", "WindowsApp")
AddToIniOneDefaultMenu("Microsoft.WindowsMaps_8wekyb3d8bbwe!App", "Maps", "WindowsApp")
AddToIniOneDefaultMenu("Microsoft.BingNews_8wekyb3d8bbwe!AppexNews", "Bing News", "WindowsApp")
AddToIniOneDefaultMenu("Microsoft.ZuneVideo_8wekyb3d8bbwe!Microsoft.ZuneVideo", "Zune Video", "WindowsApp")
AddToIniOneDefaultMenu("", "", "X")
AddToIniOneDefaultMenu("windows.immersivecontrolpanel_cw5n1h2txyewy!microsoft.windows.immersivecontrolpanel", "Immersive Control Panel", "WindowsApp")
AddToIniOneDefaultMenu("", "", "Z") ; close Windows Apps menu

AddToIniOneDefaultMenu("", "", "Z") ; restore end of main menu marker

IniWrite, 1, % o_Settings.strIniFile, Global, DefaultWindowsAppsMenuBuilt

g_intNextFavoriteNumber := ""
g_strAddThisMenuName := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
AddToIniDefaultMenu:
;------------------------------------------------------------

g_strAddThisMenuName := o_L["MenuMyQAPMenu"]
Gosub, AddToIniGetMenuName ; find next favorite number in ini file and check if g_strAddThisMenuName menu name exists
g_intNextFavoriteNumber -= 1 ; minus one to overwrite the existing end of main menu marker

; do not save QAP feature menus name to ini file and keep default names
AddToIniOneDefaultMenu("", "", "X")
AddToIniOneDefaultMenu(g_strMenuPathSeparator . " " . g_strAddThisMenuNameWithInstance, g_strAddThisMenuNameWithInstance, "Menu")
AddToIniOneDefaultMenu("{Add Favorite - QAP}", "", "QAP", true)
AddToIniOneDefaultMenu("", "", "X")
AddToIniOneDefaultMenu("{Last Actions}", "", "QAP")
AddToIniOneDefaultMenu("{ReopenCurrentFolder}", "", "QAP", true)
AddToIniOneDefaultMenu("{Current Folders}", "", "QAP", true)
AddToIniOneDefaultMenu("", "", "X")
AddToIniOneDefaultMenu("{Clipboard}", "", "QAP", true)
AddToIniOneDefaultMenu("", "", "X")
AddToIniOneDefaultMenu("{Drives}", "", "QAP")
AddToIniOneDefaultMenu("", "", "Z") ; close QAP menu

g_strAddThisMenuName := o_L["MenuMySpecialMenu"]
Gosub, AddToIniGetMenuName ; find next favorite number in ini file and check if g_strAddThisMenuName menu name exists

AddToIniOneDefaultMenu(g_strMenuPathSeparator . " " . g_strAddThisMenuNameWithInstance, g_strAddThisMenuNameWithInstance, "Menu")
AddToIniOneDefaultMenu("{Add Favorite - Special}", "", "QAP", true)
AddToIniOneDefaultMenu("", "", "X")
AddToIniOneDefaultMenu(A_Desktop, o_L["MenuDesktop"], "Special") ; Desktop
AddToIniOneDefaultMenu("{450D8FBA-AD25-11D0-98A8-0800361B1103}", "", "Special") ; Documents
AddToIniOneDefaultMenu(o_SpecialFolders.strMyPicturesPath, "", "Special") ; Pictures
AddToIniOneDefaultMenu(o_SpecialFolders.strDownloadPath, "", "Special") ; Downloads
AddToIniOneDefaultMenu("", "", "X")
AddToIniOneDefaultMenu("{20D04FE0-3AEA-1069-A2D8-08002B30309D}", "", "Special") ; Computer
AddToIniOneDefaultMenu("{F02C1A0D-BE21-4350-88B0-7367FC96EF3C}", "", "Special") ; Network
AddToIniOneDefaultMenu("", "", "X")
AddToIniOneDefaultMenu("{21EC2020-3AEA-1069-A2DD-08002B30309D}", "", "Special") ; Control Panel
AddToIniOneDefaultMenu("{645FF040-5081-101B-9F08-00AA002F954E}", "", "Special") ; Recycle Bin
AddToIniOneDefaultMenu("", "", "Z") ; close special menu

g_strAddThisMenuName := o_QAPfeatures.aaQAPFeaturesCodeByDefaultName[o_L["MenuSettings"] . "..."] ; QAP feature code used here for comparison only, not for menu name
Gosub, AddToIniGetMenuName ; find next favorite number in ini file and check if the QAP feature exist in this menu
if (g_strAddThisMenuNameWithInstance = o_QAPfeatures.aaQAPFeaturesCodeByDefaultName[o_L["MenuSettings"] . "..."]) ; if equal, it means that this menu is not already there
; (we cannot have this menu twice with "+" because, as all QAP features, o_L["MenuSettings"] always have the same menu name)
{
	AddToIniOneDefaultMenu("", "", "X")
	AddToIniOneDefaultMenu("{Settings}", o_L["MenuSettings"] . "...", "QAP", true) ; back in main menu

}
if (o_FileManagers.P_intActiveFileManager = 2 or o_FileManagers.P_intActiveFileManager = 3) ; Directory Opus or Total Commander
{
	strDOpusOrTCMenuName := (o_FileManagers.P_intActiveFileManager = 2 ? o_L["DOpusMenuName"] : o_L["TCMenuName"]) . "..."
	
	g_strAddThisMenuName := strDOpusOrTCMenuName
	Gosub, AddToIniGetMenuName ; find next favorite number in ini file and check if g_strAddThisMenuName menu name exists
	if (g_strAddThisMenuName = strDOpusOrTCMenuName) ; if equal, it means that this menu is not already there
	; (we cannot have this menu twice with "+" because, as all QAP features, o_L["TCMenuName"] always have the same menu name)
	{
		AddToIniOneDefaultMenu("", "", "X")
		AddToIniOneDefaultMenu((o_FileManagers.P_intActiveFileManager = 2 ? "{DOpus Favorites}" : "{TC Directory hotlist}"), strDOpusOrTCMenuName, "QAP")
	}
}
g_strAddThisMenuName := o_QAPfeatures.aaQAPFeaturesCodeByDefaultName[o_L["MenuAddThisFolder"] . "..."] ; QAP feature code used here for comparison only, not for menu name
Gosub, AddToIniGetMenuName ; find next favorite number in ini file and check if the QAP feature exist in this menu
if (g_strAddThisMenuNameWithInstance = o_QAPfeatures.aaQAPFeaturesCodeByDefaultName[o_L["MenuAddThisFolder"] . "..."]) ; if equal, it means that this menu is not already there
; (we cannot have this menu twice with "+" because, as all QAP features, o_L["MenuAddThisFolder"] always have the same menu name)
{
	AddToIniOneDefaultMenu("", "", "X")
	AddToIniOneDefaultMenu("{Add This Folder}", o_L["MenuAddThisFolder"] . "...", "QAP", true)
}

AddToIniOneDefaultMenu("", "", "Z") ; restore end of main menu marker

IniWrite, 1, % o_Settings.strIniFile, Global, DefaultMenuBuilt

g_intNextFavoriteNumber := ""
g_strAddThisMenuName := ""
strDOpusOrTCMenuName := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
AddToIniDynamicDefaultMenu:
;------------------------------------------------------------

g_strAddThisMenuName := o_L["MenuDynamicMenus"]
Gosub, AddToIniGetMenuName ; find next favorite number in ini file and check if g_strAddThisMenuName menu name exists
g_intNextFavoriteNumber -= 1 ; minus one to overwrite the existing end of main menu marker

; AddToIniOneDefaultMenu(strLocation, strName, strFavoriteType, blnAddShortcut := false)
AddToIniOneDefaultMenu("", "", "X")
AddToIniOneDefaultMenu(g_strMenuPathSeparator . " " . g_strAddThisMenuNameWithInstance, g_strAddThisMenuNameWithInstance, "Menu", 0, "+^m")

AddToIniOneDefaultMenu("{Popular Folders}", "", "QAP")
AddToIniOneDefaultMenu("{Popular Files}", "", "QAP")
AddToIniOneDefaultMenu("", "", "X")
AddToIniOneDefaultMenu("{Recent Folders}", "", "QAP")
AddToIniOneDefaultMenu("{Recent Files}", "", "QAP")
AddToIniOneDefaultMenu("", "", "X")
AddToIniOneDefaultMenu("{Switch Folder or App}", "", "QAP")
AddToIniOneDefaultMenu("", "", "Z") ; close Popular Contents menu

AddToIniOneDefaultMenu("", "", "Z") ; restore end of main menu marker

IniWrite, 1, % o_Settings.strIniFile, Global, DefaultDynamicMenusBuilt

g_strAddThisMenuNameWithInstance := "" ; last used here

return
;------------------------------------------------------------


;------------------------------------------------------------
AddToIniGetMenuName:
;------------------------------------------------------------

strInstance := ""

Loop
{
	strIniLine := o_Settings.ReadIniValue("Favorite" . A_Index, "", "Favorites")
	if InStr(strIniLine, g_strAddThisMenuName . strInstance)
		strInstance .= "+"
	if (strIniLine = "ERROR")
	{
		g_intNextFavoriteNumber := A_Index
		Break
	}
}
g_strAddThisMenuNameWithInstance := g_strAddThisMenuName . strInstance

strInstance := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
AddToIniOneDefaultMenu(strLocation, strName, strFavoriteType, blnAddShortcut := false, strCustomShortcut := "")
;------------------------------------------------------------
{
	global g_intNextFavoriteNumber
	global g_blnIniFileCreation

	if (strFavoriteType = "Z")
		strNewIniLine := strFavoriteType
	else
	{
		if (strFavoriteType = "Menu")
			if InStr(strName, o_L["MenuMyQAPMenu"]) ; use InStr in case strName has "+" added
				strIconResource := "iconApplication"
			else if InStr(strName, o_L["MenuMySpecialMenu"])
				strIconResource := "iconSpecialFolders"
			else if InStr(strName, o_L["MenuDynamicMenus"])
				strIconResource := "iconQAP"
			else ; o_L["MenuMyWindowsAppsMenu"]
				strIconResource := "iconDesktop"
		else if (strFavoriteType = "Special")
			strIconResource := o_SpecialFolders.AA[strLocation].strDefaultIcon
		else if (strFavoriteType = "WindowsApp")
			strIconResource := "iconDesktop"
		else
			strIconResource := o_QAPfeatures.AA[strLocation].strDefaultIcon

		if !StrLen(strName)
			if (strFavoriteType = "Special")
				strName := o_SpecialFolders.AA[strLocation].strDefaultName
			else
				strName := o_QAPfeatures.AA[strLocation].strDefaultName

		if (g_blnIniFileCreation) ; do not add shortcut if not creation of ini file at first launch
			if StrLen(strCustomShortcut)
				strShortcut := strCustomShortcut
			else if (blnAddShortcut)
				strShortcut := o_QAPfeatures.AA[strLocation].strDefaultShortcut

		strNewIniLine := strFavoriteType . "|" . strName . "|" . strLocation . "|" . strIconResource . "||||||||||||||||" . strShortcut
	}
	
	IniWrite, %strNewIniLine%, % o_Settings.strIniFile, Favorites, Favorite%g_intNextFavoriteNumber%
	g_intNextFavoriteNumber++
}
;------------------------------------------------------------


;-----------------------------------------------------------
LoadIniAlternativeMenuFeaturesHotkeys:
; load and enable Alternative menu features hotkeys
; called at launch by LoadIniFile and after saving options by GuiOptionsGroupSave
;-----------------------------------------------------------

; Turn off previous QAP Alternative Menu features hotkeys
for strCode, objThisQAPFeature in o_QAPfeatures.AA
	if HasShortcut(objThisQAPFeature.strCurrentHotkey)
	{
		; do nothing if error (in case the hotkey does not exist yet when adding a new alternative hotkey)
		Hotkey, % objThisQAPFeature.strCurrentHotkey, , Off UseErrorLevel
		objThisQAPFeature.strCurrentHotkey := "" ; will be reset next when reloading from ini file
	}
	
; Load QAP Alternative Menu hotkeys
for intOrder, strCode in o_QAPfeatures.saQAPFeaturesAlternativeCodeByOrder
{
	strHotkey := o_Settings.ReadIniOption("MenuPopup", "str" . strCode, strCode, "", "PopupHotkeysAlternative"
		, "f_lblAlternativeHotkeyName" . intOrder . "|f_lblAlternativeHotkeyText" . intOrder . "|f_btnChangeAlternativeHotkey" . intOrder
		, "AlternativeMenuHotkeys")

	if (strHotkey <> "ERROR")
	{
		Hotkey, %strHotkey%, OpenAlternativeMenuHotkey, On UseErrorLevel
		o_QAPfeatures.AA[strCode].strCurrentHotkey := strHotkey
	}
	else
		ErrorLevel := 0 ; reset value that was changed to 5 when IniRead returned the string "ERROR"
	if (ErrorLevel)
		Oops(o_L["DialogInvalidHotkey"], new Triggers.HotkeyParts(strHotkey).Hotkey2Text(), o_QAPfeatures.AA[strCode].strLocalizedName) ; .strLocalizedName OK because Alternative
}

strCode := ""
objThisQAPFeature := ""
strHotkey := ""
intOrder := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
ConvertLocationHotkeys:
;------------------------------------------------------------

; check if name-location hotkeys need to be converted to v8.8 favorites shortcut format
blnNameLocationHotkeysUpgraded := o_Settings.ReadIniValue("NameLocationHotkeysUpgraded", 0) ; default false
if (blnNameLocationHotkeysUpgraded) ; already upgraded, no need to convert
	return

; check if location hotkeys need to be converted to v8.1 "name|location|hotkey" format before converting to v8.8 favorites shortcut format
blnHotkeysUpgradedToNameLocation := o_Settings.ReadIniValue("HotkeysUpgradedToNameLocation", 0) ; default false

blnNeedToSave := false
Loop ; convert each LocationHotkeys to shortcut for the first favorites matching name and location
{
	strLocationHotkey := o_Settings.ReadIniValue("Hotkey" . A_Index, "", "LocationHotkeys")
	if (strLocationHotkey = "ERROR")
		break
	saLocationHotkey := StrSplit(strLocationHotkey, "|") ; name|location|hotkey (v8.1+ format)
	
	if !(blnHotkeysUpgradedToNameLocation)
	; convert format from pre-v8.1 "location|hotkey" to "name|location|hotkey", using the name of the first favorite found for location
	{
		saLocationHotkey[3] := saLocationHotkey[2] ; in this order, move hotkey to 3rd position
		saLocationHotkey[2] := saLocationHotkey[1] ; in this order, move location to 2nd position
		Loop
		{
			strLoadIniLine := o_Settings.ReadIniValue("Favorite" . A_Index, "", "Favorites")
			if (strLoadIniLine = "ERROR")
				break
			; 1 FavoriteType, 2 FavoriteName, 3 FavoriteLocation, ...
			saLoadIniLine := StrSplit(strLoadIniLine, "|")
			if (saLoadIniLine[3] = saLocationHotkey[1])
				saLocationHotkey[1] := saLoadIniLine[2] ; put name in saLocationHotkey[1]
		}
	}
	; now saLocationHotkey[1] contains the name, saLocationHotkey[2] contains the location and saLocationHotkey[3] contains the hotkey
	; find first favorite for this name-location in menu object 
	for strMenuName, oContainer in o_Containers.AA
		for intIndex, oItem in oContainer.SA
		{
			strThisItemName := (oItem.AA.strFavoriteType = "QAP" ? "" : oItem.AA.strFavoriteName) ; compare empty name for QAP Features favorites
			if (strThisItemName = saLocationHotkey[1]) and (oItem.AA.strFavoriteLocation = saLocationHotkey[2])
			{
				oItem.AA.strFavoriteShortcut := saLocationHotkey[3]
				blnNeedToSave := true
				break, 2 ; exit the 2 for-loops
			}
		}			
}

if (blnNeedToSave)
{
	MsgBox, 48, % L(o_L["OopsTitle"], g_strAppNameText, g_strAppVersion)
		, % L("Hotkeys section in your settings file has been upgraded for this version (~1~). The upgraded settings will be saved.", g_strAppVersion)
	FileCopy, % o_Settings.strIniFile, % o_Settings.strIniFile . "-pre_v8_8_hotkeys-BK", 1 ; the backup file should not exist but, in case, overwrite it
	; must be after FileCopy
	IniRead, strHotkeysIniSection, % o_Settings.strIniFile, LocationHotkeys
	IniWrite, %strHotkeysIniSection%, % o_Settings.strIniFile, LocationHotkeys-pre_v8_8_hotkeys-BK
	IniDelete, % o_Settings.strIniFile, LocationHotkeys
	IniWrite, 1, % o_Settings.strIniFile, Global, NameLocationHotkeysUpgraded
	Gosub, GuiSaveAndReloadQAP
}


blnNameLocationHotkeysUpgraded := ""
blnHotkeysUpgradedToNameLocation := ""
strLocationHotkey := ""
saLocationHotkey := ""
strLoadIniLine := ""
saLoadIniLine := ""
strMenuName := ""
oContainer := ""
intIndex := ""
oItem := ""
strThisItemName := ""
blnNeedToSave := ""
strHotkeysIniSection := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
InitDiagMode:
;------------------------------------------------------------

MsgBox, 52, %g_strAppNameText%, % L(o_L["DiagModeCaution"], g_strAppNameText, g_strDiagFile)
IfMsgBox, No
{
	o_Settings.Launch.blnDiagMode.WriteIni(0)
	return
}

if !FileExist(g_strDiagFile)
{
	FileAppend, DateTime`tType`tData`n, %g_strDiagFile%
	Diag("DIAGNOSTIC FILE", o_L["DiagModeIntro"], "")
	Diag("A_ScriptFullPath", A_ScriptFullPath, "")
	Diag("AppVersion", g_strAppVersion, "")
	Diag("A_WorkingDir", A_WorkingDir, "")
	Diag("A_AhkVersion", A_AhkVersion, "")
	Diag("A_OSVersion", A_OSVersion, "")
	Diag("A_Is64bitOS", A_Is64bitOS, "")
	Diag("A_IsUnicode", A_IsUnicode, "")
	Diag("A_Language", A_Language, "")
	Diag("A_IsAdmin", A_IsAdmin, "")
	RegRead, strUsageDbRecentsFolder, HKEY_CURRENT_USER, Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders, Recent
	Diag("Recent Items Folder" , strUsageDbRecentsFolder, "")
}

FileRead, strIniFileContent, % o_Settings.strIniFile
strIniFileContent := StrReplace(strIniFileContent, """", """""")
Diag("IniFile", "`n""" . strIniFileContent . """`n", "")
FileAppend, `n, %g_strDiagFile% ; required when the last line of the existing file ends with "

strIniFileContent := ""

g_intClipboardMenuTickCount := 0
g_intDrivesMenuTickCount := 0
g_intRecentItemsMenuTickCount := 0
g_intSwitchReopenMenuTickCount := 0

return
;------------------------------------------------------------


;------------------------------------------------------------
LoadThemeGlobal:
;------------------------------------------------------------

global g_strGuiWindowColor := o_Settings.ReadIniValue("WindowColor", E0E0E0, "Gui-" . o_Settings.Launch.strTheme.IniValue)
global g_strMenuBackgroundColor := o_Settings.ReadIniValue("MenuBackgroundColor", FFFFFF, "Gui-" . o_Settings.Launch.strTheme.IniValue)

return
;------------------------------------------------------------



;========================================================================================================================
; END OF INITIALIZATION
;========================================================================================================================


;========================================================================================================================
!_017_EXIT:
;========================================================================================================================

;-----------------------------------------------------------
ExitApp: ; should not be called
TrayMenuExitApp:
;-----------------------------------------------------------

ExitApp
;-----------------------------------------------------------


;-----------------------------------------------------------
CleanUpBeforeExit:
;-----------------------------------------------------------

; if (o_Settings.Launch.blnDiagMode.IniValue)
	; Diag("ListLines", ScriptInfo("ListLines"))

if FileExist(o_Settings.strIniFile) ; in case user deleted the ini file to create a fresh one, this avoids creating an ini file with just this value
{
	SaveWindowPosition("SettingsPosition", "ahk_id " . g_strAppHwnd)
	IniWrite, % GetScreenConfiguration(), % o_Settings.strIniFile, Global, LastScreenConfiguration
}

FileRemoveDir, %g_strTempDir%, 1 ; Remove all files and subdirectories

Gosub, ExternalMenusRelease ; release reserved external menus

if IsObject(o_UsageDb) ; use IsObject instead of g_blnUsageDbEnabled in case it was turned false in this session
{
	; before backup the db, close it to avoid lock
	Loop
		if o_UsageDb.CloseDb()
		{
			blnDbClosed := true
			break
		}
		else ; no error messge if close fails - not needed when quitting
		{
			if (A_Index = 3) ; try 3 times in case background task is writing to the file
			{
				blnDbClosed := false
				break
			}
			Sleep, 500
		}

	if (blnDbClosed)
		FileCopy, %g_strUsageDbFile%, % StrReplace(g_strUsageDbFile, ".DB", ".DB-BK"), 1
}

if (o_Settings.Launch.blnDiagMode.IniValue)
{
	MsgBox, % 52 + 256 , %g_strAppNameText%, % L(o_L["DiagModeExit"], g_strAppNameText, g_strDiagFile) . "`n`n" . o_L["DiagModeIntro"] . "`n`n" . o_L["DiagModeSee"]
	IfMsgBox, Yes
		Run, %g_strDiagFile%
}

ExitApp
;-----------------------------------------------------------


;========================================================================================================================
; END OF EXIT
;========================================================================================================================



;========================================================================================================================
!_020_BUILD:
;========================================================================================================================

;------------------------------------------------------------
SetTrayMenuIcon:
;------------------------------------------------------------

Menu, Tray, NoStandard
o_Settings.ReadIniOption("LaunchAdvanced", "strAlternativeTrayIcon", "AlternativeTrayIcon", " ", "AdvancedLaunch", "f_strAlternativeTrayIcon|f_lblAlternativeTrayIcon|f_btnAlternativeTrayIcon") ; empty if not found

Menu, Tray, UseErrorLevel ; will be turned off at the end of SetTrayMenuIcon
if StrLen(o_Settings.LaunchAdvanced.strAlternativeTrayIcon.IniValue) and FileExist(o_Settings.LaunchAdvanced.strAlternativeTrayIcon.IniValue)
	Menu, Tray, Icon, % o_Settings.LaunchAdvanced.strAlternativeTrayIcon.IniValue, 1, 1 ; last 1 to freeze icon during pause or suspend
else
	if (A_IsAdmin and o_Settings.LaunchAdvanced.blnRunAsAdmin.IniValue)
		; 56 is iconQAPadminBeta and 55 is iconQAPadmin, last 1 to freeze icon during pause or suspend
		Menu, Tray, Icon, % o_JLicons.strFileLocation, % (g_strCurrentBranch <> "prod" ? 56 : 55), 1
	else
		; 60 is iconQAPloading, 58 is iconQAPbeta and 1 is iconQAP, last 1 to freeze icon during pause or suspend
		Menu, Tray, Icon, % o_JLicons.strFileLocation, % (g_strCurrentBranch <> "prod" ?  (g_strCurrentBranch = "beta" ? 58 : 60) : 1), 1

g_blnTrayIconError := ErrorLevel or g_blnTrayIconError
Menu, Tray, UseErrorLevel, Off

if (g_blnTrayIconError)
	Oops(o_L["OopsJLiconsError"], g_strJLiconsVersion)

;@Ahk2Exe-IgnoreBegin
; Start of code for developement phase only - won't be compiled
Menu, Tray, Icon, % o_JLicons.strFileLocation, % (A_IsAdmin ? 57 : 59), 1 ; 57 is iconQAPadminDev and 59 is iconQAPdev, last 1 to freeze icon during pause or suspend
Menu, Tray, Standard
; / End of code for developement phase only - won't be compiled
;@Ahk2Exe-IgnoreEnd

g_blnTrayIconError := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
BuildTrayMenu:
BuildTrayMenuRefresh:
;------------------------------------------------------------

if (g_blnPortableMode)
	global g_aaMenuTrayL := o_L.InsertAmpersand(true, "MenuSettings", "MenuRunAtStartup", "MenuFile", "MenuFavorite", "MenuTools"
		, "MenuOptions", "MenuHelp", "GuiDonate")
else
	global g_aaMenuTrayL := o_L.InsertAmpersand(true, "MenuSettings", "MenuFile", "MenuFavorite", "MenuTools"
		, "MenuOptions", "MenuHelp", "GuiDonate")

if (A_ThisLabel = "BuildTrayMenuRefresh")
	Menu, Tray, DeleteAll

Menu, Tray, Add, % g_aaMenuTrayL["MenuSettings"] . "...", GuiShowFromTray
Menu, Tray, Add
if (g_blnPortableMode)
{
	Menu, Tray, Add, % g_aaMenuTrayL["MenuRunAtStartup"], ToggleRunAtStartup ; function ToggleRunAtStartup replaces RunAtStartup
	Menu, Tray, Add
}
Menu, Tray, Add, % g_aaMenuTrayL["MenuFile"], :menuBarFile
Menu, Tray, Add, % g_aaMenuTrayL["MenuFavorite"], :menuBarFavorite
Menu, Tray, Add, % g_aaMenuTrayL["MenuTools"], :menuBarTools
Menu, Tray, Add, % g_aaMenuTrayL["MenuOptions"], :menuBarOptions
Menu, Tray, Add, % g_aaMenuTrayL["MenuHelp"], :menuBarHelp
if (!o_Settings.Launch.blnDonor.IniValue)
{
	Menu, Tray, Add
	Menu, Tray, Add, % g_aaMenuTrayL["GuiDonate"], GuiDonate
}
;@Ahk2Exe-IgnoreBegin
; Start of code for developement phase only - won't be compiled
Menu, Tray, Add
; / End of code for developement phase only - won't be compiled
;@Ahk2Exe-IgnoreEnd

Menu, Tray, Default, % g_aaMenuTrayL["MenuSettings"] . "..."
if (g_blnUseColors)
	Menu, Tray, Color, %g_strMenuBackgroundColor%
Menu, Tray, Tip, % g_strAppNameText . " " . g_strAppVersion . " (" . (A_PtrSize * 8) . "-bit)`n"
	. (o_Settings.Launch.blnDonor.IniValue ? L(g_aaMenuTrayL["DonateThankyou"], o_Settings.Launch.strSponsorName.IniValue) : g_aaMenuTrayL["DonateButton"]) ; A_PtrSize * 8 = 32 or 64

return
;------------------------------------------------------------


;------------------------------------------------------------
BuildGuiMenuBar:
; see https://docs.microsoft.com/fr-fr/windows/desktop/uxguide/cmd-menus
;------------------------------------------------------------

loop, Parse, % "Main|File|Favorite|Tools|Options|MoreOptions|Help", "|"
	new Container("MenuBar", "menuBar" . A_LoopField)

; 1 strFavoriteType, 2 strFavoriteName, 3 strFavoriteLocation, 4 strFavoriteIconResource

aaMenuFileL := o_L.InsertAmpersand(true, "GuiSave", "GuiSaveAndClose", "GuiCancel", "GuiClose", "MenuOpenWorkingDirectory"
	, "MenuEditIniFile", "MenuSwitchSettings", "MenuSwitchSettingsDefault", "ImpExpMenu", "MenuReload", "MenuExitApp")
saMenuItemsTable := Object()
saMenuItemsTable.Push(["GuiSaveAndStayFavorites", L(aaMenuFileL["GuiSave"], g_strAppNameText), "", "iconNoIcon"])
saMenuItemsTable.Push(["GuiSaveAndCloseFavorites", L(aaMenuFileL["GuiSaveAndClose"], g_strAppNameText), "", "iconNoIcon"])
saMenuItemsTable.Push(["GuiCancel", aaMenuFileL["GuiCancel"], "", "iconNoIcon"])
saMenuItemsTable.Push(["GuiCancel", L(aaMenuFileL["GuiClose"], g_strAppNameText), "", "iconNoIcon"])
saMenuItemsTable.Push(["X"])
saMenuItemsTable.Push(["OpenWorkingDirectory", aaMenuFileL["MenuOpenWorkingDirectory"], "", "iconNoIcon"])
saMenuItemsTable.Push(["X"])
saMenuItemsTable.Push(["ShowSettingsIniFile", L(aaMenuFileL["MenuEditIniFile"], o_Settings.strIniFileNameExtOnly), "", "iconNoIcon"])
saMenuItemsTable.Push(["SwitchSettings", aaMenuFileL["MenuSwitchSettings"] . "...", "", "iconNoIcon"])
saMenuItemsTable.Push(["SwitchSettingsDefault", aaMenuFileL["MenuSwitchSettingsDefault"], "", "iconNoIcon"])
saMenuItemsTable.Push(["ImportExport", aaMenuFileL["ImpExpMenu"] . "...", "", "iconNoIcon"])
saMenuItemsTable.Push(["X"])
saMenuItemsTable.Push(["ReloadQAP", L(aaMenuFileL["MenuReload"], g_strAppNameText), "", "iconNoIcon"])
saMenuItemsTable.Push(["X"])
saMenuItemsTable.Push(["TrayMenuExitApp", L(aaMenuFileL["MenuExitApp"], g_strAppNameText), "", "iconNoIcon"])
o_Containers.AA["menuBarFile"].LoadFavoritesFromTable(saMenuItemsTable)
o_Containers.AA["menuBarFile"].BuildMenu(false, true) ; true for numeric shortcut already inserted
Menu, menuBarFile, Disable, % L(aaMenuFileL["GuiSave"], g_strAppNameText)
Menu, menuBarFile, Disable, % L(aaMenuFileL["GuiSaveAndClose"], g_strAppNameText)
Menu, menuBarFile, Disable, % aaMenuFileL["GuiCancel"]

aaFavoriteL := o_L.InsertAmpersand(true, "DialogAdd", "DialogEdit", "GuiRemoveFavorite", "GuiMove", "DialogCopy"
	, "ControlToolTipMoveUp", "ControlToolTipMoveDown", "ControlToolTipSortFavorites")
saMenuItemsTable := Object()
saMenuItemsTable.Push(["GuiAddFavoriteSelectType", aaFavoriteL["DialogAdd"], "", "iconNoIcon"])
saMenuItemsTable.Push(["GuiEditFavorite", aaFavoriteL["DialogEdit"], "", "iconNoIcon"])
saMenuItemsTable.Push(["X"])
saMenuItemsTable.Push(["GuiRemoveFavorite", aaFavoriteL["GuiRemoveFavorite"], "", "iconNoIcon"])
saMenuItemsTable.Push(["GuiMoveFavoriteToMenu", aaFavoriteL["GuiMove"], "", "iconNoIcon"])
saMenuItemsTable.Push(["GuiCopyFavorite", aaFavoriteL["DialogCopy"], "", "iconNoIcon"])
saMenuItemsTable.Push(["X"])
saMenuItemsTable.Push(["GuiMoveFavoriteUp", aaFavoriteL["ControlToolTipMoveUp"], "", "iconNoIcon"])
saMenuItemsTable.Push(["GuiMoveFavoriteDown", aaFavoriteL["ControlToolTipMoveDown"], "", "iconNoIcon"])
saMenuItemsTable.Push(["X"])
saMenuItemsTable.Push(["GuiSortFavorites", aaFavoriteL["ControlToolTipSortFavorites"], "", "iconNoIcon"])
o_Containers.AA["menuBarFavorite"].LoadFavoritesFromTable(saMenuItemsTable)
o_Containers.AA["menuBarFavorite"].BuildMenu(false, true) ; true for numeric shortcut already inserted

aaMenuToolsL := o_L.InsertAmpersand(true, "ControlToolTipSearchButton", "DialogExtendedSearch", "DialogShortcuts", "DialogHotstrings", "DialogIconsManage"
	, "MenuRefreshMenu", "MenuSuspendHotkeys", "MenuRestoreSettingsWindowPosition", "ControlToolTipAlwaysOnTopOff")
saMenuItemsTable := Object()
saMenuItemsTable.Push(["GuiFocusFilter", aaMenuToolsL["ControlToolTipSearchButton"], "", "iconNoIcon"]) ; GuiFavoritesListFilterButton
saMenuItemsTable.Push(["FilterExtendedClick", aaMenuToolsL["DialogExtendedSearch"], "", "iconNoIcon"]) ; vf_blnFavoritesListFilterExtended x+10 yp gLoadFavoritesInGuiFiltered
saMenuItemsTable.Push(["X"])
saMenuItemsTable.Push(["GuiHotkeysManage", aaMenuToolsL["DialogShortcuts"], "", "iconNoIcon"]) ; vf_blnFavoritesListFilterExtended x+10 yp gLoadFavoritesInGuiFiltered
saMenuItemsTable.Push(["GuiHotkeysManageHotstrings", aaMenuToolsL["DialogHotstrings"], "", "iconNoIcon"]) ; vf_blnFavoritesListFilterExtended x+10 yp gLoadFavoritesInGuiFiltered
saMenuItemsTable.Push(["GuiIconsManage", aaMenuToolsL["DialogIconsManage"], "", "iconNoIcon"]) ; vf_blnFavoritesListFilterExtended x+10 yp gLoadFavoritesInGuiFiltered
saMenuItemsTable.Push(["X"])
saMenuItemsTable.Push(["RefreshQAPMenu", aaMenuToolsL["MenuRefreshMenu"], "", "iconNoIcon"]) ; vf_blnFavoritesListFilterExtended x+10 yp gLoadFavoritesInGuiFiltered
saMenuItemsTable.Push(["SuspendHotkeys", aaMenuToolsL["MenuSuspendHotkeys"], "", "iconNoIcon"]) ; vf_blnFavoritesListFilterExtended x+10 yp gLoadFavoritesInGuiFiltered
saMenuItemsTable.Push(["GuiShowRestoreDefaultPosition", aaMenuToolsL["MenuRestoreSettingsWindowPosition"], "", "iconNoIcon"]) ; vf_blnFavoritesListFilterExtended x+10 yp gLoadFavoritesInGuiFiltered
 saMenuItemsTable.Push(["X"])
saMenuItemsTable.Push(["GuiAlwaysOnTop", aaMenuToolsL["ControlToolTipAlwaysOnTopOff"], "", "iconNoIcon"]) ; vf_blnFavoritesListFilterExtended x+10 yp gLoadFavoritesInGuiFiltered
o_Containers.AA["menuBarTools"].LoadFavoritesFromTable(saMenuItemsTable)
o_Containers.AA["menuBarTools"].BuildMenu(false, true) ; true for numeric shortcut already inserted

aaL := o_L.InsertAmpersand(true, "OptionsGeneral", "OptionsSettingsWindow", "OptionsMenuIcons", "OptionsMenuAppearance", "OptionsPopupMenu"
	, "OptionsPopupHotkeys", "OptionsPopupHotkeysAlternative", "OptionsFileManagers", "OptionsSnippets", "OptionsUserVariables"
	, "OptionsDatabase", "OptionsMenuAdvanced", "OptionsAdvancedLaunch", "OptionsAdvancedOther")
saMenuItemsTable := Object()
saMenuItemsTable.Push(["GuiOptionsGroupGeneral", aaL["OptionsGeneral"], "", "iconNoIcon"])
saMenuItemsTable.Push(["GuiOptionsGroupSettingsWindow", aaL["OptionsSettingsWindow"], "", "iconNoIcon"])
saMenuItemsTable.Push(["X", "", "", ""])
saMenuItemsTable.Push(["GuiOptionsGroupMenuIcons", aaL["OptionsMenuIcons"], "", "iconNoIcon"])
saMenuItemsTable.Push(["GuiOptionsGroupMenuAppearance", aaL["OptionsMenuAppearance"], "", "iconNoIcon"])
saMenuItemsTable.Push(["GuiOptionsGroupPopupMenu", aaL["OptionsPopupMenu"], "", "iconNoIcon"])
saMenuItemsTable.Push(["X", "", "", ""])
saMenuItemsTable.Push(["GuiOptionsGroupPopupHotkeys", aaL["OptionsPopupHotkeys"], "", "iconNoIcon"])
saMenuItemsTable.Push(["GuiOptionsGroupPopupHotkeysAlternative", aaL["OptionsPopupHotkeysAlternative"], "", "iconNoIcon"])
saMenuItemsTable.Push(["X", "", "", ""])
saMenuItemsTable.Push(["GuiOptionsGroupFileManagers", aaL["OptionsFileManagers"], "", "iconNoIcon"])
saMenuItemsTable.Push(["X", "", "", ""])
saMenuItemsTable.Push(["GuiOptionsGroupSnippets", aaL["OptionsSnippets"], "", "iconNoIcon"])
saMenuItemsTable.Push(["X", "", "", ""])
saMenuItemsTable.Push(["GuiOptionsGroupUserVariables", aaL["OptionsUserVariables"], "", "iconNoIcon"])
saMenuItemsTable.Push(["X", "", "", ""])
saMenuItemsTable.Push(["GuiOptionsGroupDatabase", aaL["OptionsDatabase"], "", "iconNoIcon"])
saMenuItemsTable.Push(["X", "", "", ""])
saMenuItemsTable.Push(["GuiOptionsGroupMenuAdvanced", aaL["OptionsMenuAdvanced"], "", "iconNoIcon"])
saMenuItemsTable.Push(["GuiOptionsGroupAdvancedLaunch", aaL["OptionsAdvancedLaunch"], "", "iconNoIcon"])
saMenuItemsTable.Push(["GuiOptionsGroupAdvancedOther", aaL["OptionsAdvancedOther"], "", "iconNoIcon"])
o_Containers.AA["menuBarOptions"].LoadFavoritesFromTable(saMenuItemsTable)
o_Containers.AA["menuBarOptions"].BuildMenu(false, true) ; true for numeric shortcut already inserted

aaHelpL := o_L.InsertAmpersand(true, "MenuHelp", "MenuUpdate", "HelpMenuQuickStart", "HelpMenuKnowledgeBase", "HelpMenuSupportForum"
	, "GuiHotkeysHelp", "GuiDropFilesHelp", "GuiDonate", "GuiDonateCodeInput", "MenuAbout")
saMenuItemsTable := Object()
saMenuItemsTable.Push(["GuiHelp", aaHelpL["MenuHelp"], "", "iconNoIcon"])
saMenuItemsTable.Push(["X"])
saMenuItemsTable.Push(["Check4Update", aaHelpL["MenuUpdate"], "", "iconNoIcon"])
saMenuItemsTable.Push(["X"])
saMenuItemsTable.Push(["HelpQuickStart", aaHelpL["HelpMenuQuickStart"], "", "iconNoIcon"])
saMenuItemsTable.Push(["HelpKnowledgeBase", aaHelpL["HelpMenuKnowledgeBase"], "", "iconNoIcon"])
saMenuItemsTable.Push(["HelpSupportForum", aaHelpL["HelpMenuSupportForum"], "", "iconNoIcon"])
saMenuItemsTable.Push(["X"])
saMenuItemsTable.Push(["GuiHotkeysHelpClicked", aaHelpL["GuiHotkeysHelp"], "", "iconNoIcon"])
saMenuItemsTable.Push(["GuiDropFilesHelpClicked", aaHelpL["GuiDropFilesHelp"], "", "iconNoIcon"])
saMenuItemsTable.Push(["X"])
saMenuItemsTable.Push(["GuiDonate", aaHelpL["GuiDonate"], "", "iconNoIcon"])
saMenuItemsTable.Push(["GuiDonateCodeInput", aaHelpL["GuiDonateCodeInput"], "", "iconNoIcon"])
saMenuItemsTable.Push(["X"])
saMenuItemsTable.Push(["GuiAbout", aaHelpL["MenuAbout"], "", "iconNoIcon"])
o_Containers.AA["menuBarHelp"].LoadFavoritesFromTable(saMenuItemsTable)
o_Containers.AA["menuBarHelp"].BuildMenu(false, true) ; true for numeric shortcut already inserted

aaMenuBarL := o_L.InsertAmpersand(false, "MenuFile", "MenuFavorite", "MenuTools", "MenuOptions", "MenuHelp")
Menu, menuBar, Add, % aaMenuBarL["MenuFile"], :menuBarFile
Menu, menuBar, Add, % aaMenuBarL["MenuFavorite"], :menuBarFavorite
Menu, menuBar, Add, % aaMenuBarL["MenuTools"], :menuBarTools
Menu, menuBar, Add, % aaMenuBarL["MenuOptions"], :menuBarOptions
Menu, menuBar, Add, % aaMenuBarL["MenuHelp"], :menuBarHelp

ToolTip ; close menu building tooltip

aaL := ""

return
;------------------------------------------------------------

;------------------------------------------------------------
HelpQuickStart:
HelpKnowledgeBase:
HelpSupportForum:
;------------------------------------------------------------

if (A_ThisLabel = "HelpQuickStart")
	Run, https://www.quickaccesspopup.com/what-should-i-know-about-quick-access-popup-before-starting/
else if (A_ThisLabel = "HelpKnowledgeBase")
	Run, https://www.quickaccesspopup.com/frequently-asked-questions/
else if (A_ThisLabel = "HelpSupportForum")
	Run, https://forum.quickaccesspopup.com

return
;------------------------------------------------------------


;------------------------------------------------------------
InitDynamicMenus:
;------------------------------------------------------------

; o_L[""] keys used as names for dynamic menus

strMenuToInit := "DOpusMenuName|DOpusLayoutsName|TCMenuName|MenuDrives|MenuSwitchFolderOrApp|MenuCurrentFolders|MenuClipboard"
	. "|MenuLastActions|MenuPopularMenusFiles|MenuPopularMenusFolders|MenuRecentFolders|MenuRecentFiles"

loop, Parse, strMenuToInit, "|"
	new Container("Menu", o_L[A_LoopField], "", "init", true) ; last parameter true for blnDynamic

strPopularMenusFoldersAndFiles := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
PopularFoldersMenuShortcut:
PopularFilesMenuShortcut:
;------------------------------------------------------------

if !(g_blnUsageDbEnabled)
	return

SetWaitCursor(true)

Gosub, RefreshPopularMenus

Gosub, SetMenuPosition
CoordMode, Menu, % (o_Settings.MenuPopup.intPopupMenuPosition.IniValue = 2 ? "Window" : "Screen")

SetWaitCursor(false)

Menu, % (A_ThisLabel = "PopularFoldersMenuShortcut" ? o_L["MenuPopularMenusFolders"] : o_L["MenuPopularMenusFiles"]), Show, %g_intMenuPosX%, %g_intMenuPosY%

return
;------------------------------------------------------------


;------------------------------------------------------------
RefreshPopularMenus:
;------------------------------------------------------------

if !(g_blnUsageDbEnabled)
	return

Diag(A_ThisLabel, "", "START")

loop, parse, % "Folders|Files", |
{
	strFoldersOrFiles := A_Loopfield
	strFoldersOrFilesMenuNameLocalized := (strFoldersOrFiles = "Folders" ? o_L["MenuPopularMenusFolders"] : o_L["MenuPopularMenusFiles"])
	
	if !(o_QAPfeatures.aaQAPfeaturesInMenus.HasKey("{Popular " . strFoldersOrFiles . "}")) ; we don't have this QAP features in at least one menu
		continue
		
	strUsageDbSQL := "SELECT Popular" . strFoldersOrFiles .  "MenuData FROM zMetadata;"
	if !o_UsageDb.Query(strUsageDbSQL, o_MetadataRecordSet)
	{
		Diag(A_ThisLabel, "SQLite QUERY zMETADATA Error: " . strUsageDbSQL, "STOP")
		Oops("SQLite QUERY zMETADATA Error`n`nMessage: " . o_UsageDb.ErrorMsg . "`nCode: " . o_UsageDb.ErrorCode . "`nQuery: " . strUsageDbSQL)
		g_blnUsageDbEnabled := false
		return
	}
	o_MetadataRecordSet.Next(o_MetadataRow)
	strMenuItemsList := o_MetadataRow[1] ; first (and only) field is PopularFoldersMenuData or PopularFilesMenuData
	o_MetadataRecordSet.Free()
	
	; for each line in strMenuItemsList: 1) Frequent Folders/Files|2) Name/Location|3) Action|4) Icon
	; example: Frequent Folders|E:\Dropbox\AutoHotkey\QuickAccessPopup|Folder|iconFolder
	
	saMenuItemsTable := Object()
	Loop, Parse, strMenuItemsList, `n
		if StrLen(A_LoopField)
		{
			; swap items for backward compatibility pre-v10
			saOneLine := StrSplit(A_LoopField, "|")
			saOneLine[1] := saOneLine[3] ; put favorite type in 1
			if (o_Settings.Database.blnUsageDbShowPopularityIndex.IniValue) ; remove popularity index
				saOneLine[3] := SubStr(saOneLine[2], 1, InStr(saOneLine[2], " [", false, 0) - 1) ; strip " [n]" from end
			else
				saOneLine[3] := saOneLine[2] ; duplicate name 2 in location 3
			saOneLine[2] := StrReplace(saOneLine[2], "&", "&&") ; double ampersands in menu name
			; keep icon in 4
			saMenuItemsTable.Push(saOneLine)
		}
	
	o_Containers.AA[o_L["MenuPopularMenus" . strFoldersOrFiles]].LoadFavoritesFromTable(saMenuItemsTable)
	o_Containers.AA[o_L["MenuPopularMenus" . strFoldersOrFiles]].BuildMenu()
}

saOneLine := ""
strUsageDbSQL := ""
o_MetadataRecordSet := ""
saOneLine := ""
saMenuItemsTable := ""

Diag(A_ThisLabel, "", "STOP")
return
;------------------------------------------------------------


;------------------------------------------------------------
ClipboardMenuShortcut:
;------------------------------------------------------------

SetWaitCursor(true)

Gosub, RefreshClipboardMenu

Gosub, SetMenuPosition
CoordMode, Menu, % (o_Settings.MenuPopup.intPopupMenuPosition.IniValue = 2 ? "Window" : "Screen")

SetWaitCursor(false)

Menu, % o_L["MenuClipboard"], Show, %g_intMenuPosX%, %g_intMenuPosY%

return
;------------------------------------------------------------


;------------------------------------------------------------
RefreshClipboardMenu:
;------------------------------------------------------------

if !o_QAPfeatures.aaQAPfeaturesInMenus.HasKey("{Clipboard}") ; we don't have this QAP feature in at least one menu
	return

Diag(A_ThisLabel, "", "START")

strContentsInClipboard := ""
if (StrLen(Clipboard) <= o_Settings.MenuAdvanced.intClipboardMaxSize.IniValue) ; Clipboard is too large - 22 000 bytes of AHK code took close to 2 seconds
{
	; gather info for menu (can be long if large Clipboard) before refreshing the menu with Critical On
	; parse Clipboard for folder, document or application filenames (filenames alone on one line)
	Loop, parse, Clipboard, `n, `r%A_Space%%A_Tab%/?:*`"><|
	{
		strClipboardLineExpanded := A_LoopField ; only for FileExistInPath - will not be displayed in menu

		if FileExistInPath(strClipboardLineExpanded) ; rerturn strClipboardLineExpanded with expanded relative path and envvars, and search in PATH
		{
			; 1 Location/Menu name (for sorting), 2 Favorite Type, 3 Icon
			strContentsInClipboard .= "`n" . A_LoopField
			strClipboardContentType := (RecentLocationIsDocument(strClipboardLineExpanded, A_ThisLabel) ? "Document" : "Folder")
			strContentsInClipboard .= "`t" . strClipboardContentType
			if (o_Settings.MenuIcons.blnDisplayIcons.IniValue)
				strContentsInClipboard .= "`t" . (strClipboardContentType = "Document" ? GetIcon4Location(strClipboardLineExpanded) : "iconFolder")
		}

		; Parse Clipboard line for URLs (anywhere on the line)
		strURLSearchString := A_LoopField
		Gosub, GetURLsInClipboardLine
	}
}

; prepare data for new Container
saMenuItemsTable := Object()

if !StrLen(strContentsInClipboard)
{
	if !StrLen(Clipboard)
		strMenuName := o_L["MenuClipboardEmpty"]
	else if (StrLen(Clipboard) > o_Settings.MenuAdvanced.intClipboardMaxSize.IniValue)
		strMenuName := L(o_L["MenuClipboardTooLarge"], o_Settings.MenuAdvanced.intClipboardMaxSize.IniValue)
	else
		strMenuName := o_L["MenuClipboardNoContent"]
	
	saMenuItemsTable := [["DoNothing", strMenuName, "", "iconNoContent"]]
}
else
{
	Sort, strContentsInClipboard

	Loop, parse, strContentsInClipboard, `n
		if StrLen(A_LoopField)
		{
			saOneLine := StrSplit(A_LoopField, "`t") ; saOneLine[1] = path or URL, saOneLine[2] = favorite type, saOneLine[3] = icon (file,index or icon code)
			strFavoriteLocationSwap := saOneLine[1]
			saOneLine[1] := saOneLine[2] ; favorite type
			saOneLine[2] := strFavoriteLocationSwap ; name
			saOneLine[4] := saOneLine[3] ; icon
			saOneLine[3] := strFavoriteLocationSwap ; location
			saMenuItemsTable.Push(saOneLine)
		}
}

o_Containers.AA[o_L["MenuClipboard"]].LoadFavoritesFromTable(saMenuItemsTable)
o_Containers.AA[o_L["MenuClipboard"]].BuildMenu()

strContentsInClipboard := ""
strClipboardLineExpanded := ""
strURLSearchString := ""
saOneLine := ""
saMenuItemsTable := ""
strFavoriteLocationSwap := ""

Diag(A_ThisLabel, "", "STOP")
return
;------------------------------------------------------------


;------------------------------------------------------------
GetURLsInClipboardLine:
;------------------------------------------------------------
; Adapted from AHK help file: http://ahkscript.org/docs/commands/LoopReadFile.htm
; It's done this particular way because some URLs have other URLs embedded inside them:
StringGetPos, intURLStart1, strURLSearchString, http://
StringGetPos, intURLStart2, strURLSearchString, https://
StringGetPos, intURLStart3, strURLSearchString, www.

; Find the left-most starting position:
intURLStart := intURLStart1 ; Set starting default.
Loop
{
	; It helps performance (at least in a script with many variables) to resolve
	; "intURLStart%A_Index%" only once:
	intArrayElement := intURLStart%A_Index%
	if (intArrayElement = "") ; End of the array has been reached.
		break
	if (intArrayElement = -1) ; This element is disqualified.
		continue
	if (intURLStart = -1)
		intURLStart := intArrayElement
	else ; intURLStart has a valid position in it, so compare it with intArrayElement.
	{
		if (intArrayElement <> -1)
			if (intArrayElement < intURLStart)
				intURLStart := intArrayElement
	}
}

if (intURLStart = -1) ; No URLs exist in strURLSearchString.
	return ; (exit loop without cleaning local variables that could be re-used)

; Otherwise, extract this strURL:
StringTrimLeft, strURL, strURLSearchString, %intURLStart% ; Omit the beginning/irrelevant part.
Loop, parse, strURL, %A_Tab%%A_Space%<> ; Find the first space, tab, or angle (if any).
{
	strURL := A_LoopField
	break ; i.e. perform only one loop iteration to fetch the first "field".
}
; If the above loop had zero iterations because there were no ending characters found,
; leave the contents of the strURL var untouched.

; If the strURL ends in a double quote, remove it.  For now, StrReplace() is used, but
; note that it seems that double quotes can legitimately exist inside URLs, so this
; might damage them:
strURLCleansed := StrReplace(strURL, """")

; See if there are any other URLs in this line:
StringLen, intCharactersToOmit, strURL
intCharactersToOmit += intURLStart
StringTrimLeft, strURLSearchString, strURLSearchString, %intCharactersToOmit%

Gosub, GetURLsInClipboardLine ; Recursive call to self (end of loop)

strContentsInClipboard .= "`n" . strURLCleansed . "`t" . "URL" . "`t" . g_strURLIconFileIndex

return
;------------------------------------------------------------


;------------------------------------------------------------
DrivesMenuShortcut:
;------------------------------------------------------------

SetWaitCursor(true)

Gosub, RefreshDrivesMenu

Gosub, SetMenuPosition
CoordMode, Menu, % (o_Settings.MenuPopup.intPopupMenuPosition.IniValue = 2 ? "Window" : "Screen")

SetWaitCursor(false)

Menu, % o_L["MenuDrives"], Show, %g_intMenuPosX%, %g_intMenuPosY%

return
;------------------------------------------------------------


;------------------------------------------------------------
RefreshDrivesMenu:
;------------------------------------------------------------

if !(o_QAPfeatures.aaQAPfeaturesInMenus.HasKey("{Drives}")) ; we don't have this QAP features in at least one menu
	return

Diag(A_ThisLabel, "", "START")

; prepare data source
if (g_blnUsageDbEnabled) ; use SQLite usage database
{
	strUsageDbSQL := "SELECT DrivesMenuData FROM zMetadata;"
	if !o_UsageDb.Query(strUsageDbSQL, o_MetadataRecordSet)
	{
		Diag(A_ThisLabel, "SQLite QUERY zMETADATA Error: " . strUsageDbSQL, "STOP")
		Oops("SQLite QUERY zMETADATA Error`n`nMessage: " . o_UsageDb.ErrorMsg . "`nCode: " . o_UsageDb.ErrorCode . "`nQuery: " . strUsageDbSQL)
	}
	o_MetadataRecordSet.Next(o_MetadataRow)
	g_strMenuItemsListDrives := o_MetadataRow[1] ; first (and only) field is PopularFoldersMenuData or PopularFilesMenuData
	o_MetadataRecordSet.Free()
}
else ; get data directly from Windows (with variable response time)
	gosub, GetDrivesMenuListRefresh ; update g_strMenuItemsListDrives

; prepare data for new Container
saMenuItemsTable := Object()
Loop, Parse, g_strMenuItemsListDrives, `n
	; g_strMenuItemsListDrives structure: 1 Menu, 2 Item Name, 3 Label Gosub, 4 Icon
	if StrLen(A_LoopField)
	{
		saOneLine := StrSplit(A_LoopField, "|")
		saOneLine[1] := "Folder" ; force FavoriteType to Folder
		; saOneLine[2] contain favorite name
		saOneLine[3] := SubStr(saOneLine[2], 1, 1) . ":\" ; forge FavoriteLocation from name
		; saOneLine[4] contain favorite icon
		saMenuItemsTable.Push(saOneLine)
	}

o_Containers.AA[o_L["MenuDrives"]].LoadFavoritesFromTable(saMenuItemsTable)
o_Containers.AA[o_L["MenuDrives"]].BuildMenu()

strUsageDbSQL := ""
o_MetadataRecordSet := ""
saOneLine := ""
saMenuItemsTable := ""

Diag(A_ThisLabel, "", "STOP")

return
;------------------------------------------------------------


;------------------------------------------------------------
RecentFoldersMenuShortcut:
RecentFilesMenuShortcut:
;------------------------------------------------------------

SetWaitCursor(true)

Gosub, RefreshRecentItemsMenus

Gosub, SetMenuPosition
CoordMode, Menu, % (o_Settings.MenuPopup.intPopupMenuPosition.IniValue = 2 ? "Window" : "Screen")

SetWaitCursor(false)

Menu, % (A_ThisLabel = "RecentFoldersMenuShortcut" ? o_L["MenuRecentFolders"] : o_L["MenuRecentFiles"]), Show, %g_intMenuPosX%, %g_intMenuPosY%

return
;------------------------------------------------------------


;------------------------------------------------------------
RefreshRecentItemsMenus: ; attached, refresh both {Recent Folders} and {Recent Files} if one is present in menu
;------------------------------------------------------------

if !o_QAPfeatures.aaQAPfeaturesInMenus.HasKey("{Recent Folders}") and !o_QAPfeatures.aaQAPfeaturesInMenus.HasKey("{Recent Files}")
	; we don't have Recent Folders or Recent Files QAP features in at least one menu
	return

Diag(A_ThisLabel, "", "START")

; prepare data source

if (g_blnUsageDbEnabled) ; use SQLite usage database
	Loop, Parse, % "Folders|Files", |
	{
		if (o_QAPfeatures.aaQAPfeaturesInMenus.HasKey("{Recent " . A_LoopField . "}")) ; {Recent Folders} or {Recent Files}
		{
			strUsageDbSQL := "SELECT Recent" . A_LoopField . "MenuData FROM zMetadata;" ; RecentFoldersMenuData and RecentFilesMenuData
			if !o_UsageDb.Query(strUsageDbSQL, o_MetadataRecordSet)
			{
				Diag(A_ThisLabel, "SQLite QUERY zMETADATA Error: " . strUsageDbSQL, "STOP")
				Oops("SQLite QUERY zMETADATA Error`n`nMessage: " . o_UsageDb.ErrorMsg . "`nCode: " . o_UsageDb.ErrorCode . "`nQuery: " . strUsageDbSQL)
			}
			o_MetadataRecordSet.Next(o_MetadataRow)
			g_strMenuItemsListRecent%A_LoopField% := o_MetadataRow[1] ; g_strMenuItemsListRecentFolders and g_strMenuItemsListRecentFiles
			o_MetadataRecordSet.Free()
		}
	}
else ; get data directly from Windows (with variable response time)
	gosub, GetMenusListRecentItemsRefresh ; update g_strMenuItemsListRecentFolders and g_strMenuItemsListRecentFiles

Loop, Parse, % "Folders|Files", |
	if (o_QAPfeatures.aaQAPfeaturesInMenus.HasKey("{Recent " . A_LoopField . "}")) ; {Recent Folders} and {Recent Files}
	{
		strFoldersOrFiles := A_LoopField
		saMenuItemsTable := Object()
		Loop, Parse, g_strMenuItemsListRecent%strFoldersOrFiles%, `n ; g_strMenuItemsListRecentFolders and g_strMenuItemsListRecentFiles
			if StrLen(A_LoopField)
			{
				; transform 1)Recent Folders/Files|2)MenuName|3)FavoriteType|4)Icon
				; to 1)Type|2)MenuName|3)Location|4)Icon
				saOneLine := StrSplit(A_LoopField, "|") 
				saOneLine[1] := saOneLine[3] ; FavoriteType
				saOneLine[3] := saOneLine[2] ; duplicate name 2 in location 3
				saOneLine[2] := StrReplace(saOneLine[2], "&", "&&") ; double ampersands in menu name
				; keep icon in 4
				saMenuItemsTable.Push(saOneLine)
			}
		
		o_Containers.AA[o_L["MenuRecent" . strFoldersOrFiles]].LoadFavoritesFromTable(saMenuItemsTable)
		o_Containers.AA[o_L["MenuRecent" . strFoldersOrFiles]].BuildMenu()
	}

g_strMenuItemsListRecentFolders := ""
g_strMenuItemsListRecentFiles := ""

Diag(A_ThisLabel, "", "STOP")
return
;------------------------------------------------------------


;------------------------------------------------------------
ReopenFolderMenuShortcut:
;------------------------------------------------------------

SetWaitCursor(true)

Gosub, RefreshReopenFolderMenu

Gosub, SetMenuPosition
CoordMode, Menu, % (o_Settings.MenuPopup.intPopupMenuPosition.IniValue = 2 ? "Window" : "Screen")

SetWaitCursor(false)

Menu, % o_L["MenuCurrentFolders"], Show, %g_intMenuPosX%, %g_intMenuPosY%

return
;------------------------------------------------------------


;------------------------------------------------------------
RepeatLastActionsShortcut:
;------------------------------------------------------------

SetWaitCursor(true)

Gosub, RefreshLastActionsMenu

Gosub, SetMenuPosition
CoordMode, Menu, % (o_Settings.MenuPopup.intPopupMenuPosition.IniValue = 2 ? "Window" : "Screen")

SetWaitCursor(false)

Menu, % o_L["MenuLastActions"], Show, %g_intMenuPosX%, %g_intMenuPosY%

return
;------------------------------------------------------------


;------------------------------------------------------------
SwitchFolderOrAppMenuShortcut:
;------------------------------------------------------------

SetWaitCursor(true)

Gosub, RefreshSwitchFolderOrAppMenu

Gosub, SetMenuPosition
CoordMode, Menu, % (o_Settings.MenuPopup.intPopupMenuPosition.IniValue = 2 ? "Window" : "Screen")

SetWaitCursor(false)

Menu, % o_L["MenuSwitchFolderOrApp"], Show, %g_intMenuPosX%, %g_intMenuPosY%

return
;------------------------------------------------------------


;------------------------------------------------------------
RefreshSwitchFolderOrAppMenu:
RefreshReopenFolderMenu:
; This command build two menus: "Reopen a Folder" and "Switch".
; The first part of "Switch" has the same items as "Reopen a Folder" but with the OpenSwitchFolderOrApp command instead of "OpenFavorite".
;------------------------------------------------------------

if !(o_QAPfeatures.aaQAPfeaturesInMenus.HasKey("{Current Folders}") or o_QAPfeatures.aaQAPfeaturesInMenus.HasKey("{Switch Folder or App}"))
	; we don't have one of these QAP features in at least one menu
	return

Diag(A_ThisLabel, "", "START")

; Gather Explorer and DOpus windows/listers

if (o_FileManagers.P_intActiveFileManager = 2) ; DirectoryOpus
{
	Gosub, RefreshDOpusListersListText
	saDOpusListers := CollectDOpusListersList(g_strDOpusListText) ; list all listers, excluding special folders like Recycle Bin
}

saExplorersWindows := CollectExplorers(ComObjCreate("Shell.Application").Windows)

; Process Explorer windows, DOpus listers and applications windows and add it to saFoldersAndAppsList

saFoldersAndAppsList := Object()

intWindowsIdIndex := 0
blnWeHaveFolders := false

; Process DOpus listers

if (o_FileManagers.P_intActiveFileManager = 2) ; DirectoryOpus
	for intIndex, aaLister in saDOpusListers
	{
		; if we have no path or a DOpus collection, skip it
		if !StrLen(aaLister.strLocationURL) or InStr(aaLister.strLocationURL, "coll://")
			continue
		
		if NameIsInObject(aaLister.strName, saFoldersAndAppsList)
			continue
		
		intWindowsIdIndex++
		blnWeHaveFolders := true
		aaFolderOrApp := Object()
		aaFolderOrApp.strLocationURL := aaLister.strLocationURL
		aaFolderOrApp.strName := aaLister.strName
		aaFolderOrApp.strWindowId := aaLister.strLister
		aaFolderOrApp.strWindowType := "DO"
		
		saFoldersAndAppsList.Push(aaFolderOrApp)
	}

; Process Explorer windows

for intIndex, aaFolder in saExplorersWindows
{
	; if we have no path, skip it
	if !StrLen(aaFolder.strLocationURL)
		continue
		
	if NameIsInObject(aaFolder.strLocationName, saFoldersAndAppsList)
		continue
	
	intWindowsIdIndex++
	blnWeHaveFolders := true
	aaFolderOrApp := Object()
	aaFolderOrApp.strLocationURL := aaFolder.strLocationURL
	aaFolderOrApp.strName := aaFolder.strLocationName
	aaFolderOrApp.strWindowId := aaFolder.strWindowId
	aaFolderOrApp.strWindowType := "EX"

	saFoldersAndAppsList.Push(aaFolderOrApp)
}

if (A_ThisLabel <> "RefreshReopenFolderMenu")
	and o_QAPfeatures.aaQAPfeaturesInMenus.HasKey("{Switch Folder or App}") ; we have this QAP features in at least one menu
{
	; Insert a menu separator

	if (blnWeHaveFolders)
	{
		intWindowsIdIndex++
		aaFolderOrApp := Object() ; empty for menu separator
		saFoldersAndAppsList.Push(aaFolderOrApp)
	}

	; Gather and process running applications

	DetectHiddenWindows, Off
	WinGet, strWinIDs, List	; Retrieve IDs of all the existing windows
	DetectHiddenWindows, On ; revert to app default

	Loop, %strWinIDs%
	{
		If KeepThisWindow(A_Index, strWinIDs%A_Index%, "Current Windows menu", objWindowProperties)
		{
			intWindowsIdIndex++
			aaFolderOrApp := Object()
			aaFolderOrApp.strName := objWindowProperties.WindowTitle
			aaFolderOrApp.strLocationURL := objWindowProperties.ProcessPath
			aaFolderOrApp.strWindowId := strWinIDs%A_Index%
			aaFolderOrApp.strWindowType := "APP"

			saFoldersAndAppsList.Push(aaFolderOrApp)
		}
	}
	
	; simple array object used to pass data to MenuBuild for MenuSwitchFolderOrApp menu
	saSwitchFolderOrAppTable := Object()
}

; Build menu

; ### g_aaReopenFolderLocationUrlByName: replaced by menu o_Containers.AA[o_L["MenuCurrentFolders"]]

Critical, On
saCurrentFoldersTable := Object()

if (intWindowsIdIndex)
{
	for intIndex, aaFolderOrApp in saFoldersAndAppsList
	{
		if !StrLen(aaFolderOrApp.strName)
			saSwitchFolderOrAppTable.Push(["X"]) ; menu separator
		else
		{
			strMenuName := aaFolderOrApp.strName
			strFolderLocationUrl := aaFolderOrApp.strLocationURL
			if (aaFolderOrApp.strWindowType <> "APP") and !InStr(strMenuName, "ftp:")
				strFolderIcon := GetFolderIcon(aaFolderOrApp.strLocationURL)
			if (aaFolderOrApp.strWindowType <> "APP")
				; and !InStr(strMenuName, "ftp:") ; test if we can support reopen for FTP sites (Explorer reports "ftp:\\" DOpus "ftp://")
			{
				If (InStr(strMenuName, "::") = 1) ; A_ThisMenuItem can include the numeric shortcut
				{
					strMenuName := SubStr(strMenuName, 3) ; remove "::" from beginning
					strFavoriteType := "Special"
				}
				else if InStr(strMenuName, "ftp:") ; ftp:// with DOpus listers , is it working with Explorer ftp:\\ ?
					strFavoriteType := "FTP"
				else
					strFavoriteType := "Folder"
				; g_aaReopenFolderLocationUrlByName[strMenuName] := aaFolderOrApp.strLocationURL) ; replaced by menu o_Containers.AA[o_L["MenuCurrentFolders"]]
				saCurrentFoldersTable.Push([strFavoriteType, strMenuName, strMenuName, strFolderIcon]) ; insert strMenuName as location because it is decoded
			}
			saSwitchFolderOrAppTable.Push(["OpenSwitchFolderOrApp", strMenuName, aaFolderOrApp.strWindowType . "|" . aaFolderOrApp.strWindowId
				, (aaFolderOrApp.strWindowType = "EX" ? strFolderIcon
					: (aaFolderOrApp.strWindowType = "DO" ? (strFolderIcon = "iconFolder" ? g_aaFileManagerDirectoryOpus.strDirectoryOpusRtPath . ",1" : strFolderIcon)
					: aaFolderOrApp.strLocationURL . ",1"))])
		}
	}
}
else
	saSwitchFolderOrAppTable.Push(["GuiShowNeverCalled", o_L["MenuNoCurrentFolder"], "", "iconNoContent"])

if !(blnWeHaveFolders)
	saCurrentFoldersTable.Push(["GuiShowNeverCalled", o_L["MenuNoCurrentFolder"], "", "iconNoContent"])

if (A_ThisLabel <> "RefreshReopenFolderMenu")
	and o_QAPfeatures.aaQAPfeaturesInMenus.HasKey("{Switch Folder or App}") ; we have this QAP features in at least one menu
{
	o_Containers.AA[o_L["MenuSwitchFolderOrApp"]].LoadFavoritesFromTable(saSwitchFolderOrAppTable)
	o_Containers.AA[o_L["MenuSwitchFolderOrApp"]].BuildMenu()
}

o_Containers.AA[o_L["MenuCurrentFolders"]].LoadFavoritesFromTable(saCurrentFoldersTable)
o_Containers.AA[o_L["MenuCurrentFolders"]].BuildMenu()

Critical, Off

saDOpusListers := ""
saExplorersWindows := ""
aaFolderOrApp := ""
saFoldersAndAppsList := ""
intIndex := ""
aaLister := ""
objFolder := ""
strMenuName := ""
intWindowsIdIndex := ""
strWinIDs := ""
strProcessPath := ""
strWindowTitle := ""
strWindowClass := ""
strDiagFile := ""
intExStyle := ""
strWinTitlesWinApps := ""
strFolderIcon := ""
strFavoriteType := ""

Diag(A_ThisLabel, "", "STOP")
return
;------------------------------------------------------------


;------------------------------------------------------------
RefreshDOpusListersListText:
RefreshDOpusSelectedListText:
;------------------------------------------------------------

strDOpusTempFile := g_strTempDir .  "\dopus-" . (A_ThisLabel = "RefreshDOpusListersListText" ? "listers" : "selected") . "-list.txt"

FileDelete, %strDOpusTempFile%
o_FileManagers.SA[2].RunDOpusRt("/info", strDOpusTempFile, "," . (A_ThisLabel = "RefreshDOpusListersListText" ? "paths" : "listsel")) ; list opened listers or selected files in a text file
loop, 10
	if FileExist(strDOpusTempFile)
		Break
	else
		Sleep, 50 ; was 10 and had some gliches with FP - is 50 enough?

if (A_ThisLabel = "RefreshDOpusListersListText")
	FileRead, g_strDOpusListText, %strDOpusTempFile%
else ; RefreshDOpusSelectedListText
	FileRead, g_strDOpusSelectedListText, %strDOpusTempFile%
	
strDOpusTempFile := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
CollectDOpusListersList(strList)
; list all DirectoryOpus listers, excluding special folders like Recycle Bin, Network because they are not included in dopus-list.txt
;------------------------------------------------------------
{
	saListers := Object()
	
	strList := SubStr(strList, InStr(strList, "<path"))
	Loop
	{
		aaLister := Object()
		
		strList := SubStr(strList, InStr(strList, "<path"))
		strSubStr := SubStr(strList, InStr(strList, "<path"))
		strSubStr := SubStr(strSubStr, 1, InStr(strSubStr, "</path>") - 1)
		
		if (StrLen(strSubStr))
		{
			aaLister.strActivelister := ParseDOpusListerProperty(strSubStr, "active_lister")
			aaLister.strActiveTab := ParseDOpusListerProperty(strSubStr, "active_tab")
			aaLister.strLister := ParseDOpusListerProperty(strSubStr, "lister")
			aaLister.strSide := ParseDOpusListerProperty(strSubStr, "side")
			aaLister.strTab := ParseDOpusListerProperty(strSubStr, "tab")
			aaLister.strTabState := ParseDOpusListerProperty(strSubStr, "tab_state")
			aaLister.strLocationURL := SubStr(strSubStr, InStr(strSubStr, ">") + 1)
			
			aaLister.strName := ComUnHTML(aaLister.strLocationURL) ; convert HTML entities to text (like "&apos;")
			
			WinGetPos, intX, intY, intW, intH, % "ahk_id " . aaLister.strLister
			aaLister.strPosition := intX . "|" . intY . "|" . intW . "|" . intH
			WinGet, intMinMax, MinMax, % "ahk_id " . aaLister.strLister
			aaLister.intMinMax := intMinMax
			
			; if !InStr(aaLister.strLocationURL, "ftp://") - removed in v6.0.6 - FTP from DOpus now supported
				; Swith Explorer to DOpus FTP folder not supported (see https://github.com/JnLlnd/FoldersPopup/issues/84)
				
			saListers.Push(aaLister)
			
			strList := SubStr(strList, StrLen(strSubStr))
		}
	} until	(!StrLen(strSubStr))

	return saListers
}
;------------------------------------------------------------


;------------------------------------------------------------
ParseDOpusListerProperty(strSource, strProperty)
;------------------------------------------------------------
{
	intStartPos := InStr(strSource, " " . strProperty . "=")
	if !(intStartPos)
		return ""
	strSource := SubStr(strSource, intStartPos + StrLen(strProperty) + 3)
	intEndPos := InStr(strSource, """")
	
	return SubStr(strSource, 1, intEndPos - 1)
}
;------------------------------------------------------------


;------------------------------------------------------------
CollectExplorers(pExplorers)
;------------------------------------------------------------
{
	saExplorers := Object()
	intExplorers := 0
	
	For pExplorer in pExplorers
	; see http://msdn.microsoft.com/en-us/library/windows/desktop/aa752084(v=vs.85).aspx
	{
		/* in v.3.9.8: stop interupting Explorer collection if an error occurs - just check for content and continue
		if (A_LastError)
			; an error occurred during ComObjCreate (A_LastError probably is E_UNEXPECTED = -2147418113 #0x8000FFFFL)
			break
		*/

		strType := ""
		try strType := pExplorer.Type ; Gets the type name of the contained document object. "Document HTML" for IE windows. Should be empty for file Explorer windows.
		strWindowID := ""
		try strWindowID := pExplorer.HWND ; Try to get the handle of the window. Some ghost Explorer in the ComObjCreate may return an empty handle
		
		if !StrLen(strType) ; must be empty
			and StrLen(strWindowID) ; must not be empty
		{
			intExplorers++
			aaExplorer := Object()
			aaExplorer.strPosition := pExplorer.Left . "|" . pExplorer.Top . "|" . pExplorer.Width . "|" . pExplorer.Height

			aaExplorer.blnIsSpecialFolder := !StrLen(pExplorer.LocationURL) ; empty for special folders like Recycle bin
			
			if (aaExplorer.blnIsSpecialFolder)
			{
				aaExplorer.strLocationURL := pExplorer.Document.Folder.Self.Path
				aaExplorer.strLocationName := pExplorer.LocationName ; see http://msdn.microsoft.com/en-us/library/aa752084#properties
			}
			else
			{
				aaExplorer.strLocationURL := pExplorer.LocationURL
				aaExplorer.strLocationName :=  ProcessLocationURL(UriDecode(pExplorer.LocationURL))
			}
			
			aaExplorer.strWindowId := strWindowID ; not used for Explorer windows, but keep it
			WinGet, intMinMax, MinMax, % "ahk_id " . pExplorer.HWND
			aaExplorer.intMinMax := intMinMax
			
			saExplorers.Push(aaExplorer) ; I was checking if StrLen(pExplorer.HWND) - any reason?
		}
	}
	
	return saExplorers
}
;------------------------------------------------------------


;------------------------------------------------------------
TotalCommanderHotlistMenuShortcut:
;------------------------------------------------------------

SetWaitCursor(true)

Gosub, RefreshTotalCommanderHotlist

Gosub, SetMenuPosition
CoordMode, Menu, % (o_Settings.MenuPopup.intPopupMenuPosition.IniValue = 2 ? "Window" : "Screen")

SetWaitCursor(false)

Menu, % o_L["TCMenuName"], Show, %g_intMenuPosX%, %g_intMenuPosY%

return
;------------------------------------------------------------


;------------------------------------------------------------
RefreshTotalCommanderHotlist:
RefreshTotalCommanderHotlistScheduled:
;------------------------------------------------------------

if !o_QAPfeatures.aaQAPfeaturesInMenus.HasKey("{TC Directory hotlist}")
    ; we don't have this QAP featuree in at least one menu
    return

Diag(A_ThisLabel, "", "START")

; Init TC Directory hotlist if wincmd.ini file exists

If o_FileManagers.SA[3].TotalCommanderWinCmdIniFileExist() ; TotalCommander settings file exists
{
	o_Containers.AA[o_L["TCMenuName"]].LoadTCFavoritesFromIniFile(g_aaFileManagerTotalCommander.strTCIniFileExpanded) ; RECURSIVE
	o_Containers.AA[o_L["TCMenuName"]].BuildMenu() ; recurse for submenus
	ToolTip
}

Diag(A_ThisLabel, "", "STOP")
return
;------------------------------------------------------------


;------------------------------------------------------------
DirectoryOpusFavoritesMenuShortcut:
;------------------------------------------------------------

SetWaitCursor(true)

Gosub, RefreshDirectoryOpusFavorites

Gosub, SetMenuPosition
CoordMode, Menu, % (o_Settings.MenuPopup.intPopupMenuPosition.IniValue = 2 ? "Window" : "Screen")

SetWaitCursor(false)

Menu, % o_L["DOpusMenuName"], Show, %g_intMenuPosX%, %g_intMenuPosY%

return
;------------------------------------------------------------


;------------------------------------------------------------
RefreshDirectoryOpusFavorites:
RefreshDirectoryOpusFavoritesScheduled:
;------------------------------------------------------------

if !o_QAPfeatures.aaQAPfeaturesInMenus.HasKey("{DOpus Favorites}")
	; we don't have this QAP features in at least one menu
	return

Diag(A_ThisLabel, "", "START")

If o_FileManagers.SA[2].DirectoryOpusFavoritesFileExist() ; Directory Opus favorites file exists
{
	global xmlDirectoryOpusXML := New XML("xml")
	o_Containers.AA[o_L["DOpusMenuName"]].LoadDirectoryOpusFavoritesFromXML() ; RECURSIVE
	
	if (g_aaFileManagerDirectoryOpus.blnFileManagerDirectoryOpusShowLayouts and o_FileManagers.SA[2].DirectoryOpusLayoutsFileExist())
	{
		o_Containers.AA[o_L["DOpusLayoutsName"]].LoadDirectoryOpusLayoutsFromXML()
		o_Containers.AA[o_L["DOpusLayoutsName"]].BuildMenu() ; recurse for submenus
		
		oNewItem := new Container.Item(["X"], o_Containers.AA[o_L["DOpusLayoutsName"]]) ; separator
		o_Containers.AA[o_L["DOpusMenuName"]].SA.Push(oNewItem) ; add to the current container object
		oNewItem := new Container.Item(["Menu", o_L["DOpusLayoutsName"]], o_Containers.AA[o_L["DOpusLayoutsName"]]) ; Layouts menu
		oNewItem.AA.oSubMenu := o_Containers.AA[o_L["DOpusLayoutsName"]] ; attach menu
		o_Containers.AA[o_L["DOpusMenuName"]].SA.Push(oNewItem) ; add to the current container object
	}
	
	o_Containers.AA[o_L["DOpusMenuName"]].BuildMenu() ; recurse for submenus
	ToolTip
}
else
	o_Containers.AA[o_L["DOpusMenuName"]].AddMenuIcon(o_L["DialogNone"], "GuiShowNeverCalled", "iconNoContent", false) ; will never be called because disabled

oNewItem := ""

Diag(A_ThisLabel, "", "STOP")
return
;------------------------------------------------------------


;-----------------------------------------------------------
LastActionShortcut:
;-----------------------------------------------------------

Gosub, SetMenuPosition

Gosub, RefreshLastActionsMenu

CoordMode, Menu, % (o_Settings.MenuPopup.intPopupMenuPosition.IniValue = 2 ? "Window" : "Screen")
Menu, % o_L["MenuLastActions"], Show, %g_intMenuPosX%, %g_intMenuPosY%

return
;-----------------------------------------------------------


;------------------------------------------------------------
RefreshLastActionsMenu:
;------------------------------------------------------------

if !(o_QAPfeatures.aaQAPfeaturesInMenus.HasKey("{Last Actions}")) ; we don't have this QAP features in at least one menu
	or !StrLen(g_strLastActionsOrderedKeys) ; we don't have actions to repeat
	return

Diag(A_ThisLabel, "", "START")

; prepare data for new Container
saMenuItemsTable := Object()
Loop, Parse, g_strLastActionsOrderedKeys, `n
	if StrLen(A_LoopField)
		saMenuItemsTable.Push(["RepeatLastAction", A_LoopField, A_LoopField, g_aaLastActions[A_LoopField].AA.strFavoriteIconResource])

o_Containers.AA[o_L["MenuLastActions"]].LoadFavoritesFromTable(saMenuItemsTable)
o_Containers.AA[o_L["MenuLastActions"]].BuildMenu()

saMenuItemsTable := ""

Diag(A_ThisLabel, "", "STOP")
return
;------------------------------------------------------------


;------------------------------------------------------------
BuildAlternativeMenu:
;------------------------------------------------------------

new Container("Menu", "menuAlternative")

saMenuItemsTable := Object()
Loop
	if o_QAPfeatures.saQAPFeaturesAlternativeCodeByOrder.Haskey(A_Index)
	{
		strMenuName := o_QAPfeatures.AA[o_QAPfeatures.saQAPFeaturesAlternativeCodeByOrder[A_Index]].strLocalizedName ; .strLocalizedName OK because Alternative
		strMenuName .= MenuNameReminder(o_QAPfeatures.AA[o_QAPfeatures.saQAPFeaturesAlternativeCodeByOrder[A_Index]].strCurrentHotkey)
		; hotkey reminder "`t..." or " (...)" will be removed from A_ThisMenuItem in order to flag what alternative menu feature has been activated
		saMenuItemsTable.Push(["OpenAlternativeMenu", strMenuName, o_QAPfeatures.saQAPFeaturesAlternativeCodeByOrder[A_Index]
			, o_QAPfeatures.AA[o_QAPfeatures.saQAPFeaturesAlternativeCodeByOrder[A_Index]].strDefaultIcon])
	}
	else
		if o_QAPfeatures.saQAPFeaturesAlternativeCodeByOrder.Haskey(A_Index + 1) ; there is another menu item, add a menu separator
			Menu, menuAlternative, Add
		else
			break ; menu finished

o_Containers.AA["menuAlternative"].LoadFavoritesFromTable(saMenuItemsTable)
o_Containers.AA["menuAlternative"].BuildMenu()

strMenuName := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
BuildMainMenu:
BuildMainMenuWithStatus:
BuildMainMenuScheduled:
;------------------------------------------------------------

Menu, % o_L["MainMenuName"], Add
Menu, % o_L["MainMenuName"], DeleteAll
if (g_blnUseColors)
	Menu, % o_L["MainMenuName"], Color, %g_strMenuBackgroundColor%

; disable (turn off) existing hotstrings in g_dicItemsByHotstring (if any) before updating them
gosub, DisableHotstrings
g_dicItemsByHotstring := ComObjCreate("Scripting.Dictionary") ; reset object, using Scripting.Dictionary instead of Object() to support case sensitive keys

; disable shortcuts and re-init shortcuts objects before rebuilding menu
gosub, DisableShortcuts ; turn off all favorites keyboard and mouse hotkeys
g_aaItemsByShortcut := Object()
g_aaItemsByShortcutToRemoveWhenBuildingMenu := Object()

global g_intNbLiveFolderItems := 0 ; number of items added to live folders (vs maximum set in ini file)
; RecursiveBuildOneMenu(g_objMainMenu) ; recurse for submenus
o_MainMenu.BuildMenu(A_ThisLabel = "BuildMainMenuWithStatus") ; recurse for submenus
if (A_ThisLabel = "BuildMainMenuWithStatus")
	ToolTip

return
;------------------------------------------------------------


;------------------------------------------------------------
LiveFolderHasContent(o_LiveFolder)
;------------------------------------------------------------
{
;	###_O(o_LiveFolder.AA.strFavoriteLocation, objLiveFolder)
	strExpandedLocation := PathCombine(A_WorkingDir, EnvVars(o_LiveFolder.AA.strFavoriteLocation))
	if (o_LiveFolder.AA.blnFavoriteFolderLiveDocuments)
	{
		Loop, Files, %strExpandedLocation%\*.*, F ; files
		{
			if !StrLen(o_LiveFolder.AA.strFavoriteFolderLiveExtensions) ; include all
				or (o_LiveFolder.AA.blnFavoriteFolderLiveIncludeExclude and StrLen(A_LoopFileExt) and InStr(o_LiveFolder.AA.strFavoriteFolderLiveExtensions, A_LoopFileExt)) ; include 
				or (!o_LiveFolder.AA.blnFavoriteFolderLiveIncludeExclude and !InStr(o_LiveFolder.AA.strFavoriteFolderLiveExtensions, A_LoopFileExt)) ; exclude 
			{
			;	###_V("YES DOCUMENT", A_LoopFileFullPath)
				return true
			}
		}
	;	###_D("No document")
	}
	Loop, Files, %strExpandedLocation%\*.*, D ; directories
	{
	;	###_V("YES FOLDER", A_LoopFileFullPath)
		return true
	}
;	###_D("No folder")
	
	return false
}
;------------------------------------------------------------


;------------------------------------------------------------
GetMenuHandle(strMenuName)
; from MenuIcons v2 by Lexikos
; http://www.autohotkey.com/board/topic/20253-menu-icons-v2/
;------------------------------------------------------------
{
	static s_pMenuDummy
	
	; v2.2: Check for !s_pMenuDummy instead of s_pMenuDummy="" in case init failed last time.
	If !s_pMenuDummy
	{
		Menu, menuDummy, Add
		Menu, menuDummy, DeleteAll
		
		Gui, 99:Menu, menuDummy
		; v2.2: Use LastFound method instead of window title. [Thanks animeaime.]
		Gui, 99:+LastFound
		
		s_pMenuDummy := DllCall("GetMenu", "uint", WinExist())
		
		Gui, 99:Menu
		Gui, 99:Destroy
		
		; v2.2: Return only after cleaning up. [Thanks animeaime.]
		if !s_pMenuDummy
			return 0
	}

	Menu, menuDummy, Add, :%strMenuName%
	pMenu := DllCall( "GetSubMenu", "uint", s_pMenuDummy, "int", 0 )
	DllCall( "RemoveMenu", "uint", s_pMenuDummy, "uint", 0, "uint", 0x400 )
	Menu, menuDummy, Delete, :%strMenuName%

	return pMenu
}
;------------------------------------------------------------


;------------------------------------------------------------
RefreshQAPMenu:
RefreshQAPMenuScheduled:
RefreshQAPMenuExternalOnly:
;------------------------------------------------------------

if (SettingsUnsaved() or !g_blnMenuReady ; these two required
	or (g_blnRefreshQAPMenuInProgress)
	or g_blnChangeShortcutInProgress or g_blnChangeHotstringInProgress) ; these two by safety (required?)
	return

Diag(A_ThisLabel, "", "START-REFRESH")

if (o_Settings.MenuAdvanced.blnRefreshQAPMenuDebugBeep.IniValue)
	SoundBeep, 330

g_blnMenuReady := false
g_blnRefreshQAPMenuInProgress := true

for strMenuName, o_ThisContainer in o_Containers.AA
	if (o_ThisContainer.AA.strMenuType = "External") and o_ThisContainer.ExternalMenuModifiedSinceLoaded() ; refresh only if changed
	{
		o_ThisContainer.LoadFavoritesFromIniFile(false, true) ; true for Refresh External
		o_ThisContainer.BuildMenu()
	}

if (A_ThisLabel <> "RefreshQAPMenuExternalOnly")
	if (A_ThisLabel = "RefreshQAPMenuScheduled")
	{
		Gosub, RefreshTotalCommanderHotlistScheduled
		Gosub, RefreshDirectoryOpusFavoritesScheduled
		Gosub, BuildMainMenuScheduled
	}
	else
	{
		Gosub, RefreshTotalCommanderHotlist
		Gosub, RefreshDirectoryOpusFavorites
		Gosub, BuildMainMenuWithStatus ; only here we load hotkeys, when user save favorites
	}

g_blnMenuReady := true
g_blnRefreshQAPMenuInProgress := false

if (o_Settings.MenuAdvanced.blnRefreshQAPMenuDebugBeep.IniValue)
	SoundBeep, 440

Diag(A_ThisLabel, "", "STOP-REFRESH")
return
;------------------------------------------------------------


;------------------------------------------------------------
DisableShortcuts:
;------------------------------------------------------------

for strShortcut in g_aaItemsByShortcut
	Hotkey, %strShortcut%, , Off, UseErrorLevel ; do nothing if error (probably because default hotkey not supported by keyboard)

for strShortcut in g_aaItemsByShortcutToRemoveWhenBuildingMenu
	Hotkey, %strShortcut%, , Off, UseErrorLevel ; do nothing if error (probably because default hotkey not supported by keyboard)

strShortcut := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
DisableHotstrings:
;------------------------------------------------------------

; before disabling an hotstring:
; in hotstring options: insert "X" (Execute) option g_strHotstringOptionsExecute (PrepareHotstringForFunction)
; set the label "OpenFavoriteFromHotstring" for hotstrings with Execute option
for strHotstring in g_dicItemsByHotstring
	Hotstring(PrepareHotstringForFunction(strHotstring, g_dicItemsByHotstring.Item(strHotstring)), "OpenFavoriteFromHotstring", "Off")

return
;------------------------------------------------------------



;========================================================================================================================
; END OF BUILD
;========================================================================================================================



;========================================================================================================================
!_025_OPTIONS:
;========================================================================================================================

;------------------------------------------------------------
GuiOptionsGroupGeneral:
GuiOptionsGroupSettingsWindow:
GuiOptionsGroupMenuIcons:
GuiOptionsGroupMenuAppearance:
GuiOptionsGroupPopupMenu:
GuiOptionsGroupPopupHotkeys:
GuiOptionsGroupPopupHotkeysAlternative:
GuiOptionsGroupFileManagers:
GuiOptionsGroupSnippets:
GuiOptionsGroupUserVariables:
GuiOptionsGroupDatabase:
GuiOptionsGroupMenuAdvanced:
GuiOptionsGroupAdvancedLaunch:
GuiOptionsGroupAdvancedOther:
;------------------------------------------------------------

g_strSettingsGroup := StrReplace(A_ThisLabel, "GuiOptionsGroup")

gosub, CheckShowSettings

aaL := o_L.InsertAmpersand(false, "OptionsGeneral", "OptionsSettingsWindow", "OptionsMenuIcons", "OptionsMenuAppearance", "OptionsPopupMenu"
	, "OptionsPopupHotkeys", "OptionsPopupHotkeysAlternative", "OptionsFileManagers", "OptionsSnippets", "OptionsUserVariables"
	, "OptionsDatabase", "OptionsMenuAdvanced", "OptionsAdvancedLaunch", "OptionsAdvancedOther", "GuiSave", "GuiCancel")

Gosub, GuiOptionsHeader

; === General ===

; LanguageCode
Gui, 2:Add, Text, y%intGroupItemsY% x%g_intGroupItemsX% w105 vf_lblLanguage hidden, % o_L["OptionsLanguage"]
Gui, 2:Add, DropDownList, yp x%g_intGroupItemsTab3X% w200 vf_drpLanguage Sort gGuiOptionsGroupChanged hidden, % o_L["OptionsLanguageLabels"]
GuiControl, ChooseString, f_drpLanguage, %g_strLanguageLabel%

; Theme
Gui, 2:Add, Text, y+10 x%g_intGroupItemsX% w105 vf_lblTheme hidden, % o_L["OptionsTheme"]
Gui, 2:Add, DropDownList, yp x%g_intGroupItemsTab3X% w200 vf_drpTheme gGuiOptionsGroupChanged hidden, % o_Settings.SettingsWindow.strAvailableThemes.IniValue
GuiControl, ChooseString, f_drpTheme, % o_Settings.Launch.strTheme.IniValue

; RunAtStartup
Gui, 2:Add, CheckBox, y+10 x%g_intGroupItemsTab3X% vf_blnOptionsRunAtStartup gGuiOptionsGroupChanged hidden, % o_L["OptionsRunAtStartup"]
if (g_blnPortableMode) ; get value from existence of startup file shortcut
	GuiControl, , f_blnOptionsRunAtStartup, % (FileExist(A_Startup . "\" . g_strAppNameFile . ".lnk") ? 1 : 0)
else ; setup mode, get value form current user registry
	GuiControl, , f_blnOptionsRunAtStartup, % (RegistryExist("HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run", g_strAppNameText) ? 1 : 0)

; DisplayTrayTip
Gui, 2:Add, CheckBox, y+10 x%g_intGroupItemsTab3X% vf_blnDisplayTrayTip gGuiOptionsGroupChanged hidden, % o_L["OptionsTrayTip"]
GuiControl, , f_blnDisplayTrayTip, % (o_Settings.Launch.blnDisplayTrayTip.IniValue = true)

; Check4Update
Gui, 2:Add, CheckBox, y+10 x%g_intGroupItemsTab3X% vf_blnCheck4Update gGuiOptionsGroupChanged hidden, % o_L["OptionsCheck4Update"]
GuiControl, , f_blnCheck4Update, % (o_Settings.Launch.blnCheck4Update.IniValue = true)
Gui, 2:Add, Link, yp x+1 gCheck4UpdateNow vf_lnkCheck4Update hidden, % "(<a>" . o_L["OptionsCheck4UpdateNow"] . "</a>)"

; ChangeFolderInDialog
Gui, 2:Add, CheckBox, y+10 x%g_intGroupItemsTab3X% vf_blnChangeFolderInDialog gChangeFoldersInDialogClicked hidden, % o_L["OptionsChangeFolderInDialog"]
GuiControl, , f_blnChangeFolderInDialog, % (o_Settings.MenuPopup.blnChangeFolderInDialog.IniValue = true)

; Working folder (only for Setup installation)
if (!g_blnPortableMode)
{
	Gui, 2:Add, Text, y+20 x%g_intGroupItemsX% w105 vf_lblWorkingFolder hidden, % o_L["OptionsWorkingFolder"] . ":"
	Gui, 2:Add, Edit, yp x%g_intGroupItemsTab3X% w300 h20 vf_strWorkingFolder hidden ; gLabel after GuiControl that changes the value below
	Gui, 2:Add, Button, x+5 yp w100 gButtonWorkingFolder vf_btnWorkingFolder hidden, % o_L["DialogBrowseButton"]
	GuiControl, 2:, f_strWorkingFolder, % GetRegistry("HKEY_CURRENT_USER\Software\Jean Lalonde\" . g_strAppNameText, "WorkingFolder")
	GuiControl, 2:+gGuiOptionsGroupChanged, f_strWorkingFolder
}

; BackupFolder
Gui, 2:Add, Text, y+20 x%g_intGroupItemsX% w105 vf_lblBackupFolder hidden, % o_L["OptionsBackupFolder"] . ":"
Gui, 2:Add, Edit, yp x%g_intGroupItemsTab3X% w300 h20 vf_strBackupFolder hidden ; gLabel after GuiControl that changes the value below
Gui, 2:Add, Button, x+5 yp w100 gButtonBackupFolder vf_btnBackupFolder hidden, % o_L["DialogBrowseButton"]
GuiControl, 2:, f_strBackupFolder, % o_Settings.SettingsFile.strBackupFolder.IniValue
GuiControl, 2:+gGuiOptionsGroupChanged, f_strBackupFolder

; QAPTempFolder
Gui, 2:Add, Text, y+20 x%g_intGroupItemsX% w105 vf_lblQAPTempFolderParentPath hidden, % o_L["OptionsQAPTempFolder"] . ":"
Gui, 2:Add, Edit, yp x%g_intGroupItemsTab3X% w300 h20 vf_strQAPTempFolderParentPath hidden ; gLabel after GuiControl that changes the value below
Gui, 2:Add, Button, x+5 yp w100 gButtonQAPTempFolderParentPath vf_btnQAPTempFolderParentPath hidden, % o_L["DialogBrowseButton"]
GuiControl, 2:, f_strQAPTempFolderParentPath, % o_Settings.Launch.strQAPTempFolderParent.IniValue
GuiControl, 2:+gGuiOptionsGroupChanged, f_strQAPTempFolderParentPath

GuiControlGet, arrPos, Pos, f_btnQAPTempFolderParentPath
if ((arrPosY + arrPosH) > g_intOptionsFooterY)
	g_intOptionsFooterY := arrPosY + arrPosH

; === SettingsWindow ===

; DisplaySettingsStartup
Gui, 2:Add, CheckBox, y%intGroupItemsY% x%g_intGroupItemsX% vf_blnDisplaySettingsStartup gGuiOptionsGroupChanged hidden, % o_L["OptionsSettingsStartup"]
GuiControl, , f_blnDisplaySettingsStartup, % (o_Settings.SettingsWindow.blnDisplaySettingsStartup.IniValue = true)

; RememberSettingsPosition
Gui, 2:Add, CheckBox, y+10 x%g_intGroupItemsX% w500 vf_blnRememberSettingsPosition gGuiOptionsGroupChanged hidden, % o_L["OptionsRememberSettingsPosition"]
GuiControl, , f_blnRememberSettingsPosition, % (o_Settings.SettingsWindow.blnRememberSettingsPosition.IniValue = true)

; OpenSettingsOnActiveMonitor
Gui, 2:Add, CheckBox, y+10 x%g_intGroupItemsX% w500 vf_blnOpenSettingsOnActiveMonitor gGuiOptionsGroupChanged hidden, % o_L["OptionsOpenSettingsOnActiveMonitor"]
GuiControl, , f_blnOpenSettingsOnActiveMonitor, % (o_Settings.SettingsWindow.blnOpenSettingsOnActiveMonitor.IniValue = true)

; AddAutoAtTop
Gui, 2:Add, Text, y+10 x%g_intGroupItemsX% w500 hidden vf_lblAddAutoAtTop, % o_L["OptionsAddAutoAtTop"]
Gui, 2:Add, Radio, % "y+5 x" . g_intGroupItemsX + 10 . " w500 vf_blnAddAutoAtTop0 Group gGuiOptionsGroupChanged hidden " . (o_Settings.SettingsWindow.blnAddAutoAtTop.IniValue ? "Checked" : ""), % o_L["OptionsAddAutoTopOfMenu"]
Gui, 2:Add, Radio, % "y+5 x" . g_intGroupItemsX + 10 . " w500 vf_blnAddAutoAtTop1 gGuiOptionsGroupChanged hidden " . (!o_Settings.SettingsWindow.blnAddAutoAtTop.IniValue ? "Checked" : ""), % o_L["OptionsAddAutoBottomOfMenu"]

GuiControlGet, arrPos, Pos, f_blnAddAutoAtTop1
if ((arrPosY + arrPosH) > g_intOptionsFooterY)
	g_intOptionsFooterY := arrPosY + arrPosH

; === MenuIcons ===

; DisplayIcons
Gui, 2:Add, CheckBox, y%intGroupItemsY% x%g_intGroupItemsX% w500 vf_blnDisplayIcons gDisplayIconsClicked hidden, % o_L["OptionsDisplayIcons"]
GuiControl, , f_blnDisplayIcons, % (o_Settings.MenuIcons.blnDisplayIcons.IniValue = true)

; IconSize
Gui, 2:Add, Text, y+10 x%g_intGroupItemsX% vf_lblIconSize Disabled hidden, % o_L["OptionsIconSize"]
Gui, 2:Add, DropDownList, yp x+10 w75 vf_drpIconSize Disabled hidden, 16|24|32|48|64 ; gLabel after Gosub that changes the value below
GuiControl, ChooseString, f_drpIconSize, % o_Settings.MenuIcons.intIconSize.IniValue
GuiControl, 2:+gGuiOptionsGroupChanged, f_drpIconSize

; IconsManageRows
Gui, 2:Add, Edit, % "y+10 x" . g_intGroupItemsX . " w51 h22 vf_intIconsManageRowsSettingsEdit number center hidden" . (o_Settings.MenuIcons.blnDisplayIcons.IniValue ? "" : "Disabled")
Gui, 2:Add, UpDown, vf_intIconsManageRowsSettings Range0-9999 gGuiOptionsGroupChanged hidden, % o_Settings.MenuIcons.intIconsManageRowsSettings.IniValue
Gui, 2:Add, Text, % "yp x+10 w400 hidden vf_lblIconsManageRows" . (o_Settings.MenuIcons.blnDisplayIcons.IniValue ? "" : " Disabled"), % o_L["OptionsIconsManageRows"]
GuiControl, 2:+gGuiOptionsGroupChanged, f_intIconsManageRowsSettingsEdit

; RetrieveIconInFrequentMenus
Gui, 2:Add, CheckBox, y+20 x%g_intGroupItemsX% w580 vf_blnRetrieveIconInFrequentMenus gGuiOptionsGroupChanged hidden, % o_L["OptionsIconsRetrieveInFrequentMenus"]
GuiControl, , f_blnRetrieveIconInFrequentMenus, % (o_Settings.MenuIcons.blnRetrieveIconInFrequentMenus.IniValue = true)
gosub, DisplayIconsClickedInit

; strIconReplacementList
Gui, 2:Font, s8 w700
Gui, 2:Add, Link, y+25 x%g_intGroupItemsX% w500 hidden vf_lnkIconReplacementList1
	, % o_L["OptionsIconReplacementList"] . " (<a href=""https://www.quickaccesspopup.com/can-i-replace-the-qap-standard-icons-with-my-own-custom-icons/"">" . o_L["GuiHelp"] . "</a>):"
Gui, 2:Font
Gui, 2:Add, Edit, y+10 x%g_intGroupItemsX% w500 r5 vf_strIconReplacementList gGuiOptionsGroupChanged hidden, % (StrLen(o_Settings.MenuIcons.strIconReplacementList.IniValue)
	? StrReplace(Trim(o_Settings.MenuIcons.strIconReplacementList.IniValue), "|", "`n") : "iconUnknown=" . o_JLicons.AA["iconUnknown"])
Gui, 2:Add, Link, x%g_intGroupItemsX% y+10 w500 hidden vf_lnkIconReplacementList2, % o_L["OptionsIconReplacementListInstructions"]

GuiControlGet, arrPos, Pos, f_lnkIconReplacementList2
if ((arrPosY + arrPosH) > g_intOptionsFooterY)
	g_intOptionsFooterY := arrPosY + arrPosH

; === MenuAppearance ===

; HotkeyReminders
Gui, 2:Add, Text, y%intGroupItemsY% x%g_intGroupItemsX% w500 hidden vf_lblHotkeyReminders, % o_L["OptionsHotkeyRemindersPrompt"]
Gui, 2:Add, Radio, % "y+5 x" . g_intGroupItemsX . " w500 hidden vf_radHotkeyReminders1 Group gHotkeyRemindersClicked " . (o_Settings.Menu.intHotkeyReminders.IniValue = 1 ? "Checked" : ""), % o_L["OptionsHotkeyRemindersNo"]
Gui, 2:Add, Radio, % "y+5 x" . g_intGroupItemsX . " w500 hidden vf_radHotkeyReminders2 gHotkeyRemindersClicked " . (o_Settings.Menu.intHotkeyReminders.IniValue = 2 ? "Checked" : ""), % o_L["OptionsHotkeyRemindersShort"]
Gui, 2:Add, Radio, % "y+5 x" . g_intGroupItemsX . " w500 hidden vf_radHotkeyReminders3 gHotkeyRemindersClicked " . (o_Settings.Menu.intHotkeyReminders.IniValue = 3 ? "Checked" : ""), % o_L["OptionsHotkeyRemindersFull"]

; HotkeyRemindersRightAlign
Gui, 2:Add, CheckBox, y+10 x%g_intGroupItemsTab2X% w500 hidden vf_blnHotkeyRemindersRightAlign gGuiOptionsGroupChanged, % o_L["HotkeyRemindersRightAlign"]
GuiControl, , f_blnHotkeyRemindersRightAlign, % (o_Settings.Menu.blnHotkeyRemindersRightAlign.IniValue = true)

; DisplayMenuShortcuts
Gui, 2:Add, CheckBox, y+15 x%g_intGroupItemsX% w500 vf_blnDisplayNumericShortcuts gDisplayMenuShortcutsClicked hidden, % o_L["OptionsDisplayMenuShortcuts"]
GuiControl, , f_blnDisplayNumericShortcuts, % (o_Settings.Menu.blnDisplayNumericShortcuts.IniValue = true)

; DisplayMenuShortcutsFromOne
Gui, 2:Add, CheckBox, y+15 x%g_intGroupItemsTab2X% w300 vf_blnDisplayNumericShortcutsFromOne gGuiOptionsGroupChanged hidden, % o_L["OptionsDisplayMenuShortcutsFromOne"]
GuiControl, , f_blnDisplayNumericShortcutsFromOne, % (o_Settings.Menu.blnDisplayNumericShortcutsFromOne.IniValue = true)
gosub, DisplayMenuShortcutsClickedInit

; RecentFoldersMax
Gui, 2:Add, Text, y+10 x%g_intGroupItemsX% w500 hidden vf_lblRecentFoldersMaxTitle, % o_L["OptionsRecentFoldersPrompt"]
Gui, 2:Add, Edit, y+5 x%g_intGroupItemsX% w51 h22 vf_intRecentFoldersMaxEdit number center hidden ; %g_intRecentFoldersMax%
Gui, 2:Add, UpDown, vf_intRecentFoldersMax Range1-9999 gGuiOptionsGroupChanged hidden, % o_Settings.Menu.intRecentFoldersMax.IniValue
Gui, 2:Add, Text, yp x+10 w235 hidden vf_lblRecentFoldersMax, % o_L["OptionsRecentFolders"]

; NbLastActions
Gui, 2:Add, Text, y+10 x%g_intGroupItemsX% w500 hidden vf_lblNbLastActionsMaxTitle, % o_L["MenuLastActions"]
Gui, 2:Add, Edit, y+5 x%g_intGroupItemsX% w51 h22 vf_intNbLastActionsMaxEdit number center hidden ; %g_intNbLastActions%
Gui, 2:Add, UpDown, vf_intNbLastActions Range1-9999 gGuiOptionsGroupChanged hidden, % o_Settings.Menu.intNbLastActions.IniValue
Gui, 2:Add, Text, yp x+10 w235 hidden vf_lblNbLastActionsMax, % o_L["OptionsRecentFolders"]

; AddCloseToDynamicMenus
Gui, 2:Add, CheckBox, y+25 x%g_intGroupItemsX% w500 vf_blnAddCloseToDynamicMenus gGuiOptionsGroupChanged hidden, % o_L["OptionsAddCloseToDynamicMenus"]
GuiControl, , f_blnAddCloseToDynamicMenus, % (o_Settings.Menu.blnAddCloseToDynamicMenus.IniValue = true)

GuiControlGet, arrPos, Pos, f_blnAddCloseToDynamicMenus
if ((arrPosY + arrPosH) > g_intOptionsFooterY)
g_intOptionsFooterY := arrPosY + arrPosH

; === PopupMenu ===

; PopupMenuPosition
Gui, 2:Add, Text, y%intGroupItemsY% x%g_intGroupItemsX% w500 Section hidden vf_radPopupMenuPositionTitle, % o_L["OptionsMenuPositionPrompt"]
Gui, 2:Add, Radio, % "y+5 x" . g_intGroupItemsX . " w500 hidden vf_radPopupMenuPosition1 gPopupMenuPositionClicked Group "
	. (o_Settings.MenuPopup.intPopupMenuPosition.IniValue = 1 ? "Checked" : ""), % o_L["OptionsMenuNearMouse"]
Gui, 2:Add, Radio, % "y+5 x" . g_intGroupItemsX . " w500 hidden vf_radPopupMenuPosition2 gPopupMenuPositionClicked "
	. (o_Settings.MenuPopup.intPopupMenuPosition.IniValue = 2 ? "Checked" : ""), % o_L["OptionsMenuActiveWindow"]
Gui, 2:Add, Radio, % "y+5 x" . g_intGroupItemsX . " hidden vf_radPopupMenuPosition3 gPopupMenuPositionClicked "
	. (o_Settings.MenuPopup.intPopupMenuPosition.IniValue = 3 ? "Checked" : ""), % o_L["OptionsMenuFixPosition"]

Gui, 2:Add, Text, % "yp x+10 hidden vf_lblPopupFixPositionX " . (o_Settings.MenuPopup.intPopupMenuPosition.IniValue = 3 ? "" : "Disabled"), % o_L["OptionsPopupFixPositionX"]
Gui, 2:Add, Edit, % "yp x+5 w51 h22 hidden vf_intPopupFixPositionXEdit number center " . (o_Settings.MenuPopup.intPopupMenuPosition.IniValue = 3 ? "" : "Disabled")
Gui, 2:Add, UpDown, vf_intPopupFixPositionX Range1-9999 gGuiOptionsGroupChanged hidden, % o_Settings.MenuPopup.arrPopupFixPosition.IniValue[1]
Gui, 2:Add, Text, % "yp x+5 hidden vf_lblPopupFixPositionY " . (o_Settings.MenuPopup.intPopupMenuPosition.IniValue = 3 ? "" : "Disabled"), % o_L["OptionsPopupFixPositionY"]
Gui, 2:Add, Edit, % "yp x+5 w51 h22 hidden vf_intPopupFixPositionYEdit number center " . (o_Settings.MenuPopup.intPopupMenuPosition.IniValue = 3 ? "" : "Disabled")
Gui, 2:Add, UpDown, vf_intPopupFixPositionY Range1-9999 gGuiOptionsGroupChanged hidden, % o_Settings.MenuPopup.arrPopupFixPosition.IniValue[2]

; RefreshedMenusAttached
Gui, 2:Add, CheckBox, y+15 x%g_intGroupItemsX% w500 vf_blnRefreshedMenusAttached gRefreshedMenusAttachedClicked hidden, % o_L["OptionsRefreshedMenusAttached"]
GuiControl, , f_blnRefreshedMenusAttached, % (o_Settings.MenuPopup.blnRefreshedMenusAttached.IniValue = true) ; IniValue created in AddAttachedOrDetachedQAPFeatureObject

; ExplorerContextMenus
if !(g_blnPortableMode)
{
	Gui, 2:Add, CheckBox, y+15 x%g_intGroupItemsX% w500 vf_blnExplorerContextMenus gGuiOptionsGroupChanged hidden, % o_L["OptionsExplorerContextMenus"]
	GuiControl, , f_blnExplorerContextMenus, % (o_Settings.MenuPopup.blnExplorerContextMenus.IniValue = true)
}

; ExclusionMouseList
strUrl := "https://www.quickaccesspopup.com/can-i-block-the-qap-menu-hotkeys-if-they-interfere-with-one-of-my-other-apps/"
Gui, 2:Add, Link, y+15 x%g_intGroupItemsX% w500 hidden vf_lnkExclusionMouseList1, % L(o_L["OptionsExclusionMouseListDescription"]
	, o_PopupHotkeyNavigateOrLaunchHotkeyMouse.AA.strPopupHotkeyText) . " (<a href=""" . strUrl . """>" . o_L["GuiHelp"] . "</a>)"
Gui, 2:Add, Edit, y+5  x%g_intGroupItemsX% w500 r5 vf_strExclusionMouseList gGuiOptionsGroupChanged hidden
	, % StrReplace(Trim(o_Settings.MenuPopup.strExclusionMouseList.IniValue), "|", "`n")
Gui, 2:Add, Link, y+10 x%g_intGroupItemsX% w495 hidden vf_lnkExclusionMouseList2, % L(o_L["OptionsExclusionMouseListDetail1"]
	, o_PopupHotkeyNavigateOrLaunchHotkeyMouse.AA.strPopupHotkeyText)
Gui, 2:Add, Link, y+10 x%g_intGroupItemsX% w495 hidden vf_lnkExclusionMouseList3, % L(o_L["OptionsExclusionMouseListDetail2"]
	, o_PopupHotkeyNavigateOrLaunchHotkeyMouse.AA.strPopupHotkeyText, strUrl)
Gui, 2:Add, Button, y+10 x%g_intGroupItemsX% vf_btnGetWinInfoMouseExclusions gGetWinInfo hidden, % o_L["MenuGetWinInfo"]
GuiCenterButtons(g_strOptionsGuiTitle, 10, 5, 20, "f_btnGetWinInfoMouseExclusions")

GuiControlGet, arrPos, Pos, f_btnGetWinInfoMouseExclusions
if ((arrPosY + arrPosH) > g_intOptionsFooterY)
	g_intOptionsFooterY := arrPosY + arrPosH

; === PopupHotkeys ===

; NavigateOrLaunchHotkeyMouse
; NavigateOrLaunchHotkeyKeyboard
; AlternativeHotkeyMouse
; AlternativeHotkeyKeyboard

o_PopupHotkeys.BackupPopupHotkeys()

Gui, 2:Add, Text, y%intGroupItemsY% x%g_intGroupItemsX% w590 center hidden vf_lblChangeShortcutTitle, % L(o_L["OptionsTabMouseAndKeyboardIntro"], g_strAppNameText)
for intThisIndex, objThisPopupHotkey in o_PopupHotkeys.SA ; could also use o_Settings class objects
{
	Gui, 2:Font, s8 w700
	Gui, 2:Add, Text, x%g_intGroupItemsX% y+20 w610 hidden vf_lblChangeShortcut%intThisIndex%, % objThisPopupHotkey.AA.strPopupHotkeyLocalizedName
	Gui, 2:Font, s9 w500, Courier New
	Gui, 2:Add, Text, % "Section x" . g_intGroupItemsX + 260 . " y+5 w280 h23 center 0x1000 vf_lblHotkeyText" . intThisIndex . " gButtonOptionsChangeShortcut" . intThisIndex . " hidden"
		, % objThisPopupHotkey.AA.strPopupHotkeyTextShort
	Gui, 2:Font
	Gui, 2:Add, Button, yp x720 vf_btnChangeShortcut%intThisIndex% gButtonOptionsChangeShortcut%intThisIndex% hidden, % o_L["OptionsChangeHotkey"]
	Gui, 2:Font, s8 w500
	Gui, 2:Add, Link, x%g_intGroupItemsX% ys w240 gOptionsTitlesDescriptionClicked hidden vf_lnkChangeShortcut%intThisIndex%, % objThisPopupHotkey.AA.strPopupHotkeyLocalizedDescription
}

Gui, 2:Font, s8 w700
Gui, 2:Add, Text, y+15 x%g_intGroupItemsX% hidden vf_lblControlDoublePressedTitle, % o_L["OptionsControlDoublePressed"] . ":"
Gui, 2:Font
Gui, 2:Add, CheckBox, y+5 x%g_intGroupItemsX% vf_blnLeftControlDoublePressed gGuiOptionsGroupChanged hidden, % o_L["OptionsControlDoublePressedLeft"]
Gui, 2:Add, CheckBox, yp x+5 vf_blnRightControlDoublePressed gGuiOptionsGroupChanged hidden, % o_L["OptionsControlDoublePressedRight"]
GuiControl, , f_blnLeftControlDoublePressed, % (o_Settings.MenuPopup.blnLeftControlDoublePressed.IniValue = true)
GuiControl, , f_blnRightControlDoublePressed, % (o_Settings.MenuPopup.blnRightControlDoublePressed.IniValue = true)

intThisIndex := ""
objThisPopupHotkey := ""

GuiControlGet, arrPos, Pos, f_blnRightControlDoublePressed
if ((arrPosY + arrPosH) > g_intOptionsFooterY)
	g_intOptionsFooterY := arrPosY + arrPosH

; === PopupHotkeysAlternative ===

; {Alternative Menu QAP Feature Codes}
o_QAPfeatures.aaQAPFeaturesNewShortcuts := Object() ; re-init
for intOrder, strAlternativeCode in o_QAPfeatures.saQAPFeaturesAlternativeCodeByOrder
	if HasShortcut(o_QAPfeatures.AA[strAlternativeCode].strCurrentHotkey)
		; o_QAPfeatures.aaQAPFeaturesNewShortcuts will be saved to ini file and o_QAPfeatures.AA will be used to turn off previous hotkeys
		o_QAPfeatures.aaQAPFeaturesNewShortcuts[strAlternativeCode] := o_QAPfeatures.AA[strAlternativeCode].strCurrentHotkey
		
Gui, 2:Add, Text, y%intGroupItemsY% x%g_intGroupItemsX% w590 center hidden vf_lblAlternativeMenu, % o_L["OptionsAlternativeMenuFeaturesIntro"]

for intOrder, strAlternativeCode in o_QAPfeatures.saQAPFeaturesAlternativeCodeByOrder
{
	Gui, 2:Font, s8 w700
	Gui, 2:Add, Text, x%g_intGroupItemsX% y+10 w240 hidden vf_lblAlternativeHotkeyName%intOrder%, % o_QAPfeatures.AA[strAlternativeCode].strLocalizedName ; .strLocalizedName OK because Alternative
	Gui, 2:Font, s9 w500, Courier New
	Gui, 2:Add, Text, x+10 yp w280 h20 center 0x1000 vf_lblAlternativeHotkeyText%intOrder% gButtonOptionsChangeAlternativeHotkey hidden
		, % new Triggers.HotkeyParts(o_QAPfeatures.AA[strAlternativeCode].strCurrentHotkey).Hotkey2Text(true)
	Gui, 2:Font
	Gui, 2:Add, Button, yp x+10 vf_btnChangeAlternativeHotkey%intOrder% gButtonOptionsChangeAlternativeHotkey hidden, % o_L["OptionsChangeHotkey"]
}

; AlternativeMenuShowNotification
Gui, 2:Add, CheckBox, y+30 x%g_intGroupItemsX% vf_blnAlternativeMenuShowNotification gGuiOptionsGroupChanged hidden, % o_L["OptionsAlternativeMenuShowNotification"]
GuiControl, , f_blnAlternativeMenuShowNotification, % (o_Settings.MenuPopup.blnAlternativeMenuShowNotification.IniValue = true)

GuiControlGet, arrPos, Pos, f_blnAlternativeMenuShowNotification
if ((arrPosY + arrPosH) > g_intOptionsFooterY)
	g_intOptionsFooterY := arrPosY + arrPosH

; === FileManagers ===

Gui, 2:Add, Text, x%g_intGroupItemsX% y%intGroupItemsY% w590 center hidden vf_lblFileManagersIntro, % o_L["OptionsTabFileManagersIntro"]

; --- column 2 ---
; FileManagerAlwaysNavigate
Gui, Font, w600
Gui, 2:Add, Text, x%g_intGroupItemsTab4X% y+15 w300 Section hidden vf_lblFileManagerNavigateTitle, % o_L["OptionsTabFileManagersPreferences"]
Gui, Font
Gui, 2:Add, Text, y+10 x%g_intGroupItemsTab4X% w300 vf_lblFileManagerNavigate hidden, % L(o_L["OptionsFileManagerNavigateIntro"], o_FileManagers.SA[o_FileManagers.P_intActiveFileManager].AA.strDisplayName)
Gui, 2:Add, Radio, % "y+10 x" . g_intGroupItemsTab4X . " w250 hidden vf_radFileManagerNavigateCurrent gGuiOptionsGroupChanged" . (o_Settings.FileManagers.blnAlwaysNavigate.IniValue ? " checked" : "")
Gui, 2:Add, Radio, % "y+5 x" . g_intGroupItemsTab4X . " w250 hidden vf_radFileManagerNavigateNew gGuiOptionsGroupChanged" . (! o_Settings.FileManagers.blnAlwaysNavigate.IniValue ? " checked" : "")

; --- column 1 ---
; ActiveFileManager
Gui, Font, w600
Gui, 2:Add, Text, ys x%g_intGroupItemsX% w230 Section hidden vf_lblradActiveFileManager, % o_L["OptionsTabFileManagersPreferred"]
Gui, Font
loop, % o_FileManagers.SA.Length()
	Gui, 2:Add, Radio, % "y+10 x" . g_intGroupItemsTab1X . " hidden gActiveFileManagerClicked vf_radActiveFileManager" . A_Index 
		. (o_FileManagers.P_intActiveFileManager = A_Index ? " checked" : ""), % o_FileManagers.SA[A_Index].AA.strDisplayName

; --- bottom ---
Gui, 2:Font, s8 w700
Gui, 2:Add, Link, y+25 x%g_intGroupItemsTab2X% w500 vf_lnkFileManagerHelp hidden
Gui, 2:Font
Gui, 2:Add, Text, y+10 x%g_intGroupItemsTab2X% w500 vf_lblFileManagerDetail hidden

; Windows Explorer OpenFavoritesOnActiveMonitor
Gui, 2:Add, CheckBox, yp x%g_intGroupItemsTab2X% w500 vf_blnOpenFavoritesOnActiveMonitor gGuiOptionsGroupChanged hidden, % o_L["OptionsOpenFavoritesOnActiveMonitor"]
GuiControl, , f_blnOpenFavoritesOnActiveMonitor, % (g_aaFileManagerExplorer.blnOpenFavoritesOnActiveMonitor = true)

; DirectoryOpusPath
; TotalCommanderPath
Gui, 2:Add, Text, y+10 x%g_intGroupItemsTab2X% w105 vf_lblFileManagerPrompt hidden, % o_L["DialogApplicationLabel"] . ":"
Gui, 2:Add, Edit, yp x%g_intGroupItemsTab3X% w300 h20 vf_strFileManagerPath hidden ; gLabel after Gosub that changes the value below

; QAPconnectFileManager
Gui, 2:Add, DropDownList, xp yp w300 vf_drpQAPconnectFileManager hidden Sort gGuiOptionsGroupChanged
if StrLen(g_aaFileManagerQAPconnect.strQAPconnectFileManager)
	GuiControl, ChooseString, f_drpQAPconnectFileManager, % g_aaFileManagerQAPconnect.strQAPconnectFileManager
Gui, 2:Add, Button, x+10 yp vf_btnFileManagerPath gButtonSelectFileManagerPath hidden, % o_L["DialogBrowseButton"]

; DirectoryOpusUseTabs
; DirectoryOpusNewTabOrWindow (not in Gui)
; TotalCommanderUseTabs
; TotalCommanderNewTabOrWindow (not in Gui)
Gui, 2:Add, Checkbox, y+10 x%g_intGroupItemsTab3X% w590 vf_blnFileManagerUseTabs gFileManagerNavigateClicked hidden, % o_L["OptionsThirdPartyUseTabs"]

; QAPconnectFileManager buttons (must be after UseTabs checkbox)
Gui, 2:Add, Button, x%g_intGroupItemsTab3X% yp vf_btnQAPconnectEdit gShowQAPconnectIniFile hidden, % L(o_L["MenuEditIniFile"], "QAPconnect.ini")
Gui, 2:Add, Button, x+10 yp vf_btnQAPconnectRefresh gActiveFileManagerClickedInit hidden, % o_L["OptionsRefreshQAPconnectList"] ; ActiveFileManagerClickedInit will refresh the dropdown list

; TotalCommanderWinCmd
Gui, 2:Add, Text, y+10 x%g_intGroupItemsTab2X% w105 vf_lblTotalCommanderWinCmdPrompt hidden, % o_L["TCWinCmdLocation"]
Gui, 2:Add, Edit, yp x%g_intGroupItemsTab3X% w300 h20 vf_strTotalCommanderWinCmd hidden ; gGuiOptionsGroupChanged
Gui, 2:Add, Button, x+10 yp vf_btnTotalCommanderWinCmd gButtonSelectTotalCommanderWinCmd hidden, % o_L["DialogBrowseButton"]

; FileManagerDOpusShowLayouts
Gui, 2:Add, Checkbox, yp x%g_intGroupItemsTab3X% w590 vf_blnFileManagerDirectoryOpusShowLayouts gGuiOptionsGroupChanged hidden, % L(o_L["DopusMenuNameShowLayout"], o_L["DOpusLayoutsName"])
GuiControl, , f_blnFileManagerDirectoryOpusShowLayouts, % (g_aaFileManagerDirectoryOpus.blnFileManagerDirectoryOpusShowLayouts = true)

Gosub, ActiveFileManagerClickedInit
Gosub, FileManagerNavigateClickedInit
GuiControl, 2:+gGuiOptionsGroupChanged, f_strFileManagerPath

GuiControlGet, arrPos, Pos, f_blnFileManagerDirectoryOpusShowLayouts
if ((arrPosY + arrPosH) > g_intOptionsFooterY)
	g_intOptionsFooterY := arrPosY + arrPosH

; === Snippets ===

Gui, 2:Font, s8 w700
Gui, 2:Add, Link, y%intGroupItemsY% x%g_intGroupItemsX% w500 hidden vf_lblSnippetDefaultIntro, % L(o_L["OptionsSnippetsHelp"], "https://www.quickaccesspopup.com/what-are-snippets/", o_L["GuiHelp"])
Gui, 2:Font

; SnippetDefaultProcessEOLTab
Gui, 2:Add, CheckBox, y+10 x%g_intGroupItemsX% w500 vf_blnSnippetDefaultProcessEOLTab gGuiOptionsGroupChanged hidden, % o_L["DialogFavoriteSnippetProcessEOLTab"]
GuiControl, , f_blnSnippetDefaultProcessEOLTab, % (o_Settings.Snippets.blnSnippetDefaultProcessEOLTab.IniValue = true)

; SnippetDefaultFixedFont
Gui, 2:Add, CheckBox, y+10 x%g_intGroupItemsX% w500 vf_blnSnippetDefaultFixedFont gGuiOptionsGroupChanged hidden, % o_L["DialogFavoriteSnippetFixedFont"]
GuiControl, , f_blnSnippetDefaultFixedFont, % (o_Settings.Snippets.blnSnippetDefaultFixedFont.IniValue = true)

; SnippetDefaultFontSize
Gui, 2:Add, Text, y+10 x%g_intGroupItemsX% hidden vf_lblSnippetDefaultFontSize, % o_L["DialogFavoriteSnippetFontSize"]
Gui, 2:Add, Edit, x+5 yp h20 w52 vf_intSnippetDefaultFontSizeEdit hidden, % o_L["DialogFavoriteSnippetFontSize"]
Gui, 2:Add, UpDown, Range6-18 h20 gGuiOptionsGroupChanged hidden vf_intSnippetDefaultFontSize, % o_Settings.Snippets.intSnippetDefaultFontSize.IniValue

; SnippetDefaultMacro
Gui, 2:Add, CheckBox, y+10 x%g_intGroupItemsX% w300 vf_blnSnippetDefaultMacro gGuiOptionsGroupChanged hidden, % o_L["DialogFavoriteSnippetSendModeMacro"]
GuiControl, , f_blnOptionsSnippetDefaultMacro, % (o_Settings.Snippets.blnSnippetDefaultMacro.IniValue = true)

; HotstringsDefaultOptions
Gui, 2:Add, Text, y+20 x%g_intGroupItemsX% hidden vf_lblSelectHotstringDefaultOptions, % o_L["OptionsHotstringsDefault"]
Gui, 2:Add, Button, yp x+5 gSelectHotstringDefaultOptions hidden vf_btnSelectHotstringDefaultOptions, % o_L["OptionsHotstringsDefaultSelect"]

GuiControlGet, arrPos, Pos, f_blnSnippetDefaultMacro
if ((arrPosY + arrPosH) > g_intOptionsFooterY)
	g_intOptionsFooterY := arrPosY + arrPosH

; === UserVariables ===

; UserVariablesList
Gui, 2:Font, s8 w700
Gui, 2:Add, Link, y%intGroupItemsY% x%g_intGroupItemsX% w600 hidden vf_lnkUserVariablesListTitle, % o_L["OptionsUserVariablesList"]
	. " (<a href=""https://www.quickaccesspopup.com/can-i-create-custom-user-variables-and-use-them-in-file-paths-or-snippets/"">" . o_L["GuiHelp"] . "</a>)"
Gui, 2:Font
Gui, 2:Add, Link, x%g_intGroupItemsX% y+10 w600 hidden vf_lnkUserVariablesList, % o_L["OptionsUserVariablesListInstructions"]
Gui, 2:Add, Edit, x%g_intGroupItemsX% y+10 w600 hidden r5 vf_strUserVariablesList gGuiOptionsGroupChanged
	, % (StrLen(o_Settings.UserVariables.strUserVariablesList.IniValue)
	? StrReplace(Trim(o_Settings.UserVariables.strUserVariablesList.IniValue), "|", "`n") : "{MyVariable}=MyContent")

GuiControlGet, arrPos, Pos, f_strUserVariablesList
if ((arrPosY + arrPosH) > g_intOptionsFooterY)
	g_intOptionsFooterY := arrPosY + arrPosH

; === Database ===

Gui, 2:Add, CheckBox, y%intGroupItemsY% x%g_intGroupItemsX% vf_blnOptionUsageDbEnable gOptionUsageDbEnableClicked hidden, % L(o_L["OptionsUsageDbEnable"], g_strAppNameText)
GuiControl, , f_blnOptionUsageDbEnable, % (o_Settings.Database.intUsageDbIntervalSeconds.IniValue > 0)

; UsageDbIntervalSeconds
Gui, 2:Add, Text, x%g_intGroupItemsX% y+10 vf_lblUsageDbIntervalSeconds hidden, % o_L["OptionsUsageDbIntervalSeconds"]
Gui, 2:Add, Edit, x+10 yp h20 w65 number vf_intUsageDbIntervalSecondsEdit hidden
Gui, 2:Add, UpDown, Range60-7200 h20 vf_intUsageDbIntervalSeconds gGuiOptionsGroupChanged hidden, % o_Settings.Database.intUsageDbIntervalSeconds.IniValue

; UsageDbDaysInPopular
Gui, 2:Add, Text, x%g_intGroupItemsX% y+5 vf_lblUsageDbDaysInPopular hidden, % o_L["OptionsUsageDbDaysInPopular"]
Gui, 2:Add, Edit, x+10 yp h20 w65 number vf_intUsageDbDaysInPopularEdit hidden
Gui, 2:Add, UpDown, Range1-9999 h20 vf_intUsageDbDaysInPopular gGuiOptionsGroupChanged hidden, % o_Settings.Database.intUsageDbDaysInPopular.IniValue

; UsageDbMaximumSize
Gui, 2:Add, Text, x%g_intGroupItemsX% y+5 vf_lblUsageDbMaximumSize hidden, % o_L["OptionsUsageDbMaximumSize"]
Gui, 2:Add, Edit, x+10 yp h20 w65 vf_fltUsageDbMaximumSize gGuiOptionsGroupChanged hidden, % o_Settings.Database.fltUsageDbMaximumSize.IniValue ; do not use number option to accept "," decimal separator

Gui, 2:Add, Button, x%g_intGroupItemsX% y+10 vf_btnUsageDbFlush gButtonUsageDbFlushClicked hidden, % o_L["OptionsUsageDbFlushDatabase"]

; UsageDbShowPopularityIndex
Gui, 2:Add, CheckBox, x%g_intGroupItemsX% y+5 vf_blnUsageDbShowPopularityIndex gGuiOptionsGroupChanged hidden, % o_L["OptionsUsageDbShowPopularityIndex"]
GuiControl, , f_blnUsageDbShowPopularityIndex, % o_Settings.Database.blnUsageDbShowPopularityIndex.IniValue = true

Gui, 2:Font, s8 w700
Gui, 2:Add, Text, x%g_intGroupItemsX% y+20 w600 hidden vf_lblOptionUsageDbEnableStatementTitle, % o_L["OptionsUsageDbStatementTitle"]
Gui, 2:Font
Gui, 2:Add, Text,  w600 hidden x%g_intGroupItemsX% y+10 vf_lblOptionUsageDbEnableStatement, % L(o_L["OptionsUsageDbStatement"], g_strAppNameText)

Gosub, OptionUsageDbEnableClickedInit

GuiControlGet, arrPos, Pos, f_lblOptionUsageDbEnableStatement
if ((arrPosY + arrPosH) > g_intOptionsFooterY)
	g_intOptionsFooterY := arrPosY + arrPosH

; === MenuAdvanced ===

; OpenMenuOnTaskbar
Gui, 2:Add, CheckBox, y%intGroupItemsY% x%g_intGroupItemsX% vf_blnOpenMenuOnTaskbar gGuiOptionsGroupChanged hidden, % o_L["OptionsOpenMenuOnTaskbar"]
GuiControl, , f_blnOpenMenuOnTaskbar, % (o_Settings.MenuPopup.blnOpenMenuOnTaskbar.IniValue = true)

; RefreshQAPMenuIntervalSec
Gui, 2:Add, Checkbox, x%g_intGroupItemsX% y+15 vf_blnRefreshQAPMenuEnable gRefreshQAPMenuEnableClicked hidden, % o_L["OptionsRefreshQAPMenuTitle"]
GuiControl, , f_blnRefreshQAPMenuEnable, % (o_Settings.MenuAdvanced.intRefreshQAPMenuIntervalSec.IniValue > 0)
Gui, 2:Add, Edit, x%g_intGroupItemsX% y+5 w60 h22 vf_intRefreshQAPMenuIntervalSecEdit center disabled hidden
Gui, 2:Add, UpDown, vf_intRefreshQAPMenuIntervalSec Range30-86400 disabled gGuiOptionsGroupChanged hidden
	, % (o_Settings.MenuAdvanced.intRefreshQAPMenuIntervalSec.IniValue ? o_Settings.MenuAdvanced.intRefreshQAPMenuIntervalSec.IniValue : 300)
Gui, 2:Add, Text, yp x+10 vf_lblRefreshQAPMenuIntervalSec Disabled hidden, % o_L["OptionsRefreshQAPMenuIntervalSec"]

; RefreshQAPMenuDebugBeep
Gui, 2:Add, CheckBox, x%g_intGroupItemsX% y+5 w300 vf_blnRefreshQAPMenuDebugBeep Disabled gGuiOptionsGroupChanged hidden, % o_L["OptionsRefreshQAPMenuDebugBeep"]
GuiControl, , f_blnRefreshQAPMenuDebugBeep, % (o_Settings.MenuAdvanced.blnRefreshQAPMenuDebugBeep.IniValue = true)
gosub, RefreshQAPMenuEnableClickedInit

; ClipboardMaxSize
Gui, 2:Add, Text, x%g_intGroupItemsX% y+20 vf_lblClipboardMaxSize hidden, % o_L["OptionsClipboardMaxSize"]
Gui, 2:Add, Edit, x+10 yp h20 w65 number vf_intClipboardMaxSize gGuiOptionsGroupChanged hidden, % o_Settings.MenuAdvanced.intClipboardMaxSize.IniValue

; NbLiveFolderItemsMax
Gui, 2:Add, Text, x%g_intGroupItemsX% y+15 vf_lblNbLiveFolderItemsMax hidden, % o_L["OptionsNbLiveFolderItemsMax"]
Gui, 2:Add, Edit, x+10 yp h20 w65 number center vf_intNbLiveFolderItemsMax gGuiOptionsGroupChanged hidden, % o_Settings.MenuAdvanced.intNbLiveFolderItemsMax.IniValue

GuiControlGet, arrPos, Pos, f_intClipboardMaxSize
if ((arrPosY + arrPosH) > g_intOptionsFooterY)
	g_intOptionsFooterY := arrPosY + arrPosH

; === AdvancedLaunch ===

; RunAsAdmin
Gui, 2:Add, CheckBox, x%g_intGroupItemsX% y%intGroupItemsY% vf_blnRunAsAdmin gRunAsAdminClicked hidden, % o_L["OptionsRunAsAdmin"]
Gui, 2:Add, Picture, x+1 yp hidden vf_picRunAsAdmin, %g_strTempDir%\uac_logo-16.png
GuiControl, , f_blnRunAsAdmin, % (o_Settings.LaunchAdvanced.blnRunAsAdmin.IniValue = true)

; RefreshWindowsAppsListAtStartup
Gui, 2:Add, CheckBox, x%g_intGroupItemsX% y+10 w500 vf_blnRefreshWindowsAppsListAtStartup gGuiOptionsGroupChanged hidden, % o_L["OptionsRefreshWindowsAppsListAtStartup"]
GuiControl, , f_blnRefreshWindowsAppsListAtStartup, % (o_Settings.LaunchAdvanced.blnRefreshWindowsAppsListAtStartup.IniValue = true)

; AlternativeTrayIcon
Gui, 2:Add, Text, x%g_intGroupItemsX% y+10 vf_lblAlternativeTrayIcon hidden, % o_L["OptionsAlternativeTrayIcon"] . ":"
Gui, 2:Add, Edit, y+5 xs w300 h20 vf_strAlternativeTrayIcon hidden ; gLabel after GuiControl that changes the value below
Gui, 2:Add, Button, x+5 yp w75 vf_btnAlternativeTrayIcon gButtonAlternativeTrayIcon hidden, % o_L["DialogBrowseButton"]
GuiControl, 2:, f_strAlternativeTrayIcon, % o_Settings.LaunchAdvanced.strAlternativeTrayIcon.IniValue
GuiControl, 2:+gGuiOptionsGroupChanged, f_strAlternativeTrayIcon

GuiControlGet, arrPos, Pos, f_btnAlternativeTrayIcon
if ((arrPosY + arrPosH) > g_intOptionsFooterY)
	g_intOptionsFooterY := arrPosY + arrPosH

; === AdvancedOther ===

; WaitDelayInDialogBox
Gui, 2:Add, Text, x%g_intGroupItemsX% y%intGroupItemsY% vf_lblWaitDelayInDialogBox hidden, % o_L["OptionsWaitDelayInDialogBox"]
Gui, 2:Add, Edit, x+10 yp h20 w65 number center vf_intWaitDelayInDialogBox gGuiOptionsGroupChanged hidden, % o_Settings.DialogBoxes.intWaitDelayInDialogBox.IniValue

; SendToConsoleWithAlt
Gui, 2:Add, CheckBox, x%g_intGroupItemsX% y+10 w500 vf_blnSendToConsoleWithAlt gGuiOptionsGroupChanged hidden, % o_L["OptionsSendToConsoleWithAlt"]
GuiControl, , f_blnSendToConsoleWithAlt, % (o_Settings.Execution.blnSendToConsoleWithAlt.IniValue = true)

; ExternalMenusCataloguePath
if !(o_Settings.SettingsFile.blnExternalMenusCataloguePathReadOnly.IniValue)
{
	Gui, 2:Add, CheckBox, y+20 x%g_intGroupItemsX% vf_blnEnableExternalMenusCatalogue hidden, % o_L["OptionsEnableExternalMenusCatalogue"]
	Gui, 2:Add, Link, yp x+5 hidden vf_lnkEnableExternalMenusCatalogue, % "(<a href=""https://www.quickaccesspopup.com/shared-menu-catalogue/"">" . o_L["GuiHelp"] . "</a>)"
	GuiControl, , f_blnEnableExternalMenusCatalogue, % StrLen(o_Settings.SettingsFile.strExternalMenusCataloguePath.IniValue) > 0
	Gui, 2:Add, Text, y+10 x%g_intGroupItemsX% vf_lblExternalMenusCataloguePathPrompt disabled hidden, % o_L["OptionsCataloguePath"] . ":"
	Gui, 2:Add, Edit, yp x+5 w200 h20 vf_strExternalMenusCataloguePath disabled hidden ; gLabel after Gosub that changes the value below
	Gui, 2:Add, Button, x+5 yp w75 vf_btnExternalMenusCataloguePath gButtonExternalMenuSelectCataloguePath disabled hidden, % o_L["DialogBrowseButton"]
	GuiControl, 2:, f_strExternalMenusCataloguePath, % o_Settings.SettingsFile.strExternalMenusCataloguePath.IniValue
	Gosub, EnableExternalMenusCatalogueClickedInit ; init disabled fields
	GuiControl, 2:+gEnableExternalMenusCatalogueClicked, f_blnEnableExternalMenusCatalogue
	GuiControl, 2:+gGuiOptionsGroupChanged, f_strExternalMenusCataloguePath
}

; WaitDelayInSnippet
Gui, 2:Add, Text, x%g_intGroupItemsX% y+10 hidden vf_lblWaitDelayInSnippet, % o_L["OptionsWaitDelayInSnippet"]
loop, 3
	Gui, 2:Add, Edit, % "x+5 yp h20 w50 hidden number center gGuiOptionsGroupChanged vf_intWaitDelayInSnippet" . A_Index, % o_Settings.Snippets.arrWaitDelayInSnippet.IniValue[A_Index]

; SwitchExclusionList
strUrl := "https://www.quickaccesspopup.com/how-is-built-the-switch-to-an-open-folder-or-application-menu/"
Gui, 2:Font, s8 w700
Gui, 2:Add, Link, y+15 x%g_intGroupItemsX% w500 hidden vf_lnkSwitchExclusionList, % o_L["OptionsSwitchExclusionList"] . " (<a href=""" . strUrl . """>" . o_L["GuiHelp"] . "</a>)"
Gui, 2:Font
Gui, 2:Add, Edit, y+5 x%g_intGroupItemsX% w500 hidden r5 vf_strSwitchExclusionList gGuiOptionsGroupChanged, % StrReplace(Trim(o_Settings.Execution.strSwitchExclusionList.IniValue), "|", "`n")
Gui, 2:Add, Link, y+5 x%g_intGroupItemsX% w495 hidden vf_lnkGetWinInfoSwitchExclusion, % L(o_L["OptionsSwitchExclusionListInstructions"], strUrl)
Gui, 2:Add, Button, x%g_intGroupItemsX% y+10 vf_btnGetWinInfoSwitchExclusion gGetWinInfo hidden, % o_L["MenuGetWinInfo"]
GuiCenterButtons(g_strOptionsGuiTitle, 10, 5, 20, "f_btnGetWinInfoSwitchExclusion")

GuiControlGet, arrPos, Pos, f_btnGetWinInfoSwitchExclusion
if ((arrPosY + arrPosH) > g_intOptionsFooterY)
	g_intOptionsFooterY := arrPosY + arrPosH

Gosub, GuiOptionsFooter

strUrl := ""
intThisIndex := ""
objThisPopupHotkey := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiOptionsGroupSave:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

; === Validation ===

blnOptionsPathsOK := true ; unless some folder not found later

if (g_intClickedFileManager = 4) ; QAPconnect
{
	blnOptionsPathsOK := StrLen(f_drpQAPconnectFileManager)
	if (blnOptionsPathsOK)
	{
		strQAPconnectPath := o_Settings.ReadIniValue("AppPath", " ", f_drpQAPconnectFileManager, g_aaFileManagerQAPconnect.strQAPconnectIniPath) ; empty by default
		blnOptionsPathsOK := FileExistInPath(strQAPconnectPath) ; return strQAPconnectPath expanded
	}
}
else if (g_intClickedFileManager > 1) ; 2 DirectoryOpus or 3 TotalCommander
{
	blnTCWinCmdOK := true ; unless WinCmd not found later
	blnOptionsPathsOK := StrLen(f_strFileManagerPath)
	if (blnOptionsPathsOK)
	{
		strTempLocation := f_strFileManagerPath ; avoid change in f_strFileManagerPath by FileExistInPath
		blnOptionsPathsOK := FileExistInPath(strTempLocation) ; return strTempLocation with expanded relative path and envvars, and absolute location if in PATH
	}
	if (g_intClickedFileManager = 3) ; 3 TotalCommander
	{
		blnTCWinCmdOK := StrLen(f_strTotalCommanderWinCmd)
		if (blnTCWinCmdOK)
		{
			strTempLocation := f_strTotalCommanderWinCmd ; avoid change in f_strTotalCommanderWinCmd by FileExistInPath
			blnTCWinCmdOK := FileExistInPath(strTempLocation) ; return strTempLocation with expanded relative path and envvars, and absolute location if in PATH
		}
	}
}
if (g_intClickedFileManager > 1 and (!blnOptionsPathsOK or !blnTCWinCmdOK))
{
	if (g_intClickedFileManager = 4)
		Oops(o_L["OptionsThirdPartyFileNotFound"], f_drpQAPconnectFileManager, strQAPconnectPath)
	else if (!blnOptionsPathsOK) ; 2 DirectoryOpus or 3 TotalCommander
		if StrLen(f_strFileManagerPath)
			Oops(o_L["OptionsThirdPartyFileNotFound"], o_FileManagers.SA[g_intClickedFileManager].AA.strDisplayName, f_strFileManagerPath)
		else
			Oops(o_L["OptionsThirdPartySelectFile"], o_FileManagers.SA[g_intClickedFileManager].AA.strDisplayName)
	if (!blnTCWinCmdOK)
		Oops(o_L["OptionsTCWinCmd"], f_strTotalCommanderWinCmd)
	
	return
}

; Expand Temp, Backup and Settings folders
strTempFolderNew := EnvVars(f_strQAPTempFolderParentPath) ; save unexpanded to ini file
strBackupFolderNew := EnvVars(f_strBackupFolder) ; save unexpanded to ini file

if (!g_blnPortableMode) ; Working folder prep (only for Setup installation)
{
	strWorkingFolderNew := EnvVars(f_strWorkingFolder) ; do not PathCombine, save expanded to registry
	strWorkingFolderPrev := GetRegistry("HKEY_CURRENT_USER\Software\Jean Lalonde\" . g_strAppNameText, "WorkingFolder")
	if (strWorkingFolderNew <> strWorkingFolderPrev) and InStr(strWorkingFolderNew, strWorkingFolderPrev . "\") ; check that dest is not under current location (preventing a recursive copy)
	{
		Oops(o_L["DialogMoveSettingsUnder"])
		return
	}
}

if (!g_blnPortableMode and !FolderExistOrCreate(strWorkingFolderNew)) ; Working folder (only for Setup installation)
	or !FolderExistOrCreate(strBackupFolderNew) ; Backup folder
	or !FolderExistOrCreate(strTempFolderNew) ; Temp folder
	return

if (!g_blnPortableMode) ; Working folder prep (only for Setup installation)
{
	if (strWorkingFolderNew <> strWorkingFolderPrev)
	{
		SetTimer, MoveWorkingFolderChangeButtonNames, 50
		MsgBox, 547, % o_L["OptionsMoveWorkingFolderTitle"], % L(o_L["OptionsMoveWorkingFolderType"], strWorkingFolderNew, g_strAppNameText) ; Option 2 Yes-No-Cancel + 5 question icon + 512 cancel default

		IfMsgBox, Cancel
			return
		IfMsgBox, Yes
			blnMoveSettingsToNewWorkingFolder := true ; will be done after saving other settings at the end of this command
		else
			blnMoveSettingsToNewWorkingFolder := false
	}
}

if StrLen(f_strAlternativeTrayIcon) ; because f_strAlternativeTrayIcon is optional
{
	strTempLocation := f_strAlternativeTrayIcon
	blnOptionsPathsOK := FileExistInPath(strTempLocation) ; return strTempLocation with expanded relative path and envvars, and absolute location if in PATH
	if (!blnOptionsPathsOK)
	{
		Oops(o_L["OopsOptionsPathNotExist"], o_L["OopsOptionsPathTrayIcon"], f_strAlternativeTrayIcon)
		return
	}
}

blnOptionsPathsOK := ""
strTempLocation := ""

; from here, we know that we have valid paths in Options

; === Saving Options ===

g_blnMenuReady := false

; === General ===

ToggleRunAtStartup(f_blnOptionsRunAtStartup)

strLanguageCodePrev := o_Settings.Launch.strLanguageCode.IniValue
g_strLanguageLabel := f_drpLanguage
loop, % g_objOptionsLanguageLabels.Length()
	if (g_objOptionsLanguageLabels[A_Index] = g_strLanguageLabel)
		{
			o_Settings.Launch.strLanguageCode.IniValue := g_objOptionsLanguageCodes[A_Index]
			break
		}
o_Settings.Launch.strLanguageCode.WriteIni("", true) ; value already changed in the loop

strThemePrev := o_Settings.Launch.strTheme.IniValue
o_Settings.Launch.strTheme.WriteIni(f_drpTheme)

o_Settings.Launch.blnDisplayTrayTip.WriteIni(f_blnDisplayTrayTip)
o_Settings.Launch.blnCheck4Update.WriteIni(f_blnCheck4Update)
o_Settings.MenuPopup.blnChangeFolderInDialog.WriteIni(f_blnChangeFolderInDialog)

o_Settings.SettingsFile.strBackupFolder.WriteIni(f_strBackupFolder) ; save unexpanded to ini file

strQAPTempFolderParentPrev := o_Settings.Launch.strQAPTempFolderParent.IniValue
if StrLen(strTempFolderNew)
	o_Settings.Launch.strQAPTempFolderParent.WriteIni(f_strQAPTempFolderParentPath) ; save unexpanded to ini file

; === SettingsWindow ===

o_Settings.SettingsWindow.blnDisplaySettingsStartup.WriteIni(f_blnDisplaySettingsStartup)
o_Settings.SettingsWindow.blnRememberSettingsPosition.WriteIni(f_blnRememberSettingsPosition)
o_Settings.SettingsWindow.blnOpenSettingsOnActiveMonitor.WriteIni(f_blnOpenSettingsOnActiveMonitor)
o_Settings.SettingsWindow.blnAddAutoAtTop.WriteIni(f_blnAddAutoAtTop0)

; === MenuIcons ===

o_Settings.MenuIcons.blnDisplayIcons.WriteIni(f_blnDisplayIcons)
o_Settings.MenuIcons.intIconSize.WriteIni(f_drpIconSize)
o_Settings.MenuIcons.intIconsManageRowsSettings.WriteIni(f_intIconsManageRowsSettings)
o_Settings.MenuIcons.blnRetrieveIconInFrequentMenus.WriteIni(f_blnRetrieveIconInFrequentMenus)
o_Settings.MenuIcons.strIconReplacementList.WriteIni(OptionsListCleanup(f_strIconReplacementList))
o_JLicons.ProcessReplacements(o_Settings.MenuIcons.strIconReplacementList.IniValue)

; === MenuAppearance ===

if (f_radHotkeyReminders1)
	o_Settings.Menu.intHotkeyReminders.IniValue := 1
else if (f_radHotkeyReminders2)
	o_Settings.Menu.intHotkeyReminders.IniValue := 2
else
	o_Settings.Menu.intHotkeyReminders.IniValue := 3
o_Settings.Menu.intHotkeyReminders.WriteIni("", true) ; value already updated

o_Settings.Menu.blnHotkeyRemindersRightAlign.WriteIni(f_blnHotkeyRemindersRightAlign)
o_Settings.Menu.blnDisplayNumericShortcuts.WriteIni(f_blnDisplayNumericShortcuts)
o_Settings.Menu.blnDisplayNumericShortcutsFromOne.WriteIni(f_blnDisplayNumericShortcutsFromOne)
o_Settings.Menu.intRecentFoldersMax.WriteIni(f_intRecentFoldersMax)
o_Settings.Menu.intNbLastActions.WriteIni(f_intNbLastActions)
o_Settings.Menu.blnAddCloseToDynamicMenus.WriteIni(f_blnAddCloseToDynamicMenus)

; === PopupMenu ===

if (f_radPopupMenuPosition1)
	o_Settings.MenuPopup.intPopupMenuPosition.IniValue := 1
else if (f_radPopupMenuPosition2)
	o_Settings.MenuPopup.intPopupMenuPosition.IniValue := 2
else
	o_Settings.MenuPopup.intPopupMenuPosition.IniValue := 3
o_Settings.MenuPopup.intPopupMenuPosition.WriteIni("", true) ; value already updated in previous lines

o_Settings.MenuPopup.arrPopupFixPosition.IniValue[1] := f_intPopupFixPositionX
o_Settings.MenuPopup.arrPopupFixPosition.IniValue[2] := f_intPopupFixPositionY
; write text value to ini file
o_Settings.MenuPopup.arrPopupFixPosition.WriteIni(f_intPopupFixPositionX . "," . f_intPopupFixPositionY)
; but restore object array in class object
o_Settings.MenuPopup.arrPopupFixPosition.IniValue := StrSplit(o_Settings.MenuPopup.arrPopupFixPosition.IniValue, ",")

if !(g_blnPortableMode)
{
	if (f_blnExplorerContextMenus) and (!o_Settings.MenuPopup.blnExplorerContextMenus.IniValue)
		gosub, EnableExplorerContextMenus
		; else already enabled
	if (!f_blnExplorerContextMenus) and (o_Settings.MenuPopup.blnExplorerContextMenus.IniValue)
		gosub, DisableExplorerContextMenus
		; else already disabled
	o_Settings.MenuPopup.blnExplorerContextMenus.WriteIni("", true) ; value already updated in EnableExplorerContextMenus or DisableExplorerContextMenus
}

o_Settings.MenuPopup.blnRefreshedMenusAttached.WriteIni(f_blnRefreshedMenusAttached)
; next line re-init o_QAPfeatures according to o_Settings.MenuPopup.blnRefreshedMenusAttached.IniValue before rebuilding the menus
o_QAPfeatures.RefreshAttachedOrDetachedQAPFeatureObject()

; ExclusionList
o_Settings.MenuPopup.strExclusionMouseList.WriteIni(OptionsListCleanup(f_strExclusionMouseList))
o_Settings.MenuPopup.strExclusionMouseList.SplitExclusionList()

; === PopupHotkeys ===

for intThisIndex, objThisPopupHotkey in o_PopupHotkeys.SA
	o_Settings.MenuPopup["str" . objThisPopupHotkey.AA.strPopupHotkeyInternalName].WriteIni(objThisPopupHotkey.P_strAhkHotkey)
o_PopupHotkeys.EnablePopupHotkeys()
o_Settings.MenuPopup.blnLeftControlDoublePressed.WriteIni(f_blnLeftControlDoublePressed)
o_Settings.MenuPopup.blnRightControlDoublePressed.WriteIni(f_blnRightControlDoublePressed)
intThisIndex := ""

; === PopupHotkeysAlternative ===

IniDelete, % o_Settings.strIniFile, AlternativeMenuHotkeys
for strThisAlternativeCode, strNewShortcut in o_QAPfeatures.aaQAPFeaturesNewShortcuts
	if HasShortcut(strNewShortcut)
		o_Settings.MenuPopup["str" . strThisAlternativeCode].WriteIni(strNewShortcut)

Gosub, LoadIniAlternativeMenuFeaturesHotkeys ; reload from ini file
Gosub, BuildAlternativeMenu
o_Settings.MenuPopup.blnAlternativeMenuShowNotification.WriteIni(f_blnAlternativeMenuShowNotification)

strThisAlternativeCode := ""
strNewShortcut := ""

; === FileManagers ===

o_Settings.FileManagers.intActiveFileManager.WriteIni(g_intClickedFileManager)
o_Settings.FileManagers.blnAlwaysNavigate.WriteIni(f_radFileManagerNavigateCurrent)
	
strClickedFileManagerSystemName := o_FileManagers.SA[g_intClickedFileManager].AA.strFileManagerSystemName

if (g_intClickedFileManager = 1)
	o_Settings.FileManagers.blnExplorerOpenFavoritesOnActiveMonitor.WriteIni(f_blnOpenFavoritesOnActiveMonitor)
else if (g_intClickedFileManager = 4) ; QAPconnect
	o_Settings.FileManagers.AA.strQAPconnectFileManager.WriteIni(f_drpQAPconnectFileManager)
else if (g_intClickedFileManager > 1) ; 2 DirectoryOpus or 3 TotalCommander
{
	o_Settings.FileManagers["str" . strClickedFileManagerSystemName . "Path"].WriteIni(f_strFileManagerPath)
	o_Settings.FileManagers["bln" . strClickedFileManagerSystemName . "UseTabs"].WriteIni(f_blnFileManagerUseTabs)
	
	if (g_intClickedFileManager = 2) ; DirectoryOpus
	{
		if (f_blnFileManagerUseTabs)
			strClickedNewTabOrWindow := "NEWTAB" ; open new folder in a new lister tab
		else
			strClickedNewTabOrWindow := "NEW" ; open new folder in a new DOpus lister (instance)
		
		o_Settings.FileManagers.blnDirectoryOpusShowLayouts.WriteIni(f_blnFileManagerDirectoryOpusShowLayouts)
	}
	else ; TotalCommander
	{
		if (f_blnFileManagerUseTabs)
			strClickedNewTabOrWindow := "/O /T" ; open new folder in a new tab
		else
			strClickedNewTabOrWindow := "/N" ; open new folder in a new window (TC instance)
		
		o_Settings.FileManagers.strTotalCommanderWinCmd.WriteIni(f_strTotalCommanderWinCmd)
	}
	; remove: IniWrite, %strClickedNewTabOrWindow%, % o_Settings.strIniFile, Global, %strClickedFileManagerSystemName%NewTabOrWindow
	; IniRead could be kept in FileManagers init to allow user to customize "NEWTAB" or "NEW" (for DOpus), "/O /T" or "/N" (for TC)
}

; Re-init class for FileManagers, reloading ini values
o_FileManagers := new FileManagers ; declared global earlier
strClickedFileManagerSystemName := ""

; === Snippets ===

o_Settings.Snippets.blnSnippetDefaultProcessEOLTab.WriteIni(f_blnSnippetDefaultProcessEOLTab)
o_Settings.Snippets.blnSnippetDefaultFixedFont.WriteIni(f_blnSnippetDefaultFixedFont)
o_Settings.Snippets.intSnippetDefaultFontSize.WriteIni(f_intSnippetDefaultFontSizeEdit)
o_Settings.Snippets.blnSnippetDefaultMacro.WriteIni(f_blnSnippetDefaultMacro)

; === UserVariables ===

o_Settings.UserVariables.strUserVariablesList.WriteIni(OptionsListCleanup(f_strUserVariablesList))

; === Database ===

intUsageDbIntervalSecondsPrev := o_Settings.Database.intUsageDbIntervalSeconds.IniValue
o_Settings.Database.intUsageDbIntervalSeconds.WriteIni(f_blnOptionUsageDbEnable ? (f_intUsageDbIntervalSeconds < 60 ? 60 : f_intUsageDbIntervalSeconds) : 0)

intUsageDbDaysInPopularPrev := o_Settings.Database.intUsageDbDaysInPopular.IniValue
o_Settings.Database.intUsageDbDaysInPopular.WriteIni(f_intUsageDbDaysInPopular < 1 ? 1 : f_intUsageDbDaysInPopular)
f_fltUsageDbMaximumSize := StrReplace(f_fltUsageDbMaximumSize, ",", ".") ;  convert 1,5 to 1.5
if f_fltUsageDbMaximumSize is not Number
	blnNotANumber := true
if (blnNotANumber or f_fltUsageDbMaximumSize <= 0)
	Oops(o_L["OptionsUsageDbMaximumSizeInvalid"], f_fltUsageDbMaximumSize)
else
	o_Settings.Database.fltUsageDbMaximumSize.WriteIni(f_fltUsageDbMaximumSize)
o_Settings.Database.blnUsageDbShowPopularityIndex.WriteIni(f_blnOptionUsageDbEnable ? f_blnUsageDbShowPopularityIndex : false)

blnUseSQLitePrev := g_blnUsageDbEnabled
g_blnUsageDbEnabled := (o_Settings.Database.intUsageDbIntervalSeconds.IniValue > 0)
if (!blnUseSQLitePrev and g_blnUsageDbEnabled)
	gosub, UsageDbInit
if (intUsageDbIntervalSecondsPrev <> o_Settings.Database.intUsageDbIntervalSeconds.IniValue)
	or (intUsageDbDaysInPopularPrev <> o_Settings.Database.intUsageDbDaysInPopular.IniValue)
	Oops(o_L["OptionsUsageDbDisabling"], g_strAppNameText)

; preprocess these dynamic menus
Gosub, DynamicMenusPreProcess ; in case the number of items in Frequent and Recent menus was changed in Options
Gosub, LoadMenuInGui ; in case show popularity index changed

intUsageDbIntervalSecondsPrev := ""
intUsageDbDaysInPopularPrev := ""
blnUseSQLitePrev := ""
strQAPconnectPath := ""

; === MenuAdvanced ===

o_Settings.MenuPopup.blnOpenMenuOnTaskbar.WriteIni(f_blnOpenMenuOnTaskbar)
o_Settings.MenuAdvanced.intRefreshQAPMenuIntervalSec.WriteIni(f_blnRefreshQAPMenuEnable ? f_intRefreshQAPMenuIntervalSec : 0)
o_Settings.MenuAdvanced.blnRefreshQAPMenuDebugBeep.WriteIni(f_blnRefreshQAPMenuDebugBeep)
o_Settings.MenuAdvanced.intNbLiveFolderItemsMax.WriteIni(f_intNbLiveFolderItemsMax)
o_Settings.MenuAdvanced.intClipboardMaxSize.WriteIni(f_intClipboardMaxSize)

if (o_Settings.MenuAdvanced.intRefreshQAPMenuIntervalSec.IniValue > 0)
	SetTimer, RefreshQAPMenuScheduled, % o_Settings.MenuAdvanced.intRefreshQAPMenuIntervalSec.IniValue * 1000
else if (o_Settings.MenuAdvanced.intRefreshQAPMenuIntervalSec.IniValue = 0)
	SetTimer, RefreshQAPMenuScheduled, Off

; === AdvancedLaunch ===

blnRunAsAdminPrev := o_Settings.LaunchAdvanced.blnRunAsAdmin.IniValue
o_Settings.LaunchAdvanced.blnRunAsAdmin.WriteIni(f_blnRunAsAdmin)
if (blnRunAsAdminPrev <> o_Settings.LaunchAdvanced.blnRunAsAdmin.IniValue)
	Oops(o_L["OptionsRunAsAdminChanged"], g_strAppNameText)
o_Settings.LaunchAdvanced.blnRefreshWindowsAppsListAtStartup.WriteIni(f_blnRefreshWindowsAppsListAtStartup)
o_Settings.LaunchAdvanced.strAlternativeTrayIcon.WriteIni(f_strAlternativeTrayIcon)
blnRunAsAdminPrev := ""
	
; === AdvancedOther ===

o_Settings.DialogBoxes.intWaitDelayInDialogBox.WriteIni(f_intWaitDelayInDialogBox)
o_Settings.Execution.blnSendToConsoleWithAlt.WriteIni(f_blnSendToConsoleWithAlt)
o_Settings.SettingsFile.strExternalMenusCataloguePath.WriteIni(f_strExternalMenusCataloguePath)
o_Settings.Hotstrings.strHotstringsDefaultOptions.WriteIni(strNewHotstringsDefaultOptions)
o_Settings.Snippets.arrWaitDelayInSnippet.WriteIni(f_intWaitDelayInSnippet1 . "|" . f_intWaitDelayInSnippet2 . "|" . f_intWaitDelayInSnippet3)
o_Settings.Snippets.arrWaitDelayInSnippet.IniValue := StrSplit(o_Settings.Snippets.arrWaitDelayInSnippet.IniValue, "|")
o_Settings.Execution.strSwitchExclusionList.WriteIni(OptionsListCleanup(f_strSwitchExclusionList))
strNewHotstringsDefaultOptions := ""

; === Save new Working Folder in current user registry entry and update o_Settings.strIniFile

if (!g_blnPortableMode) ; Working folder (only for Setup installation)
{
	if (strWorkingFolderNew <> strWorkingFolderPrev)
	{
		blnSettingsMoveOK := true
		
		if (blnMoveSettingsToNewWorkingFolder) ; asked in the validation section above
		{
			; if blnMoveSettingsToNewWorkingFolder and BackupFolder is in the working folder change value to new working folder - must be done before FileCopyDir 
			if (o_Settings.SettingsFile.strBackupFolder.IniValue = strWorkingFolderPrev)
				o_Settings.SettingsFile.strBackupFolder.WriteIni(strWorkingFolderNew)
			
			FileCopyDir, %strWorkingFolderPrev%, %strWorkingFolderNew%, 1
			
			FileGetSize, intSettingsSizePrev, %strWorkingFolderPrev%\%g_strAppNameFile%.ini
			FileGetSize, intSettingsSize, %strWorkingFolderNew%\%g_strAppNameFile%.ini
			
			; could also use ComObjCreate("Scripting.FileSystemObject").GetFolder(A_MyDocuments).Files.Count
			intSettingsFilesNbPrev := ComObjCreate("Shell.Application").NameSpace(strWorkingFolderPrev).Items.Count ;  in root folder only, does not recurse
			intSettingsFilesNb := ComObjCreate("Shell.Application").NameSpace(strWorkingFolderNew).Items.Count
			
			; check if settings file is good and if all files were copied in root folder (use > in case the destination folder already contained files)
			blnSettingsMoveOK := (intSettingsSizePrev = intSettingsSize and intSettingsFilesNbPrev <= intSettingsFilesNb) ; copy successful
			
			if (blnSettingsMoveOK)
				MsgBox, 0, %g_strAppNameText%, % L(o_L["DialogMoveSettingsSuccess"], strWorkingFolderPrev, strWorkingFolderNew, g_strAppNameText)
			else
			{
				Oops(o_L["DialogMoveSettingsFail"])
				if (o_Settings.SettingsFile.strBackupFolder.IniValue = strWorkingFolderNew) ; reset backup folder
					o_Settings.SettingsFile.strBackupFolder.WriteIni(strWorkingFolderPrev)
			}
		}
		
		if (blnSettingsMoveOK)
		{
			SetRegistry(strWorkingFolderNew, "HKEY_CURRENT_USER\Software\Jean Lalonde\" . g_strAppNameText, "WorkingFolder") ; save expanded to registry
			o_Settings.strIniFile := strWorkingFolderNew . "\" . g_strAppNameFile . ".ini"
			; QAP will reload with new A_WorkingDir at the end of save
		}
	}
}

; === Need to restart QAP for new working folder

if (strWorkingFolderPrev <> strWorkingFolderNew and blnSettingsMoveOK)
{
	Oops(o_L["DialogMoveSettingsReload"], g_strAppNameText)
	Gosub, ReloadQAP
}

; === Optional restart if language, theme or temporary folder changed

if (strLanguageCodePrev <> o_Settings.Launch.strLanguageCode.IniValue)
	or (strThemePrev <> o_Settings.Launch.strTheme.IniValue)
	or (strQAPTempFolderParentPrev <> o_Settings.Launch.strQAPTempFolderParent.IniValue)
{
	if (strLanguageCodePrev <> o_Settings.Launch.strLanguageCode.IniValue)
	{
		strOption := o_L["OptionsLanguage"]
		strValue := g_strLanguageLabel
	}
	else if (strThemePrev <> o_Settings.Launch.strTheme.IniValue)
	{
		strOption := o_L["OptionsTheme"]
		strValue := o_Settings.Launch.strTheme.IniValue
	}
	else ; (strQAPTempFolderParentPrev <> o_Settings.Launch.strQAPTempFolderParent.IniValue)
	{
		strOption := o_L["OptionsQAPTempFolder"]
		strValue := o_Settings.Launch.strQAPTempFolderParent.IniValue
	}

	MsgBox, 52, %g_strAppNameText%, % L(o_L["ReloadPrompt"], strOption, """" . strValue . """", g_strAppNameText)
	IfMsgBox, Yes
		Gosub, ReloadQAP
	else ; if user declines to reload, restore previous value (but new value will be loaded at next launch)
	{
		if (strLanguageCodePrev <> o_Settings.Launch.strLanguageCode.IniValue)
			o_Settings.Launch.strLanguageCode.IniValue := strLanguageCodePrev
		else if (strThemePrev <> o_Settings.Launch.strTheme.IniValue)
			o_Settings.Launch.strTheme.IniValue := strThemePrev
		else ; (strQAPTempFolderParentPrev <> o_Settings.Launch.strQAPTempFolderParent.IniValue)
			o_Settings.Launch.strQAPTempFolderParent.IniValue := strQAPTempFolderParentPrev
	}
}

g_blnGroupChanged := false
Gosub, 2GuiClose

; rebuild Folders menus w/ or w/o optional folders and shortcuts
for strMenuName, arrMenu in g_objMenusIndex
{
	Menu, %strMenuName%, Add
	Menu, %strMenuName%, DeleteAll
	ResetArray("arrMenu") ; free object's memory
}
strMenuName := ""
ResetArray("arrMenu")

Gosub, BuildMainMenuWithStatus
Gosub, BuildGuiMenuBar
Gosub, BuildTrayMenuRefresh

g_blnMenuReady := true

strLanguageCodePrev := ""
strThemePrev := ""
strQAPTempFolderParentPrev := ""
strOption := ""
strValue := ""
aaL := ""
intSettingsSize := ""
intSettingsSizePrev := ""
blnSettingsMoveOK := ""
strWorkingFolderNew := ""
strBackupFolderNew := ""
strTempFolderNew := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiOptionsHeader:
;------------------------------------------------------------

; Build Gui header
g_strOptionsGuiTitle := L(o_L["OptionsGuiTitle"], g_strAppNameText, g_strAppVersion)
Gui, 2:New, +Hwndg_strGui2Hwnd, %g_strOptionsGuiTitle%
if (g_blnUseColors)
	Gui, 2:Color, %g_strGuiWindowColor%
Gui, 2:+Owner1

intMaxWidth := 0
for intKey, strGroup in o_Settings.saOptionsGroups
{
	Gui, 2:Add, Button, % "x10 y" . (intKey = 1 ? "+15" : "p+22") . " gGuiOptionsGroupButtonClicked vf_btnOptionsGroup" . strGroup , % aaL[o_Settings.saOptionsGroupsLabelNames[intKey]]
	GuiControlGet, arrPos, Pos, % "f_btnOptionsGroup" . strGroup
	if (arrPosW > intMaxWidth) ; get max control width to get X of group items
		intMaxWidth := arrPosW
}
g_intOptionsFooterY := arrPosY + arrPosH

for intKey, strGroup in o_Settings.saOptionsGroups ; same max width for all buttons
	GuiControl, Move, % "f_btnOptionsGroup" . strGroup, w%intMaxWidth%

g_intGroupItemsX := intMaxWidth + 30
g_intGroupItemsTab1X := g_intGroupItemsX + 10
g_intGroupItemsTab2X := g_intGroupItemsX + 20
g_intGroupItemsTab3X := g_intGroupItemsX + 120
g_intGroupItemsTab4X := g_intGroupItemsX + 240
intGroupItemsY := 40 ; Y position of first item of a group

Gui, 2:Font, s10 w700, Verdana
Gui, 2:Add, Text, x%g_intGroupItemsX% y10 w595 center vf_lblOptionsGuiTitle
Gui, 2:Font

strGroup := ""
ResetArray("arrPos")
intMaxWidth := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiOptionsFooter:
;------------------------------------------------------------

g_intOptionsFooterY += 20 ; place buttons below highest options group

Gui, 2:Add, Button, x10 y%g_intOptionsFooterY% vf_btnOptionsSave gGuiOptionsGroupSave disabled Default, % aaL["GuiSave"]
Gui, 2:Add, Button, yp vf_btnOptionsCancel gButtonOptionsCancel, % aaL["GuiCancel"]
if (!o_Settings.Launch.blnDonor.IniValue)
	Gui, 2:Add, Button, yp vf_btnOptionsDonate gGuiDonate, % o_L["DonateButton"]
GuiCenterButtons(g_strOptionsGuiTitle, 10, 5, 20, "f_btnOptionsSave", "f_btnOptionsCancel", (!o_Settings.Launch.blnDonor.IniValue ? "f_btnOptionsDonate" : ""))

Gui, 2:Add, Text
GuiControl, Focus, f_btnOptionsSave

Gosub, GuiOptionsGroupButtonClicked
Gosub, ShowGui2AndDisableGui1

g_intGroupItemsX := ""
g_intGroupItemsTab1X := ""
g_intGroupItemsTab2X := ""
g_intGroupItemsTab3X := ""
g_intGroupItemsTab4X := ""
intGroupItemsY := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiOptionsGroupButtonClicked:
;------------------------------------------------------------

if StrLen(A_GuiControl) or StrLen(strGotoGroup)
{
	strSettingsGroupPrev := g_strSettingsGroup
	g_strSettingsGroup := (StrLen(strGotoGroup) ? strGotoGroup : StrReplace(A_GuiControl, "f_btnOptionsGroup"))
}

GuiControl, -Default, % "f_btnOptionsGroup" . strSettingsGroupPrev ; will work even if A_GuiControl is empty
GuiControl, +Default, % "f_btnOptionsGroup" . g_strSettingsGroup ; will work even if A_GuiControl is empty

if (strSettingsGroupPrev = g_strSettingsGroup)
	return

loop, Parse, % strSettingsGroupPrev . "|" . g_strSettingsGroup, |
	if StrLen(A_LoopField)
		for intKey, aaIniValue in o_Settings.aaGroupItems[A_LoopField]
			for intControlKey, strGuiControl in StrSplit(aaIniValue.strGuiControls, "|")
				if StrLen(strGuiControl)
					GuiControl, % (A_LoopField = strSettingsGroupPrev ? "Hide" : "Show"), %strGuiControl%
ToolTip

GuiControl, , f_lblOptionsGuiTitle, % L(o_L["Options" . g_strSettingsGroup] . " - " . o_L["OptionsGuiTitle"], g_strAppNameText)

Gosub, ActiveFileManagerClickedGroupButton

strSettingsGroupPrev := ""
strGotoGroup := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiOptionsGroupChanged:
;------------------------------------------------------------

g_blnGroupChanged := true
GuiControl, % "2:" . (g_blnGroupChanged ? "Enable" : "Disable"), f_btnOptionsSave

return
;------------------------------------------------------------


;------------------------------------------------------------
ButtonOptionsCancel:
;------------------------------------------------------------

Gosub, 2GuiClose

return
;------------------------------------------------------------


;------------------------------------------------------------
ActiveFileManagerClicked:
ActiveFileManagerClickedInit:
ActiveFileManagerClickedGroupButton:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

if (A_ThisLabel = "ActiveFileManagerClicked")
	Gosub, GuiOptionsGroupChanged

strShowHideCommand := (f_radActiveFileManager1 and g_strSettingsGroup = "FileManagers" ? "Show" : "Hide")
GuiControl, %strShowHideCommand%, f_blnOpenFavoritesOnActiveMonitor

strShowHideCommand := (f_radActiveFileManager1 or g_strSettingsGroup <> "FileManagers" ? "Hide" : "Show")
GuiControl, %strShowHideCommand%, f_lblFileManagerDetail
GuiControl, %strShowHideCommand%, f_lblFileManagerPrompt
; GuiControl, %strShowHideCommand%, f_lnkFileManagerHelp

strShowHideCommand := (f_radActiveFileManager1 or f_radActiveFileManager4 or g_strSettingsGroup <> "FileManagers" ? "Hide" : "Show")
GuiControl, %strShowHideCommand%, f_blnFileManagerUseTabs
GuiControl, %strShowHideCommand%, f_btnFileManagerPath
GuiControl, %strShowHideCommand%, f_strFileManagerPath

strShowHideCommand := (!f_radActiveFileManager2 or g_strSettingsGroup <> "FileManagers" ? "Hide" : "Show")
GuiControl, %strShowHideCommand%, f_blnFileManagerDirectoryOpusShowLayouts

strShowHideCommand := (!f_radActiveFileManager3 or g_strSettingsGroup <> "FileManagers" ? "Hide" : "Show")
GuiControl, %strShowHideCommand%, f_btnTotalCommanderWinCmd
GuiControl, %strShowHideCommand%, f_lblTotalCommanderWinCmdPrompt
GuiControl, %strShowHideCommand%, f_strTotalCommanderWinCmd

strShowHideCommand := (!f_radActiveFileManager4 or g_strSettingsGroup <> "FileManagers" ? "Hide" : "Show")
GuiControl, %strShowHideCommand%, f_btnQAPconnectEdit
GuiControl, %strShowHideCommand%, f_btnQAPconnectRefresh
GuiControl, %strShowHideCommand%, f_drpQAPconnectFileManager

if InStr(A_ThisLabel, "GroupButton")
	return ; no need to change remaining values and avoid unexpected GuiOptionsGroupChanged

if (f_radActiveFileManager2) ; DirectoryOpus
{
	g_intClickedFileManager := 2
	strHelpUrl := "https://www.quickaccesspopup.com/how-to-i-enable-directory-opus-support-in-quick-access-popup/"
}
else if (f_radActiveFileManager3) ; TotalCommander
{
	g_intClickedFileManager := 3
	strHelpUrl := "https://www.quickaccesspopup.com/how-do-i-enable-total-commander-support-in-quick-access-popup/"
}
else if (f_radActiveFileManager4) ; QAPconnect
{
	g_intClickedFileManager := 4
	strHelpUrl := "https://www.quickaccesspopup.com/what-file-managers-are-supported-in-addition-to-windows-explorer/"
}
else ; f_radActiveFileManager1
{
	g_intClickedFileManager := 1
	strHelpUrl := "https://www.quickaccesspopup.com/how-does-qap-work-on-multi-monitor-systems/"
}

GuiControl, , f_lnkFileManagerHelp, % L(o_L["OptionsThirdPartySelectedHelp"], o_FileManagers.SA[g_intClickedFileManager].AA.strDisplayName, strHelpUrl, o_L["GuiHelp"])
if !(f_radActiveFileManager1) ; DirectoryOpus, TotalCommander or QAPconnect
{
	GuiControl, , f_lblFileManagerDetail, % (f_radActiveFileManager4 ? L(o_L["OptionsThirdPartyDetailQAPconnect"], "QAPconnect.ini")
		: L(o_L["OptionsThirdPartyDetail"], o_FileManagers.SA[g_intClickedFileManager].AA.strDisplayName))
	GuiControl, , f_strFileManagerPath, % o_FileManagers.SA[g_intClickedFileManager].AA.strFileManagerPath ; was the cause of the group changed flag bug

	if (f_radActiveFileManager4) ; QAPconnect
	{
		IniRead, strQAPconnectFileManagersList, % g_aaFileManagerQAPconnect.strQAPconnectIniPath, , , %A_Space% ; list of QAPconnect.ini applications, empty by default
		if StrLen(strQAPconnectFileManagersList)
		{
			strQAPconnectFileManagersList .= "|"
			strQAPconnectFileManagersList := StrReplace(strQAPconnectFileManagersList, "`n", "|")
			if StrLen(g_aaFileManagerQAPconnect.strQAPconnectFileManager)
				strQAPconnectFileManagersList := StrReplace(strQAPconnectFileManagersList, g_aaFileManagerQAPconnect.strQAPconnectFileManager . "|"
					, g_aaFileManagerQAPconnect.strQAPconnectFileManager . "||")
		}
		GuiControl, , f_drpQAPconnectFileManager, |%strQAPconnectFileManagersList%
	}
	else ; DirectoryOpus or TotalCommander

		GuiControl, , f_blnFileManagerUseTabs, % (o_FileManagers.SA[g_intClickedFileManager].AA.blnFileManagerUseTabs ? 1 : 0)

	if (f_radActiveFileManager3) ; TotalCommander
		GuiControl, , f_strTotalCommanderWinCmd, % g_aaFileManagerTotalCommander.strTCIniFile
}

strHelpUrl := ""
strQAPconnectFileManagersList := ""
strShowHideCommand := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
FileManagerNavigateClicked:
FileManagerNavigateClickedInit:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

if (A_ThisLabel = "FileManagerNavigateClicked")
	Gosub, GuiOptionsGroupChanged

GuiControl, , f_lblFileManagerNavigate, % L(o_L["OptionsFileManagerNavigateIntro"], o_FileManagers.SA[g_intClickedFileManager].AA.strDisplayName)
GuiControl, Text, f_radFileManagerNavigateCurrent, % L((f_blnFileManagerUseTabs ? o_L["OptionsFileManagerNavigateCurrentTab"] : o_L["OptionsFileManagerNavigateCurrent"])
	, o_FileManagers.SA[g_intClickedFileManager].AA.strDisplayName)
GuiControl, Text, f_radFileManagerNavigateNew, % L((f_blnFileManagerUseTabs ? o_L["OptionsFileManagerNavigateNewTab"] : o_L["OptionsFileManagerNavigateNew"])
	, o_FileManagers.SA[g_intClickedFileManager].AA.strDisplayName)

return
;------------------------------------------------------------


;------------------------------------------------------------
DisplayIconsClicked:
DisplayIconsClickedInit:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

if (A_ThisLabel = "DisplayIconsClicked")
	Gosub, GuiOptionsGroupChanged

strEnableDisableCommand := (f_blnDisplayIcons ? "Enable" : "Disable")
GuiControl, %strEnableDisableCommand%, f_lblIconSize
GuiControl, %strEnableDisableCommand%, f_drpIconSize
GuiControl, %strEnableDisableCommand%, f_intIconsManageRowsSettingsEdit
GuiControl, %strEnableDisableCommand%, f_intIconsManageRowsSettings
GuiControl, %strEnableDisableCommand%, f_lblIconsManageRows
GuiControl, %strEnableDisableCommand%, f_blnRetrieveIconInFrequentMenus
strEnableDisableCommand := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
RefreshQAPMenuEnableClicked:
RefreshQAPMenuEnableClickedInit:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

if (A_ThisLabel = "RefreshQAPMenuEnableClicked")
	Gosub, GuiOptionsGroupChanged

if (f_blnRefreshQAPMenuEnable and o_Settings.MenuAdvanced.intRefreshQAPMenuIntervalSec.IniValue = 0)
	GuiControl, , f_intRefreshQAPMenuIntervalSec, 300 ; proposed value when enabled

strEnableDisableCommand := (f_blnRefreshQAPMenuEnable ? "Enable" : "Disable")
GuiControl, %strEnableDisableCommand%, f_intRefreshQAPMenuIntervalSecEdit
GuiControl, %strEnableDisableCommand%, f_intRefreshQAPMenuIntervalSec
GuiControl, %strEnableDisableCommand%, f_lblRefreshQAPMenuIntervalSec
GuiControl, %strEnableDisableCommand%, f_blnRefreshQAPMenuDebugBeep

strEnableDisableCommand := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
PopupMenuPositionClicked:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

Gosub, GuiOptionsGroupChanged

strEnableDisableCommand := (f_radPopupMenuPosition3 ? "Enable" : "Disable")

GuiControl, %strEnableDisableCommand%, f_lblPopupFixPositionX
GuiControl, %strEnableDisableCommand%, f_intPopupFixPositionXEdit
GuiControl, %strEnableDisableCommand%, f_intPopupFixPositionX
GuiControl, %strEnableDisableCommand%, f_lblPopupFixPositionY
GuiControl, %strEnableDisableCommand%, f_intPopupFixPositionYEdit
GuiControl, %strEnableDisableCommand%, f_intPopupFixPositionY

strEnableDisableCommand := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
OptionsTitlesDescriptionClicked:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

; GuiControl, Choose, f_intOptionsTab, 6
strGotoGroup := "PopupMenu"
Gosub, GuiOptionsGroupButtonClicked

return
;------------------------------------------------------------


;------------------------------------------------------------
RunAsAdminClicked:
;------------------------------------------------------------
Gui, 2:Submit, NoHide
Gui, 2:+OwnDialogs

Gosub, GuiOptionsGroupChanged

if (f_blnRunAsAdmin)
	MsgBox, 48, % L(o_L["OopsTitle"], g_strAppNameText, g_strAppVersion), % L(o_L["OptionsRunAsAdminAlert"], g_strAppNameText)

return
;------------------------------------------------------------


;------------------------------------------------------------
ButtonOptionsChangeShortcut1:
ButtonOptionsChangeShortcut2:
ButtonOptionsChangeShortcut3:
ButtonOptionsChangeShortcut4:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

intHotkeyIndex := StrReplace(A_ThisLabel, "ButtonOptionsChangeShortcut")

if InStr(o_PopupHotkeys.SA[intHotkeyIndex].AA.strPopupHotkeyInternalName, "Mouse")
	intHotkeyType := 1 ; Mouse
else
	intHotkeyType := 2 ; Keyboard

strPopupHotkeysLocalBackup := o_PopupHotkeys.SA[intHotkeyIndex].P_strAhkHotkey
strNewHotkey := SelectShortcut(o_PopupHotkeys.SA[intHotkeyIndex].P_strAhkHotkey, o_PopupHotkeys.SA[intHotkeyIndex].AA.strPopupHotkeyLocalizedName
	, "", "", intHotkeyType, o_PopupHotkeys.SA[intHotkeyIndex].AA.strPopupHotkeyDefault, o_PopupHotkeys.SA[intHotkeyIndex].AA.strPopupHotkeyLocalizedDescription)
o_PopupHotkeys.SA[intHotkeyIndex].P_strAhkHotkey := strNewHotkey

if StrLen(o_PopupHotkeys.SA[intHotkeyIndex].P_strAhkHotkey)
{
	GuiControl, 2:, f_lblHotkeyText%intHotkeyIndex%, % o_PopupHotkeys.SA[intHotkeyIndex].AA.strPopupHotkeyTextShort
	Gosub, GuiOptionsGroupChanged
}
else
	o_PopupHotkeys.SA[intHotkeyIndex].P_strAhkHotkey := strPopupHotkeysLocalBackup
	
strPopupHotkeysLocalBackup := ""
strNewHotkey := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
ButtonOptionsChangeAlternativeHotkey:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

intAlternativeOrder := StrReplace(A_GuiControl, "f_lblAlternativeHotkeyText")
intAlternativeOrder := StrReplace(intAlternativeOrder, "f_btnChangeAlternativeHotkey")

strThisAlternativeCode := o_QAPfeatures.saQAPFeaturesAlternativeCodeByOrder[intAlternativeOrder]
objThisAlternative := o_QAPfeatures.AA[strThisAlternativeCode]
strAlternativeHotkeysBackup := o_QAPfeatures.aaQAPFeaturesNewShortcuts[strThisAlternativeCode]

; .strLocalizedName OK because Alternative
o_QAPfeatures.aaQAPFeaturesNewShortcuts[strThisAlternativeCode] := SelectShortcut(o_QAPfeatures.aaQAPFeaturesNewShortcuts[strThisAlternativeCode], objThisAlternative.strLocalizedName, o_L["DialogHotkeysManageAlternative"]
	, "", 3, objThisAlternative.strDefaultShortcut)

if StrLen(o_QAPfeatures.aaQAPFeaturesNewShortcuts[strThisAlternativeCode])
{
	GuiControl, 2:, f_lblAlternativeHotkeyText%intAlternativeOrder%, % new Triggers.HotkeyParts(o_QAPfeatures.aaQAPFeaturesNewShortcuts[strThisAlternativeCode]).Hotkey2Text()
	Gosub, GuiOptionsGroupChanged
}
else
	o_QAPfeatures.aaQAPFeaturesNewShortcuts[strThisAlternativeCode] := strAlternativeHotkeysBackup

intAlternativeOrder := ""
strThisAlternativeCode := ""
strAlternativeHotkeysBackup := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
ChangeFoldersInDialogClicked:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

Gosub, GuiOptionsGroupChanged

if !(f_blnChangeFolderInDialog)
	return
GuiControl, 2:, f_blnChangeFolderInDialog, 0

g_intGui2WinID := WinExist("A")

strGuiTitle := StrReplace(o_L["OptionsChangeFolderInDialog"], "&", "")
Gui, 3:New, +Hwndg_strGui3Hwnd, %strGuiTitle%
Gui, 3:+Owner2

if (g_blnUseColors)
	Gui, 3:Color, %g_strGuiWindowColor%
Gui, 3:Font, s10 w700, Verdana
Gui, 3:Add, Text, x10 y10 w400, % o_L["OptionsChangeFolderInDialog"]
Gui, 3:Font
Gui, 3:Add, Text, x10 w400, % o_L["OptionsChangeFolderInDialogText"]
Gui, 3:Add, Text, x10 w400, % o_L["OptionsChangeFolderInDialogCheckbox"]

Gui, 3:Add, Button, y+25 x10 vf_btnChangeFolderInDialogOK gChangeFoldersInDialogOK, % o_L["DialogOK"]
Gui, 3:Add, Button, yp x+20 vf_btnChangeFolderInDialogCancel gChangeFoldersInDialogCancel, % o_L["GuiCancel"]
	
GuiCenterButtons(strGuiTitle, 10, 5, 20, "f_btnChangeFolderInDialogOK", "f_btnChangeFolderInDialogCancel")

GuiControl, Focus, f_btnChangeFolderInDialogCancel
CalculateTopGuiPosition(g_strGui3Hwnd, g_strGui2Hwnd, intX, intY)
Gui, 3:Show, AutoSize x%intX% y%intY%
Gui, 2:+Disabled

strGuiTitle := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
ChangeFoldersInDialogOK:
ChangeFoldersInDialogCancel:
;------------------------------------------------------------
Gui, 3:Submit, NoHide

if (A_ThisLabel = "ChangeFoldersInDialogOK")
{
	GuiControl, 2:, f_blnChangeFolderInDialog, 1
	IniWrite, 1, % o_Settings.strIniFile, Global, UnderstandChangeFoldersInDialogRisk
}

Gui, 2:-Disabled
Gui, 3:Destroy
if (g_intGui2WinID <> A_ScriptHwnd)
	WinActivate, ahk_id %g_intGui2WinID%

return
;------------------------------------------------------------


;------------------------------------------------------------
EnableExternalMenusCatalogueClicked:
EnableExternalMenusCatalogueClickedInit:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

if (A_ThisLabel = "EnableExternalMenusCatalogueClicked")
	Gosub, GuiOptionsGroupChanged

blnExternalMenusCataloguePathReadOnly := o_Settings.ReadIniValue("ExternalMenusCataloguePathReadOnly", 0) ; false if not found
strEnableCommand := (blnExternalMenusCataloguePathReadOnly ? "Disable" : "Enable")
GuiControl, 2:%strEnableCommand%, f_blnEnableExternalMenusCatalogue
GuiControl, 2:%strEnableCommand%, f_strExternalMenusCataloguePath
GuiControl, 2:%strEnableCommand%, f_btnExternalMenusCataloguePath

if !(f_blnEnableExternalMenusCatalogue) and !InStr(A_ThisLabel, "Init")
	GuiControl, 2:, f_strExternalMenusCataloguePath

strShowHideCommand := (f_blnEnableExternalMenusCatalogue ? "Enable" : "Disable")
GuiControl, %strShowHideCommand%, f_lblExternalMenusCataloguePathPrompt
GuiControl, %strShowHideCommand%, f_strExternalMenusCataloguePath
GuiControl, %strShowHideCommand%, f_btnExternalMenusCataloguePath

blnExternalMenusCataloguePathReadOnly := ""
strEnableCommand := ""
strShowHideCommand := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
RefreshedMenusAttachedClicked:
;------------------------------------------------------------

Gosub, GuiOptionsGroupChanged

Oops(o_L["OptionsRefreshedMenusAttachedInfo"], o_L["MenuRecentFolders"], o_L["MenuRecentFiles"]
	, o_L["MenuPopularMenusFolders"], o_L["MenuPopularMenusFiles"], o_L["MenuDrives"])

return
;------------------------------------------------------------


;------------------------------------------------------------
DisplayMenuShortcutsClicked:
DisplayMenuShortcutsClickedInit:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

if (A_ThisLabel = "DisplayMenuShortcutsClicked")
	Gosub, GuiOptionsGroupChanged

GuiControl, % (f_blnDisplayNumericShortcuts ? "Enable" : "Disable"), f_blnDisplayNumericShortcutsFromOne

return
;------------------------------------------------------------


;------------------------------------------------------------
HotkeyRemindersClicked:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

Gosub, GuiOptionsGroupChanged

GuiControl, % (f_radHotkeyReminders1 ? "Disable" : "Enable"), f_blnHotkeyRemindersRightAlign

return
;------------------------------------------------------------


;------------------------------------------------------------
ButtonQAPTempFolderParentPath:
ButtonExternalMenuSelectCataloguePath:
ButtonBackupFolder:
ButtonWorkingFolder:
;------------------------------------------------------------
Gui, 2:+OwnDialogs
Gui, 2:Submit, NoHide

if (A_ThisLabel = "ButtonWorkingFolder")
{
	strControlName := "f_strWorkingFolder"
	strPrompt := o_L["OptionsSelectWorkingFolder"]
}
else if (A_ThisLabel = "ButtonQAPTempFolderParentPath")
{
	strControlName := "f_strQAPTempFolderParentPath"
	strPrompt := o_L["OptionsSelectQAPTempFolder"]
}
else if (A_ThisLabel = "ButtonExternalMenuSelectCataloguePath")
{
	strControlName := "f_strExternalMenusCataloguePath"
	strPrompt := o_L["OptionsSelectCatalogueRoot"]
}
else
{
	strControlName := "f_strBackupFolder"
	strPrompt := o_L["OptionsSelectBackupFolder"]
}

strPreviousFolderExpand := PathCombine(A_WorkingDir, EnvVars(%strControlName%))
FileSelectFolder, strNewFolder, *%strPreviousFolderExpand%, 3, %strPrompt%
if !StrLen(strNewFolder)
	return

Gosub, GuiOptionsGroupChanged

GuiControl, 2:, %strControlName%, %strNewFolder%

strControlName := ""
strPreviousFolderExpand := ""
strPrompt := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
ButtonSelectFileManagerPath:
ButtonSelectTotalCommanderWinCmd:
ButtonAlternativeTrayIcon:
;------------------------------------------------------------
Gui, 2:+OwnDialogs

if (A_ThisLabel = "ButtonSelectFileManagerPath")
{
	strControlName := "f_strFileManagerPath"
	strDefault := o_FileManagers.SA[g_intClickedFileManager].AA.strFileManagerPath
}
else if (A_ThisLabel = "ButtonSelectTotalCommanderWinCmd")
{
	strControlName := "f_strTotalCommanderWinCmd"
	strDefault := g_aaFileManagerTotalCommander.strTCIniFile
}
else ; (A_ThisLabel = "ButtonAlternativeTrayIcon")
{
	strControlName := "f_strAlternativeTrayIcon"
	strDefault := o_Settings.LaunchAdvanced.strAlternativeTrayIcon.IniValue
}

FileSelectFile, strNewLocation, 3, %strDefault%, % o_L["DialogAddFolderSelect"]

if !(StrLen(strNewLocation))
	return

GuiControl, 2:, %strControlName%, %strNewLocation%

strDefault := ""
strControlName := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
OptionUsageDbEnableClicked:
OptionUsageDbEnableClickedInit:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

if (A_ThisLabel = "OptionUsageDbEnableClicked")
	Gosub, GuiOptionsGroupChanged

strAction := (f_blnOptionUsageDbEnable ? "Enable" : "Disable")

GuiControl, %strAction%, f_lblUsageDbIntervalSeconds
GuiControl, %strAction%, f_intUsageDbIntervalSecondsEdit
GuiControl, %strAction%, f_intUsageDbIntervalSeconds
GuiControl, %strAction%, f_lblUsageDbDaysInPopular
GuiControl, %strAction%, f_intUsageDbDaysInPopularEdit
GuiControl, %strAction%, f_intUsageDbDaysInPopular
GuiControl, %strAction%, f_lblUsageDbDaysInPopular
GuiControl, %strAction%, f_lblUsageDbMaximumSize
GuiControl, %strAction%, f_fltUsageDbMaximumSize
GuiControl, %strAction%, f_blnUsageDbShowPopularityIndex

strAction := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
ButtonUsageDbFlushClicked:
;------------------------------------------------------------

Diag(A_ThisLabel, "", "START")

MsgBox, 36, %g_strAppNameText%, % o_L["OptionsUsageDbFlushDatabaseConfirm"]
IfMsgBox, Yes
{
	strUsageDbSQL := "DELETE FROM Usage;" ; do not delete zMetadata (and if yes in the future, do not delete record, empty LatestCollected)
	If !o_UsageDb.Exec(strUsageDbSQL)
		Oops("SQLite FLUSH Error`n`nMessage: " . o_UsageDb.ErrorMsg . "`nCode: " . o_UsageDb.ErrorCode . "`nQuery: " . strUsageDbSQL)
	else
		Oops(o_L["OptionsUsageDbFlushDatabaseDone"])
}

strUsageDbSQL := ""

Diag(A_ThisLabel, "", "STOP")
return
;------------------------------------------------------------


;------------------------------------------------------------
OptionsListCleanup(strList)
;------------------------------------------------------------
{
	strListCleanup := StrReplace(strList, "`n", "|")
	strList := ""
	Loop, Parse, strListCleanup, |
		if StrLen(A_LoopField)
			strList .= Trim(A_LoopField) . "|"
	strList := SubStr(strList, 1, -1) ; remove last |
	return strList
}
;------------------------------------------------------------


;------------------------------------------------------------
EnableExplorerContextMenus:
DisableExplorerContextMenus:
;------------------------------------------------------------

strQAPPathDoubleBackslash := StrReplace(A_ScriptDir, "\", "\\")

strContextAddFile := o_L["ContextAddFile"]
strContextAddFileXpress := o_L["ContextAddFileXpress"]
strContextAddFolder := o_L["ContextAddFolder"]
strContextAddFolderXpress := o_L["ContextAddFolderXpress"]
strContextAddShortcut := o_L["ContextAddShortcut"]
strContextShowMenu := o_L["ContextShowMenu"]
strContextShowMenuAlternative := o_L["ContextShowMenuAlternative"]

if (A_ThisLabel = "EnableExplorerContextMenus")
{
	FileDelete, %g_strTempDir%\enable-qap-context-menus.reg
	FileAppend,
		(LTrim Join`r`n
			Windows Registry Editor Version 5.00

			; Add context menus for Quick Access Popup
			; For more information:
			; https://www.quickaccesspopup.com/what-else-should-i-know-about-explorer-context-menus/

			;--------------------------------------
			; ADD FILE
			;--------------------------------------
			[HKEY_CLASSES_ROOT\*\shell\Add File to Quick Access Popup menu]
			@="%strContextAddFile%"
			"Icon"="\"%strQAPPathDoubleBackslash%\\QuickAccessPopup.ico\""

			[HKEY_CLASSES_ROOT\*\shell\Add File to Quick Access Popup menu\command]
			@="\"%strQAPPathDoubleBackslash%\\QAPmessenger.exe\" AddFile \"`%1\""
			;--------------------------------------


			;--------------------------------------
			; ADD FILE EXPRESS
			;--------------------------------------
			[HKEY_CLASSES_ROOT\*\shell\Add File to Quick Access Popup menu Express]
			@="%strContextAddFileXpress%"
			"Icon"="\"%strQAPPathDoubleBackslash%\\QuickAccessPopup.ico\""
			"Extended"=""

			[HKEY_CLASSES_ROOT\*\shell\Add File to Quick Access Popup menu Express\command]
			@="\"%strQAPPathDoubleBackslash%\\QAPmessenger.exe\" AddFileXpress \"`%1\""


			;--------------------------------------
			; ADD FOLDER
			;--------------------------------------
			[HKEY_CLASSES_ROOT\Folder\shell\Add Folder to Quick Access Popup menu]
			@="%strContextAddFolder%"
			"Icon"="\"%strQAPPathDoubleBackslash%\\QuickAccessPopup.ico\""

			[HKEY_CLASSES_ROOT\Folder\shell\Add Folder to Quick Access Popup menu\command]
			@="\"%strQAPPathDoubleBackslash%\\QAPmessenger.exe\" AddFolder \"`%1\""
			;--------------------------------------


			;--------------------------------------
			; ADD FOLDER EXPRESS
			;--------------------------------------
			[HKEY_CLASSES_ROOT\Folder\shell\Add Folder to Quick Access Popup menu Express]
			@="%strContextAddFolderXpress%"
			"Icon"="\"%strQAPPathDoubleBackslash%\\QuickAccessPopup.ico\""
			"Extended"=""

			[HKEY_CLASSES_ROOT\Folder\shell\Add Folder to Quick Access Popup menu Express\command]
			@="\"%strQAPPathDoubleBackslash%\\QAPmessenger.exe\" AddFolderXpress \"`%1\""
			;--------------------------------------


			;--------------------------------------
			; DESKTOP SHOW MENU 
			;--------------------------------------
			[HKEY_CLASSES_ROOT\DesktopBackground\Shell\Show Quick Access Popup menu]
			@="%strContextShowMenu%"
			"Icon"="\"%strQAPPathDoubleBackslash%\\QuickAccessPopup.ico\""

			[HKEY_CLASSES_ROOT\DesktopBackground\Shell\Show Quick Access Popup menu\command]
			@="\"%strQAPPathDoubleBackslash%\\QAPmessenger.exe\" ShowMenuLaunch"
			;--------------------------------------


			;--------------------------------------
			; DESKTOP SHOW ALTERNATIVE MENU
			;--------------------------------------
			[HKEY_CLASSES_ROOT\DesktopBackground\Shell\Show Quick Access Popup Alternative menu]
			@="%strContextShowMenuAlternative%"
			"Icon"="\"%strQAPPathDoubleBackslash%\\QuickAccessPopup.ico\""
			"Extended"=""

			[HKEY_CLASSES_ROOT\DesktopBackground\Shell\Show Quick Access Popup Alternative menu\command]
			@="\"%strQAPPathDoubleBackslash%\\QAPmessenger.exe\" ShowMenuAlternative"
			;--------------------------------------


			;--------------------------------------
			; FOLDER BACKGROUND SHOW MENU
			;--------------------------------------
			[HKEY_CLASSES_ROOT\Directory\Background\shell\Show Quick Access Popup menu]
			@="%strContextShowMenu%"
			"Icon"="\"%strQAPPathDoubleBackslash%\\QuickAccessPopup.ico\""

			[HKEY_CLASSES_ROOT\Directory\Background\shell\Show Quick Access Popup menu\command]
			@="\"%strQAPPathDoubleBackslash%\\QAPmessenger.exe\" ShowMenuNavigate"
			;--------------------------------------


			;--------------------------------------
			; FOLDER BACKGROUND SHOW ALTERNATIVE MENU
			;--------------------------------------
			[HKEY_CLASSES_ROOT\Directory\Background\shell\Show Quick Access Popup Alternative menu]
			@="%strContextShowMenuAlternative%"
			"Icon"="\"%strQAPPathDoubleBackslash%\\QuickAccessPopup.ico\""
			"Extended"=""

			[HKEY_CLASSES_ROOT\Directory\Background\shell\Show Quick Access Popup Alternative menu\command]
			@="\"%strQAPPathDoubleBackslash%\\QAPmessenger.exe\" ShowMenuAlternative"
			;--------------------------------------


			;--------------------------------------
			; FOLDER BACKGROUND ADD FOLDER
			;--------------------------------------
			[HKEY_CLASSES_ROOT\Directory\Background\shell\Add Folder to Quick Access Popup menu]
			@="%strContextAddFolder%"
			"Icon"="\"%strQAPPathDoubleBackslash%\\QuickAccessPopup.ico\""

			[HKEY_CLASSES_ROOT\Directory\Background\shell\Add Folder to Quick Access Popup menu\command]
			@="\"%strQAPPathDoubleBackslash%\\QAPmessenger.exe\" AddFolder \"`%V\""
			;--------------------------------------


			;--------------------------------------
			; FOLDER BACKGROUND ADD FOLDER EXPRESS
			;--------------------------------------
			[HKEY_CLASSES_ROOT\Directory\Background\shell\Add Folder to Quick Access Popup menu Express]
			@="%strContextAddFolderXpress%"
			"Icon"="\"%strQAPPathDoubleBackslash%\\QuickAccessPopup.ico\""
			"Extended"=""

			[HKEY_CLASSES_ROOT\Directory\Background\shell\Add Folder to Quick Access Popup menu Express\command]
			@="\"%strQAPPathDoubleBackslash%\\QAPmessenger.exe\" AddFolderXpress \"`%V\""
			;--------------------------------------

			;--------------------------------------
			; IMPORT SHORTCUT
			;--------------------------------------
			[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\lnkfile\shell\Import Shortcut to Quick Access Popup menu]
			@="%strContextAddShortcut%"
			"Icon"="\"%strQAPPathDoubleBackslash%\\QuickAccessPopup.ico\""

			[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\lnkfile\shell\Import Shortcut to Quick Access Popup menu\command]
			@="\"%strQAPPathDoubleBackslash%\\QAPmessenger.exe\" AddShortcut \"`%1\""
			;--------------------------------------

)
		, %g_strTempDir%\enable-qap-context-menus.reg
		
		; blnMainGuiWasActive := WinActive(L(o_L["GuiTitle"], g_strAppNameText, g_strAppVersion)) ; main Gui title
		blnOptionsGuiWasActive := WinActive(g_strOptionsGuiTitle) ; main Gui title
		if (blnOptionsGuiWasActive)
			WinMinimize, %g_strOptionsGuiTitle%
		RunWait, %g_strTempDir%\enable-qap-context-menus.reg, , UseErrorLevel
		if (ErrorLevel = "ERROR" and A_LastError = 1223) ; error 1223 because user canceled on the Run as admnistrator prompt
			Oops(o_L["ContextCancelled"])
		else
			o_Settings.MenuPopup.blnExplorerContextMenus.IniValue := true ; enabling succeeded
		if (blnOptionsGuiWasActive)
			WinActivate, %g_strOptionsGuiTitle%
}
else ; DisableExplorerContextMenus
{
	FileDelete, %g_strTempDir%\disable-qap-context-menus.bat
	FileAppend,
		(LTrim Join`r`n
			:: BATCH START - DELETE QUICK ACCESS POPUP REGISTRY KEYS
			:: https://www.quickaccesspopup.com/what-else-should-i-know-about-explorer-context-menus/
			REG DELETE "HKEY_CLASSES_ROOT\*\shell\Add File to Quick Access Popup menu" /f
			REG DELETE "HKEY_CLASSES_ROOT\*\shell\Add File to Quick Access Popup menu Express" /f
			REG DELETE "HKEY_CLASSES_ROOT\DesktopBackground\Shell\Show Quick Access Popup menu" /f
			REG DELETE "HKEY_CLASSES_ROOT\DesktopBackground\Shell\Show Quick Access Popup Alternative menu" /f
			REG DELETE "HKEY_CLASSES_ROOT\Directory\Background\shell\Add Folder to Quick Access Popup menu" /f
			REG DELETE "HKEY_CLASSES_ROOT\Directory\Background\shell\Add Folder to Quick Access Popup menu Express" /f
			REG DELETE "HKEY_CLASSES_ROOT\Directory\Background\shell\Show Quick Access Popup menu" /f
			REG DELETE "HKEY_CLASSES_ROOT\Directory\Background\shell\Show Quick Access Popup Alternative menu" /f
			REG DELETE "HKEY_CLASSES_ROOT\Folder\shell\Add Folder to Quick Access Popup menu" /f
			REG DELETE "HKEY_CLASSES_ROOT\Folder\shell\Add Folder to Quick Access Popup menu Express" /f
			REG DELETE "HKEY_LOCAL_MACHINE\SOFTWARE\Classes\lnkfile\shell\Import Shortcut to Quick Access Popup menu" /f
			:: BATCH END

)
		, %g_strTempDir%\disable-qap-context-menus.bat

		; blnMainGuiWasActive := WinActive(L(o_L["GuiTitle"], g_strAppNameText, g_strAppVersion)) ; main Gui title
		blnOptionsGuiWasActive := WinActive(g_strOptionsGuiTitle) ; main Gui title
		if (blnOptionsGuiWasActive)
			WinMinimize, %g_strOptionsGuiTitle%
		RunWait, *RunAs %g_strTempDir%\disable-qap-context-menus.bat, , UseErrorLevel
		if (ErrorLevel = "ERROR" and A_LastError = 1223) ; error 1223 because user canceled on the Run as admnistrator prompt
			Oops(o_L["ContextCancelled"])
		else
			o_Settings.MenuPopup.blnExplorerContextMenus.IniValue := false ; disabling succeeded
		if (blnOptionsGuiWasActive)
			WinActivate, %g_strOptionsGuiTitle%
}

; blnMainGuiWasActive := ""
blnOptionsGuiWasActive := ""
strQAPPathDoubleBackslash := ""
strContextAddFile := ""
strContextAddFileXpress := ""
strContextAddFolder := ""
strContextAddFolderXpress := ""
strContextAddShortcut := ""
strContextShowMenu := ""
strContextShowMenuAlternative := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
MoveWorkingFolderChangeButtonNames:
;------------------------------------------------------------

IfWinNotExist, % o_L["OptionsMoveWorkingFolderTitle"]
    return  ; Keep waiting.

SetTimer, MoveWorkingFolderChangeButtonNames, Off
WinActivate

ControlSetText, Button1, % o_L["DialogCopy"]
ControlSetText, Button2, % o_L["DialogNew"]

return
;------------------------------------------------------------



;========================================================================================================================
; END OF OPTIONS
;========================================================================================================================


;========================================================================================================================
!_030_FAVORITES_LIST:
;========================================================================================================================

;------------------------------------------------------------
BuildGui:
;------------------------------------------------------------

strTextColor := o_Settings.ReadIniValue("TextColor", 000000, "Gui-" . o_Settings.Launch.strTheme.IniValue)
g_strGuiListviewBackgroundColor := o_Settings.ReadIniValue("ListviewBackground", FFFFFF, "Gui-" . o_Settings.Launch.strTheme.IniValue)
g_strGuiListviewTextColor := o_Settings.ReadIniValue("ListviewText", 000000, "Gui-" . o_Settings.Launch.strTheme.IniValue)

g_strGuiFullTitle := L(o_L["GuiTitle"], g_strAppNameText, g_strAppVersion)
Gui, 1:New, +Hwndg_strAppHwnd +Resize -MinimizeBox +MinSize%g_intGuiDefaultWidth%x%g_intGuiDefaultHeight%, %g_strGuiFullTitle%

Gui, Menu, menuBar

if (g_blnUseColors)
	Gui, 1:Color, %g_strGuiWindowColor%

; ampersand labels for gui buttons (this does not work with image buttons' label)
aaSettingsL := o_L.InsertAmpersand(false, "*" . aaMenuBarL.strUsed, "GuiSaveAndClose", "GuiSave", "GuiClose", "GuiCancel")

; Order of controls important to avoid drawgins gliches when resizing

Gui, 1:Add, Picture, vf_picGuiAddFavorite gGuiAddFavoriteSelectType, %g_strTempDir%\add_property-48_c.png ; Static1
Gui, 1:Add, Picture, vf_picGuiEditFavorite gGuiEditFavorite x+1 yp, %g_strTempDir%\edit_property-48_c.png ; Static2
Gui, 1:Add, Picture, vf_picGuiEditFavorited xp yp, %g_strTempDir%\edit_property-48d_c.png ; Static3
Gui, 1:Add, Picture, vf_picGuiRemoveFavorite gGuiRemoveFavorite x+1 yp, %g_strTempDir%\delete_property-48_c.png ; Static4
Gui, 1:Add, Picture, vf_picGuiMoveFavorite gGuiMoveFavoriteToMenu x+1 yp, %g_strTempDir%\play_property-48_c.png ; Static5
Gui, 1:Add, Picture, vf_picGuiCopyFavorite gGuiCopyFavorite x+1 yp, %g_strTempDir%\copy-48_c.png ; Static6
Gui, 1:Add, Picture, vf_picUpMenu gGuiGotoUpMenu hidden x+1 yp, %g_strTempDir%\left2-24_c.png ; Static7
g_aaToolTipsMessages["Static7"] := o_L["ControlToolTipParentMenu"]
Gui, 1:Add, Picture, vf_picPreviousMenu gGuiGotoPreviousMenu hidden x+1 yp, %g_strTempDir%\left-24_c.png ; Static8
g_aaToolTipsMessages["Static8"] := o_L["ControlToolTipPreviousMenu"]
Gui, 1:Add, Picture, vf_picMoveFavoriteUp gGuiMoveFavoriteUp x+1 yp, %g_strTempDir%\up_circular-26_c.png ; Static9
g_aaToolTipsMessages["Static9"] := o_L["ControlToolTipMoveUp"]
Gui, 1:Add, Picture, vf_picMoveFavoriteDown gGuiMoveFavoriteDown x+1 yp, %g_strTempDir%\down_circular-26_c.png ; Static10
g_aaToolTipsMessages["Static10"] := o_L["ControlToolTipMoveDown"]
Gui, 1:Add, Picture, vf_picAddSeparator gGuiAddSeparator x+1 yp, %g_strTempDir%\separator-26_c.png ; Static11
g_aaToolTipsMessages["Static11"] := o_L["ControlToolTipSeparator"]
Gui, 1:Add, Picture, vf_picAddColumnBreak gGuiAddColumnBreak x+1 yp, %g_strTempDir%\column-26_c.png ; Static12
g_aaToolTipsMessages["Static12"] := o_L["ControlToolTipColumnBreak"]
Gui, 1:Add, Picture, vf_picAddTextSeparator gGuiAddTextSeparator x+1 yp, %g_strTempDir%\text-26_c.png ; Static13
g_aaToolTipsMessages["Static13"] := o_L["ControlToolTipTextSeparator"]
Gui, 1:Add, Picture, vf_picSortFavorites gGuiSortFavorites x+1 yp, %g_strTempDir%\generic_sorting-26_c.png ; Static14
g_aaToolTipsMessages["Static14"] := o_L["ControlToolTipSortFavorites"]
Gui, 1:Add, Picture, vf_picGuiAlwaysOnTopOn gGuiAlwaysOnTop hidden x+1 yp, %g_strTempDir%\QAP-pin-on-26_c.png ; Static15
g_aaToolTipsMessages["Static15"] := o_L["ControlToolTipAlwaysOnTopOn"]
Gui, 1:Add, Picture, vf_picGuiAlwaysOnTopOff gGuiAlwaysOnTop x+1 yp, %g_strTempDir%\QAP-pin-off-26_c.png ; Static16
g_aaToolTipsMessages["Static16"] := o_L["ControlToolTipAlwaysOnTopOff"]
Gui, 1:Add, Picture, vf_picSearch gGuiFocusFilter x+1 yp, %g_strTempDir%\search-24_c.png ; Static17
g_aaToolTipsMessages["Static17"] := o_L["ControlToolTipSearchButton"]

Gui, 1:Font, s8 w400, Arial ; button legend
Gui, 1:Add, Text, vf_lblGuiAddFavorite center gGuiAddFavoriteSelectType x0 y+20, % o_L["GuiAddFavorite"] ; Static18
Gui, 1:Add, Text, vf_lblGuiEditFavorite center gGuiEditFavorite x+1 yp w88, % o_L["GuiEditFavorite"] ; Static19, w88 to make room fot when multiple favorites are selected
Gui, 1:Add, Text, vf_lblGuiRemoveFavorite center gGuiRemoveFavorite x+1 yp w88, % o_L["GuiRemoveFavorite"] ; Static20
Gui, 1:Add, Text, vf_lblGuiMoveFavorite center gGuiMoveFavoriteToMenu x+1 yp w88, % o_L["GuiMove"] ; Static21
Gui, 1:Add, Text, vf_lblGuiCopyFavorite center gGuiCopyFavorite x+1 yp w88, % o_L["DialogCopy"] ; Static22

Gui, 1:Font, s8 w400 normal, Verdana
Gui, 1:Add, Text, vf_lblMenuDropdownOrSearchLabel x+1 yp, % o_L["GuiSubmenuDropdownLabel"] ; Static23
Gui, 1:Add, DropDownList, vf_drpMenusList gGuiMenusListChanged x0 y+1 ; ComboBox1

Gui, 1:Add, Edit, vf_strFavoritesListFilter r1 gLoadFavoritesInGuiFiltered hidden, % o_L["DialogSearch"] ; Edit1 (EditN controls do not support tooltips)
Gui, 1:Add, Checkbox, vf_blnFavoritesListFilterExtended x+10 yp gFilterExtendedClicked hidden, % o_L["DialogExtendedSearch"] ; Button1
g_aaToolTipsMessages["Button1"] := o_L["ControlToolTipSearchBoxExtended"]
Gui, 1:Add, Button, vf_btnFavoritesListNoFilter gGuiFavoritesListFilterEmptyButton x+10 yp w20 h20 hidden, X ; Button2
g_aaToolTipsMessages["Button2"] := o_L["ControlToolTipSearchBoxClear"]
Gui, 1:Add, ListView
	, % "vf_lvFavoritesList Count32 AltSubmit NoSortHdr LV0x10 " . (g_blnUseColors ? "c" . g_strGuiListviewTextColor . " Background" . g_strGuiListviewBackgroundColor : "") . " gGuiFavoritesListEvents x+1 yp"
	, % o_L["GuiLvFavoritesHeader"] ; SysHeader321 / SysListView321
Gui, 1:Add, ListView
	, % "vf_lvFavoritesListFiltered Count32 AltSubmit LV0x10 -Multi hidden " . (g_blnUseColors ? "c" . g_strGuiListviewTextColor . " Background" . g_strGuiListviewBackgroundColor : "") . " gGuiFavoritesListFilteredEvents x+1 yp"
	, % o_L["GuiLvFavoritesHeaderFiltered"] . "|Object Position (hidden)" ; SysHeader322 / SysListView322

Gui, 1:Font, s8 w600, Verdana
Gui, 1:Add, Button, vf_btnGuiSaveAndCloseFavorites Disabled gGuiSaveAndCloseFavorites x200 y400 w140 h35, % aaSettingsL["GuiSaveAndClose"] ; Button3
Gui, 1:Add, Button, vf_btnGuiSaveAndStayFavorites Disabled gGuiSaveAndStayFavorites x350 yp w100 h35, % aaSettingsL["GuiSave"] ; Button4
Gui, 1:Add, Button, vf_btnGuiCancel gGuiCancel Default x500 yp w100 h35, % aaSettingsL["GuiClose"] ; Close until changes occur - Button5

Gui, 1:Font, s8 w400 c404040 normal, Verdana

Gui, 1:Add, Link, vf_lnkSponsoredBy x0 y+1 gSponsoredByClicked, %g_SponsoredMessage% ; SysLink, center option not working for links
GuiControlGet, arrPos, Pos, f_lnkSponsoredBy
g_intLnkSponsoredByWidth := arrPosW

GetSavedSettingsWindowPosition(saSettingsPosition) ; format: x|y|w|h

Gui, 1:Show, % "Hide "
	. (saSettingsPosition[1] = -1 or saSettingsPosition[1] = "" or saSettingsPosition[2] = ""
	? "center w" . g_intGuiDefaultWidth . " h" . g_intGuiDefaultHeight
	: "x" . saSettingsPosition[1] . " y" . saSettingsPosition[2])
sleep, 100
if (saSettingsPosition[1] <> -1)
	WinMove, ahk_id %g_strAppHwnd%, , , , % saSettingsPosition[3], % saSettingsPosition[4]

GuiControl, Focus, f_lvFavoritesList
saSettingsPosition := ""
saDonateButtons := ""
strTextColor := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
LoadMenuInGui:
LoadMenuInGuiFromAlternative:
LoadMenuInGuiFromGuiSearch:
LoadMenuInGuiFromHotkeysManage:
;------------------------------------------------------------

Gui, 1:Default
Gui, 1:ListView, f_lvFavoritesList
LV_Delete()

if (o_MenuInGui.AA.strMenuType = "External") and o_MenuInGui.ExternalMenuModifiedSinceLoaded() ; refresh only if changed
	; was ExternalMenuReloadAndRebuild(g_objMenuInGui)
	{
		o_MenuInGui.LoadFavoritesFromIniFile(false, true) ; true for Refresh External
		o_MenuInGui.BuildMenu()
	}

o_MenuInGui.LoadInGui()

; keep original position from LoadMenuInGuiFromAlternative and LoadMenuInGuiFromGuiSearch (not from LoadMenuInGuiFromHotkeysManage)
LV_Modify((A_ThisLabel = "LoadMenuInGuiFromAlternative" or A_ThisLabel = "LoadMenuInGuiFromGuiSearch" ? g_intOriginalMenuPosition : 1), "Select Focus")

Gosub, AdjustColumnsWidth

GuiControl, , f_drpMenusList, % "|" . o_MainMenu.BuildMenuListDropDown(o_MenuInGui.AA.strMenuPath) . "|"

Gosub, GuiFavoritesListFilterHide
	
GuiControl, Focus, f_lvFavoritesList

strGuiMenuLocation := ""
strThisType := ""
strThisHotkey := ""
strExternalMenuName := ""
strFavoriteName := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
FilterExtendedClick:
FilterExtendedClicked:
;------------------------------------------------------------
Gui, 1:Submit, NoHide

if (A_ThisLabel = "FilterExtendedClick")
	GuiControl, , f_blnFavoritesListFilterExtended, % (f_blnFavoritesListFilterExtended ? 0 : 1)
Menu, menuBarTools, ToggleCheck, % aaMenuToolsL["DialogExtendedSearch"]

Gosub, GuiFocusFilter
Gosub, LoadFavoritesInGuiFiltered

return
;------------------------------------------------------------


;------------------------------------------------------------
LoadFavoritesInGuiFiltered:
;------------------------------------------------------------
Gui, 1:Submit, NoHide

; often fail
; intListFilteredWinID := WinExist("A")
; if not DllCall("LockWindowUpdate", Uint, intListFilteredWinID)
;	Oops("An error occured while locking window display", g_strAppNameText, g_strAppVersion)

Critical, On ; prevents the current thread from being interrupted by other threads

strFavoritesListFilter := GetFavoritesListFilter()
blnFavoritesListFilterExtended := f_blnFavoritesListFilterExtended

if !StrLen(strFavoritesListFilter)
{
	GuiControl, Show, f_picMoveFavoriteUp
	GuiControl, Show, f_picMoveFavoriteDown
	GuiControl, Show, f_picAddSeparator
	GuiControl, Show, f_picAddColumnBreak
	GuiControl, Show, f_picAddTextSeparator
	GuiControl, Show, f_picSortFavorites

	GuiControl, Hide, f_lvFavoritesListFiltered
	GuiControl, Show, f_lvFavoritesList
	Gui, 1:ListView, f_lvFavoritesList
	return
}

GuiControl, Hide, f_picMoveFavoriteUp
GuiControl, Hide, f_picMoveFavoriteDown
GuiControl, Hide, f_picAddSeparator
GuiControl, Hide, f_picAddColumnBreak
GuiControl, Hide, f_picAddTextSeparator
GuiControl, Hide, f_picSortFavorites

GuiControl, Hide, f_lvFavoritesList
GuiControl, Show, f_lvFavoritesListFiltered

Gui, 1:ListView, f_lvFavoritesList
if (LV_GetCount("Selected") > 1) ; if multiple select in list
	LV_Modify(0, "-Select") ; reset "Move n" and "Remove n" labels to "Edit" and "Remove"

Gui, 1:ListView, f_lvFavoritesListFiltered
LV_Delete()
LV_ModifyCol(6, 0) ; do early to avoid flash

o_MenuInGui.LoadInGuiFiltered(strFavoritesListFilter, blnFavoritesListFilterExtended)

LV_Modify(1, "Select Focus") 
Loop, % LV_GetCount("Column") - 1
	LV_ModifyCol(A_Index, "AutoHdr")

Critical, Off ; enables the current thread to be interrupted

; DllCall("LockWindowUpdate", Uint, 0)  ; Pass 0 to unlock the currently locked window.

strFavoritesListFilter := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiSize:
;------------------------------------------------------------

if (A_EventInfo = 1)  ; The window has been minimized.  No action needed.
    return

intListH := A_GuiHeight - 139
g_intListW := A_GuiWidth - 40 - 88
intFavoritesListFilterCloseW := 25
intFavoritesListFilterButton := 30

; space before, between and after save/reload/close buttons
; = (A_GuiWidth - left margin - right margin - (3 buttons width)) // 4 (left, between x 2, right)
intButtonSpacing := (A_GuiWidth - 120 - 120 - (140 + 100 + 100)) // 4

for intIndex, aaGuiControl in g_saGuiControls
{
	intX := aaGuiControl.X
	intY := aaGuiControl.Y

	if (intX < 0)
		intX:= A_GuiWidth + intX
	if (intY < 0)
		intY := A_GuiHeight + intY

	if (aaGuiControl.Center)
	{
		GuiControlGet, arrPos, Pos, % aaGuiControl.Name
		intX := intX - (arrPosW // 2) ; Floor divide
	}

	if (aaGuiControl.Name = "f_btnGuiSaveAndCloseFavorites")
		intX := 120 + intButtonSpacing
	else if (aaGuiControl.Name = "f_btnGuiSaveAndStayFavorites")
		intX := 120 + (2 * intButtonSpacing) + 140 ; 140 for 1st button
	else if (aaGuiControl.Name = "f_btnGuiCancel")
		intX := 120 + (3 * intButtonSpacing) + 140 + 100 ; 140 for 1st button, 100 for 2nd button
		
	GuiControl, % "1:Move" . (aaGuiControl.Draw ? "Draw" : ""), % aaGuiControl.Name, % "x" . intX	.  " y" . intY
		
}

GuiControlGet, arrFavoritesListFilterExtendedPos, Pos, f_blnFavoritesListFilterExtended
GuiControl, 1:Move, f_drpMenusList, % " w" . g_intListW - intFavoritesListFilterButton
GuiControl, 1:Move, f_strFavoritesListFilter, % "h21 w" . g_intListW - intFavoritesListFilterCloseW - arrFavoritesListFilterExtendedPosW - 10
GuiControlGet, arrFavoritesListFilterPos, Pos, f_strFavoritesListFilter
GuiControl, 1:Move, f_blnFavoritesListFilterExtended, % "y" . arrFavoritesListFilterPosY + 3 . " x" . arrFavoritesListFilterPosX + arrFavoritesListFilterPosW + 10
GuiControl, 1:Move, f_btnFavoritesListNoFilter, % "y" . arrFavoritesListFilterPosY . " x" . arrFavoritesListFilterPosX + arrFavoritesListFilterPosW + arrFavoritesListFilterExtendedPosW + 16
GuiControl, 1:Move, f_lvFavoritesList, w%g_intListW% h%intListH%
GuiControl, 1:Move, f_lvFavoritesListFiltered, w%g_intListW% h%intListH%
GuiControl, 1:Move, f_lnkSponsoredBy, % "x" . (A_GuiWidth - g_intLnkSponsoredByWidth) // 2

Gosub, AdjustColumnsWidth

intListH := ""
intButtonSpacing := ""
intIndex := ""
aaGuiControl := ""
intX := ""
intY := ""
arrPos := ""
intFavoritesListFilterCloseW := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
SponsoredByClicked:
;------------------------------------------------------------

strLink := ErrorLevel
if (strLink = "update")
	Run, https://www.quickaccesspopup.com/upgrading-donor-code/
else if (strLink = "none")
	Gosub, GuiDonate
; else do nothing

strLink := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiHotkeysHelpClicked:
;------------------------------------------------------------
Gui, 1:+OwnDialogs

MsgBox, 0, % g_strAppNameText . " - " . o_L["GuiHotkeysHelp"]
	, % o_L["GuiHotkeysHelpText"] . "`n`n" . o_L["GuiHotkeysHelpText2"]

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiAlwaysOnTop:
;------------------------------------------------------------

g_Gui1AlwaysOnTop := !g_Gui1AlwaysOnTop

WinSet, AlwaysOnTop, % (g_Gui1AlwaysOnTop ? "On" : "Off"), % L(o_L["GuiTitle"], g_strAppNameText, g_strAppVersion) ; do not use default Toogle for safety
GuiControl, % (g_Gui1AlwaysOnTop ? "Show" : "Hide"), f_picGuiAlwaysOnTopOn
GuiControl, % (g_Gui1AlwaysOnTop ? "Hide" : "Show"), f_picGuiAlwaysOnTopOff
Menu, menuBarTools, ToggleCheck, % aaMenuToolsL["ControlToolTipAlwaysOnTopOff"]

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiDropFilesHelpClicked:
;------------------------------------------------------------
Gui, 1:+OwnDialogs

MsgBox, 0, % g_strAppNameText . " - " . StrReplace(o_L["GuiDropFilesHelp"], "&&", "&")
	, % L(o_L["GuiDropFilesIncentive"], g_strAppNameText, o_L["DialogFolderLabel"], o_L["DialogFileLabel"], o_L["DialogApplicationLabel"]) . "`n`n" . o_L["GuiDropFilesIncentive2"]

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiFavoritesListEvents:
;------------------------------------------------------------

Gui, 1:ListView, f_lvFavoritesList

if (A_GuiEvent = "DoubleClick")
{
	g_intOriginalMenuPosition := LV_GetNext()
	if StrLen(o_MenuInGui.SA[g_intOriginalMenuPosition].AA.strFavoriteType) and InStr("Menu|Group|External", o_MenuInGui.SA[g_intOriginalMenuPosition].AA.strFavoriteType, true)
		Gosub, OpenMenuFromGuiHotkey
	else
		gosub, GuiEditFavorite
}
else if (A_GuiEvent = "I") ; Item changed, change Edit button label
{
	g_intFavoriteSelected := LV_GetCount("Selected")
	if (g_intFavoriteSelected > 1)
	{
		GuiControl, Disable, f_lblGuiEditFavorite
		GuiControl, Show, f_picGuiEditFavorited
		GuiControl, Hide, f_picGuiEditFavorite
		g_blnEditButtonDisabled := true
		
		GuiControl, , f_lblGuiRemoveFavorite, % o_L["GuiRemoveFavorite"] . " (" . g_intFavoriteSelected . ")"
		GuiControl, +gGuiRemoveMultipleFavorites, f_lblGuiRemoveFavorite
		GuiControl, +gGuiRemoveMultipleFavorites, f_picGuiRemoveFavorite
		
		GuiControl, , f_lblGuiMoveFavorite, % o_L["GuiMove"] . " (" . g_intFavoriteSelected . ")"
		GuiControl, +gGuiMoveMultipleFavoritesToMenu, f_lblGuiMoveFavorite
		GuiControl, +gGuiMoveMultipleFavoritesToMenu, f_picGuiMoveFavorite
		
		GuiControl, , f_lblGuiCopyFavorite, % o_L["DialogCopy"] . " (" . g_intFavoriteSelected . ")"
		GuiControl, +gGuiCopyMultipleFavoritesToMenu, f_lblGuiCopyFavorite
		GuiControl, +gGuiCopyMultipleFavoritesToMenu, f_picGuiCopyFavorite
		
		GuiControl, +gGuiMoveMultipleFavoritesUp, f_picMoveFavoriteUp
		GuiControl, +gGuiMoveMultipleFavoritesDown, f_picMoveFavoriteDown
	}
	else
	{
		GuiControl, Enable, f_lblGuiEditFavorite
		GuiControl, Show, f_picGuiEditFavorite
		GuiControl, Hide, f_picGuiEditFavorited
		g_blnEditButtonDisabled := false
		
		GuiControl, , f_lblGuiRemoveFavorite, % o_L["GuiRemoveFavorite"]
		GuiControl, +gGuiRemoveFavorite, f_lblGuiRemoveFavorite
		GuiControl, +gGuiRemoveFavorite, f_picGuiRemoveFavorite
		
		GuiControl, , f_lblGuiMoveFavorite, % o_L["GuiMove"]
		GuiControl, +gGuiMoveFavoriteToMenu, f_lblGuiMoveFavorite
		GuiControl, +gGuiMoveFavoriteToMenu, f_picGuiMoveFavorite
		
		GuiControl, , f_lblGuiCopyFavorite, % o_L["DialogCopy"]
		GuiControl, +gGuiCopyFavorite, f_lblGuiCopyFavorite
		GuiControl, +gGuiCopyFavorite, f_picGuiCopyFavorite
		
		GuiControl, +gGuiMoveFavoriteUp, f_picMoveFavoriteUp
		GuiControl, +gGuiMoveFavoriteDown, f_picMoveFavoriteDown
	}

	Menu, menuBarFavorite, % (g_intFavoriteSelected = 1 ? "Enable" : "Disable"), % aaFavoriteL["DialogEdit"] ; edit menu only if one item is selected
	Menu, menuBarFavorite, Enable, % aaFavoriteL["ControlToolTipSortFavorites"] ; re-enable if disabled by GuiCancel for Favorite Tray menu
	loop, Parse, % "GuiRemoveFavorite|GuiMove|DialogCopy|ControlToolTipMoveUp|ControlToolTipMoveDown", |
		Menu, menuBarFavorite, % (g_intFavoriteSelected ? "Enable" : "Disable"), % aaFavoriteL[A_LoopField] ; enable only if at least one item is selected
}

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiFocusFilter:
;------------------------------------------------------------

gosub, GuiFavoritesListFilterShow

GuiControl, 1:Focus, f_strFavoritesListFilter
if (g_blnFavoritesListFilterNeverFocused)
{
	GuiControl, 1:, f_strFavoritesListFilter, % ""
	g_blnFavoritesListFilterNeverFocused := false
}

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiFavoritesListFilteredEvents:
;------------------------------------------------------------

if (A_GuiEvent = "DoubleClick")
{
	g_blnOpenFromDoubleClick := true
	gosub, GuiEditFavorite
}

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiFavoritesListFilterButton:
GuiFavoritesListFilterShow:
GuiFavoritesListFilterHide:
;------------------------------------------------------------

if (A_ThisLabel = "GuiFavoritesListFilterButton")
{
	GuiControlGet, g_blnFilterVisible, Visible, f_strFavoritesListFilter
	g_blnFilterVisible := !g_blnFilterVisible ; reverse visible state
}
else ; GuiFavoritesListFilterHide
	g_blnFilterVisible := (A_ThisLabel = "GuiFavoritesListFilterShow" ? true : false) ; show else hide

strShowHideCommand := (g_blnFilterVisible ? "Hide" : "Show")
GuiControl, %strShowHideCommand%, f_drpMenusList
GuiControl, %strShowHideCommand%, f_picSearch
GuiControl, , f_lblMenuDropdownOrSearchLabel, % (g_blnFilterVisible ? o_L["DialogSearch"] . ":" : o_L["GuiSubmenuDropdownLabel"])

strShowHideCommand := (g_blnFilterVisible ? "Show" : "Hide")
GuiControl, %strShowHideCommand%, f_strFavoritesListFilter
GuiControl, %strShowHideCommand%, f_btnFavoritesListNoFilter
GuiControl, %strShowHideCommand%, f_blnFavoritesListFilterExtended

strShowHideCommand := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiAddFavoriteFromQAPFeatureFolder:
GuiAddFavoriteFromQAPFeatureDocument:
GuiAddFavoriteFromQAPFeatureApplication:
GuiAddFavoriteFromQAPFeatureSpecial:
GuiAddFavoriteFromQAPFeatureURL:
GuiAddFavoriteFromQAPFeatureFTP:
GuiAddFavoriteFromQAPFeatureQAP:
GuiAddFavoriteFromQAPFeatureMenu:
GuiAddFavoriteFromQAPFeatureGroup:
GuiAddFavoriteFromQAPFeatureSnippet:
GuiAddFavoriteFromQAPFeatureExternal:
GuiAddFavoriteFromQAPFeatureText:
GuiAddFavoriteFromQAPFeatureWindowsApp:
;------------------------------------------------------------

g_strAddFavoriteType := StrReplace(A_ThisLabel, "GuiAddFavoriteFromQAPFeature")

gosub, GuiShowFromGuiAddFavoriteQAPFeature
gosub, GuiFavoritesListFilterEmpty ; restore regular favorites list
g_intNewItemPos := (o_Settings.SettingsWindow.blnAddAutoAtTop.IniValue ? (g_objMenusIndex[A_ThisMenu][1].FavoriteType = "B" ? 2 : 1): g_objMenusIndex[A_ThisMenu].MaxIndex() + 1) ; 
g_intOriginalMenuPosition := g_intNewItemPos

if o_MenuInGui.FavoriteIsUnderExternalMenu(o_ExternalMenu) and !o_ExternalMenu.ExternalMenuAvailableForLock()
; this favorite could not be added because it is in an external menu locked by another user,
; or because external settings file is in a read-only folder, or because external files was modified 
; by another user since it was loaded in QAP by this user
	return

gosub, GuiAddFavorite

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiAddFavoriteSelectType:
GuiAddFavoriteFromQAPFeature:
;------------------------------------------------------------

if (A_ThisLabel = "GuiAddFavoriteFromQAPFeature")
{
	gosub, GuiShowFromGuiAddFavoriteQAPFeature
	g_intNewItemPos := (o_Settings.SettingsWindow.blnAddAutoAtTop.IniValue ? 1 : o_Containers.AA[A_ThisMenu].SA.MaxIndex() + 1) ; 
}

gosub, GuiFavoritesListFilterEmpty ; restore regular favorites list

if o_MenuInGui.FavoriteIsUnderExternalMenu(o_ExternalMenu) and !o_ExternalMenu.ExternalMenuAvailableForLock()
; this favorite could not be added because it is in an external menu locked by another user,
; or because external settings file is in a read-only folder, or because external files was modified 
; by another user since it was loaded in QAP by this user
	return
	
g_intGui1WinID := WinExist("A")
Gui, 1:Submit, NoHide
Gui, 1:ListView, f_lvFavoritesList ; should be set by LoadFavoritesInGuiFiltered already but seems not to be?
g_intOriginalMenuPosition := (LV_GetCount() ? (LV_GetNext() ? LV_GetNext() : 0xFFFF) : 1)

strGuiTitle := L(o_L["DialogAddFavoriteSelectTitle"], g_strAppNameText, g_strAppVersion)
Gui, 2:New, +Hwndg_strGui2Hwnd, %strGuiTitle%
Gui, 2:+Owner1
Gui, 2:+OwnDialogs
if (g_blnUseColors)
	Gui, 2:Color, %g_strGuiWindowColor%

Gui, 2:Add, Text, x10 y+20, % o_L["DialogAdd"] . ":"
Gui, 2:Add, Text, x+10 yp section

; Folder|Document|Application|Special|URL|FTP|QAP|Menu|Group|X|K|B|Snippet|Text
Gui, 2:Add, Radio, xs yp vf_intRadioFavoriteTypeFolder gFavoriteSelectTypeRadioButtonsChanged, % o_Favorites.GetFavoriteTypeObject("Folder").strFavoriteTypeLabel
Gui, 2:Add, Radio, xs vf_intRadioFavoriteTypeSpecial gFavoriteSelectTypeRadioButtonsChanged, % o_Favorites.GetFavoriteTypeObject("Special").strFavoriteTypeLabel

Gui, 2:Add, Radio, xs y+15 vf_intRadioFavoriteTypeDocument gFavoriteSelectTypeRadioButtonsChanged, % o_Favorites.GetFavoriteTypeObject("Document").strFavoriteTypeLabel
Gui, 2:Add, Radio, xs vf_intRadioFavoriteTypeApplication gFavoriteSelectTypeRadioButtonsChanged, % o_Favorites.GetFavoriteTypeObject("Application").strFavoriteTypeLabel
Gui, 2:Add, Radio, xs vf_intRadioFavoriteTypeWindowsApp gFavoriteSelectTypeRadioButtonsChanged, % o_Favorites.GetFavoriteTypeObject("WindowsApp").strFavoriteTypeLabel
Gui, 2:Add, Radio, xs vf_intRadioFavoriteTypeURL gFavoriteSelectTypeRadioButtonsChanged, % o_Favorites.GetFavoriteTypeObject("URL").strFavoriteTypeLabel
Gui, 2:Add, Radio, xs vf_intRadioFavoriteTypeFTP gFavoriteSelectTypeRadioButtonsChanged, % o_Favorites.GetFavoriteTypeObject("FTP").strFavoriteTypeLabel

Gui, 2:Add, Radio, xs y+15 vf_intRadioFavoriteTypeSnippet gFavoriteSelectTypeRadioButtonsChanged, % o_Favorites.GetFavoriteTypeObject("Snippet").strFavoriteTypeLabel

Gui, 2:Add, Radio, y+15 xs vf_intRadioFavoriteTypeQAP gFavoriteSelectTypeRadioButtonsChanged, % o_Favorites.GetFavoriteTypeObject("QAP").strFavoriteTypeLabel

Gui, 2:Add, Radio, y+15 xs vf_intRadioFavoriteTypeMenu gFavoriteSelectTypeRadioButtonsChanged, % o_Favorites.GetFavoriteTypeObject("Menu").strFavoriteTypeLabel
Gui, 2:Add, Radio, xs vf_intRadioFavoriteTypeExternal gFavoriteSelectTypeRadioButtonsChanged, % o_Favorites.GetFavoriteTypeObject("External").strFavoriteTypeLabel
Gui, 2:Add, Radio, xs vf_intRadioFavoriteTypeGroup gFavoriteSelectTypeRadioButtonsChanged, % o_Favorites.GetFavoriteTypeObject("Group").strFavoriteTypeLabel

Gui, 2:Add, Radio, xs y+15 vf_intRadioFavoriteTypeText gFavoriteSelectTypeRadioButtonsChanged, % o_Favorites.GetFavoriteTypeObject("Text").strFavoriteTypeLabel

Gui, 2:Add, Button, x+20 y+20 vf_btnAddFavoriteSelectTypeContinue gGuiAddFavoriteSelectTypeContinue default, % o_L["DialogContinue"]
Gui, 2:Add, Button, yp vf_btnAddFavoriteSelectTypeCancel gGuiAddFavoriteCancel, % o_L["GuiCancel"]
Gui, Add, Text
Gui, 2:Add, Text, xs+120 ys vf_lblAddFavoriteTypeHelp w250 h290, % L(o_L["DialogFavoriteSelectType"], o_L["DialogContinue"])

GuiCenterButtons(strGuiTitle, 10, 5, 20, "f_btnAddFavoriteSelectTypeContinue", "f_btnAddFavoriteSelectTypeCancel")
Gosub, ShowGui2AndDisableGui1

o_ExternalMenu := ""
strGuiTitle := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
FavoriteSelectTypeRadioButtonsChanged:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

g_strAddFavoriteType := "" ; start fresh

; Folder|Document|Application|Special|URL|FTP|QAP|Menu|Group|X|K|B|Snippet|External|Text|WindowsApp
Loop, % o_Favorites.s_SA.Length()
{
	strThisType := o_Favorites.s_SA[A_Index].strFavoriteTypeSystemName
	GuiControlGet, blnThisType, , % "f_intRadioFavoriteType" . strThisType
	if (blnThisType)
	{
		GuiControl, , f_lblAddFavoriteTypeHelp, % o_Favorites.s_SA[A_Index].strFavoriteTypeHelp
		g_strAddFavoriteType := strThisType
		break
	}
}

if (A_GuiEvent = "DoubleClick")
	Gosub, GuiAddFavoriteSelectTypeContinue

strThisType := ""
blnThisType := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiAddFavoriteSelectTypeContinue:
;------------------------------------------------------------

Gui, 2:Submit, NoHide

if !StrLen(g_strAddFavoriteType)
{
	Oops(o_L["DialogFavoriteSelectType"], o_L["DialogContinue"])
	return
}

Gosub, GuiAddFavorite

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiDropFiles:
;------------------------------------------------------------

GetTargetWinIdAndClass(g_strTargetWinId, g_strTargetClass) ; returns current or latest file manager window ID and Window class
	
Loop, parse, A_GuiEvent, `n
{
    g_strNewLocation = %A_LoopField%
    Break
}

g_intOriginalMenuPosition := (LV_GetCount() ? (LV_GetNext() ? LV_GetNext() + 1 : 0xFFFF) : 1)
Gosub, GuiAddFromDropFiles

return
;------------------------------------------------------------


;------------------------------------------------------------
AddThisFolder:
AddThisFolderXpress:
AddThisFolderFromMsg:
AddThisFolderFromMsgXpress:
AddThisFileFromMsg:
AddThisFileFromMsgXpress:
AddThisShortcutFromMsg:
;------------------------------------------------------------

if (A_ThisLabel = "AddThisFolder" and g_blnLaunchFromTrayIcon)
	; returns current or latest file manager window ID and Window class (including dialog boxes), and re-activate the last active file manager window
	; GetTargetWinIdAndClass(ByRef strThisId, ByRef strThisClass, blnActivate := false, blnExcludeDialogBox := false, blnIncludeBrowsers := false)
	GetTargetWinIdAndClass(g_strTargetWinId, g_strTargetClass, true, false, true)

; if A_ThisLabel contains "Msg", we already have g_strNewLocation set by RECEIVE_QAPMESSENGER

if !InStr(A_ThisLabel, "Msg") ; exclude AddThisFolderFromMsg, AddThisFileFromMsg and AddThisShortcutFromMsg
	g_strNewLocation := GetCurrentLocation(g_strTargetClass, g_strTargetWinId)

g_strNewLocationSpecialName := ""
if o_SpecialFolders.aaClassIdOrPathByDefaultName.HasKey(g_strNewLocation)
{
	; we have a known special folder (some special folders like "Bibliothques\Images" or "Libraries\Pictures" are not known yet)
	g_strNewLocationSpecialName := g_strNewLocation
	g_strNewLocation := o_SpecialFolders.aaClassIdOrPathByDefaultName[g_strNewLocation]
}

If !StrLen(g_strNewLocation)
	or !(InStr(g_strNewLocation, ":") or InStr(g_strNewLocation, "\\") or  InStr(g_strNewLocation, "{"))
{
	if (A_ThisLabel = "AddThisFolder" and g_blnLaunchFromTrayIcon)
	{
		Gui, 1:+OwnDialogs 
		Oops(o_L["OopsAddThisFolderTip"], o_FileManagers.SA[o_FileManagers.P_intActiveFileManager].AA.strDisplayName, o_PopupHotkeyNavigateOrLaunchHotkeyMouse.AA.strPopupHotkeyText
			. " " . o_L["DialogOr"] . " " . o_PopupHotkeyNavigateOrLaunchHotkeyKeyboard.AA.strPopupHotkeyText)
	}
	else
	{
		Gui, 1:+OwnDialogs 
		MsgBox, 52, % L(o_L["DialogAddFolderManuallyTitle"], g_strAppNameText, g_strAppVersion), % o_L["DialogAddFolderManuallyPrompt"]
		IfMsgBox, Yes
		{
			Gosub, GuiShowFromAddThisFolder
			g_strAddFavoriteType := "Folder"
			Gosub, GuiAddFavorite
		}
	}
	return
}
else
{
	if !InStr(A_ThisLabel, "Xpress") ; NOT Xpress
	{
		; initialy position new entry at top or bottom of menu
		g_intOriginalMenuPosition := (o_Settings.SettingsWindow.blnAddAutoAtTop.IniValue ? 1 : 0xFFFF)
		
		Gosub, GuiShowFromAddThisFolder ; except for Express add, show Settings window
		
		if (A_ThisLabel = "AddThisFolder")
			
			Gosub, GuiAddThisFolder
			
		else if (A_ThisLabel = "AddThisFolderFromMsg")
			
			Gosub, GuiAddThisFolderFromMsg
			
		else if (A_ThisLabel = "AddThisFileFromMsg")
			
			Gosub, GuiAddThisFileFromMsg
			
		else if (A_ThisLabel = "AddThisShortcutFromMsg")
			
			Gosub, GuiAddShortcutFromMsg
			
	}
	else ; AddThisFolderXpress, AddThisFolderFromMsgXpress or AddThisFileFromMsgXpress
	{
		; in Express mode, g_intOriginalMenuPosition will be set in GuiAddFavoriteSaveXpress
		if (A_ThisLabel = "AddThisFolderXpress")
			
			Gosub, GuiAddThisFolderXpress
			
		else if (A_ThisLabel = "AddThisFolderFromMsgXpress")
			
			Gosub, GuiAddThisFolderFromMsgXpress
			
		else ; AddThisFileFromMsgXpress
			
			Gosub, GuiAddThisFileFromMsgXpress
		
		Gosub, GuiSaveAndCloseFavorites ; for Express save all favorites to ini file
	}
}

objPrevClipboard := ""
strIDs := ""
strMouseHotkey := ""
strKeyboardHotkey := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GetTargetWinIdAndClass(ByRef strThisId, ByRef strThisClass, blnActivate := false, blnExcludeDialogBox := false, blnIncludeBrowsers := false)
; return ByRef parameters for g_strTargetWinId and g_strTargetClass (or current file manager ID and class if called to reopen current location)
; called when g_strTargetWinId and g_strTargetClass are not updated when invoking the popup menu
; with blnActivate true when add folder from QAP tray icon
; with blnExcludeDialogBox true when reopen file manager current location in dialog box
;------------------------------------------------------------
{
	DetectHiddenWindows, Off
	WinGet, strIDs, list
	DetectHiddenWindows, On ; revert to app default

	strBrowsersClass := g_strModernBrowsers . "," . g_strLegacyBrowsers
	
	Loop, %strIDs%
	{
		intThisIDIndex := A_Index
		WinGetClass, strThisClass, % "ahk_id " . strIDs%intThisIDIndex%
		if WindowIsExplorer(strThisClass)
			or (WindowIsDirectoryOpus(strThisClass) and o_FileManagers.P_intActiveFileManager = 2)
			or (WindowIsTotalCommander(strThisClass) and o_FileManagers.P_intActiveFileManager = 3)
			or (WindowIsDialog(strThisClass, strIDs%intThisIDIndex%) and !blnExcludeDialogBox)
		{
			if (blnActivate)
			{
				WinActivate, % "ahk_id " . strIDs%intThisIDIndex% ; scan items of the array from the most recently active before invoking the popup menu from the tray icon
				WinWaitActive, % "ahk_id " . strIDs%intThisIDIndex%, , 1 ; wait up to 1 seconds
			}
			strThisId := strIDs%intThisIDIndex%
			break
		}
		else if (blnIncludeBrowsers)
			loop, parse, strBrowsersClass, `,
				if (A_LoopField = strThisClass)
				{
					if (blnActivate)
					{
						WinActivate, % "ahk_id " . strIDs%intThisIDIndex% ; scan items of the array from the most recently active before invoking the popup menu from the tray icon
						WinWaitActive, % "ahk_id " . strIDs%intThisIDIndex%, , 1 ; wait up to 1 seconds
					}
					strThisId := strIDs%intThisIDIndex%
					WinGetClass, TEST, % "ahk_id " . strIDs%intThisIDIndex%
					break, 2
				}
	}
}
;------------------------------------------------------------


;========================================================================================================================
; END OF FAVORITES_LIST
;========================================================================================================================


;========================================================================================================================
!_032_FAVORITE_GUI:
;========================================================================================================================

;------------------------------------------------------------
GuiAddFavorite:
GuiAddThisFolder:
GuiAddThisFolderXpress:
GuiAddThisFolderFromMsg:
GuiAddThisFolderFromMsgXpress:
GuiAddThisFileFromMsg:
GuiAddThisFileFromMsgXpress:
GuiAddShortcutFromMsg:
GuiAddFromDropFiles:
GuiEditFavorite:
GuiCopyFavorite:
GuiAddExternalFromCatalogue:
GuiAddExternalOtherExternal:
;------------------------------------------------------------

strGuiFavoriteLabel := A_ThisLabel
g_blnAbortEdit := false

; must be before GuiFavoriteInit and GuiAddFavoriteSaveXpress
g_strTypesForTabWindowOptions := "|Folder|Special|FTP" . (o_Settings.Execution.blnTryWindowPosition.IniValue ? "|Document|Application|URL|WindowsApp" : "") ; must start with "|"
g_strTypesForTabAdvancedOptions := "|Folder|Document|Application|Special|URL|FTP|Snippet|QAP|Group|WindowsApp" ; must start with "|"

Gosub, GuiFavoriteInit

if (g_blnAbortEdit)
{
	gosub, GuiAddFavoriteCleanup
	return
}

if InStr(strGuiFavoriteLabel, "Xpress") or (strGuiFavoriteLabel = "GuiAddExternalFromCatalogue") ; when from GuiAddExternalFromCatalogue, item is saved in ButtonAddExternalMenusFromCatalogue
{
	if InStr(strGuiFavoriteLabel, "Xpress")
		gosub, GuiAddFavoriteSaveXpress ; save this new favorite and return
	gosub, GuiAddFavoriteCleanup
	return
}

gosub, CheckShowSettings

Gui, 1:Submit, NoHide
if (strGuiFavoriteLabel = "GuiAddFavorite")
	Gosub, 2GuiClose ; to avoid flashing Gui 1:

strGuiTitle := L(o_L["DialogAddEditFavoriteTitle"]
	, (InStr(strGuiFavoriteLabel, "GuiEditFavorite") ? o_L["DialogEdit"] : (strGuiFavoriteLabel = "GuiCopyFavorite" ? o_L["DialogCopy"] : o_L["DialogAdd"]))
	, g_strAppNameText, g_strAppVersion, o_EditedFavorite.AA.strFavoriteType)
Gui, 2:New, +Resize -MaximizeBox +MinSize560x505 +MaxSizex505 +Hwndg_strGui2Hwnd, %strGuiTitle%
Gui, 2:+Owner1
Gui, 2:+OwnDialogs
if (g_blnUseColors)
	Gui, 2:Color, %g_strGuiWindowColor%

intTabHeight := 440
g_strTabsList := BuildTabsList(o_EditedFavorite.AA.strFavoriteType)
Gui, 2:Add, Tab2, % "vf_intAddFavoriteTab w520 h" . intTabHeight . " gGuiAddFavoriteTabChanged AltSubmit", %g_strTabsList%
intTabNumber := 0

; ------ BUILD TABS ------

Gosub, GuiFavoriteTabBasic

Gosub, GuiFavoriteIconDefault ; init default icon now that f_strFavoriteLocation has been set in the Basic tab

Gosub, GuiFavoriteTabMenuOptions

if InStr(g_strTabsList, o_L["DialogAddFavoriteTabsLive"])
	Gosub, GuiFavoriteTabLiveFolderOptions

if InStr(g_strTabsList, g_objFavoriteGuiTabs[3])
	Gosub, GuiFavoriteTabWindowOptions

If InStr(g_strTabsList, g_objFavoriteGuiTabs[4])
	Gosub, GuiFavoriteTabAdvancedSettings

if InStr(g_strTabsList, o_L["DialogAddFavoriteTabsExternal"])
	Gosub, GuiFavoriteTabExternal

Gosub, CheckboxFolderLiveClicked

; ------ TABS End ------

aaL := o_L.InsertAmpersand(false, "DialogAdd", "DialogOK", "GuiCancel", "DialogCopy") 

Gui, 2:Tab

intButtonsY := 460

; see same if/else conditions in TreeViewQAPChanged and TreeViewSpecialChanged to save favorite when event DoubleClick
if InStr(strGuiFavoriteLabel, "GuiEditFavorite")
{
	Gui, 2:Add, Button, y%intButtonsY% vf_btnEditFavoriteSave gGuiEditFavoriteSave default, % aaL["DialogOK"]
	Gui, 2:Add, Button, yp vf_btnAddFavoriteCancel gGuiAddFavoriteCancel, % aaL["GuiCancel"]
	
	GuiCenterButtons(strGuiTitle, 10, 5, 20, "f_btnEditFavoriteSave", "f_btnAddFavoriteCancel")
}
else if InStr(strGuiFavoriteLabel, "GuiCopyFavorite")
{
	Gui, 2:Add, Button, y%intButtonsY% vf_btnCopyFavoriteCopy gGuiCopyFavoriteSave default, % aaL["DialogCopy"]
	Gui, 2:Add, Button, yp vf_btnAddFavoriteCancel gGuiAddFavoriteCancel, % aaL["GuiCancel"]
	
	GuiCenterButtons(strGuiTitle, 10, 5, 20, "f_btnCopyFavoriteCopy", "f_btnAddFavoriteCancel")
}
else
{
	Gui, 2:Add, Button, y%intButtonsY% vf_btnAddFavoriteAdd gGuiAddFavoriteSave default, % aaL["DialogAdd"]
	Gui, 2:Add, Button, yp vf_btnAddFavoriteCancel gGuiAddFavoriteCancel, % aaL["GuiCancel"]
	
	GuiCenterButtons(strGuiTitle, 10, 5, 20, "f_btnAddFavoriteAdd", "f_btnAddFavoriteCancel")
}

if InStr("Folder|Document|Application", o_EditedFavorite.AA.strFavoriteType)
	GuiControl, 2:+Default, f_btnSelectFolderLocation
else
	GuiControl, 2:+Default, f_btnAddFavoriteAdd

if (o_EditedFavorite.AA.strFavoriteType = "Special")
	GuiControl, 2:Focus, f_tvSpecial
else if (o_EditedFavorite.AA.strFavoriteType = "QAP")
	GuiControl, 2:Focus, f_tvQAP
else
{
	GuiControl, 2:Focus, f_strFavoriteShortName
	if InStr("GuiEditFavorite|GuiCopyFavorite", strGuiFavoriteLabel) 
		SendInput, ^a
}

Gosub, DropdownParentMenuChanged ; to init the content of menu items

Gui, 2:Add, Text

GetGui2Size("AddEditCopyFavoriteDialogPosition", intGui2Width, intGui2Height)
if (intGui2Height < 544) ; minimum height since v8.7.0.9.2
	intGui2Height := 544
WinMove, ahk_id %g_strGui2Hwnd%, , , , %intGui2Width%, %intGui2Height% ; restore only size, always position relative to Settings window
Gosub, ShowGui2AndDisableGui1

if (o_EditedFavorite.AA.strFavoriteName = o_L["ToolTipRetrievingWebPageTitle"])
{
	GuiControl, Disable, f_strFavoriteShortName
	o_EditedFavorite.AA.strFavoriteName := GetWebPageTitle(g_strNewLocation)
	GuiControl, , f_strFavoriteShortName, % o_EditedFavorite.AA.strFavoriteName
	GuiControl, Enable, f_strFavoriteShortName
}


GuiAddFavoriteCleanup:
blnIsGroupMember := ""
ResetArray("arrTop")
g_strNewLocation := ""
g_blnAbortEdit := ""
o_ExternalMenu := ""
strDialogPosition := ""
intGui2Width := ""
intGui2Height := ""
ResetArray("arrDialogPosition")
strGuiTitle := ""
aaL := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
BuildTabsList(strFavoriteType)
;------------------------------------------------------------
{
	global

	; 1 Basic Settings, 2 Menu Options, 3 Window Options, 4 Advanced Settings
	strTabsList := " " . g_objFavoriteGuiTabs[1] . " | " . g_objFavoriteGuiTabs[2]
	
	if (strFavoriteType = "Folder") and !(blnIsGroupMember)
		strTabsList .= " | " . o_L["DialogAddFavoriteTabsLive"]
	if (InStr(g_strTypesForTabWindowOptions, "|" . strFavoriteType)
		and ((o_FileManagers.P_intActiveFileManager = 1 or o_FileManagers.P_intActiveFileManager = 3) or o_Settings.Execution.blnTryWindowPosition.IniValue)) ; Explorer or Total Commander
		strTabsList .= " | " . g_objFavoriteGuiTabs[3]
	if InStr(g_strTypesForTabAdvancedOptions, "|" . strFavoriteType)
		strTabsList .= " | " . g_objFavoriteGuiTabs[4]
	if (strFavoriteType = "External")
		strTabsList .= " | " . o_L["DialogAddFavoriteTabsExternal"]
	
	strTabsList .= "  "
	
	return strTabsList
}
;------------------------------------------------------------


;------------------------------------------------------------
GuiFavoriteInit:
;------------------------------------------------------------
; Icon resource in the format "iconfile,index", example "shell32.dll,2"
; g_strDefaultIconResource -> default icon for the current type of favorite
; g_strNewFavoriteIconResource -> icon currently displayed in the Add/Edit dialog box

; g_strNewFavoriteShortcut -> actual hotkey in internal format displayed as text in the Add/Edit dialog box

; when edit favorite, keep original values in o_EditedFavorite
; when add favorite, put initial or default values in o_EditedFavorite and update them when gui save

blnFavoriteFromSearch := StrLen(GetFavoritesListFilter())

if (blnFavoriteFromSearch)
	o_MenuInGui := GetMenuForGuiFiltered(g_intOriginalMenuPosition)

if o_MenuInGui.FavoriteIsUnderExternalMenu(o_ExternalMenu) and !o_ExternalMenu.ExternalMenuAvailableForLock()
; this favorite could not be added or edited because it is in an external menu locked by another user,
; or because external settings file is in a read-only folder, or because external files was modified 
; by another user since it was loaded in QAP by this user
{
	g_blnAbortEdit := true
	return
}

if (blnFavoriteFromSearch)
{
	gosub, OpenMenuFromGuiSearch ; open the parent menu of found selected favorite
	gosub, GuiFavoritesListFilterEmpty ; must be after we opened the menu

	if (o_MenuInGui.SA[g_intOriginalMenuPosition].IsContainer() and g_blnOpenFromDoubleClick)
	{
		gosub, OpenMenuFromGuiHotkey ; load the selected found menu in gui
		g_blnOpenFromDoubleClick := false ; reset value
		g_blnAbortEdit := true
		return
	}
}

o_EditedFavorite := new Container.Item([]) ; declared global earlier
g_strDefaultIconResource := ""
g_strNewFavoriteIconResource := ""

blnIsGroupMember := (o_MenuInGui.AA.strMenuType = "Group")

if InStr("GuiEditFavorite|GuiCopyFavorite", strGuiFavoriteLabel)
{
	Gui, 1:ListView, f_lvFavoritesList
	g_intOriginalMenuPosition := LV_GetNext()

	if !(g_intOriginalMenuPosition)
	{
		Oops(o_L[(strGuiFavoriteLabel = "GuiCopyFavorite" ? "DialogSelectItemOneOrMore" : "DialogSelectItemToEdit")])
		g_blnAbortEdit := true
		return
	}
	
	if (strGuiFavoriteLabel = "GuiCopyFavorite")
		o_EditedFavorite := o_MenuInGui.SA[g_intOriginalMenuPosition].Backup()
	else
		o_EditedFavorite := o_MenuInGui.SA[g_intOriginalMenuPosition]
	
	if o_EditedFavorite.IsSeparator() ; favorite is menu separator or column break
		g_blnAbortEdit := true
	else if (strGuiFavoriteLabel = "GuiCopyFavorite" and InStr("Menu|Group|External", o_EditedFavorite.AA.strFavoriteType, true)) ; menu or group cannot be copied
	{
		Oops(o_L["OopsCannotCopyFavorite"], o_Favorites.GetFavoriteTypeObject(o_EditedFavorite.AA.strFavoriteType).strFavoriteTypeShortName)
		g_blnAbortEdit := true
	}
	
	if (g_blnAbortEdit = true)
		return

	g_strNewFavoriteIconResource := o_EditedFavorite.AA.strFavoriteIconResource
	g_strNewFavoriteWindowPosition := o_EditedFavorite.AA.strFavoriteWindowPosition
	g_blnNewFavoriteFtpEncoding := o_EditedFavorite.AA.blnFavoriteFtpEncoding

	if (strGuiFavoriteLabel = "GuiCopyFavorite")
		g_strNewFavoriteShortcut := "None" ; copied favorite has no hotkey
	else
		g_strNewFavoriteShortcut := o_EditedFavorite.AA.strFavoriteShortcut

	if (o_EditedFavorite.AA.strFavoriteType = "Group")
		; 1 boolean value (replace existing Explorer windows if true, add to existing Explorer Windows if false)
		; 2 restore folders with "Explorer" or "Other" (Directory Opus, Total Commander or QAPconnect)
		; 3 delay in milliseconds to insert between each favorite to restore
		g_saGroupInGuiSettings := StrSplit(o_EditedFavorite.AA.strFavoriteGroupSettings, ",")
	
	o_EditedFavorite.AA.strFavoriteDateModified := A_NowUTC
}
else ; add favorite
{
	strOriginalExtension := GetFileExtension(g_strNewLocation)
	if (strGuiFavoriteLabel = "GuiAddShortcutFromMsg" or strOriginalExtension = "lnk")
	{
		strShortcutFilename := GetLocationPathName(g_strNewLocation) ; save the name of the lnk as new favorite name
		; FileGetShortcut, %file%, OutTarget, OutDir, OutArgs, OutDesc, OutIcon, OutIconNum, OutRunState
		FileGetShortcut, %g_strNewLocation%, strShortcutLocation, strShortcutWorkingDir, strShortcutArgs, , strShortcutIconFile, strShortcutIconIndex, intShortcutRunState
		if StrLen(strShortcutLocation)
			g_strNewLocation := strShortcutLocation
		; else keep the original .lnk path-name
	}
		
	if !WindowIsDialog(g_strTargetClass, g_strTargetWinId)
		and (InStr(strGuiFavoriteLabel, "ThisFolder") ; includes all ...FromMsg
			or (strGuiFavoriteLabel = "GuiAddFromDropFiles"))
	{
		WinGetPos, intX, intY, intWidth, intHeight, ahk_id %g_strTargetWinId%
		WinGet, intMinMax, MinMax, ahk_id %g_strTargetWinId% ; -1: minimized, 1: maximized, 0: neither minimized nor maximized
		; Boolean,MinMax,Left,Top,Width,Height,Delay,RestoreSide/Monitor (comma delimited)
		; 0 for use default / 1 for remember, -1 Minimized / 0 Normal / 1 Maximized, Left (X), Top (Y), Width, Height; for example: "1,0,100,50,640,480,200"
		; record position but keep "use default position"
		g_strNewFavoriteWindowPosition := "0," . intMinMax . "," . intX . "," . intY . "," . intWidth . "," . intHeight . ",200"
	}
	else
		g_strNewFavoriteWindowPosition := ""

	if (strGuiFavoriteLabel = "GuiAddExternalOtherExternal")
	{
		strGuiFavoriteLabel := "GuiAddFavorite"
		blnNoExternalMenusCatalogue := true
	}
	else
		blnNoExternalMenusCatalogue := false
	
	if (strGuiFavoriteLabel <> "GuiAddFavorite")
	; includes GuiAddThisFolder, GuiAddThisFolderXpress, GuiAddThisFolderFromMsg, GuiAddThisFolderFromMsgXpress,
	; GuiAddThisFileFromMsg, GuiAddThisFileFromMsgXpress, GuiAddFromDropFiles, GuiAddExternalFromCatalogue
	{
		; g_strNewLocation is received from AddThisFolder (etc.), GuiDropFiles or ButtonAddExternalMenusFromCatalogue
		if (strGuiFavoriteLabel = "GuiAddExternalFromCatalogue")
		{
			o_EditedFavorite.AA.strFavoriteAppWorkingDir := g_strNewLocation
			strExternalMenuName := o_Settings.ReadIniValue("MenuName", " ", "Global", g_strNewLocation)
			o_EditedFavorite.AA.strFavoriteName := (StrLen(strExternalMenuName) ? strExternalMenuName : GetLocationPathName(g_strNewLocation))
			o_EditedFavorite.AA.strFavoriteType := "External"
			g_strNewFavoriteIconResource := "iconSubmenu"
		}
        else if (strOriginalExtension = "lnk")
            
            o_EditedFavorite.AA.strFavoriteName := strShortcutFilename ; other fields filled later
            
		else ; all other labels
		{
			o_EditedFavorite.AA.strFavoriteLocation := g_strNewLocation
			if LocationIsHttp(g_strNewLocation)
			{
				o_EditedFavorite.AA.strFavoriteType := "URL"
				o_EditedFavorite.AA.strFavoriteName := o_L["ToolTipRetrievingWebPageTitle"]
				g_strNewFavoriteIconResource := g_strURLIconFileIndex
			}
			else
				o_EditedFavorite.AA.strFavoriteName := (StrLen(g_strNewLocationSpecialName) ? g_strNewLocationSpecialName : GetLocationPathName(g_strNewLocation))
		}
	}
	g_strNewFavoriteShortcut := "None" ; internal name

	if (strGuiFavoriteLabel = "GuiAddFavorite")
	{
		o_EditedFavorite.AA.strFavoriteType := g_strAddFavoriteType
		
		if (g_strAddFavoriteType = "External") and !(blnNoExternalMenusCatalogue) and FileExist(EnvVars(o_Settings.SettingsFile.strExternalMenusCataloguePath.IniValue))
		{
			Gosub, AddExternalMenusFromCatalogue
			g_blnAbortEdit := true ; data from AddExternalMenusFromCatalogue already saved in ButtonAddExternalMenusFromCatalogue
			return
		}
	}
	else if InStr(strGuiFavoriteLabel, "GuiAddThisFolder") ; includes GuiAddThisFolderXpress, GuiAddThisFolderFromMsg and GuiAddThisFolderFromMsgXpress
	{
		if !StrLen(o_EditedFavorite.AA.strFavoriteType) ; exclude case where FavoriteType was set earlier
			if StrLen(g_strNewLocationSpecialName)
				o_EditedFavorite.AA.strFavoriteType := "Special"
			else if SubStr(g_strNewLocation, 1, 6) = "ftp://"
				o_EditedFavorite.AA.strFavoriteType := "FTP"
			else
				o_EditedFavorite.AA.strFavoriteType := "Folder"
	}
	else if InStr("GuiAddFromDropFiles|GuiAddThisFileFromMsg|GuiAddThisFileFromMsgXpress|GuiAddShortcutFromMsg", strGuiFavoriteLabel)
	{
		strExtension := GetFileExtension(g_strNewLocation)
		if StrLen(strExtension) and InStr("exe|com|bat|ahk|vbs|cmd", strExtension)
			o_EditedFavorite.AA.strFavoriteType := "Application"
		else if LocationIsDocument(g_strNewLocation)
			o_EditedFavorite.AA.strFavoriteType := "Document"
		else
			o_EditedFavorite.AA.strFavoriteType := "Folder"
		
		if (strGuiFavoriteLabel = "GuiAddThisFileFromMsgXpress")
		{
			g_strNewFavoriteIconResource := o_EditedFavorite.GetDefaultIcon4Type(g_strNewLocation)
			o_EditedFavorite.AA.strFavoriteIconResource := g_strNewFavoriteIconResource
		}
		
		if (strGuiFavoriteLabel = "GuiAddShortcutFromMsg" or strOriginalExtension = "lnk")
			; as of v9.3.1, the "AddShortcut" context menu (calling this code) has not been fully deployed in setup and portable install scripts
		{
			o_EditedFavorite.AA.strFavoriteLocation := g_strNewLocation
			o_EditedFavorite.AA.strFavoriteAppWorkingDir := (o_EditedFavorite.AA.strFavoriteType = "Application" ? strShortcutWorkingDir : "")
			o_EditedFavorite.AA.strFavoriteArguments := (o_EditedFavorite.AA.strFavoriteType = "Application" ? strShortcutArgs : "")
			g_strNewFavoriteIconResource := (StrLen(strShortcutIconFile) ? EnvVars(strShortcutIconFile) . "," . strShortcutIconIndex : "")
			o_EditedFavorite.AA.strFavoriteIconResource := g_strNewFavoriteIconResource
			if InStr(g_strTypesForTabWindowOptions, "|" . o_EditedFavorite.AA.strFavoriteType)
			{
				; before: intShortcutRunState = Shortcut RunState -> 1 Normal / 3 Maximized / 7 Minimized
				intShortcutRunStateWindowsOptions := (intShortcutRunState = 3 ? 1 : (intShortcutRunState = 7 ? -1 : 0))
				; after: intShortcutRunStateWindowsOptions = QAP RunState -> -1 Minimized / 0 Normal / 1 Maximized
				g_strNewFavoriteWindowPosition :=  (intShortcutRunStateWindowsOptions <> 0 ? "1" : "0") . "," . intShortcutRunStateWindowsOptions ; if state is not normal enable Windows options for Min or Max
			}
			; else keep g_strNewFavoriteWindowPosition empty
			o_EditedFavorite.AA.strFavoriteWindowPosition := g_strNewFavoriteWindowPosition
		}
	}
	
	if (g_strAddFavoriteType = "FTP")
		g_blnNewFavoriteFtpEncoding := (o_FileManagers.P_intActiveFileManager = 3 ? false : true) ; if TotalCommander URL should not be encoded (as hardcoded in OpenFavorite)

	if (o_EditedFavorite.AA.strFavoriteType = "Folder") and StrLen(o_EditedFavorite.AA.strFavoriteLocation) and !StrLen(g_strNewFavoriteIconResource)
	{
		g_strNewFavoriteIconResource := GetFolderIcon(o_EditedFavorite.AA.strFavoriteLocation)
		o_EditedFavorite.AA.strFavoriteIconResource := g_strNewFavoriteIconResource
	}
	
	o_EditedFavorite.AA.strFavoriteDateCreated := A_NowUTC
	o_EditedFavorite.AA.strFavoriteDateModified := o_EditedFavorite.AA.strFavoriteDateCreated
}

; Gosub, GuiFavoriteIconDefault DO NOT INIT DEFAULT ICON HERE BECAUSE WE NEED f_strFavoriteLocation TO BE SET BEFORE WHEN CREATING THE 1ST TAB

intX := ""
intY := ""
intWidth := ""
intHeight := ""
intMinMax := ""
strExternalMenuName := ""
blnNoExternalMenusCatalogue := ""
strShortcutWorkingDir := ""
strShortcutArgs := ""
strShortcutIconFile := ""
strShortcutIconIndex := ""
intShortcutRunState := ""
intShortcutRunStateWindowsOptions := ""
strShortcutLocation := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiFavoriteTabBasic:
;------------------------------------------------------------

Gui, 2:Tab, % ++intTabNumber

Gui, 2:Font, w700
Gui, 2:Add, Text, x20 y50 w500, % o_L["DialogFavoriteType"] . ": " . o_Favorites.GetFavoriteTypeObject(o_EditedFavorite.AA.strFavoriteType).strFavoriteTypeLabel
Gui, 2:Font

Gui, 2:Add, Text, x20 y+10 w500 vf_TypeHelp, % "> " . StrReplace(o_Favorites.GetFavoriteTypeObject(o_EditedFavorite.AA.strFavoriteType).strFavoriteTypeHelp, "`n`n", "`n> ")

if (o_EditedFavorite.AA.strFavoriteType = "Snippet")
{
	GuiControlGet, arrPosTypeHelp, Pos, f_TypeHelp
	g_intTypeHelpY := arrPosTypeHelpY
}

if (o_EditedFavorite.AA.strFavoriteType = "QAP")
	Gui, 2:Add, Edit, x20 y+10 vf_strFavoriteShortName hidden, % o_EditedFavorite.AA.strFavoriteName ; not allow to change favorite short name for QAP feature favorites
else
{
	Gui, 2:Add, Text, % "x20 y+10 vf_ShortNameLabel", % (o_EditedFavorite.AA.strFavoriteType = "Text" ? o_Favorites.GetFavoriteTypeObject("Text").strFavoriteTypeLocationLabel : o_L["DialogFavoriteShortNameLabel"]) . " *"

	Gui, 2:Add, Edit
		, % "x20 y+10 Limit250 vf_strFavoriteShortName h21 w" . 400 - (o_EditedFavorite.AA.strFavoriteType = "Menu" ? 50 : 0)
		, % o_EditedFavorite.AA.strFavoriteName
}

if (InStr("Menu|Group|External", o_EditedFavorite.AA.strFavoriteType, true) and InStr(strGuiFavoriteLabel, "GuiEditFavorite"))
	Gui, 2:Add, Button, x+10 yp gGuiOpenThisMenu, % (o_EditedFavorite.AA.strFavoriteType = "Group" ? o_L["DialogOpenThisGroup"] : o_L["DialogOpenThisMenu"])
else if (o_EditedFavorite.AA.strFavoriteType = "URL")
	Gui, 2:Add, Button, x+10 yp gGuiGetWebPageTitle, % o_L["DialogGetWebPageTitle"]

if !InStr("Special|QAP|WindowsApp", o_EditedFavorite.AA.strFavoriteType)
{
	if !InStr("|Menu|Group|External|Text", "|" . o_EditedFavorite.AA.strFavoriteType, true)
	{
		if (o_EditedFavorite.AA.strFavoriteType = "Snippet")
			Gui, Font, w700
			
		Gui, 2:Add, Text, x20 y+10 vf_lblLocation, % o_Favorites.GetFavoriteTypeObject(o_EditedFavorite.AA.strFavoriteType).strFavoriteTypeLocationLabel . " *"
		
		if (o_EditedFavorite.AA.strFavoriteType = "Snippet")
		{
			; 1 macro (boolean) true: send snippet to current application using macro mode / else paste as raw text
			; 2 prompt (text) pause prompt before pasting/launching the snippet
			; 3 encode (boolean) true: automatically encode / false: do not encode
			; 4 fixed width (boolean) true: fixed width / false: proportional width
			; 5 font size (integer)
			if !StrLen(o_EditedFavorite.AA.strFavoriteLaunchWith) ; default values
				o_EditedFavorite.AA.strFavoriteLaunchWith := o_Settings.Snippets.blnSnippetDefaultMacro.IniValue . ";;"
					. o_Settings.Snippets.blnSnippetDefaultProcessEOLTab.IniValue . ";" 
					. o_Settings.Snippets.blnSnippetDefaultFixedFont.IniValue . ";"
					. o_Settings.Snippets.intSnippetDefaultFontSize.IniValue
			saFavoriteSnippetOptions := StrSplit(strFavoriteSnippetOptions, ";")
			
			Gui, Font
			Gui, Font, w700
			Gui, 2:Add, Button, x500 yp h18 w20 vf_btnEnlarge gEnlargeSnippetContent, +
			Gui, Font
			GuiControlGet, arrPosEnlarge, Pos, f_btnEnlarge
			g_intContentLabelY := arrPosEnlargeY
			
			; intMoveRight := 500 - (arrPosFixedFontX + arrPosFixedFontW + arrPosFontSizeW + arrPosUpDownW + arrPosFontSizeLabelW + 10 + arrPosEnlargeW)
			; GuiControl, Move, f_btnEnlarge, % "x" . arrPosEnlargeX + intMoveRight
		}
		
		Gui, 2:Add, Edit, % "x20 y+10 vf_strFavoriteLocation "
			. (o_EditedFavorite.AA.strFavoriteType = "Snippet" ? "w500 r5 t8" : "gEditFavoriteLocationChanged w400 h20")
			, % o_EditedFavorite.AA.strFavoriteLocation ; do not process snippet according to f_blnProcessEOLTab here
		if (o_EditedFavorite.AA.strFavoriteType = "Snippet")
		{
			GuiControlGet, arrPosSnippetContent, Pos, f_strFavoriteLocation
			g_intSnippetContentH := arrPosSnippetContentH
		}
			
		if (o_EditedFavorite.AA.strFavoriteType = "Snippet")
			gosub, ContentEditFontChanged
			
		if InStr("Folder|Document|Application", o_EditedFavorite.AA.strFavoriteType)
			Gui, 2:Add, Button, x+10 yp gButtonSelectFavoriteLocation vf_btnSelectFolderLocation, % o_L["DialogBrowseButton"]

		if !InStr("Snippet|WindowsApp|", o_EditedFavorite.AA.strFavoriteType . "|")
			Gui, 2:Add, Link, x20 y+5 w500, % L(o_L["DialogPlaceholders"], "https://www.quickaccesspopup.com/can-i-insert-values-in-favorites-location-or-parameters-using-placeholders")
		
        if (o_EditedFavorite.AA.strFavoriteType = "Application")
		{
			Gui, 2:Add, Text, x20 y+20 vf_lblSelectRunningApplication, % o_L["DialogBrowseOrSelectApplication"]
			Gui, 2:Add, DropDownList, x20 y+5 w500 vf_drpRunningApplication gDropdownRunningApplicationChanged
				, % CollectRunningApplications(o_EditedFavorite.AA.strFavoriteLocation)
			Gui, 2:Add, Checkbox, x20 y+20 w400 vf_strFavoriteLaunchWith, % o_L["DialogActivateAlreadyRunning"]
			GuiControl, , f_strFavoriteLaunchWith, % (o_EditedFavorite.AA.strFavoriteLaunchWith = 1)
		}

		if (strGuiFavoriteLabel = "GuiCopyFavorite")
			o_EditedFavorite.AA.strFavoriteLocation := "" ; to avoid side effect on original favorite hotkey
	}
	
	if (o_EditedFavorite.AA.strFavoriteType = "Snippet")
	{
		g_strSnippetFormat := "raw" ; control initialy loaded with unprocessed content as in ini file
		Gui, 2:Add, Checkbox, % "x20 y+10 w320 vf_blnProcessEOLTab gProcessEOLTabChanged " . (saFavoriteSnippetOptions[3] <> 0 ? "checked" : ""), % o_L["DialogFavoriteSnippetProcessEOLTab"]
		Gui, 2:Add, Checkbox, % "x360 yp w160 vf_blnFixedFont gContentEditFontChanged " . (saFavoriteSnippetOptions[4] = 1 ? "checked" : ""), % o_L["DialogFavoriteSnippetFixedFont"]
		
		Gui, 2:Add, Link, x20 y+5 vf_lblSnippetHelp w320, `n`n ; keep `n to make sure a second line is available for the control
		Gui, 2:Add, Text, x360 yp vf_lblFontSize, % o_L["DialogFavoriteSnippetFontSize"]
		GuiControlGet, arrPosFontSizeLabel, Pos, f_lblFontSize
		Gui, 2:Add, Edit, x+5 yp w40 vf_intFontSize gContentEditFontChanged
		GuiControlGet, arrPosFontSize, Pos, f_intFontSize
		Gui, 2:Add, UpDown, Range6-18 vf_intFontUpDown, % (StrLen(saFavoriteSnippetOptions[5]) ? saFavoriteSnippetOptions[5] : o_Settings.Snippets.intSnippetDefaultFontSize.IniValue)
		GuiControlGet, arrPosUpDown, Pos, f_intFontUpDown
		
		Gosub, ProcessEOLTabChanged ; encode/decode snippet and update f_lblSnippetHelp text
	}
}
else ; "Special", "QAP" or "WindowsApp"
{
	if (o_EditedFavorite.AA.strFavoriteType <> "WindowsApp")
		Gui, 2:Add, Edit, x20 yp hidden section vf_strFavoriteLocation, % o_EditedFavorite.AA.strFavoriteLocation ; hidden because set by TreeViewSpecialChanged or TreeviewQAPChanged
	Gui, 2:Add, Text, % (o_EditedFavorite.AA.strFavoriteType = "QAP" ? "yp" : "y+10") . " xs w300 vf_lblLocation", % o_Favorites.GetFavoriteTypeObject(o_EditedFavorite.AA.strFavoriteType).strFavoriteTypeLabel . " *"

	if (o_EditedFavorite.AA.strFavoriteType = "WindowsApp")
	{
		blnIsCustomWindowsApp := (SubStr(o_EditedFavorite.AA.strFavoriteLocation, 1, 7) = "Custom:")
		Gui, 2:Add, Text, x20 y+5 vf_lblWindowsAppsList, % o_L["DialogWindowsAppsList"]
		strWindowsAppsDropdownList := LoadWindowsAppsList(o_EditedFavorite.AA.strFavoriteLocation)
		Gui, 2:Add, DropDownList, x20 y+5 w400 vf_drpWindowsAppsList gDropdownWindowsAppsListChanged
			, % strWindowsAppsDropdownList . "|* " . o_L["DialogWindowsAppsListCustom"] . (blnIsCustomWindowsApp ? "||" : "")
		Gui, 2:Add, Button, x+10 yp gButtonRefreshWindowsAppsList vf_btnRefreshWindowsAppsList, % o_L["DialogRefresh"]
		Gui, 2:Add, Edit, % "x20 y+5 section vf_strFavoriteLocation w400 h20"
			. (blnIsCustomWindowsApp ? "" : " hidden") ; hidden because Windows Apps dropdown list except if starts with "Custom:"
			, % (blnIsCustomWindowsApp ? SubStr(o_EditedFavorite.AA.strFavoriteLocation, 8) : o_EditedFavorite.AA.strFavoriteLocation)
	}
	else
	{
		GuiControlGet, arrPosLocationLabel, Pos, f_lblLocation
		intTreeViewHeight := intTabHeight - arrPosLocationLabelY - 43 ; 43 = space required below)
			
		if (o_EditedFavorite.AA.strFavoriteType = "QAP")
			Gui, 2:Add, Link, x+5 yp w200 vf_tvQAPFeatureURL
		
		intTreeViewWidth := (o_EditedFavorite.AA.strFavoriteType = "QAP" ? "300" : "400")
		Gui, 2:Add, TreeView, % "x20 y+5 w" . intTreeViewWidth . " h" . intTreeViewHeight . " " . (o_EditedFavorite.AA.strFavoriteType = "QAP" ? "vf_tvQAP gTreeViewQAPChanged" : "vf_tvSpecial gTreeViewSpecialChanged")
		
		if (o_EditedFavorite.AA.strFavoriteType = "QAP")
		{
			Gui, 2:Add, Edit, % "x+5 yp w200 h" . intTreeViewHeight . " ReadOnly vf_tvQAPDescription"
			gosub, LoadTreeviewQAP
		}
		else
			gosub, LoadTreeviewSpecial
	}
}

if (o_EditedFavorite.AA.strFavoriteType = "FTP")
{
	Gui, 2:Add, Text, x20 y+5, % o_L["GuiLoginName"]
	Gui, 2:Add, Text, x230 yp, % o_L["GuiPassword"]
	
	Gui, 2:Add, Edit, x20 y+5 w190 h20 vf_strFavoriteLoginName, % o_EditedFavorite.AA.strFavoriteLoginName
	Gui, 2:Add, Edit, x230 yp w190 h20 Password vf_strFavoritePassword, % o_EditedFavorite.AA.strFavoritePassword
	Gui, 2:Add, Text, x20 y+5, % o_L["GuiPasswordNotEncripted"]
}

if (o_EditedFavorite.AA.strFavoriteType = "Group")
{
	Gui, 2:Add, Text, x20 y+20, % o_L["GuiGroupSaveRestoreOption"]
	Gui, 2:Add, Radio, % "x20 y+10 vf_blnRadioGroupAdd " . (g_saGroupInGuiSettings[1] ? "" : "checked"), % o_L["GuiGroupSaveAddWindowsLabel"]
	Gui, 2:Add, Radio, % "x20 y+5 vf_blnRadioGroupReplace " . (g_saGroupInGuiSettings[1] ? "checked" : ""), % o_L["GuiGroupSaveReplaceWindowsLabel"]

	if (o_FileManagers.P_intActiveFileManager = 2 or o_FileManagers.P_intActiveFileManager = 3) ; DirectoryOpus or TotalCommander
	{
		Gui, 2:Add, Text, x20 y+20, % o_L["GuiGroupSaveRestoreWith"]
		Gui, 2:Add, Radio, % "x20 y+10 vf_blnRadioGroupRestoreWithExplorer " . (g_saGroupInGuiSettings[2] = "Windows Explorer" ? "checked" : ""), Windows Explorer
		Gui, 2:Add, Radio, % "x20 y+5 vf_blnRadioGroupRestoreWithOther " . (g_saGroupInGuiSettings[2] <> "Windows Explorer" ? "checked" : "")
			, % o_FileManagers.SA[o_FileManagers.P_intActiveFileManager].AA.strDisplayName ; will be selected by default if empty (when Add)
	}
}

if InStr("Folder|Special|FTP", o_EditedFavorite.AA.strFavoriteType) ; when adding folders or FTP sites
	and (o_FileManagers.P_intActiveFileManager = 2 or o_FileManagers.P_intActiveFileManager = 3) ; in Directory Opus or TotalCommander
	and (blnIsGroupMember) ; in a group
{
	; 0 for use default / 1 for remember, -1 Minimized / 0 Normal / 1 Maximized, Left (X), Top (Y), Width, Height, Delay, RestoreSide/Monitor; for example: "0,,,,,,,L"
	saNewFavoriteWindowPosition := StrSplit(g_strNewFavoriteWindowPosition, ",")
	
	Gui, 2:Add, Text, x20 y+20, % L(o_L["GuiGroupRestoreSide"], (o_FileManagers.P_intActiveFileManager = 2 ? "Directory Opus" : "Total Commander"))
	Gui, 2:Add, Radio, % "x+10 yp vf_intRadioGroupRestoreSide " . (saNewFavoriteWindowPosition[8] <> "R" ? "checked" : ""), % o_L["DialogWindowPositionLeft"] ; if "L" or ""
	Gui, 2:Add, Radio, % "x+10 yp " . (saNewFavoriteWindowPosition[8] = "R" ? "checked" : ""), % o_L["DialogWindowPositionRight"]
}

if (o_EditedFavorite.AA.strFavoriteType = "External")
{
	Gui, 2:Add, Text, x20 y+10, % o_L["DialogExternalLocation"] . "*"
	Gui, 2:Add, Edit, % (StrLen(o_EditedFavorite.AA.strFavoriteAppWorkingDir) ? "Disabled " : "") .  "x20 y+5 w400 Limit250 gEditFavoriteExternalLocationChanged vf_strFavoriteAppWorkingDir", % o_EditedFavorite.AA.strFavoriteAppWorkingDir
	if StrLen(o_EditedFavorite.AA.strFavoriteAppWorkingDir)
		Gui, 2:Add, Text, x20 y+5 w500, % o_L["DialogExternalLocationReadOnly"]
	else
		Gui, 2:Add, Button, x+10 yp gButtonSelectExternalSettingsFile, % o_L["DialogBrowseButton"]
	Gui, 2:Add, Link, x20 y+15 w500, % L(o_L["DialogFavoriteExternalHelpWeb"], "https://www.quickaccesspopup.com/can-a-submenu-be-shared-on-different-pcs-or-by-different-users/")
}

Gui, 2:Add, Checkbox, % "x20 y+" (InStr("Special|QAP", o_EditedFavorite.AA.strFavoriteType) ? "10" : (o_EditedFavorite.AA.strFavoriteType = "Snippet" ? "30" : "20"))
	. " vf_blnFavoriteDisabled " . (o_EditedFavorite.AA.blnFavoriteDisabled ? "checked" : "")
	, % (blnIsGroupMember ? o_L["DialogFavoriteDisabledGroupMember"] : o_L["DialogFavoriteDisabled"])

saNewFavoriteWindowPosition := ""
intTreeViewHeight := ""
intTreeViewWidth := ""
strWindowsAppsDropdownList := ""
blnIsCustomWindowsApp := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
LoadTreeviewQAP:
LoadTreeviewSpecial:
;------------------------------------------------------------

blnSelectDone := false
aaCategoriesID := Object()
global g_aaTreeViewItemsByIDs := Object()

aaCategories := (A_ThisLabel = "LoadTreeviewQAP" ? o_QAPfeatures.aaQAPFeaturesCategories : o_SpecialFolders.aaSpecialFoldersCategories)

; build name|code|categories (sorted by name)
strItemsNameCodeCategories := ""
for strItemCode, oItem in % (A_ThisLabel = "LoadTreeviewQAP" ? o_QAPfeatures.AA : o_SpecialFolders.AA)
	if (A_ThisLabel = "LoadTreeviewQAP")
		strItemsNameCodeCategories .= oItem.strLocalizedName . "|" . strItemCode . "|" . oItem.strQAPFeatureCategories . "`n"
	else ; LoadTreeviewSpecial
		if StrLen(oItem.strDefaultName) ; to skip class object non-special folders items
			strItemsNameCodeCategories .= oItem.strDefaultName . "|" . strItemCode . "|" . StrReplace(oItem.strCategories, "|", "~") . "`n"
Sort, strItemsNameCodeCategories

for strCategory, strCategoryLabel in aaCategories
{
	if (strCategory = "3.1-AddFavoriteOfType")
		aaCategoriesID[strCategory] := TV_Add(strCategoryLabel, aaCategoriesID["3-QAPMenuEditing"], "First Bold")
	else if (strCategory = "5.1-CloseComputer")
		aaCategoriesID[strCategory] := TV_Add(strCategoryLabel, aaCategoriesID["5-WindowsFeature"], "First Bold")
	else
		aaCategoriesID[strCategory] := TV_Add(strCategoryLabel, , (A_Index = 1 and InStr(strGuiFavoriteLabel, "GuiAdd") ? "Expand" : "") " Bold")
	
	loop, Parse, strItemsNameCodeCategories, `n
	{
		if !StrLen(A_LoopField)
			continue
		
		; name|code|categories
		saItem := StrSplit(A_LoopField, "|")
		
		if InStr(saItem[3], strCategory)
		{
			if (A_ThisLabel = "LoadTreeviewQAP")
			{
				if (!blnSelectDone and o_QAPfeatures.AA[o_EditedFavorite.AA.strFavoriteLocation].strLocalizedName = saItem[1])
				{
					strSelect := "Select"
					blnSelectDone := true
				}
				else
					strSelect := ""
				
				intItemID := TV_Add(saItem[1], aaCategoriesID[strCategory], strSelect)
				g_aaTreeViewItemsByIDs[intItemID] := o_QAPfeatures.AA[saItem[2]]
			}
			else
			{
				if (!blnSelectDone and o_SpecialFolders.AA[o_EditedFavorite.AA.strFavoriteLocation].strDefaultName = saItem[1])
				{
					strSelect := "Select"
					blnSelectDone := true
				}
				else
					strSelect := ""
				
				intItemID := TV_Add(saItem[1], aaCategoriesID[strCategory], strSelect)
				g_aaTreeViewItemsByIDs[intItemID] := o_SpecialFolders.AA[saItem[2]]
			}
		}
	}
}

aaCategoriesID := ""
aaCategories := ""
strCategory := ""
strCategoryLabel := ""
strItemCode := ""
oItem := ""
intItemID := ""
strSelect := ""
blnSelectDone := ""
strItemsNameCodeCategories := ""
ResetArray("arrItem")

return
;------------------------------------------------------------


;------------------------------------------------------------
EnlargeSnippetContent:
;------------------------------------------------------------
GuiControlGet, strEnlargeLabel, , f_btnEnlarge

GuiControl, % (strEnlargeLabel = "+" ? "Hide" : "Show"), f_ShortNameLabel
GuiControl, % (strEnlargeLabel = "+" ? "Hide" : "Show"), f_strFavoriteShortName
GuiControl, % (strEnlargeLabel = "+" ? "Hide" : "Show"), f_TypeHelp

GuiControl, Move, f_strFavoriteLocation, % "y" . (strEnlargeLabel = "+" ? g_intTypeHelpY : g_intContentLabelY) + 30
	. " h" . (strEnlargeLabel = "+" ? g_intSnippetContentH + (g_intContentLabelY - g_intTypeHelpY) : g_intSnippetContentH)

GuiControl, Move, f_lblLocation, % "y" . (strEnlargeLabel = "+" ? g_intTypeHelpY : g_intContentLabelY)
GuiControl, Move, f_btnEnlarge, % "y" . (strEnlargeLabel = "+" ? g_intTypeHelpY : g_intContentLabelY)

GuiControl, , f_btnEnlarge, % (strEnlargeLabel = "+" ? "-" : "+")

strEnlargeLabel := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiFavoriteTabMenuOptions:
;------------------------------------------------------------

Gui, 2:Tab, % ++intTabNumber

Gui, 2:Add, Text, x20 y50 vf_lblFavoriteParentMenu
	, % (InStr("Menu|External", o_EditedFavorite.AA.strFavoriteType, true) ? o_L["DialogSubmenuParentMenu"] : o_L["DialogFavoriteParentMenu"])
Gui, 2:Add, DropDownList, x20 y+5 w500 vf_drpParentMenu gDropdownParentMenuChanged
	, % o_MainMenu.BuildMenuListDropDown(o_MenuInGui.AA.strMenuPath
		, (InStr("Menu|External", o_EditedFavorite.AA.strFavoriteType, true) ? o_L["MainMenuName"] . " " . o_EditedFavorite.AA.strFavoriteLocation : "") ; exclude self
		, true) . "|" ; exclude read-only external menus

Gui, 2:Add, Text, x20 y+10 vf_lblFavoriteParentMenuPosition, % o_L["DialogFavoriteMenuPosition"]
Gui, 2:Add, DropDownList, x20 y+5 w500 vf_drpParentMenuItems AltSubmit

if !(blnIsGroupMember)
{
	Gui, 2:Add, Text, x20 y+20 gGuiPickIconDialog section, % o_L["DialogIcon"]
	Gui, 2:Add, Picture, x20 y+5 w32 h32 vf_picIcon gGuiPickIconDialog
	Gui, 2:Add, Text, x+5 yp vf_lblRemoveIcon gGuiRemoveIcon, X
	Gui, 2:Add, Link, x20 ys+57 gGuiPickIconDialog, % "<a>" . o_L["DialogSelectIcon"] . "</a>"
	Gui, 2:Add, Link, x+20 yp gGuiPickIconDialogNo, % "<a>" . o_L["DialogSelectIconNo"] . "</a>"
	if (o_EditedFavorite.AA.strFavoriteType = "Folder")
		Gui, 2:Add, Link, x270 yp w240 vf_lblSetWindowsFolderIcon gSetWindowsFolderIcon, % "<a>" . o_L["DialogWindowsFolderIconSet"] . "</a>"
	Gui, 2:Add, Link, x20 ys+74 w240 gGuiEditIconDialog, % "<a>" . o_L["DialogEditIcon"] . "</a>"
	Gui, 2:Add, Link, x20 ys+91 w240 gGuiPickIconDialogJL vf_lblSelectIconJL, % "<a>" . o_L["DialogSelectIconJL"] . "</a>"

	if (o_EditedFavorite.AA.strFavoriteType <> "Text")
	{
		Gui, 2:Add, Text, x20 y+20, % o_L["DialogShortcut"]
		Gui, 2:Add, Link, x+5 yp, % "(<a href=""https://www.quickaccesspopup.com/can-i-launch-my-favorites-with-keyboard-or-mouse-shortcuts/"">" . o_L["GuiHelp"] . "</a>)"
		Gui, 2:Add, Text, x20 y+5 w300 h23 0x1000 vf_strHotkeyText gButtonChangeFavoriteHotkey, % new Triggers.HotkeyParts(g_strNewFavoriteShortcut).Hotkey2Text()
		Gui, 2:Add, Button, yp x+10 gButtonChangeFavoriteHotkey, % o_L["OptionsChangeHotkey"]
		
		g_strNewFavoriteHotstring := o_EditedFavorite.AA.strFavoriteHotstring
		SplitHotstring(g_strNewFavoriteHotstring, g_strNewFavoriteHotstringTrigger, g_strNewFavoriteHotstringOptionsShort)
		Gui, 2:Add, Text, x20 y+20, % o_L["DialogHotstringTriggerOptions"]
		Gui, 2:Add, Link, x+5 yp, % "(<a href=""https://www.quickaccesspopup.com/what-are-hotstrings/"">" . o_L["GuiHelp"] . "</a>)"
		Gui, 2:Add, Text, x20 y+5 w300 h23 0x1000 vf_strHotstringTrigger gButtonChangeFavoriteHotstring, %g_strNewFavoriteHotstringTrigger%
		Gui, 2:Add, Button, yp x+10 gButtonChangeFavoriteHotstring, % o_L["OptionsChangeHotkey"]
		Gui, 2:Add, Text, x20 y+5 w300 h46 0x1000 vf_strHotstringOptions gButtonChangeFavoriteHotstring, % GetHotstringOptionsLong(g_strNewFavoriteHotstringOptionsShort)
	}
}

ResetArray("arrFavoriteHotstring")

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiFavoriteTabLiveFolderOptions:
;------------------------------------------------------------

Gui, 2:Tab, % ++intTabNumber

Gui, 2:Add, Checkbox, % "x20 y50 w500 vf_blnFavoriteFolderLive gCheckboxFolderLiveClicked " . (o_EditedFavorite.AA.intFavoriteFolderLiveLevels ? "checked" : ""), % o_L["DialogFavoriteFolderLive"]

Gui, 2:Add, Edit, x20 y+15 w51 h22 vf_intFavoriteFolderLiveLevelsEdit number limit1 center hidden
Gui, 2:Add, UpDown, vf_intFavoriteFolderLiveLevels Range1-9, % o_EditedFavorite.AA.intFavoriteFolderLiveLevels
Gui, 2:Add, Text, x+5 yp w385 vf_lblFavoriteFolderLiveLevels hidden, % o_L["DialogFavoriteFolderLiveLevels"]

if !StrLen(o_EditedFavorite.AA.strFavoriteFolderLiveSort)
	o_EditedFavorite.AA.strFavoriteFolderLiveSort := "A1"
strLiveFolderSortOrder := SubStr(o_EditedFavorite.AA.strFavoriteFolderLiveSort, 1, 1)
Gui, 2:Add, Text, y+20 x200 section vf_lblLiveFolderSortOrderLabel hidden, % o_L["DialogSortOrder"] . ":"
Gui, 2:Add, Radio, % "y+5 x200 vf_radLiveFolderSortA hidden group" . (strLiveFolderSortOrder = "A" ? " checked" : ""), % o_L["DialogAscending"]
Gui, 2:Add, Radio, % "y+5 x200 vf_radLiveFolderSortD hidden" . (strLiveFolderSortOrder = "D" ? " checked" : ""), % o_L["DialogDescending"]

strLiveFolderSortCriteria := SubStr(o_EditedFavorite.AA.strFavoriteFolderLiveSort, 2, 1)
Gui, 2:Add, Text, ys x20 vf_lblLiveFolderSortCriteriaLabel hidden, % o_L["DialogSortBy"] . ":"
Gui, 2:Add, Radio, % "y+5 x20 vf_radLiveFolderSort1 hidden section" . (strLiveFolderSortCriteria = "1" ? " checked" : ""), % o_L["DialogFileName"]
Gui, 2:Add, Radio, % "y+5 x20 vf_radLiveFolderSort2 hidden" . (strLiveFolderSortCriteria = "2" ? " checked" : ""), % o_L["DialogFileExtension"]
Gui, 2:Add, Radio, % "y+5 x20 vf_radLiveFolderSort3 hidden" . (strLiveFolderSortCriteria = "3" ? " checked" : ""), % o_L["DialogFileSize"]
Gui, 2:Add, Radio, % "y+5 x20 vf_radLiveFolderSort4 hidden" . (strLiveFolderSortCriteria = "4" ? " checked" : ""), % o_L["DialogModifiedDate"]

Gui, 2:Add, Edit, x20 y+15 w51 h22 vf_intFavoriteFolderLiveColumnsEdit number limit3 center hidden
Gui, 2:Add, UpDown, vf_intFavoriteFolderLiveColumns Range0-999, % o_EditedFavorite.AA.intFavoriteFolderLiveColumns
Gui, 2:Add, Text, x+5 yp w385 vf_lblFavoriteFolderLiveColumns hidden, % o_L["DialogFavoriteFolderLiveColumns"]

Gui, 2:Add, Checkbox, % "x20 y+20 w400 vf_blnFavoriteFolderLiveDocuments gCheckboxFolderLiveDocumentsClicked hidden " . (o_EditedFavorite.AA.blnFavoriteFolderLiveDocuments ? "checked" : "")
	, % o_L["DialogFavoriteFolderLiveDocuments"]

Gui, 2:Add, Radio, % "x20 y+10 vf_radFavoriteFolderLiveInclude hidden " . (o_EditedFavorite.AA.blnFavoriteFolderLiveIncludeExclude ? "checked" : ""), % o_L["DialogFavoriteFolderLiveInclude"]
Gui, 2:Add, Radio, % "x+5 yp vf_radFavoriteFolderLiveExclude hidden " . (o_EditedFavorite.AA.blnFavoriteFolderLiveIncludeExclude ? "" : "checked"), % o_L["DialogFavoriteFolderLiveExclude"]
Gui, 2:Add, Text, x20 y+10 w400 vf_lblFavoriteFolderLiveExtensions hidden, % "..." . o_L["DialogFavoriteFolderLiveExtensions"]
Gui, 2:Add, Edit, x20 y+10 w400 vf_strFavoriteFolderLiveExtensions hidden, % o_EditedFavorite.AA.strFavoriteFolderLiveExtensions

strLiveFolderSortOrder := ""
strLiveFolderSortCriteria := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiFavoriteTabWindowOptions:
;------------------------------------------------------------

Gui, 2:Tab, % ++intTabNumber

; 0 for use default / 1 for remember, -1 Minimized / 0 Normal / 1 Maximized, Left (X), Top (Y), Width, Height, Delay, RestoreSide/Monitor; for example: "1,0,100,50,640,480,200"
saNewFavoriteWindowPosition := StrSplit(g_strNewFavoriteWindowPosition, ",")

Gui, 2:Add, Checkbox, % "x20 y50 section vf_blnUseDefaultWindowPosition gCheckboxWindowPositionClicked " . (saNewFavoriteWindowPosition[1] ? "" : "checked")
	, % o_L["DialogUseDefaultWindowPosition"] . " " . o_L["DialogUnavailableWithLiveFolders"] ; last part generally hidden but make room for when visible

Gui, 2:Add, Text, % "y+20 x20 section vf_lblWindowPositionState " . (saNewFavoriteWindowPosition[1] ? "" : "hidden"), % o_L["DialogState"]

Gui, 2:Add, Radio, % "y+10 x20 vf_lblWindowPositionMinMax1 gRadioButtonWindowPositionMinMaxClicked" 
	. (saNewFavoriteWindowPosition[1] ? "" : " hidden") . (saNewFavoriteWindowPosition[2] ? " checked" : ""), % o_L["DialogNormal"]
Gui, 2:Add, Radio, % "y+10 x20 vf_lblWindowPositionMinMax2 gRadioButtonWindowPositionMinMaxClicked"
	. (saNewFavoriteWindowPosition[1] ? "" : " hidden") . (saNewFavoriteWindowPosition[2] = 1 ? " checked" : ""), % o_L["DialogMaximized"]
Gui, 2:Add, Radio, % "y+10 x20 vf_lblWindowPositionMinMax3 gRadioButtonWindowPositionMinMaxClicked"
	. (saNewFavoriteWindowPosition[1] ? "" : " hidden") . (saNewFavoriteWindowPosition[2] = -1 ? " checked" : ""), % o_L["DialogMinimized"]

Gui, 2:Add, Text, % "y+20 x20 vf_lblWindowPositionDelayLabel " . (saNewFavoriteWindowPosition[1] ? "" : "hidden"), % o_L["DialogWindowPositionDelay"]
Gui, 2:Add, Edit, % "yp x+20 w36 center number limit5 vf_lblWindowPositionDelay " . (saNewFavoriteWindowPosition[1] ? "" : "hidden"), % (saNewFavoriteWindowPosition[7] = "" ? 200 : saNewFavoriteWindowPosition[7])
Gui, 2:Add, Text, % "x+10 yp vf_lblWindowPositionMillisecondsLabel " . (saNewFavoriteWindowPosition[1] ? "" : "hidden"), % o_L["GuiGroupRestoreDelayMilliseconds"]
Gui, 2:Add, Text, % "y+20 x20 vf_lblWindowPositionMayFail " . (saNewFavoriteWindowPosition[1] ? "" : "hidden"), % o_L["DialogWindowPositionMayFail"]

Gui, 2:Add, Text, % "ys x200 section vf_lblWindowPosition " . (saNewFavoriteWindowPosition[1] ? "" : "hidden"), % o_L["DialogWindowPosition"]

Gui, 2:Add, Text, % "ys+20 xs vf_lblWindowPositionX " . (saNewFavoriteWindowPosition[1] and saNewFavoriteWindowPosition[2] = 0 ? "" : "hidden"), % o_L["DialogWindowPositionX"]
Gui, 2:Add, DropDownList, % "yp xs vf_drpWindowMonitor " . (saNewFavoriteWindowPosition[1] and saNewFavoriteWindowPosition[2] <> 0 ? "" : "hidden"), % BuildMonitorsList(saNewFavoriteWindowPosition[8])
Gui, 2:Add, Text, % "ys+40 xs vf_lblWindowPositionY " . (saNewFavoriteWindowPosition[1] and saNewFavoriteWindowPosition[2] = 0 ? "" : "hidden"), % o_L["DialogWindowPositionY"]
Gui, 2:Add, Text, % "ys+60 xs vf_lblWindowPositionW " . (saNewFavoriteWindowPosition[1] and saNewFavoriteWindowPosition[2] = 0 ? "" : "hidden"), % o_L["DialogWindowPositionW"]
Gui, 2:Add, Text, % "ys+80 xs vf_lblWindowPositionH " . (saNewFavoriteWindowPosition[1] and saNewFavoriteWindowPosition[2] = 0 ? "" : "hidden"), % o_L["DialogWindowPositionH"]

Gui, 2:Add, Edit, % "ys+20 xs+72 w36 h17 vf_intWindowPositionX center limit5 " . (saNewFavoriteWindowPosition[1] and saNewFavoriteWindowPosition[2] = 0 ? "" : "hidden"), % saNewFavoriteWindowPosition[3]
Gui, 2:Add, Edit, % "ys+40 xs+72 w36 h17 vf_intWindowPositionY center limit5 " . (saNewFavoriteWindowPosition[1] and saNewFavoriteWindowPosition[2] = 0 ? "" : "hidden"), % saNewFavoriteWindowPosition[4]
Gui, 2:Add, Edit, % "ys+60 xs+72 w36 h17 vf_intWindowPositionW center number limit5 " . (saNewFavoriteWindowPosition[1] and saNewFavoriteWindowPosition[2] = 0 ? "" : "hidden"), % saNewFavoriteWindowPosition[5]
Gui, 2:Add, Edit, % "ys+80 xs+72 w36 h17 vf_intWindowPositionH center number limit5 " . (saNewFavoriteWindowPosition[1] and saNewFavoriteWindowPosition[2] = 0 ? "" : "hidden"), % saNewFavoriteWindowPosition[6]

saNewFavoriteWindowPosition := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiFavoriteTabAdvancedSettings:
;------------------------------------------------------------

Gui, 2:Tab, % ++intTabNumber

if (o_EditedFavorite.AA.strFavoriteType = "Application")
{
	Gui, 2:Add, Checkbox, x20 y50 w400 vf_blnFavoriteElevate, % o_L["DialogElevate"]
	GuiControl, , f_blnFavoriteElevate, % (o_EditedFavorite.AA.blnFavoriteElevate = 1)	
	Gui, 2:Add, Text, x20 y+20 w400, % o_L["DialogWorkingDirLabel"]
	Gui, 2:Add, Edit, x20 y+5 w400 Limit250 vf_strFavoriteAppWorkingDir, % o_EditedFavorite.AA.strFavoriteAppWorkingDir
	Gui, 2:Add, Button, x+10 yp vf_btnBrowseAppWorkingDir gButtonSelectWorkingDir, % o_L["DialogBrowseButton"]
	Gui, 2:Add, Checkbox, x20 y+5 w500 vf_blnAppWorkingDirCurrent gButtonAppWorkingDirCurrentChanged, % o_L["DialogAppWorkingDirCurrent"] . "."
	GuiControl, , f_blnAppWorkingDirCurrent, % (o_EditedFavorite.AA.strFavoriteAppWorkingDir = "{CUR_LOC}")
	Gosub, ButtonAppWorkingDirCurrentChanged
	Gui, 2:Add, Link, x20 y+5 w500, % L(o_L["DialogPlaceholders"], "https://www.quickaccesspopup.com/can-i-insert-values-in-favorites-location-or-parameters-using-placeholders")
}
else if (o_EditedFavorite.AA.strFavoriteType = "Group")
{
	Gui, 2:Add, Text, x20 y50, % o_L["GuiGroupRestoreDelay"]
	Gui, 2:Add, Edit, x20 y+5 w50 center number Limit4 vf_intGroupRestoreDelay, % g_saGroupInGuiSettings[3]
	Gui, 2:Add, Text, x+10 yp, % o_L["GuiGroupRestoreDelayMilliseconds"]
}
else if (o_EditedFavorite.AA.strFavoriteType = "Snippet")
{
	Gui, 2:Add, Text, x20 y50, % o_L["DialogFavoriteSnippetSendMode"]
	Gui, 2:Add, Radio, % "x20 y+10 vf_blnRadioSendModeText gSnippetModeChanged " . (saFavoriteSnippetOptions[1] <> 1 ? "checked" : ""), % o_L["DialogFavoriteSnippetSendModeText"]
	Gui, 2:Add, Radio, % "x20 y+5 vf_blnRadioSendModeMacro gSnippetModeChanged " . (saFavoriteSnippetOptions[1] = 1 ? "checked" : ""), % o_L["DialogFavoriteSnippetSendModeMacro"]
	
	Gui, 2:Add, Text, x20 y+15 vf_lblSnippetPrompt w400, % L(o_L["DialogFavoriteSnippetPromptLabel"], (saFavoriteSnippetOptions[1] = 1 ? o_L["DialogFavoriteSnippetPromptLabelLaunching"] : o_L["DialogFavoriteSnippetPromptLabelPasting"]))
	Gui, 2:Add, Edit, x20 y+5 w400 Limit250 vf_strFavoriteSnippetPrompt, % saFavoriteSnippetOptions[2]
}
else if !InStr("QAP|WindowsApp", o_EditedFavorite.AA.strFavoriteType, true) ; Folder, Document, Special, URL and FTP
{
	Gui, 2:Add, Text, x20 y50 w400 vf_lblFavoriteLaunchWith, % o_L["DialogLaunchWith"] . " " . o_L["DialogUnavailableWithLiveFolders"] ; last part generally hidden but make room for when visible
	Gui, 2:Add, Edit, x20 y+5 w400 Limit250 vf_strFavoriteLaunchWith, % o_EditedFavorite.AA.strFavoriteLaunchWith
	Gui, 2:Add, Button, x+10 yp vf_btnFavoriteLaunchWith gButtonSelectLaunchWith, % o_L["DialogBrowseButton"]
}

if !InStr("Group|Snippet|QAP", o_EditedFavorite.AA.strFavoriteType, true)
{
	Gui, 2:Add, Text, y+20 x20 w400  vf_lblFavoriteArguments, % o_L["DialogArgumentsLabel"] . " " . o_L["DialogUnavailableWithLiveFolders"] ; last part generally hidden but make room for when visible
	Gui, 2:Add, Edit, x20 y+5 w400 Limit250 vf_strFavoriteArguments gFavoriteArgumentChanged, % o_EditedFavorite.AA.strFavoriteArguments
	Gui, 2:Add, Text, x20 y+5 w500, % o_L["DialogArgumentsLabelHelp"]
	Gui, 2:Add, Link, x20 y+5 w500, % L(o_L["DialogPlaceholders"], "https://www.quickaccesspopup.com/can-i-insert-values-in-favorites-location-or-parameters-using-placeholders")
	
	Gui, 2:Add, Text, x20 y+10 w500 vf_PlaceholdersCheckLabel, % o_L["DialogArgumentsPlaceholdersCheckLabel"]
	Gui, 2:Add, Edit, x20 y+5 w500 vf_strPlaceholdersCheck ReadOnly
	
	gosub, FavoriteArgumentChanged
}

if (o_EditedFavorite.AA.strFavoriteType = "FTP")
{
	Gui, 2:Add, Checkbox, x20 y+5 vf_blnFavoriteFtpEncoding, % (o_FileManagers.P_intActiveFileManager = 3 ? o_L["OptionsFtpEncodingTC"] : o_L["OptionsFtpEncoding"])
	GuiControl, , f_blnFavoriteFtpEncoding, % (g_blnNewFavoriteFtpEncoding = true)
}

Gui, 2:Add, Link, x20 y+10, % L(o_L["DialogSoundLabel"], "https://www.quickaccesspopup.com/can-i-play-a-sound-when-i-launch-a-favorite/", o_L["GuiHelp"])
Gui, 2:Add, Edit, x20 y+10 vf_strFavoriteSoundLocation w300 h20, % o_EditedFavorite.AA.strFavoriteSoundLocation
Gui, 2:Add, Button, x+10 yp gButtonSelectFavoriteSoundLocation, % o_L["DialogBrowseButton"]
Gui, 2:Add, Button, x+10 yp gButtonPlayFavoriteSoundLocation, % o_L["DialogPlay"]

strFavoriteSnippetOptions := ""
saFavoriteSnippetOptions := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiFavoriteTabExternal:
;------------------------------------------------------------

objExternalTypes := StrSplit(o_L["DialogExternalTypes"], "|")

Gui, 2:Tab, % ++intTabNumber

if !ExternalMenuIsReadOnly(f_strFavoriteAppWorkingDir)
	Gui, 2:Add, Text, x20 y50 w500, % L(o_L["DialogFavoriteExternalSaveNote"], (InStr(strGuiFavoriteLabel, "Add") ? o_L["DialogAdd"] : o_L["DialogOK"]))
Gui, 2:Add, Link, x20 y+10 w500, % L(o_L["DialogFavoriteExternalHelpWeb"], "https://www.quickaccesspopup.com/can-a-submenu-be-shared-on-different-pcs-or-by-different-users/")

Gui, 2:Add, Text, x20 y+10 w500, % o_L["DialogExternalTypesTitle"]
Loop, 3 ; no default type
	Gui, 2:Add, Radio, % "x20 y+5 w480 gRadioButtonExternalMenuClicked vf_radExternalMenuType" . A_Index, % objExternalTypes[A_Index] ; current value set by LoadExternalFileGlobalValues

; Gui, 2:Add, Checkbox, x20 y50 vf_blnExternalMenuReadOnly gExternalMenuReadOnlyClicked, % o_L["DialogReadOnly"]
Gui, 2:Add, Text, x20 y+10 vf_lblExternalMenuName, % o_L["DialogExternalMenuName"]
Gui, 2:Add, Edit, x20 y+5 w400 vf_strExternalMenuName

Gui, 2:Add, Text, x20 y+10 w500 vf_lblExternalSource, % o_L["DialogExternalSource"]
Gui, 2:Add, Radio, x20 y+5 w480 vf_radExternalSourceNetwork, % o_L["DialogExternalSourceNetwork"] ; current value set by LoadExternalFileGlobalValues
GuiControl, , f_radExternalSourceNetwork, 1 ; default true (Network), backward compatible value for pre-v9.1
Gui, 2:Add, Radio, x20 y+5 w480 vf_radExternalSourceCloud, % o_L["DialogExternalSourceCloud"]

Gui, 2:Add, Text, x20 y+10 vf_lblExternalWriteAccessUsers, % o_L["DialogExternalWriteAccessUsers"]
Gui, 2:Add, Edit, x20 y+5 w400 vf_strExternalWriteAccessUsers

Gui, 2:Add, Text, x20 y+10 vf_lblExternalWriteAccessMessage, % o_L["DialogExternalWriteAccessMessage"]
Gui, 2:Add, Edit, x20 y+5 w400 r3 vf_strExternalWriteAccessMessage

; Gui, 2:Add, Text, x20 y+15, % o_L["DialogExternalStartingNumber"] ; DEPRECATED since v8.1.9.1
; Gui, 2:Add, Edit, % "x20 y+5 w50 center number Limit4 vf_intExternalStartingNumber " . (strGuiFavoriteLabel <> "GuiAddFavorite" ? "Disabled" : "")
; 	, % (o_EditedFavorite.AA.strFavoriteGroupSettings > 0 ? o_EditedFavorite.AA.strFavoriteGroupSettings : 1) ; DEPRECATED since v8.1.9.1
gosub, LoadExternalFileGlobalValues
gosub, LoadExternalFileGlobalReadOnly
gosub, RadioButtonExternalMenuInit

objExternalTypes := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
RadioButtonExternalMenuInit:
RadioButtonExternalMenuClicked:
;------------------------------------------------------------

blnType3Before := f_radExternalMenuType3
Gui, 2:Submit, NoHide

if (A_ThisLabel = "RadioButtonExternalMenuClicked" and !blnType3Before and f_radExternalMenuType3)
{
	Oops(o_L["OopsExternalReadOnlyAlert"] . "`n`n" . o_L["OopsExternalReadOnlyAlertUsernameAdded"], o_L["DialogExternalWriteAccessUsers"], A_UserName, A_ComputerName)
	if !InStr(f_strExternalWriteAccessUsers, A_UserName)
		GuiControl, , f_strExternalWriteAccessUsers, % f_strExternalWriteAccessUsers . (StrLen(f_strExternalWriteAccessUsers) ? ";" : "") . A_UserName
}

if (A_ThisLabel = "RadioButtonExternalMenuClicked" and ExternalMenuIsReadOnly(f_strFavoriteAppWorkingDir))
{
	GuiControl, , f_radExternalMenuType3, % 1
	Oops(o_L["OopsErrorIniFileReadOnly"] . (StrLen(f_strExternalMenuName) ? "`n`n" . f_strExternalMenuName : "") . (StrLen(f_strExternalWriteAccessMessage) ? "`n`n" . f_strExternalWriteAccessMessage : ""))
	return
}

GuiControl, % (f_radExternalMenuType2 or f_radExternalMenuType3 ? "Show" : "Hide"), f_lblExternalMenuName
GuiControl, % (f_radExternalMenuType2 or f_radExternalMenuType3 ? "Show" : "Hide"), f_strExternalMenuName

GuiControl, % (f_radExternalMenuType2 or f_radExternalMenuType3 ? "Show" : "Hide"), f_lblExternalSource
GuiControl, % (f_radExternalMenuType2 or f_radExternalMenuType3 ? "Show" : "Hide"), f_radExternalSourceNetwork
GuiControl, % (f_radExternalMenuType2 or f_radExternalMenuType3 ? "Show" : "Hide"), f_radExternalSourceCloud

GuiControl, % (f_radExternalMenuType3 ? "Show" : "Hide"), f_lblExternalWriteAccessUsers
GuiControl, % (f_radExternalMenuType3 ? "Show" : "Hide"), f_strExternalWriteAccessUsers

GuiControl, % (f_radExternalMenuType3 ? "Show" : "Hide"), f_lblExternalWriteAccessMessage
GuiControl, % (f_radExternalMenuType3 ? "Show" : "Hide"), f_strExternalWriteAccessMessage

blnType3Before := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
ButtonAppWorkingDirCurrentChanged:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

GuiControl, 2:, f_strFavoriteAppWorkingDir, % (f_blnAppWorkingDirCurrent ? "{CUR_LOC}" : f_strFavoriteAppWorkingDir)

strEnableDisableCommand := (f_blnAppWorkingDirCurrent ? "Disable" : "Enable")
GuiControl, 2:%strEnableDisableCommand%, f_strFavoriteAppWorkingDir
GuiControl, 2:%strEnableDisableCommand%, f_btnBrowseAppWorkingDir
strEnableDisableCommand := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
SnippetModeChanged:
;------------------------------------------------------------

; check if the icon was the default for the snippet type
blnChangeDefaultSnippetIcon := (f_blnRadioSendModeText = 1 and g_strNewFavoriteIconResource = "iconPaste")
	or (f_blnRadioSendModeMacro = 1 and g_strNewFavoriteIconResource = "iconPasteSpecial") ; text snippet with default macro icon, change to defaujlt text snippet icon

Gui, 2:Submit, NoHide

if (blnChangeDefaultSnippetIcon) ; change default snippet icon
{
	g_strNewFavoriteIconResource := (f_blnRadioSendModeText = 1 ? "iconPaste" : "iconPasteSpecial")
	Gosub, GuiFavoriteIconDisplay
}

; change snippet prompt label according to snippet type
GuiControl, 2:, f_lblSnippetPrompt, % L(o_L["DialogFavoriteSnippetPromptLabel"], (f_blnRadioSendModeMacro = 1 ? o_L["DialogFavoriteSnippetPromptLabelLaunching"] : o_L["DialogFavoriteSnippetPromptLabelPasting"]))

blnChangeDefaultSnippetIcon := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
ContentEditFontChanged:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

g_blnContentEditFixedFont := f_blnFixedFont
g_blnContentEditFontSize := f_intFontSize

if (g_blnContentEditFixedFont)
	Gui, 2:Font, % "s" . g_blnContentEditFontSize, Courier New
else
	Gui, 2:Font, % "s" . g_blnContentEditFontSize
GuiControl, Font, f_strFavoriteLocation
Gui, 2:Font

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiMoveFavoriteToMenu:
GuiMoveMultipleFavoritesToMenu:
GuiCopyMultipleFavoritesToMenu:
;------------------------------------------------------------
strGuiFavoriteLabel := A_ThisLabel
g_intGui1WinID := WinExist("A")

if (LV_GetNext() = 0)
{
	Oops(o_L["DialogSelectItemOneOrMore"])
	return
}

blnMove := InStr(A_ThisLabel, "GuiMove")

strGuiTitle := L((blnMove ? (A_ThisLabel = "GuiMoveFavoriteToMenu" ? o_L["DialogMoveFavoriteTitle"] : o_L["DialogMoveFavoritesTitle"])
	: o_L["DialogCopyFavoritesTitle"]), g_strAppNameText, g_strAppVersion)
Gui, 2:New, +Resize -MaximizeBox +MinSize320x160 +MaxSizex160 +Hwndg_strGui2Hwnd, %strGuiTitle%
Gui, 2:+Owner1
Gui, 2:+OwnDialogs
if (g_blnUseColors)
	Gui, 2:Color, %g_strGuiWindowColor%

Gui, 2:Add, Text, x10 y10 vf_lblFavoriteParentMenu
	, % L((blnMove ? (A_ThisLabel = "GuiMoveFavoriteToMenu" ? o_L["DialogFavoriteParentMenuMove"] : o_L["DialogFavoritesParentMenuMove"])
	: o_L["DialogFavoritesParentMenuCopy"]), g_intFavoriteSelected)
Gui, 2:Add, DropDownList, x10 w300 vf_drpParentMenu gDropdownParentMenuChanged
	, % o_MainMenu.BuildMenuListDropDown(o_MenuinGui.AA.strMenuPath, , true) ; include self but exclude read-only external

Gui, 2:Add, Text, x20 y+10 vf_lblFavoriteParentMenuPosition, % (A_ThisLabel = "GuiMoveFavoriteToMenu" ? o_L["DialogFavoriteMenuPosition"] : o_L["DialogFavoritesMenuPosition"])
Gui, 2:Add, DropDownList, x20 y+5 w290 vf_drpParentMenuItems AltSubmit
GuiControl, 2:, f_drpParentMenuItems, % "|" . strDropdownParentMenuItems . g_strGuiDoubleLine . " " . o_L["DialogEndOfMenu"] . " " . g_strGuiDoubleLine

aaL := o_L.InsertAmpersand(false, "GuiCancel", "GuiCopy", "GuiMove") 

Gui, 2:Add, Button, % "y+20 vf_btnMoveOrCopyFavoritesSave default g" . (blnMove ? "GuiMoveMultipleFavoritesSave" : "GuiCopyMultipleFavoritesSave"), % (blnMove ? aaL["GuiMove"] : aaL["GuiCopy"])
Gui, 2:Add, Button, yp vf_btnMoveOrCopyFavoritesCancel gGuiAddFavoriteCancel, % aaL["GuiCancel"]
GuiCenterButtons(strGuiTitle, 10, 5, 20, "f_btnMoveOrCopyFavoritesSave", "f_btnMoveOrCopyFavoritesCancel")

g_intOriginalMenuPosition := 0xFFFF ; to select end of menu by default
Gosub, DropdownParentMenuChanged ; to init the content of menu items

GuiControl, 2:Focus, f_drpParentMenu

GetGui2Size("CopyMoveDialogPosition", intGui2Width, intGui2Height)
WinMove, ahk_id %g_strGui2Hwnd%, , , , %intGui2Width% ; restore only width, always position relative to Settings window
Gosub, ShowGui2AndDisableGui1

blnMove := ""
ResetArray("arrDialogPosition")
strDialogPosition := ""
strGuiTitle := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
ButtonChangeFavoriteHotkey:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

if (o_EditedFavorite.AA.strFavoriteType = "QAP")
	strQAPDefaultShortcut := o_QAPfeatures.AA[o_QAPfeatures.aaQAPFeaturesCodeByDefaultName[strQAPFeatureSelectedLocalizedName]].strDefaultShortcut

strBackupFavoriteShortcut := g_strNewFavoriteShortcut
g_strNewFavoriteShortcut := SelectShortcut(g_strNewFavoriteShortcut, f_strFavoriteShortName, o_EditedFavorite.AA.strFavoriteType, f_strFavoriteLocation, 3, strQAPDefaultShortcut)
if StrLen(g_strNewFavoriteShortcut)
	GuiControl, 2:, f_strHotkeyText, % new Triggers.HotkeyParts(g_strNewFavoriteShortcut).Hotkey2Text()
else
	g_strNewFavoriteShortcut := strBackupFavoriteShortcut

strQAPDefaultShortcut := ""
strBackupFavoriteShortcut := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
ButtonChangeFavoriteHotstring:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

g_strNewFavoriteHotstring := SelectHotstring(g_strNewFavoriteHotstring, f_strFavoriteShortName, o_EditedFavorite.AA.strFavoriteType, f_strFavoriteLocation)

SplitHotstring(g_strNewFavoriteHotstring, g_strNewFavoriteHotstringTrigger, g_strNewFavoriteHotstringOptionsShort)

GuiControl, 2:, f_strHotstringTrigger, %g_strNewFavoriteHotstringTrigger%
GuiControl, 2:, f_strHotstringOptions, % GetHotstringOptionsLong(g_strNewFavoriteHotstringOptionsShort)

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiAddFavoriteTabChanged:
;------------------------------------------------------------

intFromTab := f_intAddFavoriteTab
Gui, 2:Submit, NoHide ; updates f_intAddFavoriteTab

if (intFromTab = 1) ; if last tab was 1 we need to update the icon and external menu values
{
	if !StrLen(g_strNewFavoriteIconResource) and (o_EditedFavorite.AA.strFavoriteType = "Folder") and StrLen(f_strFavoriteLocation)
		g_strNewFavoriteIconResource := GetFolderIcon(f_strFavoriteLocation)
	
	Gosub, GuiFavoriteIconDefault
	Gosub, GuiFavoriteIconDisplay

	if (g_blnExternalLocationChanged)
	{
		gosub, LoadExternalFileGlobalValues
		g_blnExternalLocationChanged := false
	}
	if !InStr("Group|Snippet", o_EditedFavorite.AA.strFavoriteType, true)
		gosub, FavoriteArgumentChanged
	
}
else if (intFromTab = 3 and o_EditedFavorite.AA.strFavoriteType = "Folder" and f_blnFavoriteFolderLive)
{
	; back from Live Folder tab, check if we replace default iconFolder with iconFolderLive
	if (g_strNewFavoriteIconResource = "iconFolder")
	{
		g_strNewFavoriteIconResource := "iconFolderLive"
		Gosub, GuiFavoriteIconDisplay
	}
}
else ; to tab 1
	if (o_EditedFavorite.AA.strFavoriteType = "Special")
		GuiControl, 2:Focus, f_tvSpecial
	else if (o_EditedFavorite.AA.strFavoriteType = "QAP")
		GuiControl, 2:Focus, f_tvQAP

; normally this should be called only if g_blnExternalLocationChanged but it need to run at each tab change to keep control's r-o option, do not know why
gosub, LoadExternalFileGlobalReadOnly

intFromTab := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
DropdownParentMenuChanged:
;------------------------------------------------------------
strPrevParentMenu := f_drpParentMenu ; backup previous menu in case we have to cancel
Gui, 2:Submit, NoHide

saThisMenu := o_Containers.AA[f_drpParentMenu].SA

for intIndex, o_Item in saThisMenu
	if (o_EditedFavorite.AA.strFavoriteName = o_Item.AA.strFavoriteName)
			and (o_MenuInGui.AA.strMenuPath = o_Containers.AA[f_drpParentMenu].AA.strMenuPath ; skip edited item itself
			and !InStr(strGuiFavoriteLabel, "Copy")) ; and that we are not copying a favorite
		Continue
	else if (o_Item.AA.strFavoriteType = "X")
		strDropdownParentMenuItems .= g_strGuiMenuSeparator . g_strGuiMenuSeparator . "|"
	else if (o_Item.AA.FavoriteType = "K")
		strDropdownParentMenuItems .= g_strGuiDoubleLine . " " . o_L["MenuColumnBreak"] . " " . g_strGuiDoubleLine . "|"
	else
		strDropdownParentMenuItems .= o_Item.AA.strFavoriteName . "|"

GuiControl, , f_drpParentMenuItems, % "|" . strDropdownParentMenuItems . g_strGuiDoubleLine . " " . o_L["DialogEndOfMenu"] . " " . g_strGuiDoubleLine
if (f_drpParentMenu = o_MenuInGui.AA.strMenuPath) and (g_intOriginalMenuPosition <> 0xFFFF)
	GuiControl, Choose, f_drpParentMenuItems, %g_intOriginalMenuPosition%
else
	GuiControl, ChooseString, f_drpParentMenuItems, % g_strGuiDoubleLine . " " . o_L["DialogEndOfMenu"] . " " . g_strGuiDoubleLine
g_intNewItemPos := "" ; if new item position g_intNewItemPos is set, reset it and let f_drpParentMenuItems set it later #### not sure if safe...

strDropdownParentMenuItems := ""
saThisMenu := ""
o_Item := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
DropdownRunningApplicationChanged:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

GuiControl, , f_strFavoriteLocation, %f_drpRunningApplication%

return
;------------------------------------------------------------


;------------------------------------------------------------
DropdownWindowsAppsListChanged:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

if (f_drpWindowsAppsList = "* " . o_L["DialogWindowsAppsListCustom"])
{
	GuiControl, , f_strFavoriteLocation
	GuiControl, Show, f_strFavoriteLocation
}
else
{
	GuiControl, Hide, f_strFavoriteLocation
	
	GuiControl, , f_strFavoriteShortName, %f_drpWindowsAppsList%
	GuiControl, , f_strFavoriteLocation, % g_aaWindowsAppsIDsByName[f_drpWindowsAppsList]
}

return
;------------------------------------------------------------


;------------------------------------------------------------
ButtonRefreshWindowsAppsList:
ButtonRefreshWindowsAppsListAtStartup:
;------------------------------------------------------------

Diag(A_ThisLabel, "", "START")

strPsScriptFile := ".\CollectWindowsAppsList.ps1" ; must start with ".\", start PowerShell in g_strTempDir
; changed in v9.0.9.11 strPsScriptPathFile := g_strTempDir . "\" . strPsScriptFile
strPsScriptPathFile := A_WorkingDir . "\" . strPsScriptFile
FileDelete, %strPsScriptPathFile%
strWindowsAppsListFile := g_strTempDir . "\CollectWindowsAppsList.tsv"
FileDelete, %strWindowsAppsListFile%
FileAppend,
	(LTrim Join`r`n
$installedapps = get-AppxPackage
$ids = $null
foreach ($app in $installedapps)
{
  try
  {
    $ids = (Get-AppxPackageManifest $app -erroraction Stop).package.applications.application.id
  }
  catch
  {
  	Write-Output "No Id's found for $($app.name)" 
  }
  foreach ($id in $ids)
  {
  	$line = $app.Name + "`t" + $app.packagefamilyname + "!" + $id
  	echo $line
  	$line >> '%strWindowsAppsListFile%'
  }
}
# write-host "Press any key to continue..."
# [void][System.Console]::ReadKey($true)

) ; leave the last extra line above
, %strPsScriptPathFile%, % (A_IsUnicode ? "UTF-16" : "")

sleep, 200

; when Run or RunWait a PowerShell script, the -Command parameter script's path cannot include space(s) (PoWerShell bug?)
; this is why the scipt path is set as current folder (".\") and the script path is passed as WorkingDir
; RunWait, PowerShell.exe -ExecutionPolicy Bypass -Command %strPsScriptFile%, %g_strTempDir%, Hide ; could be Min instead of Hide
RunWait, PowerShell.exe -ExecutionPolicy Bypass -Command %strPsScriptFile%, %A_WorkingDir%, Hide ; could be Min instead of Hide
Sleep, 200
; removed in v9.0.9.11 FileDelete, %strPsScriptPathFile%

if (A_ThisLabel <> "ButtonRefreshWindowsAppsListAtStartup")
{
	Gui, 2:+OwnDialogs
	if FileExist(strWindowsAppsListFile)
	{
		FileCopy, %strWindowsAppsListFile%, %g_strWindosListAppsCacheFile%, 1
		GuiControl, , f_drpWindowsAppsList, % "|" . LoadWindowsAppsList(o_EditedFavorite.AA.strFavoriteLocation)
		MsgBox, 0, %g_strAppNameText%, % o_L["DialogWindowsAppsListSuccess"]
	}
	else
		Oops(o_L["DialogWindowsAppsListError"])
}
else
	if FileExist(strWindowsAppsListFile)
		FileCopy, %strWindowsAppsListFile%, %g_strWindosListAppsCacheFile%, 1

strPsScriptFile := ""
strPsScriptPathFile := ""
strWindowsAppsListFile := ""

Diag(A_ThisLabel, "", "STOP")
return
;------------------------------------------------------------


;------------------------------------------------------------
GuiOpenThisMenu:
;------------------------------------------------------------
Gosub, 2GuiClose

Gui, 1:Default
GuiControl, 1:Focus, f_lvFavoritesList
Gui, 1:ListView, f_lvFavoritesList

Gosub, OpenMenuFromEditForm

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiGetWebPageTitle:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

if StrLen(f_strFavoriteLocation)
	GuiControl, , f_strFavoriteShortName, % GetWebPageTitle(f_strFavoriteLocation)
else
	Oops(o_L["OopsFirstEnterUrl"], o_Favorites.GetFavoriteTypeObject(o_EditedFavorite.AA.strFavoriteType).strFavoriteTypeLocationLabel)

return
;------------------------------------------------------------


;------------------------------------------------------------
TreeViewQAPChanged:
TreeViewSpecialChanged:
;------------------------------------------------------------

if (A_GuiEvent = "S")
{
	Gui, 2:Submit, NoHide
	
	strItemSelectedName := (A_ThisLabel = "TreeViewQAPChanged" ? g_aaTreeViewItemsByIDs[A_EventInfo].strLocalizedName : g_aaTreeViewItemsByIDs[A_EventInfo].strDefaultName)
	if StrLen(strItemSelectedName) ; a QAP feature or Windows Special folder is selected
	{
		strLocation := (A_ThisLabel = "TreeViewQAPChanged" ? o_QAPfeatures.aaQAPFeaturesCodeByDefaultName[strItemSelectedName] : o_SpecialFolders.aaClassIdOrPathByDefaultName[strItemSelectedName])
		GuiControl, , f_strFavoriteShortName, %strItemSelectedName%
		GuiControl, , f_strFavoriteLocation, %strLocation%
		
		if InStr(strGuiFavoriteLabel, "GuiAdd") ; set new and default icon only when adding a QAP feature favorite
		{
			g_strNewFavoriteIconResource := (A_ThisLabel = "TreeViewQAPChanged" ? o_QAPfeatures.AA[strLocation].strDefaultIcon : o_SpecialFolders.AA[strLocation].strDefaultIcon)
			g_strDefaultIconResource := g_strNewFavoriteIconResource
		}
		
		if (A_ThisLabel = "TreeViewQAPChanged")
		{
			; set default shortcut
			if InStr(strGuiFavoriteLabel, "GuiAdd") ; this is a new favorite
				and !HasShortcut(g_strNewFavoriteShortcut) ; edited favorite don't have shortcut
				and !g_aaItemsByShortcut.HasKey(o_QAPfeatures.AA[strLocation].strDefaultShortcut) ; and default shortcut is not already used
				g_strNewFavoriteShortcut := o_QAPfeatures.AA[strLocation].strDefaultShortcut ; assign default shortcut for QAP feature
				
			GuiControl, , f_strHotkeyText, % new Triggers.HotkeyParts(g_strNewFavoriteShortcut).Hotkey2Text()
			
			strQAPFeatureSelectedLocalizedName := strItemSelectedName ; used when calling SelectShortcut for default shortcut
		}
		strLocation := ""
	}

	if (A_ThisLabel = "TreeViewQAPChanged")
	{
		GuiControl, , f_tvQAPDescription, % g_aaTreeViewItemsByIDs[A_EventInfo].strQAPFeatureDescription
		GuiControl, % (StrLen(g_aaTreeViewItemsByIDs[A_EventInfo].strQAPFeatureURL) ? "Show" : "Hide"), f_tvQAPFeatureURL
		GuiControl, , f_tvQAPFeatureURL, % "<a href=""https://www.quickaccesspopup.com/" . g_aaTreeViewItemsByIDs[A_EventInfo].strQAPFeatureURL . "/"">" . o_L["DialogQAPFeaturesHelpLink"] . "</a>"
	}
}
else if (A_GuiEvent = "DoubleClick")
{
	strItemSelectedName := (A_ThisLabel = "TreeViewQAPChanged" ? g_aaTreeViewItemsByIDs[A_EventInfo].strLocalizedName : g_aaTreeViewItemsByIDs[A_EventInfo].strDefaultName)
	if StrLen(strItemSelectedName) ; a QAP feature or Windows Special folder is selected
		if InStr(strGuiFavoriteLabel, "GuiEditFavorite")
			gosub, GuiEditFavoriteSave
		else if InStr(strGuiFavoriteLabel, "GuiCopyFavorite")
			gosub, GuiCopyFavoriteSave
		else
			gosub, GuiAddFavoriteSave
}

return
;------------------------------------------------------------


;------------------------------------------------------------
EditFavoriteLocationChanged:
EditFavoriteExternalLocationChanged:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

if (o_EditedFavorite.AA.strFavoriteType = "URL")
	return

if !StrLen(f_strFavoriteShortName) or (o_EditedFavorite.AA.strFavoriteType = "Application") ; always update when browsing the running apps list
	GuiControl, 2:, f_strFavoriteShortName, % GetLocationPathName((A_ThisLabel = "EditFavoriteLocationChanged" ? f_strFavoriteLocation : f_strFavoriteAppWorkingDir))

if InStr("|Folder|Document|Application", "|" . o_EditedFavorite.AA.strFavoriteType)
{
	if RegExMatch(f_strFavoriteLocation, """.*""") ; trim unneeded double quotes if location is enclosed with double quotes
		GuiControl, 2:, f_strFavoriteLocation, % Trim(f_strFavoriteLocation, """")
	gosub, GuiFavoriteIconDefault
}

if (A_ThisLabel = "EditFavoriteExternalLocationChanged")
{
	g_blnExternalLocationChanged := true ; will update external menu values in advanced tab when GuiAddFavoriteTabChanged

	if !StrLen(f_strFavoriteShortName) and FileExist(f_strFavoriteAppWorkingDir)
	{
		strExternalMenuName := o_Settings.ReadIniValue("MenuName", " ", "Global", f_strFavoriteAppWorkingDir) ; empty if not found
		if StrLen(strExternalMenuName)
			GuiControl, 2:, f_strFavoriteShortName, %strExternalMenuName%
	}
}

return
;------------------------------------------------------------


;------------------------------------------------------------
ProcessEOLTabChanged:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

strSnippetFormatBefore := g_strSnippetFormat
if (strSnippetFormatBefore = "raw" and f_blnProcessEOLTab)
{
	; DecodeSnippet: convert from "raw" content (as from ini file) to "display" format (when f_blnProcessEOLTab is true)
	GuiControl, , f_strFavoriteLocation, % DecodeSnippet(f_strFavoriteLocation)
	g_strSnippetFormat := "display"
}
if (strSnippetFormatBefore = "display" and !f_blnProcessEOLTab)
{
	; EncodeSnippet: convert from "display" format (when in gui f_blnProcessEOLTab was true) to "raw" content (when f_blnProcessEOLTab is false), ready for saving to ini file
	GuiControl, , f_strFavoriteLocation, % EncodeSnippet(f_strFavoriteLocation)
	g_strSnippetFormat := "raw"
}

; change help text according to encoding state
GuiControl, 2:, f_lblSnippetHelp, % (f_blnProcessEOLTab ? o_L["DialogFavoriteSnippetHelpProcess"] : o_L["DialogFavoriteSnippetHelpNoProcess"]) . " " 
	. L(o_L["DialogFavoriteSnippetHelpWeb"], "https://www.quickaccesspopup.com/what-are-snippets/"
		, "https://www.quickaccesspopup.com/can-i-insert-values-in-favorites-location-or-parameters-using-placeholders")

strSnippetFormatBefore := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
FavoriteArgumentChanged:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

strCommand := (RegExMatch(f_strFavoriteArguments, "i){[a-z_]*}") ? "Show" : "Hide") ; "i){[a-z]*}" case insensitive, between {}, zero, one or more a-z

GuiControl, %strCommand%, f_PlaceholdersCheckLabel
GuiControl, %strCommand%, f_strPlaceholdersCheck 
GuiControl, 2:, f_strPlaceholdersCheck, % ExpandPlaceholders(f_strFavoriteArguments, f_strFavoriteLocation, o_L["DialogArgumentsPlaceholdersCurrentExample"], o_L["DialogArgumentsPlaceholdersSelectedExample"])

strCommand := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
ButtonSelectFavoriteLocation:
ButtonSelectWorkingDir:
ButtonSelectLaunchWith:
ButtonSelectExternalSettingsFile:
ButtonSelectFavoriteSoundLocation:
;------------------------------------------------------------
Gui, 2:Submit, NoHide
Gui, 2:+OwnDialogs

if (A_ThisLabel = "ButtonSelectFavoriteLocation")
{
	strDefault := f_strFavoriteLocation
	strType := (o_EditedFavorite.AA.strFavoriteType = "Folder" ? "Folder" : "File")
}
else if InStr("ButtonSelectWorkingDir|ButtonSelectExternalSettingsFile", A_ThisLabel)
{
	strDefault := f_strFavoriteAppWorkingDir ; working directory or external menu settings file
	strType := (A_ThisLabel = "ButtonSelectWorkingDir" ? "Folder" : "IniFile") ; file if External settings file
}
else ; ButtonSelectLaunchWith or ButtonSelectFavoriteSoundLocation 
{
	if (A_ThisLabel = "ButtonSelectLaunchWith")
		strDefault := f_strFavoriteLaunchWith
	else ; ButtonSelectFavoriteSoundLocation
	{
		if (StrLen(f_strFavoriteSoundLocation) and SubStr(f_strFavoriteSoundLocation, 1, 1) <> "*")
			strDefault := f_strFavoriteSoundLocation
		else
			strDefault := A_WinDir . "\media\tada.wav"
	}
	strType := "File"
}

if (strType = "Folder")
	FileSelectFolder, strNewLocation, *%strDefault%, 3, % o_L["DialogAddFolderSelect"]
else if (strType = "File")
	; do not use option "S" because it gives an error message on read-only supports
	FileSelectFile, strNewLocation, 3, %strDefault%, % o_L["DialogAddFileSelect"]
else ; IniFile
{
	; do not use option "S" because it gives an error message on read-only supports
	FileSelectFile, strNewLocation, , %strDefault%, % o_L["DialogAddFileSelect"], *.ini ; removed option 8 to prompt to create a new file because not user friendly
	if StrLen(strNewLocation) and !StrLen(GetFileExtension(strNewLocation))
		strNewLocation .= ".ini"
}

if (!StrLen(strNewLocation) or strNewLocation = ".ini")
{
	gosub, ButtonSelectFavoriteLocationCleanup
	return
}

if InStr("ButtonSelectWorkingDir|ButtonSelectExternalSettingsFile", A_ThisLabel)
	GuiControl, 2:, f_strFavoriteAppWorkingDir, %strNewLocation%
else if (A_ThisLabel = "ButtonSelectLaunchWith")
	GuiControl, 2:, f_strFavoriteLaunchWith, %strNewLocation%
else if (A_ThisLabel = "ButtonSelectFavoriteSoundLocation")
	GuiControl, 2:, f_strFavoriteSoundLocation, %strNewLocation%
else ; ButtonSelectFavoriteLocation
{
	GuiControl, 2:, f_strFavoriteLocation, %strNewLocation%
	if !StrLen(f_strFavoriteShortName)
		GuiControl, 2:, f_strFavoriteShortName, % GetLocationPathName(strNewLocation)
}

ButtonSelectFavoriteLocationCleanup:
strNewLocation := ""
strDefault := ""
strType := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
ButtonPlayFavoriteSoundLocation:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

; OpenFavoritePlaySound(f_strFavoriteSoundLocation)

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiPickIconDialog:
GuiPickIconDialogJL:
GuiPickIconDialogNo:
GuiEditIconDialog:
;------------------------------------------------------------
Gui, 2:Submit, NoHide
Gui, 2:+OwnDialogs

if InStr("|Document|Application", "|" . o_EditedFavorite.AA.strFavoriteType) and !StrLen(f_strFavoriteLocation)
{
	OopsGui2(o_L["PickIconNoLocation"])
	return
}

if (A_ThisLabel = "GuiEditIconDialog")
	; InputBox, outVar, title, prompt, hide, width, height, x, y, font, timeout, %g_strNewFavoriteIconResource%
	InputBox, strTempNewFavoriteIconResource, % g_strAppNameFile . " - " . o_L["DialogEditIcon"], % o_L["DialogEditIconPrompt"], , 400, 160, , , , , %g_strNewFavoriteIconResource%
else if (A_ThisLabel = "GuiPickIconDialog")
	strTempNewFavoriteIconResource := PickIconDialog(g_strNewFavoriteIconResource)
else if (A_ThisLabel = "GuiPickIconDialogJl")
	strTempNewFavoriteIconResource := PickIconDialog(o_JLicons.strFileLocation)
else if (A_ThisLabel = "GuiPickIconDialogNo")
	strTempNewFavoriteIconResource := "iconNoIcon"
g_strNewFavoriteIconResource := (StrLen(strTempNewFavoriteIconResource) ? strTempNewFavoriteIconResource : g_strNewFavoriteIconResource)

Gosub, GuiFavoriteIconDisplay

strTempNewFavoriteIconResource := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiRemoveIcon:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

g_strNewFavoriteIconResource := ""
Gosub, GuiFavoriteIconDefault

Gosub, GuiFavoriteIconDisplay

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiFavoriteIconDefault:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

g_strDefaultIconResource := o_EditedFavorite.GetDefaultIcon4Type(f_strFavoriteLocation)

if !StrLen(g_strNewFavoriteIconResource) or (g_strNewFavoriteIconResource = "iconUnknown") or (g_strNewFavoriteIconResource = o_JLicons.AA["iconUnknown"])
	g_strNewFavoriteIconResource := g_strDefaultIconResource

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiFavoriteIconDisplay:
;------------------------------------------------------------

ParseIconResource(g_strNewFavoriteIconResource, strThisIconFile, intThisIconIndex)
strExpandedIconFile := EnvVars(strThisIconFile)
GuiControl, , f_picIcon, *icon%intThisIconIndex% %strExpandedIconFile%
GuiControl, % (g_strNewFavoriteIconResource <> g_strDefaultIconResource ? "Show" : "Hide"), f_lblRemoveIcon
GuiControl, % (strThisIconFile <> o_JLicons.strFileLocation ? "Show" : "Hide"), f_lblSelectIconJL

strThisFolder := (o_EditedFavorite.AA.strFavoriteType = "Folder" and StrLen(f_strFavoriteLocation) ? PathCombine(A_WorkingDir, EnvVars(f_strFavoriteLocation)) : "")
blnThisDesktopIniExist := (StrLen(strThisFolder) ? FileExist(strThisFolder . "\desktop.ini") : false)
strCurrentDesktopIcon := (StrLen(strThisFolder) ? GetFolderIcon(strThisFolder) : "")

if (o_EditedFavorite.AA.strFavoriteType = "Folder")
{
	GuiControl, % ((blnThisDesktopIniExist) ; desktop.ini exists
		or (g_strNewFavoriteIconResource <> g_strDefaultIconResource ; or icon is not default
		and (!blnThisDesktopIniExist) and (g_strNewFavoriteIconResource <> "iconNoIcon") ; but not if no icon and desktop does not exist
		and StrLen(f_strFavoriteLocation))
		? "Show" : "Hide")
		, f_lblSetWindowsFolderIcon

	; compare g_strNewFavoriteIconResource expanded and not expanded because if could be expanded or not in desktop.ini
	GuiControl, , f_lblSetWindowsFolderIcon
		, % "<a>"
		. ((strCurrentDesktopIcon = g_strNewFavoriteIconResource or strCurrentDesktopIcon = strExpandedIconFile . "," . intThisIconIndex) ; desktop icon is same as favorite
			or (blnThisDesktopIniExist and (g_strNewFavoriteIconResource = g_strDefaultIconResource or g_strNewFavoriteIconResource = "iconNoIcon")) ; or desktop icon exists and it is the default or no icon
		? o_L["DialogWindowsFolderIconRemove"] : o_L["DialogWindowsFolderIconSet"])
		. "</a>"
}

strExpandedIconFile := ""
strThisIconFile := ""
intThisIconIndex := ""
strThisFolder := ""
blnThisDesktopIniExist := ""
strCurrentDesktopIcon := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
CheckboxFolderLiveClicked:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

strShowHideCommand := (f_blnFavoriteFolderLive ? "Show" : "Hide")

GuiControl, %strShowHideCommand%, f_lblLiveFolderSortOrderLabel
GuiControl, %strShowHideCommand%, f_radLiveFolderSortA
GuiControl, %strShowHideCommand%, f_radLiveFolderSortD

GuiControl, %strShowHideCommand%, f_lblLiveFolderSortCriteriaLabel
GuiControl, %strShowHideCommand%, f_radLiveFolderSort1
GuiControl, %strShowHideCommand%, f_radLiveFolderSort2
GuiControl, %strShowHideCommand%, f_radLiveFolderSort3
GuiControl, %strShowHideCommand%, f_radLiveFolderSort4

GuiControl, %strShowHideCommand%, f_lblFavoriteFolderLiveLevels
GuiControl, %strShowHideCommand%, f_intFavoriteFolderLiveLevelsEdit
GuiControl, %strShowHideCommand%, f_intFavoriteFolderLiveLevels
if (f_blnFavoriteFolderLive and !StrLen(f_intFavoriteFolderLiveLevels))
	GuiControl, , f_intFavoriteFolderLiveLevels, 1
GuiControl, %strShowHideCommand%, f_lblFavoriteFolderLiveColumns
GuiControl, %strShowHideCommand%, f_intFavoriteFolderLiveColumnsEdit
GuiControl, %strShowHideCommand%, f_intFavoriteFolderLiveColumns
GuiControl, %strShowHideCommand%, f_blnFavoriteFolderLiveDocuments

; GuiControl, % (f_blnFavoriteFolderLive ? "Disable" : "Enable"), f_blnUseDefaultWindowPosition

GuiControl, , f_strFavoriteLaunchWith, % (f_blnFavoriteFolderLive ? "" : f_strFavoriteLaunchWith)
GuiControl, % (f_blnFavoriteFolderLive ? "Disable" : "Enable"), f_strFavoriteLaunchWith
GuiControl, % (f_blnFavoriteFolderLive ? "Disable" : "Enable"), f_btnFavoriteLaunchWith

GuiControl, , f_strFavoriteArguments, % (f_blnFavoriteFolderLive ? "" : f_strFavoriteArguments)
GuiControl, % (f_blnFavoriteFolderLive ? "Disable" : "Enable"), f_strFavoriteArguments

GuiControl, , f_blnFavoriteFolderLiveDocuments, % (f_blnFavoriteFolderLive ? (f_blnFavoriteFolderLiveDocuments = true) : false)
gosub, CheckboxFolderLiveDocumentsClicked

gosub, CheckboxFolderLiveChangeWindowPositionTab

strShowHideCommand := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
CheckboxFolderLiveDocumentsClicked:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

strShowHideCommand := (f_blnFavoriteFolderLiveDocuments ? "Show" : "Hide")

GuiControl, %strShowHideCommand%, f_radFavoriteFolderLiveInclude
GuiControl, %strShowHideCommand%, f_radFavoriteFolderLiveExclude
GuiControl, %strShowHideCommand%, f_lblFavoriteFolderLiveExtensions
GuiControl, %strShowHideCommand%, f_strFavoriteFolderLiveExtensions
GuiControl, , % (f_blnFavoriteFolderLiveDocuments ? "" : f_strFavoriteFolderLiveExtensions)

strShowHideCommand := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
CheckboxWindowPositionClicked:
RadioButtonWindowPositionMinMaxClicked:
CheckboxFolderLiveChangeWindowPositionTab:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

GuiControl, % (f_blnFavoriteFolderLive ? "Disable" : "Enable"), f_blnUseDefaultWindowPosition
GuiControl, , f_blnUseDefaultWindowPosition, % o_L["DialogUseDefaultWindowPosition"] . (f_blnFavoriteFolderLive ? " " . o_L["DialogUnavailableWithLiveFolders"] : "")
GuiControl, , f_lblFavoriteArguments, % o_L["DialogArgumentsLabel"] . (f_blnFavoriteFolderLive ? " " . o_L["DialogUnavailableWithLiveFolders"] : "")
GuiControl, , f_lblFavoriteLaunchWith, % o_L["DialogLaunchWith"] . (f_blnFavoriteFolderLive ? " " . o_L["DialogUnavailableWithLiveFolders"] : "")

strShowHideCommand := (!f_blnUseDefaultWindowPosition and (!f_blnFavoriteFolderLive) ? "Show" : "Hide")

GuiControl, %strShowHideCommand%, f_lblWindowPositionState
GuiControl, %strShowHideCommand%, f_lblWindowPositionMinMax1
GuiControl, %strShowHideCommand%, f_lblWindowPositionMinMax2
GuiControl, %strShowHideCommand%, f_lblWindowPositionMinMax3

GuiControl, %strShowHideCommand%, f_lblWindowPositionDelayLabel
GuiControl, %strShowHideCommand%, f_lblWindowPositionDelay
GuiControl, %strShowHideCommand%, f_lblWindowPositionMillisecondsLabel
GuiControl, %strShowHideCommand%, f_lblWindowPositionMayFail
GuiControl, %strShowHideCommand%, f_lblWindowPosition

strShowHideCommand := (!f_blnUseDefaultWindowPosition and f_lblWindowPositionMinMax1 and !f_blnFavoriteFolderLive ? "Show" : "Hide")

GuiControl, %strShowHideCommand%, f_lblWindowPositionX
GuiControl, %strShowHideCommand%, f_intWindowPositionX
GuiControl, %strShowHideCommand%, f_lblWindowPositionY
GuiControl, %strShowHideCommand%, f_intWindowPositionY
GuiControl, %strShowHideCommand%, f_lblWindowPositionW
GuiControl, %strShowHideCommand%, f_intWindowPositionW
GuiControl, %strShowHideCommand%, f_lblWindowPositionH
GuiControl, %strShowHideCommand%, f_intWindowPositionH

strShowHideCommand := (!f_blnUseDefaultWindowPosition and !f_lblWindowPositionMinMax1 and !f_blnFavoriteFolderLive ? "Show" : "Hide")

GuiControl, %strShowHideCommand%, f_drpWindowMonitor

strShowHideCommand := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
HotkeyEnterMenuOrFavorite:
;------------------------------------------------------------

Gui, 1:ListView, f_lvFavoritesList

g_intOriginalMenuPosition := LV_GetNext()

if o_MenuInGui.SA[g_intOriginalMenuPosition].IsContainer()
	Gosub, OpenMenuFromGuiHotkey
else if (LV_GetCount("Selected") = 1)
	Gosub, GuiEditFavorite

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiMenusListChanged:
GuiGotoUpMenu:
GuiGotoPreviousMenu:
OpenMenuFromEditForm:
OpenMenuFromGuiHotkey:
OpenMenuFromGuiSearch:
;------------------------------------------------------------

intCurrentLastPosition := 0

if (A_ThisLabel = "GuiMenusListChanged")
{
	GuiControlGet, strNewDropdownMenu, , f_drpMenusList

	if (strNewDropdownMenu = o_MenuInGui.AA.strMenuPath) ; user selected the current menu in the dropdown
	{
		gosub, GuiMenusListChangedCleanup
		return
	}
}

if (A_ThisLabel = "GuiGotoPreviousMenu")
{
	o_MenuInGui := o_Containers.AA[g_saSubmenuStack.Pop()] ; pull the last menu from the left arrow stack and remove it from the left arrow stack
	intCurrentLastPosition := g_saSubmenuStackPosition.Pop() ; pull the focus position in last menu from the left arrow stack and remove it from stack
}
else
{
	g_saSubmenuStack.Push(o_MenuInGui.AA.strMenuPath) ; push the current menu to the left arrow stack
	
	if (A_ThisLabel = "GuiMenusListChanged")
		o_MenuInGui := o_Containers.AA[strNewDropdownMenu]
	else if (A_ThisLabel = "GuiGotoUpMenu")
		o_MenuInGui := o_MenuInGui.AA.oParentMenu
	else if (A_ThisLabel = "OpenMenuFromEditForm") or (A_ThisLabel = "OpenMenuFromGuiHotkey")
		o_MenuInGui := o_MenuInGui.SA[g_intOriginalMenuPosition].AA.oSubMenu
	; else if (A_ThisLabel = "OpenMenuFromGuiSearch") ; we already have the menu object in o_MenuInGui from the search event
	
	g_saSubmenuStackPosition.Push(LV_GetNext("Focused"))
}

GuiControl, % (g_saSubmenuStack.MaxIndex() ? "Show" : "Hide"), f_picPreviousMenu
GuiControl, % (o_MenuInGui.AA.strMenuPath <> o_L["MainMenuName"] ? "Show" : "Hide"), f_picUpMenu

gosub, GuiFavoritesListFilterEmpty ; restore regular favorites list with o_MenuInGui

if (A_ThisLabel = "OpenMenuFromGuiSearch")
	Gosub, LoadMenuInGuiFromGuiSearch
else
	Gosub, LoadMenuInGui

if (intCurrentLastPosition) ; we went to a previous menu
{
	LV_Modify(0, "-Select")
	LV_Modify(intCurrentLastPosition, "Select Focus Vis")
}

if (A_ThisLabel = "GuiMenusListChanged") ; keep focus on dropdown list
	GuiControl, Focus, f_lvFavoritesList

GuiMenusListChangedCleanup:
intCurrentLastPosition := ""
strNewDropdownMenu := ""
strWriteAccessMessage := ""
strExternalMenuName := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiAddFavoriteCancel:
;------------------------------------------------------------

Gosub, GuiAddFavoriteFlush
Gosub, 2GuiClose

return
;------------------------------------------------------------


;------------------------------------------------------------
CheckShowSettings:
;------------------------------------------------------------

if !StrLen(o_MenuInGui.AA.strMenuPath)
	o_MenuInGui := o_MainMenu

DetectHiddenWindows, Off
if !WinExist(g_strGuiFullTitle) 
{
	Gosub, GuiShowFromGuiOutside
	Gui, 1:Default
	Gui, 1:ListView, f_lvFavoritesList
	LV_Modify(0, "-Select")
}
DetectHiddenWindows, On ; revert to app default
g_intGui1WinID := WinExist("A")

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiShow:
GuiShowFromQAPFeature:
GuiShowFromAlternative:
GuiShowRestoreDefaultPosition:
GuiShowFromGuiSettings:
GuiShowFromGuiAddFavoriteQAPFeature:
; next labels are not required, they could be GuiShow (but keep them in case of future debugging needs)
GuiShowFromTray:
GuiShowFromGuiOutside:
GuiShowFromAddThisFolder:
GuiShowFromHotkeysManage:
GuiShowFromIconsManage:
GuiShowFromExternalCatalogue:
GuiShowNeverCalled:
;------------------------------------------------------------

if !InStr("GuiShowFromAlternative|GuiShowFromGuiSettings|GuiShowFromGuiOutside|GuiShowRestoreDefaultPosition|", A_ThisLabel . "|") ; menu object already set in these cases
	or !IsObject(o_MenuInGui.AA) ; or in some situation at startup where o_MenuInGui is not defined
{
	if (o_Containers.AA[A_ThisMenu].AA.blnIsLiveMenu)
		strThisMenu := o_Containers.AA[A_ThisMenu].AA.oParentMenu.AA.strMenuPath
	else if (A_ThisMenu = "Tray" or A_ThisMenu = "" or !o_Containers.AA.HasKey(A_ThisMenu)
		or o_Containers.AA[A_ThisMenu].AA.strMenuType = "MenuBar") ; A_ThisMenu is empty or menu not in containers or menu is menu bar
		strThisMenu := o_L["MainMenuName"] ; not "Main" for non-English
	else
		strThisMenu := A_ThisMenu
	o_MenuInGui := o_Containers.AA[strThisMenu] ; A_ThisMenu is "Main" or "Main > Submenu"...
}

Gosub, RefreshQAPMenuExternalOnly

; to test backup/restore
; ###avant1 := o_MainMenu.SA[2].AA.oSubMenu.SA[1].AA.strFavoriteName
; ###avant2 := o_MainMenu.SA[2].AA.oSubMenu.SA[2].AA.oSubMenu.SA[1].AA.strFavoriteName

o_MainMenuBK := o_MainMenu.Backup() ; backup menu content

; to test backup/restore
; o_MainMenu.SA[2].AA.oSubMenu.SA[1].AA.strFavoriteName := "Item Menu 1 MOD"
; o_MainMenu.SA[2].AA.oSubMenu.SA[2].AA.oSubMenu.SA[1].AA.strFavoriteName := "Item Menu 2 MOD"
; ###apres1 := o_MainMenu.SA[2].AA.oSubMenu.SA[1].AA.strFavoriteName
; ###apres2 := o_MainMenu.SA[2].AA.oSubMenu.SA[2].AA.oSubMenu.SA[1].AA.strFavoriteName
; o_MainMenu := o_MainMenuBK
; o_MainMenu.RestoreContainersIndex()
; ###_V("o_MainMenu.SA[2].AA.oSubMenu.SA[1].AA.strFavoriteName", ###avant1, ###apres1, ###avant2, ###apres2
	; , o_MainMenu.SA[2].AA.oSubMenu.SA[1].AA.strFavoriteName
	; , o_MainMenu.SA[2].AA.oSubMenu.SA[2].AA.oSubMenu.SA[1].AA.strFavoriteName)

if (A_ThisLabel = "GuiShowFromAlternative")
	Gosub, LoadMenuInGuiFromAlternative
else
	Gosub, LoadMenuInGui

g_blnFavoritesListFilterNeverFocused := true
GuiControl, 1:, f_strFavoritesListFilter, % o_L["DialogSearch"]

if (A_ThisLabel = "GuiShowRestoreDefaultPosition" or ScreenConfigurationChanged())
	Gui, 1:Show, % "center w" . g_intGuiDefaultWidth . " h" . g_intGuiDefaultHeight
else
{
	GetPositionFromMouseOrKeyboard(g_strMenuTriggerLabel, A_ThisHotkey, intActiveX, intActiveY)
	if (o_Settings.SettingsWindow.blnOpenSettingsOnActiveMonitor.IniValue
		and GetWindowPositionOnActiveMonitor("ahk_id " . g_strAppHwnd, intActiveX, intActiveY, intPositionX, intPositionY))
		; display at center of active monitor
		Gui, 1:Show, % "x" . intPositionX . " y" . intPositionY
	else ; keep existing position
		Gui, 1:Show
}

GuiShowCleanup:
blnSaveEnabled := ""
strThisMenu := ""
intActiveX := ""
intActiveY := ""
intPositionX := ""
intPositionY := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GetFolderIcon(strFolderLocation)
;------------------------------------------------------------
{
	; do not try to retrieve custom icon if file is on a network (path starting with "\\")
	; return standard folder icon instead
	if (SubStr(strFolderLocation, 1, 2) = "\\")
		return "iconFolder"
	
	; if strFolderLocation has a relative path, make it absolute based on the working directry before reading desktop.ini
	strFolderDesktopIni := PathCombine(A_WorkingDir, EnvVars(strFolderLocation)) . "\desktop.ini"
	
	strDesktopIconFileIndex := o_Settings.ReadIniValue("IconResource", " ", ".ShellClassInfo", strFolderDesktopIni)
	
	if StrLen(strDesktopIconFileIndex)
	{
		strDesktopIconFile := SubStr(strDesktopIconFileIndex, 1, InStr(strDesktopIconFileIndex, ",") - 1)
		intDesktopIconIndex := SubStr(strDesktopIconFileIndex, InStr(strDesktopIconFileIndex, ",") + 1)
	}
	else
	{
		; IconFile and IconIndex are deprecated since Vista but still supported
		strDesktopIconFile := o_Settings.ReadIniValue("IconFile", " ", ".ShellClassInfo", strFolderDesktopIni)
		intDesktopIconIndex := o_Settings.ReadIniValue("IconIndex", 0, ".ShellClassInfo", strFolderDesktopIni)
	}

	; when retrieving an icon from a desktop.ini file, if the icon resource has relative path make it absolute based on the favorite folder (not the working directory)
	if StrLen(strDesktopIconFile)
		strDesktopIconFileIndex := PathCombine(strFolderLocation, EnvVars(strDesktopIconFile)) . ","
			. intDesktopIconIndex + (intDesktopIconIndex >= 0 ? 1 : 0) ; adjust index for positive index only (not for negative index)
	
	if !StrLen(strDesktopIconFileIndex)
		strDesktopIconFileIndex := "iconFolder"
	
	return strDesktopIconFileIndex
}
;------------------------------------------------------------


;------------------------------------------------------------
SetWindowsFolderIcon:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

GuiControlGet, strSetWindowsFolderIconLabel, , f_lblSetWindowsFolderIcon
blnSet := (strSetWindowsFolderIconLabel = "<a>" . o_L["DialogWindowsFolderIconSet"] . "</a>") ; else o_L["DialogWindowsFolderIconRemove"]

strFolder := PathCombine(A_WorkingDir, EnvVars(f_strFavoriteLocation))
strFolderDesktopIni := strFolder . "\desktop.ini" 
strDesktopIniAttrib := FileExist(strFolderDesktopIni)
blnDesktopIniExist := StrLen(strDesktopIniAttrib)
SplitPath, strFolderDesktopIni, , strDir, , , strDrive
blnFolderIsRoot := (strDir = strDrive . "\")

if (blnSet)
{
	if (blnFolderIsRoot)
	{
		Oops(o_L["DialogWindowsFolderIconNoRoot"])
		Gosub, SetWindowsFolderIconCleanup
		return
	}
	
	strVerb := (blnDesktopIniExist ? o_L["DialogWindowsFolderIconUpdate"] : o_L["DialogWindowsFolderIconCreate"])
	strMessage := L(o_L["DialogWindowsFolderIconPrompt"], strVerb, strFolderDesktopIni) . "`n`n" . o_L["DialogWindowsFolderIconPrompt2"]
	MsgBox, 4, %g_strAppNameText%, %strMessage%
}
else ; remove
{
	strMessage := L(o_L["DialogWindowsFolderIconReset"])
	strMessageRemove := L(o_L["DialogWindowsFolderIconRemoveFile"], strFolderDesktopIni)
	MsgBox, 4, %g_strAppNameText%, %strMessage%
}

IfMsgBox, No
{
	Gosub, SetWindowsFolderIconCleanup
	return
}

if (g_strCurrentBranch <> "prod" and blnDesktopIniExist)
{
	FileCopy, %strFolderDesktopIni%, %strFolderDesktopIni%-BK.txt, 1 ; overwrite
	FileSetAttrib, -S-H, %strFolderDesktopIni%-BK.txt ; make it normal file
}

if (blnDesktopIniExist)
{
	; In any case, if they exist, remove deprecated values IconFile and IconIndex (deprecated after XP)
	IniDelete, %strFolderDesktopIni%, .ShellClassInfo, IconFile
	IniDelete, %strFolderDesktopIni%, .ShellClassInfo, IconIndex
}

if (blnSet)
{
	FileSetAttrib, +R, %strFolder%, 2 ; make sure folder is read-only to display icon (was system in previous doc)
 
	; From: https://msdn.microsoft.com/en-us/library/cc144102.aspx
	ParseIconResource(g_strNewFavoriteIconResource, strIconFile, intIconIndex)
	strIconFile := StrReplace(strIconFile, strFolder . "\") ; remove current folder from resource path to make it movable with the folder
	intIconIndex := (intIconIndex >= 0 ? intIconIndex - 1 : intIconIndex) ; adjust index for positive index only (not for negative index)
	IniWrite %strIconFile%`,%intIconIndex%, %strFolderDesktopIni%, .ShellClassInfo, IconResource
	; ConfirmFileOp -> Set this entry to 0 to avoid a "You Are Deleting a System Folder" warning when deleting or moving the folder.
	IniWrite 0, %strFolderDesktopIni%, .ShellClassInfo, ConfirmFileOp

	if !(blnDesktopIniExist) ; the file is new
		FileSetAttrib, +H+S, %strFolderDesktopIni% ; make it system and hidden
}
else ; remove
{
	IniDelete, %strFolderDesktopIni%, .ShellClassInfo, IconResource

	MsgBox, 4, %g_strAppNameText%, % L(strMessageRemove, strFolderDesktopIni)
	IfMsgBox, Yes
	{
		FileSetAttrib, -R, %strFolder%, 2 ; remove read-only (was system) attribute from folder
		FileDelete, %strFolderDesktopIni%
	}
}

gosub, GuiFavoriteIconDisplay

SetWindowsFolderIconCleanup:
blnSet := ""
strSetWindowsFolderIconLabel := ""
strFolder := ""
strFolderDesktopIni := ""
strDesktopIniAttrib := ""
blnDesktopIniExist := ""
strDir := ""
strDrive := ""
blnFolderIsRoot := ""
strMessage := ""
strVerb := ""
strMessageRemove := ""
strIconFile := ""
intIconIndex := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
LoadExternalFileGlobalValues:
;------------------------------------------------------------

strExternalExpandedFileName := PathCombine(A_WorkingDir, EnvVars(f_strFavoriteAppWorkingDir))
if StrLen(GetFileExtension(strExternalExpandedFileName)) = 0
	strExternalExpandedFileName .= ".ini"

intMenuExternalType := o_Settings.ReadIniValue("MenuType", "", "Global", strExternalExpandedFileName) ; 1 Personal, 2 Collaborative or 3 Centralized (no default)

if (intMenuExternalType <> "ERROR")
{
	GuiControl, , % "f_radExternalMenuType" . intMenuExternalType, % 1
	gosub, RadioButtonExternalMenuInit
}
else
{
	intMenuExternalType := ""
	return
}

blnExternalMenuReadOnly := o_Settings.ReadIniValue("MenuReadOnly", 0, "Global", strExternalExpandedFileName) ; false if not found
; deprecated since v8.1.1 but still supported ix exists in ini file
; GuiControl, , f_blnExternalMenuReadOnly, %blnExternalMenuReadOnly%

strExternalMenuName := o_Settings.ReadIniValue("MenuName", " ", "Global", strExternalExpandedFileName) ; empty if not found
GuiControl, , f_strExternalMenuName, %strExternalMenuName%

strExternalWriteAccessUsers := o_Settings.ReadIniValue("WriteAccessUsers", " ", "Global", strExternalExpandedFileName) ; empty if not found
GuiControl, , f_strExternalWriteAccessUsers, %strExternalWriteAccessUsers%

strExternalWriteAccessMessage := o_Settings.ReadIniValue("WriteAccessMessage", " ", "Global", strExternalExpandedFileName) ; empty if not found
GuiControl, , f_strExternalWriteAccessMessage, %strExternalWriteAccessMessage%

strExternalLastModifiedFromNetworkOrCoud := o_Settings.ReadIniValue("LastModifiedFromSystem", " ", "Global", strExternalExpandedFileName) ; empty if not found
GuiControl, , f_radExternalSourceNetwork, % strExternalLastModifiedFromNetworkOrCoud <> 1
GuiControl, , f_radExternalSourceCloud, % strExternalLastModifiedFromNetworkOrCoud = 1

blnExternalMenuReadOnly := ""
strExternalMenuName := ""
strExternalWriteAccessUsers := ""
strExternalWriteAccessMessage := ""
intMenuExternalType := ""
strExternalExpandedName := ""
strExternalLastModifiedFromNetworkOrCoud := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
LoadExternalFileGlobalReadOnly:
;------------------------------------------------------------

; read-only menu can be editable if user is in ExternalWriteAccessUsers
strReadOnlyPrefix := (ExternalMenuIsReadOnly(f_strFavoriteAppWorkingDir) ? "+" : "-")

GuiControl, 2:%strReadOnlyPrefix%ReadOnly, f_strExternalMenuName
GuiControl, 2:%strReadOnlyPrefix%ReadOnly, f_strExternalWriteAccessUsers
GuiControl, 2:%strReadOnlyPrefix%ReadOnly, f_strExternalWriteAccessMessage

strReadOnlyPrefix := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
AddExternalMenusFromCatalogue:
AddExternalCatalogueFromQAPFeature:
;------------------------------------------------------------

if (A_ThisLabel = "AddExternalCatalogueFromQAPFeature")
	gosub, GuiShowFromExternalCatalogue
else
	gosub, 2GuiClose

g_intGui1WinID := WinExist("A")

strGuiTitle := L(o_L["DialogExternalMenuAddFromCatalogue"], g_strAppNameText, g_strAppVersion)
Gui, 2:New, +Hwndg_strGui2Hwnd, %strGuiTitle%
Gui, 2:+Owner1
Gui, 2:+OwnDialogs
if (g_blnUseColors)
	Gui, 2:Color, %g_strGuiWindowColor%

Gui, 2:Add, Text, , % L(o_L["DialogExternalMenuSelectFromCatalogue"], o_L["DialogExternalMenuAdd"])
Gui, 2:Add, ListView, % "vf_lvExternalMenusCatalogue Count32 Checked " . (g_blnUseColors ? "c" . g_strGuiListviewTextColor . " Background" . g_strGuiListviewBackgroundColor : "") 
	. " gExternalMenusCatalogueListEvents x10 y+10 w640 h340 AltSubmit", % o_L["DialogExternalMenuAddHeader"]

Gui, 2:Add, Text, x10 w640 center, % o_L["DialogExternalTip"]
Gui, 2:Add, Text
Gui, 2:Add, Button, x10 gButtonAddExternalMenusFromCatalogue vf_btnAddExternalMenusFromCatalogue default, % o_L["DialogExternalMenuAdd"]
Gui, 2:Add, Button, x+20 yp gButtonAddExternalMenusNotFromCatalogue vf_btnAddExternalMenusNotFromCatalogue, % o_L["DialogExternalMenuAddNotFromCatalogue"]
Gui, 2:Add, Button, x+20 yp gButtonAddExternalMenusFromCatalogueClose vf_btnAddExternalMenusFromCatalogueClose, % o_L["GuiClose"]
Gui, 2:Add, Text
	
strExpandedPath := PathCombine(A_WorkingDir, EnvVars(o_Settings.SettingsFile.strExternalMenusCataloguePath.IniValue))

Loop, Files, %strExpandedPath%\*.ini, R
{
	if InStr(A_LoopFileFullPath, "-backup-20") ; if include "-backup-YYYYMMDD"
		Continue
	strName := o_Settings.ReadIniValue("MenuName", " ", "Global", A_LoopFileFullPath)
	strName := StrReplace(strName, "&&", "&")
	LV_Add("", strName, A_LoopFileFullPath)
}
LV_ModifyCol(, "")

GuiCenterButtons(strGuiTitle, 20, 10, , "f_btnAddExternalMenusFromCatalogue", "f_btnAddExternalMenusNotFromCatalogue", "f_btnAddExternalMenusFromCatalogueClose")

Gosub, ShowGui2AndDisableGui1

strExpandedPath := ""
strName := ""
strGuiTitle := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
ExternalMenusCatalogueListEvents:
;------------------------------------------------------------

if (A_GuiEvent = "DoubleClick")
{
	Gui, 2:+OwnDialogs
	LV_GetText(strFile, A_EventInfo, 2)
	strValue := o_Settings.ReadIniValue("MenuName", " ", "Global", strFile)
	strTitle := o_L["DialogAddFavoriteTabsExternal"] . " - " . strValue
	strMessage := o_L["DialogExternalMenuName"] . ":`n" . (StrLen(strValue) ? strValue : o_L["DialogNone"]) . "`n`n"
	strValue := o_Settings.ReadIniValue("MenuType", " ", "Global", strFile)
	objExternalTypes := StrSplit(o_L["DialogExternalTypes"], "|")
	strMessage .= o_L["DialogExternalTypesLabel"] . ":`n" . (StrLen(strValue) ? objExternalTypes[strValue] . " (" . strValue . ")": o_L["DialogNone"]) . "`n`n"
	strValue := o_Settings.ReadIniValue("WriteAccessUsers", " ", "Global", strFile)
	strMessage .= o_L["DialogExternalWriteAccessUsers"] . ":`n" . (StrLen(strValue) ? strValue : o_L["DialogNone"]) . "`n`n"
	strValue := o_Settings.ReadIniValue("WriteAccessMessage", " ", "Global", strFile)
	strMessage .= o_L["DialogExternalWriteAccessMessage"] . ":`n" . (StrLen(strValue) ? strValue : o_L["DialogNone"]) . "`n`n"
	blnReadOnly := ExternalMenuIsReadOnly(strFile)
	MsgBox, % (blnReadOnly ? "0" : "4"), %strTitle%, % strMessage . (blnReadOnly ? "" : "`n`n" . o_L["DialogExternalMenuOpen"])
	IfMsgBox, Yes
		Run, %strFile%
}

strFile := ""
strValue := ""
strTitle := ""
objExternalTypes := ""
strMessage := ""
blnReadOnly := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
ButtonAddExternalMenusFromCatalogue:
;------------------------------------------------------------

intCatalogueRow := 0  ; This causes the first loop iteration to start the search at the top of the list.
intNbMenusAdded := 0
Loop
{
	Gui, 2:Default
	GuiControl, 2:Focus, f_lvExternalMenusCatalogue
	Gui, 2:ListView, f_lvExternalMenusCatalogue
    intCatalogueRow := LV_GetNext(intCatalogueRow, "Checked")  ; Resume the search at the row after that found by the previous iteration.
    if !(intCatalogueRow)  ; The above returned zero, so there are no more selected rows.
        break
    LV_GetText(strFile, intCatalogueRow, 2)
	g_strNewLocation := strFile
	
	g_blnExternalMenusAdded := false ; will be set true by GuiAddExternalSave
	Gosub, GuiAddExternalFromCatalogue
	Gosub, GuiAddExternalSave
	if (g_blnExternalMenusAdded)
	{
		intNbMenusAdded++
		Gui, 1:Default
		Gui, 1:ListView, f_lvFavoritesList
		intListviewRow := LV_GetNext() + 1
		LV_Modify(0, "-Select")
		LV_Modify(intListviewRow, "Select")
	}
}
if (intNbMenusAdded)
	MsgBox, 0, %g_strAppNameText%, % L((intNbMenusAdded > 1 ? o_L["DialogExternalMenusAdded"] : o_L["DialogExternalMenuAdded"]), intNbMenusAdded)

Gosub, 2GuiClose

intNbMenusAdded := ""
intListviewRow := ""
g_blnExternalMenusAdded := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
ButtonAddExternalMenusNotFromCatalogue:
;------------------------------------------------------------

Gosub, GuiAddExternalOtherExternal

return
;------------------------------------------------------------


;------------------------------------------------------------
ButtonAddExternalMenusFromCatalogueClose:
;------------------------------------------------------------

Gosub, 2GuiClose

return
;------------------------------------------------------------


;========================================================================================================================
; END OF FAVORITE_GUI
;========================================================================================================================


;========================================================================================================================
!_034_FAVORITE_GUI_SAVE:
;========================================================================================================================

;------------------------------------------------------------
GuiMoveMultipleFavoritesSave:
GuiCopyMultipleFavoritesSave:
;------------------------------------------------------------
Gui, 2:Submit, NoHide
Gui, 2:+OwnDialogs

blnMove := (A_ThisLabel = "GuiMoveMultipleFavoritesSave")

if (f_drpParentMenu = o_MenuInGui.AA.strMenuPath)
{
	OopsGui2(o_L["OopsCannotCopyMoveToSelf"])
	return
}

; check if favorites to copy include menus or groups
Gui, 1:Default
Gui, ListView, f_lvFavoritesList
intTempMenuPosition := 0
if (!blnMove) ; multiple copy not supported for menus, external and groups
	Loop
	{
		intTempMenuPosition := LV_GetNext(intTempMenuPosition)
		if (!intTempMenuPosition)
			break
		if InStr("|Menu|Group|External", "|" . o_MenuInGui.SA[intTempMenuPosition].AA.strFavoriteType)
		{
			MsgBox, 4, %g_strAppNameText%, % o_L["CopyFavoritesToMenuOrGroup"]
			IfMsgBox, Yes
				break
			else
				return
	}
}

g_intOriginalMenuPosition := 0
intNbFavoritesCopied := 0
g_blnMulipleMoveOrCopyAborted := false

Loop
{
	g_intOriginalMenuPosition := LV_GetNext(g_intOriginalMenuPosition)
	if (!g_intOriginalMenuPosition)
        break
	if (!blnMove and o_MenuInGui.SA[g_intOriginalMenuPosition].IsContainer()) ; skip menus and groups for copy
		continue

	if (blnMove)
		o_EditedFavorite := o_MenuInGui.SA[g_intOriginalMenuPosition]
	else
		o_EditedFavorite := o_MenuInGui.SA[g_intOriginalMenuPosition].Backup()

	if (blnMove)
	{
		Gosub, GuiMoveOneFavoriteSave
		g_intOriginalMenuPosition -=  1 ; because GuiMoveOneFavoriteSave deleted the previous item
	}
	else
	{
		Gosub, GuiCopyOneFavoriteSave
		if !(g_blnMulipleMoveOrCopyAborted)
			intNbFavoritesCopied++
		if (f_drpParentMenu = o_MenuInGui.AA.strMenuPath) and (g_intOriginalMenuPosition >= g_intNewItemPos) ; copied items are inserted before selected, increment selected
			g_intOriginalMenuPosition++
	}
	
	if (g_blnMulipleMoveOrCopyAborted)
		break
}

if (intNbFavoritesCopied)
	Oops(o_L["OopsFavoritesCopied"], intNbFavoritesCopied)

gosub, GuiAddFavoriteSaveCleanup ; clean these variables for next multiple move or copy

Gosub, GuiAddFavoriteCancel

blnMove := ""
intNbFavoritesCopied := ""
intTempMenuPosition := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiAddFavoriteSave:
GuiAddFavoriteSaveXpress:
GuiEditFavoriteSave:
GuiCopyOneFavoriteSave:
GuiMoveOneFavoriteSave:
GuiCopyFavoriteSave:
GuiAddExternalSave:
;------------------------------------------------------------

Gui, 2:Submit, NoHide
Gui, 2:+OwnDialogs

strThisLabel := A_ThisLabel
g_blnAbortSave := false

gosub, GuiAddFavoriteSaveValidate
if (g_blnAbortSave)
{
	gosub, GuiAddFavoriteSaveCleanup
	return
}

; if adding menu or group, create submenu object

if (o_EditedFavorite.IsContainer() and InStr("GuiAddFavoriteSave|GuiAddExternalSave|", strThisLabel . "|"))
{
	global o_EditedFavoriteMenu := new Container(o_EditedFavorite.AA.strFavoriteType, strNewFavoriteShortName, o_Containers.AA[strDestinationMenu]) ; class instance for the new menu or group

	if (o_EditedFavoriteMenu.AA.strMenuType = "External")
	{
		o_EditedFavoriteMenu.AA.strMenuExternalSettingsPath := PathCombine(A_WorkingDir, EnvVars(strFavoriteAppWorkingDir))
		o_EditedFavoriteMenu.AA.blnMenuExternalLoaded := true ; consider as loaded since it is new and empty
	}

	o_EditedFavorite.AA.oSubmenu := o_EditedFavoriteMenu
}
else
	o_EditedFavoriteMenu := o_EditedFavorite.AA.oSubmenu

; update menu object except if we multiple move or copy favorites

if !InStr("|GuiMoveOneFavoriteSave|GuiCopyOneFavoriteSave", "|" . strThisLabel)
{
	; if external menu file exists, load the submenu from the external settings ini file

	if (o_EditedFavorite.AA.strFavoriteType = "External")
	{
		if FileExist(o_EditedFavoriteMenu.AA.strMenuExternalSettingsPath) ; file path exists
			; load the external menu to menu instance o_EditedFavoriteMenu created earlier
			o_EditedFavoriteMenu.LoadFavoritesFromIniFile(false, true) ; true for Refresh External
		else ; if external settings file does not exist, create empty [Favorites] section
		{
			MsgBox, 4, %g_strAppNameText%, % L(o_L["DialogExternalMenuNotExist"], o_EditedFavoriteMenu.AA.strMenuExternalSettingsPath)
			IfMsgBox, No
			{
				gosub, GuiAddFavoriteSaveCleanup
				return
			}
			IniWrite, Z, % o_EditedFavoriteMenu.AA.strMenuExternalSettingsPath, Favorites, Favorite1
			Sleep, 20 ; for safety
		}
		
		; if external settings file is not read-only, write [Global] values to external settings file
		if !ExternalMenuIsReadOnly(o_EditedFavoriteMenu.AA.strMenuExternalSettingsPath)
		{
			if !(g_blnExternalLocationChanged) and !(strThisLabel = "GuiAddExternalSave") ; only if external menu created with dialog box
			{
				intMenuExternalType := (f_radExternalMenuType1 ? 1 : (f_radExternalMenuType2 ? 2 : 3))
				IniWrite, %intMenuExternalType%, % o_EditedFavoriteMenu.AA.strMenuExternalSettingsPath, Global, MenuType
				IniWrite, %f_strExternalMenuName%, % o_EditedFavoriteMenu.AA.strMenuExternalSettingsPath, Global, MenuName
				IniWrite, %f_strExternalWriteAccessUsers%, % o_EditedFavoriteMenu.AA.strMenuExternalSettingsPath, Global, WriteAccessUsers
				IniWrite, %f_strExternalWriteAccessMessage%, % o_EditedFavoriteMenu.AA.strMenuExternalSettingsPath, Global, WriteAccessMessage
				; update last modified value in ini file because values requiring update by other users were changed
				IniWrite, % (f_radExternalSourceCloud = 1), % o_EditedFavoriteMenu.AA.strMenuExternalSettingsPath, Global, LastModifiedFromSystem
				strLastModified := ExternalMenuGetModifiedDateTime(o_EditedFavoriteMenu.AA.strMenuExternalSettingsPath)
				IniWrite, %strLastModified%, % o_EditedFavoriteMenu.AA.strMenuExternalSettingsPath, Global, LastModified
			}
			else
				strLastModified := ExternalMenuGetModifiedDateTime(o_EditedFavoriteMenu.AA.strMenuExternalSettingsPath)
				; else, no need to save values from advanced tab because they were not updated yet by GuiAddFavoriteTabChanged

			; update object's last modified dates anyway
			o_EditedFavorite.AA.oSubMenu.MenuExternalLastModifiedWhenLoaded := strLastModified
			o_EditedFavorite.AA.oSubMenu.MenuExternalLastModifiedNow := strLastModified
			o_EditedFavorite.AA.oSubMenu.MenuExternalLastModifiedFromNetworkOrCoud := (f_radExternalSourceCloud = 1)
		}
	}

	o_EditedFavorite.AA.strFavoriteName := strNewFavoriteShortName

	if o_EditedFavorite.IsContainer()
		o_EditedFavorite.UpdateMenusPathAndLocation(strDestinationMenu) ; also update o_Containers
	else
	{
		if (o_EditedFavorite.AA.strFavoriteType = "WindowsApp") and (f_drpWindowsAppsList = "* " . o_L["DialogWindowsAppsListCustom"])
			strNewFavoriteLocation := "Custom:" . strNewFavoriteLocation
		o_EditedFavorite.AA.strFavoriteLocation := strNewFavoriteLocation
	}

	; attach favorite object to its parent menu
	o_EditedFavorite.AA.oParentMenu := o_Containers.AA[strDestinationMenu]

	Gosub, UpdateFavoriteObjectSaveShortcut
	Gosub, UpdateFavoriteObjectSaveHotstring ; puts g_strNewFavoriteHotstring in o_EditedFavorite.AA.strFavoriteHotstring

	; for safety check if icon resource is empty, if yes, set default icon for type
	if !StrLen(g_strNewFavoriteIconResource)
		g_strNewFavoriteIconResource := o_EditedFavorite.GetDefaultIcon4Type(strNewFavoriteLocation)
	o_EditedFavorite.AA.strFavoriteIconResource := g_strNewFavoriteIconResource
	
	o_EditedFavorite.AA.strFavoriteWindowPosition := strNewFavoriteWindowPosition
	
	if (o_EditedFavorite.AA.strFavoriteType = "Group")
	{
		o_EditedFavorite.AA.strFavoriteGroupSettings := f_blnRadioGroupReplace
		o_EditedFavorite.AA.strFavoriteGroupSettings .= "," . (f_blnRadioGroupRestoreWithOther ? "Other" : "Windows Explorer")
		o_EditedFavorite.AA.strFavoriteGroupSettings .= "," . f_intGroupRestoreDelay
	}

	o_EditedFavorite.AA.strFavoriteLoginName := f_strFavoriteLoginName
	o_EditedFavorite.AA.strFavoritePassword := f_strFavoritePassword
	o_EditedFavorite.AA.blnFavoriteFtpEncoding := f_blnFavoriteFtpEncoding
	
	o_EditedFavorite.AA.strFavoriteArguments := f_strFavoriteArguments
	o_EditedFavorite.AA.strFavoriteAppWorkingDir := strFavoriteAppWorkingDir
	o_EditedFavorite.AA.blnFavoriteDisabled := f_blnFavoriteDisabled
	
	o_EditedFavorite.AA.intFavoriteFolderLiveLevels := (f_blnFavoriteFolderLive ? f_intFavoriteFolderLiveLevels : "")
	o_EditedFavorite.AA.blnFavoriteFolderLiveDocuments := (f_blnFavoriteFolderLive ? f_blnFavoriteFolderLiveDocuments : "")
	o_EditedFavorite.AA.intFavoriteFolderLiveColumns := (f_blnFavoriteFolderLive ? (f_intFavoriteFolderLiveColumns = 0 ? "" : f_intFavoriteFolderLiveColumns) : "")
	o_EditedFavorite.AA.blnFavoriteFolderLiveIncludeExclude := (f_blnFavoriteFolderLive ? f_radFavoriteFolderLiveInclude : "")
	o_EditedFavorite.AA.strFavoriteFolderLiveExtensions := (f_blnFavoriteFolderLive ? f_strFavoriteFolderLiveExtensions : "")

	o_EditedFavorite.AA.strFavoriteSoundLocation := strNewFavoriteSoundLocation

	if (f_blnFavoriteFolderLive)
	{
		strLoopCriteria := 0
		loop
			if (f_radLiveFolderSort%A_Index%)
				strLoopCriteria := A_Index
		until (strLoopCriteria > 0)
		o_EditedFavorite.AA.strFavoriteFolderLiveSort := (f_radLiveFolderSortA ? "A" : "D") . strLoopCriteria
	}

	if (o_EditedFavorite.AA.strFavoriteType = "Snippet")
		; 1 macro (boolean) true: send snippet to current application using macro mode / else paste as raw text
		; 2 prompt (text) pause prompt before pasting/launching the snippet
		; 3 encode (boolean) true: automatically encode / false: do not encode
		; 4 fixed width (boolean) true: fixed width / false: proportional width
		; 5 font size (integer)
		o_EditedFavorite.AA.strFavoriteLaunchWith := f_blnRadioSendModeMacro . ";" . f_strFavoriteSnippetPrompt . ";" . f_blnProcessEOLTab . ";" . f_blnFixedFont . ";" . f_intFontSize
	else
	{
		o_EditedFavorite.AA.strFavoriteLaunchWith := f_strFavoriteLaunchWith
		o_EditedFavorite.AA.blnFavoriteElevate := f_blnFavoriteElevate
	}
}
else ; GuiMoveOneFavoriteSave and GuiCopyOneFavoriteSave (but GuiCopyOneFavoriteSave cannot be part of multiple copy)
	if o_EditedFavorite.IsContainer()
		; for Menu and Group in multiple moved, update the strFavoriteLocation in favorite object and update menus and hotkeys index objects
		o_EditedFavorite.UpdateMenusPathAndLocation(strDestinationMenu)

; updating original and destination menu objects (these can be the same)

if (strOriginalMenu <> "")
	o_Containers.AA[strOriginalMenu].SA.RemoveAt(g_intOriginalMenuPosition) ; use .RemoveAt, not .Delete
if !(g_intNewItemPos)
	g_intNewItemPos := o_Containers.AA[strDestinationMenu].SA.MaxIndex() + 1
o_Containers.AA[strDestinationMenu].SA.InsertAt(g_intNewItemPos, o_EditedFavorite)

; updating listview
if (strThisLabel <> "GuiAddExternalSave")
	Gosub, 2GuiClose
else ; GuiAddExternalSave
	g_blnExternalMenusAdded := true

Gui, 1:Default
GuiControl, 1:Focus, lvFavoritesList
Gui, 1:ListView, lvFavoritesList

if (strOriginalMenu = o_MenuInGui.AA.strMenuPath) ; remove original from Listview if original in Gui (can be replaced with modified)
	LV_Delete(g_intOriginalMenuPosition)

if (strDestinationMenu = o_MenuInGui.AA.strMenuPath) ; add modified to Listview if destination in Gui (can replace original deleted)
{
	if (strThisLabel <> "GuiCopyOneFavoriteSave") ; to protect selected items in multiple copy to same folder
		LV_Modify(0, "-Select")
	if (o_EditedFavorite.AA.strFavoriteType = "Menu")
		strThisLocation := g_strMenuPathSeparator
	else if (o_EditedFavorite.AA.strFavoriteType = "External")
		strThisLocation := (ExternalMenuIsReadOnly(strFavoriteAppWorkingDir) ? o_L["DialogReadOnly"] . " " : "")
			. g_strMenuPathSeparator . g_strMenuPathSeparator . " " . strFavoriteAppWorkingDir
	else if (o_EditedFavorite.AA.strFavoriteType = "Group")
		strThisLocation := g_strGroupIndicatorPrefix . g_strGroupIndicatorSuffix
	else
		strThisLocation := o_EditedFavorite.AA.strFavoriteLocation

	strThisType := o_EditedFavorite.GetItemTypeLabelForList()
	strThisHotkey := new Triggers.HotkeyParts(o_EditedFavorite.AA.strFavoriteShortcut).Hotkey2Text(true)
	if StrLen(o_EditedFavorite.AA.strFavoriteHotstring)
		strThisHotkey .= " " . BetweenParenthesis(GetHotstringTrigger(o_EditedFavorite.AA.strFavoriteHotstring))

	; GuiCopyOneFavoriteSave condition to protect selected items in multiple copy to same folder
	if (g_intNewItemPos)
		LV_Insert(g_intNewItemPos, (strThisLabel <>"GuiCopyOneFavoriteSave" ? "Select Focus" : ""), o_EditedFavorite.AA.strFavoriteName, strThisType, strThisHotkey, strThisLocation)
	else
		LV_Add((strThisLabel <>"GuiCopyOneFavoriteSave" ? "Select Focus" : ""), o_EditedFavorite.AA.strFavoriteName, strThisType, strThisHotkey, strThisLocation)
	
	if (strThisLabel <> "GuiCopyOneFavoriteSave") ; to protect selected items in multiple copy to same folder
		LV_Modify(LV_GetNext(), "Vis")
}

GuiControl, 1:, f_drpMenusList, % "|" . o_MainMenu.BuildMenuListDropDown(o_MenuInGui.AA.strMenuPath) . "|" ; required if submenu was added
Gosub, AdjustColumnsWidth

Gosub, EnableSaveAndCancel

; if favorite's original or destination menu are in an external settings file, flag that they need to be saved
if o_Containers.AA[strDestinationMenu].FavoriteIsUnderExternalMenu(o_ExternalMenu)
	o_ExternalMenu.AA.blnNeedSave := true
if StrLen(strOriginalMenu) and (strOriginalMenu <> strDestinationMenu)
	if o_Containers.AA[strOriginalMenu].FavoriteIsUnderExternalMenu(o_ExternalMenu)
		o_ExternalMenu.AA.blnNeedSave := true

if ("|GuiMoveOneFavoriteSave|GuiCopyOneFavoriteSave", "|" . strThisLabel)
	g_intNewItemPos++ ; move next favorite after this one in the destination menu (or will be deleted in GuiMoveOneFavoriteSave after the loop)
else
	g_intNewItemPos := "" ; delete it for next use

GuiAddFavoriteSaveCleanup:
if !InStr("|GuiMoveOneFavoriteSave|GuiCopyOneFavoriteSave", "|" . strThisLabel) ; do not execute at each favorite when moving multiple favorites
	or (A_ThisLabel = "GuiAddFavoriteSaveCleanup") ; but executed it when called at the end of GuiMoveMultipleFavoritesSave/GuiCopyMultipleFavoritesSave
{
	strOriginalMenu := ""
	strDestinationMenu := ""
	strMenuLocation := ""
	strThisLocation := ""
	strThisType := ""
	strThisHotkey := ""
	strNewFavoriteWindowPosition := ""
	strMenuPath := ""
	g_intNewItemPos := "" ; in case we abort save and retry
	strIndexToRemove := ""
	strThisMenuIndexPath := ""
	objThisMenu := ""
	strHttpLocationTransformed := ""
	strNewFavoriteShortName := ""
	strNewFavoriteLocation := ""
	intMenuExternalType := ""
	strLastModified := ""
	strValidKeys := ""
	strThisHotstringTrigger := ""
	strThisHotstringOptions := ""
	g_strNewFavoriteHotstring := ""
	g_strNewFavoriteHotstringTrigger := ""
	g_strNewFavoriteHotstringOptionsShort := ""
	strLoopCriteria := ""
	strExternalFilenameNoExt := ""
	strNewFavoriteSoundLocation := ""
	strExpandedNewFavoriteLocation := ""
	
	; make sure all gui variables are flushed before next fav add or edit
	Gosub, GuiAddFavoriteFlush
}

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiAddFavoriteFlush:
;------------------------------------------------------------

; make sure all gui variables are flushed before next fav add or edit
f_blnRadioGroupAdd := ""
f_blnRadioGroupReplace := ""
f_blnRadioGroupRestoreWithExplorer := ""
f_blnRadioGroupRestoreWithOther := ""
f_blnUseDefaultWindowPosition := ""
f_drpParentMenu := ""
f_drpParentMenuItems := ""
f_tvQAP := ""
f_tvSpecial := ""
f_drpRunningApplication := ""
f_drpSpecial := ""
f_intGroupExplorerDelay := ""
f_intGroupRestoreDelay := ""
f_intWindowPositionH := ""
f_intWindowPositionW := ""
f_intWindowPositionX := ""
f_intWindowPositionY := ""
f_picIcon := ""
f_strFavoriteAppWorkingDir := ""
f_strFavoriteArguments := ""
f_strFavoriteLaunchWith := ""
f_strFavoriteLocation := ""
f_strFavoriteLoginName := ""
f_strFavoritePassword := ""
f_strFavoriteShortName := ""
f_blnFavoriteElevate := ""
f_strHotkeyText := ""
f_strHotstringTrigger := ""
f_strHotstringOptions := ""
f_blnRadioSendModeMacro := ""
f_strFavoriteSnippetPrompt := ""
f_blnFavoriteFolderLive := ""
f_intFavoriteFolderLiveLevels := ""
f_blnFavoriteFolderLiveDocuments := ""
f_intFavoriteFolderLiveColumns := ""
f_radFavoriteFolderLiveInclude := ""
f_radFavoriteFolderLiveExclude := ""
f_strFavoriteFolderLiveExtensions := ""
objExternalMenu := ""
strItemSelectedName := ""
strGuiFavoriteLabel := ""
strQAPFeatureSelectedLocalizedName := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiAddFavoriteSaveValidate:
;------------------------------------------------------------

; validate original and destination menus values

if InStr("|GuiEditFavoriteSave|GuiMoveOneFavoriteSave", "|" . strThisLabel)
	strOriginalMenu := o_MenuInGui.AA.strMenuPath
else ; GuiAddFavoriteSave|GuiAddFavoriteSaveXpress|GuiCopyFavoriteSave|GuiCopyOneFavoriteSave|GuiAddExternalSave|
{
	strOriginalMenu := "" ; no change required in original menu
	if (strThisLabel <> "GuiCopyOneFavoriteSave") ; but keep original menu position for multiple copy
		g_intOriginalMenuPosition := 0
}

if (strThisLabel = "GuiAddExternalSave")
	strExternalMenuName := o_Settings.ReadIniValue("MenuName", " ", "Global", o_EditedFavorite.AA.strFavoriteAppWorkingDir) ; empty if not found

if InStr("GuiAddFavoriteSaveXpress|GuiAddExternalSave|", strThisLabel . "|")
{
	strNewFavoriteShortName := (StrLen(o_EditedFavorite.AA.strFavoriteName) ? o_EditedFavorite.AA.strFavoriteName : strExternalMenuName)
	strNewFavoriteLocation := o_EditedFavorite.AA.strFavoriteLocation
	strFavoriteAppWorkingDir := o_EditedFavorite.AA.strFavoriteAppWorkingDir ; for external menu from catalogue
	strNewFavoriteWindowPosition := g_strNewFavoriteWindowPosition
	
	if (strThisLabel = "GuiAddFavoriteSaveXpress")
	{
		; add new favorite in first or last position of menu where the XPress command was used
		strDestinationMenu := A_ThisMenu
		if !StrLen(strDestinationMenu) ; for GuiAddFavoriteSaveXpress favorite is added from context menu (no A_ThisMenu)
			strDestinationMenu := o_L["MainMenuName"]
		g_intNewItemPos := (o_Settings.SettingsWindow.blnAddAutoAtTop.IniValue ? 1 : g_objMenusIndex[strDestinationMenu].MaxIndex() + 1) ; 
	}
	else ; GuiAddExternalSave
	{
		; add new shared menu in current Main menu
		Gui, 1:Default
		Gui, 1:ListView, f_lvFavoritesList
		g_intNewItemPos := LV_GetNext()
		strDestinationMenu := o_MenuInGui.AA.strMenuPath
	}
}
else
{
	strNewFavoriteShortName := f_strFavoriteShortName
	strNewFavoriteLocation := f_strFavoriteLocation
	strFavoriteAppWorkingDir := f_strFavoriteAppWorkingDir
	strNewFavoriteSoundLocation := f_strFavoriteSoundLocation
	
	; f_drpParentMenu and f_drpParentMenuItems have same field name in 2 gui: GuiAddFavorite and GuiMoveMultipleFavoritesToMenu
	strDestinationMenu := f_drpParentMenu

	; if gui was closed from Live Folder Options tab (without changing tab), update Live folder icon
	if (o_EditedFavorite.AA.strFavoriteType = "Folder" and f_blnFavoriteFolderLive
		and g_strNewFavoriteIconResource = "iconFolder")
			g_strNewFavoriteIconResource := "iconFolderLive"
}

; now that we know original and destination menus, check if we need to lock them

if o_Containers.AA[strDestinationMenu].FavoriteIsUnderExternalMenu(o_ExternalMenu) and !o_ExternalMenu.ExternalMenuAvailableForLock(true) ; blnLockItForMe
; if the destination menu is an external menu that cannot be locked, user received an error message, then abort save
{
	g_blnAbortSave := true
	return
}
if StrLen(strOriginalMenu) and (strOriginalMenu <> strDestinationMenu)
	if o_Containers.AA[strOriginalMenu].FavoriteIsUnderExternalMenu(o_ExternalMenu) and !o_ExternalMenu.ExternalMenuAvailableForLock(true) ; blnLockItForMe
	; if the original menu changed by the save is an external menu that cannot be locked, user received an error message, then abort save
	{
		g_blnAbortSave := true
		return
	}

if (!g_intNewItemPos)
	; g_intNewItemPos may be already set if in GuiMoveOneFavoriteSave, GuiCopyOneFavoriteSave, GuiAddFavoriteSaveXpress, GuiAddExternalSave, 
	; GuiAddFavoriteFromQAPFeature or GuiAddFavoriteFromQAPFeatureFolder (and other types)
	if (f_drpParentMenuItems)
		g_intNewItemPos := f_drpParentMenuItems
	else ; if f_drpParentMenuItems is not set, add to the end of menu
		g_intNewItemPos := g_objMenusIndex[strDestinationMenu].MaxIndex()

; for these favorites, file/folder must exist

if InStr("Folder|Document|Application", o_EditedFavorite.AA.strFavoriteType)
	and StrLen(strNewFavoriteLocation) ; to exclude situations (like move) where strNewFavoriteLocation is empty
	and !RegExMatch(strNewFavoriteLocation, "i){(|CUR_|SEL_)(LOC|NAME|DIR|EXT|NOEXT|DRIVE|Clipboard)}") ; case insensitive
{
	strExpandedNewFavoriteLocation := strNewFavoriteLocation
	if !FileExistInPath(strExpandedNewFavoriteLocation)
	{
		OopsGui2(o_L["OopsFileNotFound"] . ":`n" . strExpandedNewFavoriteLocation
			. (strExpandedNewFavoriteLocation <> strNewFavoriteLocation ? "`n`n" . o_L["OopsFileExpandedFrom"] . ":`n" . strNewFavoriteLocation : ""))
		g_blnAbortSave := true
		return
	}
}

; validation to avoid unauthorized favorite types in groups
; validation to avoid external settings file under another external settings file

if (o_Containers.AA[strDestinationMenu].AA.strMenuType = "Group" and InStr("Menu|Group|External", o_EditedFavorite.AA.strFavoriteType, true))
	or (o_Containers.AA[strDestinationMenu].AA.strMenuType = "External" and o_EditedFavorite.AA.strFavoriteType = "External")
{
	if (o_Containers.AA[strDestinationMenu].AA.strMenuType = "Group")
		OopsGui2(o_L["DialogFavoriteNameNotAllowed"], StrReplace(o_Favorites.GetFavoriteTypeObject(o_EditedFavorite.AA.strFavoriteType).strFavoriteTypeLabel, "&", ""))
	else
		OopsGui2(o_L["OopsExternalNotAllowedUnderExternal"])
	if (strThisLabel = "GuiMoveOneFavoriteSave")
		g_intOriginalMenuPosition++
	g_blnAbortSave := true
	return
}

; validate External menu location and external menu type

if (o_EditedFavorite.AA.strFavoriteType = "External") and !InStr("|GuiEditFavoriteSave|GuiMoveOneFavoriteSave", "|" . strThisLabel)
{
	; make sure we have a file name
	SplitPath, strFavoriteAppWorkingDir, , , , strExternalFilenameNoExt
	if !StrLen(strExternalFilenameNoExt)
	{
		OopsGui2(o_L["DialogFavoriteLocationEmpty"])
		g_blnAbortSave := true
		return
	}
	
	; make sure the user selected the type of the new external menu
	if (f_radExternalMenuType1 + f_radExternalMenuType2 + f_radExternalMenuType3 = 0)
	{
		gosub, LoadExternalFileGlobalValues ; load values if file exists
		Gui, 2:Submit, NoHide
	}
	if (f_radExternalMenuType1 + f_radExternalMenuType2 + f_radExternalMenuType3 = 0)
	{
		OopsGui2(o_L["OopsExternalSelectType"])
		GuiControl, ChooseString, f_intAddFavoriteTab, % " " . o_L["DialogAddFavoriteTabsExternal"] ; space (only) before tab name
		g_blnExternalLocationChanged := 0 ; reset to 0, important to make sure the external file is created by GuiAddExternalSave
		g_blnAbortSave := true
		return
	}
}

; various validations (not required for GuiMoveOneFavoriteSave and GuiCopyOneFavoriteSave because info in o_EditedFavorite is not changed)

if !InStr("|GuiMoveOneFavoriteSave|GuiCopyOneFavoriteSave", "|" . strThisLabel)
{
	if !StrLen(strNewFavoriteShortName) and (o_EditedFavorite.AA.strFavoriteType <> "QAP")
	{
		OopsGui2(InStr("Menu|External", o_EditedFavorite.AA.strFavoriteType, true) ? o_L["DialogSubmenuNameEmpty"] : o_L["DialogFavoriteNameEmpty"])
		g_blnAbortSave := true
		return
	}

	if  InStr("|Folder|Document|Application|URL|FTP", "|" . o_EditedFavorite.AA.strFavoriteType) and !StrLen(strNewFavoriteLocation)
	{
		OopsGui2(o_L["DialogFavoriteLocationEmpty"])
		g_blnAbortSave := true
		return
	}

	if  (o_EditedFavorite.AA.strFavoriteType = "Snippet")
	{
		if InStr(f_strFavoriteSnippetPrompt, "|")
		{
			OopsGui2(o_L["DialogFavoriteSnippetPromptNoPipe"])
			g_blnAbortSave := true
			return
		}
		if !StrLen(strNewFavoriteLocation)
		{
			OopsGui2(o_L["DialogFavoriteSnippetEmpty"])
			g_blnAbortSave := true
			return
		}
		else
			; if content of gui is "display", encode it to make it ready for saving to ini file
			strNewFavoriteLocation := (g_strSnippetFormat = "display" ? EncodeSnippet(strNewFavoriteLocation) : strNewFavoriteLocation)
	}

	if (o_EditedFavorite.AA.strFavoriteType = "FTP" and SubStr(strNewFavoriteLocation, 1, 6) <> "ftp://")
	{
		OopsGui2(o_L["OopsFtpLocationProtocol"])
		g_blnAbortSave := true
		return
	}

	if  InStr("|Special|QAP", "|" . o_EditedFavorite.AA.strFavoriteType) and !StrLen(strNewFavoriteLocation)
	{
		OopsGui2(o_L["DialogFavoriteDropdownEmpty"], StrReplace(o_Favorites.GetFavoriteTypeObject(o_EditedFavorite.AA.strFavoriteType).strFavoriteTypeLabel, "&", "")
			, (o_EditedFavorite.AA.strFavoriteType = "Special" ? o_L["DialogDropDown"] : o_L["DialogTreeView"]))
		g_blnAbortSave := true
		return
	}

	if InStr("|Menu|Group|External", "|" . o_EditedFavorite.AA.strFavoriteType, true) and InStr(strNewFavoriteShortName, g_strMenuPathSeparator)
	{
		OopsGui2(L(o_L["DialogFavoriteNameNoSeparator"], g_strMenuPathSeparator))
		g_blnAbortSave := true
		return
	}

	if InStr(strNewFavoriteShortName, g_strGroupIndicatorPrefix)
	{
		OopsGui2(L(o_L["DialogFavoriteNameNoSeparator"], g_strGroupIndicatorPrefix))
		g_blnAbortSave := true
		return
	}

	if InStr(strNewFavoriteShortName, "& ") and !InStr(strNewFavoriteShortName, "&&")
		OopsGui2(o_L["OopsAmpersandInName"])
		; do not abort for this
	
	if InStr(g_strTypesForTabWindowOptions, "|" . o_EditedFavorite.AA.strFavoriteType) and (strThisLabel <> "GuiAddFavoriteSaveXpress")
	{
		strNewFavoriteWindowPosition := (f_blnUseDefaultWindowPosition ? 0 : 1)
		strNewFavoriteWindowPosition .= "," . (f_lblWindowPositionMinMax1 ? 0 : (f_lblWindowPositionMinMax2 ? 1 : -1))
			. "," . f_intWindowPositionX . "," . f_intWindowPositionY . "," . f_intWindowPositionW . "," . f_intWindowPositionH . "," . f_lblWindowPositionDelay
		
		GuiControlGet, intRadioGroupRestoreSide, , f_intRadioGroupRestoreSide
		if !(ErrorLevel) ; if errorlevel, control does not exist
			strNewFavoriteWindowPosition .= "," . (f_intRadioGroupRestoreSide = 1 ? "L" : "R")
		else
			strNewFavoriteWindowPosition .= "," . StrReplace(f_drpWindowMonitor, o_L["DialogWindowMonitor"] . " ", "")

		if !ValidateWindowPosition(strNewFavoriteWindowPosition)
		{
			OopsGui2(o_L["OopsInvalidWindowPosition"])
			g_blnAbortSave := true
			return
		}
	}

	if (o_EditedFavorite.AA.strFavoriteType = "External")
	{
		strExternalSettingsExtension := GetFileExtension(strFavoriteAppWorkingDir)

		if !StrLen(strExternalSettingsExtension)
			strFavoriteAppWorkingDir .= ".ini"
		else if (strExternalSettingsExtension <> "ini")
		{
			OopsGui2(o_L["DialogExternalLocationIni"])
			g_blnAbortSave := true
			return
		}
	}
	
	if LocationTransformedFromHTTP2UNC(o_EditedFavorite.AA.strFavoriteType, (o_EditedFavorite.AA.strFavoriteType = "External" ? strFavoriteAppWorkingDir : strNewFavoriteLocation))
		OopsGui2(o_L["OopsHttpLocationTransformed"], (o_EditedFavorite.AA.strFavoriteType = "External" ? strFavoriteAppWorkingDir : strNewFavoriteLocation))
		; do not abort

	if (strNewFavoriteLocation = "{TC Directory hotlist}" and !o_FileManagers.SA[3].TotalCommanderWinCmdIniFileExist())
	{
		OopsGui2(o_L["OopsInvalidWinCmdIni"])
		g_blnAbortSave := true
		return
	}
}

; avoid duplicate names when saving express

loop ; loop for duplicate names; if in Add this Folder Express or GuiAddExternalSave (from Catalogue), add " [!]" if name is not new.
	if !o_Containers.AA[strDestinationMenu].FavoriteNameIsNew(InStr("|GuiMoveOneFavoriteSave|GuiCopyOneFavoriteSave", "|" . strThisLabel) ? o_EditedFavorite.AA.strFavoriteName : strNewFavoriteShortName)
		and !o_EditedFavorite.IsSeparator() ; same name OK for separators
	{
		; we have the same name in the destination menu
		if (strOriginalMenu <> strDestinationMenu) ; the favorite was moved to new destination menu
			or (strThisLabel = "GuiCopyOneFavoriteSave") ; if same name in same menu to duplicate with multiple copy
			or (strNewFavoriteShortName <> o_EditedFavorite.AA.strFavoriteName) ; when the name has been edited from another menu
			or (strThisLabel = "GuiAddFavoriteSaveXpress") ; for new favorite having the same name
		{
			if InStr("GuiAddFavoriteSaveXpress|GuiAddExternalSave", strThisLabel . "|")
				and (o_EditedFavorite.AA.strFavoriteType <> "QAP")
				if InStr("|GuiMoveOneFavoriteSave|GuiCopyOneFavoriteSave", "|" . strThisLabel) ; #### not in effect now
					o_EditedFavorite.AA.strFavoriteName .= " [!]" ; and loop
				else
					strNewFavoriteShortName .= " [!]" ; and loop
			else
			{
				if (o_EditedFavorite.AA.strFavoriteType = "QAP")
					OopsGui2(o_L["DialogFavoriteNameNotNewQAPfeature"], (InStr("|GuiMoveOneFavoriteSave|GuiCopyOneFavoriteSave", "|" . strThisLabel) ? o_EditedFavorite.AA.strFavoriteName : strNewFavoriteShortName))
				else
					OopsGui2(o_L["DialogFavoriteNameNotNew"], (InStr("|GuiMoveOneFavoriteSave|GuiCopyOneFavoriteSave", "|" . strThisLabel) ? o_EditedFavorite.AA.strFavoriteName : strNewFavoriteShortName))
				if InStr("|GuiMoveOneFavoriteSave|GuiCopyOneFavoriteSave", "|" . strThisLabel) ; #### not in effect now
					g_intOriginalMenuPosition++
				if InStr("|GuiMoveOneFavoriteSave|GuiCopyOneFavoriteSave", "|" . strThisLabel)
					g_blnMulipleMoveOrCopyAborted := true
				g_blnAbortSave := true
				return
			}
		}
		else
			break ; name is not new but is OK - exit loop
	}
	else
		break ; name is new - exit loop

; check that a menu cannot be moved under itself when part of a multiple move (not when copy because menu cannot be copied)

if (strThisLabel = "GuiMoveOneFavoriteSave")
	and InStr("|Menu|External", "|" . o_EditedFavorite.AA.strFavoriteType)
	if (InStr(strDestinationMenu, strOriginalMenu . g_strMenuPathSeparatorWithSpaces . o_EditedFavorite.AA.strFavoriteName) = 1) ; = 1 to check if equal from start only
		and !o_EditedFavorite.IsSeparator() ; no risk with separators
	{
		OopsGui2(o_L["DialogMenuNotMoveUnderItself"], o_EditedFavorite.AA.strFavoriteName)
		g_intOriginalMenuPosition++ ; will be reduced by GuiMoveMultipleFavoritesSave
		g_blnAbortSave := true
		return
	}

return
;------------------------------------------------------------


;------------------------------------------------------------
ValidateWindowPosition(strPosition)
;------------------------------------------------------------
{
	; Boolean,MinMax,Left,Top,Width,Height,Delay,RestoreSide/Monitor
	; 0 for use default / 1 for remember, -1 Minimized / 0 Normal / 1 Maximized, Left (X), Top (Y), Width, Height, Delay (default 200 ms),
	; L Left / R Right / 1 primary monitor / 2 secondary monitor...; for example: "1,0,100,50,640,480,200" or "0,,,,,,,L"
	saPosition := StrSplit(strPosition, ",")
	if !(saPosition[1]) or (saPosition[2] <> 0) ; no position to validate
		return true
	
	if saPosition[3] is not integer
		blnOK := false
	else if saPosition[4] is not integer
		blnOK := false
	else if saPosition[5] is not integer
		blnOK := false
	else if saPosition[6] is not integer
		blnOK := false
	else if saPosition[7] is not integer
		blnOK := false
	; saPosition[8] can be letter or number
	else
		blnOK := true

	if (blnOK)
	 	blnOK := (saPosition[5] > 0) and (saPosition[6] > 0) and (saPosition[7] >= 0) ; Width, Height and Delay must be positive
	
	return blnOK
}
;------------------------------------------------------------


;========================================================================================================================
; END OF FAVORITE_GUI_SAVE
;========================================================================================================================


;========================================================================================================================
!_036_FAVORITE_GUI_OTHER:
;========================================================================================================================

;------------------------------------------------------------
GuiRemoveMultipleFavorites:
;------------------------------------------------------------

GuiControl, Focus, f_lvFavoritesList
Gui, 1:ListView, f_lvFavoritesList

if LV_GetCount("Selected") > 1
{
	MsgBox, 52, %g_strAppNameText%, % L(o_L["DialogRemoveMultipleFavorites"], LV_GetCount("Selected"))
	IfMsgBox, No
		return
}

Loop
	Gosub, GuiRemoveOneFavorite
until !LV_GetNext()

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiRemoveFavorite:
GuiRemoveOneFavorite:
;------------------------------------------------------------

g_blnFavoriteFromSearch := StrLen(GetFavoritesListFilter())
if (g_blnFavoriteFromSearch)
	o_MenuInGui := GetMenuForGuiFiltered(intItemToRemove)
else
{
	GuiControl, Focus, f_lvFavoritesList
	Gui, 1:ListView, f_lvFavoritesList
	intItemToRemove := LV_GetNext()
}

if !(intItemToRemove)
{
	Oops(o_L["DialogSelectItemToRemove"])
	gosub, GuiRemoveFavoriteCleanup
	return
}

if o_MenuInGui.FavoriteIsUnderExternalMenu(o_ExternalMenu) and !o_ExternalMenu.ExternalMenuAvailableForLock(true) ; blnLockItForMe
; if the menu is an external menu that cannot be locked, user received an error message, then abort
{
	if (A_ThisLabel = "GuiRemoveOneFavorite")
		LV_Modify(LV_GetNext(), "-Select")
	gosub, GuiRemoveFavoriteCleanup
	return
}

; remove favorite in object model (if menu, leaving submenu objects unlinked without releasing them)

blnItemIsMenu := o_MenuInGui.SA[intItemToRemove].IsContainer()

if (blnItemIsMenu)
{
	MsgBox, 52, % L(o_L["DialogFavoriteRemoveTitle"], g_strAppNameText)
		, % L((o_MenuInGui.SA[intItemToRemove].AA.strFavoriteType = "Menu" ? o_L["DialogFavoriteRemovePrompt"]
			: (o_MenuInGui.SA[intItemToRemove].AA.strFavoriteType = "External" ? o_L["DialogFavoriteRemoveExternalPrompt"]
			: o_L["DialogFavoriteRemoveGroupPrompt"])), o_MenuInGui.SA[intItemToRemove].AA.oSubmenu.AA.strMenuPath)
	IfMsgBox, No
	{
		if (A_ThisLabel = "GuiRemoveOneFavorite")
			LV_Modify(LV_GetNext(), "-Select")
		gosub, GuiRemoveFavoriteCleanup
		return
	}
	o_Containers.AA.Delete(o_MenuInGui.SA[intItemToRemove].AA.oSubmenu.AA.strMenuPath) ; if user cancels settings changes, menu object will not be re-created (we live with it)
}

o_EditedFavorite := o_MenuInGui.SA[intItemToRemove] ; for UpdateFavoriteObjectSaveShortcut
g_strNewFavoriteShortcut := "" ; for UpdateFavoriteObjectSaveShortcut
Gosub, UpdateFavoriteObjectSaveShortcut

o_MenuInGui.SA.RemoveAt(intItemToRemove)

; refresh menu dropdpown in gui

if (blnItemIsMenu)
	GuiControl, 1:, f_drpMenusList, % "|" . o_MainMenu.BuildMenuListDropDown(o_MenuInGui.AA.strMenuPath) . "|"

LV_Delete(intItemToRemove)
if (A_ThisLabel = "GuiRemoveFavorite")
{
	LV_Modify(intItemToRemove, "Select Focus") ; select item next to deleted one
	if !LV_GetNext() ; if last item was deleted, select the new last item
		LV_Modify(LV_GetCount(), "Select Focus")
}
Gosub, AdjustColumnsWidth

Gosub, EnableSaveAndCancel

; if favorite's menu is in an external settings file, flag that it needs to be saved
if o_MenuInGui.FavoriteIsUnderExternalMenu(o_ExternalMenu)
	o_ExternalMenu.AA.blnNeedSave := true

if (g_blnFavoriteFromSearch)
	gosub, LoadFavoritesInGuiFiltered ; stay in filtered list after item removed


GuiRemoveFavoriteCleanup:
intItemToRemove := ""
blnItemIsMenu := ""
objExternalMenu := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiMoveMultipleFavoritesUp:
GuiMoveMultipleFavoritesDown:
;------------------------------------------------------------

GuiControl, Focus, f_lvFavoritesList
Gui, 1:ListView, f_lvFavoritesList

Gosub, GetSelectedRows

Loop
{
	Gosub, % (A_ThisLabel = "GuiMoveMultipleFavoritesUp" ? "GetFirstSelected" : "GetLastSelected") ; will re-init g_intRowToProcess
	if (!g_intRowToProcess) or (g_blnAbortMultipleMove)
		break
	
	g_intSelectedRow := g_intRowToProcess
	Gosub, % (A_ThisLabel = "GuiMoveMultipleFavoritesUp" ? "GuiMoveOneFavoriteUp" : "GuiMoveOneFavoriteDown")
}

if (!g_blnAbortMultipleMove)
	Loop, Parse, strSelectedRows, |
		LV_Modify(A_LoopField  + (A_ThisLabel = "GuiMoveMultipleFavoritesUp" ? -1 : 1), "Select")

LV_Modify(LV_GetNext(0), "Focus") ; give focus to the first selected row

g_blnAbortMultipleMove := ""
strSelectedRows := ""
g_intRowToProcess := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiMoveFavoriteUp:
GuiMoveFavoriteDown:
GuiMoveOneFavoriteUp:
GuiMoveOneFavoriteDown:
;------------------------------------------------------------

if o_MenuInGui.FavoriteIsUnderExternalMenu(o_ExternalMenu) and !o_ExternalMenu.ExternalMenuAvailableForLock(true) ; blnLockItForMe
{
	o_ExternalMenu := ""
	return
}

if !InStr(A_ThisLabel, "One")
{
	GuiControl, Focus, f_lvFavoritesList
	Gui, 1:ListView, f_lvFavoritesList
	g_intSelectedRow := LV_GetNext()
}
if (g_intSelectedRow = 0)
{
	Oops(o_L["DialogSelectItemToMove"])
	return
}
if (g_intSelectedRow = (InStr(A_ThisLabel, "Up") ? 1 : LV_GetCount())) ; if first or last item
{
	if InStr(A_ThisLabel, "One")
		g_blnAbortMultipleMove := true
	return
}

; --- move in menu object ---

o_MenuInGui.MoveFavorite(g_intSelectedRow, (InStr(A_ThisLabel, "Up") ? -1 : 1))

; --- move in Gui ---

saThisRow := Object()
Loop, 4
{
	LV_GetText(strThisPos, g_intSelectedRow, A_Index)
	saThisRow[A_Index] := strThisPos
}

saOtherRow := Object()
Loop, 4
{
	LV_GetText(strThisPos, g_intSelectedRow + (InStr(A_ThisLabel, "Up") ? -1 : 1), A_Index)
	saOtherRow[A_Index] := strThisPos
}

LV_Modify(g_intSelectedRow, "-Select")
LV_Modify(g_intSelectedRow, "", saOtherRow[1], saOtherRow[2], saOtherRow[3], saOtherRow[4])
LV_Modify(g_intSelectedRow + (InStr(A_ThisLabel, "Up") ? -1 : 1), , saThisRow[1], saThisRow[2], saThisRow[3], saThisRow[4])

if !InStr(A_ThisLabel, "One")
	LV_Modify(g_intSelectedRow + (InStr(A_ThisLabel, "Up") ? -1 : 1), "Select Focus Vis")

Gosub, EnableSaveAndCancel

; if favorite's menu is in an external settings file, flag that it needs to be saved
if o_MenuInGui.FavoriteIsUnderExternalMenu(o_ExternalMenu) ; LATER
	o_ExternalMenu.AA.blnNeedSave := true ; fix add .AA ?

objExternalMenu := ""
saThisRow := ""
saOtherRow := ""
strThisPos := ""

return

;------------------------------------------------------------


;------------------------------------------------------------
GuiSortFavorites:
;------------------------------------------------------------

if o_MenuInGui.FavoriteIsUnderExternalMenu(o_ExternalMenu) and !o_ExternalMenu.ExternalMenuAvailableForLock(true) ; blnLockItForMe
{
	o_ExternalMenu := ""
	return
}

GuiControl, Focus, f_lvFavoritesList
Gui, 1:ListView, f_lvFavoritesList

intFirstSelectedRow := LV_GetNext(0)

if (LV_GetCount("Selected") <= 1) ; if one or no row is selected, select all and sort until the first separator
	LV_Modify(0, "Select") ; select all rows
	
Gosub, GetSelectedRows ; updated strSelectedRows (pipe delimited list of selected row numbers)
saSelectedRows := StrSplit(strSelectedRows, "|")

aaNewOrder := Object() ; associative array of Item objects to be sorted by favorite names

intRowsToSort := 0 ; counter, sort only if at least 2 rows to sort
strSortedRows := "" ; keep track of sorted rows to re-select only these rows

Loop, Parse, strSelectedRows, |
{
	if o_MenuInGui.SA[A_LoopField].IsSeparator() ; stop at first separator
	{
		blnSeparatorFound := true
		break
	}
	intRowsToSort++
	strSortedRows .= saSelectedRows[A_Index] . "|"
	aaNewOrder[GuiSortCleanFavoriteName(o_MenuInGui.SA[A_LoopField].AA.strFavoriteName)] := o_MenuInGui.SA[A_LoopField] ; add object of favorite to sort
}
strSortedRows := SubStr(strSortedRows, 1, -1) ; trim last char

if (intRowsToSort > 1) ; sort only if required
{
	for strThisName, o_Item in aaNewOrder
		; replace gui menu objects to sort with favorites object sorted
		o_MenuInGui.SA[saSelectedRows[A_Index]] := o_Item

	gosub, LoadMenuInGui ; refresh menu in gui
	
	LV_Modify(0, "-Select") ; deselect all
	Loop, Parse, strSortedRows, |
		LV_Modify(A_LoopField, "Select") ; select only sorted rows
	LV_Modify(LV_GetNext(0), "Focus Vis") ; give focus to the first sorted row and make it visible

	Gosub, EnableSaveAndCancel

	; if favorite's menu is in an external settings file, flag that it needs to be saved
	if o_MenuInGui.FavoriteIsUnderExternalMenu(o_ExternalMenu)
		o_ExternalMenu.AA.blnNeedSave := true
}
else
{
	LV_Modify(0, "-Select") ; deselect all
	LV_Modify((intFirstSelectedRow ? intFirstSelectedRow : 1), "Select") ; re-select first selected
}

if (blnSeparatorFound)
	Oops(o_L["OopsSortUpToSeparator"])

intFirstSelectedRow := ""
objExternalMenu := ""
strSelectedRows := ""
saSelectedRows := ""
intSelected := ""
aaNewOrder := ""
intRowsToSort := ""
strSortedRows := ""
strThisName := ""
o_Item := ""
blnSeparatorFound := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiSortCleanFavoriteName(strFavoriteName)
;------------------------------------------------------------
{
	if InStr(strFavoriteName, "&")
	{
		strFavoriteName := StrReplace(strFavoriteName, "&", "")
		strFavoriteName .= "-" . RandomBetween() ; add random number in case another favorite has the same name without the ampersand)
	}
	return strFavoriteName
}
;------------------------------------------------------------


;------------------------------------------------------------
GetFirstSelected:
GetLastSelected:
;------------------------------------------------------------

g_intRowToProcess := 0

if (A_ThisLabel = "GetFirstSelected")
	g_intRowToProcess := LV_GetNext(g_intRowToProcess) ; start from first selected
else
	loop
		g_intRowToProcess := LV_GetNext(g_intRowToProcess) ; start with last selected
	until !LV_GetNext(g_intRowToProcess)

return
;------------------------------------------------------------


;------------------------------------------------------------
GetSelectedRows:
;------------------------------------------------------------

strSelectedRows := ""
g_intRowToProcess := 0
loop
{
	g_intRowToProcess := LV_GetNext(g_intRowToProcess)
	strSelectedRows .= g_intRowToProcess . "|"
}
until !LV_GetNext(g_intRowToProcess)
strSelectedRows := SubStr(strSelectedRows, 1, -1) ; remove last |

return
;------------------------------------------------------------


;============================================================
GuiHotkeysManage:
GuiHotkeysManageFromQAPFeature:
GuiHotkeysManageHotstrings:
GuiHotkeysManageHotstringsFromQAPFeature:
;------------------------------------------------------------

if InStr(A_ThisLabel, "FromQAPFeature")
	Gosub, GuiShowFromHotkeysManage
	
intWidth := 980

g_intGui1WinID := WinExist("A")
Gui, 1:Submit, NoHide

strGuiTitle := L(o_L["DialogHotkeysManageTitle"], g_strAppNameText, g_strAppVersion)
Gui, 2:New, +Hwndg_strGui2Hwnd, %strGuiTitle%
Gui, 2:+Owner1
Gui, 2:+OwnDialogs
if (g_blnUseColors)
	Gui, 2:Color, %g_strGuiWindowColor%

saShortcutsHotstrings := [o_L["DialogShortcuts"], o_L["DialogHotstrings"]]
saShortcutHotstringLower := StrSplit(o_L["DialogHotkeysManageShortcutHotstringLower"], "|")
saHotkeysHeader := [L(o_L["DialogHotkeysManageListHeader"], saShortcutsHotstrings[1])
	, L(o_L["DialogHotkeysManageListHeader"], o_L["DialogHotkeysManageListHeaderHotstrings"])]
saHotkeysUrl := ["https://www.quickaccesspopup.com/can-i-launch-my-favorites-with-keyboard-or-mouse-shortcuts/"
	, "https://www.quickaccesspopup.com/what-are-hotstrings/"]

Gui, 2:Add, Tab2, % "w" . intWidth + 20 . " h460 vf_HotkeysTab AltSubmit", % saShortcutsHotstrings[1] . "|" . saShortcutsHotstrings[2]

Loop, 2 ; create Listviews tabs Shortcuts and Hotstrings
{
	Gui, 2:Tab, %A_Index%
	Gui, 2:Font, w600
	Gui, 2:Add, Text, x20 y40, % L((A_Index = 1 ? o_L["DialogHotkeysManageAboutShortcuts"] : o_L["DialogHotkeysManageAboutHotstrings"]), g_strAppNameText)
	Gui, 2:Font
	Gui, 2:Add, Link, x+5 yp, % "(<a href=""" . saHotkeysUrl[A_Index] . """>" . o_L["GuiHelp"] . "</a>)"
	Gui, 2:Add, Text, x20 y+10 w%intWidth%, % L(o_L["DialogHotkeysManageIntro"], saShortcutHotstringLower[A_Index])

	; 1 -> #|Menu|Favorite Name|Type|Shortcuts|Favorite Location|Object Position (hidden)
	; 2 -> #|Menu|Favorite Name|Type|Trigger|Options|Favorite Location|Object Position (hidden)
	Gui, 2:Add, Listview
		, % "vf_lvHotkeysManageList" . A_Index . " Count32 " . (g_blnUseColors ? "c" . g_strGuiListviewTextColor . " Background" . g_strGuiListviewBackgroundColor : "") 
		. " gHotkeysManageListEvents x20 y+10 w" . intWidth - 0. " h340"
		, % "#|" . saHotkeysHeader[A_Index] . "|Object Position (hidden)"
}
Gui, 2:Tab

Gui, 2:Add, Checkbox, vf_blnSeeAllFavorites gCheckboxSeeAllFavoritesClicked, % o_L["DialogHotkeysManageListSeeAllFavorites"]
Gui, 2:Add, Checkbox, x+50 yp vf_blnSeeShortHotkeyNames gCheckboxSeeShortHotkeyNames, % o_L["DialogHotkeysManageListSeeShortHotkeyNames"]
GuiControl, , f_blnSeeShortHotkeyNames, % (o_Settings.Menu.intHotkeyReminders.IniValue = 2) ; 1 = no name, 2 = short names, 3 = full name

Gosub, HotkeysManageListLoad

Gui, 2:Tab
Gui, 2:Add, Button, x+10 y+30 vf_btnHotkeysManageClose gGuiHotkeysManageClose h33 Default, % o_L["GuiClose"]
GuiCenterButtons(strGuiTitle, , , , "f_btnHotkeysManageClose")
GuiControl, Focus, f_btnHotkeysManageClose
Gui, 2:Add, Text, x10, %A_Space%

if InStr(A_ThisLabel, "Hotstrings")
	GuiControl, Choose, f_HotkeysTab, 2

Gosub, ShowGui2AndDisableGui1

intWidth := ""
strGuiTitle := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
HotkeysManageListEvents:
; 1 Shortcuts -> #|Menu|Favorite Name|Type|Shortcuts|Favorite Location|Object Position (hidden)
; 2 Hotstrings -> #|Menu|Favorite Name|Type|Trigger|Options|Favorite Location|Object Position (hidden)
;------------------------------------------------------------

Gui, 2:ListView, f_lvHotkeysList

if (A_GuiEvent = "DoubleClick")
{
	GuiControlGet, intActiveTab, , f_HotkeysTab
	Gui, 2:ListView, f_lvHotkeysManageList%intActiveTab%
	
	intItemPosition := LV_GetNext()
	LV_GetText(strHotkeyType, intItemPosition, 4)
	if !StrLen(strHotkeyType)
	{
		gosub, HotkeysManageListEventsCleanup
		return
	}
	
	LV_GetText(strMenuPath, intItemPosition, 2)
	LV_GetText(strFavoritePosition, intItemPosition, LV_GetCount("Column"))
	LV_GetText(strMenuPath, intItemPosition, 2)
	
	o_EditedFavorite := o_Containers.AA[strMenuPath].SA[strFavoritePosition]
	
	if (intActiveTab = 1) ; Shortcut
		if (strHotkeyType = o_L["DialogHotkeysManagePopup"]) ; this is a popup menu hotkey, go to Options, Menu hotkeys
		{
			MsgBox, 35, %g_strAppNameText%!, % L(o_L["DialogChangeHotkeyPopup"], o_L["OptionsMouseAndKeyboard"], o_L["GuiOptions"])
			IfMsgBox, Yes
				Gosub, GuiOptionsGroupPopupHotkeys
		}
		else if (strHotkeyType = o_L["DialogHotkeysManageAlternative"]) ; this is Alternative menu feature, go to Options, Menu hotkeys
		{
			MsgBox, 35, %g_strAppNameText%!, % L(o_L["DialogChangeHotkeyAlternative"], o_L["OptionsAlternativeMenuFeatures"], o_L["GuiOptions"])
			IfMsgBox, Yes
				Gosub, GuiOptionsGroupPopupHotkeysAlternative
		}
		else
		{
			g_strNewFavoriteShortcut := SelectShortcut(o_EditedFavorite.AA.strFavoriteShortcut
				, o_EditedFavorite.AA.strFavoriteName
				, o_EditedFavorite.AA.strFavoriteType
				, o_EditedFavorite.AA.strFavoriteLocation, 3
				, o_QAPfeatures.AA[o_EditedFavorite.AA.strFavoriteLocation].strDefaultShortcut)
			; SelectShortcut returns the new shortcut, "None" if no shortcut or empty string if cancelled
			if !StrLen(g_strNewFavoriteShortcut)
				g_strNewFavoriteShortcut := o_EditedFavorite.AA.strFavoriteShortcut
			
			Gosub, UpdateFavoriteObjectSaveShortcutList ; updates o_EditedFavorite.AA.strFavoriteShortcut with g_strNewFavoriteShortcut and enable Settings save/Cancel buttons
		}
	else ; Hotstring
	{
		g_strNewFavoriteHotstring := SelectHotstring(o_EditedFavorite.AA.strFavoriteHotstring
			, o_EditedFavorite.AA.strFavoriteName
			, o_EditedFavorite.AA.strFavoriteType
			, o_EditedFavorite.AA.strFavoriteLocation)
		; SelectHotstring returns the new hotstring (AHK format ":options:trigger"), empty string if no trigger or existing hotstring if cancelled
		
		Gosub, UpdateFavoriteObjectSaveHotstringList ; updates o_EditedFavorite.AA.strFavoriteHotstring with g_strNewFavoriteHotstring and enable Settings save/Cancel buttons
	}
}

HotkeysManageListEventsCleanup:
intActiveTab := ""
intItemPosition := ""
strHotkeyType := ""
strMenuPath := ""
strFavoritePosition := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
HotkeysManageListLoad:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

Gui, 2:Default
Gui, 2:ListView, f_lvHotkeysManageList
LV_Delete()

intHotkeysManageListWinID := WinExist("A")
if not DllCall("LockWindowUpdate", Uint, intHotkeysManageListWinID)
	Oops("An error occured while locking window display in`n" . L(o_L["DialogHotkeysManageTitle"], g_strAppNameText, g_strAppVersion))

Loop, 2
{
	Gui, 2:ListView, f_lvHotkeysManageList%A_Index%
	LV_Delete()

	if (A_Index = 1) ; for shortcuts (1) only
	{
		; #|Menu|Favorite Name|Type|Shortcuts|Favorite Location|Object Position (hidden)
		loop, 4 ; load popup menu triggers, use loop 4 (not for ... in) to keep the 1-4 order
			LV_Add(, , o_L["DialogNA"], o_PopupHotkeys.SA[A_Index].AA.strPopupHotkeyLocalizedName, o_L["DialogHotkeysManagePopup"], (f_blnSeeShortHotkeyNames ? o_PopupHotkeys.SA[A_Index].P_strAhkHotkey
				: o_PopupHotkeys.SA[A_Index].AA.strPopupHotkeyText), o_L["DialogNA"])

		for strQAPFeatureCode in o_QAPfeatures.aaQAPFeaturesDefaultNameByCode ; load Alternative menu QAP Features shortcuts
			if (o_QAPfeatures.AA[strQAPFeatureCode].intQAPFeatureAlternativeOrder)
				if HasShortcut(o_QAPfeatures.AA[strQAPFeatureCode].strCurrentHotkey) or f_blnSeeAllFavorites
					LV_Add(, , o_L["DialogHotkeysManageAlternativeMenu"], o_QAPfeatures.AA[strQAPFeatureCode].strLocalizedName, o_L["DialogHotkeysManageAlternative"]
						, new Triggers.HotkeyParts(o_QAPfeatures.AA[strQAPFeatureCode].strCurrentHotkey).Hotkey2Text(), strQAPFeatureCode)
	}
	
	o_MainMenu.LoadMenuHotkeysToManageList(A_Index, f_blnSeeAllFavorites, f_blnSeeShortHotkeyNames) ; load favorite shortcuts (1) and hotstrings (2)

	LV_ModifyCol(1, "Integer Sort")
	Loop, % LV_GetCount("Column") - 1
		LV_ModifyCol(A_Index + 1, "AutoHdr")
	LV_ModifyCol(LV_GetCount("Column"), 0) ; last column Object Position (hidden)
}

DllCall("LockWindowUpdate", Uint, 0)  ; Pass 0 to unlock the currently locked window.

intHotkeysManageListWinID := ""
strQAPFeatureCode := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
CheckboxSeeAllFavoritesClicked:
CheckboxSeeShortHotkeyNames:
;------------------------------------------------------------

Gosub, HotkeysManageListLoad

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiHotkeysManageClose:
;------------------------------------------------------------

gosub, 2GuiClose
gosub, LoadMenuInGuiFromHotkeysManage

return
;------------------------------------------------------------


;============================================================
GuiIconsManage:
GuiIconsManageFromQAPFeature:
;------------------------------------------------------------

if (A_ThisLabel = "GuiIconsManageFromQAPFeature")
	Gosub, GuiShowFromIconsManage

global g_saManageIcons := Object() ; was g_objManageIcons
o_MainMenu.LoadMenuIconsManage()

g_intGui1WinID := WinExist("A")
Gui, 1:Submit, NoHide

intIconsManageRowsHeight := 44
if !(o_Settings.MenuIcons.intIconsManageRowsSettings.IniValue)
{
	ActiveMonitorInfo(intTop, intLeft, intWidth, intMonitorHeight)
	g_intIconsManageRows := ((intMonitorHeight - 250) // intIconsManageRowsHeight)
}
else
	g_intIconsManageRows:= o_Settings.MenuIcons.intIconsManageRowsSettings.IniValue

intMarginWidth := 10
intIconSize := 32
intMenuPathWidth := 400
intFavoriteNameWidth := 300
intButtonsHeight := 20
intButtonsWidth := 150

strGuiTitle := L(o_L["DialogIconsManageTitle"], g_strAppNameText, g_strAppVersion)
Gui, 2:New, +Hwndg_strGui2Hwnd, %strGuiTitle%
Gui, 2:+Owner1
Gui, 2:+OwnDialogs
if (g_blnUseColors)
	Gui, 2:Color, %g_strGuiWindowColor%

Gui, 2:Add, Text, x10 y10 w1000, % L(o_L["DialogIconsManageAbout"], g_strAppNameText)

Gui, 2:Font, w600
Gui, 2:Add, Edit, % "readonly center x" . intMarginWidth . " w" . intMenuPathWidth, % o_L["DialogIconsManageParentMenu"]
Gui, 2:Add, Edit, % "readonly center yp x+" . intMarginWidth . " w" . intFavoriteNameWidth, % o_L["DialogIconsManageFavoriteName"]
Gui, 2:Add, Edit, % "readonly center yp x+" . intMarginWidth . " w" . intButtonsWidth + intIconSize + (intMarginWidth // 2), % o_L["DialogIconsManageCurrent"]
Gui, 2:Add, Edit, % "readonly center yp x+" . intMarginWidth . " w" . intButtonsWidth + intIconSize + (intMarginWidth // 2), % o_L["DialogIconsManageDefault"]
Gui, 2:Font

Loop, %g_intIconsManageRows%
{
	Gui, 2:Font, w600
	Gui, 2:Add, Edit, % "readonly -vscroll x" . intMarginWidth . " y" . 15 + (A_Index * intIconsManageRowsHeight) . " w" . intMenuPathWidth . " h" . intIconsManageRowsHeight - 5 . " vf_lblMenuPath" . A_Index
	Gui, 2:Font
	Gui, 2:Add, Edit, % "readonly -vscroll yp x+" . intMarginWidth . " w" . intFavoriteNameWidth . " h" . intIconsManageRowsHeight - 5 . " vf_lblFavoriteName" . A_Index
	Gui, 2:Add, Picture, % "yp x+" . intMarginWidth . " w" . intIconSize . " h" . intIconSize . " gIconsManagePickIconDialog vf_picIconCurrent" . A_Index
	Gui, 2:Add, Button, % "yp+7 x+" . intMarginWidth // 2 . " h" . intButtonsHeight . " w" . intButtonsWidth . " gIconsManagePickIconDialog vf_btnPickDialog" . A_Index, % o_L["DialogSelectIcon"]
	Gui, 2:Add, Picture, % "yp-7 x+" . intMarginWidth . " w" . intIconSize . " h" . intIconSize . " gIconsManageSetDefault vf_picIconDefault" . A_Index
	Gui, 2:Add, Button, % "yp+7 x+" . intMarginWidth // 2 . " h" . intButtonsHeight . " w" . intButtonsWidth . " gIconsManageSetDefault vf_btnSetDefault" . A_Index, % o_L["DialogIconsManageSetDefaultIcon"]
}

aaL := o_L.InsertAmpersand(false, "DialogIconsManagePrevious", "DialogIconsManageNext", "GuiClose") 

Gui, 2:Add, Button, x10 y+25 vf_btnIconsManagePrev gLoadIconsManageListPrev h20, % aaL["DialogIconsManagePrevious"]
Gui, 2:Add, Button, x10 yp vf_btnIconsManageNext gLoadIconsManageListNext, % aaL["DialogIconsManageNext"]
Gui, 2:Add, Button, x10 yp vf_btnIconsManageClose g2GuiClose, % aaL["GuiClose"]
Gui, 2:Add, Text, x10, %A_Space%

Gosub, LoadIconsManageList

; GuiCenterButtons(strWindow, intInsideHorizontalMargin := 10, intInsideVerticalMargin := 0, intDistanceBetweenButtons := 20, arrControls*)
GuiCenterButtons(strGuiTitle, 20, 10, 40, "f_btnIconsManagePrev", "f_btnIconsManageNext", "f_btnIconsManageClose")
Gosub, ShowGui2AndDisableGui1

intTop := ""
intLeft := ""
intWidth := ""
intMonitorHeight := ""
intIconsManageRowsHeight := ""
intMarginWidth := ""
intIconSize := ""
intCurrentWidth := ""
intDefaultWidth := ""
intMenuPathWidth := ""
intFavoriteNameWidth := ""
intButtonsWidth := ""
intButtonsHeight := ""
strGuiTitle := ""
aaL := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
LoadIconsManageList:
LoadIconsManageListPrev:
LoadIconsManageListNext:
;------------------------------------------------------------

intIconsManageListWinID := WinExist("A")
if not DllCall("LockWindowUpdate", Uint, intIconsManageListWinID)
	Oops("An error occured while locking window display in`n" . L(o_L["DialogIconsManageTitle"], g_strAppNameText, g_strAppVersion))

if (A_ThisLabel = "LoadIconsManageListNext")
	g_intIconsManageStartingRow += g_intIconsManageRows
else if (A_ThisLabel = "LoadIconsManageListPrev")
	g_intIconsManageStartingRow -= g_intIconsManageRows
else ; LoadIconsManageList
	g_intIconsManageStartingRow := 1

Loop, %g_intIconsManageRows%
{
	intThisItemInMenu := A_Index + g_intIconsManageStartingRow - 1
	
	strShowHide := (intThisItemInMenu <= g_saManageIcons.MaxIndex() ? "Show" : "Hide")
	GuiControl, %strShowHide%, f_picIconCurrent%A_Index%
	GuiControl, %strShowHide%, f_btnPickDialog%A_Index%
	GuiControl, %strShowHide%, f_picIconDefault%A_Index%
	GuiControl, %strShowHide%, f_btnSetDefault%A_Index%
	GuiControl, %strShowHide%, f_lblFavoriteName%A_Index%
	GuiControl, %strShowHide%, f_lblMenuPath%A_Index%
	
	if !StrLen(g_saManageIcons[intThisItemInMenu].AA.strFavoriteIconResource) ; for safety
		g_saManageIcons[intThisItemInMenu].AA.strFavoriteIconResource := g_saManageIcons[intThisItemInMenu].GetDefaultIcon4Type(oItem.AA.strFavoriteLocation)
	ParseIconResource(g_saManageIcons[intThisItemInMenu].AA.strFavoriteIconResource, strInconFile, intIconIndex, "iconFolder") ; only folder favorite may need the default icon
	GuiControl, , f_picIconCurrent%A_Index%, % "*icon" . intIconIndex . " " . strInconFile
	ParseIconResource(g_saManageIcons[intThisItemInMenu].GetDefaultIcon4Type(oItem.AA.strFavoriteLocation), strInconFile, intIconIndex)
	GuiControl, , f_picIconDefault%A_Index%, % "*icon" . intIconIndex . " " . strInconFile
	strShowHide := (A_Index = 1 or (g_saManageIcons[intThisItemInMenu].AA.oParentMenu.AA.strMenuPath <> strPreviousMenuPath
		and intThisItemInMenu <= g_saManageIcons.MaxIndex()) ? "Show" : "Hide")
	GuiControl, %strShowHide%, f_lblMenuPath%A_Index%

	GuiControl, , f_lblFavoriteName%A_Index%, % g_saManageIcons[intThisItemInMenu].AA.strFavoriteName
	GuiControl, , f_lblMenuPath%A_Index%, % g_saManageIcons[intThisItemInMenu].AA.oParentMenu.AA.strMenuPath
	strPreviousMenuPath := g_saManageIcons[intThisItemInMenu].AA.oParentMenu.AA.strMenuPath
}

GuiControl, % ((g_intIconsManageStartingRow + g_intIconsManageRows) < g_saManageIcons.MaxIndex() ? "Enable" : "Disable"), f_btnIconsManageNext
GuiControl, % (g_intIconsManageStartingRow > 1 ? "Enable" : "Disable"), f_btnIconsManagePrev
GuiControl, Focus, f_btnIconsManageClose

DllCall("LockWindowUpdate", Uint, 0)  ; Pass 0 to unlock the currently locked window.

intIconsManageListWinID := ""
strShowHide := ""
intThisItemInMenu := ""
strInconFile := ""
intIconIndex := ""
strPreviousMenuPath := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
IconsManagePickIconDialog:
IconsManageSetDefault:
;------------------------------------------------------------

intIconRow := StrReplace(A_GuiControl, "f_picIconCurrent")
intIconRow := StrReplace(intIconRow, "f_picIconDefault")
intIconRow := StrReplace(intIconRow, "f_btnPickDialog")
intIconRow := StrReplace(intIconRow, "f_btnSetDefault")
intManageIconsIndex := g_intIconsManageStartingRow + intIconRow - 1

strIconResource := (A_ThisLabel = "IconsManagePickIconDialog"
	? PickIconDialog(g_saManageIcons[intManageIconsIndex].AA.strFavoriteIconResource) 
	: g_saManageIcons[intManageIconsIndex].GetDefaultIcon4Type(oItem.AA.strFavoriteLocation))
ParseIconResource(strIconResource, strInconFile, intIconIndex)
GuiControl, , f_picIconCurrent%intIconRow%, % "*icon" . intIconIndex . " " . strInconFile

if (g_saManageIcons[intManageIconsIndex].AA.strFavoriteIconResource <> strIconResource)
{
	if g_saManageIcons[intManageIconsIndex].AA.oParentMenu.FavoriteIsUnderExternalMenu(o_ExternalMenu)
		if !o_ExternalMenu.ExternalMenuAvailableForLock()
			; this favorite could not be edited because it is in an external menu locked by another user,
			; or because external settings file is in a read-only folder, or because external files was modified 
			; by another user since it was loaded in QAP by this user
			goto, IconsManagePickIconDialogCleanup
		else ; flag that this external menu needs to be saved
			o_ExternalMenu.AA.blnNeedSave := true ; fix add .AA ?
	; else continue

	; save new icon in item
	g_saManageIcons[intManageIconsIndex].AA.strFavoriteIconResource := strIconResource
	
	Gosub, EnableSaveAndCancel
}

IconsManagePickIconDialogCleanup:
intIconRow := ""
strIconResource := ""
objExternalMenu := ""

return
;------------------------------------------------------------


;============================================================
GuiAddSeparator:
GuiAddColumnBreak:
;------------------------------------------------------------

if o_MenuInGui.FavoriteIsUnderExternalMenu(o_ExternalMenu) and !o_ExternalMenu.ExternalMenuAvailableForLock(true) ; blnLockItForMe
; if the menu is an external menu that cannot be locked, user received an error message, then abort
	return

GuiControl, Focus, f_lvFavoritesList
Gui, 1:ListView, f_lvFavoritesList

if (LV_GetCount("Selected") > 1)
	return

intInsertPosition := LV_GetCount() ? (LV_GetNext() ? LV_GetNext() : LV_GetCount() + 1) : 1

; --- add in menu object ---
o_MenuInGui.SA.InsertAt(intInsertPosition, new Container.Item([(A_ThisLabel = "GuiAddSeparator" ? "X" : "K")]))

; --- add in Gui ---

LV_Modify(0, "-Select")

if (A_ThisLabel = "GuiAddSeparator")
	LV_Insert(intInsertPosition, "Select Focus", g_strGuiMenuSeparator, g_strGuiMenuSeparatorShort, g_strGuiMenuSeparatorShort, g_strGuiMenuSeparator . g_strGuiMenuSeparator)
else ; GuiAddColumnBreak
	LV_Insert(intInsertPosition, "Select Focus", g_strGuiDoubleLine . " " . o_L["MenuColumnBreak"] . " " . g_strGuiDoubleLine
		, g_strGuiDoubleLine, g_strGuiDoubleLine, g_strGuiDoubleLine . " " . o_L["MenuColumnBreak"] . " " . g_strGuiDoubleLine)

LV_Modify(LV_GetNext(), "Vis")
Gosub, AdjustColumnsWidth

Gosub, EnableSaveAndCancel

; if favorite's menu is in an external settings file, flag that it needs to be saved
if o_MenuInGui.FavoriteIsUnderExternalMenu(o_ExternalMenu)
	o_ExternalMenu.AA.blnNeedSave := true ; fix add .AA ?

intInsertPosition := ""
objNewFavorite := ""
o_ExternalMenu := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiAddTextSeparator:
;------------------------------------------------------------
Gui, 1:Submit, NoHide

Gui, 1:ListView, f_lvFavoritesList
g_intOriginalMenuPosition := (LV_GetCount() ? (LV_GetNext() ? LV_GetNext() : 0xFFFF) : 1)

g_strAddFavoriteType := "Text"
gosub, GuiAddFavorite

return
;------------------------------------------------------------


;------------------------------------------------------------
GetMenuForGuiFiltered(ByRef intPositionInMenuForGui)
;------------------------------------------------------------
{
	Gui, 1:ListView, f_lvFavoritesListFiltered

	intPositionInListView := LV_GetNext()
	if !(intPositionInListView)
	{
		intPositionInMenuForGui := 0
		return % "" ; empty
	}
	
	LV_GetText(strMenuPath, intPositionInListView, 2)
	LV_GetText(intPositionInMenuForGui, intPositionInListView, 6)
	
	return o_Containers.AA[strMenuPath]
}
;------------------------------------------------------------


;------------------------------------------------------------
GuiFavoritesListFilterEmpty:
GuiFavoritesListFilterEmptyButton:
;------------------------------------------------------------

if (A_ThisLabel = "GuiFavoritesListFilterEmptyButton")
	gosub, GuiFavoritesListFilterButton

if !StrLen(GetFavoritesListFilter())
	return

if !(g_blnFavoritesListFilterNeverFocused)
{
	GuiControl, 1:, f_strFavoritesListFilter, % ""
	g_blnFavoritesListFilterNeverFocused := false
}

gosub, LoadMenuInGui

return
;------------------------------------------------------------


;------------------------------------------------------------
GetFavoritesListFilter()
;------------------------------------------------------------
{
	GuiControlGet, strFilter, 1:, f_strFavoritesListFilter

	return ((strFilter = o_L["DialogSearch"] and g_blnFavoritesListFilterNeverFocused) ? "" : Trim(strFilter))
}
;------------------------------------------------------------


;========================================================================================================================
; END OF FAVORITE_GUI_OTHER
;========================================================================================================================


;========================================================================================================================
!_038_FAVORITES_GUI_SAVE:
;========================================================================================================================

;------------------------------------------------------------
GuiSaveAndCloseFavorites:
GuiSaveAndStayFavorites:
GuiSaveAndDoNothing:
GuiSaveAndReloadQAP:
;------------------------------------------------------------

g_blnMenuReady := false
strSavedMenuInGui := o_MenuInGui.AA.strMenuPath

GuiControl, Disable, f_btnGuiSaveAndCloseFavorites
GuiControl, Disable, f_btnGuiSaveAndStayFavorites
Gui, Font, s6 ; set a new default
GuiControl, Disable, f_btnGuiCancel

Menu, menuBarFile, Disable, % L(aaMenuFileL["GuiSave"], g_strAppNameText)
Menu, menuBarFile, Disable, % L(aaMenuFileL["GuiSaveAndClose"], g_strAppNameText)
Menu, menuBarFile, Disable, % aaMenuFileL["GuiCancel"]
Menu, menuBarFile, Enable, % L(aaMenuFileL["GuiClose"], g_strAppNameText)

o_MainMenu.SaveFavoritesToIniFile()
ToolTip ; clear tooltip after refresh

if (A_ThisLabel = "GuiSaveAndReloadQAP") or (g_blnHotstringNeedRestart)
	Gosub, ReloadQAP

; was for g_objHotkeysByNameLocation
; clean-up unused hotkeys if favorites were deleted
; for strThisNameLocation, strThisHotkey in g_objHotkeysByNameLocation
	; if RecursiveHotkeyNotNeeded(strThisNameLocation, g_objMainMenu)
	; {
		; g_objHotkeysByNameLocation.Remove(strThisNameLocation)
		; Hotkey, %strThisHotkey%, , Off, UseErrorLevel ; do nothing if error (probably because default hotkey not supported by keyboard)
	; }
; Gosub, DisablePreviousLocationHotkeys ; disable hotkeys found in ini file before updating the ini file
; Gosub, SaveLocationHotkeysToIni ; save location hotkeys to ini file from g_objHotkeysByNameLocation
; Gosub, EnableLocationHotkeys ; enable location hotkeys from g_objHotkeysByNameLocation

Gosub, ExternalMenusRelease ; release reserved external menus
Gosub, LoadMenuFromIniWithStatus ; load favorites to menu object

Gosub, BuildMainMenuWithStatus ; only here we load hotkeys, when user save favorites

GuiControl, Enable, f_btnGuiCancel
GuiControl, , f_btnGuiCancel, % aaSettingsL["GuiClose"]
g_blnMenuReady := true

if (A_ThisLabel = "GuiSaveAndStayFavorites")
{
	if o_Containers.AA[strSavedMenuInGui].FavoriteIsUnderExternalMenu(o_ExternalMenu) ; by safety, reload in main menu to make sure entering in the external menu is properly processed
		o_MenuInGui := o_Containers.AA[aaMenuFileL["MainMenuName"]]
	Gosub, GuiShowFromGuiSettings
}
else if (A_ThisLabel <> "GuiSaveAndDoNothing")
	Gosub, GuiCancel
	
strSavedMenuInGui := ""
strThisNameLocation := ""
strThisHotkey := ""

return
;------------------------------------------------------------


;========================================================================================================================
; END OF FAVORITES LIST
;========================================================================================================================


;========================================================================================================================
!_040_GUI_CHANGE_HOTKEY:
return
;========================================================================================================================

; Gui in function, see from daniel2 http://www.autohotkey.com/board/topic/19880-help-making-gui-work-inside-a-function/#entry130557

;------------------------------------------------------------
SelectShortcut(P_strActualShortcut, P_strFavoriteName, P_strFavoriteType, P_strFavoriteLocation, P_intShortcutType, P_strDefaultShortcut := "", P_strDescription := "")
; P_intShortcutType: 1 Mouse, 2 Keyboard, 3 Mouse or Keyboard
; returns the new shortcut, "None" if no shortcut or empty string if cancel
;------------------------------------------------------------
{
	; To create a global variable inside a function without knowing in advance what the variable's name is, the function must be assume-global. (Lexikos)
	; (https://autohotkey.com/board/topic/84822-error-when-creating-gui-with-global-var-as-a-name/#entry540615)
	; Use SS_ prefix in local variable names to avoid conflicts outside the function and empty these variable because the function will not do it.
	global

	SS_aaL := o_L.InsertAmpersand(false, "DialogOK", "GuiCancel", "DialogNone", "GuiResetDefault")
	
	g_blnChangeShortcutInProgress := true
	SS_strModifiersLabels := "Shift|Ctrl|Alt|Win"
	StringSplit, SS_arrModifiersLabels, SS_strModifiersLabels, |
	SS_strModifiersSymbols := "+|^|!|#"
	StringSplit, SS_arrModifiersSymbols, SS_strModifiersSymbols, |
	
	o_HotkeyActual := new Triggers.HotkeyParts(P_strActualShortcut) ; global

	g_intGui2WinID := WinExist("A")
	
	SS_strGuiTitle := L(o_L["DialogChangeHotkeyTitle"], g_strAppNameText, g_strAppVersion)
	Gui, 3:New, +Hwndg_strGui3Hwnd, %SS_strGuiTitle%
	Gui, 3:Default
	Gui, +Owner2
	Gui, +OwnDialogs
	
	if (g_blnUseColors)
		Gui, Color, %g_strGuiWindowColor%
	Gui, Font, s10 w700, Verdana
	Gui, Add, Text, x10 y10 w400 center, % L(o_L["DialogChangeHotkeyTitle"], g_strAppNameText)
	Gui, Font

	Gui, Add, Text, y+15 x10, % o_L["DialogTriggerFor"]
	Gui, Font, s8 w700
	Gui, Add, Text, x+5 yp w300 section, % P_strFavoriteName . (StrLen(P_strFavoriteType) ? " (" . P_strFavoriteType . ")" : "")
	Gui, Font
	if StrLen(P_strFavoriteLocation)
		Gui, Add, Text, xs y+5 w300, % (P_strFavoriteType = "Snippet" ? StringLeftDotDotDot(EncodeSnippet(P_strFavoriteLocation), 150) : P_strFavoriteLocation)
	if StrLen(P_strDescription)
	{
		P_strDescription := StrReplace(P_strDescription, "<A>") ; remove links from description (already displayed in previous dialog box)
		P_strDescription := StrReplace(P_strDescription, "</A>")
		Gui, Add, Text, xs y+5 w300, %P_strDescription%
	}

	Loop, 4 ; for each modifier add a checkbox
	{
		SS_strModifiersLabel := SS_arrModifiersLabels%A_Index%
		Gui, Add, CheckBox, % "y+" (SS_strModifiersLabel = "Shift" ? 20 : 10) . " x50 gModifierClicked vf_bln"
			. SS_arrModifiersLabels%A_Index%, % o_L["Dialog" . SS_strModifiersLabel . "Short"]
		if (SS_strModifiersLabel = "Shift")
			GuiControlGet, SS_arrTop, Pos, f_blnShift
	}

	if (P_intShortcutType = 1)
		Gui, Add, DropDownList, % "y" . SS_arrTopY . " x150 w200 vf_drpShortcutMouse gMouseChanged", % o_MouseButtons.GetDropDownList(o_HotkeyActual.strMouseButton)
	if (P_intShortcutType = 3)
	{
		Gui, Add, Text, % "y" . SS_arrTopY . " x150 w60", % o_L["DialogMouse"]
		Gui, Add, DropDownList, yp x+10 w200 vf_drpShortcutMouse gMouseChanged, % o_MouseButtons.GetDropDownList(o_HotkeyActual.strMouseButton)
		Gui, Add, Text, % "y" . SS_arrTopY + 20 . " x150", % o_L["DialogOr"]
	}
	if (P_intShortcutType <> 1)
	{
		Gui, Add, Text, % "y" . SS_arrTopY + (P_intShortcutType = 2 ? 0 : 40) . " x150 w60", % o_L["DialogKeyboard"]
		Gui, Add, Hotkey, yp x+10 w200 vf_strShortcutKey gShortcutChanged section
		GuiControl, , f_strShortcutKey, % o_HotkeyActual.strKey
	}
	if (P_intShortcutType <> 1)
		Gui, Add, Link, y+5 xs w200 gShortcutInvisibleKeysClicked, % L(o_L["DialogHotkeyInvisibleKeys"], "Space", "Tab", "Enter", "Esc", "Menu")

	Gui, Add, Button, % "x10 y" . SS_arrTopY + 100 . " vf_btnNoneShortcut gSelectNoneShortcutClicked", % SS_aaL["DialogNone"]
	if StrLen(P_strDefaultShortcut)
	{
		Gui, Add, Button, % "x10 y" . SS_arrTopY + 100 . " vf_btnResetShortcut gButtonResetShortcut", % SS_aaL["GuiResetDefault"]
		GuiCenterButtons(SS_strGuiTitle, 10, 5, 20, "f_btnNoneShortcut", "f_btnResetShortcut")
	}
	else
	{
		Gui, Add, Text, % "x10 y" . SS_arrTopY + 100
		GuiCenterButtons(SS_strGuiTitle, 10, 5, 20, "f_btnNoneShortcut")
	}
	
	Gui, Add, Text, x10 y+25 w400, % o_L["DialogChangeHotkeyLeftAnyRight"]
	Loop, 4 ; create 4 groups of radio buttons for Right, Any or Left keys
	{
		SS_strModifiersLabel := SS_arrModifiersLabels%A_Index%
		Gui, Add, Text, y+10 x10 w60 right, % o_L["Dialog" . SS_strModifiersLabel . "Short"]
		Gui, Font, w700
		Gui, Add, Text, yp x+10 w40 center, % chr(0x2192) ; right arrow
		Gui, Font
		Gui, Add, Radio, % "yp x+10 disabled vf_radLeft" . SS_arrModifiersLabels%A_Index%, % o_L["DialogWindowPositionLeft"]
		Gui, Add, Radio, % "yp x+10 disabled vf_radAny" . SS_arrModifiersLabels%A_Index%, % o_L["DialogChangeHotkeyAny"]
		Gui, Add, Radio, % "yp x+10 disabled vf_radRight" . SS_arrModifiersLabels%A_Index%, % o_L["DialogWindowPositionRight"]
	}
	Gosub, SetModifiersCheckBoxAndRadio ; set checkboxes and radio buttons according to o_HotkeyActual.strModifiers

	Gui, Add, Button, y+25 x10 vf_btnChangeShortcutOK gButtonChangeShortcutOK, % SS_aaL["DialogOK"]
	Gui, Add, Button, yp x+20 vf_btnChangeShortcutCancel gButtonChangeShortcutCancel, % SS_aaL["GuiCancel"]
	
	GuiCenterButtons(SS_strGuiTitle, 10, 5, 20, "f_btnChangeShortcutOK", "f_btnChangeShortcutCancel")

	Gui, Add, Text
	GuiControl, Focus, f_btnChangeShortcutOK
	CalculateTopGuiPosition(g_strGui3Hwnd, g_strGui2Hwnd, SS_intX, SS_intY)
	Gui, Show, AutoSize x%SS_intX% y%SS_intY%

	Gui, 2:+Disabled
	WinWaitClose, %SS_strGuiTitle% ; waiting for Gui to close
	
	if (SS_strNewShortcut <> P_strActualShortcut)
		SS_strNewShortcut := ShortcutIfAvailable(SS_strNewShortcut, P_strFavoriteName)

	; Clean-up function global variables
	ResetArray("SS_arrModifiersLabels")
	ResetArray("SS_arrModifiersSymbols")
	ResetArray("SS_arrTop")
	SS_blnAlt := ""
	SS_blnCtrl := ""
	SS_blnShift := ""
	SS_blnThisLeft := ""
	SS_blnThisModifierOn := ""
	SS_blnThisRight := ""
	SS_blnWin := ""
	SS_intReverseIndex := ""
	SS_strHotkeyControl := ""
	SS_strHotkeyControlKey := ""
	SS_strHotkeyControlModifiers := ""
	SS_strKey := ""
	SS_strModifiersLabel := ""
	SS_strModifiersLabels := ""
	SS_strModifiersSymbols := ""
	SS_strMouse := ""
	SS_strMouseControl := ""
	SS_strMouseValue := ""
	SS_strThisLabel := ""
	SS_strThisSymbol := ""
	SS_intX := ""
	SS_intY := ""
	SS_strGuiTitle := ""
	SS_aaL := ""

	return SS_strNewShortcut ; returning value
	
	;------------------------------------------------------------

	;------------------------------------------------------------
	MouseChanged:
	;------------------------------------------------------------
	SS_strMouseControl := A_GuiControl ; hotkey var name
	GuiControlGet, SS_strMouseValue, , %SS_strMouseControl%

	if (SS_strMouseValue = o_L["DialogNone"]) ; this is the translated "None"
	{
		loop, 4 ; uncheck modifiers checkbox
			GuiControl, , % "f_bln" . SS_arrModifiersLabels%A_Index%, 0
		gosub, ModifierClicked
	}

	if (P_intShortcutType = 3) ; both keyboard and mouse options are available
		; we have a mouse button, empty the hotkey control
		GuiControl, , f_strShortcutKey, None

	return
	;------------------------------------------------------------
	
	;------------------------------------------------------------
	ShortcutChanged:
	;------------------------------------------------------------
	SS_strHotkeyControl := A_GuiControl ; hotkey var name
	SS_strHotkeyControl := %SS_strHotkeyControl% ; hotkey content

	if !StrLen(SS_strHotkeyControl)
		return

	o_HotkeyCheckModifiers := new Triggers.HotkeyParts(SS_strHotkeyControl) ; global

	if StrLen(o_HotkeyCheckModifiers.strModifiers) ; we have a modifier and we don't want it, reset keyboard to none and return
		GuiControl, , %A_GuiControl%, None
	else ; we have a valid key, empty the mouse dropdown and return
		GuiControl, Choose, f_drpShortcutMouse, 0
	
	o_HotkeyCheckModifiers := ""

	return
	;------------------------------------------------------------

	;------------------------------------------------------------
	SelectNoneShortcutClicked:
	;------------------------------------------------------------
	o_HotkeyActual.SplitParts("None")
	
	GuiControl, , f_strShortcutKey, % o_L["DialogNone"]
	GuiControl, Choose, f_drpShortcutMouse, % o_L["DialogNone"]
	Gosub, SetModifiersCheckBoxAndRadio ; set checkboxes and radio buttons according to o_HotkeyActual.strModifiers

	return
	;------------------------------------------------------------

	;------------------------------------------------------------
	ShortcutInvisibleKeysClicked:
	;------------------------------------------------------------
	if (ErrorLevel = "Space")
		GuiControl, , f_strShortcutKey, %A_Space%
	else if (ErrorLevel = "Tab")
		GuiControl, , f_strShortcutKey, %A_Tab%
	else if (ErrorLevel = "Enter")
		GuiControl, , f_strShortcutKey, Enter
	else if (ErrorLevel = "Esc")
		GuiControl, , f_strShortcutKey, Escape
	else ; Menu
		GuiControl, , f_strShortcutKey, AppsKey
	GuiControl, Choose, f_drpShortcutMouse, 0

	return
	;------------------------------------------------------------

	;------------------------------------------------------------
	ButtonResetShortcut:
	;------------------------------------------------------------
	o_HotkeyActual.SplitParts(P_strDefaultShortcut)
	
	GuiControl, , f_strShortcutKey, % o_HotkeyActual.strKey
	GuiControl, Choose, f_drpShortcutMouse, % o_MouseButtons.GetMouseButtonLocalized4InternalName(o_HotkeyActual.strMouseButton, false) ; not short
	Gosub, SetModifiersCheckBoxAndRadio ; set checkboxes and radio buttons according to o_HotkeyActual.strModifiers
	
	return
	;------------------------------------------------------------

	;------------------------------------------------------------
	SetModifiersCheckBoxAndRadio:
	;------------------------------------------------------------
	loop, 4 ; set modifiers checkboxes according to o_HotkeyActual.strModifiers
	{
		SS_strThisLabel := SS_arrModifiersLabels%A_Index%
		SS_strThisSymbol := SS_arrModifiersSymbols%A_Index%
		
		GuiControl, , % "f_bln" . SS_strThisLabel, % InStr(o_HotkeyActual.strModifiers, SS_strThisSymbol) > 0 ; > 0 required to make sure we have 0 or 1 value
		
		GuiControl, , f_radLeft%SS_strThisLabel%, % InStr(o_HotkeyActual.strModifiers, "<" . SS_strThisSymbol) > 0
		GuiControl, , f_radAny%SS_strThisLabel%, % !InStr(o_HotkeyActual.strModifiers, "<" . SS_strThisSymbol) and !InStr(P_strActualShortcut, ">" . SS_strThisSymbol)
		GuiControl, , f_radRight%SS_strThisLabel%, % InStr(o_HotkeyActual.strModifiers, ">" . SS_strThisSymbol) > 0
	}
	gosub, ModifierClicked
	
	return
	;------------------------------------------------------------

	;------------------------------------------------------------
	ModifierClicked:
	;------------------------------------------------------------
	Loop, 4 ; enable/disable modifiers radio buttons groups for each modifier
	{
		SS_strThisLabel := SS_arrModifiersLabels%A_Index%
		SS_strThisSymbol := SS_arrModifiersSymbols%A_Index%
		
		GuiControlGet, SS_blnThisModifierOn, , % "f_bln" . SS_arrModifiersLabels%A_Index%
		GuiControl, Enable%SS_blnThisModifierOn%, f_radLeft%SS_strThisLabel%
		GuiControl, Enable%SS_blnThisModifierOn%, f_radAny%SS_strThisLabel%
		GuiControl, Enable%SS_blnThisModifierOn%, f_radRight%SS_strThisLabel%
	}
	return
	;------------------------------------------------------------
	
	;------------------------------------------------------------
	ButtonChangeShortcutOK:
	;------------------------------------------------------------
	GuiControlGet, SS_strMouse, , f_drpShortcutMouse
	GuiControlGet, SS_strKey, , f_strShortcutKey
	GuiControlGet, SS_blnWin , ,f_blnWin
	GuiControlGet, SS_blnAlt, , f_blnAlt
	GuiControlGet, SS_blnCtrl, , f_blnCtrl
	GuiControlGet, SS_blnShift, , f_blnShift

	if StrLen(SS_strMouse)
		SS_strMouse := o_MouseButtons.GetMouseButtonInternal4LocalizedName(SS_strMouse) ; get mouse button system name from dropdown localized text
	
	SS_strNewShortcut := Trim(SS_strKey . (SS_strMouse = "None" ? "" : SS_strMouse))
	if !StrLen(SS_strNewShortcut)
		SS_strNewShortcut := "None"
	
	if HasShortcut(SS_strNewShortcut)
		Loop, 4
		{
			SS_intReverseIndex := -(A_Index-5) ; reverse order of modifiers important to keep modifiers labels in correct order
			SS_strThisLabel := SS_arrModifiersLabels%SS_intReverseIndex%
			SS_strThisSymbol := SS_arrModifiersSymbols%SS_intReverseIndex%
			if (SS_bln%SS_strThisLabel%)
			{
				GuiControlGet, SS_blnThisLeft, , f_radLeft%SS_strThisLabel%
				GuiControlGet, SS_blnThisRight, , f_radRight%SS_strThisLabel%
				SS_strNewShortcut := (SS_blnThisLeft ? "<" : "") . (SS_blnThisRight ? ">" : "") . SS_strThisSymbol . SS_strNewShortcut
			}
		}

	; ###_V(A_ThisLabel, SS_strNewShortcut)
	
	if (SS_strNewShortcut = "LButton")
	{
		Oops(o_L["DialogChangeHotkeyMouseCheckLButton"], o_L["DialogShift"], o_L["DialogCtrl"], o_L["DialogAlt"], o_L["DialogWin"])
		SS_strNewShortcut := ""
		return
	}
	else if (SS_blnWin or SS_blnAlt or SS_blnCtrl or SS_blnShift) and (SS_strNewShortcut = "None")
	{
		Oops(o_L["DialogChangeHotkeyModifierAndNone"])
		SS_strNewShortcut := ""
		return
	}	
	g_blnChangeShortcutInProgress := false
	Gosub, 3GuiClose
	
	return
	;------------------------------------------------------------

	;------------------------------------------------------------
	ButtonChangeShortcutCancel:
	;------------------------------------------------------------

	; called here if user click Cancel, called also directlry if user hit Escape
	Gosub, 3GuiEscape
  
	return
	;------------------------------------------------------------
}
;------------------------------------------------------------


;------------------------------------------------------------
SelectHotstringDefaultOptions:
;------------------------------------------------------------

strNewHotstringsDefaultOptions := SelectHotstring(o_Settings.Hotstrings.strHotstringsDefaultOptions.IniValue, "", "", "", true)
Gosub, GuiOptionsGroupChanged

return
;------------------------------------------------------------


;------------------------------------------------------------
SelectHotstring(P_strActualHotstring, P_strFavoriteName, P_strFavoriteType, P_strFavoriteLocation, P_blnDefaultOptions := false)
; returns the new hotstring or empty string if cancel
;------------------------------------------------------------
{
	global
	
	g_blnChangeHotstringInProgress := !(P_blnDefaultOptions)
	SH_strGuiTitle := L((P_blnDefaultOptions ? o_L["DialogChangeHotstringTitleDefaultOptions"] : o_L["DialogChangeHotstringTitle"]), g_strAppNameText)

	SplitHotstring(P_strActualHotstring, SH_strFavoriteHotstringTrigger, SH_strFavoriteHotstringOptionsShort)
	if !StrLen(P_strActualHotstring) ; if new hotstring, use default options
		SH_strFavoriteHotstringOptionsShort := o_Settings.Hotstrings.strHotstringsDefaultOptions.IniValue
	; ###_V("P_strActualHotstring", P_strActualHotstring, SH_strFavoriteHotstringTrigger, SH_strFavoriteHotstringOptionsShort)

	g_intGui2WinID := WinExist("A")

	Gui, 3:New, +Hwndg_strGui3Hwnd, %SH_strGuiTitle%
	Gui, 3:Default
	Gui, +Owner2
	Gui, +OwnDialogs
	
	if (g_blnUseColors)
		Gui, Color, %g_strGuiWindowColor%
	Gui, Font, s10 w700, Verdana
	Gui, Add, Text, x10 y10 w400 center, %SH_strGuiTitle%
	Gui, Font
	
	Gui, Add, Link, y+15 x10, % (P_blnDefaultOptions ? L(o_L["DialogChangeHotstringDefaultOptionsPrompt"], "https://www.quickaccesspopup.com/what-are-hotstrings/#options") : o_L["DialogTriggerFor"])
	
	if !(P_blnDefaultOptions)
	{
		Gui, Font, s8 w700
		Gui, Add, Text, x+5 yp w300 section, % (P_blnDefaultOptions ? o_L["DialogChangeHotstringDefaultOptionsPrompt"]
			: P_strFavoriteName . (StrLen(P_strFavoriteType) ? " (" . P_strFavoriteType . ")" : ""))
		Gui, Font
	}
	
	if StrLen(P_strFavoriteLocation)
		Gui, Add, Text, xs y+5 w300, % (P_strFavoriteType = "Snippet" ? StringLeftDotDotDot(EncodeSnippet(P_strFavoriteLocation), 150) : P_strFavoriteLocation)

	; Trigger
	if !(P_blnDefaultOptions)
	{
		Gui, Add, Text, y+15 x10, % o_L["DialogHotstringTriggerAbbreviation"]
		Gui, Add, Edit, x10 y+5 w300 Limit40 vf_SH_strHotstringTrigger, %SH_strFavoriteHotstringTrigger%
	}

	; Options
	SH_strTempOptions := SH_strFavoriteHotstringOptionsShort
	SH_strTempOptions := StrReplace(SH_strTempOptions, "C1") ; avoid ambiguity with "C", for backward compatibility, remove "C1" option that was available in v9.0.1/9.0.2
	
	; C Case sensitive
	Gui, Add, Checkbox, % "x10 y+10 vf_SH_blnHotstringCaseSensitive " . (InStr(SH_strTempOptions , "C") ? "checked" : ""), % o_L["DialogHotstringCaseSensitive"]
	; ?	Expand inside other words
	Gui, Add, Checkbox, % "x10 y+5 vf_SH_blnHotstringExpandInsideWords " . (InStr(SH_strFavoriteHotstringOptionsShort, "?") ? "checked" : ""), % o_L["DialogHotstringExpandInsideWords"]
	; B0 Keep hotstring trigger (do not backspace)
	Gui, Add, Checkbox, % "x10 y+5 vf_SH_blnHotstringKeepHotstring " . (InStr(SH_strFavoriteHotstringOptionsShort, "B0") ? "checked" : ""), % o_L["DialogHotstringKeepHotstring"]
	; *	Do not wait for Ending key
	Gui, Add, Checkbox, % "x10 y+5 vf_SH_blnHotstringNotWaitEndingKey " . (InStr(SH_strFavoriteHotstringOptionsShort, "*") ? "checked" : ""), % o_L["DialogHotstringNotWaitEndingKey"]
	; Unsupported options: O	Do not keep Ending key (not available when using Send), C1 Do not conform to typed case (not available when using Send),
	; Kn Key-delay, Pn Priority, R Send Raw, SI Send Input, SP Send PLay, SE Send Event, T Send Raw, Z Reset recognizer after each triggering
	; Keep default EndChars "-()[]{}:;'"/\,.?!" + Enter, Space and Tab
	; Keep default MouseReset option (recognizer resets monitored string on mouse click)

	SH_aaL := o_L.InsertAmpersand(false, "DialogOK", "GuiCancel")
	
	Gui, Add, Button, y+25 x10 vf_btnChangeHotstringOK gButtonChangeHotstringOK default, % SH_aaL["DialogOK"]
	Gui, Add, Button, yp x+20 vf_btnChangeHotstringCancel gButtonChangeHotstringCancel, % SH_aaL["GuiCancel"]
	
	GuiCenterButtons(SH_strGuiTitle, 10, 5, 20, "f_btnChangeHotstringOK", "f_btnChangeHotstringCancel")

	Gui, Add, Text
	GuiControl, Focus, f_btnChangeHotkeyOK
	CalculateTopGuiPosition(g_strGui3Hwnd, g_strGui2Hwnd, SH_intX, SH_intY)
	Gui, Show, AutoSize x%SH_intX% y%SH_intY%

	Gui, 2:+Disabled
	WinWaitClose,  %SH_strGuiTitle% ; waiting for Gui to close
	
	; SH_strNewHotstring was built by ButtonChangeHotstringOK
	SplitHotstring(SH_strNewHotstring, SH_strHotstringTrigger, SH_strFavoriteHotstringOptionsShort)
	; ###_V("SH_strNewHotstring avant Validate", SH_strNewHotstring, SH_strHotstringTrigger, SH_strFavoriteHotstringOptionsShort)
	
	if !(P_blnDefaultOptions)
	{
		if !StrLen(SH_strHotstringTrigger)
			SH_strNewHotstring := "" ; make sure we have no option if no trigger
		
		if StrLen(SH_strNewHotstring)
			SH_strNewHotstring := HotstringValidate(P_strActualHotstring, SH_strNewHotstring)
	}
	; ###_V("SH_strNewHotstring aprs Validate", SH_strNewHotstring)
	
	; Clean-up function global variables
	SH_strGuiTitle := ""
	SH_strFavoriteHotstringTrigger := ""
	SH_strFavoriteHotstringOptionsShort := ""
	SH_strHotstringTrigger := ""
	SH_blnHotstringCaseSensitive := ""
	SH_blnHotstringWaitEndingKey := ""
	SH_blnHotstringKeepTrigger := ""
	SH_strTempOptions := ""
	SH_intX := ""
	SH_intY := ""
	SH_aaL := ""
	
	return SH_strNewHotstring ; returning value
	
	;------------------------------------------------------------

	;------------------------------------------------------------
	ButtonChangeHotstringOK:
	;------------------------------------------------------------
	
	GuiControlGet, SH_blnHotstringCaseSensitive, , f_SH_blnHotstringCaseSensitive
	GuiControlGet, SH_blnHotstringExpandInsideWords, , f_SH_blnHotstringExpandInsideWords
	GuiControlGet, SH_blnHotstringKeepHotstring , , f_SH_blnHotstringKeepHotstring
	GuiControlGet, SH_blnHotstringNotWaitEndingKey , , f_SH_blnHotstringNotWaitEndingKey

	GuiControlGet, SH_strHotstringTrigger, , f_SH_strHotstringTrigger
	
	if StrLen(SH_strHotstringTrigger) or (P_blnDefaultOptions)
		SH_strNewHotstring := g_strHotstringOptionsSeparator
			. (SH_blnHotstringCaseSensitive ? "C" : "")
			. (SH_blnHotstringExpandInsideWords ? "?" : "")
			. (SH_blnHotstringKeepHotstring ? "B0" : "")
			. (SH_blnHotstringNotWaitEndingKey ? "*" : "")
			. g_strHotstringOptionsSeparator
			. SH_strHotstringTrigger
	else
		SH_strNewHotstring := "" ; return empty if no trigger
	
	g_blnChangeHotstringInProgress := false
	Gosub, 3GuiClose
	
	return
	;------------------------------------------------------------

	;------------------------------------------------------------
	ButtonChangeHotstringCancel:
	;------------------------------------------------------------
	
	; called here if user click Cancel, called also directlry if user hit Escape
	Gosub, 3GuiEscape
  
	return
	;------------------------------------------------------------
}
;------------------------------------------------------------


;-----------------------------------------------------------
UpdateFavoriteObjectSaveShortcut:
UpdateFavoriteObjectSaveShortcutList:
;-----------------------------------------------------------

if (o_EditedFavorite.AA.strFavoriteShortcut = g_strNewFavoriteShortcut) ; if not changed
	or (!HasShortcut(o_EditedFavorite.AA.strFavoriteShortcut) and !HasShortcut(g_strNewFavoriteShortcut)) ; if both are "None" or empty
	return

; shortcut was added, changed or removed

if HasShortcut(g_strNewFavoriteShortcut)
{
	; add item to g_aaItemsByShortcut and remove from g_aaItemsByShortcutToRemoveWhenBuildingMenu (because it is now re-used)
	g_aaItemsByShortcut[g_strNewFavoriteShortcut] := o_EditedFavorite ; insert new shortcut as in g_strNewFavoriteShortcut
	g_aaItemsByShortcutToRemoveWhenBuildingMenu.Delete(g_strNewFavoriteShortcut) ; in case this shortcut was removed from another favorite before
}

if HasShortcut(o_EditedFavorite.AA.strFavoriteShortcut)
{
	; remove item from g_aaItemsByShortcut and add it to g_aaItemsByShortcutToRemoveWhenBuildingMenu
	g_aaItemsByShortcut.Delete(o_EditedFavorite.AA.strFavoriteShortcut) ; remove old shortcut as in o_EditedFavorite
	g_aaItemsByShortcutToRemoveWhenBuildingMenu[o_EditedFavorite.AA.strFavoriteShortcut] := "foo" ; to disable the shortcut when reloading the menu; only key is used, the value is ignored
}

if (A_ThisLabel = "UpdateFavoriteObjectSaveShortcutList")
{
	GuiControl, 1:Enable, f_btnGuiSaveAndCloseFavorites
	GuiControl, 1:Enable, f_btnGuiSaveAndStayFavorites
	GuiControl, 1:, f_btnGuiCancel, % aaSettingsL["GuiCancel"]
}

o_EditedFavorite.AA.strFavoriteShortcut := (HasShortcut(g_strNewFavoriteShortcut) ? g_strNewFavoriteShortcut : "")

if (A_ThisLabel = "UpdateFavoriteObjectSaveShortcutList")
	Gosub, HotkeysManageListLoad

return
;-----------------------------------------------------------


;-----------------------------------------------------------
UpdateFavoriteObjectSaveHotstring:
UpdateFavoriteObjectSaveHotstringList:
;-----------------------------------------------------------

if (o_EditedFavorite.AA.strFavoriteHotstring == g_strNewFavoriteHotstring) ; if not changed (case-sensitive equal)
	return

; Hotstring was added, changed or removed. Do not add new, change or remove hotstring to g_dicItemsByHotstring
; because we would not be able to turn it off in DisableHotstrings since it does not exist yet

; if an hostring does not already need restart, check if this hotstring's options changed and need restart
if !(g_blnHotstringNeedRestart)
	and (GetHotstringOptions(o_EditedFavorite.AA.strFavoriteHotstring) <> GetHotstringOptions(g_strNewFavoriteHotstring))
{
	g_blnHotstringNeedRestart := true
	Oops(o_L["DialogChangeHotstringReload"], g_strAppNameText)
}

; update favorite object
o_EditedFavorite.AA.strFavoriteHotstring := g_strNewFavoriteHotstring

if (A_ThisLabel = "UpdateFavoriteObjectSaveHotstringList")
{
	GuiControl, 1:Enable, f_btnGuiSaveAndCloseFavorites
	GuiControl, 1:Enable, f_btnGuiSaveAndStayFavorites
	GuiControl, 1:, f_btnGuiCancel, % aaSettingsL["GuiCancel"]
	
	Gosub, HotkeysManageListLoad
}

return
;-----------------------------------------------------------


;-----------------------------------------------------------
ShortcutIfAvailable(strShortcut, strFavoriteName)
;-----------------------------------------------------------
{
	global g_arrOptionsPopupHotkeyTitles
	
	if !StrLen(strShortcut) or (strShortcut = "None")
		return strShortcut
	
	; check popup menu hotkeys
	for intThisIndex, objThisPopupHotkey in o_PopupHotkeys.SA
		if (objThisPopupHotkey.P_strAhkHotkey = strShortcut)
		{
			strExistingName := objThisPopupHotkey.AA.strPopupHotkeyLocalizedName
			break
		}
	
	if !StrLen(strExistingName)
		; check QAP Features Alternative menu hotkeys
		for strCode, objThisQAPFeature in o_QAPfeatures.AA
			if (objThisQAPFeature.strCurrentHotkey = strShortcut)
			{
				strExistingName := objThisQAPFeature.strLocalizedName
				break
			}
	
	; check favorites hotkeys
	if !StrLen(strExistingName)
		strExistingName := g_aaItemsByShortcut[strShortcut].AA.strFavoriteName

	if StrLen(strExistingName)
	{
		Oops(o_L["OopsHotkeyAlreadyUsed"], new Triggers.HotkeyParts(strShortcut).Hotkey2Text(), strExistingName, strFavoriteName)
		return ""
	}
	else
		return strShortcut
}
;-----------------------------------------------------------


;-----------------------------------------------------------
HotstringValidate(strActualHotstring, strNewHotstring)
;-----------------------------------------------------------
{
	if StrLen(strNewHotstring) > 40 ; each hotstring abbreviation can be no more than 40 characters long
	{
		Oops(o_L["OopsHotstringTriggerTooLong"])
		return strActualHotstring
	}
	else
		return strNewHotstring
}
;-----------------------------------------------------------


;========================================================================================================================
; END OF GUI_CHANGE_HOTKEY:
;========================================================================================================================


;========================================================================================================================
!_050_GUI_CLOSE-CANCEL-BK_OBJECTS:
;========================================================================================================================


;------------------------------------------------------------
ShowGui2AndDisableGui1:
ShowGui2AndDisableGui1KeepPosition:
;------------------------------------------------------------

if (A_ThisLabel = "ShowGui2AndDisableGui1")
{
	CalculateTopGuiPosition(g_strGui2Hwnd, g_strAppHwnd, intX, intY)
	Gui, 2:Show, AutoSize x%intX% y%intY%
}
else ; KeepPosition
	Gui, 2:Show

Gui, 1:+Disabled
if (g_Gui1AlwaysOnTop)
	WinSet, AlwaysOnTop, Off, % L(o_L["GuiTitle"], g_strAppNameText, g_strAppVersion)

intX := ""
intY := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiClose:
GuiEscape:
;------------------------------------------------------------

GoSub, GuiCancel

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiCancel:
;------------------------------------------------------------

if !(g_blnFavoritesListFilterNeverFocused)
{
	GuiControl, 1:, f_strFavoritesListFilter, % "" ; empty filter will hide filtered list and show regular list
	g_blnFavoritesListFilterNeverFocused := false
}
GuiControlGet, strCancelLabel, , f_btnGuiCancel

blnCancelEnabled := (strCancelLabel = aaSettingsL["GuiCancel"])
if (blnCancelEnabled)
{
	Gui, 1:+OwnDialogs
	MsgBox, 36, % L(o_L["DialogCancelTitle"], g_strAppNameText, g_strAppVersion), % o_L["DialogCancelPrompt"]
	IfMsgBox, Yes
	{
		g_blnMenuReady := false
		
		; Gosub, RestoreBackupContainers
		o_MainMenu := o_MainMenuBK
		o_MainMenu.RestoreContainersIndex()
		
		GuiControl, Disable, f_btnGuiSaveAndCloseFavorites
		GuiControl, Disable, f_btnGuiSaveAndStayFavorites
		GuiControl, , f_btnGuiCancel, % aaSettingsL["GuiClose"]
		
		g_blnHotstringNeedRestart := false
		g_blnMenuReady := true
	}
	IfMsgBox, No
	{
		gosub, GuiCancelCleanup
		return
	}
}
Gosub, ExternalMenusRelease ; release cancel enabled or not

; disable Favorite menu items in Tray menu
loop, Parse, % "DialogEdit|GuiRemoveFavorite|GuiMove|DialogCopy|ControlToolTipMoveUp|ControlToolTipMoveDown|ControlToolTipSortFavorites", |
	Menu, menuBarFavorite, Disable, % aaFavoriteL[A_LoopField]

Gui, 1:Cancel

GuiCancelCleanup:
blnCancelEnabled := ""
blnCancelEnabled := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
2GuiSize:
;------------------------------------------------------------

WinGetTitle, strThisTitle, A

if WindowIsAddEditCopyFavorite(strThisTitle)
{
	; resize add/edit/copy favorite dialog box to select long parent menu
	GuiControl, 2:Move, f_drpParentMenu, % "w" . A_GuiWidth - 50
	GuiControl, 2:Move, f_drpParentMenuItems, % "w" . A_GuiWidth - 50
	GuiControl, 2:Move, f_intAddFavoriteTab, % "w" . A_GuiWidth - 30
}
else if WindowIsToMenuDialogBox(strThisTitle)
{
	; resize dialog box to select destination menu when copying/moving multiple favorites
	GuiControl, 2:Move, f_drpParentMenu, % "w" . A_GuiWidth - 20
	GuiControl, 2:Move, f_drpParentMenuItems, % "w" . A_GuiWidth - 30
}
strThisTitle := ""

; resizing GuiDonate
if (g_intLnkWhySponsorWidth) 
	GuiControl, 2:Move, f_lnkWhySponsor, % "x" . (A_GuiWidth - g_intLnkWhySponsorWidth) // 2

if (g_intLnkSendLink) ; resizing GuiDonate
	GuiControl, 2:Move, f_lnkSendLink, % "x" . (A_GuiWidth - g_intLnkSendLink) // 2
g_intLnkWhySponsorWidth := ""
g_intLnkSendLink := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
2GuiClose:
2GuiEscape:
;------------------------------------------------------------

WinGetTitle, strThisTitle, A

if (g_strOptionsGuiTitle = strThisTitle)
{
	if (g_blnGroupChanged)
	{
		Gui, 2:+OwnDialogs
		MsgBox, 36, % L(o_L["DialogCancelTitle"], g_strAppNameText, g_strAppVersion), % o_L["DialogCancelPrompt"]
		
		IfMsgBox, Yes
		{
			g_blnGroupChanged := false
			; revert to previous content of o_PopupHotkeys.SA
			o_PopupHotkeys.RestorePopupHotkeys()
		}
		IfMsgBox, No
			return
	}
	g_strSettingsGroup := ""
}
else
{
	; save position and size of add/edit/copy dialog box and of dialog box to select destination menu when copying/moving multiple favorites
	blnIsAddEditCopyFavorite := WindowIsAddEditCopyFavorite(strThisTitle)
	blnIsToMenuDialogBox := WindowIsToMenuDialogBox(strThisTitle)

	if (blnIsAddEditCopyFavorite or blnIsToMenuDialogBox)
		SaveWindowPosition((blnIsToMenuDialogBox ? "CopyMoveDialogPosition" : "AddEditCopyFavoriteDialogPosition"), "A")
}

Gui, 1:-Disabled
Gui, 2:Destroy
if (g_intGui1WinID <> A_ScriptHwnd)
	WinActivate, ahk_id %g_intGui1WinID%

if (g_Gui1AlwaysOnTop)
	WinSet, AlwaysOnTop, On, % L(o_L["GuiTitle"], g_strAppNameText, g_strAppVersion)

strThisTitle := ""
blnIsAddEditCopyFavorite := ""
blnIsToMenuDialogBox := ""
intMinMax := ""
strDialogPosition := ""
intX := ""
intY := ""
intW := ""
intH := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
3GuiClose:
3GuiEscape:
;------------------------------------------------------------

if (A_ThisLabel = "3GuiEscape")
	if (g_blnChangeShortcutInProgress) ; coming from SelectShortcut
	{
		SS_strNewShortcut := ""
		g_blnChangeShortcutInProgress := false
	}
	else if (g_blnChangeHotstringInProgress) ; coming from SelectHotstring
	{
		SH_strNewHotstring := P_strActualHotstring
		g_blnChangeHotstringInProgress := false
	}

Gui, 2:-Disabled
Gui, 3:Destroy
if (g_intGui2WinID <> A_ScriptHwnd)
	WinActivate, ahk_id %g_intGui2WinID%

return
;------------------------------------------------------------


;------------------------------------------------------------
ExternalMenusRelease:
;------------------------------------------------------------

; do not use ###_V(): dialog box could hang exit
loop, % g_saExternaleMenuToRelease.MaxIndex()
{
	IniWrite, % "", % g_saExternaleMenuToRelease[1], Global, MenuReservedBy ; no need to update LastModified for this change
	g_saExternaleMenuToRelease.RemoveAt(1)
}

return
;------------------------------------------------------------


;========================================================================================================================
; END OF GUI CLOSE-CANCEL-BK_OBJECTS
;========================================================================================================================


;========================================================================================================================
!_060_POPUP_MENU:
;========================================================================================================================

;------------------------------------------------------------
~LCtrl:: ; use ~ to allow detecting double keypress
~RCtrl:: ; use ~ to allow detecting double keypress
;------------------------------------------------------------

strKeyPressed := A_ThisLabel

if ((strKeyPressed = "~LCtrl") and !(o_Settings.MenuPopup.blnLeftControlDoublePressed.IniValue))
	or ((strKeyPressed = "~RCtrl") and !(o_Settings.MenuPopup.blnRightControlDoublePressed.IniValue))
	return

if (A_PriorHotKey = strKeyPressed and A_TimeSincePriorHotkey < 400) ; ms maximum delay between Ctrl presses
{
	if CanNavigate(o_PopupHotkeyNavigateOrLaunchHotkeyKeyboard.P_strAhkHotkey) ; fake pressing main QAP keyboard trigger (Windows + W or custom)
		Gosub, NavigateHotkeyKeyboard
	else if CanLaunch(o_PopupHotkeyNavigateOrLaunchHotkeyKeyboard.P_strAhkHotkey) ; fake pressing main QAP keyboard trigger (Windows + W or custom)
		Gosub, LaunchHotkeyKeyboard
	; else do nothing
}
StringTrimLeft, strKeyPressed, strKeyPressed, 1
KeyWait, %strKeyPressed%

strKeyPressed := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
NavigateHotkeyMouse:		; g_strTargetWinId set by CanNavigate
NavigateHotkeyKeyboard:		; g_strTargetWinId set by CanNavigate
NavigateFromMsg:			; g_strTargetWinId set by RECEIVE_QAPMESSENGER
LaunchFromMsg:				; g_strTargetWinId set by RECEIVE_QAPMESSENGER
LaunchHotkeyMouse:			; g_strTargetWinId set by CanNavigate
LaunchHotkeyKeyboard:		; g_strTargetWinId set by CanNavigate
LaunchFromTrayIcon:			; g_strTargetWinId set empty (not required)
LaunchFromAlternativeMenu:	; g_strTargetWinId set by AlternativeHotkeyMouse/AlternativeHotkeyKeyboard
;------------------------------------------------------------

if SettingsUnsaved()
	if SettingsNotSavedReturn()
		return

if (!g_blnMenuReady or g_blnChangeShortcutInProgress or g_blnChangeHotstringInProgress)
	return

Diag(A_ThisLabel, "", "START-SHOW")

g_strMenuTriggerLabel := A_ThisLabel

if (g_blnGetWinInfo)
{
	gosub, GetWinInfo2Clippoard
	return
}

SetWaitCursor(true)

g_blnAlternativeMenu := (A_ThisLabel = "LaunchFromAlternativeMenu")
g_blnLaunchFromTrayIcon := (A_ThisLabel = "LaunchFromTrayIcon") ; make sure it is initialized true or false

Gosub, SetMenuPosition

if !(g_blnAlternativeMenu)
	g_strAlternativeMenu := "" ; delete from previous call to Alternative key, else keep what was set in OpenAlternativeMenu

if (A_ThisLabel = "LaunchFromTrayIcon")
{
	g_strTargetWinId := "" ; never use target window when launched from the tray icon
	g_strTargetClass := "" ;  re-init for safety
	g_strHotkeyTypeDetected := "Launch" ; never navigate when launched from the tray icon
}
else if (A_ThisLabel = "LaunchFromAlternativeMenu")
	g_strHotkeyTypeDetected := "Alternative"
else if InStr(A_ThisLabel, "FromMsg")
	g_strHotkeyTypeDetected := (InStr(A_ThisLabel, "Navigate") ? "Navigate" : "Launch")
else
	g_strHotkeyTypeDetected := SubStr(A_ThisLabel, 1, InStr(A_ThisLabel, "Hotkey") - 1) ; "Navigate" or "Launch"

if InStr(A_ThisLabel, "Mouse")
	and (WindowIsExplorer(g_strTargetClass) or WindowIsDirectoryOpus(g_strTargetClass) or WindowIsQAPconnect(g_strTargetWinId)
		or (WindowIsTotalCommander(g_strTargetClass) and g_strHotkeyTypeDetected = "Navigate"))
	
{
	; to make sure the item and Explorer window, DOpus lister or under the mouse become active,
	; and for TC only if navigate (to avoid disrupting GetSelectedLocation)
	Click
	Sleep, 20
}

; refresh the dynamic menus before showing the main menu
Gosub, RefreshSwitchFolderOrAppMenu ; also refreshes menu o_L["MenuCurrentFolders"]
Gosub, RefreshClipboardMenu
Gosub, RefreshTotalCommanderHotlist
Gosub, RefreshDirectoryOpusFavorites
Gosub, RefreshLastActionsMenu

if (o_Settings.MenuPopup.blnRefreshedMenusAttached.IniValue)
{
	Gosub, RefreshPopularMenus
	Gosub, RefreshRecentItemsMenus
	Gosub, RefreshDrivesMenu
}
ToolTip ; clear tooltip after refresh

Diag(A_ThisLabel, "", "STOP-SHOW") ; must be before Menu Show
SetWaitCursor(false) 

; o_FileManagers.CopyClassStructure() ; ####
Menu, % o_L["MainMenuName"], Show, %g_intMenuPosX%, %g_intMenuPosY% ; at mouse pointer if option 1, 20x20 offset of active window if option 2 and fix location if option 3

return
;------------------------------------------------------------


;------------------------------------------------------------
AlternativeHotkeyMouse:
AlternativeHotkeyKeyboard:
;------------------------------------------------------------

g_blnAlternativeMenu := true
g_strHotkeyTypeDetected := "Alternative"

SetTargetWinInfo(A_ThisLabel = "AlternativeHotkeyMouse")
Gosub, SetMenuPosition
Menu, menuAlternative, Show, %g_intMenuPosX%, %g_intMenuPosY%

return
;------------------------------------------------------------


;------------------------------------------------------------
SetMenuPosition:
;------------------------------------------------------------

; relative to active window if option o_Settings.MenuPopup.intPopupMenuPosition.IniValue = 2
CoordMode, Mouse, % (o_Settings.MenuPopup.intPopupMenuPosition.IniValue = 2 ? "Window" : "Screen")
CoordMode, Menu, % (o_Settings.MenuPopup.intPopupMenuPosition.IniValue = 2 ? "Window" : "Screen")

if (o_Settings.MenuPopup.intPopupMenuPosition.IniValue = 1) ; display menu near mouse pointer location
{
	MouseGetPos, g_intMenuPosX, g_intMenuPosY
	if (g_blnLaunchFromTrayIcon)
	{
		SysGet, intMonitorWorkArea, MonitorWorkArea
		if (g_intMenuPosY > intMonitorWorkAreaBottom - 5)
			g_intMenuPosY := intMonitorWorkAreaBottom - 5
	}
}
else if (o_Settings.MenuPopup.intPopupMenuPosition.IniValue = 2) ; display menu at an offset of 20x20 pixel from top-left of active window area
{
	g_intMenuPosX := 20
	g_intMenuPosY := 20
}
else ; (o_Settings.MenuPopup.intPopupMenuPosition.IniValue =  3) - fix position - use the g_intMenuPosX and g_intMenuPosY values from the ini file
{
	g_intMenuPosX := o_Settings.MenuPopup.arrPopupFixPosition.IniValue[1]
	g_intMenuPosY := o_Settings.MenuPopup.arrPopupFixPosition.IniValue[2]
}

intMonitorWorkArea := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
CanNavigate(strMouseOrKeyboard) ; SEE HotkeyIfWin.ahk to use Hotkey, If, Expression
; "CabinetWClass" and "ExploreWClass" -> Explorer
; "ProgMan" -> Desktop
; "WorkerW" -> Desktop
; "ConsoleWindowClass" -> Console (CMD) or PowerShell
; "#32770" -> Dialog
; "bosa_sdm_" (...) -> Dialog MS Office under WinXP
;------------------------------------------------------------
{
	global ; sets g_strTargetWinId, g_strTargetControl, g_strTargetClass

	; Mouse hotkey (.P_strAhkHotkey is NavigateOrLaunchHotkeyMouse value in ini file)
	SetTargetWinInfo(strMouseOrKeyboard = o_PopupHotkeyNavigateOrLaunchHotkeyMouse.P_strAhkHotkey)

	blnCanNavigate := WindowIsExplorer(g_strTargetClass) or WindowIsConsole(g_strTargetClass)
		or (o_Settings.MenuPopup.blnChangeFolderInDialog.IniValue and WindowIsDialog(g_strTargetClass, g_strTargetWinId) and !DialogBoxParentExcluded(g_strTargetWinId))
		or (o_FileManagers.P_intActiveFileManager = 2 and WindowIsDirectoryOpus(g_strTargetClass))
		or (o_FileManagers.P_intActiveFileManager = 3 and WindowIsTotalCommander(g_strTargetClass))
		or (o_FileManagers.P_intActiveFileManager = 4 and WindowIsQAPconnect(g_strTargetWinId))
		or WindowIsQuickAccessPopup(g_strTargetClass)

	; check if we will show the "change folder alert" before opening the selected favorite, if the favorite is a folder
	if (!o_Settings.MenuPopup.blnChangeFolderInDialog.IniValue and WindowIsDialog(g_strTargetClass, g_strTargetWinId))
	{
		blnChangeFolderInDialogAlertRead := o_Settings.ReadIniValue("ChangeFolderInDialogAlertRead", 0)
		g_blnShowChangeFolderInDialogAlert := !(blnChangeFolderInDialogAlertRead)
	}
	else
		g_blnShowChangeFolderInDialogAlert := false
	
	return blnCanNavigate
}
;------------------------------------------------------------


;------------------------------------------------------------
CanLaunch(strMouseOrKeyboard) ; SEE HotkeyIfWin.ahk to use Hotkey, If, Expression
;------------------------------------------------------------
{
	global

	if (strMouseOrKeyboard = o_PopupHotkeyNavigateOrLaunchHotkeyMouse.P_strAhkHotkey) ; if hotkey is mouse
		Loop, Parse, % o_Settings.MenuPopup.strExclusionMouseList.strExclusionMouseListApp, |
			if StrLen(A_Loopfield)
				and (InStr(g_strTargetClass, A_LoopField)
				or InStr(g_strTargetWinTitle, A_LoopField)
				or InStr(g_strTargetProcessName, A_LoopField))
				return false

	if WindowIsTray(g_strTargetClass)
		return o_Settings.MenuPopup.blnOpenMenuOnTaskbar.IniValue

	if WindowIsTreeview(g_strTargetWinId)
		return false
	
	if WindowIsDialog(g_strTargetClass, g_strTargetWinId) and DialogBoxParentExcluded(g_strTargetWinId)
		return false
	
	; else we can launch

	return true
}
;------------------------------------------------------------


;------------------------------------------------------------
DialogBoxParentExcluded(strTargetWinId)
;------------------------------------------------------------
{
	; get specified window's parent ID
	; from SKAN https://autohotkey.com/board/topic/27295-getting-id-or-class-for-parent-window/#entry175515
	strParentTargetWinId := DllCall("GetParent", UInt,strTargetWinId)
	strParentTargetWinId := (!strParentTargetWinId ? strTargetWinId : strParentTargetWinId)
	
	; get parent window's class and title
	WinGetClass, strParentClass, ahk_id %strParentTargetWinId%
	WinGetTitle, strParentTitle, ahk_id %strParentTargetWinId%
	WinGet, strProcessName, ProcessName, ahk_id %strParentTargetWinId%

	; check for class or title in dialog's parent exclusion list
	Loop, Parse, % o_Settings.MenuPopup.strExclusionMouseList.strExclusionMouseListDialog, |
		if StrLen(A_Loopfield)
			and (InStr(strParentClass, A_LoopField)
			or InStr(strParentTitle, A_LoopField)
			or InStr(strProcessName, A_LoopField))
			return true

	return false
}
;------------------------------------------------------------



;========================================================================================================================
; END OF POPUP MENU
;========================================================================================================================



;========================================================================================================================
!_065_CLASS:
return
;========================================================================================================================

;------------------------------------------------------------
WindowIsExplorer(strClass)
;------------------------------------------------------------
{
	return (strClass = "CabinetWClass") or (strClass = "ExploreWClass")
}
;------------------------------------------------------------


;------------------------------------------------------------
WindowIsDesktop(strClass)
;------------------------------------------------------------
{
	; global g_blnClickOnTrayIcon
	
	; blnWindowIsDesktop := (strClass = "ProgMan")
	;	or (strClass = "WorkerW")
	;	or (strClass = "Shell_TrayWnd" and (o_Settings.MenuPopup.blnOpenMenuOnTaskbar.IniValue or g_blnClickOnTrayIcon))
	;	or (strClass = "NotifyIconOverflowWindow")
	; ###_V("WindowIsDesktop", strClass, o_Settings.MenuPopup.blnOpenMenuOnTaskbar.IniValue, g_blnClickOnTrayIcon, blnWindowIsDesktop)

	; g_blnClickOnTrayIcon := false
	; g_blnClickOnTrayIcon was turned on by AHK_NOTIFYICON
	; turn it off to avoid further clicks on taskbar to be accepted if o_Settings.MenuPopup.blnOpenMenuOnTaskbar.IniValue is off

	return (strClass = "ProgMan") or (strClass = "WorkerW")
}
;------------------------------------------------------------


;------------------------------------------------------------
WindowIsTray(strClass)
;------------------------------------------------------------
{
	return (strClass = "Shell_TrayWnd") or (strClass = "NotifyIconOverflowWindow")
}
;------------------------------------------------------------


;------------------------------------------------------------
WindowIsConsole(strClass)
;------------------------------------------------------------
{
	return (strClass = "ConsoleWindowClass")
}
;------------------------------------------------------------


;------------------------------------------------------------
WindowIsDialog(strClass, strWinId)
;------------------------------------------------------------
{
	return (strClass = "#32770") and !WindowIsTreeview(strWinId) and DialogHasRequiredControle(strWinId)
}
;------------------------------------------------------------


;------------------------------------------------------------
DialogHasRequiredControle(strWinId)
; Disable popup menu in dialog boxes when its controls list does not fullfil these conditions:
; include ("Edit1" or "Edit2") and ("ToolBarWindow32" or "SysListView32" or "SysTreeView32" or "DirectUIHWND") and ("Button")
; Thanks to research by Helge Kraak
;------------------------------------------------------------
{
	WinGet, strControlsList, ControlList, ahk_id %strWinId%
	
	return (InStr(strControlsList, "Edit1") or InStr(strControlsList, "Edit2"))
		and (InStr(strControlsList, "ToolBarWindow32") or InStr(strControlsList, "SysListView32") or InStr(strControlsList, "SysTreeView32") or InStr(strControlsList, "DirectUIHWND"))
		and InStr(strControlsList, "Button")
}
;------------------------------------------------------------


;------------------------------------------------------------
WindowIsTreeview(strWinId)
; Disable popup menu in folder select dialog boxes (like those displayed by FileSelectFolder)
; because their Edit1 control does not react as expected in NavigateDialog.
; Signature: contains both SysTreeView321 and SHBrowseForFolder controls (tested on Win7 only)
; but NOT 100% sure this is a unique signature...
;------------------------------------------------------------
{
	WinGet, strControlsList, ControlList, ahk_id %strWinId%
	blnIsTreeView := InStr(strControlsList, "SysTreeView321") and InStr(strControlsList, "SHBrowseForFolder")
	if (blnIsTreeView)
	{
		TrayTip, % o_L["WindowIsTreeviewTitle"], % o_L["WindowIsTreeviewText"], , 18 ; 2 warning icon + 16 no sound
		Sleep, 20 ; tip from Lexikos for Windows 10 "Just sleep for any amount of time after each call to TrayTip" (http://ahkscript.org/boards/viewtopic.php?p=50389&sid=29b33964c05f6a937794f88b6ac924c0#p50389)
	}
	
	return blnIsTreeView
}
;------------------------------------------------------------


;------------------------------------------------------------
WindowIsDirectoryOpus(strClass)
;------------------------------------------------------------
{
	return InStr(strClass, "dopus")
}
;------------------------------------------------------------


;------------------------------------------------------------
WindowIsTotalCommander(strClass)
;------------------------------------------------------------
{
	return InStr(strClass, "TTOTAL_CMD")
}
;------------------------------------------------------------


;------------------------------------------------------------
WindowIsQAPconnect(strWinId)
;------------------------------------------------------------
{
	; global g_strQAPconnectAppFilename
	; global g_strQAPconnectCompanionFilename

	if (strWinId = 0)
		return false

	; get path and filename of the app controling window strWinId
	; first get process ID
    intPID := 0
    DllCall("GetWindowThreadProcessId", "UInt", strWinId, "UInt *", intPID)
	; get filename of process
    hProcess := DllCall("OpenProcess", "UInt", 0x400 | 0x10, "Int", False, "UInt", intPID)
    intPathLength = 260*2
    VarSetCapacity(strFCAppFile, intPathLength, 0)
    DllCall("Psapi.dll\GetModuleFileNameExW", "UInt", hProcess, "Int", 0, "Str", strFCAppFile, "UInt", intPathLength)
    DllCall("CloseHandle", "UInt", hProcess)
	
	; get filename only and compare with QAPconnect filename or QAPconnect target filename (see QAPconnect doc)
	SplitPath, strFCAppFile, strFCAppFile
	return (strFCAppFile = g_aaFileManagerQAPconnect.strQAPconnectAppFilename) or (strFCAppFile = g_aaFileManagerQAPconnect.strQAPconnectCompanionFilename)
}
;------------------------------------------------------------


;------------------------------------------------------------
WindowIsQuickAccessPopup(strClass)
; enabled only when compiled
;------------------------------------------------------------
{
	return (strClass = "JeanLalonde.ca")
}
;------------------------------------------------------------


;========================================================================================================================
; END OF CLASS
;========================================================================================================================



;========================================================================================================================
!_070_MENU_ACTIONS:
;========================================================================================================================

;------------------------------------------------------------
OpenAlternativeMenu:
; remember the Alternative menu item to execute and open the popup menu to choose on what favorite execute this action
;------------------------------------------------------------
 
g_strAlternativeMenu := A_ThisMenuItem
if (o_Settings.Menu.blnDisplayNumericShortcuts.IniValue)
	g_strAlternativeMenu := SubStr(g_strAlternativeMenu, 4) ; remove "&1 " from menu item
if (o_Settings.Menu.intHotkeyReminders.IniValue > 1)
	if (o_Settings.Menu.blnHotkeyRemindersRightAlign.IniValue) and InStr(g_strAlternativeMenu, "`t")
		g_strAlternativeMenu := SubStr(g_strAlternativeMenu, 1, InStr(g_strAlternativeMenu, "`t")) ; and remove hotkey reminder from tab
	else if InStr(g_strAlternativeMenu, " (")
		; InStr 0 param to search from the end, allowing the name to include " ("
		g_strAlternativeMenu := SubStr(g_strAlternativeMenu, 1, InStr(g_strAlternativeMenu, " (", , 0) - 1) ; and remove hotkey reminder from " ("

gosub, OpenAlternativeMenuTrayTip
gosub, LaunchFromAlternativeMenu

return
;------------------------------------------------------------


;------------------------------------------------------------
OpenAlternativeMenuHotkey:
;------------------------------------------------------------

if (g_blnChangeShortcutInProgress or g_blnChangeHotstringInProgress)
	return

; search Alternative menu code in o_QAPfeatures.AA to set g_strAlternativeMenu with localized name and gosub LaunchFromAlternativeMenu
g_strAlternativeMenu := ""
for intOrder, strCode in o_QAPfeatures.saQAPFeaturesAlternativeCodeByOrder
	if (o_QAPfeatures.AA[strCode].strCurrentHotkey = A_ThisHotkey)
	{
; .strLocalizedName OK because Alternative
		g_strAlternativeMenu := o_QAPfeatures.AA[strCode].strLocalizedName
		break
	}

if StrLen(g_strAlternativeMenu)
{
	gosub, OpenAlternativeMenuTrayTip
	gosub, LaunchFromAlternativeMenu
}
else
	Oops("QAP feature could not be found...")

OpenAlternativeMenuHotkeyCleanup:
intOrder := ""
strCode := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
OpenAlternativeMenuTrayTip:
;------------------------------------------------------------

if !(o_Settings.MenuPopup.blnAlternativeMenuShowNotification.IniValue)
	return

if (g_strAlternativeMenu = o_L["MenuCopyLocation"])
	strMessage := o_L["AlternativeMenuTrayTipCopyLocation"]
else if (g_strAlternativeMenu = o_L["MenuAlternativeNewWindow"])
	strMessage := o_L["AlternativeMenuTrayTipNewWindow"]
else if (g_strAlternativeMenu = o_L["MenuAlternativeEditFavorite"])
	strMessage := o_L["AlternativeMenuTrayTipEditFavorite"]
else if (g_strAlternativeMenu = o_L["MenuAlternativeRunAs"])
	strMessage := o_L["AlternativeMenuTrayTipRunAs"]
else if (g_strAlternativeMenu = o_L["MenuAlternativeOpenContainingCurrent"]) or (g_strAlternativeMenu = o_L["MenuAlternativeOpenContainingNew"])
	strMessage := o_L["AlternativeMenuTrayTipOpenContaining"]
else
	strMessage := ""

TrayTip, %g_strAppNameText%, %strMessage%, , 17 ; 1 info icon + 16 no sound
Sleep, 20 ; tip from Lexikos for Windows 10 "Just sleep for any amount of time after each call to TrayTip" (http://ahkscript.org/boards/viewtopic.php?p=50389&sid=29b33964c05f6a937794f88b6ac924c0#p50389)

strMessage := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
OpenGroupOfFavoritesCloseExplorers:
;------------------------------------------------------------

intSleepTime := 67 ; for visual effect only...
ToolTip, % o_L["GuiGroupClosing"]

if (g_arrGroupSettingsOpen2 = "Other")
{
	if (o_FileManagers.P_intActiveFileManager = 2) ; Directory Opus
	{
		WinGet, arrIDs, List, ahk_class dopus.lister
		Loop, %arrIDs%
		{
			WinClose, % "ahk_id " . arrIDs%A_Index%
			Sleep, %intSleepTime%
		}
	}
	else if (o_FileManagers.P_intActiveFileManager = 3) ; Total Commander
	{
		WinGet, arrIDs, List, ahk_class TTOTAL_CMD
		Loop, %arrIDs%
		{
			WinClose, % "ahk_id " . arrIDs%A_Index%
			Sleep, %intSleepTime%
		}
	}
}
else ; g_arrGroupSettingsOpen2 = "Windows Explorer" or ""
{
	strWindowsId := ""
	for pExplorer in ComObjCreate("Shell.Application").Windows
	{
		; do not close in this loop as it mess up the handlers
		strType := ""
		try strType := pExplorer.Type ; Gets the type name of the contained document object. "Document HTML" for IE windows. Should be empty for file Explorer windows.
		strWindowID := ""
		try strWindowID := pExplorer.HWND ; Try to get the handle of the window. Some ghost Explorer in the ComObjCreate may return an empty handle
		if !StrLen(strType) and StrLen(strWindowID) ; strType must be empty and strWindowID must not be empty
			strWindowsId .= pExplorer.HWND . "|"
	}
	strWindowsId := SubStr(1, -1) ; remove last | separator
	Loop, Parse, strWindowsId, |
	{
		WinClose, ahk_id %A_LoopField%
		Sleep, %intSleepTime%
	}
}

ToolTip ; clear tooltip

intSleepTime := ""
strWindowsId := ""
pExplorer := ""
ResetArray("arrIDs")

return
;------------------------------------------------------------


;-----------------------------------------------------------
RepeatLastAction:
RepeatLastActionShortcut:
;-----------------------------------------------------------

if (o_Settings.Menu.blnDisplayNumericShortcuts.IniValue)
	strThisMenuItem := SubStr(A_ThisMenuItem, 4) ; remove "&1 " from menu item
else
	strThisMenuItem :=  A_ThisMenuItem

if (A_ThisLabel = "RepeatLastActionShortcut" ; Repeat Last Action shortcut
	or SubStr(strThisMenuItem, 1, StrLen(o_L["MenuLastAction"])) = o_L["MenuLastAction"]) ; menu item is "Repeat Last Action" (stripping shortcut from label)
	; use first item from g_strLastActionsOrderedKeys
	g_strLastActionRepeated := SubStr(g_strLastActionsOrderedKeys, 1, InStr(g_strLastActionsOrderedKeys, "`n") - 1)
else ; item from the Repeat Last Actions menu
	g_strLastActionRepeated := strThisMenuItem

o_ThisFavorite := g_aaLastActions[g_strLastActionRepeated]
o_ThisFavorite.AA.blnFavoritePseudo := true ; this is not a real favorite, it could not be edited if not found

gosub, OpenFavoriteFromLastAction

strThisMenuItem := ""

return
;-----------------------------------------------------------


;------------------------------------------------------------
OpenFavorite:
OpenFavoriteFromShortcut:
OpenFavoriteFromLastAction:
OpenReopenFolder:
OpenDrives:
OpenFavoriteHotlist:
OpenDOpusFavorite:
OpenDOpusLayout:
OpenReopenCurrentFolder:
OpenReopenInNewWindow:
OpenFavoriteFromHotstring:
OpenWorkingDirectory:
OpenSwitchFolderOrApp:
;------------------------------------------------------------

if (g_blnChangeShortcutInProgress or g_blnChangeHotstringInProgress)
 	return

g_strOpenFavoriteLabel := A_ThisLabel
g_strNewWindowId := "" ; start fresh for any new favorite to open, used to position Explorer and Total Commander windows only

; avoid conflict with hotkeys and avoid editing menu items not in favorites list
if InStr("OpenFavorite|OpenFavoriteFromLastAction", g_strOpenFavoriteLabel)
{
	blnShiftPressed := GetKeyState("Shift")
	blnControlPressed := GetKeyState("Control")
}
else
{
	blnShiftPressed := false
	blnControlPressed := false
}

if InStr("OpenFavoriteFromShortcut|OpenFavoriteFromHotstring|", g_strOpenFavoriteLabel . "|") ; include end marker
{
	if SettingsUnsaved()
		if SettingsNotSavedReturn()
			return

	g_strTargetWinId := "" ; forget value from previous open favorite
}

if (A_ThisLabel <> "OpenFavoriteFromLastAction") ; we already have o_ThisFavorite from RepeatLastAction
	gosub, OpenFavoriteGetFavoriteObject ; define o_ThisFavorite

if !IsObject(o_ThisFavorite) ; OpenFavoriteGetFavoriteObject was aborted
	or (o_ThisFavorite.AA.strFavoriteType = "Folder") and !StrLen(o_ThisFavorite.AA.strFavoriteLocation) ; no current location found
{
	gosub, OpenFavoriteCleanup
	return
}

; before opening the favorite, check if we show the "change folder alert" before opening the selected favorite, if the favorite is a folder or special
if (g_blnShowChangeFolderInDialogAlert and InStr("Folder|Special", o_ThisFavorite.AA.strFavoriteType))
{
	MsgBox, 52, %g_strAppNameText%, % o_L["OopsChangeFolderInDialogAlert"]
	IfMsgBox, Yes
	{
		gosub, GuiOptionsGroupGeneral
		return
	}
	IfMsgBox, No
		IniWrite, 1, % o_Settings.strIniFile, Global, ChangeFolderInDialogAlertRead
}

; process Alternative features keyboard modifiers
if (blnShiftPressed or blnControlPressed)
{
	g_blnAlternativeMenu := true
	g_strHotkeyTypeDetected := "Alternative"
	
	if (blnShiftPressed and blnControlPressed) ; as if user selected o_L["MenuAlternativeEditFavorite"] in Alternative menu
		g_strAlternativeMenu := o_L["MenuAlternativeEditFavorite"]
	else if (blnShiftPressed) ; as if user selected o_L["MenuAlternativeNewWindow"] in Alternative menu
		g_strAlternativeMenu := o_L["MenuAlternativeNewWindow"]
	else ; blnControlPressed as if user selected o_L["MenuCopyLocation"] in Alternative menu
		g_strAlternativeMenu := o_L["MenuCopyLocation"]
}

; collect last actions
if !(g_blnAlternativeMenu) ; do not collect Alternative menu features
	gosub, CollectLastActions ; update g_aaLastActions

; always navigate
if (o_Settings.FileManagers.blnAlwaysNavigate.IniValue and (g_strAlternativeMenu <> o_L["MenuAlternativeNewWindow"])
	and InStr("|Folder|Special|FTP", "|" . o_ThisFavorite.AA.strFavoriteType)
	and !WindowIsDialog(g_strTargetClass, g_strTargetWinId))
{
	; GetTargetWinIdAndClass(ByRef strThisId, ByRef strThisClass, blnActivate := false, blnExcludeDialogBox := false, blnIncludeBrowsers := false)
	GetTargetWinIdAndClass(g_strTargetWinId, g_strTargetClass, true, true) ; get and activate last used file manager
	g_strHotkeyTypeDetected := "Navigate"
}

; preparation for Alternative menu features before setting the full location
if (g_blnAlternativeMenu) and (g_strAlternativeMenu = o_L["MenuAlternativeNewWindow"])
{
	g_strTargetWinId := "" ; never use target window when launched from alternative menu with new window
	g_strHotkeyTypeDetected := "Launch"
}

; beginning of OpenFavorite execution

o_ThisFavorite.OpenFavorite(g_strMenuTriggerLabel, g_strOpenFavoriteLabel, g_strTargetWinId, g_strHotkeyTypeDetected)

OpenFavoriteCleanup:

o_ThisFavorite := ""
g_blnAlternativeMenu := ""
g_strAlternativeMenu := ""
blnShiftPressed := ""
blnControlPressed := ""
g_blnLaunchFromTrayIcon := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
OpenFavoriteGetFavoriteObject:
;------------------------------------------------------------

g_strLastActionRepeated := "" ; if we are here, we are not repeating an action, so kill this variable

if InStr("OpenFavoriteFromShortcut|OpenFavoriteFromHotstring|", g_strOpenFavoriteLabel . "|")
{
	o_ThisFavorite := (g_strOpenFavoriteLabel = "OpenFavoriteFromShortcut"
		? g_aaItemsByShortcut[A_ThisHotkey]
		: g_dicItemsByHotstring.Item(g_strHotstringOptionsSeparator . SubStr(A_ThisHotkey, 3))) ; remove "X" (g_strHotstringOptionsExecute) as first option (":X:trigger" or ":XC*:trigger")

	if !IsObject(o_ThisFavorite)
	{
		saShortcutHotstringLower := StrSplit(o_L["DialogHotkeysManageShortcutHotstringLower"], "|")
		SplitHotstring(A_ThisHotkey, strOopsTrigger, strHotstringOppsOptionsShort)
		Oops(o_L["OopsHotkeyObjectNotFound"]
			, g_strAppNameText
			, (g_strOpenFavoriteLabel = "OpenFavoriteFromShortcut" ? saShortcutHotstringLower[1] : saShortcutHotstringLower[2])
			, (g_strOpenFavoriteLabel = "OpenFavoriteFromShortcut" ? A_ThisHotkey : strOopsTrigger))
		return
	}
	
	if InStr("Menu|External", o_ThisFavorite.AA.strFavoriteType, true)
	; if favorite is a submenu, check if it is empty or if some of its items are QAP features needing to be refreshed
	{
		saMenu := o_ThisFavorite.AA.oSubMenu.SA
		if saMenu.MaxIndex() ; has items
		{
			loop, % saMenu.MaxIndex()
			; this scans only this menu, not its submenu - QAP features needing to be refreshed may be in submenu...
				if (saMenu[A_Index].AA.strFavoriteType = "QAP")
					if (saMenu[A_Index].AA.strFavoriteLocation = "{Clipboard}")
						Gosub, RefreshClipboardMenu
					else if InStr("{Switch Folder or App}|{Current Folders}", saMenu[A_Index].strFavoriteLocation)
						Gosub, RefreshSwitchFolderOrAppMenu
		}
		else
		{
			Oops(o_L["MenuMenu"] . " """ . o_ThisFavorite.AA.strFavoriteName . """ " . o_L["OopsEmpty"])
			o_ThisFavorite := ""
		}
	}

	if (g_strOpenFavoriteLabel = "OpenFavoriteFromHotstring")
	{
		g_strTargetWinId := "" ; never use target window when launched from hotstring
		g_strHotkeyTypeDetected := "Launch"
	}
	else if CanNavigate(A_ThisHotkey) ; update g_strTargetWinId
		g_strHotkeyTypeDetected := "Navigate"
	else if CanLaunch(A_ThisHotkey)
	{
		g_strTargetWinId := "" ; never use target window when launched from hotkey
		g_strHotkeyTypeDetected := "Launch"
	}
	else
	{
		gosub, OpenFavoriteGetFavoriteObjectCleanup
		return ; active window is on exclusion list
	}
}
else if InStr("OpenReopenCurrentFolder|OpenReopenInNewWindow|", g_strOpenFavoriteLabel . "|")
{
	if (g_strOpenFavoriteLabel = "OpenReopenCurrentFolder") ; reopen in dialog box
		; returns current or latest file manager window ID and Window class, excluding dialog boxes
		; GetTargetWinIdAndClass(ByRef strThisId, ByRef strThisClass, blnActivate := false, blnExcludeDialogBox := false, blnIncludeBrowsers := false)
		GetTargetWinIdAndClass(strReopenWindowsID, strReopenWindowClass, false, true) ; returns current or latest file manager window ID and Window class, so not activate, exclude dialog box
	else ; OpenReopenInNewWindow reopen from dialog box
	{
		; get location from current file dialog box
		strReopenWindowsID := g_strTargetWinId
		strReopenWindowClass := g_strTargetClass
		; open in a new window
		g_strTargetWinId := ""
		g_strTargetClass := ""
		g_strHotkeyTypeDetected := "Launch"
	}

	global o_ThisFavorite := new Container.Item(["Folder", "Name not displayed", GetCurrentLocation(strReopenWindowClass, strReopenWindowsID)])
	o_ThisFavorite.AA.blnFavoritePseudo := true
}
else if (g_strOpenFavoriteLabel = "OpenWorkingDirectory")
{
	; ; 1 strFavoriteType, 2 strFavoriteName, 3 strFavoriteLocation, 4 strFavoriteIconResource, 5 strFavoriteArguments, 6 strFavoriteAppWorkingDir,
	global o_ThisFavorite := new Container.Item(["Folder", o_L["MenuOpenWorkingDirectory"], A_WorkingDir])
	o_ThisFavorite.AA.blnFavoritePseudo := true ; this is not a real favorite, it could not be edited if not found
	g_strHotkeyTypeDetected := "Launch"
}
else
	o_ThisFavorite := GetFavoriteObjectFromMenuPosition(intMenuItemPos) ; was g_objThisFavorite

; pseudo favorite object, set an icon ressource for repeat actions menu
if (o_ThisFavorite.AA.blnFavoritePseudo)
	o_ThisFavorite.AA.strFavoriteIconResource := (o_ThisFavorite.AA.strFavoriteType = "Folder" ? GetFolderIcon(o_ThisFavorite.AA.strFavoriteLocation)
		: GetIcon4Location(o_ThisFavorite.AA.strFavoriteLocation))

OpenFavoriteGetFavoriteObjectCleanup:
saMenu := ""
strThisMenuItem := ""
strFavoriteType := ""
intMenuItemPos := ""
strThisNameLocation := ""
ResetArray("arrThisNameLocation")
strTempName := ""
strMenuPath := ""
strReopenWindowsID := ""
strReopenWindowClass := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GetSpecialFolderLocation(ByRef strHotkeyTypeDetected, ByRef strTargetName, aaItem)
;------------------------------------------------------------
{
	strLocation := aaItem.strFavoriteLocation ; make sure FavoriteLocation was not expanded by EnvVars
	aaSpecialFolder := o_SpecialFolders.AA[strLocation]
	
	if (strTargetName = "Explorer")
		strUse := aaSpecialFolder.strUse4NavigateExplorer
	else if (strTargetName = "Dialog")
		strUse := aaSpecialFolder.strUse4Dialog
	else if (strTargetName = "Console")
		strUse := aaSpecialFolder.strUse4Console
	else if (strTargetName = "DirectoryOpus")
		strUse := aaSpecialFolder.strUse4DOpus
	else if (strTargetName = "TotalCommander")
		strUse := aaSpecialFolder.strUse4TC
	else if (strTargetName = "QAPconnect")
		strUse := aaSpecialFolder.strUse4FPc
	else
		strUse := aaSpecialFolder.strUse4NewExplorer

	if (strUse = "NEW") ; re-assign values as if it was a new window request to be open in *Explorer*
	{
		strUse := aaSpecialFolder.strUse4NewExplorer
		strHotkeyTypeDetected := "Launch"
		strTargetName := "Explorer"
	}
	
	if (strUse = "CLS")
	{
		if (SubStr(strLocation, 1, 1) = "{")
			if (strTargetName = "TotalCommander")
				strLocation := "::" . strLocation
			else
				strLocation := "shell:::" . strLocation
		else ; expand strLocation
			strLocation := EnvVars(strLocation)			
	}
	else if (strUse = "AHK")
	{
		strAHKConstant := aaSpecialFolder.strAHKConstant ; for example "A_Desktop"
		strLocation := %strAHKConstant% ; the contant value, for example "C:\Users\jlalonde\Desktop"
	}
	else if (strUse = "DOA")
		strLocation := "/" . aaSpecialFolder.strDOpusAlias
	else if (strUse = "SCT")
		strLocation := "shell:" . aaSpecialFolder.strShellConstantText
	else if (strUse = "TCC")
		strLocation := aaSpecialFolder.strTCCommand
	else
	{
		Oops(o_L["OopsCouldNotOpenSpecialFolder"], strTargetName, strLocation)
		strLocation := ""
	}
	
	return strLocation
}
;------------------------------------------------------------



;------------------------------------------------------------
GetFavoriteObjectFromMenuPosition(ByRef intMenuItemPos)
;------------------------------------------------------------
{
	; o_L["MenuDrives"] added when testing new object model for dynamic menus
	; the +1 test for the back menu item will not be required after all menu are converted to the new object model
	GetNumberOfHiddenItemsBeforeThisItem(intColumnBreaksBeforeThisItem, intDisabledItemsBeforeThisItem)
	; #### no need to have 2 variables, the function could return the position in object

	intMenuItemPos := A_ThisMenuItemPos + intColumnBreaksBeforeThisItem + intDisabledItemsBeforeThisItem
	
	; return g_objMenusIndex[A_ThisMenu][intMenuItemPos]
	return o_Containers.AA[A_ThisMenu].SA[intMenuItemPos]
}
;------------------------------------------------------------


;------------------------------------------------------------
GetNumberOfHiddenItemsBeforeThisItem(ByRef intColumnBreaksBeforeThisItem, ByRef intDisabledItemsBeforeThisItem)
;------------------------------------------------------------
{
	intColumnBreaksBeforeThisItem := 0
	intDisabledItemsBeforeThisItem := 0
	
	Loop
	{
		if ((A_Index - intColumnBreaksBeforeThisItem - intDisabledItemsBeforeThisItem) > A_ThisMenuItemPos)
			break
		; else if (g_objMenusIndex[A_ThisMenu][A_Index + intMenuObjectItemOffset].FavoriteType = "K")
		else if (o_Containers.AA[A_ThisMenu].SA[A_Index].AA.strFavoriteType = "K")
			intColumnBreaksBeforeThisItem++
		; else if (g_objMenusIndex[A_ThisMenu][A_Index + intMenuObjectItemOffset].FavoriteDisabled)
		else if (o_Containers.AA[A_ThisMenu].SA[A_Index].AA.blnFavoriteDisabled)
			intDisabledItemsBeforeThisItem++
	}
}
;------------------------------------------------------------


;------------------------------------------------------------
CollectLastActions:
; add opened favorite to last actions and update g_strLastActionsOrderedKeys
;------------------------------------------------------------

if (o_ThisFavorite.AA.strFavoriteName = o_L["MenuLastAction"]) ; do not collect QAP feature Repeat Last Action
	or (o_ThisFavorite.AA.strFavoriteName = o_L["MenuLastActions"]) ; do not collect QAP feature Repeat Last Actions
	or (o_ThisFavorite.AA.strFavoriteType = "Text") ; do not collect text separators
	return

if StrLen(g_strLastActionRepeated) ; we are repeating an action
{
	o_NewLastAction := g_aaLastActions[g_strLastActionRepeated]
	strLastActionLabel := g_strLastActionRepeated
}
else
{
	global o_NewLastAction := new Container.Item([])
	o_NewLastAction := o_ThisFavorite.Backup()
	strLastActionLabel := RemoveSingleAmpersand(A_ThisMenu . " > " . o_ThisFavorite.AA.strFavoriteName) ; double ampersand in menu item name
}
o_NewLastAction.AA.strOpenTimeStamp := A_Now

; insert in g_aaLastActions
if g_aaLastActions.HasKey(strLastActionLabel)
	g_aaLastActions.Delete(strLastActionLabel) ; kill previous item for this key
g_aaLastActions[strLastActionLabel] := o_NewLastAction ; this overwrites older item with same key

strLastActionsOrdered := ""
for strLastActionLabel, o_LastAction in g_aaLastActions
	strLastActionsOrdered .= o_LastAction.AA.strOpenTimeStamp . g_strEscapePipe . strLastActionLabel . "`n"

Sort, strLastActionsOrdered, R

g_strLastActionsOrderedKeys := ""
loop, parse, strLastActionsOrdered, `n
{
	if !StrLen(A_LoopField)
		break
	strThisLastActionKey := SubStr(A_LoopField, InStr(A_LoopField, g_strEscapePipe) + StrLen(g_strEscapePipe))
	if (A_Index > o_Settings.Menu.intNbLastActions.IniValue)
		g_aaLastActions.Delete(strThisLastActionKey) ; kill older items
	else
		g_strLastActionsOrderedKeys .= SubStr(strThisLastActionKey, 1) . "`n"
}

strLastActionLabel := ""
strLastActionsOrdered := ""
objLastAction := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GetWinInfo:
;------------------------------------------------------------

g_blnGetWinInfo := true

MsgBox, % 64 + 4096, % g_strAppNameText . " - " . o_L["MenuGetWinInfo"], % L(o_L["DialogGetWinInfo"], new Triggers.HotkeyParts(o_PopupHotkeyNavigateOrLaunchHotkeyMouse.P_strAhkHotkey).Hotkey2Text())

return
;------------------------------------------------------------


;------------------------------------------------------------
GetWinInfo2Clippoard:
;------------------------------------------------------------

g_blnGetWinInfo := ""
WinClose, % g_strAppNameText . " - " . o_L["MenuGetWinInfo"]

MsgBox, 4, % g_strAppNameText . " - " . o_L["MenuGetWinInfo"], % L(o_L["DialogGetWinInfo2Clippoard"], g_strTargetWinTitle, g_strTargetClass, g_strTargetProcessName)

IfMsgBox, Yes
	Clipboard := g_strTargetWinTitle . "`r`n" . g_strTargetClass . "`r`n" . g_strTargetProcessName

return
;------------------------------------------------------------


;------------------------------------------------------------
CloseComputerControl:
;------------------------------------------------------------

strGuiTitle := o_L["DialogCloseComputerControl"] . " - " . g_strAppNameText . " " . g_strAppVersion
Gui, CloseComputer:New, +Hwndg_strGui3Hwnd, %strGuiTitle%
Gui, CloseComputer:+OwnDialogs
if (g_blnUseColors)
	Gui, CloseComputer:Color, %g_strGuiWindowColor%

Gui, Font, w700
Gui, CloseComputer:Add, Text, x10 w520, % o_L["DialogCloseComputerControl"]
Gui, Font

Gui, CloseComputer:Add, Radio, x10 y+15 w250 gCloseComputerComboClicked vf_CloseComputerA9, % o_L["DialogCloseComputerPowerDown"] ; 9 = 1 shutdown + 8 power down
Gui, CloseComputer:Add, Radio, x10 y+5 w250 gCloseComputerComboClicked vf_CloseComputerA1, % o_L["DialogCloseComputerShutdown"]
Gui, CloseComputer:Add, Radio, x10 y+5 w250 gCloseComputerComboClicked vf_CloseComputerA2, % o_L["DialogCloseComputerRestart"]
Gui, CloseComputer:Add, Radio, x10 y+5 w250 gCloseComputerComboClicked vf_CloseComputerA0, % o_L["DialogCloseComputerLogoff"]

Gui, CloseComputer:Add, Radio, x10 y+10 w250 gCloseComputerComboClicked vf_CloseComputerBSuspend section, % o_L["DialogCloseComputerSuspend"]
Gui, CloseComputer:Add, Radio, x10 y+5 w250 gCloseComputerComboClicked vf_CloseComputerBHibernate, % o_L["DialogCloseComputerHibernate"]

Gui, CloseComputer:Add, Radio, x10 y+10 w250 gCloseComputerComboClicked vf_CloseComputerMonitorTurnOff, % o_L["DialogCloseComputerMonitorTurnOff"]
Gui, CloseComputer:Add, Radio, x10 y+5 w250 gCloseComputerComboClicked vf_CloseComputerMonitorLowPower, % o_L["DialogCloseComputerMonitorLowPower"]
Gui, CloseComputer:Add, Radio, x10 y+5 w250 gCloseComputerComboClicked vf_CloseComputerStartScreenSaver, % o_L["DialogCloseComputerStartScreenSaver"]

Gui, CloseComputer:Add, Checkbox, x270 ys w250 vf_CloseComputerSuspendImmediately disabled, % o_L["DialogCloseComputerSuspendImmediately"]
Gui, CloseComputer:Add, Checkbox, x270 y+5 w250 vf_CloseComputerDisableWakeEvents disabled, % o_L["DialogCloseComputerDisableWakeEvents"]
GuiControlGet, arrGroup1Pos, Pos, f_CloseComputerA9
Gui, CloseComputer:Add, Checkbox, x270 y%arrGroup1PosY% w250 vf_CloseComputerForce disabled, % o_L["DialogCloseComputerForce"]

GuiControlGet, arrGroupLastPos, Pos, f_CloseComputerStartScreenSaver
Gui, CloseComputer:Add, Button, % "x10 y" . arrGroupLastPosY + 25 . " gCloseComputerGuiGo vf_btnCloseComputerGo default", % o_L["DialogCloseComputerGo"]
Gui, CloseComputer:Add, Button, x10 yp gCloseComputerGuiEscape vf_btnCloseComputerCancel, % o_L["DialogCancelButton"]
Gui, CloseComputer:Add, Text, y+10

GuiCenterButtons(strGuiTitle, 20, 10, , "f_btnCloseComputerGo", "f_btnCloseComputerCancel")

CalculateTopGuiPosition(g_strGui3Hwnd, g_strAppHwnd, intX, intY)
Gui, CloseComputer:Show, AutoSize x%intX% y%intY%

ResetArray("arrGroup1Pos")
ResetArray("arrGroupLastPos")
intX := ""
intY := ""
strGuiTitle := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
CloseComputerComboClicked:
;------------------------------------------------------------

GuiControl, % (InStr(A_GuiControl, "f_CloseComputerA") ? "Enable" : "Disable"), f_CloseComputerForce
GuiControl, % (InStr(A_GuiControl, "f_CloseComputerB") ? "Enable" : "Disable"), f_CloseComputerSuspendImmediately
GuiControl, % (InStr(A_GuiControl, "f_CloseComputerB") ? "Enable" : "Disable"), f_CloseComputerDisableWakeEvents

strCloseComputerControlSelected := A_GuiControl

return
;------------------------------------------------------------


;------------------------------------------------------------
CloseComputerGuiGo:
CloseComputerGuiEscape:
;------------------------------------------------------------
Gui, CloseComputer:Submit, NoHide

intShutdownParameter := 0

if (A_ThisLabel = "CloseComputerGuiGo")
{
	if !StrLen(strCloseComputerControlSelected)
	{
		Oops(o_L["DialogCloseComputerPrompt"])
		return
	}
	
	if InStr(strCloseComputerControlSelected, "f_CloseComputerA")
	{
		intShutdownParameter := StrReplace(strCloseComputerControlSelected, "f_CloseComputerA")
		Shutdown, % intShutdownParameter + (f_CloseComputerForce * 4) ; 0 Logoff, 1 Shutdown, 2 Reboot, 8 Power down (9 Shutdown + Power down), add 4 to Force
	}
	else if InStr(strCloseComputerControlSelected, "f_CloseComputerB")
	{
		DllCall("PowrProf\SetSuspendState"
			, "int", (strCloseComputerControlSelected = "f_CloseComputerBHibernate") ; 0 suspend or 1 hibernate
			, "int", f_CloseComputerSuspendImmediately ; 1 suspend immediately
			, "int", f_CloseComputerDisableWakeEvents) ; 1 disable all wake events
	}
	else
	{
		Sleep, 1000 ; make sure no key release would wake up the monitor again
		if InStr(strCloseComputerControlSelected, "f_CloseComputerMonitor")
			SendMessage, 0x112, 0xF170
				, (strCloseComputerControlSelected = "f_CloseComputerMonitorTurnOff" ? 2 : 1) ; 1 low-power, 2 turn off
				, , Program Manager  ; 0x112 is WM_SYSCOMMAND, 0xF170 is SC_MONITORPOWER.
		else if (strCloseComputerControlSelected = "f_CloseComputerStartScreenSaver")
			; start the user's chosen screen saver
			SendMessage, 0x112, 0xF140, 0, , Program Manager  ; 0x112 is WM_SYSCOMMAND, and 0xF140 is SC_SCREENSAVE.
	}
}

Gui, CloseComputer:Destroy

strCloseComputerControlSelected := ""
intShutdownParameter := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
ShutdownComputer:
PowerDownComputer:
RestartComputer:
LogoffComputer:
SuspendComputer:
HibernateComputer:
TurnOffMonitorComputer:
LowPowerMonitorComputer:
StartScreenSaverComputer:
;------------------------------------------------------------

if (A_ThisLabel = "ShutdownComputer")
	strPrompt := o_L["DialogCloseComputerShutdown"]
else if (A_ThisLabel = "PowerDownComputer")
	strPrompt := o_L["DialogCloseComputerPowerDown"]
else if (A_ThisLabel = "RestartComputer")
	strPrompt := o_L["DialogCloseComputerRestart"]
else if (A_ThisLabel = "LogoffComputer")
	strPrompt := o_L["DialogCloseComputerLogoff"]

strPrompt := StrReplace(strPrompt, "&")
strPrompt .= "?"

if InStr("ShutdownComputer|PowerDownComputer|RestartComputer|LogoffComputer", A_ThisLabel)
{
	MsgBox, 4, %g_strAppNameText%, %strPrompt%
	IfMsgBox, Yes
		Shutdown, % (A_ThisLabel = "ShutdownComputer" ? 1 ; Shutdown 1
			: (A_ThisLabel = "PowerDownComputer" ? 8+1 ; Power down 8 + Shutdown 1
			: (A_ThisLabel = "RestartComputer" ? 2 : 0))) ; Logoff 0, Reboot 2
}
else if InStr("SuspendComputer|HibernateComputer", A_ThisLabel)
	{
		DllCall("PowrProf\SetSuspendState"
			, "int", (A_ThisLabel = "HibernateComputer") ; 0 suspend or 1 hibernate
			, "int", 0 ; 1 suspend immediately
			, "int", 0) ; 1 disable all wake events
	}
else ; TurnOffMonitorComputer, LowPowerMonitorComputer or StartScreenSaverComputer
{
	Sleep, 1000 ; make sure no key release would wake up the monitor again
	if InStr("TurnOffMonitorComputer|LowPowerMonitorComputer", A_ThisLabel)
		SendMessage, 0x112, 0xF170
			, (A_ThisLabel = "TurnOffMonitorComputer" ? 2 : 1) ; 1 low-power, 2 turn off
			, , Program Manager  ; 0x112 is WM_SYSCOMMAND, 0xF170 is SC_MONITORPOWER.
	else ; StartScreenSaverComputer
		; start the user's chosen screen saver
		SendMessage, 0x112, 0xF140, 0, , Program Manager  ; 0x112 is WM_SYSCOMMAND, and 0xF140 is SC_SCREENSAVE.
}

strPrompt := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
CloseAllWindows:
;------------------------------------------------------------

strGuiTitle := o_L["DialogCloseAllWindows"] . " - " . g_strAppNameText . " " . g_strAppVersion
Gui, CloseAllWindows:New, +Hwndg_strGui3Hwnd, %strGuiTitle%
Gui, CloseAllWindows:+OwnDialogs
if (g_blnUseColors)
	Gui, CloseAllWindows:Color, %g_strGuiWindowColor%

Gui, Font, w700
Gui, CloseAllWindows:Add, Text, w640, % o_L["DialogCloseAllWindows"]
Gui, Font
Gui, CloseAllWindows:Add, Text, w640, % o_L["DialogCloseAllWindowsIntro"]
Gui, CloseAllWindows:Add, Button, x10 y+20 gCloseAllWindowsSelectAll vf_btnCloseAllWindowsSelectAll, % o_L["DialogCloseAllWindowsSelectAll"]
Gui, CloseAllWindows:Add, ListView, % "vf_lvCloseAllWindows Count32 Checked " . (g_blnUseColors ? "c" . g_strGuiListviewTextColor . " Background" . g_strGuiListviewBackgroundColor : "") 
	. " gCloseAllWindowsListEvents x10 y+20 w640 h340 AltSubmit", % o_L["DialogCloseAllWindowsHeader"] . "|ID|Window Process Path"
LV_ModifyCol(2, 0)
LV_ModifyCol(3, 0)

Gui, CloseAllWindows:Add, Text
Gui, CloseAllWindows:Add, Button, x10 gCloseAllWindowsCloseButton vf_btnCloseAllWindowsClose, % o_L["DialogCloseAllWindowsClose"]
Gui, CloseAllWindows:Add, Button, x+20 yp gCloseAllWindowsGuiEscape vf_btnCloseAllWindowsCancel, % o_L["DialogCancelButton"]
Gui, CloseAllWindows:Add, Button, gCloseAllWindowsEnter Hidden Default, Enter
Gui, CloseAllWindows:Add, Text

DetectHiddenWindows, Off
WinGet, strWinIDs, list
DetectHiddenWindows, On ; revert to app default

Loop, %strWinIDs%
	If KeepThisWindow(A_Index, strWinIDs%A_Index%, "Close All Windows menu", objWindowProperties)
		LV_Add("", objWindowProperties.WindowTitle, strWinIDs%A_Index%, objWindowProperties.ProcessPath)
LV_ModifyCol(1, "Auto")

GuiCenterButtons(strGuiTitle, 20, 10, , "f_btnCloseAllWindowsClose", "f_btnCloseAllWindowsCancel")

GuiControl, CloseAllWindows:Focus, f_lvCloseAllWindows
CalculateTopGuiPosition(g_strGui3Hwnd, g_strAppHwnd, intX, intY)
Gui, CloseAllWindows:Show, AutoSize x%intX% y%intY%

intX := ""
intY := ""
strGuiTitle := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
CloseAllWindowsSelectAll:
;------------------------------------------------------------

; check all if none is checked, use "-" prefix to deselect all if any one is selected
LV_Modify("", (LV_GetNext(, "Checked") ? "-" : "") . "Check")

return
;------------------------------------------------------------


;------------------------------------------------------------
CloseAllWindowsListEvents:
;------------------------------------------------------------

if (A_GuiEvent <> "DoubleClick")
	return

intFocusRow := A_EventInfo
gosub, CloseAllWindowsDetails

return
;------------------------------------------------------------


;------------------------------------------------------------
CloseAllWindowsEnter:
;------------------------------------------------------------

GuiControlGet, strControlFocus, FocusV
if (strControlFocus <> "f_lvCloseAllWindows")
    return

intFocusRow := LV_GetNext(0, "Focused")
gosub, CloseAllWindowsDetails

return
;------------------------------------------------------------


;------------------------------------------------------------
CloseAllWindowsDetails:
;------------------------------------------------------------
Gui, CloseAllWindows:+OwnDialogs

LV_GetText(strWindowTitle, intFocusRow, 1)
LV_GetText(strWindowPath, intFocusRow, 3)

MsgBox, % 4+32+256, %g_strAppNameText%, % L(o_L["DialogCloseAllWindowsDetail"], strWindowTitle, strWindowPath)

IfMsgBox, Yes
{
	LV_GetText(strWindowID, intFocusRow, 2)
	Gosub, CloseAllWindowsCloseThisWindow
}

return
;------------------------------------------------------------


;------------------------------------------------------------
CloseAllWindowsCloseButton:
;------------------------------------------------------------

intWindowsRow := 0 ; the first loop iteration starts the search at the top of the list
Loop
{
	intWindowsRow := LV_GetNext(intWindowsRow, "Checked")  ; Resume the search at the row after that found by the previous iteration.
	if !(intWindowsRow) ; false if no more selected rows
		break
	
	LV_GetText(strWindowID, intWindowsRow, 2)
	Gosub, CloseAllWindowsCloseThisWindow
	Sleep, 200 ; for safety, required?
}

Gosub, CloseAllWindowsGuiClose

return
;------------------------------------------------------------


;------------------------------------------------------------
CloseAllWindowsCloseThisWindow:
;------------------------------------------------------------

; WinClose sends a WM_CLOSE message to the target window, which is a somewhat forceful method of closing it.
; An alternate method of closing is to send the following message. It is similar in effect to pressing Alt-F4 or clicking the window's close button in its title bar
; PostMessage, 0x112, 0xF060,,, % "ahk_id " . strWindowID ; 0x112 = WM_SYSCOMMAND, 0xF060 = SC_CLOSE

WinActivate, ahk_id %strWindowID%
Sleep, 100 ; for safety, required?
WinClose, ahk_id %strWindowID%
Sleep, 100 ; for safety, required?

; WinWaitClose, ahk_id %strWindowID%, , 2 ; wait 2 secs and set ErrorLevel to 1 if timed out
; if (ErrorLevel)
; {
	; WinGetTitle, strWindowTitle, ahk_id %strWindowID%
	; Oops("Unable to close window:`n`n~1~", strWindowTitle) ; ### language
; }

return
;------------------------------------------------------------


;------------------------------------------------------------
CloseAllWindowsGuiClose:
CloseAllWindowsGuiEscape:
;------------------------------------------------------------

Gui, CloseAllWindows:Destroy

strWindows := ""
intWindowsRow := ""
ResetArray("strIDs")
strWindowTitle := ""
strWindowPath := ""
strWindowID := ""
strControlFocus := ""
intFocusRow := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
DoNothing:
;------------------------------------------------------------

return
;------------------------------------------------------------



;========================================================================================================================
; END OF MENU ACTIONS
;========================================================================================================================



;========================================================================================================================
!_074_NAVIGATE:
return ;  a label must not point to a function.
;========================================================================================================================

;------------------------------------------------------------
ControlIsVisible(strWinTitle, strControlClass)
/*
Adapted from ControlIsVisible(WinTitle,ControlClass) by Learning One
http://ahkscript.org/boards/viewtopic.php?f=5&t=526&start=20#p4673
*/
;------------------------------------------------------------
{
	; used in Navigator
	ControlGet, blnIsControlVisible, Visible, , %strControlClass%, %strWinTitle%

	return blnIsControlVisible
}
;------------------------------------------------------------


;------------------------------------------------------------
ControlSetTextR(strControl, strNewText := "", strWinTitle := "", intTries := 3)
/*
Adapted from from RMApp_ControlSetTextR(Control, NewText="", WinTitle="", Tries=3) by Learning One
http://ahkscript.org/boards/viewtopic.php?f=5&t=526&start=20#p4673
*/
;------------------------------------------------------------
{
	; used in Navigator. More reliable ControlSetText
	Loop, %intTries%
	{
		ControlSetText, %strControl%, %strNewText%, %strWinTitle% ; set
		Sleep, % (100 * A_Index) ; JL added "* A_Index"
		ControlGetText, strCurControlText, %strControl%, %strWinTitle% ; check
		if (strCurControlText = strNewText) ; if OK
			return True
	}

	return false
}
;------------------------------------------------------------


;------------------------------------------------------------
ControlSetFocusR(strControl, strWinTitle := "", intTries := 3)
/*
Adapted from RMApp_ControlSetFocusR(Control, WinTitle="", Tries=3) by Learning One
http://ahkscript.org/boards/viewtopic.php?f=5&t=526&start=20#p4673
*/
;------------------------------------------------------------
{
	; used in Navigator. More reliable ControlSetFocus
	Loop, %intTries%
	{
		ControlFocus, %strControl%, %strWinTitle% ; focus control
		Sleep, % (100 * A_Index) ; JL added "* A_Index"
		ControlGetFocus, strFocusedControl, %strWinTitle% ; check
		if (strFocusedControl = strControl) ; if OK
			return True
	}

	return false
}
;------------------------------------------------------------



;========================================================================================================================
; END OF NAVIGATE
;========================================================================================================================



;========================================================================================================================
!_075_NEW_WINDOW:
;========================================================================================================================

;========================================================================================================================
; END OF NEW WINDOW
;========================================================================================================================


;========================================================================================================================
!_076_TRAY_MENU_ACTIONS:
;========================================================================================================================

;------------------------------------------------------------
ShowSettingsIniFile:
;------------------------------------------------------------

Run, % o_Settings.strIniFile

return
;------------------------------------------------------------


;------------------------------------------------------------
ReloadQAP:
ReloadQAPSwitch:
ReloadAsAdmin:
;------------------------------------------------------------

; Do not use the Reload command: Any command-line parameters passed to the original script are not passed to the new instance.
; Also, include the string /restart as the first parameter (i.e. after the name of the executable), which tells the program to
; use the same behavior as Reload.

; make sure the default system mouse pointer are reset before reloading QAP
SetWaitCursor(false)

if (A_ThisLabel = "ReloadQAPSwitch")
	; update Settings param
	o_CommandLineParameters.SetParam("Settings", g_strSwitchSettingsFile)

; keep other params received from command-line as collected in o_CommandLineParameters
strCurrentCommandLineParameters := o_CommandLineParameters.strParams

; Why using RunWait instead of Run... AHK Doc: "To keep the script running even if it failed to restart (if user answered "No" to
; UAC prompt), remove ExitApp and use RunWait instead of Run. On success, /restart causes the new instance to terminate the old one.
; On failure, the new instance exits and RunWait returns."

; Putting "*RunAs" in a variable caused an error when making it empty to launch without admin right

try
{
	if (A_IsCompiled)
		if (A_ThisLabel = "ReloadAsAdmin" or A_IsAdmin)
			RunWait, *RunAs %A_ScriptFullPath% /restart %strCurrentCommandLineParameters%
		else
			RunWait, %A_ScriptFullPath% /restart %strCurrentCommandLineParameters% ; double-quotes already included in strCurrentCommandLineParameters
	else
		if (A_ThisLabel = "ReloadAsAdmin" or A_IsAdmin)
			RunWait, *RunAs %A_AhkPath% /restart %A_ScriptFullPath% %strCurrentCommandLineParameters%
		else
			RunWait, %A_AhkPath% /restart %A_ScriptFullPath% %strCurrentCommandLineParameters% ; double-quotes already included in strCurrentCommandLineParameters
	ExitApp
}

Oops(o_L["OopsNotAdmin"], g_strAppNameText)

strCurrentCommandLineParameters := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
ShowQAPconnectIniFile:
;------------------------------------------------------------

if FileExist(g_aaFileManagerQAPconnect.strQAPconnectIniPath)
	Run, % g_aaFileManagerQAPconnect.strQAPconnectIniPath
else
	Oops(o_L["OptionsThirdPartyFileNotFound"], "QAPconnect", g_aaFileManagerQAPconnect.strQAPconnectIniPath)

return
;------------------------------------------------------------


;------------------------------------------------------------
CreateStartupShortcut:
;------------------------------------------------------------

FileCreateShortcut, %A_ScriptFullPath%, %A_Startup%\%g_strAppNameFile%.lnk, %A_WorkingDir%
	, % o_CommandLineParameters.strParams ; since version 8.7.1 now includes the changed /Settings: parameter if user switched settings file

return
;------------------------------------------------------------


;------------------------------------------------------------
SuspendHotkeys:
;------------------------------------------------------------

if (A_IsSuspended)
	Suspend, Off
else
	Suspend, On

Menu, menuBarTools, ToggleCheck, % aaMenuToolsL["MenuSuspendHotkeys"]

return
;------------------------------------------------------------


;------------------------------------------------------------
Check4Update:
Check4UpdateNow:
;------------------------------------------------------------

strUrlCheck4Update := "https://www.quickaccesspopup.com/latest/latest-version-4.php"

g_strUrlAppLandingPage := "https://www.quickaccesspopup.com" ; must be here if user select Check for update from tray menu
strBetaLandingPage := "https://www.quickaccesspopup.com/latest/check4update-beta-redirect.html"

strLatestSkippedProd := o_Settings.ReadIniValue("LatestVersionSkipped", 0.0)
strLatestSkippedBeta := o_Settings.ReadIniValue("LatestVersionSkippedBeta", 0.0)
strLatestUsedBeta := o_Settings.ReadIniValue("LastVersionUsedBeta", 0.0)
strLatestSkippedAlpha := o_Settings.ReadIniValue("LatestVersionSkippedAlpha", 0.0)
strLatestUsedAlpha := o_Settings.ReadIniValue("LastVersionUsedAlpha", 0.0)

blnSetup := (FileExist(A_ScriptDir . "\_do_not_remove_or_rename.txt") = "" ? 0 : 1)

; FileGetTime, strShell32Date, %A_WinDir%\System32\shell32.dll
; FileGetTime, strImageresDate, %A_WinDir%\System32\imageres.dll

strLatestVersions := Url2Var(strUrlCheck4Update
	. "?v=" . g_strCurrentVersion
	. "&os=" . GetOSVersion()
	. "&is64=" . A_Is64bitOS
	. "&setup=" . (blnSetup)
				+ (2 * (o_Settings.Launch.blnDonor.IniValue ? 1 : 0))
				+ (4 * (o_FileManagers.P_intActiveFileManager = 2 ? 1 : 0)) ; DirectoryOpus
				+ (8 * (o_FileManagers.P_intActiveFileManager = 3 ? 1 : 0)) ; TotalCommander
				+ (16 * (o_FileManagers.P_intActiveFileManager = 4 ? 1 : 0)) ; QAPconnect
	. "&lsys=" . A_Language
	. "&lfp=" . o_Settings.Launch.strLanguageCode.IniValue
	. "&shd=" . "" ; strShell32Date not needed but keep empty value for MySQL database
	. "&ird=" . "" ; strImageresDate not needed but keep empty value for MySQL database
	. "&ini1=" . g_strIniBefore
	. "&ini2=" . g_strIniAfter)
if !StrLen(strLatestVersions)
	if (A_ThisMenuItem = aaHelpL["MenuUpdate"])
	{
		Oops(o_L["UpdateError"])
		gosub, Check4UpdateCleanup
		return ; an error occured during ComObjCreate
	}

strLatestVersions := SubStr(strLatestVersions, InStr(strLatestVersions, "[[") + 2) 
strLatestVersions := SubStr(strLatestVersions, 1, InStr(strLatestVersions, "]]") - 1) 
strLatestVersions := Trim(strLatestVersions, "`n`l") ; remove en-of-line if present
Loop, Parse, strLatestVersions, , 0123456789.| ; strLatestVersions should only contain digits, dots and one pipe (|) between prod and beta versions
	; if we get here, the content returned by the URL above is wrong
	if (A_ThisMenuItem <> aaHelpL["MenuUpdate"])
	{
		gosub, Check4UpdateCleanup
		return ; return silently
	}
	else
	{
		Oops(o_L["UpdateError"]) ; return with an error message
		gosub, Check4UpdateCleanup
		return
	}

objLatestVersions := StrSplit(strLatestVersions, "|")
strLatestVersionProd := objLatestVersions[1]
strLatestVersionBeta := objLatestVersions[2]
strLatestVersionAlpha := objLatestVersions[3]

; DEGUG VALUES
; g_strCurrentVersion := "9.9.0.8"
; strLatestVersionAlpha := "9.3.1"
; strLatestUsedAlpha := "1.1"
; strLatestSkippedAlpha := "9.3.2"
; strLatestVersionBeta := "9.3.2"
; strLatestUsedBeta := "1.1"
; strLatestSkippedBeta := "9.3.1"
; strLatestVersionProd := "9.2"
; strLatestSkippedProd := "9.4"
; DEGUG VALUES
; ###_V(A_ThisLabel, "*g_strCurrentVersion", g_strCurrentVersion, "*", ""
	; , "*strLatestVersionAlpha", strLatestVersionAlpha, "*strLatestUsedAlpha", strLatestUsedAlpha, "*strLatestSkippedAlpha", strLatestSkippedAlpha
	; , "*Propose ALPHA?", ((strLatestUsedAlpha <> "0.0" and ProposeUpdate(strLatestVersionAlpha, g_strCurrentVersion, strLatestSkippedAlpha)) ? "OUI" : ""), "*", ""
	; , "*strLatestVersionBeta", strLatestVersionBeta, "*strLatestUsedBeta", strLatestUsedBeta, "*strLatestSkippedBeta", strLatestSkippedBeta
	; , "*Propose BETA?", ((strLatestUsedBeta <> "0.0" and ProposeUpdate(strLatestVersionBeta, g_strCurrentVersion, strLatestSkippedBeta)) ? "OUI" : ""), "*", ""
	; , "*strLatestVersionProd", strLatestVersionProd, "*strLatestSkippedProd", strLatestSkippedProd
	; , "*Propose PROD?", (ProposeUpdate(strLatestVersionProd, g_strCurrentVersion, strLatestSkippedProd) ? "OUI" : "")
	; , "*", "")
; KEEP DEBUGGING CODE

if (strLatestUsedAlpha <> "0.0" and ProposeUpdate(strLatestVersionAlpha, g_strCurrentVersion, strLatestSkippedAlpha))
{
	g_strUpdateProdOrBeta := "alpha"
	g_strUpdateLatestVersion := strLatestVersionAlpha
	Gosub, GuiCheck4Update
}
else if (strLatestUsedBeta <> "0.0" and ProposeUpdate(strLatestVersionBeta, g_strCurrentVersion, strLatestSkippedBeta))
{
	g_strUpdateProdOrBeta := "beta"
	g_strUpdateLatestVersion := strLatestVersionBeta
	Gosub, GuiCheck4Update
}
else if ProposeUpdate(strLatestVersionProd, g_strCurrentVersion, strLatestSkippedProd)
{
	g_strUpdateProdOrBeta := "prod"
	g_strUpdateLatestVersion := strLatestVersionProd
	Gosub, GuiCheck4Update
}
else if (A_ThisMenuItem = aaHelpL["MenuUpdate"]) or (A_ThisLabel = "Check4UpdateNow")
{
	MsgBox, 4, % l(o_L["UpdateTitle"], g_strAppNameText), % l(o_L["UpdateYouHaveLatest"], g_strAppVersion, g_strAppNameText)
	IfMsgBox, Yes
		Run, %g_strUrlAppLandingPage%
}
; else do nothing

Check4UpdateCleanup:
strLatestSkippedAlpha := ""
strLatestSkippedBeta := ""
strLatestSkippedProd := ""
strLatestUsedAlpha := ""
strLatestUsedBeta := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
ProposeUpdate(strVersionNew, strVersionRunning, strVersionSkipped)
	; si (version_nouveau_beta > version_installe_beta) / il y a une nouvelle version
		; et (version_nouveau_beta <= version_sautee_beta / et elle n'a pas t saute
;------------------------------------------------------------
{
	; ###_V(A_ThisFunc, strVersionNew, strVersionRunning, strVersionSkipped
		; , FirstVsSecondIs(strVersionNew, strVersionRunning), FirstVsSecondIs(strVersionNew, strVersionSkipped)
		; , (FirstVsSecondIs(strVersionNew, strVersionRunning) = 1 and FirstVsSecondIs(strVersionNew, strVersionSkipped) > 0))
	; FirstVsSecondIs() returns -1 if first smaller, 0 if equal, 1 if first greater
	; return (strVersionNew > strVersionRunning) and (strVersionNew >= strVersionSkipped)
	return (FirstVsSecondIs(strVersionNew, strVersionRunning) = 1
		and FirstVsSecondIs(strVersionNew, strVersionSkipped) > 0)
}
;------------------------------------------------------------


;------------------------------------------------------------
FirstVsSecondIs(strFirstVersion, strSecondVersion)
; returns -1 if first smaller, 0 if equal, 1 if first greater
; supports from 1 to 5 version sub-numbers of up to 3 digits each
; examples: "1", "1.2", 1.22.333.444.555"
;------------------------------------------------------------
{
	strFirstVersion := PrepareVersionNumber(strFirstVersion)
	strSecondVersion := PrepareVersionNumber(strSecondVersion)
	; ###_V(A_ThisFunc, strFirstVersion, strSecondVersion)

	if (strFirstVersion > strSecondVersion)
		return 1 ; greater
	else if (strFirstVersion < strSecondVersion)
		return -1 ; smaller
	else
		return 0 ; equal
}
;------------------------------------------------------------


;------------------------------------------------------------
PrepareVersionNumber(strVersionNumber)
; Make version number strings comparable by < and > operators.
; Returns a padded string of 5 sub-numbers of 3 digits each, NOT separated.
; Example: "1.22.333" returns "001022333000000"
;------------------------------------------------------------
{
	; RegExReplace(..., "[^.]") removes all but dots
	; StrLen() counts number of dots in version number
	; the loop add ".0" until we have 4 dots and five sub-numbers (eg "0.0.0.0.0")
	loop, % 4 - StrLen(RegExReplace(strVersionNumber, "[^.]"))
		strVersionNumber .= ".0"

	; make sure every version sub-number has an equal number of 3 digits, removing dots
	loop, parse, strVersionNumber, .
	{
		strSubNumber := A_LoopField
		while StrLen(strSubNumber) < 3
			strSubNumber := "0" . strSubNumber
		strResult .= strSubNumber
	}
	
	return strResult
}
;------------------------------------------------------------


;------------------------------------------------------------
GuiCheck4Update:
;------------------------------------------------------------

strChangeLog := Url2Var("https://www.quickaccesspopup.com/changelog/changelog" . (g_strUpdateProdOrBeta <> "prod" ? "-" . g_strUpdateProdOrBeta : "") . ".txt")

if StrLen(strChangeLog)
{
	intPos := InStr(strChangeLog, "Version" . (g_strUpdateProdOrBeta = "beta" ? " BETA" : (g_strUpdateProdOrBeta = "alpha" ? " ALPHA" : "")) . ": " . g_strUpdateLatestVersion . " ")
	strChangeLog := SubStr(strChangeLog, intPos)
	intPos := InStr(strChangeLog, "`n`n")
	strChangeLog := SubStr(strChangeLog, 1, intPos - 1)
}

strGuiTitle := L(o_L["UpdateTitle"], g_strAppNameText)
Gui, Update:New, +Hwndg_strGui3Hwnd, %strGuiTitle%
; Do not use g_strMenuBackgroundColor here because it is not set yet

Gui, Update:Font, s10 w700, Verdana
Gui, Update:Add, Text, x10 y10 w640, % L(o_L["UpdateTitle"], g_strAppNameText)
Gui, Update:Font
Gui, Update:Add, Text, x10 w640, % l(o_L["UpdatePrompt"], g_strAppNameText, g_strCurrentVersion
	, g_strUpdateLatestVersion . (g_strUpdateProdOrBeta <> "prod" ? " " . g_strUpdateProdOrBeta : ""))
Gui, Update:Add, Edit, x8 y+10 w640 h300 ReadOnly, %strChangeLog%
Gui, Update:Font

Gui, Update:Add, Button, y+20 x10 vf_btnCheck4UpdateDialogChangeLog gButtonCheck4UpdateDialogChangeLog, % o_L["UpdateButtonChangeLog"]
Gui, Update:Add, Button, yp x+20 vf_btnCheck4UpdateDialogVisit gButtonCheck4UpdateDialogVisit, % o_L["UpdateButtonVisit"]

GuiCenterButtons(strGuiTitle, 10, 5, 20, "f_btnCheck4UpdateDialogChangeLog", "f_btnCheck4UpdateDialogVisit")

if (g_strUpdateProdOrBeta = "prod")
{
	Gui, Update:Add, Button, y+20 x10 vf_btnCheck4UpdateDialogDownloadSetup gButtonCheck4UpdateDialogDownloadSetup, % o_L["UpdateButtonDownloadSetup"]
	Gui, Update:Add, Button, yp x+20 vf_btnCheck4UpdateDialogDownloadPortable gButtonCheck4UpdateDialogDownloadPortable, % o_L["UpdateButtonDownloadPortable"]

	GuiCenterButtons(strGuiTitle, 10, 5, 20, "f_btnCheck4UpdateDialogDownloadSetup", "f_btnCheck4UpdateDialogDownloadPortable")
}

Gui, Update:Add, Button, y+20 x10 vf_btnCheck4UpdateDialogSkipVersion gButtonCheck4UpdateDialogSkipVersion, % o_L["UpdateButtonSkipVersion"]
Gui, Update:Add, Button, yp x+20 vf_btnCheck4UpdateDialogRemind gButtonCheck4UpdateDialogRemind, % o_L["UpdateButtonRemind"]
Gui, Update:Add, Text

GuiCenterButtons(strGuiTitle, 10, 5, 20, "f_btnCheck4UpdateDialogSkipVersion", "f_btnCheck4UpdateDialogRemind")

GuiControl, Update:Focus, f_btnCheck4UpdateDialogRemind
CalculateTopGuiPosition(g_strGui3Hwnd, g_strAppHwnd, intX, intY)
Gui, Update:Show, AutoSize x%intX% y%intY%

strGuiTitle := ""

return

;------------------------------------------------------------


;------------------------------------------------------------
ButtonCheck4UpdateDialogChangeLog:
ButtonCheck4UpdateDialogVisit:
ButtonCheck4UpdateDialogDownloadSetup:
ButtonCheck4UpdateDialogDownloadPortable:
ButtonCheck4UpdateDialogSkipVersion:
ButtonCheck4UpdateDialogRemind:
UpdateGuiClose:
UpdateGuiEscape:
;------------------------------------------------------------

strUrlChangeLog := "https://www.quickaccesspopup.com/change-log" . (g_strUpdateProdOrBeta <> "prod" ? "-" . g_strUpdateProdOrBeta . "-version" : "") . "/"
strUrlDownloadSetup := "https://www.quickaccesspopup.com/latest/check4update-download-setup-redirect.html" ; prod only
strUrlDownloadPortable:= "https://www.quickaccesspopup.com/latest/check4update-download-portable-redirect.html" ; prod only
strUrlAppLandingPageBeta := "https://forum.quickaccesspopup.com/forumdisplay.php?fid=11"

if InStr(A_ThisLabel, "ButtonCheck4UpdateDialogChangeLog")
	Run, %strUrlChangeLog%
else if (A_ThisLabel = "ButtonCheck4UpdateDialogVisit")
	Run, % (g_strUpdateProdOrBeta = "prod" ? g_strUrlAppLandingPage : strUrlAppLandingPageBeta) ; beta page also for alpha
else if (A_ThisLabel = "ButtonCheck4UpdateDialogDownloadSetup")
	Run, %strUrlDownloadSetup%
else if (A_ThisLabel = "ButtonCheck4UpdateDialogDownloadPortable")
	Run, %strUrlDownloadPortable%
else if (A_ThisLabel = "ButtonCheck4UpdateDialogSkipVersion")
{
	IniWrite, % (g_strUpdateProdOrBeta = "alpha" ? strLatestVersionAlpha : (g_strUpdateProdOrBeta = "beta" ? strLatestVersionBeta : strLatestVersionProd)), % o_Settings.strIniFile, Global
		, % "LatestVersionSkipped" . (g_strUpdateProdOrBeta = "alpha" ? "Alpha" : (g_strUpdateProdOrBeta = "beta" ? "Beta" : "")) ; do not add "Prod" to ini variable for backward compatibility
	if (g_strUpdateProdOrBeta <> "prod")
	{
		MsgBox, 4, % l(o_L["UpdateTitle"], g_strAppNameText . " " . g_strUpdateProdOrBeta)
			, % (g_strUpdateProdOrBeta = "alpha" ? StrReplace (o_L["UpdatePromptBetaContinue"], "beta" "alpha") ; it seems safe to replace for all languages
			: o_L["UpdatePromptBetaContinue"])
		IfMsgBox, No
			IniWrite, 0.0, % o_Settings.strIniFile, Global, LastVersionUsedBeta
	}
}
else ; ButtonCheck4UpdateDialogRemind, UpdateGuiClose or UpdateGuiEscape
	IniWrite, 0.0, % o_Settings.strIniFile, Global
		, % "LatestVersionSkipped" . (g_strUpdateProdOrBeta = "alpha" ? "Alpha" : (g_strUpdateProdOrBeta = "beta" ? "Beta" : "")) ; do not add "Prod" to ini variable for backward compatibility

Gui, Destroy

Check4UpdateDialogCleanup:
strChangelog := ""
strUrlChangeLog := ""
strUrlDownloadSetup := ""
strUrlDownloadPortable:= ""
strUrlAppLandingPageBeta := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
SwitchSettings:
SwitchSettingsDefault:
;------------------------------------------------------------

if SettingsUnsaved()
{
	Oops(o_L["ImpExpUnsavedSettings"])
	return
}

if (A_ThisLabel = "SwitchSettingsDefault")
	g_strSwitchSettingsFile := o_Settings.strIniFileDefault
else
{
	strSwitchSettingsFolder := o_Settings.ReadIniValue("SwitchSettingsFolder", A_WorkingDir)

	FileSelectFile, g_strSwitchSettingsFile, 3, %strSwitchSettingsFolder%, % o_L["DialogSwitchSettings"], *.ini
	if !(StrLen(g_strSwitchSettingsFile))
		return

	SplitPath, g_strSwitchSettingsFile, , strSwitchSettingsFolder, strSwitchSettingsExt
	if !StrLen(strSwitchSettingsExt)
		g_strSwitchSettingsFile .= ".ini"
	IniWrite, %strSwitchSettingsFolder%, % o_Settings.strIniFile, Global, SwitchSettingsFolder
}

IniRead, strIniSettingsGlobal, %g_strSwitchSettingsFile%, Global, , %A_Space%
IniRead, strIniSettingsFavorite1, %g_strSwitchSettingsFile%, Favorites, Favorite1, %A_Space%
if !StrLen(strIniSettingsGlobal) or !StrLen(strIniSettingsFavorite1)
{
	Oops(o_L["DialogSettingsInvalid"], "[Global]", "[Favorites]", g_strSwitchSettingsFile)
	return
}

Gosub, ReloadQAPSwitch

strSwitchSettingsFolder := ""
strSwitchSettingsExt := ""
strIniSettingsGlobal := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
ImportExport:
;------------------------------------------------------------

if SettingsUnsaved()
{
	Oops(o_L["ImpExpUnsavedSettings"])
	return
}

strGuiTitle := L(o_L["ImpExpTitle"], g_strAppNameText)
Gui, ImpExp:New, +Hwndg_strGui3Hwnd, %strGuiTitle%
if (g_blnUseColors)
	Gui, ImpExp:Color, %g_strGuiWindowColor%

Gui, ImpExp:Font, w700
Gui, ImpExp:Add, Radio, y+20 x10 w130 vf_radImpExpExport gImpExpClicked Checked Group, % o_L["ImpExpExport"]
Gui, ImpExp:Add, Radio, x150 yp w130 vf_radImpExpImport gImpExpClicked, % o_L["ImpExpImport"]

Gui, ImpExp:Font, w700
Gui, ImpExp:Add, Text, y+20 x10 w400 vf_lblImpExpFile, % L(o_L["ImpExpFile"], o_L["ImpExpDestination"])
Gui, ImpExp:Font
Gui, ImpExp:Add, Edit, x10 w320 h20 vf_strImpExpFile
Gui, ImpExp:Add, Button, x+10 yp vf_btnImpExpFile gButtonImpExpFile, % o_L["DialogBrowseButton"]

Gui, ImpExp:Font, w700
Gui, ImpExp:Add, Text, y+20 x10 w400 vf_lblImpExpOptions, % o_L["ImpExpExport"]
Gui, ImpExp:Font

Gui, ImpExp:Add, CheckBox, y+10 x10 w400 vf_blnImpExpFavorites Checked, % o_L["ImpExpOptionFavorites"]
Gui, ImpExp:Add, Checkbox, y+10 x10 w400 vf_blnImpExpGlobal Checked, % o_L["ImpExpFileGlobal"]
Gui, ImpExp:Add, CheckBox, y+10 x10 w400 vf_blnImpExpAlternative Checked, % o_L["ImpExpOptionAlternative"]
Gui, ImpExp:Add, Checkbox, y+10 x10 w400 vf_blnImpExpThemes Checked, % o_L["ImpExpFileThemes"]

aaImportExportL := o_L.InsertAmpersand(false, "ImpExpImport", "ImpExpExport", "GuiClose")

Gui, ImpExp:Add, Button, y+20 x10 vf_btnImpExpGo gButtonImpExpGo default, % aaImportExportL["ImpExpExport"]
Gui, ImpExp:Add, Button, yp x+20 vf_btnImpExpClose gButtonImpExpClose, % aaImportExportL["GuiClose"]
GuiCenterButtons(strGuiTitle, 10, 5, 20, "f_btnImpExpGo", "f_btnImpExpClose")
Gui, ImpExp:Add, Text

; GuiControl, Focus, f_btnCheck4UpdateDialogDownloadSetup
gosub, ImpExpClicked
CalculateTopGuiPosition(g_strGui3Hwnd, g_strAppHwnd, intX, intY)
Gui, ImpExp:Show, AutoSize x%intX% y%intY%

intX := ""
intY := ""
strGuiTitle := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
ImpExpClicked:
;------------------------------------------------------------
Gui, ImpExp:Submit, NoHide

GuiControl, , f_lblImpExpFile, % L(o_L["ImpExpFile"], (f_radImpExpExport ? o_L["ImpExpDestination"] : o_L["ImpExpSource"]))
GuiControl, , f_lblImpExpOptions, % L(f_radImpExpExport ? o_L["ImpExpExport"] : o_L["ImpExpImport"])
GuiControl, , f_btnImpExpGo, % L(f_radImpExpExport ? o_L["ImpExpExport"] : aaImportExportL["ImpExpImport"])

if (f_radImpExpExport)
	strImpExpFile := o_Settings.ReadIniValue("LastExportFile", " ") ; empty if not found
else
	strImpExpFile := ""
GuiControl, , f_strImpExpFile, %strImpExpFile%

return
;------------------------------------------------------------


;------------------------------------------------------------
ButtonImpExpFile:
;------------------------------------------------------------
Gui, ImpExp:Submit, NoHide
Gui, ImpExp:+OwnDialogs

strImpExpFolder := o_Settings.ReadIniValue("Last" . (f_radImpExpExport ? "Ex" : "Im") . "portFolder", A_WorkingDir)

FileSelectFile, strImpExpSelectedFile, % (f_radImpExpExport ? 2 : 3), %strImpExpFolder%, % o_L["DialogAddFolderSelect"], *.ini
if !(StrLen(strImpExpSelectedFile))
	return

if !StrLen(GetFileExtension(strImpExpSelectedFile))
	strImpExpSelectedFile .= ".ini"

GuiControl, ImpExp:, f_strImpExpFile, %strImpExpSelectedFile%

strImpExpFolder := ""
strImpExpSelectedFile := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
ButtonImpExpGo:
;------------------------------------------------------------
Gui, ImpExp:Submit, NoHide

if !StrLen(f_strImpExpFile)
{
	Oops(o_L["ImpExpSelectFile"], (f_radImpExpExport ? o_L["ImpExpDestination"] : o_L["ImpExpSource"]))
	return
}

blnAbort := false
blnContentTransfered := false
blnContentIdentical := false

if (f_radImpExpExport)
	strImpExpFile := StrReplace(StrReplace(f_strImpExpFile, "%A_Now%", A_Now), "%A_NowUTC%", A_NowUTC)
else
	strImpExpFile := f_strImpExpFile

g_strImpExpSourceFile := (f_radImpExpExport ? o_Settings.strIniFile : strImpExpFile)
g_strImpExpDestinationFile := (f_radImpExpExport ? strImpExpFile : o_Settings.strIniFile)

SplitPath, g_strImpExpDestinationFile, , strImpExpFolder, strImpExpExt
if !StrLen(strImpExpExt) ; add ini to destination file
	g_strImpExpDestinationFile .= ".ini"
strImEx := (f_radImpExpExport ? "Ex" : "Im")
IniWrite, %strImpExpFolder%, % o_Settings.strIniFile, Global, Last%strImEx%portFolder
if (f_radImpExpExport)
	IniWrite, % f_strImpExpFile, % o_Settings.strIniFile, Global, LastExportFile ; store f_strImpExpFile, not strImpExpFile that may contain current time

if !(blnAbort) and (f_blnImpExpFavorites)
{
	blnReplace := false
	strFavorite := o_Settings.ReadIniValue("Favorite1", "", "Favorites", g_strImpExpDestinationFile) ; ERROR if not found
	if (strFavorite <> "ERROR")
	{
		SetTimer, ImpExpChangeButtonNames, 50
		MsgBox, 3, % o_L["ImpExpMenu"] . " " o_L["ImpExpFavorites"] . " - " . g_strAppNameText, % L(o_L["ImpExpReplaceFavorites"], g_strImpExpDestinationFile)
		IfMsgBox, Yes
			blnReplace := true
		IfMsgBox, Cancel
			return

		if !(blnReplace) ; append
		{
			; get last index number
			Loop
			{
				strAppendFavorite := o_Settings.ReadIniValue("Favorite" . A_Index, "", "Favorites", g_strImpExpDestinationFile)
				if (strAppendFavorite = "ERROR")
				{
					intLastFavorite := A_Index
					Break
				}
			}
			intLastFavorite -= 2 ; minus one for "ERROR" and minus one to overwrite "Z" (end of menu) that will be re-inserted in the import
			intIniLine := 0
			Loop
			{
				intIniLine++
				strAppendFavorite := o_Settings.ReadIniValue("Favorite" . intIniLine, "", "Favorites", g_strImpExpSourceFile) ; ERROR if not found
				if (strAppendFavorite = "ERROR")
					Break
				intDestintIniLine := intIniLine + intLastFavorite
				IniWrite, %strAppendFavorite%, %g_strImpExpDestinationFile%, Favorites, Favorite%intDestintIniLine%
			}
			blnContentTransfered := (intIniLine > 0)
		}
	}
	
	if (strFavorite = "ERROR" or blnReplace)
		WriteIniSection("Favorites", "", blnAbort, blnContentTransfered, blnContentIdentical) ; update blnAbort, blnContentTransfered and blnContentIdentical
}

if (f_blnImpExpGlobal)
	WriteIniSection("Global", o_L["ImpExpFileGlobal"], blnAbort, blnContentTransfered, blnContentIdentical) ; update blnAbort, blnContentTransfered and blnContentIdentical

if (f_blnImpExpAlternative)
	WriteIniSection("AlternativeMenuHotkeys", "", blnAbort, blnContentTransfered, blnContentIdentical) ; update blnAbort, blnContentTransfered and blnContentIdentical

if (f_blnImpExpThemes)
{
	strThemesList := o_Settings.ReadIniValue("AvailableThemes", "", "Global", g_strImpExpSourceFile) ; ERROR if not found
	if (strThemesList = "ERROR")
		Oops(o_L["ImpExpNoThemes"], "AvailableThemes=", "[Global]", g_strImpExpSourceFile)
	else
		Loop, Parse, strThemesList, |
			WriteIniSection("Gui-" . A_LoopField, "", blnAbort, blnContentTransfered, blnContentIdentical) ; update blnAbort, blnContentTransfered and blnContentIdentical
}

if (f_radImpExpExport)
	MsgBox, 0, %g_strAppNameText%
		, % L(o_L["ImpExpFinalReport"], (blnAbort or !blnContentTransfered ? o_L["ImpExpAborted"] : o_L["ImpExpCompleted"]) . (blnContentIdentical ? " " . o_L["ImpExpOrIdentical"] : ""), g_strImpExpSourceFile, g_strImpExpDestinationFile)
else
{
	if (blnAbort or !blnContentTransfered)
		MsgBox, 0, %g_strAppNameText%, % L(o_L["ImpExpFinalReport"], o_L["ImpExpAborted"] . (blnContentIdentical ? " " . o_L["ImpExpOrIdentical"] : ""), g_strImpExpSourceFile, g_strImpExpDestinationFile)
	else
	{
		MsgBox, 52, %g_strAppNameText%, % L(o_L["ImpExpFinalReport"], o_L["ImpExpCompleted"] . (blnContentIdentical ? " " . o_L["ImpExpOrIdentical"] : ""), g_strImpExpSourceFile, g_strImpExpDestinationFile)
			. "`n`n" . L(o_L["ImpExpRestartApp"], g_strAppNameText)
		IfMsgBox, Yes
			Gosub, ReloadQAP
	}
}

g_strImpExpSourceFile := ""
g_strImpExpDestinationFile := ""
intIniLine := ""
strFavorite := ""
blnAbort := ""
blnReplace := ""
intLastFavorite := ""
strAppendFavorite := ""
strImpExpFolder := ""
strImpExpFile := ""
strImpExpExt := ""
strImEx := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
WriteIniSection(strSectionName, strDescription, ByRef blnAbort, ByRef blnContentTransfered, ByRef blnContentIdentical)
;------------------------------------------------------------
{
	global g_strImpExpSourceFile
	global g_strImpExpDestinationFile
	
	if blnAbort
		return

	blnReplaceOK := false
	
	IniRead, strSourceIniSection, %g_strImpExpSourceFile%, %strSectionName%, , %A_Space%
	if !StrLen(strSourceIniSection)
	{
		if StrLen(strDescription)
			Oops(o_L["ImpExpSectionNotFound"], g_strImpExpSourceFile, strSectionName, strDescription)
		return
	}

	IniRead, strDestIniSection, %g_strImpExpDestinationFile%, %strSectionName%, , %A_Space% ; empty if not found

	if StrLen(strDestIniSection) and (strSourceIniSection <> strDestIniSection)
	{
		MsgBox, 3, % o_L["ImpExpMenu"] . " - " . g_strAppNameText, % L(o_L["ImpExpReplaceSection"], g_strImpExpDestinationFile, strSectionName, SubStr(strDestIniSection, 1, 200) . (StrLen(strDestIniSection) > 200 ? "`n..." : ""))
		IfMsgBox, Yes
			blnReplaceOK := true
		IfMsgBox, Cancel
			blnAbort := true
	}
	
	if (strSourceIniSection = strDestIniSection)
		blnContentIdentical := true
	
	if (strSourceIniSection <> strDestIniSection) and (!StrLen(strDestIniSection) or blnReplaceOK)
	{
		IniWrite, %strSourceIniSection%, %g_strImpExpDestinationFile%, %strSectionName%
		blnContentTransfered := true
		
		if (g_strImpExpDestinationFile = o_Settings.strIniFile ; this is an import
			and strSectionName = "Global") ; of Global section
			; delete QAPTempFolder value to avoid dependency on local folder from other system (value will default to %TEMP%)
			IniDelete, % o_Settings.strIniFile, Global, QAPTempFolder
	}
}
;------------------------------------------------------------


;------------------------------------------------------------
ButtonImpExpClose:
;------------------------------------------------------------

Gui, ImpExp:Destroy

return
;------------------------------------------------------------


;------------------------------------------------------------
ImpExpChangeButtonNames:
;------------------------------------------------------------

IfWinNotExist, % o_L["ImpExpMenu"] . " " . o_L["ImpExpFavorites"] . " - " . g_strAppNameText
    return  ; Keep waiting.

SetTimer, ImpExpChangeButtonNames, Off
WinActivate

ControlSetText, Button1, % o_L["ImpExpReplaceAll"]
ControlSetText, Button2, % o_L["ImpExpAppend"]

return
;------------------------------------------------------------



;========================================================================================================================
; END OF TRAY MENU ACTIONS
;========================================================================================================================



;========================================================================================================================
!_078_ABOUT-DONATE-HELP:
;========================================================================================================================

;------------------------------------------------------------
GuiAbout:
;------------------------------------------------------------

g_intGui1WinID := WinExist("A")
Gui, 1:Submit, NoHide

strGuiTitle := L(o_L["AboutTitle"], g_strAppNameText, g_strAppVersion)
Gui, 2:New, +Hwndg_strGui2Hwnd, %strGuiTitle%
if (g_blnUseColors)
	Gui, 2:Color, %g_strGuiWindowColor%
Gui, 2:+Owner1
Gui, 2:Font, s12 w700, Verdana
Gui, 2:Add, Link, y10 w380, % L(o_L["AboutText1"], g_strAppNameText, g_strAppVersion, A_PtrSize * 8) ;  ; A_PtrSize * 8 = 32 or 64
Gui, 2:Font, s8 w400, Verdana
Gui, 2:Add, Link, w380, % L(o_L["AboutText2"], g_strAppNameText, A_AhkVersion)
FormatTime, strYear, , yyyy ; current time
Gui, 2:Add, Link, w380, % L(o_L["AboutText3"], chr(169), strYear)
Gui, 2:Add, Text, w380, % L(o_L["AboutUserComputerName"], A_UserName, A_ComputerName)
Gui, 2:Font, s10 w400, Verdana
Gui, 2:Add, Link, w380, % L(o_L["AboutText4"])
Gui, 2:Font, s8 w400, Verdana

aaL := o_L.InsertAmpersand(false, "GuiClose", "DonateButton")

Gui, 2:Add, Button, y+20 vf_btnAboutDonate gGuiDonate, % aaL["DonateButton"]
Gui, 2:Add, Button, yp vf_btnAboutClose g2GuiClose, % aaL["GuiClose"]
GuiCenterButtons(strGuiTitle, 10, 5, 20, "f_btnAboutDonate", "f_btnAboutClose")

GuiControl, Focus, f_btnAboutClose
Gosub, ShowGui2AndDisableGui1

strYear := ""
strGuiTitle := ""
aaL := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiDonate:
;------------------------------------------------------------

g_intGui1WinID := WinExist("A")
Gui, 1:Submit, NoHide

strGuiTitle := L(o_L["DonateTitle"], g_strAppNameText, g_strAppVersion)
Gui, 2:New, +Hwndg_strGui2Hwnd, %strGuiTitle%
if (g_blnUseColors)
	Gui, 2:Color, %g_strGuiWindowColor%
Gui, 2:+Owner1
Gui, 2:Font, s12 w700, Verdana
Gui, 2:Add, Link, y10 w420, % L(o_L["DonateText1"], g_strAppNameText)
Gui, 2:Font, s8 w400, Verdana
Gui, 2:Add, Link, x10 w185 y+10 vf_lnkWhySponsor, % L(o_L["DonateText2"], "https://www.quickaccesspopup.com/sponsoring/") ; will be centered by 2GuiSize
GuiControlGet, arrPos, Pos, f_lnkWhySponsor
g_intLnkWhySponsorWidth := arrPosW

loop, Parse, % "1|2|3|4", |
{
	Gui, 2:Add, Button, % (A_Index = 1 ? "y+20 Default vbtnDonateDefault " : "") . " xm w150 gButtonDonate" . A_LoopField, % o_L["DonatePlatformName" . A_LoopField]
	Gui, 2:Add, Link, x+10 w235 yp, % o_L["DonatePlatformComment" . A_LoopField]
}
; Gui, 2:Add, Button, y+10 Default vbtnDonateDefault xm w150 gButtonDonate2, % o_L["DonatePlatformName2"] ; Patreon out
; Gui, 2:Add, Link, x+10 w235 yp, % o_L["DonatePlatformComment2"] ; Patreon out
; Gui, 2:Add, Button, y+10 Default xm w150 gButtonDonate1, % o_L["DonatePlatformName1"]
; Gui, 2:Add, Link, x+10 w235 yp, % o_L["DonatePlatformComment1"]

Gui, 2:Add, Link, xm y+15 w420, % L(o_L["DonateCheckPrompt2"], o_L["DonateCheckPrompt4"] . " " . o_L["DonateCheckPrompt5"])

Gui, 2:Font, s10 w700, Verdana
Gui, 2:Add, Link, xm y+20 w420, % o_L["DonateText3"]
Gui, 2:Font, s8 w400, Verdana
Gui, 2:Add, Link, xm y+10 w420 Section, % L(o_L["DonateText4"], g_strAppNameText)

strDonateReviewUrlLeft1 := "http://download.cnet.com/Quick-Access-Popup/3000-2344_4-76475848.html"
strDonateReviewUrlLeft2 := "http://www.portablefreeware.com/index.php?id=2765"
strDonateReviewUrlLeft3 := "http://www.softpedia.com/get/System/OS-Enhancements/FoldersPopup.shtml"
strDonateReviewUrlRight1 := "http://fileforum.betanews.com/detail/Quick-Access-Popup/1455462511/1"
strDonateReviewUrlRight2 := "http://www.filecluster.com/System-Utilities/Launchers-Task-Manager-Utilities/Download-Quick-Access-Popup.html"
strDonateReviewUrlRight3 := "http://freewares-tutos.blogspot.ca/2016/05/quick-access-popup-accedez-rapidement.html"

loop, 3
	Gui, 2:Add, Link, % (A_Index = 1 ? "ys+20" : "y+5") . " x25 w150", % "<a href=""" . strDonateReviewUrlLeft%A_Index% . """>" . o_L["DonateReviewNameLeft" . A_Index] . "</a>"

loop, 3
	Gui, 2:Add, Link, % (A_Index = 1 ? "ys+20" : "y+5") . " x175 w150", % "<a href=""" . strDonateReviewUrlRight%A_Index% . """>" . o_L["DonateReviewNameRight" . A_Index] . "</a>"

Gui, 2:Add, Link, y+10 x10 vf_lnkSendLink, % "<a href=""https://www.quickaccesspopup.com/sponsoring/"">" . o_L["DonateText5"] . "</a>"
GuiControlGet, arrPos, Pos, f_lnkSendLink
g_intLnkSendLink := arrPosW

aaL := o_L.InsertAmpersand(false, "GuiDonateCodeInput", "GuiClose")

Gui, 2:Font, s8 w400, Verdana
Gui, 2:Add, Button, x175 y+20 gGuiDonateCodeInput vf_btnDonateCodeInuput, % aaL["GuiDonateCodeInput"]
Gui, 2:Add, Button, x175 yp g2GuiClose vf_btnDonateClose, % aaL["GuiClose"]
GuiCenterButtons(strGuiTitle, 10, 5, 20, "f_btnDonateCodeInuput", "f_btnDonateClose")
Gui, 2:Add, Text

GuiControl, Focus, btnDonateDefault
Gosub, ShowGui2AndDisableGui1

strDonateReviewUrlLeft1 := ""
strDonateReviewUrlLeft2 := ""
strDonateReviewUrlLeft3 := ""
strDonateReviewUrlRight1 := ""
strDonateReviewUrlRight2 := ""
strDonateReviewUrlRight3 := ""
strGuiTitle := ""
arrPos := ""
aaL := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
ButtonDonate1:
ButtonDonate2:
ButtonDonate3:
ButtonDonate4:
;------------------------------------------------------------

strDonatePlatformUrl1 := "https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=TE8TR28QKM3Z8"
strDonatePlatformUrl2 := "https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=Y9VVGCBNJK5DQ"
strDonatePlatformUrl3 := "https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=DV4E4DYVWC5GC"
strDonatePlatformUrl4 := "https://www.quickaccesspopup.com/sponsoring/"

intButton := StrReplace(A_ThisLabel, "ButtonDonate")
Run, % strDonatePlatformUrl%intButton%

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiDonateCodeInput:
;------------------------------------------------------------

g_intGui1WinID := WinExist("A")
Gui, 1:Submit, NoHide

strGuiTitle := L(o_L["DonateTitle"], g_strAppNameText, g_strAppVersion)
Gui, 2:New, +Hwndg_strGui2Hwnd, %strGuiTitle%
if (g_blnUseColors)
	Gui, 2:Color, %g_strGuiWindowColor%
Gui, 2:+Owner1
Gui, 2:Font, s12 w700, Verdana
Gui, 2:Add, Link, y10 w420, % L(o_L["DonateText1"], g_strAppNameText)
Gui, 2:Font, s8 w400, Verdana

Gui, 2:Add, Text, y+20, % o_L["GuiDonateCodeInputDonorLabel"]
Gui, 2:Add, Edit, y+10 w200 vf_strDonorCode

Gui, 2:Add, Text, y+20, % o_L["GuiDonateCodeInputSponsorLabel"]
Gui, 2:Add, Edit, y+10 w200 vf_strSponsorName

aaL := o_L.InsertAmpersand(false, "GuiSave", "DialogCancelButton")

Gui, 2:Font, s8 w400, Verdana
Gui, 2:Add, Button, x175 y+20 gGuiDonateCodeInputSave vf_btnDonateCodeInputSave, % aaL["GuiSave"]
Gui, 2:Add, Button, x175 yp g2GuiClose vf_btnDonateCodeInputCancel, % aaL["DialogCancelButton"]
GuiCenterButtons(strGuiTitle, 10, 5, 20, "f_btnDonateCodeInputSave", "f_btnDonateCodeInputCancel")
Gui, 2:Add, Text

GuiControl, Focus, btnDonateDefault
Gosub, ShowGui2AndDisableGui1

aaL := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiDonateCodeInputSave:
;------------------------------------------------------------
Gui, 2:Submit, NoHide

strDonorCode := Trim(f_strDonorCode)
strSponsorName := Trim(f_strSponsorName)

; Donor code must contain only numbers and capital letters and be 8 digits
if (StrLen(strDonorCode) <> 8 or RegExMatch(strDonorCode, "[^A-Z^0-9]")) ; [^A-Z^0-9] any digit not in A-Z and not in 0-9
	or (strDonorCode <> SubStr(MD5(g_strEscapePipe . strSponsorName . g_strEscapePipe, true), 13, 8))
{
	Oops(o_L["GuiDonateCodeInputDonorInvalid"])
	return
}

o_Settings.Launch.blnDonor.WriteIni(strDonorCode)
o_Settings.Launch.strSponsorName.WriteIni(strSponsorName)

MsgBox, 0, %g_strAppNameText%, % L(o_L["DonateThankyou"], strSponsorName), 10

Gosub, 2GuiClose
Gosub, BuildGui
o_MenuInGui := o_MainMenu
Gosub, GuiShowFromGuiOutside

strDonorCode := ""
strSponsorName := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
GuiHelp:
;------------------------------------------------------------

aaL := o_L.InsertAmpersand(false, "DonateButton", "GuiClose", "DialogTabNext")

g_intGui1WinID := WinExist("A")
Gui, 1:Submit, NoHide

strGuiTitle := L(o_L["HelpTitle"], g_strAppNameText, g_strAppVersion)
Gui, 2:New, +Hwndg_strGui2Hwnd, %strGuiTitle%
if (g_blnUseColors)
	Gui, 2:Color, %g_strGuiWindowColor%
Gui, 2:+Owner1
intWidth := 600
Gui, 2:Font, s12 w700, Verdana
Gui, 2:Add, Text, x10 y10, %g_strAppNameText%
Gui, 2:Font, s10 w400, Verdana
Gui, 2:Add, Link, x10 w%intWidth%, % o_L["HelpTextLead"]

Gui, 2:Font, s8 w600, Verdana
Gui, 2:Add, Tab2, vf_intHelpTab w640 h350 AltSubmit, % " " . o_L["HelpTabGettingStarted"] . " | " . o_L["HelpTabAddingFavorite"] . " | "
	. o_L["HelpTabQAPFeatures"] . " | " . o_L["HelpTabSharedMenus"] . " | " . o_L["HelpTabTipsAndTricks"] . " "

Gui, 2:Font, s8 w400, Verdana
Gui, 2:Tab, 1
Gui, 2:Add, Link, w%intWidth%, % L(o_L["HelpText11"], o_PopupHotkeyNavigateOrLaunchHotkeyMouse.AA.strPopupHotkeyText, o_PopupHotkeyNavigateOrLaunchHotkeyKeyboard.AA.strPopupHotkeyText)
Gui, 2:Add, Link, w%intWidth%, % o_L["HelpText12"]
Gui, 2:Add, Link, w%intWidth%, % L(o_L["HelpText13"], o_PopupHotkeyAlternativeHotkeyMouse.AA.strPopupHotkeyText, o_PopupHotkeyAlternativeHotkeyKeyboard.AA.strPopupHotkeyText)
Gui, 2:Add, Link, w%intWidth%, % o_L["HelpText14"]
Gui, 2:Add, Button, y+25 vf_btnNext1 gNextHelpButtonClicked, % aaL["DialogTabNext"]
GuiCenterButtons(strGuiTitle, 10, 5, 20, "f_btnNext1")

Gui, 2:Tab, 2
Gui, 2:Add, Link, w%intWidth%, % o_L["HelpText21"]
Gui, 2:Add, Link, w%intWidth%, % o_L["HelpText22"]
Gui, 2:Add, Link, w%intWidth%, % L(o_L["HelpText23"], o_PopupHotkeyNavigateOrLaunchHotkeyMouse.AA.strPopupHotkeyText, o_PopupHotkeyNavigateOrLaunchHotkeyKeyboard.AA.strPopupHotkeyText)
Gui, 2:Add, Button, y+25 vf_btnNext2 gNextHelpButtonClicked, % aaL["DialogTabNext"]
GuiCenterButtons(strGuiTitle, 10, 5, 20, "f_btnNext2")

Gui, 2:Tab, 3
Gui, 2:Add, Link, w%intWidth%, % o_L["HelpText31"]
Gui, 2:Add, Link, w%intWidth% y+3, % o_L["HelpText32"]
Gui, 2:Add, Link, w%intWidth%, % o_L["HelpText33"]
Gui, 2:Add, Link, w%intWidth% y+3, % L(o_L["HelpText34"], new Triggers.HotkeyParts(GetFavoriteHotkeyFromLocation("{Settings}")).Hotkey2Text())
Gui, 2:Add, Button, y+25 vf_btnNext3 gNextHelpButtonClicked, % aaL["DialogTabNext"]
GuiCenterButtons(strGuiTitle, 10, 5, 20, "f_btnNext3")

Gui, 2:Tab, 4 ; has text numbered 51, 52, etc.
Gui, 2:Add, Link, w%intWidth%, % o_L["HelpText51"]
objSharedMenuTypes := StrSplit(o_L["DialogExternalTypes"], "|")
Gui, 2:Add, Link, y+2 w%intWidth%, % " - " . objSharedMenuTypes[1]
Gui, 2:Add, Link, y+2 w%intWidth%, % " - " . objSharedMenuTypes[2]
Gui, 2:Add, Link, y+2 w%intWidth%, % " - " . objSharedMenuTypes[3]
Gui, 2:Add, Link, y+5 w%intWidth%, % o_L["HelpText52"]
Gui, 2:Add, Link, y+5 w%intWidth%, % o_L["HelpText53"]
Gui, 2:Add, Link, y+5 w%intWidth%, % o_L["HelpText54"]
Gui, 2:Add, Button, y+25 vf_btnNext4 gNextHelpButtonClicked, % aaL["DialogTabNext"]
GuiCenterButtons(strGuiTitle, 10, 5, 20, "f_btnNext4")

Gui, 2:Tab, 5 ; has text numbered 41, 42, etc.
Gui, 2:Add, Link, w%intWidth%, % o_L["HelpText41"]
Gui, 2:Add, Link, y+5 w%intWidth%, % o_L["HelpText42"]
Gui, 2:Add, Link, y+5 w%intWidth%, % o_L["HelpText43"]
Gui, 2:Add, Link, y+5 w%intWidth%, % o_L["HelpText44"]
Gui, 2:Add, Link, y+5 w%intWidth%, % o_L["HelpText45"]


Gui, 2:Tab
GuiControlGet, arrTabPos, Pos, f_intHelpTab
Gui, 2:Add, Button, % "x180 y" . arrTabPosY + arrTabPosH + 10. " vf_btnHelpDonate gGuiDonate", % aaL["DonateButton"]
Gui, 2:Add, Button, x+80 yp g2GuiClose vf_btnHelpClose, % aaL["GuiClose"]
GuiCenterButtons(strGuiTitle, 10, 5, 20, "f_btnHelpDonate", "f_btnHelpClose")

GuiControl, Focus, btnHelpClose
Gosub, ShowGui2AndDisableGui1

ResetArray("arrSharedMenuTypes")
ResetArray("arrTabPos")
strGuiTitle := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
NextHelpButtonClicked:
;------------------------------------------------------------

Gui, 2:Submit, NoHide

GuiControl, Choose, f_intHelpTab, % f_intHelpTab + 1 ; f_intHelpTab is number of current tab

return
;------------------------------------------------------------



;========================================================================================================================
; END OF ABOUT-DONATE-HELP
;========================================================================================================================



;========================================================================================================================
!_085_DATABASE_COMMANDS:
return
;========================================================================================================================

;------------------------------------------------------------
UsageDbInit:
;------------------------------------------------------------

Diag(A_ThisLabel, "", "START", g_blnIniFileCreation) ; force if first launch

strError := ""
; In portable mode, the two files sqlite.dll and sqlite.def are distributed in the zip file in their 32-bit (sqlite-32-bit.dll) and 64-bit (sqlite-64bit.dll) versions.
; If sqlite.dll does not exit in program's directory, copy the 32-bit or 64-bit file depending on OS (same for sqlite.def).
strError := ""
loop, parse, % "dll|def", |
{
	strExtension := A_LoopField
	if (g_blnPortableMode)
	{
		str64or32 := A_PtrSize * 8 ; executable running is 32-bit (4 * 8) or 64-bit (8 * 8), do not use A_Is64bitOS because it shows the system's spec, not the running executable's spec
		if FileExist(A_ScriptDir . "\sqlite3." . strExtension) ; if prod file exists
		{
			FileGetSize, intSizeSQLiteCurrent, %A_ScriptDir%\sqlite3.%strExtension% ; check size of file in prod, in bytes
			FileGetSize, intSizeSQLiteRequired, %A_ScriptDir%\sqlite3-%str64or32%-bit.%strExtension% ; check size of file required for running executable, in bytes
		}
		if !FileExist(A_ScriptDir . "\sqlite3." . strExtension) or (intSizeSQLiteCurrent <> intSizeSQLiteRequired) ; if no file in prod or wrong file for current executable
			if FileExist(A_ScriptDir . "\sqlite3-" . str64or32 . "-bit." . strExtension)
			{
				FileCopy, %A_ScriptDir%\sqlite3-%str64or32%-bit.%strExtension%, %A_ScriptDir%\sqlite3.%strExtension%, 1 ; overwrite if wrong file exists
				if (ErrorLevel)
				{
					Oops("Exit ~1~ properly before retstarting it with a different bitsize build (32-bit or 64-bit)", g_strAppNameText)
					ExitApp
				}
			}
			else
				strError .= A_ScriptDir . "\sqlite3-" . str64or32 . "-bit." . strExtension . "`n"
	}
	else
		if !FileExist(A_ScriptDir . "\sqlite3." . strExtension)
			strError .= A_ScriptDir . "\sqlite3." . strExtension . "`n"
}

if StrLen(strError)
{
	Diag(A_ThisLabel, "Db SQLite Missing", "STOP", g_blnIniFileCreation) ; force if first launch
	Oops(o_L["OopsUsageDbSQLiteMissing"], strError)
	g_blnUsageDbEnabled := false
	return
}
else ; init SQLite wraper object
	global o_UsageDb := New SQLiteDb ; was g_objUsageDb

; for pre-v9.1.9.10 version upgrading to v9.1.9.11
if !FileExist(g_strUsageDbFile) and FileExist(g_strUsageDbFileOld)
	FileCopy, %g_strUsageDbFileOld%, %g_strUsageDbFile%

blnUsageDbIsNew := !FileExist(g_strUsageDbFile)

if !o_UsageDb.OpenDb(g_strUsageDbFile)
{
	Diag(A_ThisLabel, "SQLite Error OpenDb Message: " . o_UsageDb.ErrorMsg . " Code: " . o_UsageDb.ErrorCode, "STOP", g_blnIniFileCreation) ; force if first launch
	Oops("SQLite Error OpenDb`n`nMessage: " . o_UsageDb.ErrorMsg . "`nCode: " . o_UsageDb.ErrorCode . "`nFile: " . g_strUsageDbFile)
	g_blnUsageDbEnabled := false
	return
}

if (blnUsageDbIsNew)
{
	strUsageDbSQL := "CREATE TABLE IF NOT EXISTS Usage (id INTEGER PRIMARY KEY"
		. ",TargetPath,TargetDateTime"
		. ",CollectType,CollectDateTime,CollectPath"
		. ",TargetAttributes,TargetType,TargetExtension"
		. ",MenuTrigger,MenuHotkeyTypeDetected,MenuAlternative,MenuTargetAppName,MenuTargetClass"
		. ",MenuFavoriteType,MenuFavoriteName,MenuOriginalLocation,MenuLiveLevels,MenuShortcut,MenuHotstring"
		. ",MenuIconResource,MenuParameters,MenuStartIn,MenuLaunchWith,MenuSoundLocation"
		. ",MenuDateCreated,MenuDateModified"
		. ");"
	strUsageDbSQL .= "`n" . "CREATE INDEX IF NOT EXISTS iTargetPath ON Usage (TargetPath);"
	strUsageDbSQL .= "`n" . "CREATE INDEX IF NOT EXISTS iCollectDateTime ON Usage (CollectDateTime);"
	strUsageDbSQL .= "`n" . "CREATE TABLE IF NOT EXISTS zMetadata (LatestCollected, PopularFoldersMenuData, PopularFilesMenuData, DrivesMenuData, RecentFoldersMenuData, RecentFilesMenuData);"
	strUsageDbSQL .= "`n" . "INSERT INTO zMetadata VALUES('0', '', '', '', '', '');" ; make sure it has values for all columns

	If !o_UsageDb.Exec(strUsageDbSQL)
	{
		Diag(A_ThisLabel, "SQLite CREATE Error Message: " . o_UsageDb.ErrorMsg . " Code: " . o_UsageDb.ErrorCode, "STOP", g_blnIniFileCreation) ; force if first launch
		Oops("SQLite CREATE Error`n`nMessage: " . o_UsageDb.ErrorMsg . "`nCode: " . o_UsageDb.ErrorCode . "`nQuery: " . strUsageDbSQL)
		g_blnUsageDbEnabled := false
		return
	}
}
else ; modifications for previous versions
{
	strUsageDbSQL := ""
	if !GetUsageDbColumnExist("zMetadata", "PopularFoldersMenuData") ; added in v9.2.0.2
	{
		strUsageDbSQL .= "ALTER TABLE zMetaData ADD COLUMN PopularFoldersMenuData;"
		strUsageDbSQL .= "ALTER TABLE zMetaData ADD COLUMN PopularFilesMenuData;"
		strUsageDbSQL .= "ALTER TABLE zMetaData ADD COLUMN DrivesMenuData;"
	}
	if !GetUsageDbColumnExist("zMetadata", "RecentFoldersMenuData") ; added in v9.2.0.5
	{
		strUsageDbSQL .= "ALTER TABLE zMetaData ADD COLUMN RecentFoldersMenuData;"
		strUsageDbSQL .= "ALTER TABLE zMetaData ADD COLUMN RecentFilesMenuData;"
	}
	If StrLen(strUsageDbSQL)
		!o_UsageDb.Exec(strUsageDbSQL)
		{
			Oops("SQLite ALTER Error`n`nMessage: " . o_UsageDb.ErrorMsg . "`nCode: " . o_UsageDb.ErrorCode . "`nQuery: " . strUsageDbSQL)
			g_blnUsageDbEnabled := false
			return
		}
}

; check maximum size

FileGetSize, intSizeBeforeDelete, %g_strUsageDbFile%
intMaximumSizeBytes := Round(o_Settings.Database.fltUsageDbMaximumSize.IniValue * 1048576, 0) ; = * 1 MB
if (intSizeBeforeDelete > intMaximumSizeBytes)
{
	strUsageDbSQL := "SELECT id FROM Usage;"
	If !o_UsageDb.GetTable(strUsageDbSQL, objUsageDbTable)
		Oops("SQLite GetTable Error`n`nMsg:`t" . o_UsageDb.ErrorMsg . "`nCode:`t" . o_UsageDb.ErrorCode . "`n" . strUsageDbSQL)
	
	fltProportionOfRecordsToDelete := ((intSizeBeforeDelete - intMaximumSizeBytes) / intSizeBeforeDelete)
	intRecordsToDelete := Round(objUsageDbTable.RowCount * fltProportionOfRecordsToDelete, 0) + Round(objUsageDbTable.RowCount / 10, 0) ;  difference + 10%
	
	strUsageDbSQL := "DELETE FROM Usage WHERE id in (SELECT id FROM Usage ORDER BY id LIMIT "
		. intRecordsToDelete . ");" ; delete 10% latest entries of the database
	If !o_UsageDb.Exec(strUsageDbSQL)
		Oops("SQLite DELETE Error`n`nMsg:`t" . o_UsageDb.ErrorMsg . "`nCode:`t" . o_UsageDb.ErrorCode . "`n" . strUsageDbSQL)
	
	strUsageDbSQL := "VACUUM;"
	If !o_UsageDb.Exec(strUsageDbSQL)
		Oops("SQLite VACUUM Error`n`nMsg:`t" . o_UsageDb.ErrorMsg . "`nCode:`t" . o_UsageDb.ErrorCode . "`n" . strUsageDbSQL)
}

str64or32 := ""
strExtension := ""
strError := ""
blnUsageDbIsNew := ""
strUsageDbSQL := ""
intSizeBeforeDelete := ""
intMaximumSizeBytes := ""
fltProportionOfRecordsToDelete := ""
intRecordsToDelete := ""
intSizeSQLiteCurrent := ""
intSizeSQLiteRequired := ""
objUsageDbTable := ""

Diag(A_ThisLabel, "", "STOP", g_blnIniFileCreation) ; force if first launch
return
;------------------------------------------------------------


;------------------------------------------------------------
UsageDbCollectMenuData:
;------------------------------------------------------------

if !(g_blnUsageDbEnabled)
{
	SetTimer, UsageDbCollectMenuData, Off
	Diag(A_ThisLabel . ":g_blnUsageDbEnabled" , g_blnUsageDbEnabled, "")
	return
}

Diag(A_ThisLabel, "", "START-COLLECT")
RegRead, strUsageDbRecentsFolder, HKEY_CURRENT_USER, Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders, Recent

strUsageDbItemsList := ""
Loop, Files, %strUsageDbRecentsFolder%\*.*
	strUsageDbItemsList .= A_LoopFileTimeModified . "`t" . A_LoopFileFullPath . "`n"
Sort, strUsageDbItemsList, R
; Diag(A_ThisLabel . ":strUsageDbItemsList", StrReplace(StringLeftDotDotDot(strUsageDbItemsList, 500), "`n", "|"))
Diag(A_ThisLabel . ":strUsageDbItemsList (after)", "", "ELAPSED")

if (g_blnUsageDbDebug or o_Settings.Launch.blnDiagMode.IniValue)
	strUsageDbReport := ""

intUsageDbtNbItems := 0

strUsageDbSQL := "SELECT LatestCollected FROM zMetadata;"
if !o_UsageDb.Query(strUsageDbSQL, o_MetadataRecordSet)
{
	Diag(A_ThisLabel, "SQLite QUERY zMETADATA Error: " . strUsageDbSQL, "STOP")
	Oops("SQLite QUERY zMETADATA Error`n`nMessage: " . o_UsageDb.ErrorMsg . "`nCode: " . o_UsageDb.ErrorCode . "`nQuery: " . strUsageDbSQL)
	g_blnUsageDbEnabled := false
	return
}

o_MetadataRecordSet.Next(o_MetadataRow)
strUsageDbPreviousLatestCollected := o_MetadataRow[1] ; first (and only) field is LatestCollected
o_MetadataRecordSet.Free()
; Diag(A_ThisLabel . ":strUsageDbPreviousLatestCollected (before)", strUsageDbPreviousLatestCollected)

strUsageDbSQL := "INSERT INTO Usage ("
		. "TargetPath,TargetDateTime"
		. ",CollectType,CollectDateTime,CollectPath"
		. ",TargetAttributes,TargetType,TargetExtension"
		. ") VALUES`n"
Loop, parse, strUsageDbItemsList, `n
{
	if !StrLen(A_LoopField) ; last line is empty
		continue
	if (A_Index > g_intUsageDbRecentLimit)
		break

	saUsageDbShortcutFullPath := StrSplit(A_LoopField, A_Tab)
	strUsageDbShortcutDateTime := saUsageDbShortcutFullPath[1]
	strUsageDbShortcutPath := saUsageDbShortcutFullPath[2]
	
	if (A_Index = 1) ; because sorted by shortcut date reverse, first is most recent
		strUsageDbLatestCollected := strUsageDbShortcutDateTime
	if (strUsageDbShortcutDateTime <= strUsageDbPreviousLatestCollected)
		break
	
	FileGetShortcut, %strUsageDbShortcutPath%, strUsageDbTargetPath
	; RecentGetUsageDbTargetFileInfo to check if on an offline server
	RecentGetUsageDbTargetFileInfo(strUsageDbTargetPath, strUsageDbTargetAttributes, strUsageDbTargetType, strUsageDbTargetDateTime, strUsageDbTargetExtension, A_ThisLabel)
	
	if StrLen(strUsageDbTargetAttributes)
	{
		if (g_blnUsageDbDebug)
			strUsageDbReport .= strUsageDbTargetPath . "`n"

		strUsageDbSQL .= "("
			; target file and date-time
			. "'" . EscapeQuote(strUsageDbTargetPath) . "'"
			. ",'" . ConvertUsageDbDateFormat(strUsageDbTargetDateTime) . "'"
			; collect type, time and shortcut file
			. ",'RecentItems'"
			. ",'" . ConvertUsageDbDateFormat(strUsageDbShortcutDateTime) . "'"
			. ",'" . EscapeQuote(strUsageDbShortcutPath) . "'"
			
			; target file info
			. ",'" . strUsageDbTargetAttributes . "'"
			. ",'" . strUsageDbTargetType . "'"
			. ",'" . EscapeQuote(strUsageDbTargetExtension) . "'"
			. "),`n"

		intUsageDbtNbItems++
	}
}
strUsageDbSQL := SubStr(strUsageDbSQL, 1, StrLen(strUsageDbSQL) - 2) ; remove last ",`n"
Diag(A_ThisLabel . ":strUsageDbPreviousLatestCollected (after)", strUsageDbPreviousLatestCollected, "ELAPSED")
; Diag(A_ThisLabel . ":strUsageDbShortcutDateTime (last)", strUsageDbShortcutDateTime)
; Diag(A_ThisLabel . ":strUsageDbSQL (last)", StringLeftDotDotDot(strUsageDbSQL, 1000))
Diag(A_ThisLabel . ":intUsageDbtNbItems", intUsageDbtNbItems, "ELAPSED")

if (g_blnUsageDbDebug)
	ToolTip, % StringLeftDotDotDot(strUsageDbSQL, 5000)

o_UsageDb.Exec("BEGIN TRANSACTION;")
If (intUsageDbtNbItems) and !o_UsageDb.Exec(strUsageDbSQL)
{
	Diag(A_ThisLabel, "SQLite INSERT Recent Items Error: " . strUsageDbSQL, "STOP")
	Oops("SQLite INSERT Recent Items Error`n`nMessage: " . o_UsageDb.ErrorMsg . "`n`nCode: " . o_UsageDb.ErrorCode . "`nQuery: " . strUsageDbSQL)
	g_blnUsageDbEnabled := false
	o_UsageDb.Exec("ROLLBACK;")
	return
}	

strUsageDbPreviousLatestCollected := strUsageDbLatestCollected

strUsageDbSQL := "UPDATE zMetadata SET LatestCollected = '" . strUsageDbLatestCollected . "';"
If !o_UsageDb.Exec(strUsageDbSQL)
{
	Diag(A_ThisLabel, "SQLite UPDATE LatestCollected zMETADATA Error: " . strUsageDbSQL, "STOP")
	Oops("SQLite UPDATE LatestCollected zMETADATA Error`n`nMessage: " . o_UsageDb.ErrorMsg . "`nCode: " . o_UsageDb.ErrorCode . "`nQuery: " . strUsageDbSQL)
	g_blnUsageDbEnabled := false
	o_UsageDb.Exec("ROLLBACK;")
	return
}

; we had no error
o_UsageDb.Exec("COMMIT;")

if (g_blnUsageDbDebug)
{
	if (g_blnUsageDbDebugBeep)
		SoundBeep, 300
	ToolTip, % "Items added: " . intUsageDbtNbItems . "`n`n" . StringLeftDotDotDot(strUsageDbReport, 2000)
	Sleep, % (intUsageDbtNbItems = 0 ? 300 : 2000)
	ToolTip
}

; preprocess Frequent Folders, Frequent Files, Recent Folders, Recent Files and Drives menu data
Gosub, DynamicMenusPreProcess

strUsageDbRecentsFolder := ""
strUsageDbItemsList := ""
strUsageDbReport := ""
intUsageDbtNbItems := ""
strUsageDbSQL := ""
o_MetadataRecordSet := ""
saUsageDbShortcutFullPath := ""
strUsageDbShortcutDateTime := ""
strUsageDbShortcutPath := ""
strUsageDbLatestCollected := ""
strUsageDbTargetPath := ""
strUsageDbTargetAttributes := ""
strUsageDbTargetType := ""
strUsageDbTargetDateTime := ""
strUsageDbTargetExtension := ""
strUsageDbPreviousLatestCollected := ""

Diag(A_ThisLabel, "", "STOP-COLLECT")

return
;------------------------------------------------------------


;------------------------------------------------------------
DynamicMenusPreProcess:
;------------------------------------------------------------

if !(g_blnUsageDbEnabled)
	return

Diag(A_ThisLabel, "", "START")

strDynamicDbSQL := ""
loop, parse, % "Folders|Files", |
{
	Diag(A_ThisLabel . ":StartPopular", A_Loopfield, "ELAPSED")
	strFoldersOrFiles := A_Loopfield
	strMenuItemsList%strFoldersOrFiles% := "" ; menu name|menu item name|label|icon

	if (strFoldersOrFiles = "Folders")
		if !(o_QAPfeatures.aaQAPfeaturesInMenus.HasKey("{Popular Folders}")) ; we don't have this QAP features in at least one menu
			continue
		else
		{
			strTargetType := "Folder"
			strFoldersOrFilesMenuNameLocalized := o_L["MenuPopularMenusFolders"]
		}
	else ; "Files"
		if !(o_QAPfeatures.aaQAPfeaturesInMenus.HasKey("{Popular Files}")) ; we don't have this QAP features in at least one menu
			continue
		else
		{
			strTargetType := "File"
			strFoldersOrFilesMenuNameLocalized := o_L["MenuPopularMenusFiles"]
		}

	; SQLite GetTable
	; Parse table
	strUsageDbSQL := "SELECT TargetPath, COUNT(TargetPath) AS 'Nb' FROM Usage WHERE CollectDateTime >= date('now','-" . o_Settings.Database.intUsageDbDaysInPopular.IniValue . " day') "
		. "GROUP BY TargetPath COLLATE NOCASE HAVING TargetType='" . strTargetType . "' COLLATE NOCASE ORDER BY COUNT(TargetPath) DESC;"
	if !o_UsageDb.Query(strUsageDbSQL, o_RecordSet)
	{
		Diag(A_ThisLabel, "SQLite QUERY POPULAR MENUS Error", "STOP")
		Oops("SQLite QUERY POPULAR MENUS Error`n`nMessage: " . o_UsageDb.ErrorMsg . "`nCode: " . o_UsageDb.ErrorCode . "`nQuery: " . strUsageDbSQL)
		g_blnUsageDbEnabled := false
		return
	}
	Diag(A_ThisLabel . ":After SQLiteQuery", o_RecordSet.HasRows, "ELAPSED")

	intPopularItemsCount := 0
	Loop
	{
		if o_RecordSet.Next(o_Row) = -1 ; end of recordset
			break
		strPath := o_Row[1]
		strTargetNb := o_Row[2]
		Diag(A_ThisLabel . ":Processing Start", strPath . " " . strTargetType, "ELAPSED")
		; RecentFileExistInPath to check if on an offline server
		
		if (o_Settings.MenuIcons.blnRetrieveIconInFrequentMenus.IniValue)
			if (strTargetNb <= 1 or !RecentFileExistInPath(strPath, A_ThisLabel)) ; skip if not enough frequent or if not exits
				continue
		; else consider that file exists if we do not retrieve icon
		
		intPopularItemsCount++
		strMenuItemName := strPath
		if (o_Settings.Database.blnUsageDbShowPopularityIndex.IniValue)
			strMenuItemName .= " [" . strTargetNb . "]"
		if (o_Settings.MenuIcons.blnRetrieveIconInFrequentMenus.IniValue)
			strIcon := (strFoldersOrFiles = "Folders" ? GetFolderIcon(strPath) : GetIcon4Location(strPath))
		else
			strIcon := (strFoldersOrFiles = "Folders" ? "iconFolder" : "iconDocuments")
		strMenuItemsList%strFoldersOrFiles% .= strFoldersOrFilesMenuNameLocalized . "|" . strMenuItemName
			. (strFoldersOrFiles = "Folders" ? "|Folder|" : "|Document|") . strIcon . "`n"
		Diag(A_ThisLabel . ":Processing Stop", intPopularItemsCount, "ELAPSED")
		if (intPopularItemsCount >= o_Settings.Menu.intRecentFoldersMax.IniValue)
			break ; Folders or Files menus is complete
	}
	o_RecordSet.Free()
	if (intPopularItemsCount < o_Settings.Menu.intRecentFoldersMax.IniValue)
		strMenuItemsList%strFoldersOrFiles% .= strFoldersOrFilesMenuNameLocalized . "|" . L(o_L["MenuPopularMenusWillImprove"], g_strAppNameText) . "|GuiShowNeverCalled|iconAbout`n"

	if StrLen(strMenuItemsList%strFoldersOrFiles%)
		strDynamicDbSQL .= "Popular" . strFoldersOrFiles .  "MenuData = '" . EscapeQuote(strMenuItemsList%strFoldersOrFiles%) "', " ; PopularFoldersMenuData and PopularFilesMenuData
	Diag(A_ThisLabel . ":FinishPopular", A_Loopfield, "ELAPSED")
}
; Diag(A_ThisLabel . ":pre-strDynamicDbSQL", StrReplace(strDynamicDbSQL, "`n", "``n"))

if (o_QAPfeatures.aaQAPfeaturesInMenus.HasKey("{Drives}")) ; we have this QAP features in at least one menu
{
	gosub, GetDrivesMenuListPreprocess ; update g_strMenuItemsListDrives
	strDynamicDbSQL .= "DrivesMenuData = '" . EscapeQuote(g_strMenuItemsListDrives) . "', "
}
Diag(A_ThisLabel . ":After GetDrivesMenuListPreprocess", intPopularItemsCount, "ELAPSED")
; Diag(A_ThisLabel . ":g_strMenuItemsListDrives", StrReplace(g_strMenuItemsListDrives, "`n", "``n"))

Diag(A_ThisLabel . ":StartRecent", A_Loopfield, "ELAPSED")
if (o_QAPfeatures.aaQAPfeaturesInMenus.HasKey("{Recent Folders}") or o_QAPfeatures.aaQAPfeaturesInMenus.HasKey("{Recent Files}")) ; we have one of these QAP features in at least one menu
{
	gosub, GetMenusListRecentItemsPreprocess ; update g_strMenuItemsListRecentFolders and g_strMenuItemsListRecentFiles
	strDynamicDbSQL .= "RecentFoldersMenuData = '" . EscapeQuote(g_strMenuItemsListRecentFolders) . "', "
	strDynamicDbSQL .= "RecentFilesMenuData = '" . EscapeQuote(g_strMenuItemsListRecentFiles) . "', "
}
Diag(A_ThisLabel . ":FinishProcessing", A_Loopfield, "ELAPSED")
Diag(A_ThisLabel . ":g_strMenuItemsListRecentFolders", StrReplace(g_strMenuItemsListRecentFolders, "`n", "``n"), "ELAPSED")
Diag(A_ThisLabel . ":g_strMenuItemsListRecentFiles", StrReplace(g_strMenuItemsListRecentFiles, "`n", "``n"), "ELAPSED")

if StrLen(strDynamicDbSQL) ; if menu does not contain Drives, Popular or Recent menus, strDynamicDbSQL is empty
{
	strDynamicDbSQL := SubStr(strDynamicDbSQL, 1, -2) ; remove last ", "
	strDynamicDbSQL := "UPDATE zMetadata SET " . strDynamicDbSQL . ";" ; add opening command and ending semi-colon
	; Diag(A_ThisLabel . ":strDynamicDbSQL", StrReplace(strDynamicDbSQL, "`n", "``n"))

	If !o_UsageDb.Exec(strDynamicDbSQL)
	{
		Diag(A_ThisLabel, "SQLite UPDATE zMETADATA Error: " . StrReplace(strDynamicDbSQL, "`n", "``n"), "STOP")
		Oops("SQLite UPDATE Popular zMETADATA Error`n`nMessage: " . o_UsageDb.ErrorMsg . "`nCode: " . o_UsageDb.ErrorCode . "`nQuery: " . strDynamicDbSQL)
		return
	}
}
Diag(A_ThisLabel . ":FinishRecent", A_Loopfield, "ELAPSED")

strPath := ""
strMenuItemName := ""
strIcon := ""
strUsageDbSQL := ""
o_RecordSet := ""
o_Row := ""
strTargetType := ""
strMenuItemsList := ""
strDynamicDbSQL := ""
g_strMenuItemsListDrives := ""

Diag(A_ThisLabel, "", "STOP")
return
;------------------------------------------------------------


;------------------------------------------------------------
GetDrivesMenuListPreprocess:
GetDrivesMenuListRefresh:
;------------------------------------------------------------
Diag(A_ThisLabel, "", "ELAPSED")

g_strMenuItemsListDrives := "" ; menu name|menu item name|label|icon

DriveGet, strDrivesList, List

; gather info for menu (can be long for CD/DVD drives)
Loop, parse, strDrivesList
{
	strPath := A_LoopField . ":"
	DriveGet, strStatus, Status, %strPath%
	if (strStatus = "Ready")
	{
		DriveGet, intCapacity, Capacity, %strPath%
		DriveSpaceFree, intFreeSpace,  %strPath%
		DriveGet, strDriveLabel, Label, %strPath%
		DriveGet, strDriveType, Type, %strPath% ; Unknown, Removable, Fixed, Network, CDROM, RAMDisk
	}
	else
	{
		strDriveLabel := strStatus
		intCapacity := ""
		intFreeSpace := ""
		strDriveType := ""
	}
	
	strMenuItemName := strPath . " " . strDriveLabel
	if StrLen(intFreeSpace) and StrLen(intCapacity)
		strMenuItemName .= " " . L(o_L["MenuDrivesSpace"], intFreeSpace // 1024, intCapacity // 1024)
	if InStr("Fixed|Unknown", strDriveType)
		strIcon := "iconDrives"
	else
		strIcon := "icon" . strDriveType
	g_strMenuItemsListDrives .= o_L["MenuDrives"] . "|" . strMenuItemName . "|OpenDrives|" . strIcon . "`n"
}

strDrivesList := ""
strPath := ""
strStatus := ""
intCapacity := ""
intFreeSpace := ""
strDriveLabel := ""
strDriveType := ""

Diag(A_ThisLabel, "", "ELAPSED")
return
;------------------------------------------------------------


;------------------------------------------------------------
GetMenusListRecentItemsPreprocess:
GetMenusListRecentItemsRefresh:
;------------------------------------------------------------

if (g_blnUsageDbEnabled) ; use SQLite usage database
{
	strUsageDbSQL := "SELECT TargetPath, TargetType FROM Usage WHERE (TargetType='Folder' OR TargetType='File') ORDER BY CollectDateTime DESC;"
	if !o_UsageDb.Query(strUsageDbSQL, o_RecordSet)
	{
		Diag(A_ThisLabel, "SQLite QUERY Build menu Error", "STOP")
		Oops("SQLite QUERY Build menu Error`n`nMessage: " . o_UsageDb.ErrorMsg . "`nCode: " . o_UsageDb.ErrorCode . "`nQuery: " . strUsageDbSQL)
		return
	}
	objDuplicatesFinder := Object()
}
else ; gather recent items the old way, directly from Windows
{
	strShortcutsItemsList := "" ; menu name|menu item name|label|icon
	RegRead, strRecentsFolder, HKEY_CURRENT_USER, Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders, Recent
	Loop, Files, %strRecentsFolder%\*.* ; tried to limit to number of recent but they are not sorted chronologically
		strShortcutsItemsList .= A_LoopFileTimeModified . "`t" . A_LoopFileFullPath . "`n"
	Sort, strShortcutsItemsList, R
	; a `n ends the last line of the list
}
Diag(A_ThisLabel . ":AfterSelect", A_Loopfield, "ELAPSED")

; loop data source

g_strMenuItemsListRecentFolders := ""
intRecentFoldersCount := 0
g_strMenuItemsListRecentFiles := ""
intRecentFilesCount := 0

Loop
{
	; get next item
	if (g_blnUsageDbEnabled)
	{
		if o_RecordSet.Next(o_Row) = -1 ; end of recordset
			break
		strTargetPath := o_Row[1]
		strTargetType := o_Row[2]
		if (objDuplicatesFinder.HasKey(strTargetPath))
		{
			Diag(A_ThisLabel . ":Skip Duplicate", strTargetPath . " " . strTargetType, "ELAPSED")
			continue
		}
		else ; new item
			objDuplicatesFinder[strTargetPath] := strTargetType ; value is not used, only the key is checked
	}
	else
	{
		if !StrLen(strShortcutsItemsList)
			break
		strItem := SubStr(strShortcutsItemsList, 1, InStr(strShortcutsItemsList, "`n") - 1)
		strShortcutsItemsList := SubStr(strShortcutsItemsList, InStr(strShortcutsItemsList, "`n") + 1)
		
		arrShortcutFullPath := StrSplit(strItem, A_Tab)
		strShortcutFullPath := arrShortcutFullPath[2]
		
		FileGetShortcut, %strShortcutFullPath%, strTargetPath
		
		if (ErrorLevel) ; hidden or system files (like desktop.ini) returns an error
			continue
		; RecentFileExist to check if on an offline server
		if !RecentFileExist(strTargetPath, A_ThisLabel) ; if folder/document was deleted, on a removable drive or offline server
			continue
		; RecentLocationIsDocument to check if on an offline server
		strTargetType := (RecentLocationIsDocument(strTargetPath, A_ThisLabel) ? "File" : "Folder")
	}
	Diag(A_ThisLabel . ":ProcessingStart", strTargetPath . " " . strTargetType, "ELAPSED")

	strMenuName := strTargetPath
	strIcon := (strTargetType = "Folder" ? GetFolderIcon(strTargetPath) : GetIcon4Location(strTargetPath))
	if (strTargetType = "Folder") and (intRecentFoldersCount < o_Settings.Menu.intRecentFoldersMax.IniValue)
	{
		g_strMenuItemsListRecentFolders .= o_L["MenuRecentFolders"] . "|" . strMenuName . "|Folder|" . strIcon . "`n"
		intRecentFoldersCount++
		Diag(A_ThisLabel . ":ProcessingFinish-Folder", intRecentFoldersCount, "ELAPSED")
	}
	; do not "else"
	if (strTargetType = "File") and (intRecentFilesCount < o_Settings.Menu.intRecentFoldersMax.IniValue)
	{
		g_strMenuItemsListRecentFiles .= o_L["MenuRecentFiles"] . "|" . strMenuName . "|Document|" . strIcon . "`n"
		intRecentFilesCount++
		Diag(A_ThisLabel . ":ProcessingFinish-File", intRecentFoldersCount, "ELAPSED")
	}

	if (intRecentFoldersCount >= o_Settings.Menu.intRecentFoldersMax.IniValue) and (intRecentFilesCount >= o_Settings.Menu.intRecentFoldersMax.IniValue)
		break ; both Folders and Files menus are complete
}
if (g_blnUsageDbEnabled) ; use SQLite usage database
	o_RecordSet.Free()

intRecentFoldersCount := ""
intRecentFilesCount := ""
strUsageDbSQL := ""
o_RecordSet := ""
o_Row := ""
strTargetPath := ""
strTargetType := ""
objDuplicatesFinder := ""
strShortcutsItemsList := ""
strRecentsFolder := ""
ResetArray("arrShortcutFullPath")
strShortcutFullPath := ""
strNumericShortcut := ""
strMenuName := ""
strIcon := ""
ResetArray("arrMenuItemsList")

return
;------------------------------------------------------------


;========================================================================================================================
; END OF DATABASE COMMANDS
;========================================================================================================================


;========================================================================================================================
!_090_VARIOUS_COMMANDS:
return
;========================================================================================================================


;------------------------------------------------------------
GetCurrentLocation(strClass, strWinID)
; return current location in in Explorer, Directory Opus, Total Commander or file dialog box window identified by class and windows ID
;------------------------------------------------------------
{
	global g_strDOpusListText

	strLocation := ""
	
	if WindowIsExplorer(strClass) or WindowIsTotalCommander(strClass) or WindowIsDirectoryOpus(strClass)
		or WindowIsDialog(strClass, strWinID)
	{
		if WindowIsDirectoryOpus(strClass)
		{
			Gosub, RefreshDOpusListersListText
			saDOpusListers := CollectDOpusListersList(g_strDOpusListText) ; list all listers, excluding special folders like Recycle Bin
			
			; From leo @ GPSoftware (http://resource.dopus.com/viewtopic.php?f=3&t=23013):
			; Lines will have active_lister="1" if they represent tabs from the active lister.
			; To get the active tab you want the line with active_lister="1" and tab_state="1".
			; tab_state="1" means it's the selected tab, on the active side of the lister.
			; tab_state="2" means it's the selected tab, on the inactive side of a dual-display lister.
			; Tabs which are not visible (because another tab is selected on top of them) don't get a tab_state attribute at all.

			for intIndex, aaLister in saDOpusListers
				if (aaLister.strActiveLister = "1" and aaLister.strTabState = "1") ; this is the active tab
				{
					strLocation := ComUnHTML(aaLister.strLocationURL) ; ComUnHTML convert HTML entities to text (like "&apos;")
					break
				}
		}
		else ; Explorer, TotalCommander or dialog boxes
		{
			; use the clipblard to get the current location from dialog box or Total Commander
			objPrevClipboard := ClipboardAll ; Save the entire clipboard
			ClipBoard := ""

			; Obsolete notes (since Shell.Application is used to get Explore current location) - but keep here anyway
			; With Explorer, the key sequence {F4}{Esc} selects the current location of the window.
			; With dialog boxes, the key sequence {F4}{Esc} generally selects the current location of the window. But, in some
			; dialog boxes, the {Esc} key closes the dialog box. We will check window title to detect this behavior.

			intTries := 3
			intWaitTimeIncrement := 150 ; time allowed to get title
			strAddThisFolderWindowTitle := ""
			Loop, %intTries%
			{
				Sleep, intWaitTimeIncrement * A_Index
				WinGetTitle, strAddThisFolderWindowTitle, A ; to check later if this window is closed unexpectedly
			} Until (StrLen(strAddThisFolderWindowTitle))
			strWindowActiveTitle := strAddThisFolderWindowTitle ; now these are the same... check later if the window was closed unexpectedly
			
			if WindowIsTotalCommander(strClass)
			{
				cm_CopySrcPathToClip := 2029
				SendMessage, 0x433, %cm_CopySrcPathToClip%, , , ahk_class TTOTAL_CMD ; put current locatin in Clipboard
				ClipWait, 1
				strLocation := Clipboard
			}
			else if WindowIsExplorer(strClass)
			{
				; Gets the active IE or Explorer window
				for pExplorer in ComObjCreate("Shell.Application").Windows
					if (pExplorer.HWND = strWinID)
					{
						strLocation :=  ProcessLocationURL(UriDecode(pExplorer.LocationURL))
						Break
					}
			}
			else ; dialog boxes
			{
				intTries := 3
				intWaitTimeIncrement := 300 ; time allowed for dialog boxes
				Loop, %intTries%
				{
					Sleep, intWaitTimeIncrement * A_Index
					SendInput, {F4}{Esc} ; F4 move the caret the "Go To A Different Folder box" and {Esc} select it content ({Esc} could be replaced by ^a to Select All)
					Sleep, intWaitTimeIncrement * A_Index
					SendInput, ^c ; Copy
					Sleep, intWaitTimeIncrement * A_Index
					WinGetTitle, strWindowActiveTitle, A ; to check if the window was closed unexpectedly
				} Until (StrLen(ClipBoard) or (strAddThisFolderWindowTitle <> strWindowActiveTitle))
				if (A_ThisLabel = "AddThisFolderXpress") ; escape from address bar
					SendInput, {Esc}
				strLocation := Clipboard
			}

			Clipboard := objPrevClipboard ; Restore the original clipboard
		}
	}
	else if InStr(g_strModernBrowsers, strClass)
		strLocation := GetCurrentUrlAcc(strClass)
	else if InStr(g_strLegacyBrowsers, strClass) ; LegacyBrowsers (as of https://autohotkey.com/boards/viewtopic.php?p=116752#p116752)
		strLocation := GetCurrentUrlDDE(strClass) ; empty string if DDE not supported (or not a browser)

	return strLocation
}
;------------------------------------------------------------


;------------------------------------------------------------
AdjustColumnsWidth:
;------------------------------------------------------------

Loop, % LV_GetCount("Column")
	if (StrLen(GetFavoritesListFilter()) and A_Index = LV_GetCount("Column"))
		LV_ModifyCol(LV_GetCount("Column"), 0) ; when filtered, hide last column "Object Position (hidden)"
	else
		LV_ModifyCol(A_Index, "AutoHdr") ; adjust other columns width

/*
FOLLOWING NOT REQUIRED ANYMORE
when using option AutoHdr ("If applied to the last column, it will be made at least as wide as all the remaining space in the ListView.")

; See http://www.autohotkey.com/board/topic/6073-get-listview-column-width-with-sendmessage/
Loop, %intNbColAuto%
{
	intColZeroBased := A_Index - 1 ; column index, zero-based
	SendMessage, 0x1000+29, %intColZeroBased%, 0, SysListView321, ahk_id %g_strAppHwnd%
	intColSum += ErrorLevel ; column width
}

LV_ModifyCol(intNbColAuto + 1, g_intListW - intColSum - 21) ; adjust column width (-21 is for vertical scroll bar width)

intColSum := ""
*/

return
;------------------------------------------------------------


;------------------------------------------------------------
EnableSaveAndCancel:
;------------------------------------------------------------

GuiControl, 1:Enable, f_btnGuiSaveAndCloseFavorites
GuiControl, 1:Enable, f_btnGuiSaveAndStayFavorites
GuiControl, 1:, f_btnGuiCancel, % aaSettingsL["GuiCancel"]

Menu, menuBarFile, Enable, % L(aaMenuFileL["GuiSave"], g_strAppNameText)
Menu, menuBarFile, Enable, % L(aaMenuFileL["GuiSaveAndClose"], g_strAppNameText)
Menu, menuBarFile, Enable, % aaMenuFileL["GuiCancel"]
Menu, menuBarFile, Disable, % L(aaMenuFileL["GuiClose"], g_strAppNameText)

return
;------------------------------------------------------------


;------------------------------------------------------------
SettingsNotSavedReturn()
;------------------------------------------------------------
{
	global g_strGuiFullTitle
	
	GuiControlGet, blnCancelButtonEnabled, 1:Enabled, f_btnGuiCancel ; get Settings Cancel button enabled
	if !(blnCancelButtonEnabled) ; if not enabled, QAP is currently saving, return true to cancel menu display
		return true
		
	SetTimer, SettingsNotSavedChangeButtonNames, 50
	MsgBox, 3, % L(o_L["DialogSettingsNotSavedTitle"], g_strAppNameText), % o_L["DialogSettingsNotSavedPrompt"]
	IfMsgBox, No ; Settings
	{
		WinActivate, %g_strGuiFullTitle%
		return true
	}
	IfMsgBox, Cancel ; Cancel
		return true
	
	; else IfMsgBox, Yes - Save (and continue)
	gosub, GuiSaveAndDoNothing
	return false
}
;------------------------------------------------------------


;------------------------------------------------------------
SettingsNotSavedChangeButtonNames:
;------------------------------------------------------------

aaL := o_L.InsertAmpersand(false, "GuiSave", "MenuSettings", "GuiCancel")

IfWinNotExist, % L(o_L["DialogSettingsNotSavedTitle"], g_strAppNameText)
    return  ; Keep waiting.
SetTimer, SettingsNotSavedChangeButtonNames, Off
WinActivate, % L(o_L["DialogSettingsNotSavedTitle"], g_strAppNameText)
ControlSetText, Button1, % aaL["GuiSave"]
ControlSetText, Button2, % aaL["MenuSettings"]
ControlSetText, Button3, % aaL["GuiCancel"]

aa_ := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
ListApplications:
;------------------------------------------------------------

Gui, ListApps:New
Gui, ListApps:+Resize +MaximizeBox +MinimizeBox 
Gui, ListApps:Add, ListView
	, % "Count32 vf_gListApplications gListApplicationsEvents w1000 h700 " . (g_blnUseColors ? "c" . g_strGuiListviewTextColor
	. " Background" . g_strGuiListviewBackgroundColor : ""), % o_L["GuiListApplicationsHeader"]
Gui, ListApps:
Gui, ListApps:Default

Gui, ListApps:Add, Text, vf_ListApplicationLabel, % o_L["DialogListApplicationLabel"]
strListApplicationsDropdown := "List All||Current Windows menu|Running Applications|Close All Windows menu" ; do not use o_L["DialogListApplicationsDropdown"] until the code below is updated for localization
Gui, ListApps:Add, DropdownList, yp x+10 vf_drpListApplications gListApplicationsChanged, %strListApplicationsDropdown%
Gui, ListApps:Add, Button, yp x+10 vf_ListApplicationRefreshButton gListApplicationsLoad, % o_L["DialogRefresh"]
Gui, ListApps:Add, Button, yp x+10 vf_ListApplicationCloseButton gListAppsGuiClose, % o_L["GuiClose"]

Gosub, ListApplicationsChanged

Gui, ListApps:Show

return
;------------------------------------------------------------


;------------------------------------------------------------
ListAppsGuiClose:
;------------------------------------------------------------

Gui, ListApps:Destroy

return
;------------------------------------------------------------


;------------------------------------------------------------
ListAppsGuiSize:

GuiControl, ListApps:Move, f_gListApplications, % "w" . A_GuiWidth - 20
GuiControl, ListApps:Move, f_gListApplications, % "h" . A_GuiHeight - 50
GuiControl, ListApps:Move, f_ListApplicationLabel, % "y" . A_GuiHeight - 25
GuiControl, ListApps:Move, f_drpListApplications, % "y" . A_GuiHeight - 30
GuiControl, ListApps:Move, f_ListApplicationRefreshButton, % "y" . A_GuiHeight - 30
GuiControl, ListApps:Move, f_ListApplicationCloseButton, % "x" . A_GuiWidth - 50 . " y" . A_GuiHeight - 30

return
;------------------------------------------------------------


;------------------------------------------------------------
ListApplicationsEvents:
;------------------------------------------------------------

if (A_GuiEvent = "DoubleClick")
{
	LV_GetText(strWindowID, A_EventInfo, 2)
	WinGetTitle, strWindowTitle, ahk_id %strWindowID%
	WinGet, strWindowProcessPath, ProcessPath, ahk_id %strWindowID%
	MsgBox, 3, % o_L["MenuListApplications"], % strWindowTitle . "`n" . strWindowProcessPath . "`n`n" . o_L["DialogListApplicationYesNo"]
	IfMsgBox, Yes
		WinActivate, ahk_id %strWindowID%
	IfMsgBox, No
		WinClose, ahk_id %strWindowID%
	
	strWindowID := ""
	strWindowTitle := ""
	strWindowProcessPath := ""
}

return
;------------------------------------------------------------


;------------------------------------------------------------
ListApplicationsChanged:
;------------------------------------------------------------

Gui, ListApps:Submit, NoHide
gosub, ListApplicationsLoad

return
;------------------------------------------------------------


;------------------------------------------------------------
ListApplicationsLoad:
;------------------------------------------------------------

DetectHiddenWindows, Off
WinGet, strWinIDs, List	; Retrieve IDs of all the non-hidden windows
DetectHiddenWindows, On ; revert to app default

LV_Delete()
Loop, %strWinIDs%
	if KeepThisWindow(A_Index, strWinIDs%A_Index%, f_drpListApplications, objWindowProperties)
	{
		LV_Add("", A_Index, objWindowProperties.WindowID, StringLeftDotDotDot(objWindowProperties.WindowTitle, 50), objWindowProperties.ProcessName, StringLeftDotDotDot(objWindowProperties.ProcessPath, 50)
			, objWindowProperties.WandH, objWindowProperties.MinMax, objWindowProperties.Style, objWindowProperties.ExStyle
			, objWindowProperties.UniversalApplicationID, objWindowProperties.UniversalApplicationName)
			
		if (objWindowProperties.UniversalApplicationID) and (f_drpListApplications = "List All")
			if KeepThisWindow(A_Index, objWindowProperties.UniversalApplicationID, "List All", objUniversalWindowProperties)
				LV_Add("", A_Index, objUniversalWindowProperties.WindowID, StringLeftDotDotDot(objUniversalWindowProperties.WindowTitle, 50)
					, objUniversalWindowProperties.ProcessName, StringLeftDotDotDot(objUniversalWindowProperties.ProcessPath, 50), objUniversalWindowProperties.WandH
					, objUniversalWindowProperties.MinMax, objUniversalWindowProperties.Style, objUniversalWindowProperties.ExStyle
					, objUniversalWindowProperties.UniversalApplicationID, "(" . objWindowProperties.WindowID . ")")
	}
Loop, % LV_GetCount("Column")
	LV_ModifyCol(A_Index, "AutoHdr")
LV_ModifyCol(1, "Integer")

objWindowProperties := ""
objUniversalWindowProperties := ""

return
;------------------------------------------------------------


;------------------------------------------------------------
DetectCloudUserVariables:
;------------------------------------------------------------

Diag(A_ThisLabel, "", "START", g_blnIniFileCreation) ; force if first launch

o_Settings.UserVariables.strUserVariablesList.IniValue := ""

; detect Dropbox
if FileExist(EnvVars("%LOCALAPPDATA%\Dropbox\info.json"))
	FileRead, strDropboxJsonFileContent, % EnvVars("%LOCALAPPDATA%\Dropbox\info.json")
else if FileExist(EnvVars("%APPDATA%\Dropbox\info.json"))
	FileRead, strDropboxJsonFileContent, % EnvVars("%APPDATA%\Dropbox\info.json")
if StrLen(strDropboxJsonFileContent)
{
	strDropboxJsonFileContent := SubStr(strDropboxJsonFileContent, InStr(strDropboxJsonFileContent, """path"": """) + 9)
	strDropboxJsonFileContent := SubStr(strDropboxJsonFileContent, 1, InStr(strDropboxJsonFileContent, """") - 1)
	o_Settings.UserVariables.strUserVariablesList.IniValue .= "{Dropbox}=" . StrReplace(strDropboxJsonFileContent, "\\", "\") . "|"
}

; detect OneDrive/SkyDrive
; from https://stackoverflow.com/a/29562190/2327946
Loop, parse, % "Software\Microsoft\OneDrive|Software\Microsoft\Windows\CurrentVersion\SkyDrive|Software\Microsoft\SkyDrive", |
; use the first valid value found
{
	RegRead, strOneDrive, HKCU, %A_LoopField%, UserFolder
	if StrLen(strOneDrive) and FileExist(strOneDrive)
	{
		o_Settings.UserVariables.strUserVariablesList.IniValue .= "{OneDrive}=" . strOneDrive . "|"
		break
	}
}

; detect Google Drive
; from https://stackoverflow.com/a/29562861/2327946
strGoogleDriveDbFile := EnvVars("%LOCALAPPDATA%\Google\Drive\user_default\sync_config.db")
if FileExist(strGoogleDriveDbFile)
{
	strGoogleDriveDbFileCopy := g_strTempDir . "\Temp_GoogleDrive_Database.DB"
	FileCopy, %strGoogleDriveDbFile%, %strGoogleDriveDbFileCopy%, 1 ; no need to delete because is in the QAP temp directory
	global o_GoogleDriveDb := New SQLiteDb
	if o_GoogleDriveDb.OpenDb(strGoogleDriveDbFileCopy)
	; no error message if false - Oops("SQLite Error Opening Google Drive database`n`nMessage: " . o_GoogleDriveDb.ErrorMsg . "`nCode: " . o_GoogleDriveDb.ErrorCode . "`nFile: " . strGoogleDriveDbFileCopy)
	{
		strSQLGoogleDriveQuery := "SELECT data_value FROM data WHERE entry_key='local_sync_root_path'"
		If o_GoogleDriveDb.Query(strSQLGoogleDriveQuery, objGoogleDriveRecordSet)
		; no error message if false - Oops("SQLite Error Reading Google Drive database`n`nMessage: " . o_GoogleDriveDb.ErrorMsg . "`nCode: " . o_GoogleDriveDb.ErrorCode . "`nQuery: " . strSQLGoogleDriveQuery)
		{
			objGoogleDriveRecordSet.Next(objGoogleDriveRow)
			o_Settings.UserVariables.strUserVariablesList.IniValue .= "{GoogleDrive}=" . SubStr(objGoogleDriveRow[1], 5) . "|"
		}
		objGoogleDriveRecordSet.Free()
		o_GoogleDriveDb.CloseDb()
	}
}

; detect iCloud
strICloudDrive := EnvVars("%USERPROFILE%\iCloudDrive")
if FileExist(strICloudDrive)
	o_Settings.UserVariables.strUserVariablesList.IniValue .= "{iCloudDrive}=" . strICloudDrive . "|"

strDropboxJsonFileContent := ""
strOneDrive := ""
strGoogleDriveDbFile := ""
o_GoogleDriveDb := ""
strSQLGoogleDriveQuery := ""
objGoogleDriveRecordSet := ""
objGoogleDriveRow := ""
strICloudDrive := ""

Diag(A_ThisLabel, "", "STOP", g_blnIniFileCreation) ; force if first launch
return
;------------------------------------------------------------


;========================================================================================================================
; END OF VARIOUS COMMANDS
;========================================================================================================================


;========================================================================================================================
!_095_VARIOUS_FUNCTIONS:
return
;========================================================================================================================

;------------------------------------------------------------
GetSelectedLocation(strClass, strWinId)
; LearningOne and jethrow on https://autohotkey.com/board/topic/60723-can-autohotkey-retrieve-file-path-of-the-selected-file/page-2
;------------------------------------------------------------
{
	global g_strDOpusSelectedListText
	
	if WindowIsExplorer(strClass)
	{
		for objWindow in ComObjCreate("Shell.Application").Windows
			if (objWindow.hwnd = strWinId)
			{
				objSelectedItems := objWindow.Document.SelectedItems
				break
			}
		for objItem in objSelectedItems
		{
			strFirstItem := objItem.path
			if StrLen(strFirstItem)
				break
		}
	}
	else if WindowIsDesktop(strClass)
	{
		ControlGet, objFiles, List, Selected Col1, SysListView321, ahk_class %strClass%
		Loop, Parse, objFiles, `n, `r
		{
			strFirstItem := A_Desktop . "\" A_LoopField
			if StrLen(strFirstItem)
				break
		}
	}
	else if WindowIsDirectoryOpus(strClass)
	{
		gosub, RefreshDOpusSelectedListText
		strFirstItem := SubStr(g_strDOpusSelectedListText, InStr(g_strDOpusSelectedListText, "<item id="))
		strFirstItem := SubStr(strFirstItem, InStr(strFirstItem, "path=""") + 6)
		strFirstItem := SubStr(strFirstItem, 1, InStr(strFirstItem, """ type=") - 1)
		strFirstItem := ComUnHTML(strFirstItem) ; convert html entities like "&apos;" converted to "'"
	}
	; no reliable technique to retrieve the active item in dialog boxes and Total Commander
	else if WindowIsTotalCommander(strClass)
		Oops(o_L["OopsSelectedItemTotalCommander"])
	else if WindowIsDialog(strClass, strWinId)
		Oops(o_L["OopsSelectedItemDialogBoxes"])

    return strFirstItem
}
;------------------------------------------------------------


;------------------------------------------------
L(strMessage, objVariables*)
;------------------------------------------------
{
	Loop
	{
		if InStr(strMessage, "~" . A_Index . "~")
			strMessage := StrReplace(strMessage, "~" . A_Index . "~", objVariables[A_Index])
 		else
			break
	}
	
	return strMessage
}
;------------------------------------------------


;------------------------------------------------
Oops(strMessage, objVariables*)
;------------------------------------------------
{
	Gui, 1:+OwnDialogs
	MsgBox, 48, % L(o_L["OopsTitle"], g_strAppNameText, g_strAppVersion), % L(strMessage, objVariables*)
}
;------------------------------------------------


;------------------------------------------------
OopsGui2(strMessage, objVariables*)
;------------------------------------------------
{
	Gui, 2:+OwnDialogs
	MsgBox, 48, % L(o_L["OopsTitle"], g_strAppNameText, g_strAppVersion), % L(strMessage, objVariables*)
}
;------------------------------------------------


;------------------------------------------------------------
GetOSVersion()
;------------------------------------------------------------
{
	if (GetOSVersionInfo().MajorVersion = 10)
		return "WIN_10"
	else
		return A_OSVersion
}
;------------------------------------------------------------


;------------------------------------------------------------
GetOSVersionInfo()
; by shajul (http://www.autohotkey.com/board/topic/54639-getosversion/?p=414249)
; reference: http://msdn.microsoft.com/en-ca/library/windows/desktop/ms724833(v=vs.85).aspx
;------------------------------------------------------------
{
	static s_oVer

	If !s_oVer
	{
		VarSetCapacity(OSVer, 284, 0)
		NumPut(284, OSVer, 0, "UInt")
		If !DllCall("GetVersionExW", "Ptr", &OSVer)
		   return 0 ; GetSysErrorText(A_LastError)
		s_oVer := Object()
		s_oVer.MajorVersion      := NumGet(OSVer, 4, "UInt")
		s_oVer.MinorVersion      := NumGet(OSVer, 8, "UInt")
		s_oVer.BuildNumber       := NumGet(OSVer, 12, "UInt")
		s_oVer.PlatformId        := NumGet(OSVer, 16, "UInt")
		s_oVer.ServicePackString := StrGet(&OSVer+20, 128, "UTF-16")
		s_oVer.ServicePackMajor  := NumGet(OSVer, 276, "UShort")
		s_oVer.ServicePackMinor  := NumGet(OSVer, 278, "UShort")
		s_oVer.SuiteMask         := NumGet(OSVer, 280, "UShort")
		s_oVer.ProductType       := NumGet(OSVer, 282, "UChar") ; 1 = VER_NT_WORKSTATION, 2 = VER_NT_DOMAIN_CONTROLLER, 3 = VER_NT_SERVER
		s_oVer.EasyVersion       := s_oVer.MajorVersion . "." . s_oVer.MinorVersion . "." . s_oVer.BuildNumber
	}
	return s_oVer
}
;------------------------------------------------------------


;------------------------------------------------------------
GetFavoriteHotkeyFromLocation(strLocation)
;------------------------------------------------------------
{
	for strShortcut, oItem in g_aaItemsByShortcut
		if (oItem.AA.strFavoriteLocation = strLocation)
			return oItem.AA.strFavoriteShortcut
		
	return o_L["DialogNone"]
}
;------------------------------------------------------------


;------------------------------------------------------------
GetHotstringTrigger(strHotstring)
;------------------------------------------------------------
{
	SplitHotstring(strHotstring, strTrigger, strOptionsShort)
	
	return strTrigger
}
;------------------------------------------------------------


;------------------------------------------------------------
GetHotstringOptions(strHotstring)
;------------------------------------------------------------
{
	SplitHotstring(strHotstring, strTrigger, strOptionsShort)
	
	return strOptionsShort
}
;------------------------------------------------------------


;------------------------------------------------------------
SplitHotstring(strHotstring, ByRef strTrigger, ByRef strOptionsShort)
;------------------------------------------------------------
{
	saHotstring := StrSplit(strHotstring, ":")
	strTrigger := saHotstring[3]
	strOptionsShort := saHotstring[2]
	
	return StrLen(saHotstring[1])
}
;------------------------------------------------------------


;------------------------------------------------------------
GetHotstringOptionsLong(strHotstringOptionsShort)
;------------------------------------------------------------
{
	strTempOptions := strHotstringOptionsShort
	if InStr(strTempOptions, "C1")
		strTempOptions := StrReplace(strTempOptions, "C1") ; backward compatibility from 8.9 beta to v9.0.2, to avoid ambiguity with "C"

	strHotstringOptionsLong := (InStr(strHotstringOptionsShort, "C") ? o_L["DialogHotstringCaseSensitive"] . g_strHotstringOptionsLongSeparator : "")
		. (InStr(strHotstringOptionsShort, "?") ? o_L["DialogHotstringExpandInsideWords"] . g_strHotstringOptionsLongSeparator : "")
		. (InStr(strHotstringOptionsShort, "B0") ? o_L["DialogHotstringKeepHotstring"] . g_strHotstringOptionsLongSeparator : "")
		. (InStr(strHotstringOptionsShort, "*") ? o_L["DialogHotstringNotWaitEndingKey"] . g_strHotstringOptionsLongSeparator : "")
	if (SubStr(strHotstringOptionsLong, StrLen(strHotstringOptionsLong) - StrLen(g_strHotstringOptionsLongSeparator) + 1) = g_strHotstringOptionsLongSeparator)
		strHotstringOptionsLong := SubStr(strHotstringOptionsLong, 1, -StrLen(g_strHotstringOptionsLongSeparator))
	
	return strHotstringOptionsLong
}
;------------------------------------------------------------


;------------------------------------------------------------
PrepareHotstringForFunction(strHotstring, objFavorite)
;------------------------------------------------------------
{
	; insert X option as first option (":X...:trigger" or ":X...:trigger") just before creating the hotstring
	SplitHotstring(strHotstring, strTrigger, strOptionsShort)
	strPreparedHotstring := g_strHotstringOptionsSeparator . g_strHotstringOptionsExecute . strOptionsShort . g_strHotstringOptionsSeparator . strTrigger
	
	return strPreparedHotstring
}
;-----------------------------------------------------------


/*
;------------------------------------------------
DiagWindowInfo(strName)
; never called as of v9.1.9.4
;------------------------------------------------
{
	global g_strTargetWinId
	
	WinGetClass, strClass, ahk_id %g_strTargetWinId%
	WinGetTitle, strTitle, ahk_id %g_strTargetWinId%
	
	strActiveWindowId := WinActive("A")
	WinGetClass, strClass, ahk_id %strActiveWindowId%
	WinGetTitle, strTitle, ahk_id %strActiveWindowId%
	; Diag(strName . " - Active Window", strActiveWindowId . "`t" . strClass . "`t" . strTitle)
}
;------------------------------------------------
*/


;------------------------------------------------
Diag(strName, strData, strStartElapsedStop, blnForceForFirstStartup := false)
;------------------------------------------------
{
	static s_intStartTick
	static s_intStartFullTick
	static s_intStartShowTick
	static s_intStartCollectTick

	if !(o_Settings.Launch.blnDiagMode.IniValue or blnForceForFirstStartup)
		return
	
	FormatTime, strNow, %A_Now%, yyyyMMdd@HH:mm:ss
	strDiag := strNow . "." . A_MSec . "`t" . strName . "`t" . strData
	
	if StrLen(strStartElapsedStop)
	{
		strDiag .= "`t" . strStartElapsedStop . "`t" . A_TickCount
		
		if (strStartElapsedStop = "START-REFRESH")
			s_intStartFullTick := A_TickCount
		else if (strStartElapsedStop = "START-SHOW")
			s_intStartShowTick := A_TickCount
		else if (strStartElapsedStop = "START-COLLECT")
			s_intStartCollectTick := A_TickCount
		else if (strStartElapsedStop = "START")
			s_intStartTick := A_TickCount
		else if InStr(strStartElapsedStop, "-REFRESH") ; ELAPSED-REFRESH or STOP-REFRESH
		{
			intTicksAll := A_TickCount - s_intStartFullTick
			strDiag .= "`t" . intTicksAll . "`t" . (intTicksAll > 500 ? "*FLAG1*" : "")
		}
		else if InStr(strStartElapsedStop, "-SHOW") ; ELAPSED-SHOW or STOP-SHOW
		{
			intTicksShow := A_TickCount - s_intStartShowTick
			strDiag .= "`t" . intTicksShow . "`t" . (intTicksShow > 1000 ? "*FLAG2*" : "")
		}
		else if InStr(strStartElapsedStop, "-COLLECT") ; ELAPSED-COLLECT or STOP-COLLECT
		{
			intTicksCollect := A_TickCount - s_intStartCollectTick
			strDiag .= "`t" . intTicksCollect . "`t" . (intTicksCollect > 2000 ? "*FLAG3*" : "")
		}
		else ; ELAPSED
		{
			intTicks := A_TickCount - s_intStartTick
			strDiag .= "`t" . intTicks . "`t" . (intTicks > 2000 and strStartElapsedStop <> "ELAPSED" ? "*FLAG4*" : "")
		}
	}

	; g_strDiagFile := A_WorkingDir . "\" . g_strAppNameFile . "-DIAG.txt"
	strDiagFile := (blnForceForFirstStartup ? StrReplace(g_strDiagFile, "DIAG", "1st_STARTUP") : g_strDiagFile)
	loop
	{
		FileAppend, %strDiag%`n, %strDiagFile%
		if ErrorLevel
			Sleep, 20
	}
	until !ErrorLevel or (A_Index > 50) ; after 1 second (20ms x 50), we have a problem
	
	if (strStartElapsedStop = "STOP")
		s_intStartTick := ""
	else if (strStartElapsedStop = "STOP-REFRESH")
		s_intStartFullTick := ""
	else if (strStartElapsedStop = "STOP-SHOW")
		s_intStartShowTick := ""
	else if (strStartElapsedStop = "STOP-COLLECT")
		s_intStartCollectTick := ""
}
;------------------------------------------------


;------------------------------------------------------------
ParseIconResource(strIconResource, ByRef strIconFile, ByRef intIconIndex, strDefaultType := "")
; strIconResource can be a icongroup (file,index) or an index in o_JLicons.AA
;------------------------------------------------------------
{
	if !StrLen(strDefaultType)
		strDefaultType := "iconUnknown"
	if !StrLen(strIconResource)
		strIconResource := o_JLicons.AA[strDefaultType]
	If !InStr(strIconResource, ",") ; this is an index from o_JLicons.AA or the name of a file including icons
		if StrLen(o_JLicons.AA[strIconResource]) ; this is an index from o_JLicons.AA
			strIconResource := o_JLicons.AA[strIconResource] ; replace it with file,index format
		else ; this is the name of a file including icons
			strIconResource := strIconResource . ",1" ; use its first icon
	
	; from here, strIconResource is always of icongroup files format ("file,index")
	intComaPos := InStr(strIconResource, ",", , 0) - 1 ; search from the end because filename could also include a coma (ex.: "file,name.ico,1")
	strIconFile := SubStr(strIconResource, 1, intComaPos)
	intIconIndex := StrReplace(strIconResource, strIconFile . ",")
	; if strExpandedIconResource has a relative path, make it absolute based on the QAP working directory
	strIconFile := PathCombine(A_WorkingDir, EnvVars(strIconFile))
}
;------------------------------------------------------------


;------------------------------------------------------------
GetIcon4Location(strLocation)
; returns an icon resource in icongroup format (file,index) or an index of o_JLicons.AA
; icongroup will be splitted by ParseIconResource before being used by Menu command
; index of o_JLicons.AA will converted to icongroup by ParseIconResource before being splitted
; get icon, extract from kiu http://www.autohotkey.com/board/topic/8616-kiu-icons-manager-quickly-change-icon-files/
;------------------------------------------------------------
{
	if (SubStr(strLocation, 1, 2) <> "\\") ;  for files not on a server, search in path
		FileExistInPath(strLocation) ; expand strLocation and search in PATH

	if !StrLen(strLocation)
		return "iconUnknown"
	
	strExtension := GetFileExtension(strLocation)
	RegRead, strHKeyClassRoot, HKEY_CLASSES_ROOT, .%strExtension%
	if !StrLen(strHKeyClassRoot)
		return "iconUnknown"
	
	RegRead, strRegistryIconResource, HKEY_CLASSES_ROOT, %strHKeyClassRoot%\DefaultIcon
	if (strRegistryIconResource = "%1") ; use the file itself (for executable)
		return strLocation . ",1"
	else if InStr(strRegistryIconResource, """") ; for badly set icon in registry including double-quote (only one situation seen)
		or !StrLen(strRegistryIconResource) ; empty result
		return "iconUnknown"
	else
		return strRegistryIconResource
}
;------------------------------------------------------------


;------------------------------------------------------------
GuiCenterButtons(strWindow, intInsideHorizontalMargin := 10, intInsideVerticalMargin := 0, intDistanceBetweenButtons := 20, arrControls*)
; This is a variadic function. See: http://ahkscript.org/docs/Functions.htm#Variadic
;------------------------------------------------------------
{
	Gui, Show, Hide ; why?
	WinGetPos, , , intWidth, , %strWindow%

	; find largest control height and width
	intMaxControlWidth := 0
	intMaxControlHeight := 0
	intNbControls := 0
	for intIndex, strControl in arrControls
		if StrLen(strControl) ; avoid emtpy control names
		{
			intNbControls++ ; use instead of arrControls.MaxIndex() in case we get empty control names
			GuiControlGet, arrControlPos, Pos, %strControl%
			if (arrControlPosW > intMaxControlWidth)
				intMaxControlWidth := arrControlPosW
			if (arrControlPosH > intMaxControlHeight)
				intMaxControlHeight := arrControlPosH
		}
	
	intMaxControlWidth := intMaxControlWidth + intInsideHorizontalMargin
	intButtonsWidth := (intNbControls * intMaxControlWidth) + ((intNbControls  - 1) * intDistanceBetweenButtons)
	intLeftMargin := (intWidth - intButtonsWidth) // 2

	for intIndex, strControl in arrControls
		if StrLen(strControl) ; avoid emtpy control names
			GuiControl, Move, %strControl%
				, % "x" . intLeftMargin + ((intIndex - 1) * intMaxControlWidth) + ((intIndex - 1) * intDistanceBetweenButtons)
				. " w" . intMaxControlWidth
				. " h" . intMaxControlHeight + intInsideVerticalMargin
}
;------------------------------------------------------------


;------------------------------------------------------------
RecentLocationIsDocument(strLocation, strSource)
; check atrtributes except if on network offline check file extension
;------------------------------------------------------------
{
	if (SubStr(strLocation, 1, 2) = "\\")
	{
		blnOffline := ServerIsOffline(strLocation)
		Diag(A_ThisFunc . " check if server is offline, if yes use extension from: " . strSource, strLocation . " " . (blnOffline ? "(OFFLINE)" : "(ONLINE)"), "ELAPSED")
		if (blnOffline)
			; if server is offline, we must assume that if there is an extension, it is a file (could be misleading for foler like "\\server\path.ext")
			return StrLen(GetFileExtension(strLocation)) 

	}
	; do not else
	
	return LocationIsDocument(strLocation)
}
;------------------------------------------------------------


;------------------------------------------------------------
LocationIsDocument(strLocation)
;------------------------------------------------------------
{
    FileGetAttrib, strAttributes, %strLocation%
    return !InStr(strAttributes, "D") ; not a folder
}
;------------------------------------------------------------


;------------------------------------------------------------
GetLocationPathName(strLocation)
;------------------------------------------------------------
{
	SplitPath, strLocation, strOutFileName, , , strOutNameNoExt, strDrive
	strName := (InStr(FileExist(strLocation), "D") ? strOutFileName : strOutNameNoExt)
	if !StrLen(strName) ; we are probably at the root of a drive
		return strDrive
	else
		return strName
}
;------------------------------------------------------------


;------------------------------------------------------------
GetDeepestMenuPath(strPath)
;------------------------------------------------------------
{
	return Trim(SubStr(strPath, InStr(strPath, g_strMenuPathSeparator, , 0) + 1, 9999))
}
;------------------------------------------------------------


;------------------------------------------------------------
MenuNameReminder(strHotkey, strHotstring := "")
;------------------------------------------------------------
{
	if (o_Settings.Menu.intHotkeyReminders.IniValue > 1) and StrLen(strHotkey . strHotstring)
	{
		if StrLen(strHotkey)
			strReminderText := (o_Settings.Menu.intHotkeyReminders.IniValue = 2 ? strHotkey : new Triggers.HotkeyParts(strHotkey).Hotkey2Text(true))
		if StrLen(strHotkey) and StrLen(strHotstring)
			strReminderText .= " / "
		if StrLen(strHotstring)
			strReminderText .= (o_Settings.Menu.intHotkeyReminders.IniValue = 2 ? o_L["DialogHotstringIndicator"] : strHotstring)
		
		if (o_Settings.Menu.blnHotkeyRemindersRightAlign.IniValue)
			return "`t" . strReminderText
		else
			return " " . BetweenParenthesis(strReminderText)
	}
	else
		return ""
}
;------------------------------------------------------------


;------------------------------------------------------------
IsInteger(str)
;------------------------------------------------------------
{
	if str is integer
		return true
	else
		return false
}
;------------------------------------------------------------


;------------------------------------------------------------
CollectRunningApplications(strDefaultPath)
;------------------------------------------------------------
{
	objApps := Object()

	DetectHiddenWindows, Off
	Winget, strWinIDs, list
	DetectHiddenWindows, On ; revert to app default
	
	Loop, %strWinIDs%
		If KeepThisWindow(A_Index, strWinIDs%A_Index%, "Running Applications", objWindowProperties)
			if !objApps.HasKey(objWindowProperties.ProcessPath)
				objApps.Insert(objWindowProperties.ProcessPath, "")

	for strThisPath in objApps
	{
		strPaths .= strThisPath . "|"
		if (strThisPath = strDefaultPath)
			strPaths .= "|"
	}

	return strPaths
}
;------------------------------------------------------------


;------------------------------------------------------------
LoadWindowsAppsList(strCurrentAppID)
;------------------------------------------------------------
{
	if !FileExist(g_strWindosListAppsCacheFile)
		return
	
	g_aaWindowsAppsIDsByName := Object() ; reset object
	Loop, Read, %g_strWindosListAppsCacheFile%
	{
		saWindowsApp := StrSplit(A_LoopReadLine, "`t") ; $app.Name + "`t" + $app.packagefamilyname + "!" + $id
		; saWindowsApp[1] = name / saWindowsApp[2] = packagefamilyname!id (required to execute a Windows App)
		saWindowsAppID := StrSplit(saWindowsApp[2], "!") ; $app.packagefamilyname + "!" + $id
		; saWindowsAppID[1] = packagefamilyname / saWindowsAppID[2] = id
		if (saWindowsAppID[2] = "App" or saWindowsAppID[2] = saWindowsApp[1])
			strWindowAppUniqueKey := saWindowsApp[1]
		else
			strWindowAppUniqueKey := saWindowsApp[1] . " - " . saWindowsAppID[2]
		g_aaWindowsAppsIDsByName[strWindowAppUniqueKey] := saWindowsApp[2]
	}

	for strThisApp, strThisAppID in g_aaWindowsAppsIDsByName ; to list apps sorted by name
		strWindowsAppsList .= strThisApp . "|" . (strThisAppID = strCurrentAppID ? "|" : "")
	strWindowsAppsList := SubStr(strWindowsAppsList, 1, -1) ; trim last char

	return %strWindowsAppsList%
}
;------------------------------------------------------------


;------------------------------------------------------------
EncodeSnippet(strSnippet)
; convert from display format (when f_blnProcessEOLTab is true) to raw content, ready for saving to in file
;------------------------------------------------------------
/*
https://rosettacode.org/wiki/Special_characters#AutoHotkey
The escape character defaults to accent/backtick (`).

`, = , (literal comma). Note: Commas that appear within the last parameter of a command do not need to be escaped because the program knows to treat them literally. The same is true for all parameters of MsgBox because it has smart comma handling.
`% = % (literal percent)
`` = ` (literal accent; i.e. two consecutive escape characters result in a single literal character)
`; = ; (literal semicolon). Note: This is necessary only if a semicolon has a space or tab to its left. If it does not, it will be recognized correctly without being escaped.
`n = newline (linefeed/LF)
`r = carriage return (CR)
`b = backspace
`t = tab (the more typical horizontal variety)
`v = vertical tab -- corresponds to Ascii value 11. It can also be manifest in some applications by typing Control+K.
`a = alert (bell) -- corresponds to Ascii value 7. It can also be manifest in some applications by typing Control+G.
`f = formfeed -- corresponds to Ascii value 12. It can also be manifest in some applications by typing Control+L.
Send = When the Send command or Hotstrings are used in their default (non-raw) mode, characters such as {}^!+# have special meaning. Therefore, to use them literally in these cases, enclose them in braces. For example: Send {^}{!}{{}
"" = Within an expression, two consecutive quotes enclosed inside a literal string resolve to a single literal quote. For example: Var := "The color ""red"" was found."

Process only:
`n = newline (linefeed/LF)
`t = tab (the more typical horizontal variety)

No need to process:
- | (pipe) used as separator in favorites lines in ini file are already replaced with the escape sequence ""
*/
{
	strSnippet := StrReplace(strSnippet, "``", "````") ;  replace backticks with double-backticks
	strSnippet := StrReplace(strSnippet, "`n", "``n")  ; encode end-of-lines
	strSnippet := StrReplace(strSnippet, "`t", "``t")  ; encode tabs
	
	return strSnippet
}
;------------------------------------------------------------


;------------------------------------------------------------
DecodeSnippet(strSnippet, blnWithCarriageReturn := false)
; convert from raw content (as from ini file) to display format (when f_blnProcessEOLTab is true) or to paste format
;------------------------------------------------------------
{
	strSnippet := StrReplace(strSnippet, "````", "!r4nd0mt3xt!")	; preserve double-backticks
	strSnippet := StrReplace(strSnippet
		, "``n", (blnWithCarriageReturn ? "`r" : "") . "`n")		; decode end-of-lines (with `r only when sending as Snippet)
	strSnippet := StrReplace(strSnippet, "``t", "`t")				; decode tabs
	strSnippet := StrReplace(strSnippet, "!r4nd0mt3xt!", "````")	; restore double-backticks
	
	return strSnippet
}
;------------------------------------------------------------


;------------------------------------------------------------
EscapeQuote(str)
;------------------------------------------------------------
{
	return StrReplace(str, "'", "''")
}
;------------------------------------------------------------


;------------------------------------------------------------
GetWebPageTitle(strLocation)
;------------------------------------------------------------
{
	ToolTip, % o_L["ToolTipRetrievingWebPageTitle"]
	strHTML := Url2Var(strLocation)
	ToolTip
	
	RegExMatch(strHTML, "is)<title(.*?)</title>", strTitle) ; extract title with tags
	RegExMatch(strTitle, "s)>(.*?)</title>", strTitle) ; remove part of opening title tag
	StringTrimLeft, strTitle, strTitle, 1 ; remove rest of opening title tag
	
	strTitle := StrReplace(strTitle, "</title>") ; remove closing title tag
	strTitle := StrReplace(strTitle, "`r", "")
	strTitle := StrReplace(strTitle, "`t", A_Space)
	strTitle := StrReplace(strTitle, "`n", A_Space)
	
	strTitle := NumDecode(Trim(strTitle, Chr(160))) ; Chr(160) to also trim non-breaking spaces
	return (StrLen(strTitle) ? strTitle : o_L["DialogNA"])
}
;------------------------------------------------------------


;------------------------------------------------------------
Url2Var(strUrl)
;------------------------------------------------------------
{
	objWebRequest := ComObjCreate("WinHttp.WinHttpRequest.5.1")
	/*
	if (A_LastError)
		; an error occurred during ComObjCreate (A_LastError probably is E_UNEXPECTED = -2147418113 #0x8000FFFFL)
		BUT DO NOT ABORT because the following commands will be executed even if an error occurred in ComObjCreate (!)
	*/
	objWebRequest.Open("GET", strUrl)
	objWebRequest.Send()

	return (objWebRequest.StatusText() = "OK" ? objWebRequest.ResponseText() : "")
}
;------------------------------------------------------------


;------------------------------------------------------------
NameIsInObject(strName, aa)
;------------------------------------------------------------
{
	loop, % aa.MaxIndex()
		if (strName = aa[A_Index].strName)
			return true
		
	return false
}
;------------------------------------------------------------


;------------------------------------------------------------
HasShortcut(strCandidateShortcut)
;------------------------------------------------------------
{
	return StrLen(strCandidateShortcut) and (strCandidateShortcut <> "None")
}
;------------------------------------------------------------


;------------------------------------------------
ProcessLocationURL(str)
;------------------------------------------------
{
	str := StrReplace(str, "file:///")
	str := StrReplace(str, "file:") ; for network drives starting with file:\\, keep only \\
	str := StrReplace(str, "/", "\")

	return str
}
;------------------------------------------------


;------------------------------------------------
UriDecode(str)
; by polyethene
; http://www.autohotkey.com/board/topic/17367-url-encoding-and-decoding-of-special-characters/?p=112822
; Note JL: this function only decodes one byte characters (e.g. "%40"->"@" but not utf-8 char "%C3%A9"->"")
;------------------------------------------------
{
	Loop
		If RegExMatch(str, "i)(?<=%)[\da-f]{1,2}", hex)
			str := StrReplace(str, "%" . hex, Chr("0x" . hex))
		Else
			Break
		
	return str
}
;------------------------------------------------


;------------------------------------------------------------
UriEncode(str)
; from GoogleTranslate by Mikhail Kuropyatnikov
; http://www.autohotkey.net/~sumon/GoogleTranslate.ahk
; edited to encode also "@" see http://stackoverflow.com/questions/32341476/valid-url-for-an-ftp-site-with-username-containing/
;------------------------------------------------------------
{ 
	strFormat := A_FormatInteger
	data := ""
	SetFormat, Integer, H
	SizeInBytes := StrPutVar(str,var,"utf-8")
	Loop, %SizeInBytes%
	{
		ch := NumGet(var,A_Index-1,"UChar")
		If (ch=0)
			Break
		if ((ch>0x7f) || (ch<0x30) || (ch=0x3d) || (ch=0x40))
			s .= "%" . ((StrLen(c:=SubStr(ch,3))<2) ? "0" . c : c)
		Else
			s .= Chr(ch)
	}
	SetFormat, Integer, %strformat%
	return s
} 
;------------------------------------------------------------


;------------------------------------------------------------
NumDecode(str)
; Extracted from Dec_XML() https://autohotkey.com/board/topic/29866-encoding-and-decoding-functions-v11/
; converts "&#233;" or "&#xE9;" to ""
;------------------------------------------------------------
{
	Loop
		If RegexMatch(str, "S)(&#(\d+);)", dec) ; matches: &#[dec];
			str := StrReplace(str, dec1, Chr(dec2))
		Else If RegexMatch(str, "Si)(&#x([\da-f]+);)", hex) ; matches: &#x[hex];
			str := StrReplace(str, hex1, Chr("0x" . hex2))
		Else
			Break
	
	return str
} 
;------------------------------------------------------------


;------------------------------------------------------------
StrPutVar(string, ByRef var, encoding)
;------------------------------------------------------------
{
    ; Ensure capacity.
    SizeInBytes := VarSetCapacity( var, StrPut(string, encoding)
        ; StrPut returns char count, but VarSetCapacity needs bytes.
        * ((encoding="utf-16"||encoding="cp1200") ? 2 : 1) )
    ; Copy or convert the string.
    StrPut(string, &var, encoding)
   Return SizeInBytes 
}
;------------------------------------------------------------


;------------------------------------------------------------
ComUnHTML(html)
; convert HTML entities to text (like "&apos;") - author unknown
; http://www.autohotkey.com/board/topic/47356-unhtm-remove-html-formatting-from-a-string-updated/page-2#entry467499
;------------------------------------------------------------
{
	oHTML := ComObjCreate("HtmlFile")
	oHTML.write(html)
	return oHTML.documentElement.innerText
}
;------------------------------------------------------------


;------------------------------------------------------------
ExpandPlaceholders(strOriginal, strLocation, strCurrentLocation, strSelectedLocation)
; strOriginal: string to be expanded
; strLocation: {LOC} (full location), {NAME} (file name), {DIR} (directory), {EXT} (extension), {NOEXT} (file name without extension) or {DRIVE} (drive)
; strCurrentLocation: same with prefix "CUR_" like {CUR_LOC} (full current location in file manager), {CUR_NAME} (current file name), etc.
; strSelectedLocation: same with prefix "SEL_" like {SEL_LOC} (full location of selected item in file manager), {SEL_NAME} (selected file name), etc.
; Do not process strCurrentLocation or strSelectedLocation if = -1
;------------------------------------------------------------
{
	; protect escaped open curly brackets `{
	strOriginal := StrReplace(strOriginal, "````{", "!r4nd0mt3xt!") ; original tick was doubled by EncodeSnippet

	strExpanded := ExpandPlaceholdersForThis(strOriginal, strLocation, "")
	if (strCurrentLocation <> -1)
		strExpanded := ExpandPlaceholdersForThis(strExpanded, strCurrentLocation, "CUR_")
	if (strSelectedLocation <> -1)
		strExpanded := ExpandPlaceholdersForThis(strExpanded, strSelectedLocation, "SEL_")
	strExpanded := StrReplace(strExpanded, "{Clipboard}", Clipboard)

	strExpanded := ExpandUserVariables(strExpanded)

	; restore escaped open curly brackets and remove tick {
	strExpanded := StrReplace(strExpanded, "!r4nd0mt3xt!", "{") ; restore ticked open curly brackets

	return strExpanded
}
;------------------------------------------------------------


;------------------------------------------------------------
ExpandPlaceholdersForThis(strArguments, strThisLocation, strPrefix := "")
;------------------------------------------------------------
{
	SplitPath, strThisLocation, strOutFileName, strOutDir, strOutExtension, strOutNameNoExt, strOutDrive
	
	strExpanded := strArguments
	strExpanded := StrReplace(strExpanded, "{" . strPrefix . "LOC}", strThisLocation) ; default replace all occurences
	strExpanded := StrReplace(strExpanded, "{" . strPrefix . "NAME}", strOutFileName)
	strExpanded := StrReplace(strExpanded, "{" . strPrefix . "DIR}", strOutDir)
	strExpanded := StrReplace(strExpanded, "{" . strPrefix . "EXT}", strOutExtension)
	strExpanded := StrReplace(strExpanded, "{" . strPrefix . "NOEXT}", strOutNameNoExt)
	strExpanded := StrReplace(strExpanded, "{" . strPrefix . "DRIVE}", strOutDrive)
	
	return strExpanded
}
;------------------------------------------------------------


;------------------------------------------------------------
SetTargetWinInfo(blnMouseElseKeyboard)
; set g_strTargetClass, g_strTargetWinId, g_strTargetControl and g_strTargetWinTitle
;------------------------------------------------------------
{
	global
	
	if (blnMouseElseKeyboard)
	{
		MouseGetPos, , , g_strTargetWinId, g_strTargetControl
		WinGetClass, g_strTargetClass, % "ahk_id " . g_strTargetWinId
	}
	else ; Keyboard
	{
		g_strTargetWinId := WinExist("A")
		g_strTargetControl := ""
		WinGetClass, g_strTargetClass, % "ahk_id " . g_strTargetWinId
	}

	WinGetTitle, g_strTargetWinTitle, % "ahk_id " . g_strTargetWinId
	WinGet, g_strTargetProcessName, ProcessName, % "ahk_id " . g_strTargetWinId
	WinGet, g_strTargetProcessName, ProcessName, % "ahk_id " . g_strTargetWinId
}
;------------------------------------------------------------


;------------------------------------------------------------
LocationIsHTTP(strLocation)
;------------------------------------------------------------
{
	return SubStr(strLocation, 1, 7) = "http://" or SubStr(strLocation, 1, 8) = "https://"
}
;------------------------------------------------------------


;------------------------------------------------------------
RecentFileExistInPath(ByRef strFile, strSource)
; always return true if file si on an offline network drive
;------------------------------------------------------------
{
	if (SubStr(strFile, 1, 2) = "\\")
	{
		blnOffline := ServerIsOffline(strFile)
		Diag(A_ThisFunc . " check if server is offline from: " . strSource, strFile . " " . (blnOffline ? "(OFFLINE)" : "(ONLINE)"), "ELAPSED")
		if (blnOffline)
			return false
	}
	; do not else
	
	return FileExistInPath(strFile)
}
;------------------------------------------------------------


;------------------------------------------------------------
FileExistInPath(ByRef strFile)
;------------------------------------------------------------
{
	strFile := EnvVars(strFile) ; expand environment variables like %APPDATA% or %USERPROFILE%, and user variables like {DropBox}
	if (!StrLen(strFile) or InStr(strFile, "://") or SubStr(strFile, 1, 1) = "{") ; this is not a file - caution some URLs in WhereIs cause an infinite loop
		return, False
	
	if !InStr(strFile, "\") ; if no path in filename
		strFile := WhereIs(strFile) ; search if file exists in path env variable or registry app paths
	else
		strFile := PathCombine(A_WorkingDir, strFile) ; make relative path absolute
	
	if (SubStr(strFile, 1, 2) = "\\") ; this is an UNC path
	; check if it is the UNC root - if yes, return true without confirming if path exist because FileExist bug(?) with UNC root path
	{
		intPos := InStr(strFile, "\", false, 3)
		if !(intPos) ; there is no "\" after the domain or IP address, this is the UNC root
			return true
	}
	
	return, FileExist(strFile) ; returns the file's attributes if file exists or empty (false) is not
}
;------------------------------------------------------------


;------------------------------------------------------------
RecentFileExist(strPath, strSource)
; if file is on server, check if server is online
;------------------------------------------------------------
{
	if (SubStr(strPath, 1, 2) = "\\")
	{
		blnOffline := ServerIsOffline(strPath)
		Diag(A_ThisFunc . " check if server is offline from: " . strSource, strPath . " " . (blnOffline ? "(OFFLINE)" : "(ONLINE)"), "ELAPSED")
		if (blnOffline)
			return false
	}
	; do not else

	return FileExist(strPath)
}
;------------------------------------------------------------


;------------------------------------------------------------
ServerIsOffline(strPath)
;------------------------------------------------------------
{
	SplitPath, strPath, , strDir ; extract the folder because DriveGet check status for folders, not files
	; DriveGet Status returns: Unknown (might indicate unformatted/RAW), Ready, NotReady (typical for removable drives that don't contain media),
	; Invalid (Path does not exist or is a network drive that is presently inaccessible, etc.)
	DriveGet, strStatus, Status, %strDir%
	; ###_V(A_ThisFunc, strPath, strDir, strStatus)
	
	return (strStatus <> "Ready")
}
;------------------------------------------------------------


;------------------------------------------------------------
WhereIs(strThisFile)
; based on work from Skan in https://autohotkey.com/board/topic/20807-fileexist-in-path-environment/
;------------------------------------------------------------
{
	if !StrLen(GetFileExtension(strThisFile)) ; if file has no extension
	{
		; prepare executable extensions list from PATHEXT env variable
		EnvGet, strExeExtensions, PathExt

		; re-enter WhereIs with each extension until one returns an existing file
		Loop, Parse, strExeExtensions, `;
		{
			strFoundFile := WhereIs(strThisFile . A_LoopField) ; recurse into WhereIs with a complete filename
		} until StrLen(strFoundFile)
		
		return %strFoundFile% ; exit if we find an existing file, or return empty if not
	}
	; from here, we have a filename with an extension
	
	; prepare locations list
	SplitPath, A_AhkPath, , strAhkDir
	EnvGet, strDosPath, Path
	strPaths := A_WorkingDir . ";" . A_ScriptDir . ";" . strAhkDir . ";" . strAhkDir . "\Lib;" . A_MyDocuments . "\AutoHotkey\Lib" . ";" . strDosPath
	
	; search in each location
	Loop, Parse, strPaths, `;
		If StrLen(A_LoopField)
			If FileExist(A_LoopField . "\" . strThisFile)
				Return, RegExReplace(A_LoopField . "\" . strThisFile, "\\\\", "\") ; RegExReplace to prevent results like C:\\Directory
	
	; if not found, check in registry paths for this filename
	RegRead, strAppPath, HKLM, SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\%strThisFile%
	If FileExist(strAppPath)
		Return, strAppPath
	
	; else return empty
}
;------------------------------------------------------------


;------------------------------------------------------------
PathCombine(strAbsolutePath, strRelativePath)
; see http://www.autohotkey.com/board/topic/17922-func-relativepath-absolutepath/page-3#entry117355
; and http://stackoverflow.com/questions/29783202/combine-absolute-path-with-a-relative-path-with-ahk/
;------------------------------------------------------------
{
    VarSetCapacity(strCombined, (A_IsUnicode ? 2 : 1) * 260, 1) ; MAX_PATH
    DllCall("Shlwapi.dll\PathCombine", "UInt", &strCombined, "UInt", &strAbsolutePath, "UInt", &strRelativePath)
    Return, strCombined
}
;------------------------------------------------------------


;------------------------------------------------------------
EnvVars(str)
; from Lexikos http://www.autohotkey.com/board/topic/40115-func-envvars-replace-environment-variables-in-text/#entry310601
; adapted from from Lexikos http://www.autohotkey.com/board/topic/40115-func-envvars-replace-environment-variables-in-text/#entry310601
; in addition to environment variables, it expands QAP user variables like {Dropbox}
;------------------------------------------------------------
{
    if sz:=DllCall("ExpandEnvironmentStrings", "uint", &str, "uint", 0, "uint", 0)
    {
        VarSetCapacity(dst, A_IsUnicode ? sz*2:sz)
        if DllCall("ExpandEnvironmentStrings", "uint", &str, "str", dst, "uint", sz)
            return ExpandUserVariables(dst)
    }
	
    return ExpandUserVariables(str)
}
;------------------------------------------------------------


;------------------------------------------------------------
ExpandUserVariables(str)
;------------------------------------------------------------
{
    loop, parse, % o_Settings.UserVariables.strUserVariablesList.IniValue, |
        if StrLen(A_LoopField)
        {
            StringSplit, arrUserVariable, A_LoopField, =
            if (SubStr(arrUserVariable1, 1, 1) = "{" and SubStr(arrUserVariable1, StrLen(arrUserVariable1), 1) = "}")
                str := StrReplace(str, arrUserVariable1, arrUserVariable2)
        }
	
    return str
}
;------------------------------------------------------------


;------------------------------------------------------------
AppIsRunning(strAppPath, blnDesiredElevated, ByRef strAppID)
; Based on Drugoy (https://github.com/Drugoy/Autohotkey-scripts-.ahk/blob/master/DevTools/showPerWindowInfoOfAllWindows.ahk)
; Return true only if running app has the desired UAC level
;------------------------------------------------------------
{
	DetectHiddenWindows, Off
	WinGet, strWinIDs, List	; Retrieve IDs of all the existing windows
	DetectHiddenWindows, On ; revert to app default
	Loop, %strWinIDs%
	{
		WinGet, strProcessPath, ProcessPath, % "ahk_id " . strWinIDs%A_Index%
		if (strProcessPath = strAppPath)
		{
			strAppID := strWinIDs%A_Index%
			WinGet, intPid , PID, % "ahk_id " . strWinIDs%A_Index%
			if (blnDesiredElevated = IsProcessElevated(intPid))
				return true
		}
	}
	return false
}
;------------------------------------------------------------


;------------------------------------------------------------
IsProcessElevated(ProcessID)
; from jNizM on https://autohotkey.com/boards/viewtopic.php?p=96016#p96016
; with fix https://autohotkey.com/boards/viewtopic.php?f=5&t=40657
;------------------------------------------------------------
{
    if !(hProcess := DllCall("OpenProcess", "uint", 0x1000, "int", 0, "uint", ProcessID, "ptr"))
		; Use 0x1000 (PROCESS_QUERY_LIMITED_INFORMATION) instead of 0x0400 (PROCESS_QUERY_INFORMATION) - see https://autohotkey.com/boards/viewtopic.php?f=5&t=40657
        throw Exception("OpenProcess failed", -1)
    if !(DllCall("advapi32\OpenProcessToken", "ptr", hProcess, "uint", 0x0008, "ptr*", hToken))
        throw Exception("OpenProcessToken failed", -1), DllCall("CloseHandle", "ptr", hProcess)
    if !(DllCall("advapi32\GetTokenInformation", "ptr", hToken, "int", 20, "uint*", IsElevated, "uint", 4, "uint*", size))
        throw Exception("GetTokenInformation failed", -1), DllCall("CloseHandle", "ptr", hToken) && DllCall("CloseHandle", "ptr", hProcess)
    return IsElevated, DllCall("CloseHandle", "ptr", hToken) && DllCall("CloseHandle", "ptr", hProcess)
}
;------------------------------------------------------------


;------------------------------------------------------------
SetWaitCursor(blnOnOff)
; from Gio in https://autohotkey.com/boards/viewtopic.php?f=5&t=13284
;------------------------------------------------------------
{
	static s_blnCursorWaitAlreadyOn
	static s_oWaitCursor
	
	if (blnOnOff)
		if (s_blnCursorWaitAlreadyOn)
			return
		else
		{
			; The line of code below loads a cursor from the system set (specifically, the wait cursor - 32514).
			s_oWaitCursor :=  DllCall("LoadImage", "Uint", 0, "Uint", 32514, "Uint", 2, "Uint", 0, "Uint", 0, "Uint", 0x8000)

			; And then we set all the default system cursors to be our choosen cursor. CopyImage is necessary as SetSystemCursor destroys the cursor we pass to it after using it.
			strCursors := "32650,32512,32515,32649,32651,32513,32648,32646,32643,32645,32642,32644,32516,32514"
			Loop, Parse, strCursors, `,
				DllCall("SetSystemCursor", "Uint", DllCall("CopyImage", "Uint", s_oWaitCursor, "Uint", 2, "Int", 0, "Int", 0, "Uint", 0), "Uint", A_LoopField)
			
			s_blnCursorWaitAlreadyOn := true
		}
	else
	{
		; And finally, when the action is over, we call the code below to revert the default set of cursors back to its original state.
		; SystemParametersInfo() (with option 0x0057) changes the set of system cursors to the system defaults. 
		; We are loading a system cursor, so there is no need to destroy it. Also the copies we are creating with CopyImage() are destroyed by SetSystemCursor() itself.
		DllCall("SystemParametersInfo", "Uint", 0x0057, "Uint", 0, "Uint", 0, "Uint", 0)
		Sleep, 50
		
		s_oWaitCursor := ""
		s_blnCursorWaitAlreadyOn := false
	}
}
;------------------------------------------------------------


;------------------------------------------------------------
StringLeftDotDotDot(strText, intMax)
;------------------------------------------------------------
{
	return SubStr(strText, 1, intMax) . (StrLen(strText) > intMax ? "..." : "")
}
;------------------------------------------------------------


;------------------------------------------------------------
LocationTransformedFromHTTP2UNC(strType, ByRef strLocation)
;------------------------------------------------------------
{
	if InStr("Folder|Document|External", strType)
		and (SubStr(strLocation, 1, 5) = "http:" or SubStr(strLocation, 1, 6) = "https:")
	{
		; Transform from "http:" to "\\" (WevDAV to UNC), example:
		; From: http://abc.server.com/folder/subfolder/My Name.doc
		; to:   \\abc.server.com\folder\subfolder\My%20Name.doc
		; See: http://stackoverflow.com/questions/1344910/get-the-content-of-a-sharepoint-folder-with-excel-vba
		
		strLocation := StrReplace(strLocation, "/", "\")
		strLocation := StrReplace(strLocation, "http:")
		strLocation := StrReplace(strLocation, "https:")
		; not required? strLocation := StrReplace(strLocation, A_Space, "%20")
		return true
	}
	else
		return false
}
;------------------------------------------------------------


;------------------------------------------------------------
SettingsUnsaved()
;------------------------------------------------------------
{
	global

	GuiControlGet, strCancelButtonLabel, 1:, f_btnGuiCancel ; get Settings Cancel button label ("Cancel" or "Close")
	blnDialogOpen := (strCancelButtonLabel = aaSettingsL["GuiCancel"]) ; Settings open with changes to save if Cancel button label is "Cancel"
	; GuiControlGet, blnDialogOpen, 1:Enabled, f_btnGuiSaveAndCloseFavorites ; check if Settings is open with Save button enabled

	return blnDialogOpen
}
;------------------------------------------------------------


;------------------------------------------------------------
GetFileExtension(strFile)
;------------------------------------------------------------
{
	SplitPath, strFile, , , strExtension
	return strExtension
}
;------------------------------------------------------------


;------------------------------------------------------------
PickIconDialog(strFavoriteIconResource)
;------------------------------------------------------------
{
	; Source: http://ahkscript.org/boards/viewtopic.php?f=5&t=5108#p29970
	VarSetCapacity(strIconFile, 1024) ; must be placed before strIconFile is initialized because VarSetCapacity erase its content
	ParseIconResource(strFavoriteIconResource, strIconFile, intIconIndex)
	blnFileExist := FileExistInPath(strIconFile)

	WinGet, hWnd, ID, A
	if (intIconIndex >= 0) ; adjust index for positive index only (not for negative index)
		intIconIndex := intIconIndex - 1
	
	if !DllCall("shell32\PickIconDlg", "Uint", hWnd, "str", strIconFile, "Uint", 260, "intP", intIconIndex)
		return ; return empty if user cancelled
	
	if (intIconIndex >= 0) ; adjust index for positive index only (not for negative index)
		intIconIndex := intIconIndex + 1

	if (strIconFile = o_JLicons.strFileLocation)
		return o_JLicons.GetName(intIconIndex) ; JLicons index "iconXYZ"
	else
		return strIconFile . "," . intIconIndex
}
;------------------------------------------------------------


;------------------------------------------------------------
ActiveMonitorInfo(ByRef intTop, ByRef intLeft, ByRef intWidth, ByRef intHeight)
; From Bluesmaster - retrieves the size of the monitor under the mouse
; from https://autohotkey.com/board/topic/111638-activemonitorinfo-get-monitor-resolution-and-origin-from-of-monitor-with-mouse-on/
;------------------------------------------------------------
{ 
	CoordMode, Mouse, Screen
	MouseGetPos, intMouseX, intMouseY
	SysGet, intMonitorsCount, MonitorCount
	Loop %intMonitorsCount%
    {
		SysGet, arrCurrentMonitor, Monitor, %A_Index%
		if (intMouseX >= arrCurrentMonitorLeft and intMouseX <= arrCurrentMonitorRight and intMouseY >= arrCurrentMonitorTop and intMouseY <= arrCurrentMonitorBottom )
		{
			intTop := arrCurrentMonitorTop
			intLeft := arrCurrentMonitorLeft
			intHeight := arrCurrentMonitorBottom - arrCurrentMonitorTop
			intWidth := arrCurrentMonitorRight  - arrCurrentMonitorLeft
			
			return
		}
	}
}
;------------------------------------------------------------


;------------------------------------------------------------
ExternalMenuIsReadOnly(strFile)
; Check if external settings file is Read-only (deprecated) or if it is a Centralized and current user cannot edit it
;------------------------------------------------------------
{
	if ExternalMenuFolderIsReadOnly(strFile)
		return true
	; else check if user is allowed to edit Centralized file

	strFile := PathCombine(A_WorkingDir, EnvVars(strFile))
	blnExternalMenuReadOnly := o_Settings.ReadIniValue("MenuReadOnly", 0, "Global", strFile) ; deprecated since v8.1.1 but still supported ix exists in ini file
	intMenuExternalType := o_Settings.ReadIniValue("MenuType", "", "Global", strFile)
	blnExternalMenuReadOnly := (blnExternalMenuReadOnly or intMenuExternalType = 3) ; 3 = Centralized
	
	if (blnExternalMenuReadOnly)
	{
		strWriteAccessUsers := o_Settings.ReadIniValue("WriteAccessUsers", " ", "Global", strFile) ; empty by default
		loop, Parse, strWriteAccessUsers, `,`; ; official delimiter is comma, semicolon also supported
			if (A_LoopField = A_UserName)
			{
				blnExternalMenuReadOnly := false
				break
			}
	}

	return blnExternalMenuReadOnly
}
;------------------------------------------------------------


;------------------------------------------------------------
ExternalMenuFolderIsReadOnly(strFile)
; Test if user can write to folder containing an external ini file, returns true if file is in a read-only folder, false if it is not read-only
; add folder to object g_aaExternalMenuFolderIsReadOnly to avoid checking same folder again (refreshed only when QAP is restarted)
;------------------------------------------------------------
{
	strFile := PathCombine(A_WorkingDir, EnvVars(strFile))
	SplitPath, strFile, , strFolder
	
	if !g_aaExternalMenuFolderIsReadOnly.HasKey(strFolder) ; if folder of file was not already checked
	{
		; by default RandomBetween returns an integer between 0 and 2147483647 to generate a random file number and variable number
		strRandomFile := strFolder . "\~$_QAP_Test_file_" . RandomBetween() . ".ini" ; Dropbox does not syn files starting with ~$
		
		IniWrite, %A_UserName% on %A_ComputerName% at %A_Now%, %strRandomFile%, Global, WriteAccessTest
		Sleep, 20 ; for safety
		strRead := o_Settings.ReadIniValue("WriteAccessTest", "", "Global", strRandomFile) ; ERROR if not found
		
		if (strRead <> "ERROR") ; the ini file was created, now delete it
		{
			intSleepDelay := 20
			Loop
			{
				sleep, %intSleepDelay%
				FileDelete, %strRandomFile% ; remove test file
				if (ErrorLevel) ; error 32 (file used by another process) frequent on synced platforms like Dropbox
				{
					intSleepDelay *= 2 ; double the delay
					if (intSleepDelay > 320) ; after 5 tries
						; ###_V(A_ThisFunc . " ERROR DELETING TEST FILE", ErrorLevel, A_LastError, strFile, strFolder, intRandom, strRandomFile, strRead)
						break
				}
				else
					; ###_V(A_ThisFunc . " CAN WRITE, FILE DELETED", ErrorLevel, A_LastError, strFile, strFolder, intRandom, strRandomFile, strRead)
					break
			}
			g_aaExternalMenuFolderIsReadOnly[strFolder] := false ; folder is not read-only
		}
		else
			; ###_V(A_ThisFunc . " CANNOT WRITE", strFile, strFolder, intRandom, strRandomFile, strRead)
			g_aaExternalMenuFolderIsReadOnly[strFolder] := true ; folder is read-only
	}

	return g_aaExternalMenuFolderIsReadOnly[strFolder]
}
;------------------------------------------------------------


;------------------------------------------------------------
ExternalMenuGetModifiedDateTime(strFile)
; returns the last modified date of the external menu
; (file system date-time or system's date-time UTC if blnLastModifiedFromNetworkOrCoud)
;------------------------------------------------------------
{
	blnLastModifiedFromNetworkOrCoud := o_Settings.ReadIniValue("LastModifiedFromSystem", " ", "Global", strFile)

	if (blnLastModifiedFromNetworkOrCoud)
		strDateTime := A_NowUTC . "UTC"
	else
		FileGetTime, strDateTime, %strFile% ; modification date-time by default
	
	return strDateTime
}
;------------------------------------------------------------


;------------------------------------------------------------
ScriptInfo(Command)
; From Lexikos (https://autohotkey.com/boards/viewtopic.php?t=9656)
; Returns the text that would have been shown in AutoHotkey's main window if you had called Command
; Used to retreive last Lines excuted when exiting if diag mode Enabled
; Test script (retain About 400 last Lines fo code):
	; #InstallKeybdHook
	; Loop, 1000
		; A := A_Index
	; Clipboard := ScriptInfo("ListLines")
	; ExitApp
;------------------------------------------------------------
{
    static s_hEdit := 0, pfn, bkp
    if !s_hEdit {
        s_hEdit := DllCall("GetWindow", "ptr", A_ScriptHwnd, "uint", 5, "ptr")
        user32 := DllCall("GetModuleHandle", "str", "user32.dll", "ptr")
        pfn := [], bkp := []
        for i, fn in ["SetForegroundWindow", "ShowWindow"] {
            pfn[i] := DllCall("GetProcAddress", "ptr", user32, "astr", fn, "ptr")
            DllCall("VirtualProtect", "ptr", pfn[i], "ptr", 8, "uint", 0x40, "uint*", 0)
            bkp[i] := NumGet(pfn[i], 0, "int64")
        }
    }
 
    if (A_PtrSize=8) {  ; Disable SetForegroundWindow and ShowWindow.
        NumPut(0x0000C300000001B8, pfn[1], 0, "int64")  ; return TRUE
        NumPut(0x0000C300000001B8, pfn[2], 0, "int64")  ; return TRUE
    } else {
        NumPut(0x0004C200000001B8, pfn[1], 0, "int64")  ; return TRUE
        NumPut(0x0008C200000001B8, pfn[2], 0, "int64")  ; return TRUE
    }
 
    static s_cmds := {ListLines:65406, ListVars:65407, ListHotkeys:65408, KeyHistory:65409}
    s_cmds[Command] ? DllCall("SendMessage", "ptr", A_ScriptHwnd, "uint", 0x111, "ptr", s_cmds[Command], "ptr", 0) : 0
 
    NumPut(bkp[1], pfn[1], 0, "int64")  ; Enable SetForegroundWindow.
    NumPut(bkp[2], pfn[2], 0, "int64")  ; Enable ShowWindow.
 
    ControlGetText, text,, ahk_id %s_hEdit%
    return text
}
;------------------------------------------------------------


;------------------------------------------------------------
GetCurrentUrlDDE(strClass)
; "GetCurrentUrlDDE" adapted from DDE code by Sean, (AHK_L version by maraskan_user) (via Joe Glines)
; Found at http://autohotkey.com/board/topic/17633-/?p=434518
;------------------------------------------------------------
{
	WinGet, strServer, ProcessName, % "ahk_class " . strClass
	SplitPath, strServer, , , , strServer ; remove executable file extention

	intCodePage := (A_IsUnicode ? 0x04B0 : 0x03EC) ; 0x04B0 = CP_WINUNICODE, 0x03EC = CP_WINANSI
	
	DllCall("DdeInitialize", "UPtrP", idInst, "Uint", 0, "Uint", 0, "Uint", 0)
	
	hServer := DllCall("DdeCreateStringHandle", "UPtr", idInst, "Str", strServer, "int", intCodePage)
	hTopic := DllCall("DdeCreateStringHandle", "UPtr", idInst, "Str", "WWW_GetWindowInfo", "int", intCodePage)
	hItem := DllCall("DdeCreateStringHandle", "UPtr", idInst, "Str", "0xFFFFFFFF", "int", intCodePage)
	hConv := DllCall("DdeConnect", "UPtr", idInst, "UPtr", hServer, "UPtr", hTopic, "Uint", 0)
	hData := DllCall("DdeClientTransaction", "Uint", 0, "Uint", 0, "UPtr", hConv, "UPtr", hItem, "UInt", 1, "Uint", 0x20B0, "Uint", 10000, "UPtrP", nResult) ; 0x20B0 = XTYP_REQUEST, 10000 = 10s timeout
	sData := DllCall("DdeAccessData", "Uint", hData, "Uint", 0, "Str")
	
	DllCall("DdeFreeStringHandle", "UPtr", idInst, "UPtr", hServer)
	DllCall("DdeFreeStringHandle", "UPtr", idInst, "UPtr", hTopic)
	DllCall("DdeFreeStringHandle", "UPtr", idInst, "UPtr", hItem)
	DllCall("DdeUnaccessData", "UPtr", hData)
	DllCall("DdeFreeDataHandle", "UPtr", hData)
	DllCall("DdeDisconnect", "UPtr", hConv)
	DllCall("DdeUninitialize", "UPtr", idInst)
	
	csvWindowInfo := StrGet(&sData, "CP0")
	StringSplit, strWindowInfo, csvWindowInfo, `" ;"; comment to avoid a syntax highlighting issue in autohotkey.com/boards
	
	Return strWindowInfo2
}
;------------------------------------------------------------


;------------------------------------------------------------
GetCurrentUrlAcc(strClass)
; Found at https://autohotkey.com/boards/viewtopic.php?f=6&t=3702&start=60
;------------------------------------------------------------
{
	; static or global?
	global nWindow
	global accAddressBar
	
	If (nWindow != WinExist("ahk_class " strClass)) ; reuses accAddressBar if it's the same window
	{
		nWindow := WinExist("ahk_class " strClass)
		accAddressBar := GetAddressBar(GetCurrentUrlAccObjectFromWindow(nWindow))
	}
	Try sURL := accAddressBar.accValue(0)
		If (sURL == "")
		{
			WinGet, nWindows, List, % "ahk_class " strClass ; In case of a nested browser window as in the old CoolNovo (TO DO: check if still needed)
			If (nWindows > 1)
			{
				accAddressBar := GetAddressBar(GetCurrentUrlAccObjectFromWindow(nWindows2))
				Try sURL := accAddressBar.accValue(0)
			}
		}
	If ((sURL != "") and (SubStr(sURL, 1, 4) != "http")) ; Modern browsers omit "http://"
		sURL := "http://" . sURL
	If (sURL == "")
		nWindow := -1 ; Don't remember the window if there is no URL
	Return sURL
}
;------------------------------------------------------------


;------------------------------------------------------------
GetAddressBar(accObj, accPath:="")
; "GetAddressBar" based in code by stealzy
; Found at https://autohotkey.com/boards/viewtopic.php?p=109548#p109548
; IsUrl in this functions above replaced by my own code LocationIsHttp
;------------------------------------------------------------
{
	n := 0
	Try If ((accObj.accRole(0) == 42) and StrLen(accObj.accValue(0)) and LocationIsHttp(accObj.accValue(0)))
		Return accObj
	Try If ((accObj.accRole(0) == 42) and StrLen(accObj.accValue(0)) and LocationIsHttp("http://" . accObj.accValue(0))) ; Modern browsers omit "http://"
		Return accObj
	For nChild, accChild in GetCurrentUrlAccChildren(accObj)
	{
		n++
		currentPath := accPath . n . "."
		If IsObject(accAddressBar := GetAddressBar(accChild, currentPath))
			Return accAddressBar
	}
}
;------------------------------------------------------------


;------------------------------------------------------------
GetCurrentUrlAccInit()
; Part of the Acc.ahk Standard Library by Sean (updated by jethrow) (via Joe Glines)
; Found at http://autohotkey.com/board/topic/77303-/?p=491516
;------------------------------------------------------------
{
	static s_h
	If Not s_h
		s_h := DllCall("LoadLibrary", "Str", "oleacc", "Ptr")
}
;------------------------------------------------------------


;------------------------------------------------------------
GetCurrentUrlAccObjectFromWindow(hWnd, idObject = 0)
; Part of the Acc.ahk Standard Library by Sean (updated by jethrow) (via Joe Glines)
; Found at http://autohotkey.com/board/topic/77303-/?p=491516
;------------------------------------------------------------
{
	GetCurrentUrlAccInit()
	If DllCall("oleacc\AccessibleObjectFromWindow", "Ptr", hWnd, "UInt", idObject&=0xFFFFFFFF, "Ptr"
		, -VarSetCapacity(IID, 16) + NumPut(idObject == 0xFFFFFFF0 ? 0x46000000000000C0 : 0x719B3800AA000C81
		, NumPut(idObject == 0xFFFFFFF0 ? 0x0000000000020400 : 0x11CF3C3D618736E0, IID, "Int64"), "Int64"), "Ptr*", pacc) = 0
		Return ComObjEnwrap(9, pacc, 1)
}
;------------------------------------------------------------


;------------------------------------------------------------
GetCurrentUrlAccQuery(objAcc)
; Part of the Acc.ahk Standard Library by Sean (updated by jethrow) (via Joe Glines)
; Found at http://autohotkey.com/board/topic/77303-/?p=491516
;------------------------------------------------------------
{
	Try Return ComObj(9, ComObjQuery(objAcc, "{618736e0-3c3d-11cf-810c-00aa00389b71}"), 1)
}
;------------------------------------------------------------


;------------------------------------------------------------
GetCurrentUrlAccChildren(objAcc)
; Part of the Acc.ahk Standard Library by Sean (updated by jethrow) (via Joe Glines)
; Found at http://autohotkey.com/board/topic/77303-/?p=491516
;------------------------------------------------------------
{
	If ComObjType(objAcc,"Name") != "IAccessible"
		ErrorLevel := "Invalid IAccessible Object"
	Else
	{
		GetCurrentUrlAccInit()
		cChildren := objAcc.accChildCount
		Children := []
		If DllCall("oleacc\AccessibleChildren", "Ptr", ComObjValue(objAcc), "Int", 0, "Int", cChildren, "Ptr"
			, VarSetCapacity(varChildren, cChildren * (8 + 2 * A_PtrSize), 0) * 0 + &varChildren, "Int*", cChildren) = 0
		{
			Loop, %cChildren%
			{
				i := (A_Index - 1) * (A_PtrSize * 2 + 8) + 8
				child := NumGet(varChildren, i)
				Children.Insert(NumGet(varChildren, i - 8) = 9 ? GetCurrentUrlAccQuery(child) : child)
				(NumGet(varChildren, i - 8) = 9 ? ObjRelease(child) : "")
			}
			Return (Children.MaxIndex() ? Children : "")
		}
		Else
			ErrorLevel := "AccessibleChildren DllCall Failed"
	}
}
;------------------------------------------------------------


;------------------------------------------------------------
WindowIsToMenuDialogBox(strTitle)
;------------------------------------------------------------
{
	strTitle := SubStr(strTitle, 1, InStr(strTitle, " - "))
	return InStr(o_L["DialogMoveFavoriteTitle"], strTitle) or InStr(o_L["DialogMoveFavoritesTitle"], strTitle) or InStr(o_L["DialogCopyFavoritesTitle"], strTitle)
}
;------------------------------------------------------------


;------------------------------------------------------------
WindowIsAddEditCopyFavorite(strTitle)
;------------------------------------------------------------
{
	strTitle := SubStr(strTitle, 1, InStr(strTitle, ":"))
	return StrLen(strTitle)
		and (InStr(L(o_L["DialogAddEditFavoriteTitle"], o_L["DialogAdd"]), strTitle)
		or InStr(L(o_L["DialogAddEditFavoriteTitle"], o_L["DialogEdit"]), strTitle)
		or InStr(L(o_L["DialogAddEditFavoriteTitle"], o_L["DialogCopy"]), strTitle))
}
;------------------------------------------------------------


;------------------------------------------------------------
QAPSettingsString()
;------------------------------------------------------------
{
	return L(o_L["GuiTitle"], g_strAppNameText, g_strAppVersion)
}
;------------------------------------------------------------


;------------------------------------------------------------
GetInputLanguage()
; from YMP (https://autohotkey.com/board/topic/43043-get-current-keyboard-layout/#entry268123)
;------------------------------------------------------------
{
	strFormat := A_FormatInteger
	SetFormat, Integer, H ; integer hexa
	strProcessID := DllCall("GetCurrentProcessId")
	strThreadID := DllCall("GetWindowThreadProcessId", "UInt", strProcessID, "UInt", 0)
	strInputLanguage := DllCall("GetKeyboardLayout", "UInt", strThreadID, "UInt")
	SetFormat, Integer, %strFormat% ; integer back to previsous format
	
	StringRight, strInputLanguage, strInputLanguage, 4 ; keep four right digits
	
	return strInputLanguage
}
;------------------------------------------------------------


;------------------------------------------------------------
RandomBetween(intMin := 0, intMax := 2147483647)
;------------------------------------------------------------
{
	Random, intValue, %intMin%, %intMax%
	
	return intValue
}
;------------------------------------------------------------


;------------------------------------------------------------
ResetArray(ByRef arr)
;------------------------------------------------------------
{
	Loop, % %arr%0
		%arr%%A_Index% := ""
	%arr%0 := "" ; do not forget to reset the counter
}
;------------------------------------------------------------


;------------------------------------------------------------
BetweenParenthesis(str)
;------------------------------------------------------------
{
	return "(" . str . ")"
}
;------------------------------------------------------------


;------------------------------------------------------------
KeepThisWindow(intIndex, strWinID, strCaller, ByRef objWindowProperties)
; strCaller: one of "List All", "Current Windows", "Close All Windows menu" or "Running Applications"
;------------------------------------------------------------
{
	static s_strWinTitlesWinApps
	
	if (intIndex = 1)
		s_strWinTitlesWinApps := "" ; #### to be validated or continued
	
	objWindowProperties := Object()
	objWindowProperties.Index := intIndex
	objWindowProperties.WindowID := strWinID
	
	WinGet, strProcessName, ProcessName, % "ahk_id " . strWinID
	objWindowProperties.ProcessName := strProcessName
    if (strProcessName == "explorer.exe") ; case sensitive
		strWindowTitle := "Explorer"
	else
		WinGetTitle, strWindowTitle, % "ahk_id " strWinID
	objWindowProperties.WindowTitle := strWindowTitle
	WinGet, strProcessPath, ProcessPath, % "ahk_id " . strWinID
	objWindowProperties.ProcessPath := strProcessPath
	WinGetPos, intX, intY, intW, intH, % "ahk_id " strWinID
	blnWandH := intW and intH
	objWindowProperties.WandH := blnWandH
	WinGet, intMinMax, MinMax, % "ahk_id " . strWinID
	objWindowProperties.MinMax := intMinMax
	WinGet, intStyle, Style, % "ahk_id " . strWinID
	objWindowProperties.Style := intStyle
	WinGet, intExStyle, ExStyle, % "ahk_id " . strWinID
	objWindowProperties.ExStyle := intExStyle
	WinGetClass, strWindowClass, % "ahk_id " . strWinID ; for Switch only, no need to put in object
	
    if (strProcessName = "ApplicationFrameHost.exe")
	{
        ControlGet, intUniversalApplicationID, Hwnd, , Windows.UI.Core.CoreWindow1, % "ahk_id " . strWinID
        if (intUniversalApplicationID)
		{
            WinGet strUniversalApplicationName, ProcessName, ahk_id %intUniversalApplicationID%
			objWindowProperties.UniversalApplicationName := strUniversalApplicationName
			objWindowProperties.UniversalApplicationID := intUniversalApplicationID
		}
		; if (intExStyle = 0x00200000) ; WS_EX_NOREDIRECTIONBITMAP (see https://greenshot.atlassian.net/browse/BUG-2017)
		; {
			; remember titles of window of intExStyle 0x00200000 because another window with same name and intExStyle 0x00200100 is also a ghost window (not real active window)
			; s_strWinTitlesWinApps .= strWindowTitle . "|"
			; ###_V("s_strWinTitlesWinApps", s_strWinTitlesWinApps)
			; always skip windows with intExStyle is 0x00200000 because it is a ghost Windows app (not real active window)
		; }
		; #### to be validated or continued
		; #### run after loops, not here
		; remove apps of ExStyle 0x00200100 if we previously had a ghost Windows app of same title
		; Loop, % objFoldersAndAppsList.MaxIndex()
		;	if (objFoldersAndAppsList[A_Index].ExStyle = 0x00200100) and InStr(s_strWinTitlesWinApps, objFoldersAndAppsList[A_Index].Name . "|")
		;		objFoldersAndAppsList.Remove(A_Index)
	}
	
	; if InStr(strWindowTitle, "Calendrier")
		; ###_O("objWindowProperties", objWindowProperties)
	; if InStr(strProcessPath, "opus")
		; ###_O(strCaller . " / " . strProcessPath . " / " . g_strDirectoryOpusPath . " / " . g_intActiveFileManager, objWindowProperties)

	if (strCaller = "List All")
		return true
	
	if !StrLen(strWindowTitle)
		or !StrLen(strProcessPath)
		or !(blnWandH)
		or (strProcessPath = A_ProgramFiles . "\Windows Sidebar\sidebar.exe")
		or InStr(strProcessPath, A_ProgramFiles . "\WindowsApps\") ; and (intExStyle <> 0x00280000)
		return false

	else if (strProcessName = "ApplicationFrameHost.exe")
		; si minimis conserver
	{
		if ApplicationIsExcluded(strWindowClass, strWindowTitle, strProcessName)
			return false
		else
			return StrLen(intUniversalApplicationID) ; this is a running and normal (or maximized?)
				or (intMinMax = -1) ; this is a running and minimized
	}
	
	else if (strCaller = "Current Windows menu" and strProcessPath = A_WinDir . "\explorer.exe")
		return false
	
	else if (strCaller = "Current Windows menu" and strProcessPath = g_aaFileManagerDirectoryOpus.strFileManagerPath and o_FileManagers.SA.P_intActiveFileManager = 2)
		return false
	
	else if (strCaller = "Current Windows menu" and StrLen(o_Settings.Execution.strSwitchExclusionList.IniValue))
		if ApplicationIsExcluded(strWindowClass, strWindowTitle, strProcessName)
			return false
	
	else if (intStyle = 0x94000000 and intExStyle = 0x00200000)
		; added in v9.4.1.5, exclude ghost Windows Apps - maybe make an option to reject (default) or keep
		return false
		
	; else if (blnExcludeProgramManager and strProcessPath = "ProgramManager") ; ####
		; return false
	
	return true
}
;------------------------------------------------------------


;------------------------------------------------------------
ApplicationIsExcluded(strWindowClass, strWindowTitle, strProcessName)
;------------------------------------------------------------
{
	Loop, parse, % o_Settings.Execution.strSwitchExclusionList.IniValue, |
		if StrLen(A_LoopField)
			and (InStr(strWindowClass, A_LoopField)
			or InStr(strWindowTitle, A_LoopField)
			or InStr(strProcessName, A_LoopField))
			return true
		
	return false
}
;------------------------------------------------------------


;------------------------------------------------------------
RecentGetUsageDbTargetFileInfo(strPath, ByRef strAttributes, ByRef strType, ByRef strDateTime, ByRef strExtension, strSource)
;------------------------------------------------------------
{
	if (SubStr(strPath, 1, 2) = "\\")
	; if on network, if server is offline, return data based on path only
	{
		blnOffline := ServerIsOffline(strPath)
		Diag(A_ThisFunc . " based on extension or dummy data from: " . strSource, strPath . " " . (blnOffline ? "(OFFLINE)" : "(ONLINE)"), "ELAPSED")
		if (blnOffline)
		{
			strAttributes := "???" ; do not leave empty - file will be processed and added to database
			strExtension := GetFileExtension(strPath)
			if StrLen(strExtension)
				if InStr("exe|com|bat|ahk|vbs|cmd", strExtension)
					strType := "Application"
				else ; we must assume that if there is an extension, it is a file (could be misleading for foler like "\\server\path.ext")
					strType := "File"
			else
				strType := "Folder"
			strDateTime := "" ; unknown
			
			return
		}
	}
	; do not else

	GetUsageDbTargetFileInfo(strPath, strAttributes, strType, strDateTime, strExtension)
}
;------------------------------------------------------------


;------------------------------------------------------------
GetUsageDbTargetFileInfo(strPath, ByRef strAttributes, ByRef strType, ByRef strDateTime, ByRef strExtension)
;------------------------------------------------------------
{
	strAttributes := FileExist(strPath)
	if StrLen(strAttributes)
	{
		strExtension := GetFileExtension(strPath)
		if StrLen(strExtension) and InStr("exe|com|bat|ahk|vbs|cmd", strExtension)
			strType := "Application"
		else if LocationIsDocument(strPath)
			strType := "File"
		else
			strType := "Folder"
		FileGetTime, strDateTime, %strPath%
	}
	else
	{
		strExtension := ""
		strType := ""
		strDateTime := ""
	}
	Diag(A_ThisFunc, strPath . " | "
		. strAttributes . " | "
		. strType . " | "
		. strDateTime . " | "
		. "", "ELAPSED")
}
;------------------------------------------------------------


;------------------------------------------------------------
GetUsageDbColumnExist(strTable, strColumnName)
;------------------------------------------------------------
{
	global o_UsageDb
	
	o_UsageDb.GetTable("PRAGMA table_info('" . strTable . "');", o_RecordSet)
	
	for intRow, o_Row in o_RecordSet.Rows
		if (o_Row[2] = strColumnName)
			return true
		
	return false
}
;------------------------------------------------------------


;------------------------------------------------------------
ConvertUsageDbDateFormat(strDate)
;------------------------------------------------------------
{
	return (!StrLen(strDate) or InStr(strDate, " ") ? strDate : ""
		. SubStr(strDate, 1, 4) . "-"
		. SubStr(strDate, 5, 2) . "-"
		. SubStr(strDate, 7, 2) . " "
		. SubStr(strDate, 9, 2) . ":"
		. SubStr(strDate, 11, 2) . ":"
		. SubStr(strDate, 13, 2))
}
;------------------------------------------------------------


;------------------------------------------------------------
ScreenConfigurationChanged()
; used when showing Settings window only, using current (not saved) g_strLastConfiguration
;------------------------------------------------------------
{
	strCurrentScreenConfiguration := GetScreenConfiguration()
	blnConfigurationChanged := (strCurrentScreenConfiguration <> g_strLastConfiguration)
	g_strLastConfiguration := strCurrentScreenConfiguration
	
	return blnConfigurationChanged
}
;------------------------------------------------------------


;------------------------------------------------------------
GetGui2Size(strThisDialog, ByRef intWidth, ByRef intHeight)
;------------------------------------------------------------
{
	strPosition := o_Settings.ReadIniValue(strThisDialog, "")
	saPosition := StrSplit(strPosition, "|") ; array is returned by ByRef parameters
	intWidth := saPosition[3] + 10 ; + 10 correction from trial/error
	intHeight := saPosition[4]
}
;------------------------------------------------------------


;------------------------------------------------------------
CalculateTopGuiPosition(g_strTopHwnd, g_strRefHwnd, ByRef intTopGuiX, ByRef intTopGuiY)
;------------------------------------------------------------
{
	WinGetPos, intRefGuiX, intRefGuiY, intRefGuiW, intRefGuiH, ahk_id %g_strRefHwnd%
	intRefGuiCenterX := intRefGuiX + (intRefGuiW // 2)
	intRefGuiCenterY := intRefGuiY + (intRefGuiH // 2)

	WinGetPos, , , intTopGuiW, intTopGuiH, ahk_id %g_strTopHwnd%
	intTopGuiX := intRefGuiCenterX - (intTopGuiW // 2) + 5 ; + 5 correction from trial/error
	intTopGuiY := intRefGuiCenterY - (intTopGuiH // 2)
	
	WinGetPos, intWindowX, intWindowY, intWindowWidth, intWindowHeight, ahk_id %g_strRefHwnd%
	WinGetTitle, v, ahk_id %g_strRefHwnd%
	SysGet, arrCurrentMonitor, Monitor, % GetActiveMonitorForPosition(intWindowX, intWindowY, intNbMonitors)

	; ###_V(A_ThisFunc, v, g_strRefHwnd, intWindowX, intWindowY, GetActiveMonitorForPosition(intWindowX, intWindowY, intNbMonitors))
	intTopGuiX := (intTopGuiX < arrCurrentMonitorLeft ? arrCurrentMonitorLeft : intTopGuiX)
	intTopGuiY := (intTopGuiY < arrCurrentMonitorTop ? arrCurrentMonitorTop : intTopGuiY)
}
;------------------------------------------------------------


;------------------------------------------------------------
GetSavedSettingsWindowPosition(ByRef saSettingsPosition)
; use LastScreenConfiguration and window position from ini file
; if screen configuration changed, return -1 instead of the saved position
;------------------------------------------------------------
{
	g_strLastScreenConfiguration := o_Settings.ReadIniValue("LastScreenConfiguration", " ") ; to reset position if screen config changed since last session
	
	strCurrentScreenConfiguration := GetScreenConfiguration()
	if !StrLen(g_strLastScreenConfiguration) or (strCurrentScreenConfiguration <> g_strLastScreenConfiguration)
	{
		IniWrite, %strCurrentScreenConfiguration%, % o_Settings.strIniFile, Global, LastScreenConfiguration ; always save in case QAP is not closed properly
		arrSettingsPosition1 := -1 ; returned value by first ByRef parameter
	}
	else
		if (o_Settings.SettingsWindow.blnRememberSettingsPosition.IniValue)
		{
			strSettingsPosition := o_Settings.ReadIniValue("SettingsPosition", -1) ; by default -1 to center at minimal size
			saSettingsPosition := StrSplit(strSettingsPosition, "|")
		}
		else ; delete Settings position
		{
			IniDelete, % o_Settings.strIniFile, Global, SettingsPosition
			arrSettingsPosition1 := -1 ; returned value by first ByRef parameter
		}
	
	g_strLastConfiguration := strCurrentScreenConfiguration
}
;------------------------------------------------------------


;------------------------------------------------------------
GetScreenConfiguration()
; return the current monitor configuration in the following format:
; n,p:left,top,right,bottom|left,top,right,bottom|...
; nb of monitors, primary display, and coordinates of each monitor
;------------------------------------------------------------
{
	SysGet, intNbMonitors, MonitorCount
	SysGet, intIdPrimaryDisplay, MonitorPrimary

	strMonitorConfiguration := intNbMonitors . "," . intIdPrimaryDisplay . ":"
	Loop %intNbMonitors%
	{
		SysGet, arrMonitor, Monitor, %A_Index%
		Loop, Parse, % "Left|Top|Right|Bottom", |
			strMonitorConfiguration .= arrMonitor%A_LoopField% . (A_Index < 4 ? "," : "")
		strMonitorConfiguration .= (A_Index < intNbMonitors ? "|" : "")
	}
	
	return strMonitorConfiguration
}
;------------------------------------------------------------


;------------------------------------------------------------
SaveWindowPosition(strThisWindow, strWindowHandle)
; format: x|y|w|h
;------------------------------------------------------------
{
	if (strThisWindow <> "SettingsPosition" or o_Settings.SettingsWindow.blnRememberSettingsPosition.IniValue)
	; always for Add, Edit, Copy or Move Favorites dialog boxes, only if remember for Settings
	{
		WinGet, intMinMax, MinMax, %strWindowHandle%
		if (intMinMax <> 1) ; if window is maximized, we keep the last saved position and size
		{
			WinGetPos, intX, intY, intW, intH, %strWindowHandle%
			strPosition := intX . "|" . intY . "|" . intW . "|" . intH
			IniWrite, %strPosition%, % o_Settings.strIniFile, Global, %strThisWindow%
		}
	}
	else ; delete Settings position
		IniDelete, % o_Settings.strIniFile, Global, %strThisWindow%
}
;------------------------------------------------------------


;------------------------------------------------------------
GetWindowPositionOnActiveMonitor(strWindowId, intActivePositionX, intActivePositionY, ByRef intWindowX, ByRef intWindowY)
; returns true if more than one monitor and success retrieving new X-Y position on active monitor else returns false
; returns ByRef new or unmodified X and Y
;------------------------------------------------------------
{
	WinGetPos, intWindowX, intWindowY, intWindowWidth, intWindowHeight, %strWindowId%
	
	intActiveMonitorForWindow := GetActiveMonitorForPosition(intWindowX, intWindowY, intNbMonitors)
	intActiveMonitorForPosition := GetActiveMonitorForPosition(intActivePositionX, intActivePositionY, intNbMonitors)
	; ###_V(A_ThisFunc, "*intActiveMonitorForWindow", intActiveMonitorForWindow, "*intActiveMonitorForPosition", intActiveMonitorForPosition)
	
	if (intNbMonitors > 1) and intActiveMonitorForWindow and (intActiveMonitorForWindow <> intActiveMonitorForPosition)
	{
		; calculate Explorer window position relative to center of screen
		SysGet, arrThisMonitor, Monitor, %intActiveMonitorForPosition% ; Left, Top, Right, Bottom
		intWindowX := arrThisMonitorLeft + (((arrThisMonitorRight - arrThisMonitorLeft) - intWindowWidth) / 2)
		intWindowY := arrThisMonitorTop + (((arrThisMonitorBottom - arrThisMonitorTop) - intWindowHeight) / 2)
		
		; ###_V(A_ThisFunc . " True", strWindowId, intNbMonitors, intActiveMonitorForWindow, intActiveMonitorForPosition, "", intActivePositionX, intActivePositionY, "ByRef", intWindowX, intWindowY)
		return true
	}
	
	; ###_V(A_ThisFunc . " False", strWindowId, intNbMonitors, intActiveMonitorForWindow, intActiveMonitorForPosition, "", intActivePositionX, intActivePositionY, "ByRef", intWindowX, intWindowY)
	return false
}
;------------------------------------------------------------


;------------------------------------------------------------
GetActiveMonitorForPosition(intX, intY, ByRef intNbMonitors)
;------------------------------------------------------------
{
	SysGet, intNbMonitors, MonitorCount
	Loop, % intNbMonitors
	{
		SysGet, arrThisMonitor, Monitor, %A_Index% ; Left, Top, Right, Bottom
		; ###_V(A_ThisFunc . " monitor " . A_Index, arrThisMonitorLeft, intX, arrThisMonitorRight, "", arrThisMonitorTop, intY, arrThisMonitorBottom, ""
			; , (intX >= arrThisMonitorLeft and intX < arrThisMonitorRight
				; and intY >= arrThisMonitorTop and intY < arrThisMonitorBottom))

		if  (intX >= arrThisMonitorLeft and intX < arrThisMonitorRight
			and intY >= arrThisMonitorTop and intY < arrThisMonitorBottom)
			
			return A_Index
	}
}
;------------------------------------------------------------


;------------------------------------------------------------
GetPositionFromMouseOrKeyboard(strMenuTriggerLabel, strThisHotkey, ByRef intPositionX, ByRef intPositionY)
; get current mouse position (if favorite was open with mouse) or active window position (if favorite was open with keyboard)
;------------------------------------------------------------
{
	if !StrLen(strMenuTriggerLabel) ; when strMenuTriggerLabel is empty, if strThisHotkey contains "Button" or "Wheel", check mouse position
		strPositionReference := (InStr(strThisHotkey, "Button") or InStr(strThisHotkey, "Wheel") ? "Mouse" : "Window")
	else if InStr(strMenuTriggerLabel, "Keyboard")
		strPositionReference := "Window" ; check active window position
	else
		strPositionReference := "Mouse" ; all other menu triggers, check mouse position
	
	if (strPositionReference = "Mouse")
	{
		CoordMode, Mouse, Screen
		MouseGetPos, intPositionX, intPositionY
	}
	else
		WinGetPos, intPositionX, intPositionY, , , A ; window top-left position
	
	; ###_V(A_ThisFunc, strMenuTriggerLabel, strThisHotkey, "ByRef", intPositionX, intPositionY)
}
;------------------------------------------------------------


;------------------------------------------------------------
DoubleAmpersand(str)
; for ampersand in menu item names
;------------------------------------------------------------
{
	if (o_Settings.Menu.blnDisplayNumericShortcuts.IniValue and SubStr(str, 1, 1) = "&")
	{
		str := SubStr(str, 2)
		blnRestoreNumericShortcut := true
	}
	
	str := StrReplace(str, "&&", g_strEscapeReplacement) ; preserve existing double ampersand
	str := StrReplace(str, "&", "&&") ; double single ampersand
	str := StrReplace(str, g_strEscapeReplacement, "&&") ; restore preserved double ampersand

	return (blnRestoreNumericShortcut ? "&" : "") . str
}
;------------------------------------------------------------


;------------------------------------------------------------
RemoveSingleAmpersand(str, blnMakeDoubleSingle = false)
;------------------------------------------------------------
{
	str := StrReplace(str, "&&", g_strEscapeReplacement) ; preserve existing double ampersand
	str := StrReplace(str, "&", "") ; remove single ampersand
	str := StrReplace(str, g_strEscapeReplacement, (blnMakeDoubleSingle ? "&" : "&&")) ; restore preserved double ampersand

	return str
}
;------------------------------------------------------------


;------------------------------------------------------------
BuildMonitorsList(intDefault)
;------------------------------------------------------------
{
	if !(intDefault)
		intDefault := 1
	SysGet, intNbMonitors, MonitorCount
	Loop, %intNbMonitors%
		str .= o_L["DialogWindowMonitor"] . " " . A_Index . "|" . (A_Index = intDefault ? "|" : "")
	
	return str
}
;------------------------------------------------------------


;------------------------------------------------------------
GetLocalizedNameForClassId(strClassId)
;------------------------------------------------------------
{
    RegRead, strLocalizedString, HKEY_CLASSES_ROOT, CLSID\%strClassId%, LocalizedString
    ; strLocalizedString example: "@%SystemRoot%\system32\shell32.dll,-9216"

    StringSplit, arrLocalizedString, strLocalizedString, `,
    intDllNameStart := InStr(arrLocalizedString1, "\", , 0)
    StringRight, strDllFile, arrLocalizedString1, % StrLen(arrLocalizedString1) - intDllNameStart
    strDllIndex := arrLocalizedString2
    strTranslatedName := TranslateMUI(strDllFile, Abs(strDllIndex))
    
    return strTranslatedName
}
;------------------------------------------------------------


;------------------------------------------------------------
TranslateMUI(resDll, resID)
; source: 7plus (https://github.com/7plus/7plus/blob/master/MiscFunctions.ahk)
;------------------------------------------------------------
{
	VarSetCapacity(buf, 256) 
	hDll := DllCall("LoadLibrary", "str", resDll, "Ptr") 
	Result := DllCall("LoadString", "Ptr", hDll, "uint", resID, "str", buf, "int", 128)
	return buf
}
;------------------------------------------------------------


;------------------------------------------------------------
GetIconForClassId(strClassId)
;------------------------------------------------------------
{
	RegRead, strDefaultIcon, HKEY_CLASSES_ROOT, CLSID\%strClassId%\DefaultIcon
    return strDefaultIcon
}
;------------------------------------------------------------


;------------------------------------------------------------
MD5(str, blnCase := false)
; by SKAN | rewritten by jNizM (https://www.autohotkey.com/boards/viewtopic.php?f=76&t=14927&p=75925&hilit=MD5sum#p75944)
;------------------------------------------------------------
{
	static MD5_DIGEST_LENGTH := 16
	hModule := DllCall("LoadLibrary", "Str", "advapi32.dll", "Ptr")
		, VarSetCapacity(MD5_CTX, 104, 0), DllCall("advapi32\MD5Init", "Ptr", &MD5_CTX)
		, DllCall("advapi32\MD5Update", "Ptr", &MD5_CTX, "AStr", str, "UInt", StrLen(str))
		, DllCall("advapi32\MD5Final", "Ptr", &MD5_CTX)
	loop % MD5_DIGEST_LENGTH
		o .= Format("{:02" (blnCase ? "X" : "x") "}", NumGet(MD5_CTX, 87 + A_Index, "UChar"))
	return o, DllCall("FreeLibrary", "Ptr", hModule)
}
;------------------------------------------------------------


;---------------------------------------------------------
RegistryExist(strKeyName, strValueName)
;---------------------------------------------------------
{
	RegRead, strValue, %strKeyName%, %strValueName%
	
	return StrLen(strValue)
}
;---------------------------------------------------------


;---------------------------------------------------------
GetRegistry(strKeyName, strValueName)
;---------------------------------------------------------
{
	RegRead, strValue, %strKeyName%, %strValueName%
	
	return strValue
}
;---------------------------------------------------------


;---------------------------------------------------------
SetRegistry(strValue, strKeyName, strValueName)
;---------------------------------------------------------
{
	RegWrite, REG_SZ, %strKeyName%, %strValueName%, %strValue%
	if (ErrorLevel)
		Oops("An error occurred while writing the registry key.`n`nValue: " . strValueName . "`nKey name: " . strKeyName)
}
;---------------------------------------------------------


;---------------------------------------------------------
RemoveRegistry(strKeyName, strValueName)
;---------------------------------------------------------
{
	if !RegistryExist(strKeyName, strValueName)
		return
	
	RegDelete, %strKeyName%, %strValueName%
	if (ErrorLevel)
		Oops("An error occurreed while removing the registre key.`n`nValue: " . strValueName . "`nKey name: " . strKeyName)	
}
;---------------------------------------------------------


;------------------------------------------------------------
ToggleRunAtStartup(blnForce := -1)
; blnForce: -1 toggle, 0 disable, 1 enable
;------------------------------------------------------------
{
	if (blnForce = g_aaMenuTrayL["MenuRunAtStartup"]) ; toggle from Tray menu
		; because function as Tray menu command puts the menu name in first parameter (https://hotkeyit.github.io/v2/docs/commands/Menu.htm#Add_or_Change_Items_in_a_Menu)
		blnForce := -1
	
	if (g_blnPortableMode)
		blnValueBefore := StrLen(FileExist(A_Startup . "\" . g_strAppNameFile . ".lnk")) ; convert file attribute to numeric (boolean) value
	else
		blnValueBefore := RegistryExist("HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run", g_strAppNameText)

	blnValueAfter := (blnForce = -1 ? !blnValueBefore : blnForce)

	if (g_blnPortableMode)
	{
		Menu, Tray, % (blnValueAfter ? "Check" : "Uncheck"), % g_aaMenuTrayL["MenuRunAtStartup"]
		
		; Startup code adapted from Avi Aryan Ryan in Clipjump
		if FileExist(A_Startup . "\" . g_strAppNameFile . ".lnk")
			FileDelete, %A_Startup%\%g_strAppNameFile%.lnk
		if (blnValueAfter)
			Gosub, CreateStartupShortcut
	}
	else ; setup mode

		if (blnValueAfter)
			SetRegistry("QuickAccessPopup.exe", "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run", g_strAppNameText)
		else
			RemoveRegistry("HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run", g_strAppNameText)
}
;------------------------------------------------------------


;------------------------------------------------------------
FolderExistOrCreate(strFolder)
;------------------------------------------------------------
{
	strTempLocation := strFolder
	blnOK := FileExistInPath(strTempLocation) ; return strTempLocation with expanded relative path and envvars, and absolute location if in PATH
	if (!blnOK)
	{
		MsgBox, 36, %g_strAppNameText%, % L(o_L["DialogOptionsPathNotExist"], strFolder)
		IfMsgBox, Yes
		{
			FileCreateDir, %strFolder%
			blnOK := FolderExistOrCreate(strFolder) ; recursive
		}
	}
	return blnOK
}
;------------------------------------------------------------


;------------------------------------------------------------
StrLower(str)
;------------------------------------------------------------
{
	StringLower, strLower, str
	return strLower
}
;------------------------------------------------------------


;------------------------------------------------------------
StrUpper(str)
;------------------------------------------------------------
{
	StringUpper, strUpper, str
	return strUpper
}
;------------------------------------------------------------



;========================================================================================================================
; END OF VARIOUS_FUNCTIONS
;========================================================================================================================


;========================================================================================================================
!_098_ONMESSAGE_FUNCTIONS:
return
;========================================================================================================================


;------------------------------------------------
WM_MOUSEMOVE(wParam, lParam)
; "hook" for image buttons cursor and buttons tooltips
; see http://www.autohotkey.com/board/topic/70261-gui-buttons-hover-cant-change-cursor-to-hand/
; and https://autohotkey.com/board/topic/83045-solved-onmessage-gui-tooltips-issues/#entry528803
;------------------------------------------------
{
	static s_strControl
	static s_strControlPrev
	
	global g_objHandCursor
	global g_strGuiFullTitle
	global g_blnEditButtonDisabled

	; get window's titte and exit if it is not the Settings window
	WinGetTitle, strCurrentWindow, A
	if (strCurrentWindow <> g_strGuiFullTitle)
		return

	; empty Search box when it receives focus and contains the "Search" prompt
	GuiControlGet, strFocusedControl, FocusV
	GuiControlGet, strFocusedControlText, , f_strFavoritesListFilter
	if (strFocusedControl = "f_strFavoritesListFilter")
		if (g_blnFavoritesListFilterNeverFocused)
		{
			GuiControl, , f_strFavoritesListFilter, % ""
			g_blnFavoritesListFilterNeverFocused := false
		}

	; get hover control name and Static control number
	s_strControlPrev := s_strControl
	MouseGetPos, , , , s_strControl ; Static1, StaticN, Button1, ButtonN
	intControl := StrReplace(s_strControl, "Static")
	
	; display hand cursor over selected buttons
	if InStr(s_strControl, "Static")
	{
		; 2-36 except 34 (and except 3, 4 and 25 if Edit disabled)
		if (intControl < 2) or (intControl = 34) or (intControl > 35)
			or ((intControl = 3 or intControl = 4 or intControl = 25) and g_blnEditButtonDisabled)
			return
	}
	else if !InStr(s_strControl, "Button")
	{
		ToolTip ; turn ToolTip off
		return
	}
	DllCall("SetCursor", "UInt", g_objHandCursor)
	
	; display tooltip for hovered control
	if (s_strControl <> s_strControlPrev) ;  prevent flicker caused by repeating tooltip when mouse moving over the same control
		and StrLen(g_aaToolTipsMessages[s_strControl])
	{
		ToolTip, % g_aaToolTipsMessages[s_strControl] ; display tooltip or remove tooltip if no message for this control
		if StrLen(g_aaToolTipsMessages[s_strControl])
			SetTimer, RemoveToolTip, 2500 ; will remove tooltip if not removed by mouse going hovering elsewhere (required if window become inactive)
	}

	return
}
;------------------------------------------------


;------------------------------------------------
RemoveToolTip:
;------------------------------------------------

SetTimer, RemoveToolTip, Off
ToolTip

return
;------------------------------------------------


;------------------------------------------------------------
WM_LBUTTONDBLCLK(wParam, lParam, msg, hwnd)
; To prevent double-click on image static controls to copy their path to the clipboard
; see http://www.autohotkey.com/board/topic/94962-doubleclick-on-gui-pictures-puts-their-path-in-your-clipboard/#entry682595
;------------------------------------------------------------
{
    WinGetClass class, ahk_id %hwnd%
    if (class = "Static") {
        if !A_Gui
            return 0  ; Just prevent Clipboard change.
        ; Send a WM_COMMAND message to the Gui to trigger the control's g-label.
        Gui +LastFound
        id := DllCall("GetDlgCtrlID", "ptr", hwnd) ; Requires AutoHotkey v1.1.
        static s_STN_DBLCLK := 1
        PostMessage 0x111, id | (s_STN_DBLCLK << 16), hwnd
        ; Return a value to prevent the default handling of this message.
        return 0
    }
}
;------------------------------------------------------------


;------------------------------------------------------------
AHK_NOTIFYICON(wParam, lParam) 
; Adapted from Lexikos http://www.autohotkey.com/board/topic/11250-mouseover-trayicon-triggering-an-event/#entry153388
; To popup menu when left click on the tray icon - See the OnMessage command in the init section
;------------------------------------------------------------
{
	; global g_blnClickOnTrayIcon
	
	if (lParam = 0x202) ; WM_LBUTTONUP
	{
		; g_blnClickOnTrayIcon := true
		Gosub, LaunchFromTrayIcon
		return 0
	}
} 
;------------------------------------------------------------


;------------------------------------------------------------
REPLY_QAPISRUNNING(wParam, lParam) 
;------------------------------------------------------------
{
	ToolTip, #### QAP is running ####
	Sleep, 2000
	return true
} 
;------------------------------------------------------------


;------------------------------------------------------------
RECEIVE_QAPMESSENGER(wParam, lParam) 
; Adapted from AHK documentation (https://autohotkey.com/docs/commands/OnMessage.htm)
;------------------------------------------------------------
{
	global g_strNewLocation
	global g_strTargetClass
	global g_strTargetWinId
	
	SetTargetWinInfo(false) ; as if keyboard because mouse position can go out of Explorer window where menu was called

	intStringAddress := NumGet(lParam + 2*A_PtrSize) ; Retrieves the CopyDataStruct's lpData member.
	strCopyOfData := StrGet(intStringAddress) ; Copy the string out of the structure.
	
	StringSplit, arrData, strCopyOfData, |
	
	if SubStr(arrData1, 1, 4) <> "Show" and SettingsUnsaved()
		return 0xFFFF
	
	if InStr(arrData1, "AddFolder") and (SubStr(arrData2, -1, 2) = ":""") ; -1 extracts the 2 last characters
		; exception for drive paths
		arrData2 := SubStr(arrData2, 1, StrLen(arrData2) - 1) . "\"

	if (arrData2 = "C:""")
		arrData2 := "C:\"
	
	if (arrData1 = "AddFolder")
	{
		g_strNewLocation := arrData2
		Gosub, AddThisFolderFromMsg
	}
	else if (arrData1 = "AddFile")
	{
		g_strNewLocation := arrData2
		Gosub, AddThisFileFromMsg
	}
	else if (arrData1 = "AddFolderXpress")
	{
		g_strNewLocation := arrData2
		Gosub, AddThisFolderFromMsgXpress
	}
	else if (arrData1 = "AddFileXpress")
	{
		g_strNewLocation := arrData2
		Gosub, AddThisFileFromMsgXpress
	}
	else if (arrData1 = "AddShortcut")
	{
		g_strNewLocation := arrData2
		Gosub, AddThisShortcutFromMsg
	}
	else if (arrData1 = "ShowMenuNavigate")

		Gosub, NavigateFromMsg

	else if (arrData1 = "ShowMenuLaunch")

		Gosub, LaunchFromMsg

	else if (arrData1 = "ShowMenuAlternative")

		Gosub, AlternativeHotkeyKeyboard

	else
		return 0

	return 1
}
;------------------------------------------------------------



;========================================================================================================================
; END OF ONMESSAGE_FUNCTIONS
;========================================================================================================================


;========================================================================================================================
!_700_CLASSES:
return
;========================================================================================================================


;-------------------------------------------------------------
class CommandLineParameters
;-------------------------------------------------------------
/*
class CommandLineParameters
	Methods
	- CommandLineParameters.__New(): collect the command line parameters in an internal object and concat strParams
	  - each param must begin with "/" and be separated by a space
	  - supported parameters: "/Settings:[file_path]" (must end with ".ini"), "/AdminSilent" and "/Working:[working_dir_path]"
	- CommandLineParameters.ConcatParams(I): returns a concatenated string of each parameter ready to be used when reloading
	- CommandLineParameters.SetParam(strKey, strValue): set the param strkey to the value strValue
	Instance variables
	- AA: simple array for each item (parameter) from the A_Args object (for internal usage)
	- strParams: list of command line parameters collected when launching this instance, separated by space, with quotes if required
*/
;-------------------------------------------------------------
{
	;---------------------------------------------------------
	__Call(function, parameters*)
	; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
	{
		funcRef := Func(funcName := this.__class "." function)
		if CheckParameters(funcRef, function, parameters*) ; if everything is good call the function, else return false
			return funcRef.(this, parameters*) ; everything is good
		else
			return
	}
	;---------------------------------------------------------

	; Instance variables
	AA := Object() ; associative array
	strParams := ""
	
	;---------------------------------------------------------
	__New()
	;---------------------------------------------------------
	{
		for intArg, strOneArg in A_Args ; A_Args requires v1.1.27+
		{
			if !StrLen(strOneArg)
				continue
			
			intColon := InStr(strOneArg, ":")
			if (intColon)
			{
				strParamKey := SubStr(strOneArg, 2, intColon - 2) ; excluding the starting slash and ending colon
				strParamValue := SubStr(strOneArg, intColon + 1)
				if (strParamKey = "Settings" and GetFileExtension(strParamValue) <> "ini")
					continue
				this.AA[strParamKey] := strParamValue
			}
			else
			{
				strParamKey := SubStr(strOneArg, 2)
				if (strParamKey = "Settings")
					continue
				this.AA[strParamKey] := "" ; keep it empty, check param with this.AA.HasKey(strOneArg)
			}
		}
		
		this.strParams := this.ConcatParams()
	}
	;---------------------------------------------------------
	
	;---------------------------------------------------------
	ConcatParams()
	;---------------------------------------------------------
	{
		strConcat := ""
		
		for strParamKey, strParamValue in this.AA
		{
			strQuotes := (InStr(strParamKey . strParamValue, " ") ? """" : "") ; enclose param with double-quotes only if it includes space
			strConcat .= strQuotes . "/" . strParamKey
			strConcat .= (StrLen(strParamValue) ? ":" . strParamValue : "") ; if value, separate with :
			strConcat .= strQuotes . " " ; ending quote and separate with next params with space
		}
		
		return SubStr(strConcat, 1, -1) ; remove last space
	}
	;---------------------------------------------------------
	
	;---------------------------------------------------------
	SetParam(strKey, strValue)
	;---------------------------------------------------------
	{
		this.AA[strKey] := strValue
		this.strParams := this.ConcatParams()
	}
	;---------------------------------------------------------
}
;-------------------------------------------------------------


;-------------------------------------------------------------
class JLicons
;-------------------------------------------------------------
/*
class JLicons
	Methods
	- JLicons.__New(strJLiconsFile): add array oIcons "name"->"file,index" to class JLicons for each JLicon.dll and to simple array saNames index of names
	- JLicons.GetName(intKey): return name of JLicons element of index intKey (was g_objJLiconsNames[intKey] before class)
	- JLicons.AddIcon(strKey, strFileIndex): add icon resource strFileIndex for JLicons element strKey (used to add DOpus and Total Commander icons)
	- JLicons.ProcessReplacements(strReplacements): removes previous JLicons replacements in oReplacements and do the current replacements in strReplacements
	Instance variables
	- strFileLocation: path and file name of the JLicons library file
	- AA: items of JLicons
	- saNames: simple array index of icon names (iconXYZ)
	- aaReplacementPrevious: associative array "strKey->strValue" (iconXYZ->file,index) backup for original "file,index" value for replaced icons
*/
;-------------------------------------------------------------
{
	;---------------------------------------------------------
	__Call(function, parameters*)
	; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
	{
		funcRef := Func(funcName := this.__class "." function)
		if CheckParameters(funcRef, function, parameters*) ; if everything is good call the function, else return false
			return funcRef.(this, parameters*) ; everything is good
		else
			return
	}
	;---------------------------------------------------------

	; Instance variables
	strFileLocation := ""
	AA := Object() ; associative array
	saNames := Object() ; was g_objJLiconsNames before class
	aaReplacementPrevious := Object() ; associative array, original values of replaced icons
	
	;---------------------------------------------------------
	__New(strJLiconsFile)
	;---------------------------------------------------------
	{
		this.strFileLocation := strJLiconsFile ; was g_strJLiconsFile
		
		strNames := "iconQAP|iconAbout|iconAddThisFolder|iconApplication|iconCDROM"
			. "|iconChangeFolder|iconClipboard|iconClose|iconControlPanel|iconCurrentFolders"
			. "|iconDesktop|iconDocuments|iconDonate|iconDownloads|iconDrives"
			. "|iconEditFavorite|iconExit|iconFavorites|iconFolder|iconFonts"
			. "|iconFTP|iconGroup|iconHelp|iconHistory|iconHotkeys"
			. "|iconAddFavorite|iconMyComputer|iconMyMusic|iconMyVideo|iconNetwork"
			. "|iconNetworkNeighborhood|iconNoContent|iconOptions|iconPictures|iconRAMDisk"
			. "|iconRecentFolders|iconRecycleBin|iconReload|iconRemovable|iconSettings"
			. "|iconSpecialFolders|iconSubmenu|iconSwitch|iconTemplates|iconTemporary"
			. "|iconTextDocument|iconUnknown|iconWinver|iconFolderLive|iconIcons"
			. "|iconPaste|iconPasteSpecial|iconNoIcon|iconUAClogo|iconQAPadmin"
			. "|iconQAPadminBeta|iconQAPadminDev|iconQAPbeta|iconQAPdev|iconQAPloading"
			. "|iconFolderLiveOpened"

		; EXAMPLE
		; JLicons.AA["iconAbout"] -> "file,2"
		; JLicons.saNames[2] -> "iconAbout"
		this.saNames := StrSplit(strNames, "|")
		Loop, Parse, strNames, |
			this.AddIcon(A_LoopField, strJLiconsFile . "," . A_Index)
	}
	;---------------------------------------------------------
	
	;---------------------------------------------------------
	AddIcon(strKey, strFileIndex) ; to add DOpus and Total Commander icons
	;---------------------------------------------------------
	{
		this.AA[strKey] := strFileIndex
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	GetName(intKey) ; was g_objJLiconsNames[intKey] before class
	;---------------------------------------------------------
	{
		return this.saNames[intKey]
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	ProcessReplacements(strReplacements)
	;---------------------------------------------------------
	{
		; restore previously replaced icons
		for strKey, strFileIndex in this.aaReplacementPrevious
			this.AA[strKey] := strFileIndex
		
		this.aaReplacementPrevious := Object() ; reset replacements
		
		loop, parse, strReplacements, |
			if StrLen(A_LoopField)
			{
				saIconReplacement := StrSplit(A_LoopField, "=")
				if This.AA.HasKey(saIconReplacement[2]) ; support replacement with another JLicons item
					saIconReplacement[2] := This.AA[saIconReplacement[2]]
				if this.AA.HasKey(saIconReplacement[1]) and InStr(saIconReplacement[2], ",")
				; this icon exists and replacement is "file,index" (includes a coma)
				{
					this.aaReplacementPrevious[saIconReplacement[1]] := this.AA[saIconReplacement[1]]
					this.AA[saIconReplacement[1]] := saIconReplacement[2]
				}
			}
	}
	;---------------------------------------------------------
}
;-------------------------------------------------------------


;-------------------------------------------------------------
class Triggers
/*
TODO
*/

/*
class Triggers

class Triggers.PopupHotkeys
	Methods
	- Triggers.PopupHotkeys.__New(): add an array of 4 QAP menu triggers objects of class PopupHotkey to I object array and enable these hotkeys
	- Triggers.PopupHotkeys.EnablePopupHotkeys(): enable popup menu hotkeys
	- BackupPopupHotkeys(): backup hotkeys (used when opening Options)
	- RestorePopupHotkeys(): restore backuped hotkeys (used when cancelling Options changes)
	Instance variables
	- SA: array of 4 PopupHotkey object items
	- aaPopupHotkeysByNames: associative array "name->object" as index of objects by PopupHotkey names
	
	class Triggers.PopupHotkeys.PopupHotkey
		Methods
		- Triggers.PopupHotkeys.PopupHotkey.__New(): create one PopupHotkeyQAP menu trigger object
		- Triggers.PopupHotkeys.PopupHotkey.EnableHotkey(): disable previous popup menu hotkey and enable the new hotkey
		Properties
		- Triggers.PopupHotkeys.PopupHotkey.P_strAhkHotkey: set a new _PopupHotkey value and update dependent text values strPopupHotkeyText and strPopupHotkeyTextShort
		Instance variables
		- strPopupHotkey: mouse (like "MButton") or keyboard (like "#W" for Win + W) hotkey trigger for a the QAP menu
		- strPopupHotkeyInternalName: one of the two mouse or two keyboard triggers internal names
		- strPopupHotkeyText: text of default hotkey trigger
		- strPopupHotkeyTextShort: short text of hotkey trigger
		- strPopupHotkeyDefault: default hotkey trigger
		- strPopupHotkeyPrevious: backup of hotkey trigger
		- strPopupHotkeyLocalizedName: displayed name of QAP menu trigger
		- strPopupHotkeyLocalizedDescription: description of QAP menu trigger

class Triggers.HotkeyParts
	Methods
	- HotkeyParts.__New(strHotkey): create an object and split parts in properties modifier, keyboard or mouse button
	- HotkeyParts.SplitParts(strHotkey): split strHotkey into parts strModifiers, strKey and strMouseButton
	- HotkeyParts.Hotkey2Text(blnShort := false): returns localized text for HotkeyParts, in long or short format
	Instance variables
	- strModifiers: modifier part of the hotkey (like "!" for Alt+Q or Alt+MButton)
	- strKey: keyboard part of hotkey (like "Q" for Alt+Q), empty if hotkey is a mouse button
	- strMouseButton: mouse button part of hotkey (like "MButton" for Alt+MButton), empty if hotkey is a keyboard key

class Triggers.MouseButtons
	Methods
	- Triggers.MouseButtons.__New(): add an array of objects of class Button to I object array
	- Triggers.MouseButtons.GetMouseButtonInternal4LocalizedName(strLocalizedName): returns corresponding internal name for localized name (not the short name)
	- Triggers.MouseButtons.GetMouseButtonLocalized4InternalName(strInternalName, blnShort): returns corresponding localized name for internal name
	- Triggers.MouseButtons.IsMouseButton(strInternalName): returns true if strInternalName is member of the buttons array
	- Triggers.MouseButtons.GetDropDownList(strDefault): returns the mouse buttons dropdown list with button strDefault as default button
	Instance variables
	- SA: array of MouseButton object items
	- oMouseButtonInternalNames: associative array "name->object" index of mouse buttons name
	- oMouseButtonLocalizedNames: associative array "localized name->object" index of mouse buttons localized name
	- strMouseButtonsDropDownList: mouse buttons dropdown
	
	class Triggers.MouseButtons.MouseButton
		Methods
		- MouseButtons.MouseButton.__New(): create an object for one mouse button
		Instance variables
		- strInternalName: internal name of button (like "MButton")
		- strLocalizedName: localized name of button (like "Middle Mouse Button")
		- strLocalizedNameShort: short localized name of button (like "Middle Mouse")
*/
;-------------------------------------------------------------
{
	;---------------------------------------------------------
	class PopupHotkeys
	; replaces g_arrPopupHotkeys and related arrays
	;---------------------------------------------------------
	{
		;---------------------------------------------------------
		__Call(function, parameters*)
		; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
		{
			funcRef := Func(funcName := this.__class "." function)
			if CheckParameters(funcRef, function, parameters*) ; if everything is good call the function, else return false
				return funcRef.(this, parameters*) ; everything is good
			else
				return
		}
		;---------------------------------------------------------

		; Instance variables
		aaPopupHotkeysByNames := Object() ; associative array
		
		;-----------------------------------------------------
		__New()
		;-----------------------------------------------------
		{
			SA := Object() ; simple array
			saPopupHotkeyInternalNames := Object() ; simple array
			
			saPopupHotkeyInternalNames := ["NavigateOrLaunchHotkeyMouse", "NavigateOrLaunchHotkeyKeyboard", "AlternativeHotkeyMouse", "AlternativeHotkeyKeyboard"]
			saPopupHotkeyDefaults := StrSplit("MButton|#W|+MButton|+#W", "|")
			saOptionsPopupHotkeyLocalizedNames := StrSplit(o_L["OptionsPopupHotkeyTitles"], "|")
			saOptionsPopupHotkeyLocalizedDescriptions := StrSplit(o_L["OptionsPopupHotkeyTitlesSub"], "|")
			
			for intThisIndex, strThisPopupHotkeyInternalName in saPopupHotkeyInternalNames
			{
				; Init Settings class items for Triggers (must be before o_PopupHotkeys)
				strThisPopupHotkey := o_Settings.ReadIniOption("MenuPopup", "str" . strThisPopupHotkeyInternalName, strThisPopupHotkeyInternalName, saPopupHotkeyDefaults[A_Index], "PopupHotkeys"
					, "f_lblChangeShortcut" . A_Index . "|f_lblHotkeyText" . A_Index . "|f_btnChangeShortcut" . A_Index . "|f_lnkChangeShortcut" . A_Index)
				oPopupHotkey := new this.PopupHotkey(strThisPopupHotkeyInternalName, strThisPopupHotkey, saPopupHotkeyDefaults[A_Index]
					, saOptionsPopupHotkeyLocalizedNames[A_Index], saOptionsPopupHotkeyLocalizedDescriptions[A_Index])
				this.SA[A_Index] := oPopupHotkey
				this.aaPopupHotkeysByNames[strThisPopupHotkeyInternalName] := oPopupHotkey
			}
			this.EnablePopupHotkeys()
		}
		;-----------------------------------------------------
		
		;-----------------------------------------------------
		EnablePopupHotkeys()
		;-----------------------------------------------------
		{
			; Two hotkey variants for A_ThisHotkey: if CanNavigate or if CanLaunch, else A_ThisHotkey does nothing
			; "If more than one variant of a hotkey is eligible to fire, only the one created earliest will fire."
			Hotkey, If, CanNavigate(A_ThisHotkey)
				; First, if we can, navigate with QAP hotkeys (1 NavigateOrLaunchHotkeyMouse and 2 NavigateOrLaunchHotkeyKeyboard) 
				this.SA[1].EnableHotkey("Navigate", "Mouse")
				this.SA[2].EnableHotkey("Navigate", "Keyboard")
			Hotkey, If
			Hotkey, If, CanLaunch(A_ThisHotkey)
				; Second, if we can't navigate but can launch, launch with QAP hotkeys (1 NavigateOrLaunchHotkeyMouse and 2 NavigateOrLaunchHotkeyKeyboard) 
				this.SA[1].EnableHotkey("Launch", "Mouse")
				this.SA[2].EnableHotkey("Launch", "Keyboard")
			Hotkey, If
			; Open the Alternative menu with the Alternative hotkeys (3 AlternativeHotkeyMouse and 4 AlternativeHotkeyKeyboard)
			this.SA[3].EnableHotkey("Alternative", "Mouse")
			this.SA[4].EnableHotkey("Alternative", "Keyboard")
		}
		;-----------------------------------------------------
		
		;-----------------------------------------------------
		BackupPopupHotkeys()
		;-----------------------------------------------------
		{
			for intKey, oOnePopupHotkey in this.SA
				oOnePopupHotkey.AA.strPopupHotkeyPrevious := oOnePopupHotkey.P_strAhkHotkey
		}
		;-----------------------------------------------------
		
		;-----------------------------------------------------
		RestorePopupHotkeys()
		;-----------------------------------------------------
		{
			for intKey, oOnePopupHotkey in this.SA
				oOnePopupHotkey.P_strAhkHotkey := oOnePopupHotkey.AA.strPopupHotkeyPrevious
		}
		;-----------------------------------------------------
		
		;-----------------------------------------------------
		class PopupHotkey
		;-----------------------------------------------------
		{
			;---------------------------------------------------------
			__Call(function, parameters*)
			; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
			{
				funcRef := Func(funcName := this.__class "." function)
				if CheckParameters(funcRef, function, parameters*) ; if everything is good call the function, else return false
					return funcRef.(this, parameters*) ; everything is good
				else
					return
			}
			;---------------------------------------------------------

			; Instance variables
			AA := Object()
			
			;-------------------------------------------------
			__New(strThisInternalName, strThisPopupHotkey, strThisPopupHotkeyDefault, strThisLocalizedName, strThisLocalizedDescription)
			;-------------------------------------------------
			{
				this.AA.strPopupHotkeyInternalName := strThisInternalName
				this.P_strAhkHotkey := strThisPopupHotkey
				
				this.AA.strPopupHotkeyDefault := strThisPopupHotkeyDefault
				this.AA.strPopupHotkeyPrevious := ""
				this.AA.strPopupHotkeyLocalizedName := strThisLocalizedName
				this.AA.strPopupHotkeyLocalizedDescription := strThisLocalizedDescription
			}
			;-------------------------------------------------
			
			;-------------------------------------------------
			P_strAhkHotkey[]
			;-------------------------------------------------
			{
				Get
				{
					return this._strAhkHotkey ; Lexikos: "One common convention is to use a single underscore for internal members, as in _propertyname. But it's just a convention."
				}
				
				Set
				{
					oHotkeyParts := new Triggers.HotkeyParts(value)
					this.AA.strPopupHotkeyText := oHotkeyParts.Hotkey2Text()
					this.AA.strPopupHotkeyTextShort := oHotkeyParts.Hotkey2Text(true)
					
					return this._strAhkHotkey := value
				}
			}
			;-------------------------------------------------
			
			;-------------------------------------------------
			EnableHotkey(strActionType, strTriggerType)
			;-------------------------------------------------
			{
				strLabel := strActionType . "Hotkey" . strTriggerType
				if HasShortcut(this.AA.strPopupHotkeyPrevious)
					Hotkey, % this.AA.strPopupHotkeyPrevious, , Off UseErrorLevel ; do nothing if error (probably because default mouse trigger not supported by system)
				if HasShortcut(this.P_strAhkHotkey)
					Hotkey, % this.P_strAhkHotkey, %strLabel%, On UseErrorLevel
				if (ErrorLevel)
					Oops(o_L["DialogInvalidHotkey"], this.AA.strPopupHotkeyText, this.AA.strPopupHotkeyLocalizedName)
			}
			;-------------------------------------------------
		}
		;-----------------------------------------------------
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	class HotkeyParts
	; replaces SplitHotkey(strHotkey, ByRef strModifiers, ByRef strKey, ByRef strMouseButton)
	;---------------------------------------------------------
	{
		;---------------------------------------------------------
		__Call(function, parameters*)
		; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
		{
			funcRef := Func(funcName := this.__class "." function)
			if CheckParameters(funcRef, function, parameters*) ; if everything is good call the function, else return false
				return funcRef.(this, parameters*) ; everything is good
			else
				return
		}
		;---------------------------------------------------------

		; Instance variables
		strModifiers := ""
		strKey := ""
		strMouseButton := ""
		
		;-----------------------------------------------------
		__New(strHotkey)
		;-----------------------------------------------------
		{
			this.SplitParts(strHotkey)
		}
		;-----------------------------------------------------
		
		;-----------------------------------------------------
		SplitParts(strHotkey)
		;-----------------------------------------------------
		{
			if (strHotkey = "None") ; do not compare with o_L["DialogNone"] because it is translated
			{
				this.strModifiers := ""
				this.strKey := ""
				this.strMouseButton := "None" ; do not use o_L["DialogNone"] because it is translated
			}
			else 
			{
				intPosFirstNotModifier := 0
				loop, Parse, strHotkey
					if InStr("^!+#<>", A_LoopField)
						intPosFirstNotModifier++
					else
						break ; got first character not a modifier
				str := SubStr(strHotkey, 1, intPosFirstNotModifier)
				this.strModifiers := str
				str := SubStr(strHotkey, intPosFirstNotModifier + 1)
				this.strKey := str
				
				if o_MouseButtons.IsMouseButton(this.strKey) ; we have a mouse button
				{
					this.strMouseButton := this.strKey
					this.strKey := ""
				}
				else ; we have a key
					this.strMouseButton := ""
			}
		}
		;-----------------------------------------------------
		
		;-----------------------------------------------------
		Hotkey2Text(blnShort := false)
		; was Hotkey2Text and HotkeySections2Text
		;-----------------------------------------------------
		{
			if StrLen(this.strKey) ; localize system key names
			{
				strSystemKeyNames := "sc15D|AppsKey|Space|Enter|Escape"
				saLocalizedKeyNames := StrSplit(o_L["DialogMenuKey"] . "|" . o_L["DialogMenuKey"] . "|" . o_L["ToolTipSnippetWaitSpace"]
					. "|" . o_L["ToolTipSnippetWaitEnter"] . "|" . o_L["ToolTipSnippetWaitEscape"], "|")
				Loop, Parse, strSystemKeyNames, |
					if (this.strKey = A_LoopField)
						this.strKey := saLocalizedKeyNames[A_Index]
			}
			
			if (this.strMouseButton = "None") ; do not compare with o_L["DialogNone"] because it is translated
				or !StrLen(this.strModifiers . this.strMouseButton . this.strKey) ; if all parameters are empty
				str := o_L["DialogNone"] ; use o_L["DialogNone"] because this is displayed
			else
			{
				str := ""
				loop, parse, % this.strModifiers
				{
					if (A_LoopField = "!")
						str := str . (InStr(this.strModifiers, "<!") ? "<" : InStr(this.strModifiers, ">!") ? ">" : "") . (blnShort ? o_L["DialogAltShort"] : o_L["DialogAlt"]) . "+"
					if (A_LoopField = "^")
						str := str . (InStr(this.strModifiers, "<^") ? "<" : InStr(this.strModifiers, ">^") ? ">" : "") . (blnShort ? o_L["DialogCtrlShort"] : o_L["DialogCtrl"]) . "+"
					if (A_LoopField = "+")
						str := str . (InStr(this.strModifiers, "<+") ? "<" : InStr(this.strModifiers, ">+") ? ">" : "") . (blnShort ? o_L["DialogShiftShort"] : o_L["DialogShift"]) . "+"
					if (A_LoopField = "#")
						str := str . (InStr(this.strModifiers, "<#") ? "<" : InStr(this.strModifiers, ">#") ? ">" : "") . (blnShort ? o_L["DialogWinShort"] : o_L["DialogWin"]) . "+"
				}
				if StrLen(this.strMouseButton)
					str := str . o_MouseButtons.GetMouseButtonLocalized4InternalName(this.strMouseButton, blnShort)
					
				if StrLen(this.strKey)
					str := str . StrUpper(this.strKey)
			}
			
			return str
		}
		;-----------------------------------------------------
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	class MouseButtons
	;---------------------------------------------------------
	{
		;---------------------------------------------------------
		__Call(function, parameters*)
		; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
		{
			funcRef := Func(funcName := this.__class "." function)
			if CheckParameters(funcRef, function, parameters*) ; if everything is good call the function, else return false
				return funcRef.(this, parameters*) ; everything is good
			else
				return
		}
		;---------------------------------------------------------

		; Instance variables
		SA := Object()
		aaMouseButtonInternalNames := Object() ; associative array "name->index"
		aaMouseButtonLocalizedNames := Object() ; associative array of "localized name->index"
		strMouseButtonsDropDownList := ""
		
		;-----------------------------------------------------
		__New()
		;-----------------------------------------------------
		{
			saMouseButtonsInternalNames := StrSplit("None|LButton|MButton|RButton|XButton1|XButton2|WheelUp|WheelDown|WheelLeft|WheelRight", "|")
			this.strMouseButtonsDropDownList := o_L["DialogNone"] . "|" . o_L["DialogMouseButtonsText"] ; default item not identified
			saMouseButtonsLocalizedNames := StrSplit(this.strMouseButtonsDropDownList, "|")
			saMouseButtonsLocalizedNamesShort := StrSplit(o_L["DialogNone"] . "|" . o_L["DialogMouseButtonsTextShort"], "|")

			loop, % saMouseButtonsInternalNames.Length()
			{
				this.aaMouseButtonInternalNames[saMouseButtonsInternalNames[A_Index]] := A_Index
				this.aaMouseButtonLocalizedNames[saMouseButtonsLocalizedNames[A_Index]] := A_Index
				oMouseButton := new this.MouseButton(saMouseButtonsInternalNames[A_Index], saMouseButtonsLocalizedNames[A_Index], saMouseButtonsLocalizedNamesShort[A_Index])
				this.SA[A_Index] := oMouseButton
			}
		}
		;-----------------------------------------------------

		;-----------------------------------------------------
		GetMouseButtonInternal4LocalizedName(strLocalizedName)
		; strLocalizedName must be the normal name, not the short name
		;-----------------------------------------------------
		{
			return this.SA[this.aaMouseButtonLocalizedNames[strLocalizedName]].strInternalName
		}
		;-----------------------------------------------------

		;-----------------------------------------------------
		GetMouseButtonLocalized4InternalName(strInternalName, blnShort)
		; keep blnShort required to avoid error - do not use short version in mouse buttons dropdown list
		;-----------------------------------------------------
		{
			return (blnShort ? this.SA[this.aaMouseButtonInternalNames[strInternalName]].strLocalizedNameShort
				: this.SA[this.aaMouseButtonInternalNames[strInternalName]].strLocalizedName)
		}
		;-----------------------------------------------------

		;-----------------------------------------------------
		IsMouseButton(strInternalName)
		;-----------------------------------------------------
		{
			return this.aaMouseButtonInternalNames.HasKey(strInternalName)
		}
		;-----------------------------------------------------

		;-----------------------------------------------------
		GetDropDownList(strDefault) ; strDefault can be internal or localized (if "None")
		;-----------------------------------------------------
		{
			if (strDefault = o_L["DialogNone"]) ; here strDefault contains the localized text
				return StrReplace(this.strMouseButtonsDropDownList, o_L["DialogNone"] . "|", o_L["DialogNone"] . "||") ; use o_L["DialogNone"] because this is localized
			else if StrLen(strDefault) ; here strDefault contains the mouse internal name (not localized text)
				return StrReplace(this.strMouseButtonsDropDownList, this.GetMouseButtonLocalized4InternalName(strDefault, false) . "|", this.GetMouseButtonLocalized4InternalName(strDefault, false) . "||")
			else
				return this.strMouseButtonsDropDownList
		}
		;-----------------------------------------------------

		;-----------------------------------------------------
		class MouseButton
		;-----------------------------------------------------
		{
			;---------------------------------------------------------
			__Call(function, parameters*)
			; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
			{
				funcRef := Func(funcName := this.__class "." function)
				if CheckParameters(funcRef, function, parameters*) ; if everything is good call the function, else return false
					return funcRef.(this, parameters*) ; everything is good
				else
					return
			}
			;---------------------------------------------------------

			; Instance variables
			strInternalName := ""
			strLocalizedName := ""
			strLocalizedNameShort := ""
			
			;-------------------------------------------------
			__New(strThisInternalName, strThisLocalizedName, strThisLocalizedNameShort)
			;-------------------------------------------------
			{
				this.strInternalName := strThisInternalName
				this.strLocalizedName := strThisLocalizedName
				this.strLocalizedNameShort := strThisLocalizedNameShort
			}
			;-------------------------------------------------
		}
		;-----------------------------------------------------
	}
	;---------------------------------------------------------
}
;-------------------------------------------------------------


;-------------------------------------------------------------
class FileManagers
/*
TODO
*/

/*
*/
;-------------------------------------------------------------
{
	;---------------------------------------------------------
	__Call(function, parameters*)
	; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
	{
		funcRef := Func(funcName := this.__class "." function)
		if CheckParameters(funcRef, function, parameters*) ; if everything is good call the function, else return false
			return funcRef.(this, parameters*) ; everything is good
		else
			return
	}
	;---------------------------------------------------------
	
	SA := Object() ; simple array
	
	;---------------------------------------------------------
	__New()
	;---------------------------------------------------------
	{
		saActiveFileManagerSystemNames := StrSplit("WindowsExplorer|DirectoryOpus|TotalCommander|QAPconnect", "|")
		saActiveFileManagerDisplayNames := StrSplit("Windows Explorer|Directory Opus|Total Commander|QAPconnect", "|")
		
		this.SA[1] := new this.Explorer(saActiveFileManagerSystemNames[1], saActiveFileManagerDisplayNames[1])
		this.SA[2] := new this.DirectoryOpus(saActiveFileManagerSystemNames[2], saActiveFileManagerDisplayNames[2])
		this.SA[3] := new this.TotalCommander(saActiveFileManagerSystemNames[3], saActiveFileManagerDisplayNames[3])
		this.SA[4] := new this.QAPConnect(saActiveFileManagerSystemNames[4], saActiveFileManagerDisplayNames[4])
			
		intActiveFileManager := o_Settings.ReadIniOption("FileManagers", "intActiveFileManager", "ActiveFileManager", "", "FileManagers"
			, "f_radActiveFileManager1|f_radActiveFileManager2|f_radActiveFileManager3|f_radActiveFileManager4") ; if not exist returns "ERROR"
		if (intActiveFileManager = "ERROR") ; no selection
			intActiveFileManager := this.DetectFileManager() ; returns 2 DirectoryOpus or 3 TotalCommander if detected, else 1 WindowsExplorer
		this.P_intActiveFileManager := intActiveFileManager ; assigning to property checks if blnFileManagerValid

		o_Settings.ReadIniOption("FileManagers", "blnAlwaysNavigate", "FileManagerAlwaysNavigate", 0
			, "FileManagers", "f_lblFileManagersIntro|f_lblFileManagerNavigateTitle|f_lblFileManagerNavigate|f_radFileManagerNavigateCurrent|f_radFileManagerNavigateNew|f_lblradActiveFileManager") ; default false
		; in main script, use o_FileManagers.P_intActiveFileManager instead of o_Settings.FileManagers.intActiveFileManager.IniValue
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	CopyClassStructure()
	;---------------------------------------------------------
	{
		saActiveFileManagerSystemNames := StrSplit("WindowsExplorer|DirectoryOpus|TotalCommander|QAPconnect", "|")
		
		###_D("", 1, 1) ; to capture instance values
		###_O("o_FileManagers", this) ; to capture instance values
		###_O("o_FileManagers.SA (strFileManagerSystemName)", this.SA, "strFileManagerSystemName") ; to capture instance values
		loop, % saActiveFileManagerSystemNames.Length()
			###_O("o_FileManagers.SA[" . A_Index . "] (" . this.SA[A_Index].AA.strFileManagerSystemName . ")", this.SA[A_Index]) ; to capture instance values
		###_D(Clipboard, 1, 1) ; to capture instance values
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	P_intActiveFileManager[]
	; default 1 for "WindowsExplorer"
	;---------------------------------------------------------
	{
		Get
		{
			return this._intActiveFileManager ; Lexikos: "One common convention is to use a single underscore for internal members, as in _propertyname. But it's just a convention."
		}
		
		Set
		{
			if (this.SA[value].AA.blnFileManagerValid)
				this._intActiveFileManager := value
			else
			{
				if (value = 4) ; QAPconnect
					Oops(o_L["OopsWrongThirdPartyPathQAPconnect"], this.SA[4].AA.strQAPconnectFileManager, this.SA[4].AA.strFileManagerPath, "QAPconnect.ini", L(o_L["MenuEditIniFile"], "QAPconnect.ini"), o_L["OptionsThirdParty"])
				else ; 2 DirectoryOpus or 3 TotalCommander
					Oops(o_L["OopsWrongThirdPartyPath"], this.SA[value].AA.strDisplayName, this.SA[value].AA.strFileManagerPath, o_L["OptionsThirdParty"])
				this._intActiveFileManager := 1 ; fall back to Window Explorer
			}
			return this._intActiveFileManager
		}
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	DetectFileManager()
	;---------------------------------------------------------
	{
		intSelected := 1
		loop, 2
		{
			intFileManager := A_Index + 1 ; 2 DirectoryOpus or 3 TotalCommander
			if (this.SA[intFileManager].AA.blnFileManagerValid)
			{
				MsgBox, 52, %g_strAppNameText%, % L(o_L["DialogThirdPartyDetected"], g_strAppNameText, this.SA[intFileManager].AA.strDisplayName)
				IfMsgBox, Yes
				{
					intSelected := intFileManager
					break
				}
			}
		}
		IniWrite, %intSelected%, % o_Settings.strIniFile, Global, ActiveFileManager

		return %intSelected% ; by default WindowsExplorer
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	class FileManager
	;---------------------------------------------------------
	{
		AA := Object() ; associative array
		
		;---------------------------------------------------------
		__Call(function, parameters*)
		; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
		{
			funcRef := Func(funcName := this.__class "." function)
			if CheckParameters(funcRef, function, parameters*) ; if everything is good call the function, else return false
				return funcRef.(this, parameters*) ; everything is good
			else
				return
		}
		;---------------------------------------------------------

		;-----------------------------------------------------
		__New(strThisSystemName, strThisDisplayName)
		;-----------------------------------------------------
		{
			this.AA.strFileManagerSystemName := strThisSystemName
			this.AA.strDisplayName := strThisDisplayName
		}
		;-----------------------------------------------------
	}
	;---------------------------------------------------------
	
	;---------------------------------------------------------
	class Explorer extends FileManagers.FileManager
	;---------------------------------------------------------
	{
		;-----------------------------------------------------
		__Call(function, parameters*)
		; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
		{
			funcRef := Func(funcName := this.__class "." function)
			if CheckParameters(funcRef, function, parameters*) ; if everything is good call the function, else return false
				return funcRef.(this, parameters*) ; everything is good
			else
				return
		}
		;-----------------------------------------------------
		
		;-----------------------------------------------------
		__New(strThisSystemName, strThisDisplayName)
		;-----------------------------------------------------
		{
			base.__New(strThisSystemName, strThisDisplayName)
			
			this.AA.blnOpenFavoritesOnActiveMonitor := o_Settings.ReadIniOption("FileManagers", "blnExplorerOpenFavoritesOnActiveMonitor"
				, "OpenFavoritesOnActiveMonitor", 0, "FileManagers", "f_lnkFileManagerHelp|f_lblFileManagerDetail|f_blnOpenFavoritesOnActiveMonitor")
			this.AA.blnFileManagerValid := true
		}
		;-----------------------------------------------------
	}
	
	;---------------------------------------------------------
	class DirectoryOpus extends FileManagers.FileManager
	;---------------------------------------------------------
	{
		;-----------------------------------------------------
		__Call(function, parameters*)
		; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
		{
			funcRef := Func(funcName := this.__class "." function)
			if CheckParameters(funcRef, function, parameters*) ; if everything is good call the function, else return false
				return funcRef.(this, parameters*) ; everything is good
			else
				return
		}
		;-----------------------------------------------------
		
		;-----------------------------------------------------
		__New(strThisSystemName, strThisDisplayName)
		;-----------------------------------------------------
		{
			base.__New(strThisSystemName, strThisDisplayName)
			
			strPath := o_Settings.ReadIniOption("FileManagers", "strDirectoryOpusPath", "DirectoryOpusPath", " ", "FileManagers", "f_lblFileManagerPrompt|f_strFileManagerPath")
			if !StrLen(strPath)
				strPath := A_ProgramFiles . "\GPSoftware\Directory Opus\dopus.exe"
			if !FileExist(strPath)
				strPath := "dopus.exe"
			this.AA.strFileManagerPath := strPath
			this.AA.strFileManagerPathExpanded := strPath ; will be expanded by FileExistInPath()
			this.AA.blnFileManagerValid := StrLen(this.AA.strFileManagerPathExpanded)
				and FileExistInPath(this.AA.strFileManagerPathExpanded) ; return strFileManagerPathExpanded expanded and searched in PATH
				
			if (this.AA.blnFileManagerValid)
			{
				this.AA.strDirectoryOpusRtPath := StrReplace(this.AA.strFileManagerPath, "\dopus.exe", "\dopusrt.exe")
				
				this.AA.blnFileManagerUseTabs := o_Settings.ReadIniOption("FileManagers", "blnDirectoryOpusUseTabs", "DirectoryOpusUseTabs", 1, "FileManagers", "f_blnFileManagerUseTabs")
				this.AA.strDirectoryOpusCustomNewTabOrWindow := o_Settings.ReadIniOption("FileManagers", "strDirectoryOpusCustomNewTabOrWindow", "DirectoryOpusNewTabOrWindow", "", "FileManagers", "")
				
				if (this.AA.strDirectoryOpusCustomNewTabOrWindow <> "ERROR")
					; allow user to customize (other than "NEW" or "NEWTAB")
					this.AA.strNewTabOrWindow := this.AA.strDirectoryOpusCustomNewTabOrWindow
				else if (this.AA.blnFileManagerUseTabs)
					this.AA.strNewTabOrWindow := "NEWTAB" ; open new folder in a new lister tab
				else
					this.AA.strNewTabOrWindow := "NEW" ; open new folder in a new DOpus lister (instance)
				
				this.AA.blnFileManagerDirectoryOpusShowLayouts := o_Settings.ReadIniOption("FileManagers", "blnDirectoryOpusShowLayouts", "FileManagerDOpusShowLayouts", 1, "FileManagers"
					, "f_blnFileManagerDirectoryOpusShowLayouts")
				
				o_JLicons.AddIcon("DirectoryOpus", this.AA.strFileManagerPathExpanded . ",1")
			}
		}
		
		;-----------------------------------------------------
		RunDOpusRt(strCommand, strLocation := "", strParam := "")
		; put A_Space at the beginning of strParam if required - some param (like ",paths") must have no space 
		;-----------------------------------------------------
		{
			if (strCommand = "/info")
			{
				Process, Exist, dopus.exe
				; abort if DOpus.exe is not running
				if !(ErrorLevel)
					return
			}
			
			if FileExist(this.AA.strDirectoryOpusRtPath) ; for safety only
				Run, % """" . this.AA.strDirectoryOpusRtPath . """ " . strCommand . " """ . strLocation . """" . strParam
		}
		;-----------------------------------------------------

		;-----------------------------------------------------
		DirectoryOpusFavoritesFileExist()
		;-----------------------------------------------------
		{
			this.AA.strDirectoryOpusFavoritesFile := EnvVars("%APPDATA%\GPSoftware\Directory Opus\ConfigFiles\favorites.ofv")
			return FileExist(this.AA.strDirectoryOpusFavoritesFile)
		}
		;-----------------------------------------------------

		;-----------------------------------------------------
		DirectoryOpusLayoutsFileExist()
		;-----------------------------------------------------
		{
			this.AA.strDirectoryOpusLayoutsFile := EnvVars("%APPDATA%\GPSoftware\Directory Opus\Layouts\order.xml")
			return FileExist(this.AA.strDirectoryOpusLayoutsFile)
		}
		;-----------------------------------------------------

	}
	;---------------------------------------------------------
	
	;---------------------------------------------------------
	class TotalCommander extends FileManagers.FileManager
	;---------------------------------------------------------
	{
		;-----------------------------------------------------
		__Call(function, parameters*)
		; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
		{
			funcRef := Func(funcName := this.__class "." function)
			if CheckParameters(funcRef, function, parameters*) ; if everything is good call the function, else return false
				return funcRef.(this, parameters*) ; everything is good
			else
				return
		}
		;-----------------------------------------------------
		
		;-----------------------------------------------------
		__New(strThisSystemName, strThisDisplayName)
		;-----------------------------------------------------
		{
			base.__New(strThisSystemName, strThisDisplayName)
			
			strPath := o_Settings.ReadIniOption("FileManagers", "strTotalCommanderPath", "TotalCommanderPath", " ", "FileManagers", "")
			if !StrLen(strPath)
			{
				RegRead, strPath, HKEY_CURRENT_USER, Software\Ghisler\Total Commander\, InstallDir
				If !StrLen(strPath)
					RegRead, strPath, HKEY_LOCAL_MACHINE, Software\Ghisler\Total Commander\, InstallDir
				if FileExist(strPath . "\TOTALCMD64.EXE")
					strPath := strPath . "\TOTALCMD64.EXE"
				else
					strPath := strPath . "\TOTALCMD.EXE"
			}
			this.AA.strFileManagerPath := strPath
			this.AA.strFileManagerPathExpanded := strPath ; will be expanded by FileExistInPath()
			this.AA.blnFileManagerValid := StrLen(this.AA.strFileManagerPathExpanded)
				and FileExistInPath(this.AA.strFileManagerPathExpanded) ; return strFileManagerPathExpanded expanded and searched in PATH
				
			if (this.AA.blnFileManagerValid)
			{
				strIniFile := o_Settings.ReadIniOption("FileManagers", "strTotalCommanderWinCmd", "TotalCommanderWinCmd", " ", "FileManagers"
					, "f_lblTotalCommanderWinCmdPrompt|f_strTotalCommanderWinCmd|f_btnTotalCommanderWinCmd")
				If !StrLen(strIniFile)
					RegRead, strIniFile, HKEY_CURRENT_USER, Software\Ghisler\Total Commander\, IniFileName
				If !StrLen(strIniFile)
					RegRead, strIniFile, HKEY_LOCAL_MACHINE, Software\Ghisler\Total Commander\, IniFileName
				this.AA.strTCIniFile := strIniFile
				this.AA.strTCIniFileExpanded := EnvVars(this.AA.strTCIniFile)
				this.AA.blnFileManagerValid := StrLen(this.AA.strTCIniFileExpanded) and FileExist(this.AA.strTCIniFileExpanded) ; TotalCommander settings file exists
				
				this.AA.blnFileManagerUseTabs := o_Settings.ReadIniOption("FileManagers", "blnTotalCommanderUseTabs", "TotalCommanderUseTabs", 1, "FileManagers", "")
				this.AA.strTotalCommanderCustomNewTabOrWindow := o_Settings.ReadIniOption("FileManagers", "strTotalCommanderCustomNewTabOrWindow", "TotalCommanderNewTabOrWindow", "", "FileManagers", "")
				
				if (this.AA.strTotalCommanderCustomNewTabOrWindow <> "ERROR")
					; allow user to customize (other than "/O /T" or "/N")
					this.AA.strNewTabOrWindow := this.AA.strTotalCommanderCustomNewTabOrWindow
				if (this.AA.blnFileManagerUseTabs)
					this.AA.strNewTabOrWindow := "/O /T" ; open new folder in a new tab
				else
					this.AA.strNewTabOrWindow := "/N" ; open new folder in a new window (TC instance)
				
				; was BuildTotalCommanderHotlistPrepare:
				if StrLen(this.AA.strTCIniFileExpanded)
				{
					strAlternativeWinCmdIniFile := o_Settings.ReadIniValue("AlternateUserIni", " ", "Configuration", this.AA.strTCIniFileExpanded) ; empty by default
					if !StrLen(strAlternativeWinCmdIniFile)
						;  only wincmd.ini can redirect, redirection is not recursive (https://ghisler.ch/board/viewtopic.php?p=315939#315939)
						strAlternativeWinCmdIniFile := o_Settings.ReadIniValue("RedirectSection", " ", "DirMenu", this.AA.strTCIniFileExpanded) ; empty by default
					if StrLen(strAlternativeWinCmdIniFile)
					{
						SplitPath, % this.AA.strTCIniFileExpanded, , strTCDir
						this.AA.strTCIniFileExpanded := PathCombine(strTCDir, EnvVars(strAlternativeWinCmdIniFile))
					}
				}
				
				o_JLicons.AddIcon("TotalCommander", this.AA.strFileManagerPathExpanded . ",1")
			}
		}
		;-----------------------------------------------------
		
		;-----------------------------------------------------
		TotalCommanderWinCmdIniFileExist()
		;-----------------------------------------------------
		{
			return StrLen(this.AA.strTCIniFileExpanded) and FileExist(this.AA.strTCIniFileExpanded) ; TotalCommander settings file exists
		}
		;-----------------------------------------------------
		
	}
	;---------------------------------------------------------
	
	;---------------------------------------------------------
	class QAPconnect extends FileManagers.FileManager
	;---------------------------------------------------------
	{
		;-----------------------------------------------------
		__Call(function, parameters*)
		; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
		{
			funcRef := Func(funcName := this.__class "." function)
			if CheckParameters(funcRef, function, parameters*) ; if everything is good call the function, else return false
				return funcRef.(this, parameters*) ; everything is good
			else
				return
		}
		;-----------------------------------------------------
		
		;-----------------------------------------------------
		__New(strThisSystemName, strThisDisplayName)
		;-----------------------------------------------------
		{
			base.__New(strThisSystemName, strThisDisplayName)
			
			strQAPconnectFileManager := o_Settings.ReadIniOption("FileManagers", "strQAPconnectFileManager", "QAPconnectFileManager", " ", "FileManagers"
				, "f_drpQAPconnectFileManager|f_btnFileManagerPath|f_btnQAPconnectEdit|f_btnQAPconnectRefresh")
			this.AA.strQAPconnectFileManager := strQAPconnectFileManager
			this.AA.strQAPconnectIniPath := A_WorkingDir . "\QAPconnect.ini"
			/* QAPconnect.ini sample:
			[EF Commander Free (v9.50)]
			; http://www.softpedia.com/get/File-managers/EF-Commander-Free.shtml
			AppPath=..\EF Commander Free\EFCommanderFreePortable.exe
			CommandLine=/O /A=%Path%
			NewTabSwitch=
			CompanionPath=EFCWT.EXE
			NeverQuotes=
			*/
			strPath := o_Settings.ReadIniValue("AppPath", " ", strQAPconnectFileManager, this.AA.strQAPconnectIniPath)
			this.AA.strFileManagerPath := strPath
			this.AA.strFileManagerPathExpanded := strPath ; will be expanded by FileExistInPath()
			this.AA.blnFileManagerValid := StrLen(this.AA.strFileManagerPathExpanded)
				and FileExistInPath(this.AA.strFileManagerPathExpanded) ; return strFileManagerPathExpanded expanded and searched in PATH
				
			if (this.AA.blnFileManagerValid)
			{
				SplitPath, strPath, strFilename
				this.AA.strQAPconnectAppFilename := strFilename ; ahk_exe worked with filename only, not with full exe path
				this.AA.strQAPconnectWindowID := "ahk_exe " . strFilename ; ahk_exe worked with filename only, not with full exe path
				
				strCommandLine := o_Settings.ReadIniValue("CommandLine", " ", strQAPconnectFileManager, this.AA.strQAPconnectIniPath)
				this.AA.strQAPconnectCommandLine := strCommandLine
				
				strNewTabSwitch := o_Settings.ReadIniValue("NewTabSwitch", " ", strQAPconnectFileManager, this.AA.strQAPconnectIniPath)
				this.AA.strQAPconnectNewTabSwitch := strNewTabSwitch
				
				strCompanionPath := o_Settings.ReadIniValue("CompanionPath", " ", strQAPconnectFileManager, this.AA.strQAPconnectIniPath)
				if StrLen(strCompanionPath)
					FileExistInPath(strCompanionPath) ; return strQAPconnectCompanionPath expanded and searched in PATH
				SplitPath, strCompanionPath, strCompanionFilename ; used to detect window
				this.AA.strQAPconnectCompanionPath := strCompanionPath
				this.AA.strQAPconnectCompanionFilename := strCompanionFilename
				
				strNeverQuotes := o_Settings.ReadIniValue("NeverQuotes", 0, strQAPconnectFileManager, this.AA.strQAPconnectIniPath)
				this.AA.strQAPconnectNeverQuotes := strNeverQuotes
			}
		}
		;-----------------------------------------------------
	}
	;---------------------------------------------------------
}
;-------------------------------------------------------------


;-------------------------------------------------------------
class SpecialFolders
;-------------------------------------------------------------
{
	;---------------------------------------------------------
	__Call(function, parameters*)
	; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
	{
		funcRef := Func(funcName := this.__class "." function)
		if CheckParameters(funcRef, function, parameters*) ; if everything is good call the function, else return false
			return funcRef.(this, parameters*) ; everything is good
		else
			return
	}
	;---------------------------------------------------------
	
	AA := Object()
	aaClassIdOrPathByDefaultName := Object()
	strDownloadPath := ""
	strMyPicturesPath := ""
	
	;---------------------------------------------------------
	__New()
	
	; Shell numeric Constants
	; http://msdn.microsoft.com/en-us/library/windows/desktop/bb774096%28v=vs.85%29.aspx

	; Shell Commands:
	; http://www.sevenforums.com/tutorials/4941-shell-command.html
	; http://www.eightforums.com/tutorials/6050-shell-commands-windows-8-a.html

	; Environment system variables
	; http://en.wikipedia.org/wiki/Environment_variable#Windows

	; AddSpecialFolderObject(strClassIdOrPath, strShellConstant, intShellConstant, strAHKConstant, strDOpusAlias, strTCCommand
	;	, strDefaultName, strDefaultIcon
	;	, strUse4NavigateExplorer, strUse4NewExplorer, strUse4Dialog, strUse4Console, strUse4DOpus, strUse4TC, strUse4FPc
	;	, strCategories)

	; 		CLS: Class ID
	;		SCT: Shell Constant Text
	;		SCN: Shell Constant Numeric
	;		DOA: Directory Opus Alias
	;		TCC: Total Commander Commands
	;		NEW: Open in new Explorer anyway

	; NOTES
	; - Total Commander commands: cm_OpenDesktop (2121), cm_OpenDrives (2122), cm_OpenControls (2123), cm_OpenFonts (2124), cm_OpenNetwork (2125), cm_OpenPrinters (2126), cm_OpenRecycled (2127)
	; - DOpus see http://resource.dopus.com/viewtopic.php?f=3&t=23691

	;---------------------------------------------------------
	{
		;---------------------
		; CLSID giving localized name and icon, with valid Shell Command

		this.AddSpecialFolderObject("{D20EA4E1-3957-11d2-A40B-0C5020524153}", "Common Administrative Tools", -1, "", "commonadmintools", ""
			, "Administrative Tools", "" ; Outils dadministration
			, "CLS", "CLS", "NEW", "NEW", "DOA", "NEW", "NEW"
			, "3-Sysadmin")
		this.AddSpecialFolderObject("{20D04FE0-3AEA-1069-A2D8-08002B30309D}", "MyComputerFolder", 17, "", "mycomputer", 2122
			, "Computer", "" ; Ordinateur
			, "SCT", "SCT", "SCT", "NEW", "DOA", "TCC", "NEW" ; for 1,2,3 CLS works, 7 OK for FPc but CLS does not work with DoubleCommander
			, "1-Basic~5-Hardware")
		this.AddSpecialFolderObject("{21EC2020-3AEA-1069-A2DD-08002B30309D}", "ControlPanelFolder", 3, "", "controls", 2123
			, "Control Panel (Icons view)", "" ; Tous les Panneaux de configuration
			, "SCT", "SCT", "NEW", "NEW", "NEW", "CLS", "NEW"
			, "1-Basic~5-Hardware")
		this.AddSpecialFolderObject("{450D8FBA-AD25-11D0-98A8-0800361B1103}", "Personal", 5, "A_MyDocuments", "mydocuments", ""
			, "Documents", "" ; Mes documents
			, "SCT", "SCT", "AHK", "AHK", "DOA", "AHK", "AHK"
			, "1-Basic~4-Contents")
		this.AddSpecialFolderObject("{ED228FDF-9EA8-4870-83b1-96b02CFE0D52}", "Games", -1, "", "", ""
			, "Games Explorer", "" ; Jeux
			, "SCT", "SCT", "NEW", "NEW", "NEW", "CLS", "NEW"
			, "4-Contents")
		this.AddSpecialFolderObject("{B4FB3F98-C1EA-428d-A78A-D1F5659CBA93}", "HomeGroupFolder", -1, "", "", ""
			, "HomeGroup", "" ; Groupe rsidentiel
			, "SCT", "SCT", "SCT", "NEW", "NEW", "CLS", "NEW"
			, "3-Sysadmin~5-Hardware")
		this.AddSpecialFolderObject("{031E4825-7B94-4dc3-B131-E946B44C8DD5}", "Libraries", -1, "", "libraries", ""
			, "Libraries", "" ; Bibliothque
			, "SCT", "SCT", "SCT", "NEW", "DOA", "CLS", "NEW"
			, "2-Power User~4-Contents")
		this.AddSpecialFolderObject("{7007ACC7-3202-11D1-AAD2-00805FC1270E}", "ConnectionsFolder", -1, "", "", ""
			, "Network Connections", "" ; Connexions rseau
			, "SCT", "SCT", "NEW", "NEW", "NEW", "CLS", "NEW"
			, "3-Sysadmin~5-Hardware")
		this.AddSpecialFolderObject("{F02C1A0D-BE21-4350-88B0-7367FC96EF3C}", "NetworkPlacesFolder", 18, "", "network", 2125
			, "Network", "" ; Rseau
			, "SCT", "SCT", "SCT", "NEW", "DOA", "TCC", "NEW"
			, "3-Sysadmin~5-Hardware")
		this.AddSpecialFolderObject("{2227A280-3AEA-1069-A2DE-08002B30309D}", "PrintersFolder", -1, "", "printers", 2126
			, "Printers and Faxes", "" ; Imprimantes
			, "SCT", "SCT", "NEW", "NEW", "DOA", "TCC", "NEW"
			, "1-Basic~5-Hardware")
		this.AddSpecialFolderObject("{645FF040-5081-101B-9F08-00AA002F954E}", "RecycleBinFolder", 0, "", "trash", 2127
			, "Recycle Bin", "" ; Corbeille
			, "SCT", "SCT", "NEW", "NEW", "DOA", "TCC", "NEW"
			, "1-Basic")
		this.AddSpecialFolderObject("{59031a47-3f72-44a7-89c5-5595fe6b30ee}", "Profile", -1, "", "profile", ""
			, o_L["MenuUserFolder"], "" ; Dossier de l'utilisateur
			, "SCT", "SCT", "SCT", "NEW", "DOA", "CLS", "NEW"
			, "3-Sysadmin")
		this.AddSpecialFolderObject("{1f3427c8-5c10-4210-aa03-2ee45287d668}", "User Pinned", -1, "", "", ""
			, o_L["MenuUserPinned"], "" ; Epingl par l'utilisateur
			, "SCT", "SCT", "SCT", "NEW", "NEW", "NEW", "NEW"
			, "2-Power User")
		this.AddSpecialFolderObject("{BD84B380-8CA2-1069-AB1D-08000948534}", "Fonts", -1, "", "fonts", 2124
			, o_L["MenuFonts"], "iconFonts"
			, "SCT", "SCT", "NEW", "NEW", "DOA", "TCC", "NEW"
			, "3-Sysadmin")

		;---------------------
		; CLSID giving localized name and icon, no valid Shell Command, must be open in a new Explorer using CLSID - to be tested with DOpus, TC and FPc

		this.AddSpecialFolderObject("{B98A2BEA-7D42-4558-8BD1-832F41BAC6FD}", "", -1, "", "", ""
			, "Backup and Restore", "" ; Sauvegarder et restaurer
			, "CLS", "CLS", "NEW", "NEW", "NEW", "NEW", "NEW"
			, "3-Sysadmin")
		this.AddSpecialFolderObject("{ED7BA470-8E54-465E-825C-99712043E01C}", "", -1, "", "", ""
			, "Control Panel (All Tasks)", "" ; Toutes les tches
			, "CLS", "CLS", "NEW", "NEW", "NEW", "NEW", "NEW"
			, "2-Power User~5-Hardware")
		this.AddSpecialFolderObject("{323CA680-C24D-4099-B94D-446DD2D7249E}", "", -1, "", "favorites", ""
			, "Favorites", "" ; Favoris (<> Favorites (Internet))
			, "CLS", "CLS", "CLS", "NEW", "DOA", "NEW", "NEW"
			, "4-Contents")
		if (GetOsVersion() <> "WIN_10")
			this.AddSpecialFolderObject("{3080F90E-D7AD-11D9-BD98-0000947B0257}", "", -1, "", "", ""
				, "Flip 3D", "" ; Pas de traduction
				, "CLS", "CLS", "NEW", "NEW", "NEW", "NEW", "NEW"
				, "4-Contents")
		this.AddSpecialFolderObject("{6DFD7C5C-2451-11d3-A299-00C04F8EF6AF}", "", -1, "", "", ""
			, "Folder Options", "" ; Options des dossiers
			, "CLS", "CLS", "NEW", "NEW", "NEW", "NEW", "NEW"
			, "2-Power User")
		if (A_OSVersion = "WIN_7") ; Performance Information and Tool not available on Win8+
			this.AddSpecialFolderObject("{78F3955E-3B90-4184-BD14-5397C15F1EFC}", "", -1, "", "", ""
				, "Performance Information and Tools", "" ; Informations et outils de performance
				, "CLS", "CLS", "NEW", "NEW", "NEW", "NEW", "NEW"
				, "2-Power User")
		this.AddSpecialFolderObject("{35786D3C-B075-49b9-88DD-029876E11C01}", "", -1, "", "", ""
			, "Portable Devices", "" ; Appareils mobiles
			, "CLS", "CLS", "NEW", "NEW", "NEW", "NEW", "NEW"
			, "2-Power User~5-Hardware")
		this.AddSpecialFolderObject("{22877a6d-37a1-461a-91b0-dbda5aaebc99}", "", -1, "", "", ""
			, "Recent Places", "" ; Emplacements rcents
			, "CLS", "CLS", "NEW", "NEW", "NEW", "NEW", "NEW"
			, "2-Power User~4-Contents")
		this.AddSpecialFolderObject("{3080F90D-D7AD-11D9-BD98-0000947B0257}", "", -1, "", "", ""
			, "Show Desktop", "" ; Afficher le Bureau
			, "CLS", "CLS", "NEW", "NEW", "NEW", "NEW", "NEW"
			, "2-Power User")
		this.AddSpecialFolderObject("{BB06C0E4-D293-4f75-8A90-CB05B6477EEE}", "", -1, "", "", ""
			, "System", "" ; Systme
			, "CLS", "CLS", "NEW", "NEW", "NEW", "NEW", "NEW"
			, "3-Sysadmin~5-Hardware")

		;---------------------
		; Path from registry (no CLSID), localized name and icon provided, no Shell Command - to be tested with DOpus, TC and FPc

		RegRead, strException, HKEY_CURRENT_USER, Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders, {374DE290-123F-4565-9164-39C4925E467B}
		this.strDownloadPath := strException
		this.AddSpecialFolderObject(strException, "", -1, "", "downloads", ""
			, o_L["MenuDownloads"], "iconDownloads"
			, "CLS", "CLS", "CLS", "CLS", "DOA", "CLS", "CLS"
			, "1-Basic~4-Contents")
		RegRead, strException, HKEY_CURRENT_USER, Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders, My Music
		this.AddSpecialFolderObject(strException, "", -1, "", "mymusic", ""
			, o_L["MenuMyMusic"], "iconMyMusic"
			, "CLS", "CLS", "CLS", "CLS", "DOA", "CLS", "CLS"
			, "1-Basic~4-Contents")
		RegRead, strException, HKEY_CURRENT_USER, Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders, My Video
		this.AddSpecialFolderObject(strException, "", -1, "", "myvideos", ""
			, o_L["MenuMyVideo"], "iconMyVideo"
			, "CLS", "CLS", "CLS", "CLS", "DOA", "CLS", "CLS"
			, "1-Basic~4-Contents")
		RegRead, strException, HKEY_CURRENT_USER, Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders, Templates
		this.AddSpecialFolderObject(strException, "", -1, "", "templates", ""
			, o_L["MenuTemplates"], "iconTemplates"
			, "CLS", "CLS", "CLS", "CLS", "DOA", "CLS", "CLS"
			, "2-Power User")
		RegRead, strException, HKEY_CURRENT_USER, Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders, My Pictures
		this.strMyPicturesPath := strException
		this.AddSpecialFolderObject(this.strMyPicturesPath, "", 39, "", "mypictures", ""
			, o_L["MenuPictures"], "iconPictures"
			, "CLS", "CLS", "CLS", "CLS", "DOA", "CLS", "CLS"
			, "1-Basic~4-Contents")

		;---------------------
		; Path under %APPDATA% (no CLSID), localized name and icon provided, no Shell Command - to be tested with DOpus, TC and FPc

		this.AddSpecialFolderObject("%APPDATA%\Microsoft\Windows\Start Menu", "", -1, "A_StartMenu", "start", ""
			, o_L["MenuStartMenu"], "iconFolder"
			, "CLS", "CLS", "CLS", "CLS", "DOA", "CLS", "CLS"
			, "2-Power User")
		this.AddSpecialFolderObject("%APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup", "", -1, "A_Startup", "startup", ""
			, o_L["MenuStartup"], "iconFolder"
			, "CLS", "CLS", "CLS", "CLS", "DOA", "CLS", "CLS"
			, "2-Power User")
		this.AddSpecialFolderObject("%APPDATA%", "", -1, "A_AppData", "appdata", ""
			, o_L["MenuAppData"], "iconFolder"
			, "CLS", "CLS", "CLS", "CLS", "DOA", "CLS", "CLS"
			, "3-Sysadmin")
		this.AddSpecialFolderObject("%APPDATA%\Microsoft\Windows\Recent", "", -1, "", "recent", ""
			, o_L["MenuRecentItems"], "iconRecentFolders"
			, "CLS", "CLS", "CLS", "CLS", "DOA", "CLS", "CLS"
			, "2-Power User~4-Contents")
		if (GetOsVersion() = "WIN_10")
			this.AddSpecialFolderObject("%LocalAppData%\Packages\Microsoft.MicrosoftEdge_8wekyb3d8bbwe\AC\MicrosoftEdge\Cookies", "", -1, "", "cookies", ""
				, o_L["MenuCookies"], "iconFolder"
				, "CLS", "CLS", "CLS", "CLS", "DOA", "CLS", "CLS"
				, "2-Power User")
		else
			this.AddSpecialFolderObject("%APPDATA%\Microsoft\Windows\Cookies", "", -1, "", "cookies", ""
				, o_L["MenuCookies"], "iconFolder"
				, "CLS", "CLS", "CLS", "CLS", "DOA", "CLS", "CLS"
				, "2-Power User")
		this.AddSpecialFolderObject("%APPDATA%\Microsoft\Internet Explorer\Quick Launch", "", -1, "", "", ""
			, o_L["MenuQuickLaunch"], "iconFolder"
			, "CLS", "CLS", "CLS", "CLS", "CLS", "CLS", "CLS"
			, "2-Power User~4-Contents")
		this.AddSpecialFolderObject("%APPDATA%\Microsoft\SystemCertificates", "", -1, "", "", ""
			, o_L["MenuSystemCertificates"], "iconFolder"
			, "CLS", "CLS", "CLS", "CLS", "CLS", "CLS", "CLS"
			, "3-Sysadmin")

		;---------------------
		; Path under other environment variables (no CLSID), localized name and icon provided, no Shell Command - to be tested with DOpus, TC and FPc

		this.AddSpecialFolderObject("%ALLUSERSPROFILE%\Microsoft\Windows\Start Menu", "", -1, "A_StartMenuCommon", "commonstartmenu", ""
			, o_L["MenuCommonStartMenu"], "iconFolder"
			, "CLS", "CLS", "CLS", "CLS", "DOA", "CLS", "CLS"
			, "3-Sysadmin")
		this.AddSpecialFolderObject("%ALLUSERSPROFILE%\Microsoft\Windows\Start Menu\Programs\Startup", "", -1, "A_StartupCommon", "commonstartup", ""
			, o_L["MenuCommonStartupMenu"], "iconFolder"
			, "CLS", "CLS", "CLS", "CLS", "DOA", "CLS", "CLS"
			, "3-Sysadmin")
		this.AddSpecialFolderObject("%ALLUSERSPROFILE%", "", -1, "A_AppDataCommon", "commonappdata", ""
			, o_L["MenuCommonAppData"], "iconFolder"
			, "CLS", "CLS", "CLS", "CLS", "DOA", "CLS", "CLS"
			, "3-Sysadmin")
		this.AddSpecialFolderObject("%LOCALAPPDATA%\Microsoft\Windows\Temporary Internet Files", "", -1, "", "", ""
			, o_L["MenuCache"], "iconTemporary"
			, "CLS", "CLS", "CLS", "CLS", "CLS", "CLS", "CLS"
			, "2-Power User")
		this.AddSpecialFolderObject("%LOCALAPPDATA%\Microsoft\Windows\History", "", -1, "", "history", ""
			, o_L["MenuHistory"], "iconHistory"
			, "CLS", "CLS", "CLS", "CLS", "DOA", "CLS", "CLS"
			, "2-Power User")
		this.AddSpecialFolderObject("%ProgramFiles%", "", -1, "A_ProgramFiles", "programfiles", ""
			, o_L["MenuProgramFiles"], "iconFolder"
			, "CLS", "CLS", "CLS", "CLS", "DOA", "CLS", "CLS"
			, "3-Sysadmin")
		if (A_Is64bitOS)
			this.AddSpecialFolderObject("%ProgramFiles(x86)%", "", -1, "", "programfilesx86", ""
				, o_L["MenuProgramFiles"] . " (x86)", "iconFolder"
				, "CLS", "CLS", "CLS", "CLS", "DOA", "CLS", "CLS"
				, "3-Sysadmin")
		this.AddSpecialFolderObject("%PUBLIC%\Libraries", "", -1, "", "", ""
			, o_L["MenuPublicLibraries"], "iconFolder"
			, "CLS", "CLS", "CLS", "CLS", "CLS", "CLS", "CLS"
			, "3-Sysadmin")

		;---------------------
		; Path under the Users folder (no CLSID, localized name and icon provided), no Shell Command

		strPathUsername := StrReplace(A_AppData, "\AppData\Roaming")
		strPathUsers := StrReplace(strPathUsername, "\" . A_UserName)
		this.AddSpecialFolderObject(strPathUsers . "\Public", "Public", -1, "", "common", ""
			, "Public Folder", "" ; Public
			, "SCT", "SCT", "SCT", "CLS", "DOA", "CLS", "CLS"
			, "3-Sysadmin")

		;---------------------
		; Path using AHK constants (no CLSID), localized name and icon provided, no Shell Command - to be tested with DOpus, TC and FPc

		this.AddSpecialFolderObject(A_Desktop, "", 0, "A_Desktop", "desktop", 2121
			, o_L["MenuDesktop"], "iconDesktop"
			, "CLS", "CLS", "CLS", "CLS", "DOA", "TCC", "CLS"
			, "1-Basic")
		this.AddSpecialFolderObject(A_DesktopCommon, "", -1, "A_DesktopCommon", "commondesktopdir", ""
			, o_L["MenuCommonDesktop"], "iconDesktop"
			, "CLS", "CLS", "CLS", "CLS", "DOA", "CLS", "CLS"
			, "3-Sysadmin")
		this.AddSpecialFolderObject(A_Temp, "", -1, "A_Temp", "temp", ""
			, o_L["MenuTemporaryFiles"], "iconTemporary"
			, "CLS", "CLS", "CLS", "CLS", "DOA", "CLS", "CLS"
			, "2-Power User")
		this.AddSpecialFolderObject(A_WinDir, "", -1, "A_WinDir", "windows", ""
			, "Windows", "iconWinver"
			, "CLS", "CLS", "CLS", "CLS", "DOA", "CLS", "CLS"
			, "3-Sysadmin")
		this.AddSpecialFolderObject(A_Programs, "", -1, "A_Programs", "programs", "" ; CLSID was "{7be9d83c-a729-4d97-b5a7-1b7313c39e0a}" but not working under Win 10
			, o_L["MenuProgramsFolderStartMenu"], "" ; Menu Dmarrer / Programmes (Menu Start/Programs)
			, "CLS", "CLS", "CLS", "CLS", "DOA", "AHK", "AHK"
			, "2-Power User")
			
		;-----------------------
		; Special Folders categories

		saSpecialFoldersCategoriesSystemName := StrSplit("1-Basic|2-Power User|3-Sysadmin|4-Contents|5-Hardware", "|")
		saSpecialFoldersCategoriesDisplayNames := StrSplit(o_L["DialogSpecialFoldersCategoriesNames"], "|")
		Loop, % saSpecialFoldersCategoriesSystemName.Length()
			this.aaSpecialFoldersCategories[saSpecialFoldersCategoriesSystemName[A_Index]] := saSpecialFoldersCategoriesDisplayNames[A_Index]
	}
	;---------------------------------------------------------
	
	;---------------------------------------------------------
	AddSpecialFolderObject(strClassIdOrPath, strShellConstantText, intShellConstantNumeric, strAHKConstant, strDOpusAlias, strTCCommand
		, strDefaultName, strDefaultIcon
		, strUse4NavigateExplorer, strUse4NewExplorer, strUse4Dialog, strUse4Console, strUse4DOpus, strUse4TC, strUse4FPc
		, strCategories)

	; strClassIdOrPath: CLSID or Path, used as key to access objSpecialFolder objects
	;		CLSID Win_7: http://www.sevenforums.com/tutorials/110919-clsid-key-list-windows-7-a.html
	;		CLSID Win_8: http://www.eightforums.com/tutorials/13591-clsid-key-guid-shortcuts-list-windows-8-a.html
	; 		Environment system variables: http://en.wikipedia.org/wiki/Environment_variable#Windows
	;		HKEY_CLASSES_ROOT Key: http://msdn.microsoft.com/en-us/library/windows/desktop/ms724475(v=vs.85).aspx
	; 		NOTES How to call in Explorer...
	;		... CLSID: shell:::{{20D04FE0-3AEA-1069-A2D8-08002B30309D}}
	;		... ShellConstant: shell:MyComputerFolder

	; strShellConstantText: text constant used to navigate using Explorer or Dialog box? What with DOpus and TC?
	;		http://www.sevenforums.com/tutorials/4941-shell-command.html
	;		http://www.eightforums.com/tutorials/6050-shell-commands-windows-8-a.html

	; intShellConstantNumeric: numeric ShellSpecialFolderConstants constant 
	;		http://msdn.microsoft.com/en-us/library/windows/desktop/bb774096%28v=vs.85%29.aspx

	; CLSID, strShellConstantText (by version XP!, Vista, 7) and intShellConstantNumeric: http://docs.rainmeter.net/tips/launching-windows-special-folders

	; strAHKConstant: AutoHotkey constant

	; strDOpusAlias: Directory Opus constant

	; strTCCommand: Total Commander constant

	; strDefaultName: name for menu if path is used, fallback name if CLSID is used to access localized name

	; strDefaultIcon: icon in o_JLicons.AA if path is used, fallback icon (?) if CLSID returns no icon resource

	; Constants for "use" flags:
	; 		CLS: Class ID
	;		SCT: Shell Constant Text
	;		SCN: Shell Constant Numeric
	;		DOA: Directory Opus Alias
	;		TCC: Total Commander Commands

	; Usage flags:
	; 		strUse4NavigateExplorer
	; 		strUse4NewExplorer
	; 		strUse4Dialog
	; 		strUse4Console
	; 		strUse4DOpus
	; 		strUse4TC
	;		strUse4FPc

	; Special Folder Object (aaOneSpecialFolder) definition:
	;		strClassIdOrPath: key to access one Special Folder object (example: o_SpecialFolders.AA[strClassIdOrPath], saved to ini file
	;		objSpecialFolder.strShellConstantText: text constant used to navigate using Explorer or Dialog box? What with DOpus and TC?
	;		objSpecialFolder.strShellConstantNumeric: numeric ShellSpecialFolderConstants constant 
	;		objSpecialFolder.strAHKConstant: AutoHotkey constant
	;		objSpecialFolder.strDOpusAlias: Directory Opus constant
	;		objSpecialFolder.strTCCommand: Total Commander constant
	;		objSpecialFolder.strDefaultName:
	;		objSpecialFolder.strDefaultIcon: icon resource name in the format "file,index"
	;		objSpecialFolder.strUse4NavigateExplorer:
	;		objSpecialFolder.strUse4NewExplorer:
	;		objSpecialFolder.strUse4Dialog:
	;		objSpecialFolder.strUse4Console:
	;		objSpecialFolder.strUse4DOpus:
	;		objSpecialFolder.strUse4TC:
	;		objSpecialFolder.strUse4FPc:
	;		objSpecialFolder.strCategories: categories, one or many (tilde delimited) of 1-Basic~2-Power User~3-Sysadmin~4-Contents~5-Hardware

	;---------------------------------------------------------
	{
		aaOneSpecialFolder := Object()
		
		blnIsClsId := (SubStr(strClassIdOrPath, 1, 1) = "{")

		if (blnIsClsId)
			strThisDefaultName := GetLocalizedNameForClassId(strClassIdOrPath)
		If !StrLen(strThisDefaultName)
			strThisDefaultName := strDefaultName
		this.aaClassIdOrPathByDefaultName[strThisDefaultName] := strClassIdOrPath
		aaOneSpecialFolder.strDefaultName := strThisDefaultName
		
		if (blnIsClsId)
			strThisDefaultIcon := GetIconForClassId(strClassIdOrPath)
		if !StrLen(strThisDefaultIcon) and StrLen(o_JLicons.AA[strDefaultIcon])
			strThisDefaultIcon := o_JLicons.AA[strDefaultIcon]
		if !StrLen(strThisDefaultIcon)
			strThisDefaultIcon := "%SystemRoot%\System32\shell32.dll,4" ; fallback folder icon from shell32.dll
		aaOneSpecialFolder.strDefaultIcon := strThisDefaultIcon

		aaOneSpecialFolder.strShellConstantText := strShellConstantText
		aaOneSpecialFolder.strShellConstantNumeric := intShellConstantNumeric
		aaOneSpecialFolder.strAHKConstant := strAHKConstant
		aaOneSpecialFolder.strDOpusAlias := strDOpusAlias
		aaOneSpecialFolder.strTCCommand := strTCCommand
		
		aaOneSpecialFolder.strUse4NavigateExplorer := strUse4NavigateExplorer
		aaOneSpecialFolder.strUse4NewExplorer := strUse4NewExplorer
		aaOneSpecialFolder.strUse4Dialog := strUse4Dialog
		aaOneSpecialFolder.strUse4Console := strUse4Console
		aaOneSpecialFolder.strUse4DOpus := strUse4DOpus
		aaOneSpecialFolder.strUse4TC := strUse4TC
		aaOneSpecialFolder.strUse4FPc := strUse4FPc

		aaOneSpecialFolder.strCategories := strCategories

		this.AA[strClassIdOrPath] := aaOneSpecialFolder
	}
	;---------------------------------------------------------
}
;-------------------------------------------------------------

;-------------------------------------------------------------
class QAPfeatures
;-------------------------------------------------------------
{
	;---------------------------------------------------------
	__Call(function, parameters*)
	; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
	{
		funcRef := Func(funcName := this.__class "." function)
		if CheckParameters(funcRef, function, parameters*) ; if everything is good call the function, else return false
			return funcRef.(this, parameters*) ; everything is good
		else
			return
	}
	;---------------------------------------------------------
	
	AA := Object() ; associative array
	aaQAPFeaturesCodeByDefaultName := Object() ; associative array
	aaQAPFeaturesDefaultNameByCode := Object() ; associative array
	saQAPFeaturesAlternativeCodeByOrder := Object() ; simple array
	aaQAPfeaturesInMenus := Object() ; associative array, index of QAP features actualy present in menu, populated outside the class
	aaQAPFeaturesNewShortcuts := Object() ; associative array, populated outside the class
	aaQAPFeaturesCategories := Object() ; associative array
	
	;---------------------------------------------------------
	__New()
	;---------------------------------------------------------
	{
		; AddQAPFeatureObject(strQAPFeatureCode, strThisDefaultName, strQAPFeatureMenuName, strQAPFeatureCommand, strQAPFeatureCategories
		; 	, strQAPFeatureDescription, intQAPFeatureAlternativeOrder, strThisDefaultIcon, strDefaultShortcut, strHelpUrl)
		
		this.AddQAPFeatureObject("Clipboard",				o_L["MenuClipboard"],				o_L["MenuClipboard"],			"ClipboardMenuShortcut",				"2-DynamicMenus"
			, o_L["MenuClipboardDescription"], 0, "iconClipboard", "+^v"
			, "what-is-in-the-clipboard-menu")
		this.AddQAPFeatureObject("Switch Folder or App",	o_L["MenuSwitchFolderOrApp"],		o_L["MenuSwitchFolderOrApp"],	"SwitchFolderOrAppMenuShortcut",		"2-DynamicMenus~4-WindowManagement"
			, o_L["MenuSwitchFolderOrAppDescription"], 0, "iconSwitch", "+^w"
			, "how-is-built-the-switch-to-an-open-folder-or-application-menu")
		this.AddQAPFeatureObject("Current Folders",			o_L["MenuCurrentFolders"],			o_L["MenuCurrentFolders"],		"ReopenFolderMenuShortcut",				"2-DynamicMenus~4-WindowManagement"
			, o_L["MenuCurrentFoldersDescription"], 0, "iconCurrentFolders", "+^f"
			, "how-is-built-the-current-folders-menu")
		this.AddQAPFeatureObject("Last Actions", 			o_L["MenuLastActions"], 			o_L["MenuLastActions"], 		"RepeatLastActionsShortcut",			"2-DynamicMenus~6-Utility"
			, o_L["MenuLastActionsDescription"], 0, "iconReload", ""
			, "can-i-reopen-one-of-the-last-favorites-i-selected-recently")
		this.AddQAPFeatureObject("TC Directory hotlist",	o_L["TCMenuName"],					o_L["TCMenuName"],				"TotalCommanderHotlistMenuShortcut", 	"2-DynamicMenus"
			, o_L["TCMenuNameDescription"], 0, "TotalCommander", "+^t"
			, "how-do-i-enable-total-commander-support-in-quick-access-popup")
		this.AddQAPFeatureObject("DOpus Favorites",			o_L["DOpusMenuName"],				o_L["DOpusMenuName"],			"DirectoryOpusFavoritesMenuShortcut", 	"2-DynamicMenus"
			, o_L["DOpusMenuNameDescription"], 0, "DirectoryOpus", ""
			, "how-to-i-enable-directory-opus-support-in-quick-access-popup")

		; Command features

		this.AddQAPFeatureObject("About",					o_L["GuiAbout"] . "...",					"", "GuiAbout",								"7-QAPManagement"
			, o_L["GuiAboutDescription"], 0, "iconAbout", "", "")
		this.AddQAPFeatureObject("Add Favorite",			o_L["MenuAddFavorite"] . "...",				"", "GuiAddFavoriteFromQAPFeature",			"3-QAPMenuEditing"
			, o_L["MenuAddFavoriteDescription"], 0, "iconAddFavorite", ""
			, "what-should-i-know-about-quick-access-popup-before-starting")
		this.AddQAPFeatureObject("Add This Folder",			o_L["MenuAddThisFolder"] . "...",			"", "AddThisFolder",						"3-QAPMenuEditing"
			, o_L["MenuAddThisFolderDescription"], 0, "iconAddThisFolder", "+^a"
			, "can-i-add-on-the-fly-the-folder-i-am-already-in")
		this.AddQAPFeatureObject("Add This Folder Express",	o_L["MenuAddThisFolderXpress"],				"", "AddThisFolderXpress",					"3-QAPMenuEditing"
			, o_L["MenuAddThisFolderXpressDescription"], 0, "iconAddThisFolder", ""
			, "can-i-add-on-the-fly-the-folder-i-am-already-in")
		this.AddQAPFeatureObject("Exit",					L(o_L["MenuExitApp"], g_strAppNameText),	"", "ExitApp",								"7-QAPManagement"
			, o_L["MenuExitAppDescription"], 0, "iconExit", "", "")
		this.AddQAPFeatureObject("Help",					o_L["GuiHelp"] . "...",						"", "GuiHelp",								"7-QAPManagement"
			, o_L["GuiHelpDescription"], 0, "iconHelp", "", "")
		this.AddQAPFeatureObject("Hotkeys",					o_L["DialogShortcuts"] . "...",				"", "GuiHotkeysManageFromQAPFeature",		"3-QAPMenuEditing"
			, o_L["DialogShortcutsDescription"], 0, "iconHotkeys", ""
			, "can-i-launch-my-favorites-with-keyboard-or-mouse-shortcuts")
		this.AddQAPFeatureObject("Hotstrings",				o_L["DialogHotstrings"] . "...",			"", "GuiHotkeysManageHotstringsFromQAPFeature",	"1-Featured~3-QAPMenuEditing"
			, o_L["DialogHotstringsDescription"], 0, "iconHotkeys", ""
			, "what-are-hotstrings")
		this.AddQAPFeatureObject("Icons",					o_L["DialogIconsManage"] . "...",			"", "GuiIconsManageFromQAPFeature",			"3-QAPMenuEditing"
			, o_L["DialogIconsManageDescription"], 0, "iconIcons", ""
			, "can-i-manage-all-my-menu-icons-in-one-screen")
		this.AddQAPFeatureObject("Options",					o_L["GuiOptions"] . "...",					"",	"GuiOptionsGroupGeneral",				"7-QAPManagement"
			, o_L["GuiOptionsDescription"], 0, "iconOptions", ""
			, "what-are-the-essential-global-options-to-know")
		this.AddQAPFeatureObject("Settings",				o_L["MenuSettings"] . "...",				"", "GuiShowFromQAPFeature",				"3-QAPMenuEditing~7-QAPManagement"
			, o_L["MenuSettingsDescription"], 0, "iconSettings", "+^s"
			, "what-should-i-know-about-quick-access-popup-before-starting")
		this.AddQAPFeatureObject("Support",					o_L["GuiDonate"] . "...",					"", "GuiDonate",							"7-QAPManagement"
			, o_L["GuiDonateDescription"], 0, "iconDonate", ""
			, "sponsoring")
		this.AddQAPFeatureObject("GetWinInfo",				o_L["MenuGetWinInfo"] . "...",				"", "GetWinInfo",							"6-Utility"
			, o_L["MenuGetWinInfoDescription"], 0, "iconAbout", ""
			, "can-i-block-the-qap-menu-hotkeys-if-they-interfere-with-one-of-my-other-apps")
		this.AddQAPFeatureObject("Reload",					L(o_L["MenuReload"], g_strAppNameText),		"", "ReloadQAP",							"6-Utility~7-QAPManagement"
			, o_L["MenuReloadDescription"], 0, "iconReload", ""
			, "when-do-i-need-to-use-the-system-tray-menu")
		this.AddQAPFeatureObject("CloseMenu",				o_L["MenuCloseThisMenu"],					"", "DoNothing",							"7-QAPManagement"
			, o_L["MenuCloseThisMenuDescription"], 0, "iconClose", ""
			, "what-is-the-close-menu-issue")
		this.AddQAPFeatureObject("ImportExport",			o_L["ImpExpMenu"] . "...",					"", "ImportExport",							"7-QAPManagement"
			, o_L["ImpExpMenuDescription"], 0, "iconSettings", ""
			, "can-i-backup-import-or-export-my-favorites-and-settings")
		this.AddQAPFeatureObject("SwitchSettings",			o_L["MenuSwitchSettings"] . "...",			"", "SwitchSettings",						"3-QAPMenuEditing~7-QAPManagement"
			, o_L["MenuSwitchSettingsDescription"], 0, "iconSettings", ""
			, "can-i-load-qap-with-an-alternative-settings-file")
		this.AddQAPFeatureObject("SwitchSettingsDefault",	o_L["MenuSwitchSettingsDefault"],			"", "SwitchSettingsDefault",				"3-QAPMenuEditing~7-QAPManagement"
			, o_L["MenuSwitchSettingsDefaultDescription"], 0, "iconSettings", ""
			, "can-i-load-qap-with-an-alternative-settings-file")
		this.AddQAPFeatureObject("RefreshMenu",				o_L["MenuRefreshMenu"],						"", "RefreshQAPMenu",						"3-QAPMenuEditing~7-QAPManagement"
			, o_L["MenuRefreshMenuDescription"], 0, "iconReload", ""
			, "what-are-the-qap-features")
		this.AddQAPFeatureObject("AddExternalFromCatalogue",o_L["MenuExternalCatalogue"], 				"", "AddExternalCatalogueFromQAPFeature",	"3-QAPMenuEditing"
			, o_L["MenuExternalCatalogueDescription"], 0, "iconAddFavorite", ""
			, "shared-menu-catalogue")
		this.AddQAPFeatureObject("ReopenCurrentFolder",		o_L["MenuReopenCurrentFolder"], 			"", "OpenReopenCurrentFolder",				"1-Featured~4-WindowManagement"
			, o_L["MenuReopenCurrentFolderDescription"], 0, "iconChangeFolder", "+^c"
			, "can-i-change-folders-in-file-dialog-boxes-open-save-as-etc")
		this.AddQAPFeatureObject("Last Action", 			o_L["MenuLastAction"],						"", "RepeatLastActionShortcut",				"6-Utility"
			, o_L["MenuLastActionDescription"], 0, "iconReload", ""
			, "can-i-reopen-one-of-the-last-favorites-i-selected-recently")
		this.AddQAPFeatureObject("Close All Windows", 		o_L["MenuCloseAllWindows"],					"", "CloseAllWindows",						"1-Featured~4-WindowManagement"
			, o_L["MenuCloseAllWindowsDescription"], 0, "iconDesktop", ""
			, "can-i-close-all-running-applications-and-windows-in-one-click")
		this.AddQAPFeatureObject("Reopen in New Window", 	o_L["MenuReopenInNewWindow"],				"", "OpenReopenInNewWindow",				"4-WindowManagement"
			, o_L["MenuReopenInNewWindowDescription"], 0, "iconChangeFolder", ""
			, "can-i-change-folders-in-file-dialog-boxes-open-save-as-etc")
		this.AddQAPFeatureObject("Restore Settings Position", o_L["MenuRestoreSettingsWindowPosition"], "", "GuiShowRestoreDefaultPosition",		"7-QAPManagement"
			, o_L["MenuRestoreSettingsWindowPositionDescription"], 0, "iconSettings", "", "qap-is-running-but-my-settings-window-disappeared-what-happened")
		this.AddQAPFeatureObject("Check for update", 		o_L["MenuUpdate"],							"", "Check4UpdateNow",						"7-QAPManagement"
			, o_L["MenuUpdateDescription"], 0, "iconChangeFolder", "", "")
		this.AddQAPFeatureObject("Edit Settings file", 		L(o_L["MenuEditIniFile"], o_Settings.strIniFileNameExtOnly), "", "ShowSettingsIniFile", "7-QAPManagement"
			, o_L["MenuEditIniFileDescription"], 0, "iconSettings", ""
			, "how-can-i-edit-the-file-quickaccesspopup-ini")
		this.AddQAPFeatureObject("List Applications", 		o_L["MenuListApplications"],				"", "ListApplications",						"7-QAPManagement"
			, o_L["MenuListApplicationsDescription"], 0, "iconDesktop", "", "")
		this.AddQAPFeatureObject("Donor Code Input", 		o_L["GuiDonateCodeInput"],					"", "GuiDonateCodeInput",					"7-QAPManagement"
			, o_L["GuiDonateCodeInputDescription"], 0, "iconDonate", "", "sponsoring")

		this.AddQAPFeatureObject("Close Computer Control", o_L["DialogCloseComputerControl"], 			"", "CloseComputerControl",					"1-Featured~5.1-CloseComputer"
			, o_L["DialogCloseComputerControlDescription"], 0, "iconExit", ""
			, "can-i-control-how-my-computer-is-closed-with-qap")
		strQAPFeatureName := StrReplace(o_L["DialogCloseComputerShutdown"], "&")
		this.AddQAPFeatureObject("ShutDown",				strQAPFeatureName,							"", "ShutdownComputer",						"5.1-CloseComputer"
			, o_L["DialogCloseComputerShutdownDescription"], 0, "iconExit", ""
			, "can-i-control-how-my-computer-is-closed-with-qap")
		strQAPFeatureName := StrReplace(o_L["DialogCloseComputerPowerDown"], "&")
		this.AddQAPFeatureObject("Power Down Computer", 	strQAPFeatureName, 							"", "PowerDownComputer",					"5.1-CloseComputer"
			, o_L["DialogCloseComputerPowerDownDescription"], 0, "iconExit", ""
			, "can-i-control-how-my-computer-is-closed-with-qap")
		strQAPFeatureName := StrReplace(o_L["DialogCloseComputerRestart"], "&")
		this.AddQAPFeatureObject("Restart",					strQAPFeatureName,							"", "RestartComputer",						"5.1-CloseComputer"
			, o_L["DialogCloseComputerRestartDescription"], 0, "iconReload", ""
			, "can-i-control-how-my-computer-is-closed-with-qap")
		strQAPFeatureName := StrReplace(o_L["DialogCloseComputerLogoff"], "&")
		this.AddQAPFeatureObject("Logoff", 					strQAPFeatureName, 							"", "LogoffComputer",						"5.1-CloseComputer"
			, o_L["DialogCloseComputerLogoffDescription"], 0, "iconExit", ""
			, "can-i-control-how-my-computer-is-closed-with-qap")
		strQAPFeatureName := StrReplace(o_L["DialogCloseComputerSuspend"], "&")
		this.AddQAPFeatureObject("Suspend Computer", 		strQAPFeatureName, 							"", "SuspendComputer",						"5.1-CloseComputer"
			, o_L["DialogCloseComputerSuspendDescription"], 0, "iconExit", ""
			, "can-i-control-how-my-computer-is-closed-with-qap")
		strQAPFeatureName := StrReplace(o_L["DialogCloseComputerHibernate"], "&")
		this.AddQAPFeatureObject("Hibernate Computer", 		strQAPFeatureName, 							"", "HibernateComputer",					"5.1-CloseComputer"
			, o_L["DialogCloseComputerHibernateDescription"], 0, "iconExit", ""
			, "can-i-control-how-my-computer-is-closed-with-qap")
		strQAPFeatureName := StrReplace(o_L["DialogCloseComputerMonitorTurnOff"], "&")
		this.AddQAPFeatureObject("Turn Off Monitor", 		strQAPFeatureName, 							"", "TurnOffMonitorComputer",				"5.1-CloseComputer"
			, o_L["DialogCloseComputerMonitorTurnOffDescription"], 0, "iconDesktop", ""
			, "can-i-control-how-my-computer-is-closed-with-qap")
		strQAPFeatureName := StrReplace(o_L["DialogCloseComputerMonitorLowPower"], "&")
		this.AddQAPFeatureObject("Monitor Low Power", 		strQAPFeatureName, 							"", "LowPowerMonitorComputer",				"5.1-CloseComputer"
			, o_L["DialogCloseComputerMonitorLowPowerDescription"], 0, "iconDesktop", ""
			, "can-i-control-how-my-computer-is-closed-with-qap")
		strQAPFeatureName := StrReplace(o_L["DialogCloseComputerStartScreenSaver"], "&")
		this.AddQAPFeatureObject("Start Screen Saver", 		strQAPFeatureName, 							"", "StartScreenSaverComputer",				"5.1-CloseComputer"
			, o_L["DialogCloseComputerStartScreenSaverDescription"], 0, "iconDesktop", ""
			, "can-i-control-how-my-computer-is-closed-with-qap")

		; New for v9.x
		; this.AddQAPFeatureObject("Exclusions Mouse", 			o_L["Menu"],					"", "command",				"1-Featured~7-QAPManagement"
			; , o_L["MenuDescription"], 0, "icon", ""
			; , "can-i-block-the-qap-menu-hotkeys-if-they-interfere-with-one-of-my-other-apps")
		; this.AddQAPFeatureObject("Exclusions Keyboard", 			o_L["Menu"],					"", "command",				"1-Featured~7-QAPManagement"
			; , o_L["MenuDescription"], 0, "icon", "", "")

		this.AddAttachedOrDetachedQAPFeatureObject()

		Loop, % o_Favorites.s_SA.Length()
			if StrLen(o_Favorites.s_SA[A_Index].strFavoriteTypeLocationLabelNoAmpersand)
				this.AddQAPFeatureObject("Add Favorite - " . o_Favorites.s_SA[A_Index].strFavoriteTypeSystemName, o_L["MenuAddFavorite"] . " - " . o_Favorites.s_SA[A_Index].strFavoriteTypeLocationLabelNoAmpersand . "..."
					, "", "GuiAddFavoriteFromQAPFeature" . o_Favorites.s_SA[A_Index].strFavoriteTypeSystemName, "3.1-AddFavoriteOfType"
					, L(o_L["MenuAddFavoriteOfTypeDescription"], o_Favorites.s_SA[A_Index].strFavoriteTypeLocationLabelNoAmpersand), 0, "iconAddFavorite", ""
					, "what-should-i-know-about-quick-access-popup-before-starting")

		; Alternative Menu features
		this.AddQAPFeatureObject("Open in New Window",		o_L["MenuAlternativeNewWindow"],				"", "", ""
			, "", 1, "iconFolder", "", "")
		this.AddQAPFeatureObject("Edit Favorite",			o_L["MenuAlternativeEditFavorite"],			"", "", ""
			, "", 3, "iconEditFavorite", "", "")
		this.AddQAPFeatureObject("Copy Favorite Location",	o_L["MenuCopyLocation"],						"", "", ""
			, "", 5, "iconClipboard", "", "")
		this.AddQAPFeatureObject("Run As Administrator",	o_L["MenuAlternativeRunAs"],					"", "", ""
			, "", 7, "iconUAClogo", "", "")
		this.AddQAPFeatureObject("Open Containing Current",	o_L["MenuAlternativeOpenContainingCurrent"],	"", "", ""
			, "", 9, "iconSpecialFolders", "", "")
		this.AddQAPFeatureObject("Open Containing New",		o_L["MenuAlternativeOpenContainingNew"],		"", "", ""
			, "", 10, "iconSpecialFolders", "", "")

		;-----------------------
		; QAP Features categories

		saQAPFeaturesCategoriesSystemName := StrSplit("1-Featured|2-DynamicMenus|3-QAPMenuEditing|3.1-AddFavoriteOfType|4-WindowManagement|5-WindowsFeature|5.1-CloseComputer|6-Utility|7-QAPManagement", "|")
		saQAPFeaturesCategoriesDisplayNames := StrSplit(o_L["DialogQAPFeatureCategoriesNames"], "|")
		Loop, % saQAPFeaturesCategoriesSystemName.Length()
			this.aaQAPFeaturesCategories[saQAPFeaturesCategoriesSystemName[A_Index]] := saQAPFeaturesCategoriesDisplayNames[A_Index]
	}
	;---------------------------------------------------------
	

	;---------------------------------------------------------
	RefreshAttachedOrDetachedQAPFeatureObject()
	; This function is called to re-init these QAP Features when options are saved
	;---------------------------------------------------------
	{
		this.AddAttachedOrDetachedQAPFeatureObject()
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	AddAttachedOrDetachedQAPFeatureObject()
	; This function is called again after options are saved
	;---------------------------------------------------------
	{
		; default true, display "Recent Folders", "Recent Files", "Popular Folders", "Popular Files" and "Drives" attached to main menu
		; read here because this is required before LoadIniFile
		blnAttached := o_Settings.ReadIniOption("MenuPopup", "blnRefreshedMenusAttached", "RefreshedMenusAttached", 1, "PopupMenu", "f_blnRefreshedMenusAttached") ; g_blnRefreshedMenusAttached

		; init refreshed menus attached or detached according to blnAttached
		this.AddQAPFeatureObject("Recent Folders",	o_L["MenuRecentFolders"] . (blnAttached ? "" : "...")
			, (blnAttached ? o_L["MenuRecentFolders"] : "")
			, "RecentFoldersMenuShortcut", "2-DynamicMenus~5-WindowsFeature"
			, o_L["MenuRecentFoldersDescription"], 0, "iconRecentFolders",	"+^r"
			, "from-where-comes-the-content-of-the-recent-folders-menu")
		this.AddQAPFeatureObject("Recent Files", o_L["MenuRecentFiles"] . (blnAttached ? "" : "...")
			, (blnAttached ? o_L["MenuRecentFiles"] : ""
			, "from-where-comes-the-content-of-the-recent-folders-menu")
			, "RecentFilesMenuShortcut", "2-DynamicMenus~5-WindowsFeature"
			, o_L["MenuRecentFilesDescription"], 0, "iconRecentFolders",	""
			, "from-where-comes-the-content-of-the-recent-folders-menu")
		this.AddQAPFeatureObject("Popular Folders", o_L["MenuPopularMenusFolders"] . (blnAttached ? "" : "...")
			, (blnAttached ? o_L["MenuPopularMenusFolders"] : "")
			, "PopularFoldersMenuShortcut", "1-Featured~2-DynamicMenus"
			, L(o_L["MenuPopularMenusDescription"], Format("{:U}", o_L["MenuPopularFolders"])), 0, "iconFavorites", ""
			, "what-is-in-the-works-and-its-frequent-recent-and-current-menus")
		this.AddQAPFeatureObject("Popular Files", o_L["MenuPopularMenusFiles"] . (blnAttached ? "" : "...")
			, (blnAttached ? o_L["MenuPopularMenusFiles"] : "")
			, "PopularFilesMenuShortcut", "1-Featured~2-DynamicMenus"
			, L(o_L["MenuPopularMenusDescription"], Format("{:U}", o_L["MenuPopularFiles"])), 0, "iconFavorites", ""
			, "what-is-in-the-works-and-its-frequent-recent-and-current-menus")
		this.AddQAPFeatureObject("Drives", o_L["MenuDrives"] . (blnAttached ? "" : "...")
			, (blnAttached ? o_L["MenuDrives"] : ""
			, "what-are-these-features-in-the-my-qap-essentials-menu")
			, "DrivesMenuShortcut", "2-DynamicMenus~5-WindowsFeature"
			, o_L["MenuDrivesDescription"], 0, "iconDrives", "+^d"
			, "can-i-display-the-drives-recent-folders-and-recent-files-menus-attached-to-the-popup-menu")
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	AddQAPFeatureObject(strQAPFeatureCode, strThisLocalizedName, strQAPFeatureMenuName, strQAPFeatureCommand, strQAPFeatureCategories
	, strQAPFeatureDescription, intQAPFeatureAlternativeOrder, strThisDefaultIcon, strDefaultShortcut, strHelpUrl)
	;
	; QAP Feature Objects (o_QAPfeatures.AA) definition:
	;		Key: strQAPFeatureInternalName
	;		Value: aaOneQAPFeature
	;
	; QAP Features Object (aaOneQAPFeature) definition:
	;		LocalizedName: QAP Feature localized label
	;		QAPFeatureMenuName: menu to be added to the menu (excluding the starting ":"), empty if no submenu associated to this QAP feature
	;		QAPFeatureCommand: command to be executed when this favorite is selected (excluding the ending ":")
	;		QAPFeatureCategories: one or many (tilde delimited) of 1-Featured|2-DynamicMenus|3-QAPMenuEditing|3.1-AddFavoriteOfType|4-WindowManagement|5-WindowsFeature|6-Utility|7-QAPManagement
	;		QAPFeatureAlternativeOrder: order of feature in the Alternative Menu displayed before user choose the target favorite (0 if not Alternative menu feature)
	;		DefaultIcon: default icon (in the "file,index" format)
	;		DefaultShortcut: default feature hotkey (string like "+^s")
	;		HelpURL: help URL for Add/Edit favorite dialog bvox
	;---------------------------------------------------------
	{
		aaOneQAPFeature := Object()
		
		aaOneQAPFeature.strLocalizedName := strThisLocalizedName ; use as default value when adding QAP favorite, not to display name after (except for Alternative menus)
		aaOneQAPFeature.strDefaultIcon := strThisDefaultIcon
		aaOneQAPFeature.strQAPFeatureMenuName := strQAPFeatureMenuName
		aaOneQAPFeature.strQAPFeatureCommand := strQAPFeatureCommand
		aaOneQAPFeature.strQAPFeatureCategories := strQAPFeatureCategories
		aaOneQAPFeature.strQAPFeatureDescription := strQAPFeatureDescription
		aaOneQAPFeature.strQAPFeatureURL := strHelpUrl
		aaOneQAPFeature.intQAPFeatureAlternativeOrder := intQAPFeatureAlternativeOrder
		aaOneQAPFeature.strDefaultShortcut := strDefaultShortcut
		
		this.AA["{" . strQAPFeatureCode . "}"] := aaOneQAPFeature
		this.aaQAPFeaturesCodeByDefaultName[strThisLocalizedName] := "{" . strQAPFeatureCode . "}"
		this.aaQAPFeaturesDefaultNameByCode["{" . strQAPFeatureCode . "}"] := strThisLocalizedName
		if (intQAPFeatureAlternativeOrder)
			this.saQAPFeaturesAlternativeCodeByOrder[intQAPFeatureAlternativeOrder] := "{" . strQAPFeatureCode . "}"
	}
	;---------------------------------------------------------
}
;-------------------------------------------------------------

;-------------------------------------------------------------
class Favorites
/*
TODO
- move code inside FavoriteSelectTypeRadioButtonsChanged to class
*/
/*
FAVORITE TYPES REPLACED
- g_arrFavoriteTypes0...
- g_objFavoriteTypesLabels.Insert(g_arrFavoriteTypes%A_Index%, arrFavoriteTypesLabels%A_Index%)
- g_objFavoriteTypesLocationLabels.Insert(g_arrFavoriteTypes%A_Index%, arrFavoriteTypesLocationLabels%A_Index%)
- g_objFavoriteTypesLocationLabelsNoAmpersand.Insert(g_arrFavoriteTypes%A_Index%, arrFavoriteTypesLocationLabelsNoAmpersand%A_Index%)
- g_objFavoriteTypesHelp.Insert(g_arrFavoriteTypes%A_Index%, arrFavoriteTypesHelp%A_Index%)
- g_objFavoriteTypesShortNames.Insert(g_arrFavoriteTypes%A_Index%, arrFavoriteTypesShortNames%A_Index%)
*/
;-------------------------------------------------------------
{
	;---------------------------------------------------------
	__Call(function, parameters*)
	; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
	{
		funcRef := Func(funcName := this.__class "." function)
		if CheckParameters(funcRef, function, parameters*) ; if everything is good call the function, else return false
			return funcRef.(this, parameters*) ; everything is good
		else
			return
	}
	;---------------------------------------------------------

	static s_SA := Object()
	static s_saFavoriteTypesByName := Object()
	
	;---------------------------------------------------------
	__New()
	;---------------------------------------------------------
	{
		saFavoriteTypes := StrSplit("Folder|Document|Application|Special|URL|FTP|QAP|Menu|Group|X|K|B|Snippet|External|Text|WindowsApp", "|")
		saFavoriteTypesLabels := StrSplit(o_L.InsertAmpersandInString(o_L["DialogFavoriteTypesLabels"]), "|") ; insert ampersands in string
		saFavoriteTypesShortNames := StrSplit(o_L["DialogFavoriteTypesShortNames"], "|")
		saFavoriteTypesLocationLabels := StrSplit(o_L["DialogFavoriteTypesLocationLabels"], "|")
		saFavoriteTypesLocationLabelsNoAmpersand := StrSplit(o_L["DialogFavoriteTypesLabels"], "|")
		
		Loop, % saFavoriteTypes.Length()
		{
			this.s_SA[A_Index] := new Favorites.Type(saFavoriteTypes[A_Index], saFavoriteTypesLabels[A_Index], saFavoriteTypesShortNames[A_Index]
				, saFavoriteTypesLocationLabels[A_Index], saFavoriteTypesLocationLabelsNoAmpersand[A_Index], o_L["DialogFavoriteTypesHelp" . A_Index])
			this.s_saFavoriteTypesByName[saFavoriteTypes[A_Index]] := this.s_SA[A_Index]
		}
	}
	;---------------------------------------------------------
	
	;---------------------------------------------------------
	GetFavoriteTypeObject(strTypeSystemName)
	;---------------------------------------------------------
	{
		return this.s_saFavoriteTypesByName[strTypeSystemName]
	}
	;---------------------------------------------------------
	
	;---------------------------------------------------------
	class Type
	;---------------------------------------------------------
	{
		;---------------------------------------------------------
		__Call(function, parameters*)
		; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
		{
			funcRef := Func(funcName := this.__class "." function)
			if CheckParameters(funcRef, function, parameters*) ; if everything is good call the function, else return false
				return funcRef.(this, parameters*) ; everything is good
			else
				return
		}
		;---------------------------------------------------------

		;-----------------------------------------------------
		__New(strThisSystemName, strThisLabel, strThisShortName, strThisLocationLabel, strThisLocationLabelNoAmpersand, strThisHelp)
		;-----------------------------------------------------
		{
			this.strFavoriteTypeSystemName := strThisSystemName
			this.strFavoriteTypeLabel := strThisLabel
			this.strFavoriteTypeShortName := strThisShortName
			this.strFavoriteTypeLocationLabel := strThisLocationLabel
			this.strFavoriteTypeLocationLabelNoAmpersand := strThisLocationLabelNoAmpersand
			
			if (strThisSystemName = "QAP")
				this.strFavoriteTypeHelp := L(strThisHelp, o_L["MenuSwitchFolderOrApp"], o_L["MenuRecentFolders"], o_L["MenuCurrentFolders"], o_L["MenuClipboard"], o_L["MenuAddThisFolder"])
			else if (strThisSystemName = "Application")
				this.strFavoriteTypeHelp := strThisHelp . "`n`n" . o_L["DialogFavoriteTypeNoteApplication"]
			else if (strThisSystemName = "WindowsApp")
				this.strFavoriteTypeHelp := strThisHelp . "`n`n" . o_L["DialogFavoriteTypeNoteWindowsApps"]
			else
				this.strFavoriteTypeHelp := strThisHelp
		}
		;-----------------------------------------------------
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	class Folder
	;---------------------------------------------------------
	{
		;-----------------------------------------------------
		__New()
		;-----------------------------------------------------
		{
		}
		;-----------------------------------------------------
		
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	class Document
	;---------------------------------------------------------
	{
		;-----------------------------------------------------
		__New()
		;-----------------------------------------------------
		{
		}
		;-----------------------------------------------------
		
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	class Application
	;---------------------------------------------------------
	{
		;-----------------------------------------------------
		__New()
		;-----------------------------------------------------
		{
		}
		;-----------------------------------------------------
		
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	class Special
	;---------------------------------------------------------
	{
		;-----------------------------------------------------
		__New()
		;-----------------------------------------------------
		{
		}
		;-----------------------------------------------------
		
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	class URL
	;---------------------------------------------------------
	{
		;-----------------------------------------------------
		__New()
		;-----------------------------------------------------
		{
		}
		;-----------------------------------------------------
		
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	class FTP
	;---------------------------------------------------------
	{
		;-----------------------------------------------------
		__New()
		;-----------------------------------------------------
		{
		}
		;-----------------------------------------------------
		
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	class QAP
	;---------------------------------------------------------
	{
		;-----------------------------------------------------
		__New()
		;-----------------------------------------------------
		{
		}
		;-----------------------------------------------------
		
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	class Menu
	;---------------------------------------------------------
	{
		;-----------------------------------------------------
		__New()
		;-----------------------------------------------------
		{
		}
		;-----------------------------------------------------
		
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	class Group
	;---------------------------------------------------------
	{
		;-----------------------------------------------------
		__New()
		;-----------------------------------------------------
		{
		}
		;-----------------------------------------------------
		
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	class X
	;---------------------------------------------------------
	{
		;-----------------------------------------------------
		__New()
		;-----------------------------------------------------
		{
		}
		;-----------------------------------------------------
		
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	class K
	;---------------------------------------------------------
	{
		;-----------------------------------------------------
		__New()
		;-----------------------------------------------------
		{
		}
		;-----------------------------------------------------
		
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	class B
	;---------------------------------------------------------
	{
		;-----------------------------------------------------
		__New()
		;-----------------------------------------------------
		{
		}
		;-----------------------------------------------------
		
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	class Snippet
	;---------------------------------------------------------
	{
		;-----------------------------------------------------
		__New()
		;-----------------------------------------------------
		{
		}
		;-----------------------------------------------------
		
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	class External
	;---------------------------------------------------------
	{
		;-----------------------------------------------------
		__New()
		;-----------------------------------------------------
		{
		}
		;-----------------------------------------------------
		
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	class Text
	;---------------------------------------------------------
	{
		;-----------------------------------------------------
		__New()
		;-----------------------------------------------------
		{
		}
		;-----------------------------------------------------
		
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	class WindowsApp
	;---------------------------------------------------------
	{
		;-----------------------------------------------------
		__New()
		;-----------------------------------------------------
		{
		}
		;-----------------------------------------------------
		
	}
	;---------------------------------------------------------

}
;-------------------------------------------------------------

;-------------------------------------------------------------
class Settings
/*
TODO
*/
;-------------------------------------------------------------
{
	;---------------------------------------------------------
	__Call(function, parameters*)
	; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
	{
		funcRef := Func(funcName := this.__class "." function)
		if CheckParameters(funcRef, function, parameters*) ; if everything is good call the function, else return false
			return funcRef.(this, parameters*) ; everything is good
		else
			return
	}
	;---------------------------------------------------------

	aaGroupItems := Object()
	saOptionsGroups := Object()
	saOptionsGroupsLabelNames := Object()
	
	;---------------------------------------------------------
	__New()
	;---------------------------------------------------------
	{
		this.strIniFile := A_WorkingDir . "\" . g_strAppNameFile . ".ini" ; value changed when reading external ini files
		this.strIniFileDefault := this.strIniFile

		this.saOptionsGroups := ["General", "SettingsWindow", "MenuIcons", "MenuAppearance"
			, "PopupMenu", "PopupHotkeys", "PopupHotkeysAlternative", "FileManagers"
			, "Snippets", "UserVariables", "Database"
			, "MenuAdvanced", "AdvancedLaunch", "AdvancedOther"]
			
; /* #### UNCOMMENT TO TEST WITH NORMAL SETTINGS FILE NAME
		; Set developement ini file
;@Ahk2Exe-IgnoreBegin
		; Start of code for developement environment only - won't be compiled
		if (A_ComputerName = "JEAN-PC") ; for my home PC
			this.strIniFile := A_WorkingDir . "\" . g_strAppNameFile . "-HOME.ini"
		else if InStr(A_ComputerName, "ELITEBOOK-JEAN") ; for my work hotkeys
			this.strIniFile := A_WorkingDir . "\" . g_strAppNameFile . "-WORK.ini"
		; / End of code for developement environment only - won't be compiled
;@Ahk2Exe-IgnoreEnd
; */ ; #### UNCOMMENT TO TEST WITH NORMAL SETTINGS FILE NAME

		; set file name used for Edit settings label
		SplitPath, % this.strIniFile, strIniFileNameExtOnly
		this.strIniFileNameExtOnly := strIniFileNameExtOnly
		
		; at first launch quickaccesspopup.ini does not exist, read language value in quickaccesspopup-setup.ini (if exist) created by Setup
		this.ReadIniOption("Launch", "strLanguageCode", "LanguageCode", "EN", "General", "f_drpLanguage|f_lblLanguage", "Global"
			, (FileExist(this.strIniFile) ? this.strIniFile : A_WorkingDir . "\" . g_strAppNameFile . "-setup.ini"))
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	InitOptionsGroupsLabelNames()
	; called after o_L is initialized
	;---------------------------------------------------------
	{
		this.saOptionsGroupsLabelNames := ["OptionsGeneral", "OptionsSettingsWindow", "OptionsMenuIcons", "OptionsMenuAppearance"
			, "OptionsPopupMenu", "OptionsPopupHotkeys", "OptionsPopupHotkeysAlternative", "OptionsFileManagers"
			, "OptionsSnippets", "OptionsUserVariables", "OptionsDatabase"
			, "OptionsMenuAdvanced", "OptionsAdvancedLaunch", "OptionsAdvancedOther"]
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	ReadIniOption(strOptionGroup, strSettingName, strIniValueName, strDefault := "", strGuiGroup := "", strGuiControls := "", strSection := "Global", strIniFile := "")
	;---------------------------------------------------------
	{
		if !IsObject(this[strOptionGroup])
			this[strOptionGroup] := Object()
		if !IsObject(this.aaGroupItems[strGuiGroup])
			this.aaGroupItems[strGuiGroup] := Object()
		
		if StrLen(strIniValueName) ; for exception f_blnOptionsRunAtStartup having no ini value, but a control in Options gui
			strOutValue := this.ReadIniValue(strIniValueName, strDefault, strSection, strIniFile)
		
		if (strSettingName = "strExclusionMouseList") ; exception for additional values
			oIniValue := new this.IniValueExclusionMouseList(strIniValueName, strOutValue, strGuiGroup, strGuiControls, strSection, strIniFile)
		else
			oIniValue := new this.IniValue(strIniValueName, strOutValue, strGuiGroup, strGuiControls, strSection, strIniFile)
		
		this[strOptionGroup][strSettingName] := oIniValue
		this.aaGroupItems[strGuiGroup].Push(oIniValue)
		
		return oIniValue.IniValue
		; ###_O("this", this)
		; ###_O("this[strOptionGroup][strSettingName]", this[strOptionGroup][strSettingName])
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	ReadIniValue(strIniValueName, strDefault := "", strSection := "Global", strIniFile := "")
	;---------------------------------------------------------
	{
		IniRead, strOutValue, % (StrLen(strIniFile) ? strIniFile : this.strIniFile), %strSection%, %strIniValueName%, %strDefault%
		; ###_V(A_ThisFunc, strIniValueName, "|" . strDefault . "|", strSection, strIniFile, this.strIniFile, strOutValue)
		return strOutValue
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	class IniValue
	;---------------------------------------------------------
	{
		;---------------------------------------------------------
		; ### to disabe validation because validation does not support exteneded class IniValueExclusionMouseList
		###__Call(function, parameters*)
		; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
		{
			funcRef := Func(funcName := this.__class "." function)
			if CheckParameters(funcRef, function, parameters*) ; if everything is good call the function, else return false
				return funcRef.(this, parameters*) ; everything is good
			else
				return
		}
		;---------------------------------------------------------

		;-----------------------------------------------------
		__New(strIniValueName, strIniValue, strGuiGroup, strGuiControls, strSection, strIniFile)
		;-----------------------------------------------------
		{
			this.IniValue := strIniValue
			this.strGuiGroup := strGuiGroup
			this.strGuiControls := strGuiControls
			this.strIniFile := strIniFile
			this.strIniValueName := strIniValueName
			this.strSection := strSection
		}
		;-----------------------------------------------------
		
		;-----------------------------------------------------
		WriteIni(varNewValue := "", blnDoNotSave := false)
		; update the IniValue if a value is provides and write it to ini file (Global section of the main ini file only)
		;-----------------------------------------------------
		{
			if !(blnDoNotSave)
				this.IniValue := varNewValue
			IniWrite, % this.IniValue, % (StrLen(this.strIniFile) ? this.strIniFile : o_Settings.strIniFile)
				, % (StrLen(this.strSection) ? this.strSection : "Global"), % this.strIniValueName
		}
		;-----------------------------------------------------
	}
	;---------------------------------------------------------
	
	;---------------------------------------------------------
	BackupIniFile(strIniFile, blnIsExternal := false)
	; call as base class function Settings.BackupIniFile() only, not as an instance method
	; (because various ini files are not instances of this class - could be done later)
	;---------------------------------------------------------
	{
		SplitPath, strIniFile, strIniFileFilename, strIniFileFolder
		
		strThisBackupFolder := o_Settings.ReadIniValue("BackupFolder", "", "Global", strIniFile) ; can be main ini file, alternative ini or external ini file backup folder
		if !StrLen(strThisBackupFolder) ; if no backup folder in ini file, backup in ini file's folder
			strThisBackupFolder := strIniFileFolder
		
		strThisBackupFolder := PathCombine(A_WorkingDir, EnvVars(strThisBackupFolder))
		
		; delete old backup files (keep only 5/10 most recent files)
		strIniBackupFile := strThisBackupFolder . "\" . StrReplace(strIniFileFilename, ".ini", "-backup-????????.ini")
		Loop, %strIniBackupFile%
			strFilesList .= A_LoopFileFullPath . "`n"
		Sort, strFilesList, R ; reverse alphabetical order - most recent first 
		intNumberOfBackups := (g_strCurrentBranch <> "prod" ? 10 : 5)
		Loop, Parse, strFilesList, `n
			if (A_Index > intNumberOfBackups)
				if StrLen(A_LoopField)
					FileDelete, %A_LoopField%

		; create a daily backup of the ini file
		strIniBackupFile := StrReplace(strIniBackupFile, "????????", SubStr(A_Now, 1, 8))
		; always keep the most recent backup for a given day
		FileCopy, %strIniFile%, %strIniBackupFile%, 1
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	class IniValueExclusionMouseList extends Settings.IniValue
	;---------------------------------------------------------
	{
		;---------------------------------------------------------
		; ### to disabe validation because validation does not support exteneded class IniValueExclusionMouseList
		###__Call(function, parameters*)
		; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
		{
			funcRef := Func(funcName := this.__class "." function)
			if CheckParameters(funcRef, function, parameters*) ; if everything is good call the function, else return false
				return funcRef.(this, parameters*) ; everything is good
			else
				return
		}
		;---------------------------------------------------------

		;-----------------------------------------------------
		SplitExclusionList()
		;-----------------------------------------------------
		{
			strExclusionMouseListDialogIndicator := "*"
			
			this.strExclusionMouseListApp := ""
			this.strExclusionMouseListDialog := ""
			
			Loop, Parse, % this.IniValue, |
				if (SubStr(A_LoopField, 1, 1) = strExclusionMouseListDialogIndicator) and (StrLen(A_LoopField) > 2)
				; strExclusionMouseListDialogIndicator ("*") tells to check this exclusion also in app's dialog boxes, and we have something after the indicator
				{
					this.strExclusionMouseListApp .= Trim(SubStr(A_LoopField, 2)) . "|"
					this.strExclusionMouseListDialog .= Trim(SubStr(A_LoopField, 2)) . "|"
				}
				else if StrLen(A_LoopField)
					this.strExclusionMouseListApp .= Trim(A_LoopField) . "|"
		}
		;-----------------------------------------------------
	}
	;---------------------------------------------------------
}
;-------------------------------------------------------------

;-------------------------------------------------------------
class Language
/*
TODO
- adapt Settings for when setting language before quickaccesspopup.ini is created
  Regex: \bl[A-Z].*
- finish property LanguageCode (review all)
- switch language: save new language code to ini file and restart QAP
- adapt variables in QAP main script (no change done at this time)

*/
;-------------------------------------------------------------
{
	;---------------------------------------------------------
	__Call(function, parameters*)
	; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
	{
		funcRef := Func(funcName := this.__class "." function)
		if CheckParameters(funcRef, function, parameters*) ; if everything is good call the function, else return false
			return funcRef.(this, parameters*) ; everything is good
		else
			return
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	__New()
	;---------------------------------------------------------
	{
		#Include %A_ScriptDir%\QuickAccessPopup_LANG.ahk
		
		this.LanguageCode := o_Settings.Launch.strLanguageCode.IniValue
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	LanguageCode[]
	;---------------------------------------------------------
	{
		Set
		{
			; check if we have a testing language file
			strDebugLanguageFile := A_WorkingDir . "\" . g_strAppNameFile . "_LANG_ZZ.txt"
			if FileExist(strDebugLanguageFile)
			{
				strLanguageFile := strDebugLanguageFile
				this._LanguageCode := "EN"
			}
			else
			{
				strLanguageFile := (value = "EN" ? "" : g_strTempDir . "\" . g_strAppNameFile . "_LANG_" . value . ".txt")
				
				; if localized language file does not exists, keep "EN" language code and existing EN values
				this._LanguageCode := (FileExist(strLanguageFile) ? value : "EN")
			}
			
			if StrLen(strLanguageFile) and FileExist(strLanguageFile) ; we have an existing localized language file
			{
				strReplacementForSemicolon := g_strEscapeReplacement ; for non-comment semi-colons ";" escaped as ";;"
				
				FileRead, strLanguageStrings, %strLanguageFile%
				
				Loop, Parse, strLanguageStrings, `n, `r
				{
					if (SubStr(A_LoopField, 1, 1) <> ";") ; skip comment lines
					{
						saLanguageBit := StrSplit(A_LoopField, "`t")
						; ###_O("saLanguageBit-1", saLanguageBit)
						if SubStr(saLanguageBit[1], 1, 1) <> "l"
							continue
						else
							saLanguageBit[1] := SubStr(saLanguageBit[1], 2) ; remove leading "l" from language files variable names
						this[saLanguageBit[1]] := saLanguageBit[2]
						this[saLanguageBit[1]] := StrReplace(this[saLanguageBit[1]], "``n", "`n")
						
						if InStr(this[saLanguageBit[1]], ";;") ; preserve escaped ; in string
							this[saLanguageBit[1]] := StrReplace(this[saLanguageBit[1]], ";;", strReplacementForSemicolon)
						; ###_V("1", saLanguageBit[1], saLanguageBit[2], this[saLanguageBit[1]])
						if InStr(this[saLanguageBit[1]], ";")
							this[saLanguageBit[1]] := Trim(SubStr(this[saLanguageBit[1]], 1, InStr(this[saLanguageBit[1]], ";") - 1)) ; trim comment from ; and trim spaces and tabs
						; ###_V("2", saLanguageBit[1], saLanguageBit[2], this[saLanguageBit[1]])
						if InStr(this[saLanguageBit[1]], strReplacementForSemicolon) ; restore escaped ; in string
							this[saLanguageBit[1]] := StrReplace(this[saLanguageBit[1]], strReplacementForSemicolon, ";")
						; ###_V("3", saLanguageBit[1], saLanguageBit[2], this[saLanguageBit[1]])
						; ###_O("this", this)
					}
				}
			}
		; save strCode to ini
		; if changed need to restart?
		}
		
		Get
		{
			return this._LanguageCode
		}
	}
	;---------------------------------------------------------
	
	;---------------------------------------------------------
	InsertAmpersand(blnAddNumericShortcut, saIn*)
	; if first item starts with "*", it is a list of pre-used letters
	;---------------------------------------------------------
	{
		saContentCleaned := Object() ; contains only letters that can be used as shortcuts (this also excludes "~n~")
		aaOut := Object()
		
		if (SubStr(saIn[1], 1, 1) = "*") ; this is already used letters in strUsed
			aaOut.strUsed := SubStr(saIn.RemoveAt(1), 2) ; remove leading "*"
		; sort items to process first the shortest labels (those with the least valid shortcut chars)
		Loop, % saIn.MaxIndex()
		{
			saContentCleaned[A_Index] := RegExReplace(o_L[saIn[A_Index]], "[^a-zA-Z]", "")
			; strSort line: 1) length, 2) aa o_L index, 3) saContentCleaned index
			strSort .= StrLen(saContentCleaned[A_Index]) . "|" . saIn[A_Index] . "|" . A_Index . "`n"
		}
		
		strSort := SubStr(strSort, 1, -1)
		Sort, strSort, N
		saSorted := StrSplit(strSort, "`n")
		
		for intKey, strThisStr in saSorted
		{
			saThisStr := StrSplit(strThisStr, "|")
			aaOut[saThisStr[2]] := o_L[saThisStr[2]] ; backup will be replaced if a letter can be used
			if (o_Settings.Menu.blnDisplayNumericShortcuts.IniValue and blnAddNumericShortcut) ; insert ampersand for numeric shortcuts
			{
				Container.s_intMenuShortcutNumber := saThisStr[3] - 1
				aaOut[saThisStr[2]] := Container.MenuNameWithNumericShortcut(aaOut[saThisStr[2]])
			}
			else ; insert ampersand in menu name
				Loop, Parse, % saContentCleaned[saThisStr[3]] ; scan available letters in label 
				{
					if !InStr(aaOut.strUsed, A_LoopField) ; not case sensitive by default
					{
						aaOut.strUsed .= A_LoopField ; use this letter for this label
						aaOut[saThisStr[2]] := StrReplace(o_L[saThisStr[2]], A_LoopField, "&" . A_LoopField, , 1)
						break
					}
				}
		}
		
		return aaOut
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	InsertAmpersandInString(strIn)
	; strIn and strOut delimited with "|"
	; (this is based on InsertAmpersand but adapted to process the favorite types labels string and avoid having to refactor how these labels are managed)
	;---------------------------------------------------------
	{
		saContentCleaned := Object() ; contains only letters that can be used as shortcuts (this also excludes "~n~")
		saOut := Object()
		
		; sort items to process first the shortest labels (those with the least valid shortcut chars)
		Loop, Parse, strIn, |
		{
			strCleaned := RegExReplace(A_LoopField, "[^a-zA-Z]", "")
			; strSort line: 1) length, 2) cleaned string, 3) original string
			strSort .= StrLen(strCleaned) . "|" . strCleaned . "|" . A_Index . "|" . A_LoopField . "`n"
		}
		
		strSort := SubStr(strSort, 1, -1)
		Sort, strSort, N
		saSorted := StrSplit(strSort, "`n")
		
		for intKey, strThisStr in saSorted
		{
			; ###_O("saOut", saOut)
			saThisStr := StrSplit(strThisStr, "|")
			; ###_V(A_ThisFunc, saThisStr[1], saThisStr[2], saThisStr[3], saThisStr[4])
			saOut[saThisStr[3]] := saThisStr[4] ; backup will be replaced if a letter can be used
			Loop, Parse, % saThisStr[2] ; scan available letters in label 
			{
				if !InStr(strUsed, A_LoopField) ; not case sensitive by default
				{
					strUsed .= A_LoopField ; use this letter for this label
					saOut[saThisStr[3]] := StrReplace(saThisStr[4], A_LoopField, "&" . A_LoopField, , 1)
					break
				}
			}
		}
		
		for intKey, strValue in saOut
			strOut .= strValue . "|"
		strOut := SubStr(strOut, 1, -1)

		; ###_V("strOut", strOut)
		return strOut
	}
	;---------------------------------------------------------
}
;-------------------------------------------------------------

;-------------------------------------------------------------
class Containers
;-------------------------------------------------------------
{
	AA := Object() ; replace g_objMenusIndex, associative array of menus path used in Gui menu dropdown list and to access the menu object for a given menu path
	
	;---------------------------------------------------------
	__Call(function, parameters*)
	; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
	{
		funcRef := Func(funcName := this.__class "." function)
		if CheckParameters(funcRef, function, parameters*) ; if everything is good call the function, else return false
			return funcRef.(this, parameters*) ; everything is good
		else
			return
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	__New()
	;---------------------------------------------------------
	{
		; not required
	}
	;---------------------------------------------------------
}
;-------------------------------------------------------------

;---------------------------------------------------------
class Container
;---------------------------------------------------------
{
	AA := Object() ; associative array for container's properties
	SA := Object() ; simple array for container's items
	
	static s_intMenuShortcutNumber
	
	;---------------------------------------------------------
	###__Call(function, parameters*)
	; Disable because it breaks ByRef in FavoriteIsUnderExternalMenu(ByRef oExternalMenu)
	; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
	{
		funcRef := Func(funcName := this.__class "." function)
		if CheckParameters(funcRef, function, parameters*) ; if everything is good call the function, else return false
			return funcRef.(this, parameters*) ; everything is good
		else
			return
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	__New(strType, strContainerName, oParentMenu := "", strAction := "init", blnDynamic := false)
	;---------------------------------------------------------
	{
		this.AA.strMenuType := strType ; "Menu", "Group" or "External" ("Menu" can include any type of favorite and submenus, "Group" can contain only some favorite types and no submenu)
		this.AA.blnMenuDynamic := blnDynamic ; when building menu, replace "&" with "&&" in dynamic menus only
		if (oParentMenu)
		{
			; path from main menu to the current submenus, delimited with " > " (see constant g_strMenuPathSeparator), example: "Main > Sub1 > Sub1.1"
			if SubStr(strContainerName, 1, StrLen(o_L["MainMenuName"])) = o_L["MainMenuName"] ; strContainerName is already fully formed (when creating a backup or restore)
				this.AA.strMenuPath := strContainerName
			else
				this.AA.strMenuPath := oParentMenu.AA.strMenuPath . g_strMenuPathSeparatorWithSpaces . strContainerName
					. (strType = "Group" ? " " . g_strGroupIndicatorPrefix . g_strGroupIndicatorSuffix : "")
			this.AA.strParentMenuLabel := BetweenParenthesis(GetDeepestMenuPath(oParentMenu.AA.strMenuPath))
			this.AA.oParentMenu := oParentMenu
		}		
		else
		{
			this.AA.strMenuPath := strContainerName ; for MainMenuName, DOpusMenuName, TCMenuName and other dynamic menus: name as-is, no separator before
			
			if (strAction = "init" and strContainerName <> o_L["MainMenuName"]) ; ???
			{
				Menu, %strContainerName%, Add 
				Menu, %strContainerName%, DeleteAll
				if (g_blnUseColors)
					Menu, %strContainerName%, Color, %g_strMenuBackgroundColor%
				strMenuItemLabel := (strContainerName = o_L["MenuClipboard"] ?  o_L["MenuClipboardNoContent"] : o_L["DialogNone"])
				this.AddMenuIcon(strMenuItemLabel, "GuiShowNeverCalled", "iconNoContent", false) ; will never be called because disabled
				this.AddCloseMenu()
			}
		}
		
		if (strAction = "init") ; avoid updating containers index when creating a backup of the menu objects
			o_Containers.AA[this.AA.strMenuPath] := this
	}
	;---------------------------------------------------------
	
	;---------------------------------------------------------
	Backup()
	; copy of associative array AA and simple array SA to another object of class Container
	;---------------------------------------------------------
	{
		oCopy := new Container(this.AA.strMenuType, this.AA.strMenuPath
			, (this.AA.strMenuPath = o_L["MainMenuName"] ? "" : this.AA.oParentMenu) ; no parent for Main menu
			, "backup") ; pass action to avoid re-creating menu or updating o_Containers index when creating backup
		
		for strKey, varValue in this.AA
			oCopy.AA[strKey] := varValue
		
		for intKey, oItem in this.SA
		{
			oCopy.SA[intKey] := oItem.Backup()
			if oItem.IsContainer()
				oCopy.SA[intKey].AA.oSubMenu := oItem.AA.oSubMenu.Backup() ; recursive
		}
			
		return oCopy
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	RestoreContainersIndex()
	; update containers index with restored containers
	;---------------------------------------------------------
	{
		o_Containers.AA[this.AA.strMenuPath] := this
		
		for intKey, oItem in this.SA
			if oItem.IsContainer()
				oItem.AA.oSubMenu.RestoreContainersIndex() ; recursive
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	LoadFavoritesFromTable(saMenuItemsTable)
	; load items in saMenuItemsTable to a simple Container object having no submenu
	; saMenuItemsTable is an simple-array object of simple array objects saFavorite for each favorite to load
			; saFavorite:
			; 1 strFavoriteType, 2 strFavoriteName, 3 strFavoriteLocation, 4 strFavoriteIconResource, 5 strFavoriteArguments, 6 strFavoriteAppWorkingDir,
			; 7 strFavoriteWindowPosition, (X strFavoriteHotkey), 8 strFavoriteLaunchWith, 9 strFavoriteLoginName, 10 strFavoritePassword,
			; 11 strFavoriteGroupSettings, 12 blnFavoriteFtpEncoding, 13 blnFavoriteElevate, 14 blnFavoriteDisabled,
			; 15 intFavoriteFolderLiveLevels, 16 blnFavoriteFolderLiveDocuments, 17 intFavoriteFolderLiveColumns, 18 blnFavoriteFolderLiveIncludeExclude, 19 strFavoriteFolderLiveExtensions
			; 20 strFavoriteShortcut, 21 strFavoriteHotstring, 22 strFavoriteFolderLiveSort, 23 strFavoriteSoundLocation
			; 24 strFavoriteDateCreated, 25 strFavoriteDateModified, 26 intFavoriteUsageDb
	;---------------------------------------------------------
	{
		this.SA := Object() ; re-init
		Loop, % saMenuItemsTable.MaxIndex()
		{
			; create new item and add it to the container
			oNewItem := new this.Item(saMenuItemsTable[A_Index], this)
			this.SA.Push(oNewItem) ; add to the current container object
		}
	}
	;---------------------------------------------------------
	
	;---------------------------------------------------------
	LoadFavoritesFromIniFile(blnWorkingToolTip := false, blnRefreshExternal := false, blnEntryMenu := true)
	; return "EOM" if no error (or managed external file error) or "EOF" if end of file not expected error
	;---------------------------------------------------------
	{
		this.SA := Object() ; re-init
		
		static s_intIniLineLoad := 1
		static s_strIniFile
		
		if (blnEntryMenu) ; do not pass this value when recursing
			s_intIniLineLoad := 1
		
		if (blnRefreshExternal) ; do not pass this value when recursing
		{
			s_strIniFile := this.AA.strMenuExternalSettingsPath
			this.AA.blnNeedSave := false
		}
		
		if !StrLen(s_strIniFile)
			s_strIniFile := o_Settings.strIniFile
		
		if (blnWorkingToolTip)
			ToolTip, % o_L["ToolTipLoading"] . "`n" . this.AA.strMenuPath
		
		if (this.AA.strMenuType = "External")
		{
			if !FileExist(s_strIniFile)
			{
				this.AA.blnMenuExternalLoaded := false ; true if the external menu was loaded, false if not loaded (or not an external menu)
				strExternalErrorMessageExclusions := o_Settings.ReadIniValue("ExternalErrorMessageExclusions", " ", "Global", o_Settings.strIniFile) ; not documented, internal use only
				if !InStr(strExternalErrorMessageExclusions, s_strIniFile)
				{
					MsgBox, 52, %g_strAppNameText%, % o_L["OopsErrorIniFileUnavailable"] . ":`n`n" . s_strIniFile
						. "`n`n" . L(o_L["OopsErrorIniFileRetry"], g_strAppNameText)
						. "`n`n" . o_L["OopsErrorIniFileDisplayErrorMessage"]
					IfMsgBox, No
						IniWrite, % strExternalErrorMessageExclusions . s_strIniFile . "|", % o_Settings.strIniFile, Global, ExternalErrorMessageExclusions
				}
				return, "EOM" ; end of menu because of known error (external settings file unavailable) - error is noted in .MenuExternalLoaded false - external menu will be empty
			}
			
			this.AA.strMenuExternalSettingsPath := s_strIniFile
			; instead of FileGetTime, read last modified date from [Global] value updated only when content is changed
			; FileGetTime, strLastModified, % objNewMenu.MenuExternalSettingsPath, M ; modified date
			strLastModified := o_Settings.ReadIniValue("LastModified", " ", "Global", this.AA.strMenuExternalSettingsPath)
			blnLastModifiedFromNetworkOrCoud := o_Settings.ReadIniValue("LastModifiedFromSystem", " ", "Global", this.AA.strMenuExternalSettingsPath)
			; ###_V(A_ThisFunc, strLastModified, blnLastModifiedFromNetworkOrCoud)
			this.AA.strMenuExternalLastModifiedWhenLoaded := strLastModified
			this.AA.strMenuExternalLastModifiedNow := strLastModified
			this.AA.strMenuExternalLastModifiedFromNetworkOrCoud := blnLastModifiedFromNetworkOrCoud
			
			; if this menu is already locked by this user (because something unexpected happened and the lock was not released previously), unlock it immediately
			strMenuExternalReservedBy := o_Settings.ReadIniValue("MenuReservedBy", " ", "Global", this.AA.strMenuExternalSettingsPath)
			if (strMenuExternalReservedBy = A_UserName . " (" . A_ComputerName . ")")
				IniWrite, % "", % this.AA.strMenuExternalSettingsPath, Global, MenuReservedBy
		}
		
		Loop
		{
			strLoadIniLine := o_Settings.ReadIniValue("Favorite" . s_intIniLineLoad, "", "Favorites", s_strIniFile)
			s_intIniLineLoad++
			
			if (strLoadIniLine = "ERROR")
			{
				Oops(o_L["OopsErrorReadingIniFile"] . "`n`n" . s_strIniFile . "`nFavorite" . s_intIniLineLoad . "=")
				if (this.AA.strMenuType = "External")
				{
					this.AA.blnMenuExternalLoaded := false
					return, "EOM" ; end of menu because of error inside settings file - error is noted in .MenuExternalLoaded false - external menu will stop at the previous favorite
				}
				else
					Return, "EOF" ; end of file - an unknown error occurred while reading the ini file - menu loading will be aborted
			}
			else if (this.AA.strMenuType = "External")
				this.AA.blnMenuExternalLoaded := true
			
			saThisFavorite := StrSplit(strLoadIniLine, "|")
			
			if (saThisFavorite[1] = "Z")
				; container loaded without error
				return "EOM" ; end of menu
				
			else if InStr("|Menu|Group|External", "|" . saThisFavorite[1], true) ; begin a submenu / case sensitive because type X is included in External ...
			{
				if (saThisFavorite[1] = "External")
				{
					intPreviousIniLine := s_intIniLineLoad
					strPreviousIniFile := s_strIniFile
					s_intIniLineLoad := saThisFavorite[11] ; FavoriteGroupSettings, starting number - DEPRECATED since v8.1.9.1
					if !StrLen(s_intIniLineLoad)
						s_intIniLineLoad := 1 ; always 1 for menu added since v8.1.9.1
					s_strIniFile := PathCombine(A_WorkingDir, EnvVars(saThisFavorite[6]))
				}
				
				; load the submenu
				oNewSubMenu := new Container(saThisFavorite[1], saThisFavorite[2], this)
				
				if (oNewSubMenu.AA.strMenuType = "Group")
					oNewSubMenu.AA.strFavoriteGroupSettings := saThisFavorite[11]

				strResult := oNewSubMenu.LoadFavoritesFromIniFile(blnWorkingToolTip, false, false) ; RECURSIVE, 2nd param false not external root, 3rd param false non entry menu
				
				if (saThisFavorite[1] = "External")
				{
					s_intIniLineLoad := intPreviousIniLine
					s_strIniFile := strPreviousIniFile
				}
				
				if (strResult = "EOF") ; end of file was encountered while building this submenu, exit recursive function
					Return, %strResult%
			}
			
			; create new item and add it to the container
			oNewItem := new this.Item(saThisFavorite, this)
			if oNewItem.IsContainer() ; this is a submenu favorite
			{
				oNewItem.AA.oSubMenu := oNewSubMenu ; link to the submenu object
				oNewItem.AA.strFavoriteLocation := saThisFavorite[3] ; update location with container path
			}
			; else because group items cannot also be container
			else if (this.AA.strMenuType = "Group")
			{
				; 1 boolean value (replace existing Explorer windows if true, add to existing Explorer Windows if false)
				; 2 restore folders with "Windows Explorer" or "Other" (Directory Opus, Total Commander or FPconnect)
				; 3 delay in milliseconds to insert between each favorite to restore
				saTemp := StrSplit(this.AA.strFavoriteGroupSettings, ",")
				oNewItem.AA.blnGroupReplaceWindows := saTemp[1]
				oNewItem.AA.strGroupRestoreWithExplorerOrOther := saTemp[2]
				oNewItem.AA.intGroupRestoringDelay := saTemp[3]
				
				oNewItem.AA.blnFavoritePseudo := true
				oNewItem.AA.blnIsGroupMember := true
			}
			this.SA.Push(oNewItem) ; add to the current container object
		}
	}
	;---------------------------------------------------------
	
	;---------------------------------------------------------
	LoadTCFavoritesFromIniFile(strIniFile)
	;---------------------------------------------------------
	{
		this.SA := Object() ; re-init
		
		static s_intIniLineLoadTC := 1
		
		Loop
		{
			strWinCmdItemName := o_Settings.ReadIniValue("menu" . s_intIniLineLoadTC, "", "DirMenu", strIniFile)
			if (strWinCmdItemName = "ERROR")
				Return, "EOM" ; end of DirMenu section (there is no marker for end of DirMenu section)
				
			strWinCmdItemCommand := o_Settings.ReadIniValue("cmd" . s_intIniLineLoadTC, " ", "DirMenu", strIniFile) ; empty by default
			s_intIniLineLoadTC++
			
			if (strWinCmdItemName = "--")
				return, "EOM" ; end of menu
		
			blnItemIsMenu := SubStr(strWinCmdItemName, 1, 1) = "-" and StrLen(strWinCmdItemName) > 1 ; begin a submenu "-MenuName", not "-"
			
			if (blnItemIsMenu)
			{
				strWinCmdItemName := SubStr(strWinCmdItemName, 2)
				oNewSubMenu := new Container("Menu", strWinCmdItemName, this)
				oNewSubMenu.LoadTCFavoritesFromIniFile(strIniFile) ; RECURSIVE
			}
			else if (SubStr(strWinCmdItemCommand, 1, 3) <> "cd ")
				
				continue ; not a menu and not a change directory command (folder)
			
			saThisFavorite := Object() ; insert TC item values in standard QAP item values object
			if (strWinCmdItemName = "-") ; menu separator
				saThisFavorite[1] := "X" ; FavoriteType
			else
			{
				saThisFavorite[1] := (blnItemIsMenu ? "Menu" : "Folder") ; FavoriteType
				saThisFavorite[2] := strWinCmdItemName ; FavoriteName
				if !(blnItemIsMenu)
					saThisFavorite[3] := StrReplace(strWinCmdItemCommand, "cd ", "") ; FavoriteLocation
				if (SubStr(saThisFavorite[3], 1, 2) = "::")
				{
					saThisFavorite[1] := "Special" ; FavoriteType
					saThisFavorite[3] := SubStr(saThisFavorite[3], 3) ; FavoriteLocation
					saThisFavorite[4] := o_SpecialFolders.AA[saThisFavorite[3]].DefaultIcon ; FavoriteIconResource
				}
			}
			
			oNewItem := new this.Item(saThisFavorite, this)
			if (blnItemIsMenu) ; this is a submenu favorite, link to the submenu object
				oNewItem.AA.oSubMenu := oNewSubMenu
			this.SA.Push(oNewItem) ; add to the current container object
		}
	}
	;---------------------------------------------------------

	;-----------------------------------------------------
	LoadDirectoryOpusFavoritesFromXML(strNodeXml := "")
	;-----------------------------------------------------
	{
		this.SA := Object() ; re-init
		
		if !StrLen(strNodeXml) ; first level only
		{
			FileRead, strNodeXml, % g_aaFileManagerDirectoryOpus.strDirectoryOpusFavoritesFile
		}

		xmlDirectoryOpusXML.XML.LoadXML(strNodeXml)
		
		xmlNodeAll := xmlDirectoryOpusXML.SN("/*/*") ; select all nodes
		while (xmlItem := xmlNodeAll.Item[A_Index-1])
		{
			xmlItemAttributes := xmlDirectoryOpusXML.EA(xmlItem)
				
			blnItemIsMenu := (xmlItem.NodeName = "folder") ; "folder" in DOpus XML is a submenu
				and StrLen(xmlItemAttributes.label) ; to skip "<folder><separator/></folder>"
			
			if (blnItemIsMenu)
			{
				oNewSubMenu := new Container("Menu", xmlItemAttributes.label, this)
				oNewSubMenu.LoadDirectoryOpusFavoritesFromXML(xmlItem.xml) ; RECURSIVE
			}
			
			saThisFavorite := Object() ; insert DOpus item values in standard QAP item values object
			if (!blnItemIsMenu and xmlItem.NodeName = "folder"
				and SSN(xmlItem, "descendant::separator").NodeName = "separator") ; this is "<folder><separator/></folder>"
				saThisFavorite[1] := "X" ; FavoriteType separator
			else ; menu or folder (what if unexpected node?)
			{
				saThisFavorite[1] := (blnItemIsMenu ? "Menu" : "Folder") ; FavoriteType
				saThisFavorite[2] := xmlItemAttributes.label ; FavoriteName
				
				if (SSN(xmlItem, "descendant::pathstring").NodeName = "pathstring")
				{
					saThisFavorite[3] := SSN(xmlItem, "descendant::pathstring").text ; FavoriteLocation
					saThisFavorite[4] := GetFolderIcon(objLoadDOpusFavorite.FavoriteLocation) ; FavoriteIconResource
				}
				else if (SSN(xmlItem, "descendant::pidl").NodeName = "pidl")
					; <path label="Ce PC">
						; <dir>
							; <pidl>?AAAAFAAfUOBP0CDqOmkQotgIACswMJ0AAA==</pidl>
						; </dir>
					; </path>
				{
					saThisFavorite[3] := SSN(xmlItem, "descendant::pidl").text ; FavoriteLocation
					
					if (saThisFavorite[3] = "?AAAAFAAfUOBP0CDqOmkQotgIACswMJ0AAA==")
						saThisFavorite[3] := "{20D04FE0-3AEA-1069-A2D8-08002B30309D}" ; DOpus alias "mycomputer"
					else if (saThisFavorite[3] = "?AAAAFAAfWA0aLPAhvlBDiLBzZ/yW7zwAAA==")
						saThisFavorite[3] := "{F02C1A0D-BE21-4350-88B0-7367FC96EF3C}" ; DOpus alias "network"
					else if (saThisFavorite[3] = "?AAAAFAAfeEDwX2SBUBsQnwgAqgAvlU4AAA==")
						saThisFavorite[3] := "{645FF040-5081-101B-9F08-00AA002F954E}" ; DOpus alias "trash"
					
					if (SubStr(saThisFavorite[3], 1, 1) = "{")
						saThisFavorite[4] := GetIconForClassId(saThisFavorite[3])
					saThisFavorite[1] := "Special"
				}
				else
				{
					saThisFavorite[2] := "Please, report: label """ . xmlItemAttributes.label . """ / node: """ . xmlItem.NodeName . """" ; FavoriteName
					saThisFavorite[1] := "Text" ; FavoriteType
				}
				if !StrLen(saThisFavorite[2]) ; if no FavoriteName
					saThisFavorite[2] := saThisFavorite[3] ; use FavoriteLocation
			}
			
			oNewItem := new this.Item(saThisFavorite, this)
			if (blnItemIsMenu) ; this is a submenu favorite, link to the submenu object
				oNewItem.AA.oSubMenu := oNewSubMenu
			this.SA.Push(oNewItem) ; add to the current container object
		}
		
		; end of XML, last menu item
	}
	;-----------------------------------------------------

	;-----------------------------------------------------
	LoadDirectoryOpusLayoutsFromXML(strNodeXml := "", strLayoutMenuName := "")
	;-----------------------------------------------------
	{
		this.SA := Object() ; re-init
		
		if !StrLen(strNodeXml) ; first level only
		{
			xmlDirectoryOpusXML := New XML("xml") ; could use existing instamce created for favorites?
			FileRead, strNodeXml, % g_aaFileManagerDirectoryOpus.strDirectoryOpusLayoutsFile
		}
		
		xmlDirectoryOpusXML.XML.LoadXML(strNodeXml)
		
		xmlNodeAll := xmlDirectoryOpusXML.SN("/*/layout") ; select all layout nodes
		while (xmlItem := xmlNodeAll.Item[A_Index-1])
		{
			blnItemIsMenu := false
			xmlItemAttributes := xmlDirectoryOpusXML.EA(xmlItem)
			if (xmlItemAttributes.separator <> "yes")
			{
				strFolderNodeXml := this.SearchDirectoryOpusLayoutsFolder(xmlItemAttributes.name, strNodeXml)
				blnItemIsMenu := StrLen(strFolderNodeXml)
				
				if (blnItemIsMenu)
				{
					oNewSubMenu := new Container("Menu", xmlItemAttributes.name, this)
					oNewSubMenu.LoadDirectoryOpusLayoutsFromXML(strFolderNodeXml) ; RECURSIVE
				}
			}
			
			saThisFavorite := Object() ; insert DOpus Layout item values in standard QAP item values object
			
			if (xmlItemAttributes.separator = "yes")
				
				saThisFavorite[1] := "X" ; FavoriteType
				
			else
			{
				saThisFavorite[2] := xmlItemAttributes.name ; FavoriteName
				if (blnItemIsMenu)
					saThisFavorite[4] := "iconSubmenu" ; FavoriteIconResource
				else ; it is a layout
				{
					saThisFavorite[4] := "iconGroup" ; FavoriteIconResource
					saThisFavorite[3] := strLayoutMenuName . xmlItemAttributes.name ; FavoriteLocation
				}
				saThisFavorite[1] := (blnItemIsMenu ? "Menu" : "OpenDOpusLayout") ; FavoriteType
			}
			
			oNewItem := new this.Item(saThisFavorite, this)
			if (blnItemIsMenu) ; this is a submenu favorite, link to the submenu object
				oNewItem.AA.oSubMenu := oNewSubMenu
			this.SA.Push(oNewItem) ; add to the current container object
		}
		; end of XML, last menu item
	}
	;-----------------------------------------------------

	;-----------------------------------------------------
	SearchDirectoryOpusLayoutsFolder(strName, strNodeXml)
	; returns the XML of the folder node strName if it is found in strNodeXml or returns empty if not found
	;-----------------------------------------------------
	{
		xmlFolderXML := New XML("xml")
		xmlFolderXML.XML.LoadXML(strNodeXml)
		
		xmlNodeFolder := xmlFolderXML.SN("/*/folder")
		while (xmlFolderItem := xmlNodeFolder.Item[A_Index-1])
		{
			xmlFolderItemAttributes := xmlFolderXML.EA(xmlFolderItem)
			if (xmlFolderItemAttributes.name = strName)
				return xmlFolderItem.xml ; return folder node if found
		}
		return ; empty if not found
	}
	;-----------------------------------------------------

	;------------------------------------------------------------
	BuildMenu(blnWorkingToolTip := false, blnMenuShortcutAlreadyInserted := false) ; build menu and recurse in submenus
	;------------------------------------------------------------
	{
		this.s_intMenuShortcutNumber := 0
		
		; try because at first execution the strMenu menu does not exist and produces an error,
		; but DeleteAll is required later for menu updates
		Menu, % this.AA.strMenuPath, Add ; to avoid an error if menu is empty
		Menu, % this.AA.strMenuPath, DeleteAll
		
		intMenuItemsCount := 0 ; counter of items in this menu
		
		if (blnWorkingToolTip)
			ToolTip, % o_L["ToolTipBuilding"] . "`n" . this.AA.strMenuPath
		
		Loop, % this.SA.MaxIndex()
		{
			aaThisFavorite := this.SA[A_Index].AA
			
			intMenuItemsCount++ ; for objMenuColumnBreak
			
			strMenuItemAction := ""
			intMenuItemStatus := 1 ; by default
			
			; menu items from dynamic menus having custom Gosub in Type field
			if !o_Favorites.s_saFavoriteTypesByName.HasKey(aaThisFavorite.strFavoriteType)
				strMenuItemAction := aaThisFavorite.strFavoriteType
				; keep strFavoriteType value, do not make empty to avoid InStr()
			
			if (aaThisFavorite.strFavoriteType = "QAP")
				; if QAP feature attach menu option was changed when saving options
				aaThisFavorite.strFavoriteName := o_QAPfeatures.AA[aaThisFavorite.strFavoriteLocation].strLocalizedName
			
			strMenuItemLabel := aaThisFavorite.strFavoriteName
			if (StrLen(strMenuItemLabel) and !blnMenuShortcutAlreadyInserted)
				strMenuItemLabel := this.MenuNameWithNumericShortcut(strMenuItemLabel)
			
			if (aaThisFavorite.strFavoriteType = "Group")
				strMenuItemLabel .= " " . g_strGroupIndicatorPrefix . aaThisFavorite.oSubmenu.SA.MaxIndex() . g_strGroupIndicatorSuffix
			
			if StrLen(aaThisFavorite.strFavoriteShortcut) or StrLen(aaThisFavorite.strFavoriteHotstring)
				strMenuItemLabel .= MenuNameReminder(aaThisFavorite.strFavoriteShortcut, GetHotstringTrigger(aaThisFavorite.strFavoriteHotstring))
			
			if StrLen(aaThisFavorite.strFavoriteShortcut)
			{
				g_aaItemsByShortcut[aaThisFavorite.strFavoriteShortcut] := this.SA[A_Index]
				
				; enable shortcut
				Hotkey, % aaThisFavorite.strFavoriteShortcut, OpenFavoriteFromShortcut, On UseErrorLevel
				if (ErrorLevel)
					Oops(o_L["DialogInvalidHotkeyFavorite"], aaThisFavorite.strFavoriteShortcut
						, (StrLen(aaThisFavorite.strFavoriteName) ? aaThisFavorite.strFavoriteName
							: o_QAPfeatures.AA[aaThisFavorite.strFavoriteLocation].LocalizedName) ; if empty probably because it is a QAP feature name
						, aaThisFavorite.strFavoriteLocation)
			}
			
			if StrLen(aaThisFavorite.strFavoriteHotstring)
			{
				g_dicItemsByHotstring.Add(aaThisFavorite.strFavoriteHotstring, this.SA[A_Index])
				
				; before creating an hotstring...
				; in hotstring options: insert "X" (Execute) option g_strHotstringOptionsExecute (PrepareHotstringForFunction)
				; in hotstring replacement: decode end-of-lines and tabs (DecodeSnippet)
				Hotstring(PrepareHotstringForFunction(aaThisFavorite.strFavoriteHotstring, this.SA[A_Index]), "OpenFavoriteFromHotstring", "On")
			}
			
			if InStr("Menu|External", aaThisFavorite.strFavoriteType, true)
				or (aaThisFavorite.intFavoriteFolderLiveLevels and LiveFolderHasContent(this.SA[A_Index]))
					and !(g_intNbLiveFolderItems > o_Settings.MenuAdvanced.intNbLiveFolderItemsMax.IniValue)
			{
				if (aaThisFavorite.intFavoriteFolderLiveLevels)
				{
					this.BuildLiveFolderMenu(this.SA[A_Index], this.AA.strMenuPath, A_Index)
					o_Containers.AA[aaThisFavorite.oSubMenu.AA.strMenuPath] := aaThisFavorite.oSubMenu
				}
				
				aaThisFavorite.oSubMenu.BuildMenu(blnWorkingToolTip, blnMenuShortcutAlreadyInserted) ; RECURSIVE - build the submenu first
				
				strMenuItemAction := ":" . aaThisFavorite.oSubMenu.AA.strMenuPath
				intMenuItemStatus := (aaThisFavorite.oSubMenu.SA.MaxIndex() > 0) ; 0 disabled, 1 enabled, 2 default
				strMenuItemIcon := aaThisFavorite.strFavoriteIconResource
			}
			
			else if (aaThisFavorite.strFavoriteType = "X") ; this is a separator
				
				if (this.SA[A_Index - 1].FavoriteType = "K")
					intMenuItemsCount -= 1 ; separator not allowed as first item is a column, skip it
				else
					strMenuItemLabel := ""
					; Menu, % this.AA.strMenuPath, Add
				
			else if (aaThisFavorite.strFavoriteType = "K") ; this is a column break
			{
				intMenuItemsCount -= 1 ; column breaks do not take a slot in menus
				blnFlagNextItemHasColumnBreak := true
				
				continue ; with the next menu item where the BarBreak option will be used
			}
			else ; this is a favorite (Folder, Document, Application, Special, URL, FTP, QAP, Group or Text)
			{
				if (aaThisFavorite.strFavoriteType = "QAP") and StrLen(o_QAPfeatures.AA[aaThisFavorite.strFavoriteLocation].strQAPFeatureMenuName)
					; menu should never be empty (if no item, it contains a "no item" menu)
					; Menu, % this.AA.strMenuPath, Add, %strMenuItemLabel%, % ":" . o_QAPfeatures.AA[aaThisFavorite.strFavoriteLocation].strQAPFeatureMenuName, % (blnFlagNextItemHasColumnBreak ? "BarBreak" : "")
					strMenuItemAction := ":" . o_QAPfeatures.AA[aaThisFavorite.strFavoriteLocation].strQAPFeatureMenuName
				else if !StrLen(strMenuItemAction) ; if we do not already have the action
				{
					strLayoutMenuName := o_L["DOpusMenuName"] . g_strMenuPathSeparatorWithSpaces . o_L["DOpusLayoutsName"] ; #### remove after completed conversion
					if (SubStr(this.AA.strMenuPath, 1, StrLen(strLayoutMenuName)) = strLayoutMenuName)
						strMenuItemAction := "OpenDOpusLayout" ; keep for conditional action when opening item 
					else if (SubStr(this.AA.strMenuPath, 1, StrLen(o_L["DOpusMenuName"])) = o_L["DOpusMenuName"])
						strMenuItemAction := "OpenDOpusFavorite" ; keep for conditional action when opening item
					else if (SubStr(this.AA.strMenuPath, 1, StrLen(o_L["TCMenuName"])) = o_L["TCMenuName"])
						strMenuItemAction := "OpenFavoriteHotlist" ; keep for conditional action when opening item
					else
						strMenuItemAction := "OpenFavorite" ; #### default value after conversion completed
					; Menu, % this.AA.strMenuPath, Add, %strMenuItemLabel%, %strCommandName%, % (blnFlagNextItemHasColumnBreak ? "BarBreak" : "")
				}
				
				if (o_Settings.MenuIcons.blnDisplayIcons.IniValue) and (aaThisFavorite.strFavoriteIconResource <> "iconNoIcon")
				{
					if (aaThisFavorite.strFavoriteType = "Folder") ; this is a folder
						strMenuItemIcon := aaThisFavorite.strFavoriteIconResource
					else if (aaThisFavorite.strFavoriteType = "URL") ; this is an URL
						if StrLen(aaThisFavorite.strFavoriteIconResource)
							strMenuItemIcon := aaThisFavorite.strFavoriteIconResource
						else
							strMenuItemIcon := GetIcon4Location(g_strTempDir . "\default_browser_icon.html")
							; not sure it is required to have a physical file with .html extension - but keep it as is by safety
					else ; this is a document, application, Special, FTP or QAP
						if StrLen(aaThisFavorite.strFavoriteIconResource)
							strMenuItemIcon := aaThisFavorite.strFavoriteIconResource
						else
							strMenuItemIcon := GetIcon4Location(aaThisFavorite.strFavoriteLocation) ; #### default value for dynamic menus?
					; ParseIconResource(strThisIconFileIndex, strThisIconFile, intThisIconIndex, "iconFolder") ; only folder favorite may need the default icon
					
					; Menu, % this.AA.strMenuPath, UseErrorLevel, on
					; ErrorLevel := 0 ; for safety clear in case Menu is not called in next if
					; Menu, % this.AA.strMenuPath, Icon, %strMenuItemLabel%, %strThisIconFile%, %intThisIconIndex%, % o_Settings.MenuIcons.intIconSize.IniValue
					; if (ErrorLevel)
					; {
						; ParseIconResource("iconUnknown", strIconFile, intIconIndex)
						; Menu, % this.AA.strMenuPath, Icon, %strMenuItemLabel%
							; , %strIconFile%, %intIconIndex%, % o_Settings.MenuIcons.intIconSize.IniValue
					; }
					; Menu, % this.AA.strMenuPath, UseErrorLevel, off
				}
				else
					strMenuItemIcon := "iconNoIcon"
				
				if (aaThisFavorite.strFavoriteName = o_L["MenuSettings"] . "...") ; make Settings... menu bold in any menu
					intMenuItemStatus := 2 ; 0 disabled, 1 enabled, 2 default
					; Menu, % this.AA.strMenuPath, Default, %strMenuItemLabel%
				else if (strMenuItemAction = "GuiShowNeverCalled")
					intMenuItemStatus := 0 ; 0 disabled, 1 enabled, 2 default
				else
					intMenuItemStatus := 1 ; 0 disabled, 1 enabled, 2 default
			}
			
			/* #### was for debugging
			if 1 or (intMenuItemStatus = 0 and !StrLen(strMenuItemLabel))
			{
				###_V(A_ThisFunc, strMenuItemLabel, intMenuItemStatus)
				###_V(A_ThisFunc, "*DEBUG:", "SEE LIST LINES IN CLIPBOARD", "*strMenuItemLabel", strMenuItemLabel, "*intMenuItemStatus", intMenuItemStatus, "*this.AA.strMenuPath", this.AA.strMenuPath)
				Clipboard := ScriptInfo("ListLines")
			}
			*/
			this.AddMenuIcon(strMenuItemLabel, strMenuItemAction, strMenuItemIcon, intMenuItemStatus, blnFlagNextItemHasColumnBreak)
			blnFlagNextItemHasColumnBreak := false ; reset before next item
		}
		
		if !(o_Settings.Launch.blnDonor.IniValue) and (this.AA.strMenuPath = o_L["MainMenuName"])
		{
			this.AddMenuIcon("", "", "")
			this.AddMenuIcon(o_L["DonateMenu"] . "...", "GuiDonate", "iconDonate")
		}
		
		if (!IsObject(this.AA.oParentMenu) and o_Settings.Menu.blnAddCloseToDynamicMenus.IniValue
			and SubStr(this.AA.strMenuPath, 1, 7) <> "menuBar")
			this.AddCloseMenu()
	}
	;------------------------------------------------------------

	;------------------------------------------------------------
	BuildLiveFolderMenu(o_FavoriteLiveFolder, strMenuParentPath, intMenuParentPosition)
	; this.BuildLiveFolderMenu(this.SA[A_Index], this.AA.strMenuPath, A_Index)
	;------------------------------------------------------------
	{
		strExpandedLocation := PathCombine(A_WorkingDir, EnvVars(o_FavoriteLiveFolder.AA.strFavoriteLocation))

		; content in 3 tab delimited strings, first on for self-folder, then for folders and files
		; 1 sorting criteria, 2 favorite type, 3 menu name, 4 location, 5 icon (for folders, .url and .lnk), 6 args (for applications), 7 working dir (for applications)
		
		; self folder
		strFolderIcon := GetFolderIcon(strExpandedLocation)
		if (strFolderIcon = "iconFolder")
			strFolderIcon := o_FavoriteLiveFolder.AA.strFavoriteIconResource
		if (strFolderIcon = "iconFolderLive" or strFolderIcon = "iconFolder")
			strFolderIcon := "iconFolderLiveOpened"
		strSelfFolder := "`tFolder`t" . StrReplace(o_FavoriteLiveFolder.AA.strFavoriteName, "&", "") . "`t" . strExpandedLocation . "`t" . strFolderIcon . "`n"
		
		; scan folders in live folder
		strFolders := ""
		Loop, Files, %strExpandedLocation%\*.*, D ; directories
		{
			g_intNbLiveFolderItems++
			if (g_intNbLiveFolderItems > o_Settings.MenuAdvanced.intNbLiveFolderItemsMax.IniValue)
				Break
			if !InStr(A_LoopFileAttrib, "H")
				strFolders .= this.GetSortCriteria(o_FavoriteLiveFolder.AA.strFavoriteFolderLiveSort) . "`tFolder" . "`t" . A_LoopFileName . "`t" . A_LoopFileLongPath . "`t" . GetFolderIcon(A_LoopFileLongPath) . "`n"
		}
		
		Sort, strFolders, % (SubStr(o_FavoriteLiveFolder.AA.strFavoriteFolderLiveSort, 1, 1) = "D" ? "R" : "") ; R for reverse order
		
		; scan files in live folder
		strFiles := ""
		if (o_FavoriteLiveFolder.AA.blnFavoriteFolderLiveDocuments)
			Loop, Files, %strExpandedLocation%\*.*, F ; files
				if !StrLen(o_FavoriteLiveFolder.AA.strFavoriteFolderLiveExtensions) ; include all
					or (o_FavoriteLiveFolder.AA.blnFavoriteFolderLiveIncludeExclude and StrLen(A_LoopFileExt) and InStr(o_FavoriteLiveFolder.AA.strFavoriteFolderLiveExtensions, A_LoopFileExt)) ; include 
					or (!o_FavoriteLiveFolder.AA.blnFavoriteFolderLiveIncludeExclude and !InStr(o_FavoriteLiveFolder.AA.strFavoriteFolderLiveExtensions, A_LoopFileExt)) ; exclude 
				{
					; ###_V(A_ThisFunc, A_LoopFileName, A_LoopFileExt, A_LoopFileTimeModified, A_LoopFileTimeCreated, A_LoopFileTimeAccessed, A_LoopFileSize)
					g_intNbLiveFolderItems++
					if (g_intNbLiveFolderItems > o_Settings.MenuAdvanced.intNbLiveFolderItemsMax.IniValue)
						Break
					; favorite type Document is OK for Application items

					if (A_LoopFileExt = "lnk")
					{
						SplitPath, A_LoopFileName, , , , strFileName ; OutNameNoExt to remove .lnk extension
						; FileGetShortcut, %file%, OutTarget, OutDir, OutArgs, OutDesc, OutIcon, OutIconNum, OutRunState
						FileGetShortcut, %A_LoopFileLongPath%, strFileLocation, strAppWorkingDir, strArguments, , strShortcutIconFile, strShortcutIconIndex
						if !StrLen(strFileLocation)
							strFileLocation := A_LoopFileLongPath
					}
					else
					{
						strFileName := A_LoopFileName
						strFileLocation := A_LoopFileLongPath
					}
					
					strExtension := GetFileExtension(strFileLocation)
					if StrLen(strExtension) and InStr("exe.com.bat.vbs.ahk", strExtension)
						strFavoriteType := "Application"
					else
						strFavoriteType := "Document"
					
					strFiles .= this.GetSortCriteria(o_FavoriteLiveFolder.AA.strFavoriteFolderLiveSort) . "`t" . strFavoriteType . "`t" . strFileName . "`t"
						. strFileLocation . "`t" ; keep the ending tab to make sure we have an empty value if not .url or .lnk
					
					; get icon for link or shortcut, and add start in directory and args for applications
					if (A_LoopFileExt = "url")
						strFiles .= GetIcon4Location(g_strTempDir . "\default_browser_icon.html")
					else if (A_LoopFileExt = "lnk")
						strFiles .= (StrLen(strShortcutIconFile) ? EnvVars(strShortcutIconFile) . "," . strShortcutIconIndex : GetIcon4Location(strFileLocation))
							. "`t" . strArguments . "`t" . strAppWorkingDir
					; else icon resource will be set when building menu
					
					strFiles .= "`n"
				}

		if (g_intNbLiveFolderItems > o_Settings.MenuAdvanced.intNbLiveFolderItemsMax.IniValue)
		{
			Oops(o_L["OopsMaxLiveFolder"], o_Settings.MenuAdvanced.intNbLiveFolderItemsMax.IniValue)
			return
		}

		Sort, strFiles, % (SubStr(o_FavoriteLiveFolder.AA.strFavoriteFolderLiveSort, 1, 1) = "D" ? "R" : "") ; R for reverse order
		
		strContent := strSelfFolder . (StrLen(strFolders . strFiles) ? "`tX`n" : "")  . strFolders . (StrLen(strFolders) and StrLen(strFiles) ? "`tX`n" : "") . strFiles

		oNewSubMenu := new Container("Menu", o_FavoriteLiveFolder.AA.strFavoriteName, this, "", true)
		oNewSubMenu.AA.blnIsLiveMenu := true
		oNewSubMenu.AA.intLiveFolderParentPosition := intMenuParentPosition ; could be changed if we are in a Live Folder submenu
		oNewSubMenu.AA.strLiveFolderParentPath := strMenuParentPath ; could be changed if we are in a Live Folder submenu
		if (o_Containers.AA[oNewSubMenu.AA.strLiveFolderParentPath].AA.blnIsLiveMenu)
		; we are in a Live Folder submenu - we must get the strLiveFolderParentPath and intLiveFolderParentPosition from top Live Folder item
		{
			; intLiveFolderParentPosition must be changed before strLiveFolderParentPath
			oNewSubMenu.AA.intLiveFolderParentPosition := o_Containers.AA[oNewSubMenu.AA.strLiveFolderParentPath].AA.intLiveFolderParentPosition
			oNewSubMenu.AA.strLiveFolderParentPath := o_Containers.AA[oNewSubMenu.AA.strLiveFolderParentPath].AA.strLiveFolderParentPath
		}
		
		Loop, Parse, strContent, `n
		{
			if !StrLen(A_LoopField)
				break
			
			saItemSource := StrSplit(A_LoopField, "`t")
			saItemSource.RemoveAt(1) ; remove sorting criteria, order becomes as expected by new Item class
			; 1 favorite type, 2 menu name, 3 location, 4 icon (for folders, .url and .lnk), 5 args (for applications), 6 working dir (for applications)
			
			if (o_FavoriteLiveFolder.AA.intFavoriteFolderLiveColumns and (A_Index > 2) and !Mod(A_Index - 1, o_FavoriteLiveFolder.AA.intFavoriteFolderLiveColumns)) ; insert column break before new item
			{
				oNewItem := new this.Item(["K"], this) ; simple array object with only favorite type "K"
				oNewSubMenu.SA.Push(oNewItem) ; add column break to the current container object
				if (saItemSource[1] = "X") ; skip line separator after a column break
					break ; continue with next line in strContent
			}
			
			oNewItem := new this.Item(saItemSource, this)
			
			if (saItemSource[1] = "Folder" and A_Index > 1) ; make it a live folder, except if self folder
			{
				oNewItem.AA.intFavoriteFolderLiveLevels := o_FavoriteLiveFolder.AA.intFavoriteFolderLiveLevels - 1 ; controls the number of recursive calls
				oNewItem.AA.blnFavoriteFolderLiveDocuments := o_FavoriteLiveFolder.AA.blnFavoriteFolderLiveDocuments
				oNewItem.AA.intFavoriteFolderLiveColumns := o_FavoriteLiveFolder.AA.intFavoriteFolderLiveColumns
				oNewItem.AA.blnFavoriteFolderLiveIncludeExclude := o_FavoriteLiveFolder.AA.blnFavoriteFolderLiveIncludeExclude
				oNewItem.AA.strFavoriteFolderLiveExtensions := o_FavoriteLiveFolder.AA.strFavoriteFolderLiveExtensions
				oNewItem.AA.strFavoriteFolderLiveSort := o_FavoriteLiveFolder.AA.strFavoriteFolderLiveSort
			}
			if (oNewItem.AA.strFavoriteType = "Menu") ; this is a submenu favorite, link to the submenu object
				oNewItem.AA.oSubMenu := oNewSubMenu
			
			oNewSubMenu.SA.Push(oNewItem) ; add to the current container object
		}

		; attach live folder menu to live folder favorite object
		o_FavoriteLiveFolder.AA.oSubMenu := oNewSubMenu
	}
	;------------------------------------------------------------

	;------------------------------------------------------------
	GetSortCriteria(strSort)
	;------------------------------------------------------------
	{
		; sort criteria 1 file name, 2 extension, 3 size or 4 modified date (22)
		strSortCriteria := SubStr(strSort, 2, 1)
		
		if (strSortCriteria = "4")
			strCriteria := A_LoopFileTimeModified . A_LoopFileName
		else if (strSortCriteria = "3")
		{		
			strCriteria := A_LoopFileSize
			while StrLen(strCriteria) < 16 ; OK up to 1024 TB
				strCriteria := "0" . strCriteria
			strCriteria .= A_LoopFileName ; in case we have equal sizes
		}
		else if (strSortCriteria = "2")
			strCriteria := A_LoopFileExt . A_LoopFileName
		else ; 1 default if strSort not set, fallback for live folfers before v9
			strCriteria := A_LoopFileName
		
		return strCriteria
	}
	;------------------------------------------------------------

	;-------------------------------------------------------------
	AddCloseMenu()
	;-------------------------------------------------------------
	{
		if (o_Settings.Menu.blnAddCloseToDynamicMenus.IniValue)
		{
			Menu, % this.AA.strMenuPath, Add
			this.AddMenuIcon(o_L["MenuCloseThisMenu"], "DoNothing", "iconClose")
		}
	}
	;-------------------------------------------------------------
	
	;------------------------------------------------------------
	AddMenuIcon(strMenuItemName, strAction, strIconValue, intStatus := true, blnHasColumnBreak := false)
	; strIconValue can be an index from o_JLicons.AA (eg: "iconFolder") or a "file,index" icongroup (eg: "imageres.dll,33")
	;------------------------------------------------------------
	{
		/* #### was for debugging
		if (!StrLen(strMenuItemName) and !intStatus)
		{
			###_V(A_ThisFunc, "SEE LIST LINES IN CLIPBOARD", this.AA.strMenuPath)
			Clipboard := ScriptInfo("ListLines")
		}
		*/
		
		; The names of menus and menu items can be up to 260 characters long.
		if StrLen(strMenuItemName) > 260
			strMenuItemName := SubStr(strMenuItemName, 1, 256) . "..." ; minus one for the luck ;-) ### not ByRef strMenuItemName, since we will use a menu object to open the item
		
		if (this.AA.blnMenuDynamic) ; replace "&" with "&&" in dynamic menus only
			strMenuItemName := DoubleAmpersand(strMenuItemName)
		
		if SubStr(strAction, 1, 1) = ":" ; this is a menu
		{
			Try Menu, % this.AA.strMenuPath, Add, %strMenuItemName%, %strAction%, % (blnHasColumnBreak ? "BarBreak" : "")
			catch ; when menu this.SA[A_Index].AA.oSubMenu.AA.MenuPath is empty
				Menu, % this.AA.strMenuPath, Add, %strMenuItemName%, DoNothing, % (blnFlagNextItemHasColumnBreak ? "BarBreak" : "") ; DoNothing will never be called because disabled
		}
		else
			Menu, % this.AA.strMenuPath, Add, %strMenuItemName%, %strAction%, % (blnHasColumnBreak ? "BarBreak" : "")
		
		if (o_Settings.MenuIcons.blnDisplayIcons.IniValue) and (strIconValue <> "iconNoIcon")
		{
			Menu, % this.AA.strMenuPath, UseErrorLevel, on
			ParseIconResource(strIconValue, strIconFile, intIconIndex)
			Menu, % this.AA.strMenuPath, Icon, %strMenuItemName%, % EnvVars(strIconFile), %intIconIndex%, % o_Settings.MenuIcons.intIconSize.IniValue
			if (ErrorLevel)
			{
				ParseIconResource((this.AA.strMenuPath = o_L["MenuSwitchFolderOrApp"] ? "iconApplication" : "iconUnknown"), strIconFile, intIconIndex)
				Menu, % this.AA.strMenuPath, Icon, %strMenuItemName%
					, % EnvVars(strIconFile), %intIconIndex%, % o_Settings.MenuIcons.intIconSize.IniValue
			}
			Menu, % this.AA.strMenuPath, UseErrorLevel, off
		}
		
		if !(intStatus)
			Menu, % this.AA.strMenuPath, Disable, %strMenuItemName%
		else if (intStatus = 2)
			Menu, % this.AA.strMenuPath, Default, %strMenuItemName%
	}
	;------------------------------------------------------------
	
	;------------------------------------------------------------
	MenuNameWithNumericShortcut(strMenuName)
	;------------------------------------------------------------
	{
		if (o_Settings.Menu.blnDisplayNumericShortcuts.IniValue and (this.s_intMenuShortcutNumber <= 35))
		{
			; remove single ampersand in menu name (keep double ampersands)
			strMenuName := RemoveSingleAmpersand(strMenuName, true) ; true to also convert double ampersand to single
			
			if (this.s_intMenuShortcutNumber < 10)
			{
				; 0 .. 9 (or 1 .. 9, 0 if o_Settings.Menu.blnDisplayNumericShortcutsFromOne.IniValue)
				strShortcut := Mod(this.s_intMenuShortcutNumber + (o_Settings.Menu.blnDisplayNumericShortcutsFromOne.IniValue ? 1 : 0), 10)
			}
			else
				strShortcut := Chr(this.s_intMenuShortcutNumber + 55) ; Chr(10 + 55) = "A" .. Chr(35 + 55) = "Z"
			this.s_intMenuShortcutNumber++
			
			return "&" . strShortcut . " " . StrReplace(strMenuName, "&", "&&")
		}
		else
			return strMenuName
	}
	;------------------------------------------------------------

	;------------------------------------------------------------
	LoadInGui()
	;------------------------------------------------------------
	{
		for intKey, oItem in this.SA
		{
			strThisType := oItem.GetItemTypeLabelForList()
			strThisHotkey := new Triggers.HotkeyParts(oItem.AA.strFavoriteShortcut).Hotkey2Text(true)
			if StrLen(oItem.AA.strFavoriteHotstring)
				strThisHotkey .= " " . BetweenParenthesis(GetHotstringTrigger(oItem.AA.strFavoriteHotstring))
			
			if oItem.IsContainer() ; this is a menu, a group or an external menu
			{
				if (oItem.AA.strFavoriteType = "Menu")
					strGuiMenuLocation := g_strMenuPathSeparator
				else if (oItem.AA.strFavoriteType = "Group")
					strGuiMenuLocation := " " . g_strGroupIndicatorPrefix . g_strGroupIndicatorSuffix
				else ; oItem.AA.strFavoriteType = "External"
				{
					if oItem.AA.oSubMenu.ExternalMenuModifiedSinceLoaded()
					; was ExternalMenuReloadAndRebuild(oItem.AA.oSubMenu)
					{
						oItem.AA.oSubMenu.LoadFavoritesFromIniFile(false, true) ; true for Refresh External
						oItem.AA.oSubMenu.BuildMenu()
					}
					if ExternalMenuIsReadOnly(oItem.AA.oSubMenu.AA.strMenuExternalSettingsPath)
						strGuiMenuLocation := o_L["DialogReadOnly"] . " "
					else if !(oItem.AA.oSubMenu.AA.blnMenuExternalLoaded)
						strGuiMenuLocation := o_L["OopsErrorIniFileUnavailable"] . " "
					else
						strGuiMenuLocation := ""
					strGuiMenuLocation .= g_strMenuPathSeparator . g_strMenuPathSeparator . " " . oItem.AA.oSubMenu.AA.strMenuExternalSettingsPath
				}
				
				LV_Add(, oItem.AA.strFavoriteName . (o_Settings.Database.blnUsageDbShowPopularityIndex.IniValue and oItem.AA.intFavoriteUsageDb
					? " [" . oItem.AA.intFavoriteUsageDb . "]" : ""), strThisType, strThisHotkey, strGuiMenuLocation)
			}
			else if (oItem.AA.strFavoriteType = "X") ; this is a separator
				LV_Add(, g_strGuiMenuSeparator, g_strGuiMenuSeparatorShort, g_strGuiMenuSeparatorShort, g_strGuiMenuSeparator . g_strGuiMenuSeparator)

			else if (oItem.AA.strFavoriteType = "K") ; this is a column break
				LV_Add(, g_strGuiDoubleLine . " " . o_L["MenuColumnBreak"] . " " . g_strGuiDoubleLine
				, g_strGuiDoubleLine, g_strGuiDoubleLine, g_strGuiDoubleLine . " " . o_L["MenuColumnBreak"] . " " . g_strGuiDoubleLine)
				
			else ; this is a Folder, Document, QAP feature, URL, Application, Snippet or Windows App
				LV_Add(, oItem.AA.strFavoriteName . (o_Settings.Database.blnUsageDbShowPopularityIndex.IniValue and oItem.AA.intFavoriteUsageDb
					? " [" . oItem.AA.intFavoriteUsageDb . "]" : ""), strThisType, strThisHotkey
					, (oItem.AA.strFavoriteType = "Snippet" ? StringLeftDotDotDot(oItem.AA.strFavoriteLocation, 250) : oItem.AA.strFavoriteLocation))
		}
	}
	;------------------------------------------------------------

	;------------------------------------------------------------
	LoadInGuiFiltered(strFilter, blnExtended)
	;------------------------------------------------------------
	{
		; Loop, % this.SA.MaxIndex()
		for intKey, oItem in this.SA
		{
			strSearchIn := oItem.AA.strFavoriteName
			if (blnExtended)
			{
				strHotkey := new Triggers.HotkeyParts(oItem.AA.strFavoriteShortcut).Hotkey2Text(true)
				strHotkey := (strHotkey = o_L["DialogNone"] ? "" : strHotkey)
				strSearchIn .= " " . o_Favorites.GetFavoriteTypeObject(oItem.AA.strFavoriteType).strFavoriteTypeLocationLabelNoAmpersand
					. " " . oItem.GetItemTypeLabelForList() ; include short names and Live Folder label
					. " " . strHotkey
					. " " . GetHotstringTrigger(oItem.AA.strFavoriteHotstring)
					. " " . oItem.AA.strFavoriteLocation
					. " " . oItem.AA.strFavoriteArguments
					. " " . oItem.AA.strFavoriteAppWorkingDir
					. " " . oItem.AA.strFavoriteLaunchWith
					. " " . oItem.AA.strFavoriteLoginName
					. " " . oItem.AA.strFavoritePassword
					. " " . oItem.AA.strFavoriteSoundLocation
			}
			if !oItem.IsSeparator()
				and InStr(strSearchIn, strFilter)
			{
				strThisType := oItem.GetItemTypeLabelForList()
				strThisHotkey := new Triggers.HotkeyParts(oItem.AA.strFavoriteShortcut).Hotkey2Text(true)
				if StrLen(oItem.AA.strFavoriteHotstring)
					strThisHotkey .= " " . BetweenParenthesis(GetHotstringTrigger(oItem.AA.strFavoriteHotstring))
				if InStr("Menu|Group|External", oItem.AA.strFavoriteType, true) ; this is a menu, a group or an external menu
				{
					if (oItem.AA.strFavoriteType = "Menu")
						strGuiMenuLocation := g_strMenuPathSeparator
					else if (oItem.AA.strFavoriteType = "Group")
						strGuiMenuLocation := " " . g_strGroupIndicatorPrefix . g_strGroupIndicatorSuffix
					else ; oItem.AA.strFavoriteType = "External"
					{
						if ExternalMenuIsReadOnly(oItem.AA.oSubMenu.AA.strMenuExternalSettingsPath)
							strGuiMenuLocation := o_L["DialogReadOnly"] . " "
						else if !(oItem.AA.oSubMenu.AA.blnMenuExternalLoaded)
							strGuiMenuLocation := o_L["OopsErrorIniFileUnavailable"] . " "
						else
							strGuiMenuLocation := ""
						strGuiMenuLocation .= g_strMenuPathSeparator . g_strMenuPathSeparator . " " . oItem.AA.oSubMenu.AA.strrMenuExternalSettingsPath
					}
					
					LV_Add(, oItem.AA.strFavoriteName, oItem.AA.oParentMenu.AA.strMenuPath, strThisType, strThisHotkey, strGuiMenuLocation, A_Index)
				}
				else ; this is a folder, document, etc.
					LV_Add(, oItem.AA.strFavoriteName, oItem.AA.oParentMenu.AA.strMenuPath, strThisType, strThisHotkey
						, (oItem.AA.strFavoriteType = "Snippet" ? StringLeftDotDotDot(oItem.AA.strFavoriteLocation, 250) : oItem.AA.strFavoriteLocation)
						, A_Index)
			}
			
			if InStr("Menu|External|Group", oItem.AA.strFavoriteType, true)
				oItem.AA.oSubMenu.LoadInGuiFiltered(strFilter, blnExtended) ; RECURSIVE
		}
	}
	;------------------------------------------------------------
	
	;------------------------------------------------------------
	MoveFavorite(intPosition, intDirection)
	;------------------------------------------------------------
	{
		if (intPosition + intDirection > this.SA.MaxIndex())
			or (intPosition + intDirection < 1)
			return

		this.SA.InsertAt(intPosition + intDirection + (intDirection > 0 ? 1 : 0), this.SA[intPosition])
		this.SA.RemoveAt(intPosition + (intDirection > 0 ? 0 : 1))
	}	
	;------------------------------------------------------------

	;------------------------------------------------------------
	BuildMenuListDropDown(strDefaultMenuName, strSkipMenuName := "", blnExcludeReadonly := false)
	;------------------------------------------------------------
	{
		strList := this.AA.strMenuPath
		if (this.AA.strMenuPath = strDefaultMenuName)
			strList .= "|" ; default value
		
		for intKey, oItem in this.SA
		{
			if !InStr("Menu|Group|External", oItem.AA.strFavoriteType, true) ; this is not a menu or a group, case sensitive because type X is included in External ...
				continue
			
			; this object has a .Submenu property
			
			; skip to avoid moving a submenu under itself (in GuiEditFavorite)
			if StrLen(strSkipMenuName) and (oItem.AA.oSubMenu.AA.strMenuPath = strSkipMenuName)
				continue
			
			if (oItem.AA.oSubMenu.AA.strMenuType = "External")
			{
				; skip read-only external menus
				if (blnExcludeReadonly) and ExternalMenuIsReadOnly(oItem.AA.oSubMenu.AA.strMenuExternalSettingsPath)
					continue
				
				; skip external menus if not loaded
				if !(oItem.AA.oSubMenu.AA.blnMenuExternalLoaded)
					continue
			}

			; if we get here, we keep this menu and recurse in it
			strList .= "|" . oItem.AA.oSubMenu.BuildMenuListDropDown(strDefaultMenuName, strSkipMenuName, blnExcludeReadonly) ; recursive call
		}
		return strList
	}
	;------------------------------------------------------------

	;------------------------------------------------------------
	FavoriteNameIsNew(strCandidateName)
	;------------------------------------------------------------
	{
		for intKey, oItem in this.SA
			if (strCandidateName = oItem.AA.strFavoriteName)
				return false
			
		return true
	}
	;------------------------------------------------------------

	;------------------------------------------------------------
	ExternalMenuModifiedSinceLoaded()
	;------------------------------------------------------------
	{
		strLastModified := o_Settings.ReadIniValue("LastModified", " ", "Global", this.AA.strMenuExternalSettingsPath)
		this.AA.strMenuExternalLastModifiedNow := strLastModified
			
		; check if the two timestamps are of the same type
		; if not (could happen when an existing menu is changed of type), return that the menu has been modified
		if InStr(this.AA.strMenuExternalLastModifiedNow, "UTC") and !InStr(this.AA.strMenuExternalLastModifiedWhenLoaded, "UTC")
			or !InStr(this.AA.strMenuExternalLastModifiedNow, "UTC") and InStr(this.AA.strMenuExternalLastModifiedWhenLoaded, "UTC")
			return true
		
		return (this.AA.strMenuExternalLastModifiedNow > this.AA.strMenuExternalLastModifiedWhenLoaded) ; both of same format YYYYMMDDHHMMSS or YYYYMMDDHHMMSSUTC
	}
	;------------------------------------------------------------
	
	;------------------------------------------------------------
	FavoriteIsUnderExternalMenu(ByRef oExternalMenu)
	;------------------------------------------------------------
	{
		oContainer := this
		Loop ; loop going up in submenus chain
		{
			if (oContainer.AA.strMenuType = "External")
			{
				oExternalMenu := oContainer ; return the top level external menu object
				return true
			}
			else if (oContainer.AA.strMenuPath = o_L["MainMenuName"])
				return false ; up to Main menu, no External menu
			else
				oContainer := oContainer.AA.oParentMenu ; up one level and loop
		}
	}
	;------------------------------------------------------------
	
	;------------------------------------------------------------
	ExternalMenuAvailableForLock(blnLockItForMe := false)
	;------------------------------------------------------------
	{
		if (this.AA.strMenuType <> "External")
		; not an external menu, checking lock is not required, return true
			return true
		
		intMenuExternalType := o_Settings.ReadIniValue("MenuType", 1, "Global", this.AA.strMenuExternalSettingsPath) ; 1 Personal (default), 2 Collaborative or 3 Centralized (should be 1 or 2, never 3)
		strMenuExternalReservedBy := o_Settings.ReadIniValue("MenuReservedBy", " ", "Global", this.AA.strMenuExternalSettingsPath) ; empty if not found

		if (intMenuExternalType = 3 and ExternalMenuIsReadOnly(this.AA.strMenuExternalSettingsPath))
		{
			strWriteAccessMessage := o_Settings.ReadIniValue("WriteAccessMessage", " ", "Global", this.AA.strMenuExternalSettingsPath) ; empty if not found
			strExternalMenuName := o_Settings.ReadIniValue("MenuName", " ", "Global", this.AA.strMenuExternalSettingsPath) ; empty if not found
			Oops(o_L["OopsErrorIniFileReadOnly"] . (StrLen(strExternalMenuName) ? "`n`n" . o_L["DialogExternalMenuName"] . ":`n" . strExternalMenuName : "")
				. (StrLen(strWriteAccessMessage) ? "`n`n" . o_L["DialogExternalWriteAccessMessage"] . ":`n" . strWriteAccessMessage : ""))
			return false
		}
		else if (intMenuExternalType > 1 and StrLen(strMenuExternalReservedBy))
			; the collaborative or centralized menu is reserved...
			if (strMenuExternalReservedBy = A_UserName . " (" . A_ComputerName . ")")
				; ... already reserved for this user, return true
				return true
			else
			{
				; ... reserved by another user, return false
				Oops(o_L["OopsMenuExternalReservedBy"], (intMenuExternalType = 2 ? o_L["OopsMenuExternalCollaborative"] : o_L["OopsMenuExternalCentralized"]), strMenuExternalReservedBy)
				return false
			}
		else if (intMenuExternalType = 2 and ExternalMenuFolderIsReadOnly(this.AA.strMenuExternalSettingsPath))
		; user cannot write to collaborative external ini file, could not lock it, return false
		{
			Oops(o_L["OopsExternalFileWriteErrorCollaborative"])
			return false
		}

		; here, we know that this menu can be locked

		if (blnLockItForMe) and this.ExternalMenuModifiedSinceLoaded()
		; check if shared menu has been modified since it was loaded and, if yes, refresh menu
		{
			if (this.AA.strMenuPath = o_MenuInGui.AA.strMenuPath)
			; this menu is in gui - inform user that his change cannot be saved and reload menu in gui
			{
				Oops(o_L["OopsErrorIniFileModified"])
				Gosub, LoadMenuInGui ; will ExternalMenuReloadAndRebuild
				return false
			}
			else
			; was ExternalMenuReloadAndRebuild(objMenu)
			{
				this.LoadFavoritesFromIniFile(false, true) ; true for Refresh External
				this.BuildMenu()
			}
		}
		
		; lock is allowed, return true
		
		if (intMenuExternalType = 1 and StrLen(strMenuExternalReservedBy) and strMenuExternalReservedBy <> A_ComputerName . " (" . A_UserName . ")")
			; personal menu is changed on another system - only inform user, lock overwriting is allowed
			Oops(o_L["OopsMenuExternalPersonalChangedBy"], strMenuExternalReservedBy)
		
		if (blnLockItForMe)
		; lock external menu for this user (do it only when saving changes to the menu, not when checking before opening the add/edit favorite dialog box)
		{
			; in personal menu save "computer (user)", in collaborative or centralized menu save "user (computer)"
			IniWrite, % (intMenuExternalType = 1 ? A_ComputerName . " (" . A_UserName . ")" : A_UserName . " (" . A_ComputerName . ")")
				, % this.AA.strMenuExternalSettingsPath, Global, MenuReservedBy ; no need to update LastModified for this change
			; remember to free when saving or canceling
			g_saExternaleMenuToRelease.Push(this.AA.strMenuExternalSettingsPath)
		}

		return true
	}
	;------------------------------------------------------------
	
	;---------------------------------------------------------
	SaveFavoritesToIniFile(blnRoot := true)
	;---------------------------------------------------------
	{
		static s_intIniLineSave
		static s_strIniFile
		
		if (blnRoot) ; this is first call to the method
		{
			s_intIniLineSave := 1
			s_strIniFile := o_Settings.strIniFile
			
			; make internal backup
			IniRead, strTempIniFavoritesSection, %s_strIniFile%, Favorites
			IniWrite, %strTempIniFavoritesSection%, %s_strIniFile%, Favorites-backup
			IniDelete, %s_strIniFile%, Favorites
		}
		
		ToolTip, % o_L["ToolTipSaving"] . "`n" . this.AA.strMenuPath
		
		for intKey, oItem in this.SA
		{
			; make sure we do not save a menu separator after a column break - this would confuse the references to menu object index
			if (intKey > 1)
				if (oItem.AA.strFavoriteType = "X") and (this.SA[intKey - 1].AA.strFavoriteType = "K")
					continue

			strIniLine := oItem.AA.strFavoriteType . "|" ; 1
			if (oItem.AA.strFavoriteType = "QAP")
				strIniLine .= "|" ; do not save name to ini file, use current language feature name when loading ini file
			else
				strIniLine .= StrReplace(oItem.AA.strFavoriteName, "|", g_strEscapePipe) . "|" ; 2
			strIniLine .= StrReplace(oItem.AA.strFavoriteLocation, "|", g_strEscapePipe) . "|" ; 3
			if StrLen(o_JLicons.AA[oItem.AA.strFavoriteIconResource]) ; save index of o_JLicons.AA
				strIniLine .= oItem.AA.strFavoriteIconResource . "|" ; 4
			else
			{
				ParseIconResource(oItem.AA.strFavoriteIconResource, strIconFile, intIconIndex)
				if (strIconFile = o_JLicons.strFileLocation) ; use JLicons.dll index to store JLicons.dll index like "iconXYZ"
					strIniLine .= o_JLicons.GetName(intIconIndex) . "|" ; 4
				else ; use icongroup as is
					strIniLine .= oItem.AA.strFavoriteIconResource . "|" ; 4
			}
			strIniLine .= StrReplace(oItem.AA.strFavoriteArguments, "|", g_strEscapePipe) . "|" ; 5
			strIniLine .= oItem.AA.strFavoriteAppWorkingDir . "|" ; 6
			strIniLine .= oItem.AA.strFavoriteWindowPosition . "|" ; 7
			strIniLine .= oItem.AA.strFavoriteLaunchWith . "|" ; 8
			strIniLine .= StrReplace(oItem.AA.strFavoriteLoginName, "|", g_strEscapePipe) . "|" ; 9
			strIniLine .= StrReplace(oItem.AA.strFavoritePassword, "|", g_strEscapePipe) . "|" ; 10
			strIniLine .= oItem.AA.strFavoriteGroupSettings . "|" ; 11
			strIniLine .= oItem.AA.blnFavoriteFtpEncoding . "|" ; 12
			strIniLine .= oItem.AA.blnFavoriteElevate . "|" ; 13
			strIniLine .= oItem.AA.blnFavoriteDisabled . "|" ; 14
			strIniLine .= oItem.AA.intFavoriteFolderLiveLevels . "|" ; 15
			strIniLine .= oItem.AA.blnFavoriteFolderLiveDocuments . "|" ; 16
			strIniLine .= oItem.AA.intFavoriteFolderLiveColumns . "|" ; 17
			strIniLine .= oItem.AA.blnFavoriteFolderLiveIncludeExclude . "|" ; 18
			strIniLine .= oItem.AA.strFavoriteFolderLiveExtensions . "|" ; 19
			strIniLine .= oItem.AA.strFavoriteShortcut . "|" ; 20
			strIniLine .= StrReplace(oItem.AA.strFavoriteHotstring, "|", g_strEscapePipe) . "|" ; 21
			strIniLine .= oItem.AA.strFavoriteFolderLiveSort . "|" ; 22
			strIniLine .= StrReplace(oItem.AA.strFavoriteSoundLocation, "|", g_strEscapePipe) . "|" ; 23
			strIniLine .= oItem.AA.strFavoriteDateCreated . "|" ; 24
			strIniLine .= oItem.AA.strFavoriteDateModified . "|" ; 25
			strIniLine .= oItem.AA.intFavoriteUsageDb . "|" ; 26

			IniWrite, %strIniLine%, %s_strIniFile%, Favorites, % "Favorite" . s_intIniLineSave
			s_intIniLineSave++
			
			if InStr("Menu|Group", oItem.AA.strFavoriteType, true)
				or (oItem.AA.strFavoriteType = "External"
					and !ExternalMenuIsReadOnly(oItem.AA.strFavoriteAppWorkingDir)
					and oItem.AA.oSubMenu.AA.blnMenuExternalLoaded
					and oItem.AA.oSubMenu.AA.blnNeedSave)
			{
				if (oItem.AA.strFavoriteType = "External")
				{
					intPreviousIniLine := s_intIniLineSave
					strPreviousIniFile := s_strIniFile
					
					s_strIniFile := oItem.AA.oSubMenu.AA.strMenuExternalSettingsPath
					s_intIniLineSave := 1 ; reset to 1 for the external file
					
					Settings.BackupIniFile(s_strIniFile, true) ; backup external settings ini file, if required
				}
				
				oItem.AA.oSubMenu.SaveFavoritesToIniFile(false) ; RECURSIVE false not root
				
				if (oItem.AA.strFavoriteType = "External")
				{
					Sleep, 20 ; for safety
					strIniDateTimeAfter := ExternalMenuGetModifiedDateTime(s_strIniFile)
					oItem.AA.oSubMenu.strMenuExternalLastModifiedWhenLoaded := strIniDateTimeAfter
					oItem.AA.oSubMenu.strMenuExternalLastModifiedNow := strIniDateTimeAfter
					oItem.AA.oSubMenu.blnNeedSave := false
					IniWrite, %strIniDateTimeAfter%, %s_strIniFile%, Global, LastModified
					
					s_strIniFile := strPreviousIniFile
					s_intIniLineSave := intPreviousIniLine
				}
			}
		}
		
		IniWrite, Z, %s_strIniFile%, Favorites, % "Favorite" . s_intIniLineSave ; end of menu marker
		s_intIniLineSave++
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	LoadMenuHotkeysToManageList(intShortcutOrHotstrings, blnSeeAllFavorites, blnSeeShortHotkeyNames)
	; intShortcutOrHotstrings: (1) shortcuts and (2) hotstrings
	;---------------------------------------------------------
	{
		static intHotkeyListOrder
		
		if (this.AA.strMenuPath = o_L["MainMenuName"])
			intHotkeyListOrder := 0
		
		for intKey, oItem in this.SA
		{
			if (StrLen(oItem.AA.strFavoriteShortcut) and (intShortcutOrHotstrings = 1))
				or (StrLen(oItem.AA.strFavoriteHotstring) and (intShortcutOrHotstrings = 2))
				or (blnSeeAllFavorites and !oItem.IsSeparator()) ; see all except separators
			{
				strThisType := oItem.GetItemTypeLabelForList()
				intHotkeyListOrder++
				
				if (intShortcutOrHotstrings = 1 and StrLen(oItem.AA.strFavoriteShortcut)) or (blnSeeAllFavorites)
				{
					strThisHotkey := (StrLen(oItem.AA.strFavoriteShortcut) ? oItem.AA.strFavoriteShortcut : o_L["DialogNone"])
					; #|Menu|Favorite Name|Type|Shortcuts|Favorite Location|Object Position (hidden)
					LV_Add(, intHotkeyListOrder
						, this.AA.strMenuPath
						, oItem.AA.strFavoriteName
						, strThisType
						, (blnSeeShortHotkeyNames ? strThisHotkey : new Triggers.HotkeyParts(strThisHotkey).Hotkey2Text())
						, (oItem.AA.strFavoriteType = "Snippet" ? StringLeftDotDotDot(oItem.AA.strFavoriteLocation, 50) : oItem.AA.strFavoriteLocation)
						, intKey)
				}
				else if (intShortcutOrHotstrings = 2 and StrLen(oItem.AA.strFavoriteHotstring)) or (blnSeeAllFavorites)
				{
					SplitHotstring(oItem.AA.strFavoriteHotstring, strTrigger, strOptionsShort)
					; #|Menu|Favorite Name|Type|Trigger|Options|Favorite Location|Object Position (hidden)
					LV_Add(, intHotkeyListOrder
						, this.AA.strMenuPath
						, oItem.AA.strFavoriteName
						, strThisType
						, strTrigger
						, (blnSeeShortHotkeyNames ? strOptionsShort : GetHotstringOptionsLong(strOptionsShort))
						, (oItem.AA.strFavoriteType = "Snippet" ? StringLeftDotDotDot(oItem.AA.strFavoriteLocation, 50) : oItem.AA.strFavoriteLocation)
						, intKey)
				}
			}
			
			if InStr("Menu|External", oItem.AA.strFavoriteType, true)
				this.AA.oSubMenu.LoadMenuHotkeysToManageList(intShortcutOrHotstrings, blnSeeAllFavorites, blnSeeShortHotkeyNames) ; RECURSIVE
		}
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	LoadMenuIconsManage()
	; populate simple array g_saManageIcons with items, used to put content in Manage Icons dialog box
	;---------------------------------------------------------
	{
		for intKey, oItem in this.SA
		{
			if !oItem.IsSeparator() ; skip separators
				g_saManageIcons.Push(oItem)
			
			if InStr("Menu|External", oItem.AA.strFavoriteType, true)
				oItem.AA.oSubMenu.LoadMenuIconsManage() ; RECURSIVE
		}
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	UpdateUsageDbFrequency()
	;---------------------------------------------------------
	{
		Diag(A_ThisFunc, "", "START")

		for intKey, oItem in this.SA
			if StrLen(oItem.AA.strFavoriteLocation) ; exclude separators
				oItem.AA.intFavoriteUsageDb := oItem.GetUsageDbFavoriteUsage()
		
		if (g_blnUsageDbDebug)
		{
			ToolTip, %A_ThisLabel%: done...
			if (g_blnUsageDbDebugBeep)
				SoundBeep, 1200
			Sleep, 2000
			ToolTip
		}
		
		Diag(A_ThisFunc, "", "STOP")
	}
	;---------------------------------------------------------
	
	; === end of methods for class Container ===
	
	;-------------------------------------------------------------
	class Item
	;-------------------------------------------------------------
	{
		AA := Object() ; associative array for item's properties
		
		;---------------------------------------------------------
		###__Call(function, parameters*)
		; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
		{
			funcRef := Func(funcName := this.__class "." function)
			if CheckParameters(funcRef, function, parameters*) ; if everything is good call the function, else return false
				return funcRef.(this, parameters*) ; everything is good
			else
				return
		}
		;---------------------------------------------------------

		;---------------------------------------------------------
		__New(saFavorite, oParentMenu := "")
		;---------------------------------------------------------
		{
			; saFavorite:
			; 1 strFavoriteType, 2 strFavoriteName, 3 strFavoriteLocation, 4 strFavoriteIconResource, 5 strFavoriteArguments, 6 strFavoriteAppWorkingDir,
			; 7 strFavoriteWindowPosition, (X strFavoriteHotkey), 8 strFavoriteLaunchWith, 9 strFavoriteLoginName, 10 strFavoritePassword,
			; 11 strFavoriteGroupSettings, 12 blnFavoriteFtpEncoding, 13 blnFavoriteElevate, 14 blnFavoriteDisabled,
			; 15 intFavoriteFolderLiveLevels, 16 blnFavoriteFolderLiveDocuments, 17 intFavoriteFolderLiveColumns, 18 blnFavoriteFolderLiveIncludeExclude, 19 strFavoriteFolderLiveExtensions
			; 20 strFavoriteShortcut, 21 strFavoriteHotstring, 22 strFavoriteFolderLiveSort, 23 strFavoriteSoundLocation
			; 24 strFavoriteDateCreated, 25 strFavoriteDateModified, 26 intFavoriteUsageDb
			
			this.AA.oParentMenu := oParentMenu
			
			if (saFavorite[1] = "QAP")
			{
				; get QAP feature's name in current language (QAP features names are not saved to ini file)
				saFavorite[2] := o_QAPfeatures.aaQAPFeaturesDefaultNameByCode[saFavorite[3]]
				if !StrLen(saFavorite[2]) ; if QAP feature is unknown
					; by default RandomBetween returns an integer between 0 and 2147483647 to generate a random file number and variable number
					saFavorite[2] := "* Unknown QAP feature * " . RandomBetween() . " *"
				
				; to keep track of QAP features in menus to allow enable/disable menu items
				o_QAPfeatures.aaQAPfeaturesInMenus.Insert(saFavorite[3], 1) ; boolean just to flag that we have this QAP feature in menus
			}
			
			; this is a regular favorite, add it to the current menu
			this.InsertItemValue("strFavoriteType", saFavorite[1]) ; see Favorite Types
			this.InsertItemValue("strFavoriteName", StrReplace(saFavorite[2], g_strEscapePipe, "|")) ; display name of this menu item
			this.InsertItemValue("strFavoriteLocation", StrReplace(saFavorite[3], g_strEscapePipe, "|")) ; path, URL or menu path (without "Main") for this menu item
			this.InsertItemValue("strFavoriteIconResource", saFavorite[4]) ; icon resource in format "iconfile,iconindex" or JLicons index "iconXYZ"
			this.InsertItemValue("strFavoriteArguments", StrReplace(saFavorite[5], g_strEscapePipe, "|")) ; application arguments
			this.InsertItemValue("strFavoriteAppWorkingDir", saFavorite[6]) ; application working directory
			this.InsertItemValue("strFavoriteWindowPosition", saFavorite[7]) ; Boolean,Left,Top,Width,Height,Delay,RestoreSide/Monitor (comma delimited) (will be split when open favorite)
			this.InsertItemValue("strFavoriteLaunchWith", saFavorite[8]) ; launch favorite with this executable, or various options for type Application and Snippet
			if (this.AA.strFavoriteType = "Snippet" and this.AA.HasKey("strFavoriteLaunchWith"))
			{
				saTemp := StrSplit(this.AA.strFavoriteLaunchWith, ";") ; was arrFavoriteSnippetOptions
				this.AA.blnSnippetMacroMode := saTemp[1]
				this.AA.strSnippetPrompt := saTemp[2]
			}
			this.InsertItemValue("strFavoriteLoginName", StrReplace(saFavorite[9], g_strEscapePipe, "|")) ; login name for FTP favorite
			this.InsertItemValue("strFavoritePassword", StrReplace(saFavorite[10], g_strEscapePipe, "|")) ; password for FTP favorite
			this.InsertItemValue("strFavoriteGroupSettings", saFavorite[11]) ; coma separated values for group restore settings or external menu starting line
			this.InsertItemValue("blnFavoriteFtpEncoding", saFavorite[12]) ; encoding of FTP username and password, 0 do not encode, 1 encode
			this.InsertItemValue("blnFavoriteElevate", saFavorite[13]) ; elevate application, 0 do not elevate, 1 elevate
			this.InsertItemValue("blnFavoriteDisabled", saFavorite[14]) ; favorite disabled, not shown in menu, can be a submenu then all subitems are skipped
			this.InsertItemValue("intFavoriteFolderLiveLevels", saFavorite[15]) ; number of subfolders to include in submenu(s), 0 if not a live folder
			this.InsertItemValue("blnFavoriteFolderLiveDocuments", saFavorite[16]) ; also include documents in live folder
			this.InsertItemValue("intFavoriteFolderLiveColumns", saFavorite[17]) ; number of items per columns in live folder menus
			this.InsertItemValue("blnFavoriteFolderLiveIncludeExclude", saFavorite[18]) ; if true include extensions in FavoriteFolderLiveExtensions, if false exclude them
			this.InsertItemValue("strFavoriteFolderLiveExtensions", saFavorite[19]) ; extensions of files to include or exclude in live folder
			this.InsertItemValue("strFavoriteShortcut", saFavorite[20]) ; (new in v8.7.1.93) shortcut (mouse or keyboard hotkey) to launch this favorite
			this.InsertItemValue("strFavoriteHotstring", StrReplace(saFavorite[21], g_strEscapePipe, "|")) ; (changed in v8.7.1.96) hotstring to launch this favorite (AHK format: ":option:trigger")
			this.InsertItemValue("strFavoriteFolderLiveSort", saFavorite[22]) ; two chars: sort order A or D and sort criteria 1 file name, 2 extension, 3 size or 4 modified date
			this.InsertItemValue("strFavoriteSoundLocation", StrReplace(saFavorite[23], g_strEscapePipe, "|")) ; path and file of sound to play when launching the favorite
			this.InsertItemValue("strFavoriteDateCreated", saFavorite[24]) ; UTC date of creation of the favorite in QAP, in YYYYMMDDHH24MISS format (added in v9.1.x)
			this.InsertItemValue("strFavoriteDateModified", saFavorite[25]) ; UTC date of last modification of the favorite in QAP, in YYYYMMDDHH24MISS format (added in v9.1.x)
			this.InsertItemValue("intFavoriteUsageDb", saFavorite[26]) ; level of usage of this favorite (TBD - combo of occurrences in Recent Items and launches from QAP menu) (to be added in v9.2)

			if (!StrLen(this.AA.strFavoriteIconResource) or this.AA.strFavoriteIconResource = "iconUnknown")
			; get icon if not in ini file (occurs at first run wen loading default menu - or if error occured earlier)
				this.AA.strFavoriteIconResource := this.GetDefaultIcon4Type(this.AA.strFavoriteLocation)
		}
		;---------------------------------------------------------
		
		;---------------------------------------------------------
		InsertItemValue(strValueName, strValue)
		{
			if StrLen(strValue) ; avoid creating empty values polluting the debugging tools
				this.AA[strValueName] := strValue
		}
		;---------------------------------------------------------
		
		;---------------------------------------------------------
		Backup()
		; copy of associative array AA to another object of class Item
		;---------------------------------------------------------
		{
			oCopy := new Container.Item
			
			for strKey, varValue in this.AA
				oCopy.AA[strKey] := varValue
				
			return oCopy
		}
		;---------------------------------------------------------
		
		;---------------------------------------------------------
		IsContainer()
		;---------------------------------------------------------
		{
			return InStr("|Menu|Group|External", "|" . this.AA.strFavoriteType, true) ; does not include LiveFolder
		}
		;---------------------------------------------------------
		
		;---------------------------------------------------------
		IsSeparator()
		;---------------------------------------------------------
		{
			return InStr("|X|K", "|" . this.AA.strFavoriteType, true)
		}
		;---------------------------------------------------------
		
		;---------------------------------------------------------
		OpenFavorite(strMenuTriggerLabel, strOpenFavoriteLabel, strTargetWinId, strHotkeyTypeDetected)
		;---------------------------------------------------------
		{
			this.aaTemp := Object() ; reset item temporary values
			this.aaTemp.strMenuTriggerLabel := strMenuTriggerLabel
			this.aaTemp.strOpenFavoriteLabel := strOpenFavoriteLabel
			this.aaTemp.strTargetWinId := strTargetWinId
			this.aaTemp.strHotkeyTypeDetected := strHotkeyTypeDetected
			
			; EXPAND PLACEHOLDERS in location
			; for favorite's location {LOC}, {DIR}, {NAME}, etc, current location {CUR_LOC}, {CUR_NAME}, {CUR_...}, etc,
			; selected file location {SEL_LOC}, {SEL_NAME}, {SEL_...}, etc and current content of clipboard {Clipboard}
			; for favorite's location, favorite's parameter, application favorite's start in directory, snippet's content
			this.aaTemp.strLocationWithPlaceholders := ExpandPlaceholders(this.AA.strFavoriteLocation, ""
				, (InStr(this.AA.strFavoriteLocation, "{CUR_") ? GetCurrentLocation(g_strTargetClass, this.aaTemp.strTargetWinId) : -1)
				, (InStr(this.AA.strFavoriteLocation, "{SEL_") ? GetSelectedLocation(g_strTargetClass, this.aaTemp.strTargetWinId) : -1))
			
			; ALTERNATIVE
			if (this.aaTemp.strHotkeyTypeDetected = "Alternative")
			{
				if InStr("Folder|Document|Application", this.AA.strFavoriteType)
					and (g_strAlternativeMenu = o_L["MenuAlternativeOpenContainingCurrent"] or g_strAlternativeMenu = o_L["MenuAlternativeOpenContainingNew"])
					
					this.AlternativeOpenContainer()
					
				else if (g_strAlternativeMenu = o_L["MenuAlternativeEditFavorite"] and A_ThisMenu <> o_L["MenuLastActions"])
					
					this.AlternativeEditFavorite()
					
				else if (g_strAlternativeMenu = o_L["MenuCopyLocation"]) ; EnvVars expanded
				{
					if !InStr("Group|QAP", this.AA.strFavoriteType) ; for these types, there is no path to copy
					{
						Clipboard := this.aaTemp.strLocationWithPlaceholders
						TrayTip, %g_strAppNameText%, % o_L["CopyLocationCopiedToClipboard"], , 17 ; 1 info icon + 16 no sound
						Sleep, 20 ; tip from Lexikos for Windows 10 "Just sleep for any amount of time after each call to TrayTip" (http://ahkscript.org/boards/viewtopic.php?p=50389&sid=29b33964c05f6a937794f88b6ac924c0#p50389)
						blnOpenOK := true
					}
				}
				else if (g_strAlternativeMenu = o_L["MenuAlternativeNewWindow"]) and (this.AA.strFavoriteType = "Group")
					; cannot open group in new window
					blnOpenOK := false
				
				if (g_strAlternativeMenu <> o_L["MenuAlternativeRunAs"]) ; will be launched under APPLICATION below, else this is finished
					return
			}
			
			if InStr("|Folder|Special|FTP", "|" . this.AA.strFavoriteType) ; must be before SetFullLocation()
				if !this.SetTargetName() ; sets old g_strTargetAppName, can change this.aaTemp.strHotkeyTypeDetected to "Launch", can empty this.aaTemp.strTargetWinId if Desktop
					return
			
			if (this.AA.strFavoriteType <> "Text") ; text separators don't have location
				if !this.SetFullLocation()
					return
				
			if (this.AA.strFavoriteType = "Text")
				return
			
			; GROUP
			if (this.AA.strFavoriteType = "Group") and !(g_blnAlternativeMenu)
			{
				; fake use of the old command label OpenFavoriteFromGroup used in different places to flag that a group member is being processed
				this.aaTemp.strOpenFavoriteLabel := "OpenFavoriteFromGroup"
				this.OpenGroup()
				blnOpenOK := true
			}
			; MENU
			else if InStr("Menu|External", this.AA.strFavoriteType, true)
			{
				Gosub, SetMenuPosition
				Menu, % o_L["MainMenuName"] . " " . this.aaTemp.strFullLocation, Show, %g_intMenuPosX%, %g_intMenuPosY%
				blnOpenOK := true
			}
			; WINDOWS APPS
			else if (this.AA.strFavoriteType = "WindowsApp")
			{
				this.LaunchWindowsApp()
				blnOpenOK := true
			}
			; QAP COMMAND
			else if InStr("OpenFavorite|OpenFavoriteFromShortcut|OpenFavoriteFromHotstring|OpenFavoriteFromGroup|OpenFavoriteFromLastAction", strOpenFavoriteLabel)
				and (this.AA.strFavoriteType = "QAP") and StrLen(o_QAPfeatures.AA[this.AA.strFavoriteLocation].strQAPFeatureCommand)
			{
				Gosub, % o_QAPfeatures.AA[this.AA.strFavoriteLocation].strQAPFeatureCommand
				blnOpenOK := true
			}
			; SWITCH APP
			else if (this.AA.strFavoriteType = "OpenSwitchFolderOrApp")
			{
				this.SwitchFolderOrApp()
				blnOpenOK := true
			}
			; DIRECTORY OPUS LAYOUT
			else if (this.AA.strFavoriteType = "OpenDOpusLayout")
			{
				this.OpenDirectoryOpusLayout()
				blnOpenOK := true
			}
			; ACTIVATE RUNNING APPLICATION
			else if (this.AA.strFavoriteType = "Application")
				and (this.AA.strFavoriteLaunchWith = 1) ; 1 activate existing if running
				and AppIsRunning(this.aaTemp.strLocationWithPlaceholders, this.AA.blnFavoriteElevate, this.aaTemp.strAppID) ; returns true if app is running with same UAC level and updates strAppID
			{
				this.ActivateRunningApplication()
				blnOpenOK := true
			}
			; DOCUMENTS, LINK and LAUNCH WITH
			else if InStr("Document|URL", this.AA.strFavoriteType)
				or (StrLen(this.AA.strFavoriteLaunchWith) and !InStr("Application|Snippet", this.AA.strFavoriteType))
			{
				this.LaunchFullLocation()
				blnOpenOK := true
			}
			; SNIPPETS
			else if (this.AA.strFavoriteType = "Snippet")
				and (!g_blnAlternativeMenu or (g_strAlternativeMenu = o_L["MenuAlternativeNewWindow"]))
			{
				this.PasteSnippet() ; using this.AA.strLocationWithPlaceholders
				blnOpenOK := false
			}	
			; CHECK IF FILE/FOLDER MUST EXIST
			else if this.FileExistIfMust()
			{
				; WINDOW POSITION PREPARATION
				; Boolean,MinMax,Left,Top,Width,Height,Delay,RestoreSide/Monitor (comma delimited) (7)
				; 0 for use default / 1 for remember, -1 Minimized / 0 Normal / 1 Maximized, Left (X), Top (Y), Width, Height, Delay (default 200 ms),
				this.aaTemp.saFavoriteWindowPosition := StrSplit(this.AA.strFavoriteWindowPosition, ",") ; reset simple array for all favorites, replace g_arrFavoriteWindowPosition
				; DOpus or TC: L Left / R Right / Explorer or TC: Monitor 1 / Monitor 2...; for example: "1,0,100,50,640,480,200" or "0,,,,,,,L"
				if StrLen(this.aaTemp.strTargetAppName) and InStr("Explorer|TotalCommander", this.aaTemp.strTargetAppName) ; if we need to position the new Explorer or Total Commander window on the active monitor
				{
					SysGet, intNbMonitors, MonitorCount
					this.aaTemp.intNbMonitors := intNbMonitors
					if (g_aaFileManagerExplorer.blnOpenFavoritesOnActiveMonitor and this.aaTemp.intNbMonitors > 1)
						GetPositionFromMouseOrKeyboard(this.aaTemp.strMenuTriggerLabel, A_ThisHotkey, this.aaTemp.intMonitorReferencePositionX, this.aaTemp.intMonitorReferencePositionY)
				}
				
				; APPLICATION
				if (this.AA.strFavoriteType = "Application")
				{
					this.LaunchApplication()
					blnOpenOK := true
				}
				; FOLDER
				if InStr("Folder|FTP|Special", this.AA.strFavoriteType)
					blnOpenOK := this.OpenFolder()
			}
			else
				blnOpenOK := false
			
			if (blnOpenOK)
			{
				; SET WINDOW POSITION
				if (this.aaTemp.saFavoriteWindowPosition[1] or g_aaFileManagerExplorer.blnOpenFavoritesOnActiveMonitor) ;  we need to position window
					and (InStr("Explorer|TotalCommander", this.aaTemp.strTargetAppName) or o_Settings.Execution.blnTryWindowPosition.IniValue)
					; we can access new Explorer or Total Commander windows, or try with other apps
					
					this.SetWindowPosition() ; was OpenFavoriteWindowPosition
				
				if StrLen(this.AA.strFavoriteSoundLocation)
					this.OpenFavoritePlaySound()
				
				; LOG ACTION
				if !(this.AA.blnIsGroupMember) ; not if group member
					and !(g_blnAlternativeMenu) ; not if alternative menu action
					; gosub, UsageDbCollectMenu ; DO IT LATER
					this.CollectUsageDb() ; was UsageDbCollectMenu:
			}
		}
		;---------------------------------------------------------
		
		;---------------------------------------------------------
		AlternativeOpenContainer()
		;---------------------------------------------------------
		{
			SplitPath, % this.aaTemp.strLocationWithPlaceholders, , strContainingFolder
			strContainingFolder .= "\"
			saContainingItem := ["Folder", "Containing Folder", strContainingFolder]
			oContainingFolderItem := new Container.Item(saContainingItem)
			oContainingFolderItem.aaTemp := Object()
			oContainingFolderItem.aaTemp.strFullLocation := strContainingFolder
			oContainingFolderItem.aaTemp.strTargetWinId := this.aaTemp.strTargetWinId
			if (g_strAlternativeMenu = o_L["MenuAlternativeOpenContainingCurrent"])
				and CanNavigate((A_ThisHotkey = o_PopupHotkeyAlternativeHotkeyMouse.P_strAhkHotkey ? o_PopupHotkeyNavigateOrLaunchHotkeyMouse.P_strAhkHotkey
					: o_PopupHotkeyNavigateOrLaunchHotkeyKeyboard.P_strAhkHotkey))
				; substitude Alternative hotkey with corresponding regular hotkey
				oContainingFolderItem.aaTemp.strHotkeyTypeDetected := "Navigate"
			else
				oContainingFolderItem.aaTemp.strHotkeyTypeDetected := "Launch"
			if oContainingFolderItem.SetTargetName() ; sets old g_strTargetAppName, can change aaTemp.strHotkeyTypeDetected to "Launch", can empty aaTemp.strTargetWinId if Desktop
				oContainingFolderItem.OpenFolder()
		}
		;---------------------------------------------------------
		
		;---------------------------------------------------------
		AlternativeEditFavorite()
		; we get here via Alternative menu, Edit a favorite or with Ctrl+Shift+click on a favorite
		;---------------------------------------------------------
		{
			if (o_Containers.AA[A_ThisMenu].AA.blnIsLiveMenu)
			{
				; trying to edit items inside live folder leads to edit the top parent live folder favorite
				; no need to consider column breaks or disabled items because already taken into account in .intLiveFolderParentPosition
				g_intOriginalMenuPosition := o_Containers.AA[A_ThisMenu].AA.intLiveFolderParentPosition
				o_MenuInGui := o_Containers.AA[o_Containers.AA[A_ThisMenu].AA.strLiveFolderParentPath]
				o_EditedFavorite := o_Containers.AA[o_Containers.AA[A_ThisMenu].AA.oParentMenu.AA.strMenuPath].SA[g_intOriginalMenuPosition]
			}
			else
			{
				g_intOriginalMenuPosition := A_ThisMenuItemPos
				o_MenuInGui := o_Containers.AA[A_ThisMenu]
				; no need to set o_EditedFavorite here, it will be set in GuiEditFavorite / GuiFavoriteInit
			}
			
			gosub, GuiShowFromAlternative
			gosub, GuiEditFavorite
		}
		;---------------------------------------------------------
		
		;---------------------------------------------------------
		OpenFolder()
		; returns true if open went well, otherwhise false
		;---------------------------------------------------------
		{
			; Navigate
			if (this.aaTemp.strHotkeyTypeDetected = "Navigate")
				and StrLen(g_strTargetClass) and (g_strTargetWinId)
			{
				if (this.aaTemp.strTargetAppName = "Explorer")
				{
					;------------------------------------------------------------
					; Excerpt and adapted from RMApp_Explorer_Navigate(FullPath, hwnd="") by Learning One
					; http://ahkscript.org/boards/viewtopic.php?f=5&t=526&start=20#p4673
					; http://msdn.microsoft.com/en-us/library/windows/desktop/bb774096%28v=vs.85%29.aspx
					; http://msdn.microsoft.com/en-us/library/aa752094
					;------------------------------------------------------------
					
					if !RegexMatch(this.aaTemp.strFullLocation, "#.*\\") ; prevent the hash bug in Shell.Application - when a hash in path is followed by a backslash like in "c:\abc#xyz\abc")
					{
						intCountMatch := 0
						For pExplorer in ComObjCreate("Shell.Application").Windows
						{
							if (pExplorer.hwnd = g_strTargetWinId)
							{
								intCountMatch++
								if IsInteger(this.aaTemp.strFullLocation) ; ShellSpecialFolderConstant
								{
									try pExplorer.Navigate2(this.aaTemp.strFullLocation)
									catch, objErr
										Oops(o_L["NavigateSpecialError"], this.aaTemp.strFullLocation)
								}
								else
								{
									try pExplorer.Navigate(this.aaTemp.strFullLocation)
									catch, objErr
										; Note: If an error occurs in Navigate, the error message is given by Navigate itself and this script does not
										; receive an error notification. From my experience, the following line would never be executed.
										Oops(o_L["NavigateFileError"], this.aaTemp.strFullLocation)
								}
							}
						}
						if !(intCountMatch) ; open a new window
						; for Explorer add-ons like Clover (verified - it now opens the folder in a new tab), others?
						; also when g_strTargetWinId is DOpus window and DOpus is not used
							if IsInteger(this.aaTemp.strFullLocation) ; ShellSpecialFolderConstant
								ComObjCreate("Shell.Application").Explore(this.aaTemp.strFullLocation)
							else
								SendInput, % "{F4}{Esc}{Raw}" . this.aaTemp.strFullLocation . "`n"
								; if I receive bug reports from Clover users, insert delays or fall back to; Run, Explorer "%this.aaTemp.strFullLocation%"
					}
					else
						; Workaround for the hash (aka Sharp / "#") bug in Shell.Application - occurs only when navigating in the current Explorer window
						; see http://stackoverflow.com/questions/22868546/navigate-shell-command-not-working-when-the-path-includes-an-hash
						; and http://ahkscript.org/boards/viewtopic.php?f=5&t=526&p=25287#p25274
						SendInput, % "{F4}{Esc}{Raw}" . this.aaTemp.strFullLocation . "`n"
				}
				else if (this.aaTemp.strTargetAppName = "DirectoryOpus")
				{
					if (WinExist("A") <> g_strTargetWinId) ; in case that some window just popped out, and initialy active window lost focus
						WinActivate, ahk_id %g_strTargetWinId% ; we'll activate initialy active window
					
					o_FileManagers.SA[2].RunDOpusRt("/aCmd Go", this.aaTemp.strFullLocation) ; navigate the current lister
					
				}
				else if (this.aaTemp.strTargetAppName = "TotalCommander")
				{
					if IsInteger(this.aaTemp.strFullLocation)
					{
						SendMessage, 0x433, % this.aaTemp.strFullLocation, , , ahk_class TTOTAL_CMD
						Sleep, 100 ; wait to improve SendMessage reliability
						WinActivate, ahk_class TTOTAL_CMD
					}
					else
					{
						if (WinExist("A") <> g_strTargetWinId) ; in case that some window just popped out, and initialy active window lost focus
						{
							WinActivate, ahk_id %g_strTargetWinId% ; we'll activate initialy active window
							Sleep, 200
						}
						Run, % g_aaFileManagerTotalCommander.strFileManagerPath . " /O /S /L=""" . this.aaTemp.strFullLocation . """"
						; /O existing file list, /S source-dest /L=source (active pane) - change folder in the active pane/tab
					}
				}
				else if (this.aaTemp.strTargetAppName = "QAPconnect")
				{
					if InStr(this.aaTemp.strFullLocation, " ") and !(g_aaFileManagerQAPconnect.strQAPconnectNeverQuotes)
						this.aaTemp.strFullLocation := """" . this.aaTemp.strFullLocation . """"
					strQAPconnectParamString := StrReplace(g_aaFileManagerQAPconnect.strQAPconnectCommandLine, "%Path%", this.aaTemp.strFullLocation)
					strQAPconnectParamString := StrReplace(strQAPconnectParamString, "%NewTabSwitch%")
					
					if (WinExist("A") <> g_strTargetWinId) ; in case that some window just popped out, and initialy active window lost focus
					{
						WinActivate, ahk_id %g_strTargetWinId% ; we'll activate initialy active window
						Sleep, 200
					}
					Run, % g_aaFileManagerQAPconnect.strFileManagerPath . " " . strQAPconnectParamString
				}
				else if (this.aaTemp.strTargetAppName = "Console")
				{
					if (WinExist("A") <> g_strTargetWinId) ; in case that some window just popped out, and initialy active window lost focus
						WinActivate, ahk_id %g_strTargetWinId% ; we'll activate initialy active window
					
					WinGet, strProcessName, ProcessName, ahk_id %g_strTargetWinId%
					; add /D option only for cmd.exe, not required for powershell.exe
					strCommand := "CD " . (strProcessName = "powershell.exe" ? "" : "/D ") ; must end with space
					
					if (o_Settings.Execution.blnSendToConsoleWithAlt.IniValue)
					; using ALT+0nnn ASCII codes for console with international keyboard input language
					{
						strCommand .= """" . this.aaTemp.strFullLocation . """" ; double-quotes required for PowerShell
						loop, parse, strCommand
							; ANSI characters (like "") are supported by preceeding the ASCII code with 0, but Unicode characters are not supported
							; see https://autohotkey.com/docs/commands/Send.htm#asc
							strSendToConsoleAscCodes .= "{ASC 0" . Asc(A_LoopField) . "}"
						SendInput, %strSendToConsoleAscCodes%
						
						strSendToConsoleAscCodes := ""
					}
					else
						SendInput, % "{Raw}" . strCommand . """" . this.aaTemp.strFullLocation . """" ; double-quotes required for PowerShell
					
					Sleep, 200
					SendInput, {Enter}
				}
				else if (this.aaTemp.strTargetAppName = "Dialog")
				{
					if ControlIsVisible("ahk_id " . g_strTargetWinId, "Edit1")
						strEditControl := "Edit1"
						; in standard dialog windows, "Edit1" control is the right choice
					else if ControlIsVisible("ahk_id " . g_strTargetWinId, "Edit2")
						strEditControl := "Edit2"
						; but sometimes in MS office, if condition above fails, "Edit2" control is the right choice 
					else ; if above fails - just return false and do nothing.
						return false
					
					;=== In this part (if we reached it), we'll send strLocation to control and restore control's initial text after navigating to specified folder===
					
					ControlGetText, strPrevControlText, %strEditControl%, ahk_id %g_strTargetWinId% ; we'll get and store control's initial text first
					
					; for app's (like Notepad++ v7.5.6) Save As dialog box trying to save instead of navigating if location does not end with backslash
					strFullLocationTemp := this.aaTemp.strFullLocation . (SubStr(this.aaTemp.strFullLocation, StrLen(this.aaTemp.strFullLocation), 1) <> "\" ? "\" : "")
					
					if !ControlSetTextR(strEditControl, strFullLocationTemp, "ahk_id " . g_strTargetWinId) ; set control's text to strLocation
						return false ; abort if control is not set
					
					if !ControlSetFocusR(strEditControl, "ahk_id " . g_strTargetWinId) ; focus control
						return false
					
					if (WinExist("A") <> g_strTargetWinId) ; in case that some window just popped out, and initialy active window lost focus
						WinActivate, ahk_id %g_strTargetWinId% ; we'll activate initialy active window
					
					;=== Avoid accidental hotkey & hotstring triggereing while doing SendInput - can be done simply by #UseHook, but do it if user doesn't have #UseHook in the script ===
					
					Sleep, % o_Settings.DialogBoxes.intWaitDelayInDialogBox.IniValue ; give some time to control before sending {Enter} to it
					If (A_IsSuspended)
						blnWasSuspended := True
					if (!blnWasSuspended)
						Suspend, On
					; Changed from SendInput to SendEvent in v8.0.9.2 to introduce a key delay to solve issue with Firefox dialog box
					; SendInput, {End}{Space}{Backspace}{Enter} ; silly but necessary part - go to end of control, send dummy space, delete it, and then send enter
					SetKeyDelay, % o_Settings.DialogBoxes.intWaitDelayInDialogBox.IniValue
					SendEvent, {End}{Space}{Backspace}{Enter} ; silly but necessary part - go to end of control, send dummy space, delete it, and then send enter
					if (!blnWasSuspended)
						Suspend, Off
					
					Sleep, % o_Settings.DialogBoxes.intWaitDelayInDialogBox.IniValue ; give some time to control after sending {Enter} to it
					ControlGetText, strControlTextAfterNavigation, %strEditControl%, ahk_id %g_strTargetWinId% ; sometimes controls automatically restore their initial text
					if (strControlTextAfterNavigation <> strPrevControlText)
						ControlSetTextR(strEditControl, strPrevControlText, "ahk_id " . g_strTargetWinId) ; we'll set control's text to its initial text
					
					if (WinExist("A") <> g_strTargetWinId) ; sometimes initialy active window loses focus, so we'll activate it again
						WinActivate, ahk_id %g_strTargetWinId%
				}
				else ; Unknown
				{
					; avoid an error message if target app name is unknown
					Oops(o_L["OopsUnknownTargetAppName"])
					return false
				}
			}
			else ; New window
			; this.aaTemp.strHotkeyTypeDetected = "Launch" (new window) or !StrLen(g_strTargetClass) or (g_strTargetWinId = 0) ; for situations where the target window could not be detected
			{
				; updates g_strNewWindowId with new Explorer window ID
				if (this.aaTemp.strTargetAppName = "Explorer")
				{
					if (this.aaTemp.saFavoriteWindowPosition[1] or g_aaFileManagerExplorer.blnOpenFavoritesOnActiveMonitor)
					{
						; get new window ID
						; when run -> pid? if not scan Explorer ids
						this.SetExplorersIDs() ;  refresh the list of existing Explorer windows this.aaTemp.strExplorerIDs (was g_strExplorerIDs)
						strExplorerIDsBefore := this.aaTemp.strExplorerIDs ;  save the list before launching this new Explorer
					}
					
					if (StrLen(this.AA.FavoriteArguments)
						or (g_blnAlternativeMenu and g_strAlternativeMenu = o_L["MenuAlternativeNewWindow"])
						or this.aaTemp.saFavoriteWindowPosition[1] or g_aaFileManagerExplorer.blnOpenFavoritesOnActiveMonitor)
						; This technique creates a new Explorer instance at every call unless the current location is already an active Explorer window (as of Win 10).
						; It is preferred to "Run, %this.aaTemp.strFullLocation%" because it gives better result getting the new Explorer window ID required to move the window.
						Run, % "Explorer """ . this.aaTemp.strFullLocation . """", , % (this.aaTemp.saFavoriteWindowPosition[1] or g_aaFileManagerExplorer.blnOpenFavoritesOnActiveMonitor ? "Hide" : "")
					else
					{
						; When moving the window is not required and there is no parameter, this technique is preferred because, if call multiple times, it uses the
						; same Explorer instance created by QAP.
						Run, % this.aaTemp.strFullLocation
						g_strNewWindowId := ""
					}
					
					if (this.aaTemp.saFavoriteWindowPosition[1] or g_aaFileManagerExplorer.blnOpenFavoritesOnActiveMonitor)
					{
						Loop
						{
							if (A_Index > 20)
								; stop showing tray message from v9.3.1.9.1
								; TrayTip, % L(o_L["TrayTipInstalledTitle"], g_strAppNameText), % L(o_L["DialogErrorMoving"], this.aaTemp.strFullLocation), , 2 ; warning icon with sound
								; Sleep, 20 ; tip from Lexikos for Windows 10 "Just sleep for any amount of time after each call to TrayTip" (http://ahkscript.org/boards/viewtopic.php?p=50389&sid=29b33964c05f6a937794f88b6ac924c0#p50389)
								Break
								
							Sleep, % (this.aaTemp.saFavoriteWindowPosition[1] ? this.aaTemp.saFavoriteWindowPosition[7] : 400) ; 400 ms if opening window on the active monitor
							this.SetExplorersIDs() ;  refresh the list of existing Explorer windows this.aaTemp.strExplorerIDs
							Loop, Parse, % this.aaTemp.strExplorerIDs, |
								if !InStr(strExplorerIDsBefore, A_LoopField . "|")
								{
									g_strNewWindowId  := "ahk_id " . A_LoopField
									break
								}
							If StrLen(g_strNewWindowId)
								Break ; we have a new window
						}
					}
					if !StrLen(g_strNewWindowId) and (this.aaTemp.saFavoriteWindowPosition[1] or g_aaFileManagerExplorer.blnOpenFavoritesOnActiveMonitor)
					; we will not be able to move the window, just show it now
					{
						Sleep, 100
						WinShow, A
						WinActivate, A ; safe to activate after WinShow to prevent unexpected minimize of the Explorer window
					}
					
					strExplorerIDsBefore := ""
				}
				else if (this.aaTemp.strTargetAppName = "DirectoryOpus")
				{
					; check if DOpus lister exist before opening a folder in order to open the last used folders before adding the selected one
					if !WinExist("ahk_class dopus.lister")
					{
						Run, % g_aaFileManagerDirectoryOpus.strFileManagerPath
						WinWait, ahk_class dopus.lister, , 2 ; max 2 seconds
						Sleep, 200 ; sometimes without delay DOpus left the new tab empty
					}
					
					if (this.aaTemp.strOpenFavoriteLabel = "OpenFavoriteFromGroup")
					{
						if (this.aaTemp.blnFirstFolderOfGroup and this.AA.blnGroupReplaceWindows) or !(g_aaFileManagerDirectoryOpus.blnFileManagerUseTabs)
							strTabParameter := "NEW=nodual" ; force left in new lister
						else
						{
							if StrLen(this.aaTemp.saFavoriteWindowPosition[8])
								strTabParameter := "NEWTAB " . (this.aaTemp.saFavoriteWindowPosition[8] = "L" ? "OPENINLEFT" : "OPENINRIGHT")
							else
								strTabParameter := g_aaFileManagerDirectoryOpus.strNewTabOrWindow
						}
					}
					else
						strTabParameter := g_aaFileManagerDirectoryOpus.strNewTabOrWindow
					
					strTabParameter := StrReplace(strTabParameter, "NEWTAB", "NEWTAB=tofront") ; instead of activating by QAP as in previous versions
					o_FileManagers.SA[2].RunDOpusRt("/acmd Go ", this.aaTemp.strFullLocation, " " . strTabParameter) ; open in a new lister or tab, left or right
					; RunDOpusRt("/acmd Go ", objIniExplorersInGroup[intDOIndexPane].Name, " NEWTAB") ; open in a new tab of pane 1
					; RunDOpusRt("/acmd Go ", objIniExplorersInGroup[intDOIndexPane].Name, " OPENINRIGHT") ; open in a first tab of pane 2
					; RunDOpusRt("/acmd Go ", objIniExplorersInGroup[intDOIndexPane].Name, " OPENINRIGHT NEWTAB") ; open in a new tab of pane 2
					
					if (this.aaTemp.blnFirstFolderOfGroup) ; after the first member of the group, make sure the lister is fully launched before processing the second
						WinWait, ahk_class dopus.lister, , 2 ; max 2 seconds
					g_strNewWindowId := "ahk_class dopus.lister"
				}
				else if (this.aaTemp.strTargetAppName = "TotalCommander")
				{
					if (g_strOpenFavoriteLabel = "OpenFavoriteFromGroup")
					{
						; 0 for use default / 1 for remember, -1 Minimized / 0 Normal / 1 Maximized, Left (X), Top (Y), Width, Height, Delay, RestoreSide/Monitor; for example: "0,,,,,,,L"
						if StrLen(this.aaTemp.saFavoriteWindowPosition[8])
							strSideParameter := this.aaTemp.saFavoriteWindowPosition[8]
						else
							strSideParameter := "L"
					}
						
					if IsInteger(this.aaTemp.strFullLocation)
					{
						if !WinExist("ahk_class TTOTAL_CMD") ; open a first instance
							or InStr(g_aaFileManagerTotalCommander.strNewTabOrWindow, "/N") ; or open a new instance
							or (g_strOpenFavoriteLabel = "OpenFavoriteFromGroup" and (this.aaTemp.blnFirstFolderOfGroup and this.AA.blnGroupReplaceWindows))
						{
							Run, % g_aaFileManagerTotalCommander.strFileManagerPath
							WinWaitActive, ahk_class TTOTAL_CMD, , 10
							Sleep, 200 ; wait additional time to improve SendMessage reliability in OpenFavoriteNavigateTotalCommander
						}
						
						if (g_strOpenFavoriteLabel = "OpenFavoriteFromGroup")
						{
							if (strSideParameter = "L")
								intTCCommandFocus := 4001 ; cm_FocusLeft
							else
								intTCCommandFocus := 4002 ; cm_FocusRight
							Sleep, 100 ; wait to improve SendMessage reliability
							SendMessage, 0x433, %intTCCommandFocus%, , , ahk_class TTOTAL_CMD
						}
						
						if !InStr(g_aaFileManagerTotalCommander.strNewTabOrWindow, "/N") ; open the folder in a new tab
						{
							intTCCommandOpenNewTab := 3001 ; cm_OpenNewTab
							Sleep, 100 ; wait to improve SendMessage reliability
							SendMessage, 0x433, %intTCCommandOpenNewTab%, , , ahk_class TTOTAL_CMD
						}
						Sleep, 100 ; wait to improve SendMessage reliability in OpenFavoriteNavigateTotalCommander
						this.aaTemp.strHotkeyTypeDetected := "Navigate"
						this.OpenFolder() 
						; ??? check this:
						; Since this.aaTemp.strFullLocation is integer, OpenFavoriteNavigateTotalCommander is doing:
						; SendMessage, 0x433, %intTCCommand%, , , ahk_class TTOTAL_CMD
						; Sleep, 100 ; wait to improve SendMessage reliability
						; WinActivate, ahk_class TTOTAL_CMD
					}
					else ; normal folder
					{
						if (g_strOpenFavoriteLabel = "OpenFavoriteFromGroup")
							if (this.aaTemp.blnFirstFolderOfGroup and this.AA.blnGroupReplaceWindows) or !(g_aaFileManagerTotalCommander.blnFileManagerUseTabs)
								strTabParameter := "/N" ; /N new window
							else
								strTabParameter := "/O /T" ; /O same instance, /T new tab
						else
						{
							; g_aaFileManagerTotalCommander.strNewTabOrWindow should contain "/O /T" to open in an new tab of the existing file list (default), or "/N" to open in a new file list
							strTabParameter := g_aaFileManagerTotalCommander.strNewTabOrWindow
							strSideParameter := ""
						}
						
						if StrLen(strSideParameter)
							Run, % g_aaFileManagerTotalCommander.strFileManagerPath . " " . strTabParameter . " /" . strSideParameter . "=""" . this.aaTemp.strFullLocation . """"
						else
							; use active parameter with /S instead of L/R side parameter
							Run, % g_aaFileManagerTotalCommander.strFileManagerPath . " " . strTabParameter . " /S """ . this.aaTemp.strFullLocation . """"
						
						WinWaitActive, ahk_class TTOTAL_CMD, , 10
					}
					g_strNewWindowId := "ahk_class TTOTAL_CMD"
				}
				else if (this.aaTemp.strTargetAppName = "QAPconnect")
				{
					if InStr(this.aaTemp.strFullLocation, " ") and !(g_aaFileManagerQAPconnect.strQAPconnectNeverQuotes)
						this.aaTemp.strFullLocation := """" . this.aaTemp.strFullLocation . """"
					strQAPconnectParamString := StrReplace(g_aaFileManagerQAPconnect.strQAPconnectCommandLine, "%Path%", this.aaTemp.strFullLocation)
					strQAPconnectParamString := StrReplace(strQAPconnectParamString, "%NewTabSwitch%", g_aaFileManagerQAPconnect.strQAPconnectNewTabSwitch)
					
					Run, % g_aaFileManagerQAPconnect.strFileManagerPath . " " . strQAPconnectParamString
					
					if StrLen(g_aaFileManagerQAPconnect.strQAPconnectWindowID)
					; g_aaFileManagerQAPconnect.strQAPconnectWindowID contains "ahk_exe " and the file name of the FM executable.
					; It is used here to wait for the FM window and it is copied to g_strNewWindowId.
					{
						intPreviousTitleMatchMode := A_TitleMatchMode ; save current match mode
						SetTitleMatchMode, RegEx ; change match mode to RegEx
						; with RegEx, for example, ahk_class IEFrame searches for any window whose class name contains IEFrame anywhere
						; (because by default, regular expressions find a match anywhere in the target string).
						WinWaitActive, % g_aaFileManagerQAPconnect.strQAPconnectWindowID, , 10 ; wait for the window as identified in QAPconnect.ini
						SetTitleMatchMode, %intPreviousTitleMatchMode% ; restore previous match mode
						g_strNewWindowId := g_aaFileManagerQAPconnect.strQAPconnectWindowID
					}
					else
						g_strNewWindowId := ""
				}
				else ; Unknown
					; avoid an error message if target app name is unknown
					Oops(o_L["OopsUnknownTargetAppName"])
			}
			return true
		}
		;---------------------------------------------------------
		
		;---------------------------------------------------------
		SetExplorersIDs()
		;---------------------------------------------------------
		{
			this.aaTemp.strExplorerIDs := ""
			pExplorerWindows := ComObjCreate("Shell.Application").Windows
			for pExplorer in pExplorerWindows
			{
				strType := ""
				try strType := pExplorer.Type ; Gets the type name of the contained document object. "Document HTML" for IE windows. Should be empty for file Explorer windows.
				strWindowID := ""
				try strWindowID := pExplorer.HWND ; Try to get the handle of the window. Some ghost Explorer in the ComObjCreate may return an empty handle
				if !StrLen(strType) and StrLen(strWindowID) ; strType must be empty and strWindowID must not be empty
					this.aaTemp.strExplorerIDs .= pExplorer.HWND . "|"
			}
			ObjRelease(pExplorerWindows) ; free memory used by the object
		}
		;---------------------------------------------------------
		
		;---------------------------------------------------------
		SetWindowPosition() ; was OpenFavoriteWindowPosition
		;---------------------------------------------------------
		{
			if !StrLen(g_strNewWindowId) ; we can't access the new window
				return
			
			if (this.aaTemp.saFavoriteWindowPosition[1]) ; this has precedence on g_aaFileManagerExplorer.blnOpenFavoritesOnActiveMonitor
			{
				Sleep, % this.aaTemp.saFavoriteWindowPosition[7] * (this.aaTemp.blnFirstFolderOfGroup ? 2 : 1)
				
				if (this.aaTemp.saFavoriteWindowPosition[8] and this.aaTemp.saFavoriteWindowPosition[8] <= this.aaTemp.intNbMonitors) ; maximize or minimize on this monitor
				{
					SysGet, arrMonitorsCoordinates, Monitor, % this.aaTemp.saFavoriteWindowPosition[8]
					WinMove, %g_strNewWindowId%,
						, %arrMonitorsCoordinatesLeft% ; left
						, %arrMonitorsCoordinatesTop% ; top
				}
				; do not else
				if (this.aaTemp.saFavoriteWindowPosition[2] = -1) ; Minimized
					WinMinimize, %g_strNewWindowId%
				else if (this.aaTemp.saFavoriteWindowPosition[2] = 1) ; Maximized
					WinMaximize, %g_strNewWindowId%
				else ; Normal
				{
					; see WinRestore doc PostMessage, 0x112, 0xF120,,, %g_strNewWindowId% ; 0x112 = WM_SYSCOMMAND, 0xF120 = SC_RESTORE
					WinMove, %g_strNewWindowId%,
						, % this.aaTemp.saFavoriteWindowPosition[3] ; left
						, % this.aaTemp.saFavoriteWindowPosition[4] ; top
						, % this.aaTemp.saFavoriteWindowPosition[5] ; width
						, % this.aaTemp.saFavoriteWindowPosition[6] ; height
					WinRestore, %g_strNewWindowId%
					Sleep, % this.aaTemp.saFavoriteWindowPosition[7]
				}
			}
			else if (g_aaFileManagerExplorer.blnOpenFavoritesOnActiveMonitor and (this.aaTemp.intNbMonitors > 1) and (this.aaTemp.strTargetAppName = "Explorer") and (this.aaTemp.strHotkeyTypeDetected = "Launch"))
				and GetWindowPositionOnActiveMonitor(g_strNewWindowId, intMonitorReferencePositionX, intMonitorReferencePositionY, intNewWindowX, intNewWindowY)
			{
				; offset multiple Explorer windows positioned at center of screen (from -100/-100 to +80/+80
				g_intNewWindowOffset := Mod(g_intNewWindowOffset + 1, 9) ; value 0..8
				intNewWindowX := intNewWindowX + ((g_intNewWindowOffset - 4) * 20) ; value (-4 * 20)..(+4 * 20)
				intNewWindowY := intNewWindowy + ((g_intNewWindowOffset - 4) * 20)
				
				WinMove, %g_strNewWindowId%, , %intNewWindowX%, %intNewWindowY%
				Sleep, 100
			}
			
			if (this.aaTemp.saFavoriteWindowPosition[2] <> -1) ; not Minimized
			{
				WinShow, %g_strNewWindowId%
				WinActivate, %g_strNewWindowId% ; safe to activate after WinShow to prevent unexpected minimize of the Explorer window
			}
		}
		;---------------------------------------------------------
		
		;---------------------------------------------------------
		OpenGroup()
		;---------------------------------------------------------
		{
			if (this.AA.blnGroupReplaceWindows) ; was g_blnGroupReplaceWindows
				gosub, OpenGroupOfFavoritesCloseExplorers
				
			intFolderItemsCount := 0
			for intMemberNumber, o_GroupMember in this.AA.oSubMenu.SA ; o_Containers.AA[o_L["MainMenuName"] . " " . objThisGroupFavorite.FavoriteLocation] 
			{
				if !(o_GroupMember.AA.blnFavoriteDisabled)
				{
					If InStr("Folder|Special|FTP", o_GroupMember.AA.strFavoriteType)
						intFolderItemsCount++ ; do it that way because first member could be other than a folder
					o_GroupMember.aaTemp.blnFirstFolderOfGroup := (intFolderItemsCount = 1) ; was g_blnFirstFolderOfGroup
					
					Sleep, % o_GroupMember.AA.intGroupRestoringDelay + 200 ; add 200 ms as minimal default delay
					o_GroupMember.OpenFavorite(this.aaTemp.strMenuTriggerLabel, this.aaTemp.strOpenFavoriteLabel
						, "" ; never use target window when launched in a group
						, "Launch") ; all favorites in group are for Launch, never navigate
				}
			}
		}
		;---------------------------------------------------------
		
		;---------------------------------------------------------
		PasteSnippet()
		;---------------------------------------------------------
		{
			strWaitTime := 10

			WinGetClass, strClassSnippet, % "ahk_id " . this.aaTemp.strTargetWinId

			if (g_blnLaunchFromTrayIcon or WindowIsTray(strClassSnippet) or WindowIsDesktop(strClassSnippet) or StrLen(this.AA.strSnippetPrompt))
			{
				this.aaTemp.strSnippetPromptExpanded := ExpandPlaceholders(this.AA.strSnippetPrompt, ""
					, (InStr(this.AA.strSnippetPrompt, "{CUR_") ? GetCurrentLocation(g_strTargetClass, this.aaTemp.strTargetWinId) : -1)
					, (InStr(this.AA.strSnippetPrompt, "{SEL_") ? GetSelectedLocation(g_strTargetClass, this.aaTemp.strTargetWinId) : -1))
				ToolTip, % L((StrLen(this.aaTemp.strSnippetPromptExpanded) ? this.aaTemp.strSnippetPromptExpanded . "`n" : "")
					. (this.AA.blnSnippetMacroMode = 1 ? o_L["ToolTipSnippetWaitMacro"] : o_L["ToolTipSnippetWaitText"])
						, o_L["ToolTipSnippetWaitEnter"], o_L["ToolTipSnippetWaitSpace"], strWaitTime, o_L["ToolTipSnippetWaitEscape"])
				Input, strTemp, T%strWaitTime%, {Enter}{Space}{Escape}
				strErrorLevel := ErrorLevel
				ToolTip
				if !InStr(strErrorLevel, "EndKey:") or InStr(strErrorLevel, "Escape")
					return
			}
			else
				WinActivate, % "ahk_id " . this.aaTemp.strTargetWinId
			
			; this.AA.blnSnippetMacroMode is 1 for Macro snippet, anything else is Text snippet
			if (this.AA.blnSnippetMacroMode <> 1) ; snippet of type Text
			{
				BlockInput, On
				objPrevClipboard := ClipboardAll ; save the clipboard (text or data)
				Sleep, % o_Settings.Snippets.arrWaitDelayInSnippet.IniValue[1] ; safety delay default 40 ms
				ClipBoard := ""
				Sleep, % o_Settings.Snippets.arrWaitDelayInSnippet.IniValue[2] ; safety delay default 80 ms
				; DecodeSnippet: convert from raw content (as from ini file) to display format (when f_blnProcessEOLTab is true) or to paste format
				ClipBoard := DecodeSnippet(this.aaTemp.strLocationWithPlaceholders, true)
				ClipWait, 0 ; SecondsToWait, specifying 0 is the same as specifying 0.5
				intErrorLevel := ErrorLevel
				if (intErrorLevel)
					return
				
				; avoid using SendInput to send ^v
				; (see: https://autohotkey.com/board/topic/77928-ctrl-v-sendinput-v-is-not-working-in-many-applications/#entry495555)
				; tried "ControlSend, %g_strTargetControl%, ^v" with disappointing results (not working on Explorer address zone, send "v" to Word, etc.)
				Sleep, % o_Settings.Snippets.arrWaitDelayInSnippet.IniValue[3] ; delay required by some application, including Notepad, default 180 ms
				SendEvent, ^v
				BlockInput, Off
				Sleep, 100 ; safety
				
				Clipboard := objPrevClipboard ; Restore the original clipboard
			}
			else ; snippet of type Macro
			{
				; DecodeSnippet: convert from raw content (as from ini file) to display format (when f_blnProcessEOLTab is true) or to paste format
				strTemp := DecodeSnippet(this.aaTemp.strLocationWithPlaceholders) ; g_objThisFavorite.FavoriteLocation with expanded placeholders

				Loop
				{
					if InStr(strTemp, g_strSnippetCommandStart)
					{
						intCommandStart := InStr(strTemp, g_strSnippetCommandStart)
						intCommandEnd := InStr(strTemp, g_strSnippetCommandEnd, , intCommandStart)
						strSend := SubStr(strTemp, 1, intCommandStart - 1)
						strCommand := Trim(SubStr(strTemp, intCommandStart + 2, intCommandEnd - intCommandStart - 2))
						
						if StrLen(strSend)
							Send, %strSend% ; SendMode is Input mode by default until user sends a SetKeyDelay where it would be changed to Event mode
						
						if StrLen(strCommand)
						; {&Sleep:n} or {&n}: pause sending the snippet for n milliseconds (see https://autohotkey.com/docs/commands/Sleep.htm)
						; {&SetKeyDelay:n, option}: speed down the sending of the snippet (see https://autohotkey.com/docs/commands/SetKeyDelay.htm)
						; {&KeyWait:keyname, options}: pause sending the snippet until user press the specified key, option D by default, added option B to "Beep" (see https://autohotkey.com/docs/commands/KeyWait.htm)
						{
							if IsInteger(strCommand) ; shortcut {&n} for {&Sleep:n} command
							{
								strOptions := strCommand ; copy the n of milliseconds to sleep
								strCommand := "Sleep" ; set the shortcut command
							}
							else if InStr(strCommand, g_strSnippetOptionsSeparator)
							{
								strOptions := SubStr(strCommand, InStr(strCommand, g_strSnippetOptionsSeparator) + 1)
								strCommand := Trim(SubStr(strCommand, 1, InStr(strCommand, g_strSnippetOptionsSeparator) - 1))
							}
							else
								strOptions := ""

							saOptions := StrSplit(strOptions, ",")
							loop, % saOptions.MaxIndex()
								saOptions[A_Index] := Trim(saOptions[A_Index])
							
							if (strCommand = "Sleep")
								Sleep, % saOptions[1]
							else if (strCommand = "SetKeyDelay")
							{
								SendMode, Event ; to support key delay
								SetKeyDelay, % saOptions[1], % saOptions[2]
							}
							else if (strCommand = "KeyWait")
							{
								strOptions := Trim(saOptions[2] . " " . saOptions[3] . " " . saOptions[4])
								if !InStr(strOptions, "D")
									strOptions .= " D"
								ToolTip, % L(o_L["ToolTipSnippetKeyWait"], saOptions[1])
								if InStr(strOptions, "B")
									SoundBeep
								KeyWait, % saOptions[1], %strOptions%
								ToolTip
							}
						}
						
						strTemp := SubStr(strTemp, intCommandEnd + 1) ; loop with the remaining of the snippet
					}
					else ; this is the last section of the snippet
					{
						if StrLen(strTemp)
							Send, %strTemp%
						break
					}
				}

				SendMode, Input ; restore default SendMode to Input mode
			}
			;------------------------------------------------------------
		}
		;---------------------------------------------------------
		
		;---------------------------------------------------------
		SwitchFolderOrApp()
		;---------------------------------------------------------
		{
			saFolderWindowId := StrSplit(this.AA.strFavoriteLocation, "|")
			if (saFolderWindowId[1] = "EX") ; Explorer
				WinActivate, % "ahk_id " . saFolderWindowId[2]
			else if (saFolderWindowId[1] = "DO") ; Directory Opus
				; double % for DOpusRT (http://resource.dopus.com/viewtopic.php?f=3&t=23013#p124395)
				; this.strFavoriteName := StrReplace(this.strFavoriteName, "%", "%%")
				; remove because does not seem to be required anymore?
				o_FileManagers.SA[2].RunDOpusRt("/acmd Go ", this.AA.strFavoriteName, " EXISTINGLISTER") ; activate an existing lister listing this path
			else ; APP
				WinActivate, % "ahk_id " . saFolderWindowId[2]
		}
		;---------------------------------------------------------
		
		;---------------------------------------------------------
		OpenDirectoryOpusLayout()
		{
			Run, % """" . g_aaFileManagerDirectoryOpus.strDirectoryOpusRtPath . """ " . "/acmd Prefs LAYOUT=""" . this.AA.strFavoriteLocation . """"
		}
		;---------------------------------------------------------
		
		;---------------------------------------------------------
		LaunchApplication()
		;---------------------------------------------------------
		{
			; since 1.0.95.00, Run supports verbs with parameters, such as Run *RunAs %A_ScriptFullPath% /Param.
			; see RunAs doc remarks
			; Diag(A_ThisLabel . ":RunAs", (g_objThisFavorite.blnFavoriteElevate or g_strAlternativeMenu = o_L["MenuAlternativeRunAs"] ? "*RunAs " : "No"))
			; Diag(A_ThisLabel . ":g_strFullLocation", g_strFullLocation)
			; Diag(A_ThisLabel . ":strAppWorkingDirWithPlaceholders", strAppWorkingDirWithPlaceholders)
			
			Run, % (this.AA.blnFavoriteElevate or g_strAlternativeMenu = o_L["MenuAlternativeRunAs"] ? "*RunAs " : "") . this.aaTemp.strFullLocation
				, % this.aaTemp.strAppWorkingDirWithPlaceholders, UseErrorLevel, intPid
			
			if (ErrorLevel = "ERROR")
			{
				if (A_LastError <> 1223)
					Oops(o_L["OopsUnknownTargetAppName"])
				; else no error message - error 1223 because user canceled on the Run as admnistrator prompt
			}
			else if (this.aaTemp.saFavoriteWindowPosition[1] and intPid and o_Settings.Execution.blnTryWindowPosition.IniValue)
				g_strNewWindowId := "ahk_pid " . intPid
		}
		;---------------------------------------------------------
		
		;---------------------------------------------------------
		LaunchWindowsApp()
		;---------------------------------------------------------
		{
			strTempArguments := ExpandPlaceholders(this.AA.strFavoriteArguments, this.aaTemp.strFullLocation
				, (InStr(strTempArguments, "{CUR_") ? GetCurrentLocation(g_strTargetClass, g_strTargetWinId) : -1)
				, (InStr(strTempArguments, "{SEL_") ? GetSelectedLocation(g_strTargetClass, g_strTargetWinId) : -1))
			; from https://www.reddit.com/r/windows/comments/4aac5b/how_do_i_run_edge_browser_with_autohotkey/
			objIApplicationActivationManager := ComObjCreate("{45BA127D-10A8-46EA-8AB7-56EA9078943C}", "{2e941141-7f97-4756-ba1d-9decde894a3d}")
			strTempArguments := ExpandPlaceholders(this.AA.strFavoriteArguments, this.aaTemp.strFullLocation
				, (InStr(strTempArguments, "{CUR_") ? GetCurrentLocation(g_strTargetClass, g_strTargetWinId) : "")
				, (InStr(strTempArguments, "{SEL_") ? GetSelectedLocation(g_strTargetClass, g_strTargetWinId) : ""))
			DllCall(NumGet(NumGet(objIApplicationActivationManager + 0) + 3 * A_PtrSize)
				, "Ptr", objIApplicationActivationManager
				, "Str", this.aaTemp.strFullLocation
				, "Str", strTempArguments
				, "UInt", 0
				, "IntP", intProcessId)
			ObjRelease(objIApplicationActivationManager)
		}
		;---------------------------------------------------------
		
		;---------------------------------------------------------
		ActivateRunningApplication()
		;---------------------------------------------------------
		{
			; If an app is installed in more one location, it will be activated only if the one running is from the same location as the favorite.
			; If the favorite has "Parameters" in "Advanced Settings", it will be launched anyway, regardless of an existing running instance.
			; If the favorite has "Start in" option or "Window Options", they will be ignored if we activate the existing instance of the app.
			; (since v8.7) Running instance will be activated only if it has the requested UAC level (elevated - as admin - or normal)
			
			WinGet, intMinMax, MinMax, % "ahk_id " . this.aaTemp.strAppID
			if (intMinMax = -1) ; restore if window is minimized
				WinRestore, % "ahk_id " . this.aaTemp.strAppID
			WinActivate, % "ahk_id " . this.aaTemp.strAppID ; strAppID from AppIsRunning
		}
		;---------------------------------------------------------
		
		;---------------------------------------------------------
		LaunchFullLocation()
		;---------------------------------------------------------
		{
			Run, % this.aaTemp.strFullLocation, , UseErrorLevel, intPid
			if (ErrorLevel = "ERROR")
				Oops(o_L["OopsUnknownTargetAppName"])
			else
				; intPid may not be set for some doc types; could help if document is launch with a FavoriteLaunchWith
				if (this.aaTemp.saFavoriteWindowPosition[1] and intPid and o_Settings.Execution.blnTryWindowPosition.IniValue)
					g_strNewWindowId := "ahk_pid " . intPid
		}
		;---------------------------------------------------------
		
		;---------------------------------------------------------
		SetTargetName()
		; set this.aaTemp.strTargetAppName (was g_strTargetAppName)
		;---------------------------------------------------------
		{
			if WindowIsExplorer(g_strTargetClass)
				this.aaTemp.strTargetAppName := "Explorer"
			else if WindowIsDesktop(g_strTargetClass)
				this.aaTemp.strTargetAppName := "Desktop"
			; else if WindowIsTray(g_strTargetClass)
			;	this.aaTemp.strTargetAppName := "Tray"
			else if WindowIsConsole(g_strTargetClass)
				this.aaTemp.strTargetAppName := "Console"
			else if WindowIsDialog(g_strTargetClass, this.aaTemp.strTargetWinId)
				this.aaTemp.strTargetAppName := "Dialog"
			; else if WindowIsTreeview(this.aaTemp.strTargetWinId)
			;	this.aaTemp.strTargetAppName := "Treeview"
			else if WindowIsDirectoryOpus(g_strTargetClass) and (o_FileManagers.P_intActiveFileManager = 2)
				this.aaTemp.strTargetAppName := "DirectoryOpus"
			else if WindowIsTotalCommander(g_strTargetClass) and (o_FileManagers.P_intActiveFileManager = 3)
				this.aaTemp.strTargetAppName := "TotalCommander"
			else if WindowIsQAPconnect(this.aaTemp.strTargetWinId) and (o_FileManagers.P_intActiveFileManager = 4)
				this.aaTemp.strTargetAppName := "QAPconnect"
			else if WindowIsQuickAccessPopup(g_strTargetClass)
			{
				if (o_FileManagers.P_intActiveFileManager = 2)
					this.aaTemp.strTargetAppName := "DirectoryOpus"
				else if (o_FileManagers.P_intActiveFileManager = 3)
					this.aaTemp.strTargetAppName := "TotalCommander"
				else if (o_FileManagers.P_intActiveFileManager = 4)
					this.aaTemp.strTargetAppName := "QAPconnect"
				else
					this.aaTemp.strTargetAppName := "Explorer"
				this.aaTemp.strHotkeyTypeDetected := "Launch"
			}
			else
				this.aaTemp.strTargetAppName := "Unknown"

			if (this.aaTemp.strTargetAppName = "Desktop")
			{
				this.aaTemp.strTargetWinId := "" ; never use target window when clicked on the desktop
				this.aaTemp.strHotkeyTypeDetected := "Launch" ; never navigate when clicked on the desktop
			}

			if (this.aaTemp.strHotkeyTypeDetected = "Launch")
				if (this.aaTemp.strOpenFavoriteLabel = "OpenFavoriteFromGroup" and this.AA.strGroupRestoreWithExplorerOrOther = "Windows Explorer")
					this.aaTemp.strTargetAppName := "Explorer"
				else if InStr("Desktop|Dialog|Console|Unknown", this.aaTemp.strTargetAppName) ; these targets cannot launch in a new window
					or (o_FileManagers.P_intActiveFileManager > 1) ; use file managers DirectoryOpus, TotalCommander or QAPconnect
					if (o_FileManagers.P_intActiveFileManager = 2)
						this.aaTemp.strTargetAppName := "DirectoryOpus"
					else if (o_FileManagers.P_intActiveFileManager = 3)
						this.aaTemp.strTargetAppName := "TotalCommander"
					else if (o_FileManagers.P_intActiveFileManager = 4)
						this.aaTemp.strTargetAppName := "QAPconnect"
					else
						this.aaTemp.strTargetAppName := "Explorer"
					
			return (this.aaTemp.strTargetAppName <> "Unknown")
		}
		;---------------------------------------------------------
		
		;---------------------------------------------------------
		SetFullLocation()
		; set this.aaTemp.strFullLocation (was g_strFullLocation)
		;---------------------------------------------------------
		{
			; Directory Opus pidl value like "?AAAAFAAfUOBP0CDqOmkQotgIACswMJ0AAA=="
			if (o_FileManagers.P_intActiveFileManager = 2 and SubStr(this.AA.strFavoriteLocation, 1, 1) = "?")
			{
				this.aaTemp.strFullLocation := this.AA.strFavoriteLocation
				this.aaTemp.strTargetAppName := "DirectoryOpus"
				if (this.aaTemp.strHotkeyTypeDetected = "Navigate" and !WindowIsDirectoryOpus(g_strTargetClass))
					this.aaTemp.strHotkeyTypeDetected := "Launch"
			}
			; Directory Opus Layouts
			else if (this.aaTemp.strOpenFavoriteLabel = "OpenDOpusLayout")

				this.aaTemp.strFullLocation := this.AA.strFavoriteLocation

			else
			{
				this.aaTemp.strFullLocation := this.aaTemp.strLocationWithPlaceholders

				if (this.AA.strFavoriteType = "FTP")
				{
					; ftp://username:password@ftp.domain.ext/public_ftp/incoming/
					if (this.aaTemp.strTargetAppName = "TotalCommander")
						or !(this.AA.blnFavoriteFtpEncoding) ; do not encode
					{
						; must NOT encode username and password with UriEncode
						this.aaTemp.strLoginName := this.AA.strFavoriteLoginName
						this.aaTemp.strPassword := this.AA.strFavoritePassword
					}
					else
					{
						; must encode username and password with UriEncode
						this.aaTemp.strLoginName := UriEncode(this.AA.strFavoriteLoginName)
						this.aaTemp.strPassword := UriEncode(this.AA.strFavoritePassword)
					}
					
					this.aaTemp.strFullLocation := StrReplace(this.aaTemp.strFullLocation, "ftp://"
						, "ftp://" . this.aaTemp.strLoginName
						. (StrLen(this.aaTemp.strPassword) ? ":" . this.aaTemp.strPassword : "") . (StrLen(this.aaTemp.strLoginName) ? "@" : ""))
				}
				else
					if InStr("Folder|Document|Application", this.AA.strFavoriteType) ; not for URL, Special Folder and others
						and !LocationIsHTTP(this.AA.strFavoriteLocation) ; except if the folder location is on a server (like WebDAV)
					
						; placeholders are already expanded but neet to expand other variables
						; make the location absolute based on the current working directory
						blnFileExist := FileExistInPath(this.aaTemp.strFullLocation) ; return this.aaTemp.strFullLocation with expanded relative path, envvars and user variables, and absolute location if in PATH
						
					else if (this.AA.strFavoriteType = "WindowsApp")
					{
						if (SubStr(this.aaTemp.strFullLocation, 1, 7) = "Custom:")
							this.aaTemp.strFullLocation := SubStr(this.aaTemp.strFullLocation, 8)
						; for archive, older method of launching Windows Apps before using IApplicationActivationManager
						; this.aaTemp.strFullLocation := "shell:Appsfolder\" . this.aaTemp.strFullLocation
						
						return true ; do no process remaining options (.FavoriteLaunchWith and .FavoriteArguments)
					}
					else if (this.AA.strFavoriteType = "Special")
						this.aaTemp.strFullLocation := GetSpecialFolderLocation(this.aaTemp.strHotkeyTypeDetected, this.aaTemp.strTargetAppName, this.AA)
							; can change values of this.aaTemp.strHotkeyTypeDetected and this.aaTemp.strTargetAppName
					; else URL or QAP (no need to expand or make absolute), keep this.aaTemp.strFullLocation as in g_objThisFavorite.FavoriteLocation

				if StrLen(this.AA.strFavoriteLaunchWith) and !InStr("Application|Snippet", this.AA.strFavoriteType) ; ignore for Application or Snippet favorites
					this.aaTemp.strFullLocation := this.aaTemp.strExpandedLaunchWith . " """ . this.aaTemp.strFullLocation . """" ; enclose document path in double-quotes

				if StrLen(this.AA.strFavoriteArguments)
					; let user enter double-quotes as required by his arguments
					this.aaTemp.strFullLocation .= " " . ExpandPlaceholders(this.AA.strFavoriteArguments, this.aaTemp.strFullLocation
						, (InStr(this.AA.strFavoriteArguments, "{CUR_") ? GetCurrentLocation(g_strTargetClass, this.aaTemp.strTargetWinId) : -1)
						, (InStr(this.AA.strFavoriteArguments, "{SEL_") ? GetSelectedLocation(g_strTargetClass, this.aaTemp.strTargetWinId) : -1))
				
			}
			
			return StrLen(this.aaTemp.strFullLocation) ; if empty, SetFullLocation was aborted, return false, else return true
		}
		;---------------------------------------------------------

		;---------------------------------------------------------
		FileExistIfMust()
		;---------------------------------------------------------
		{
			if InStr("Folder|Document|Application", this.AA.strFavoriteType) ; for these favorites, file/folder must exist on file system
				and (g_strAlternativeMenu <> o_L["MenuAlternativeEditFavorite"]) ; except if we edit the favorite
				and !LocationIsHTTP(this.aaTemp.strLocationWithPlaceholders) ; except if the folder location is on a server (WebDAV)
				and !(SubStr(this.aaTemp.strLocationWithPlaceholders, 1, 3) = "\\\" and this.aaTemp.strOpenFavoriteLabel = "OpenFavoriteHotlist")
					; except if the location is a TC Hotlist folder managed by a file system plugin (like VirtualPanel)
				and !(SubStr(this.aaTemp.strLocationWithPlaceholders, 1, 1) = "?" and this.aaTemp.strOpenFavoriteLabel = "OpenDOpusFavorite")
					; except if the location is a DOpus Favorite special folder identified with <pidl>
				and (this.aaTemp.strOpenFavoriteLabel <> "OpenDOpusLayout")
					; except if the location is a DOpus Layout (with format "layout_name_or_sub/sub/name")
					
				if !FileExistInPath(this.aaTemp.strLocationWithPlaceholders) ; return g_strLocationWithPlaceholders with expanded relative path and envvars, also search in PATH
				{
					Gui, 1:+OwnDialogs
					MsgBox, % (this.AA.blnFavoritePseudo ? 0 : 4)
						, % L(o_L["DialogFavoriteDoesNotExistTitle"], g_strAppNameText)
						, % L(o_L["DialogFavoriteDoesNotExistPrompt"], this.AA.strFavoriteLocation
							, (StrLen(this.aaTemp.strLocationWithPlaceholders) and this.aaTemp.strLocationWithPlaceholders <> this.AA.strFavoriteLocation ? " (" . this.aaTemp.strLocationWithPlaceholders . ")" : ""))
							. (this.AA.blnFavoritePseudo ? "" : "`n`n" . o_L["DialogFavoriteDoesNotExistEdit"])
					IfMsgBox, Yes
					{
						g_blnAlternativeMenu := true
						g_strAlternativeMenu := o_L["MenuAlternativeEditFavorite"]
						return true
					}
					else
						return false
				}
				
				if StrLen(this.AA.strFavoriteAppWorkingDir) and (this.AA.strFavoriteType = "Application")
				{
					this.aaTemp.strAppWorkingDirWithPlaceholders := ExpandPlaceholders(this.AA.strFavoriteAppWorkingDir, this.aaTemp.strLocationWithPlaceholders
						, (InStr(this.AA.strFavoriteAppWorkingDir, "{CUR_") ? GetCurrentLocation(g_strTargetClass, this.aaTemp.strTargetWinId) : -1)
						, (InStr(this.AA.strFavoriteAppWorkingDir, "{SEL_") ? GetSelectedLocation(g_strTargetClass, this.aaTemp.strTargetWinId) : -1))

					strAppWorkingDirBeforeFileExist := this.aaTemp.strAppWorkingDirWithPlaceholders
					if StrLen(this.aaTemp.strAppWorkingDirWithPlaceholders) and !FileExistInPath(this.aaTemp.strAppWorkingDirWithPlaceholders)
						; FileExistInPath returns strAppWorkingDirWithPlaceholders with expanded relative path and envvars, also search in PATH
						and (g_strAlternativeMenu <> o_L["MenuAlternativeEditFavorite"])
					{
						Gui, 1:+OwnDialogs
						MsgBox, % (this.AA.blnFavoritePseudo ? 0 : 4)
							, % L(o_L["DialogFavoriteWorkingDirNotFoundTitle"], g_strAppNameText)
							, % L(o_L["DialogFavoriteWorkingDirNotFoundPrompt"], this.AA.strFavoriteName, this.AA.strFavoriteAppWorkingDir
							. (this.AA.strFavoriteAppWorkingDir <> strAppWorkingDirBeforeFileExist ? " (" . strAppWorkingDirBeforeFileExist . ")": ""))
							. (this.AA.blnFavoritePseudo ? "" : "`n`n" . o_L["DialogFavoriteDoesNotExistEdit"])
						IfMsgBox, Yes
						{
							g_blnAlternativeMenu := true
							g_strAlternativeMenu := o_L["MenuAlternativeEditFavorite"]
						}
						else
							return false
					}
				}
				
				if StrLen(this.AA.strFavoriteLaunchWith) and !InStr("Application|Snippet", this.AA.strFavoriteType) ; ignore for Application or Snippet favorites
				{
					this.aaTemp.strExpandedLaunchWith := this.AA.strFavoriteLaunchWith
					blnFileExist := FileExistInPath(this.aaTemp.strExpandedLaunchWith) ; return this.aaTemp.strExpandedLaunchWith expanded and searched in PATH
					
					if !(blnFileExist) and (g_strAlternativeMenu <> o_L["MenuAlternativeEditFavorite"])
					{
						Gui, 1:+OwnDialogs
						MsgBox, % (this.AA.blnFavoritePseudo ? 0 : 4)
							, %g_strAppNameText%, % L(o_L["OopsLaunchWithNotFound"], this.aaTemp.strExpandedLaunchWith)
							. (this.AA.blnFavoritePseudo ? "" : " " . o_L["DialogFavoriteDoesNotExistEdit"])
						IfMsgBox, Yes
						{
							g_blnAlternativeMenu := true
							g_strAlternativeMenu := o_L["MenuAlternativeEditFavorite"]
						}
						else 
							return false
					}
				}
				
			; location (and working directory for applications) exists or do not have to exist on file system
			return true
		}
		;---------------------------------------------------------
		
		;---------------------------------------------------------
		OpenFavoritePlaySound()
		;---------------------------------------------------------
		{
			if (SubStr(this.AA.strFavoriteSoundLocation, 1, 2) = "*|")
				intFavoriteSoundType := 1 ; sequence
			else if (SubStr(this.AA.strFavoriteSoundLocation, 1, 1) = "*")
				intFavoriteSoundType := 2 ; system
			else
				intFavoriteSoundType := 3 ; file

			if (intFavoriteSoundType = 1)
				Loop, Parse, % this.AA.strFavoriteSoundLocation, |, *
					if StrLen(A_LoopField)
					{
						saThisSound := StrSplit(A_LoopField, "@")
						SoundBeep, % saThisSound[2], % saThisSound[1]
					}
			
			if (intFavoriteSoundType > 1) ; do not use else with previous if(s)
			{
				strFavoriteSoundLocationExpanded := (intFavoriteSoundType = 2
					? this.AA.strFavoriteSoundLocation ; system
					: PathCombine(A_WorkingDir, EnvVars(this.AA.strFavoriteSoundLocation))) ; file
					
				if (intFavoriteSoundType = 3) ; if file do not exist play system sound
					if !FileExist(strFavoriteSoundLocationExpanded)
						strFavoriteSoundLocationExpanded := "*16" ; Hand (stop/error)
					
				SoundPlay, %strFavoriteSoundLocationExpanded%
			}
		}
		;---------------------------------------------------------

		;---------------------------------------------------------
		GetItemTypeLabelForList()
		;---------------------------------------------------------
		{
			if (this.AA.intFavoriteFolderLiveLevels)
				strType := o_L["DialogFavoriteFolderLiveType"]
			else
				strType := o_Favorites.GetFavoriteTypeObject(this.AA.strFavoriteType).strFavoriteTypeShortName
			if (this.AA.blnFavoriteDisabled)
				strType := BetweenParenthesis(strType)
			
			return strType
		}
		;---------------------------------------------------------

		;---------------------------------------------------------
		GetDefaultIcon4Type(strGuiFavoriteLocation)
		;---------------------------------------------------------
		{
			if InStr("|Menu|External", "|" . this.AA.strFavoriteType, true)
				; default submenu icon
				return "iconSubmenu"
			else if (this.AA.strFavoriteType = "Group")
				; default group icon
				return "iconGroup"
			else if (this.AA.strFavoriteType = "Folder")
				if (this.AA.intFavoriteFolderLiveLevels)
					; default live folder icon
					return "iconFolderLive"
				else
					; default folder icon
					return "iconFolder"
			else if (this.AA.strFavoriteType = "URL")
				; default browser icon
				return GetIcon4Location(g_strTempDir . "\default_browser_icon.html")
			else if (this.AA.strFavoriteType = "FTP")
				; default FTP icon
				return "iconFTP"
			else if (this.AA.strFavoriteType = "Snippet")
				return (StrSplit(this.AA.strFavoriteLaunchWith, ";")[1] ? "iconPasteSpecial" : "iconPaste") ; check first snippet property value (true: macro mode / else text)
			else if InStr("|Document|Application", "|" . this.AA.strFavoriteType) and StrLen(strGuiFavoriteLocation)
				; default icon for the selected file in add/edit favorite
				return GetIcon4Location(strGuiFavoriteLocation)
			else if (this.AA.strFavoriteType = "Special")
				; default icon for new Special folder if new location exists, or, if not, for existing favorite object location
				return o_SpecialFolders.AA[(StrLen(strGuiFavoriteLocation) ? strGuiFavoriteLocation : this.AA.strFavoriteLocation)].strDefaultIcon
			else if (this.AA.strFavoriteType = "QAP")
				; default icon for new QAP Feature if new location exists, or, if not, for existing favorite object location
				return o_QAPfeatures.AA[(StrLen(strGuiFavoriteLocation) ? strGuiFavoriteLocation : this.AA.strFavoriteLocation)].strDefaultIcon
			else if (this.AA.strFavoriteType = "Text" or this.AA.strFavoriteType = "X" or this.AA.strFavoriteType = "K")
				return "iconNoIcon"
			else if (this.AA.strFavoriteType = "WindowsApp")
				return "iconDesktop"
			else ; should not
				return "iconUnknown"
		}
		;---------------------------------------------------------

		;---------------------------------------------------------
		UpdateMenusPathAndLocation(strNewDestinationMenu)
		; update submenus and their childrens to the new path of the parent menu
		;---------------------------------------------------------
		{
			strNewMenuPath := strNewDestinationMenu . g_strMenuPathSeparatorWithSpaces . this.AA.strFavoriteName
				. (o_EditedFavorite.AA.strFavoriteType = "Group" ? " " . g_strGroupIndicatorPrefix . g_strGroupIndicatorSuffix : "")
			
			o_Containers.AA.Delete(this.AA.oSubMenu.AA.strMenuPath) ; remove old path from o_Containers
			this.AA.oSubMenu.AA.strMenuPath := strNewMenuPath ; update menu path
			o_Containers.AA[strNewMenuPath] := this.AA.oSubMenu ; add new path to o_Containers
			this.AA.strFavoriteLocation := StrReplace(strNewMenuPath, o_L["MainMenuName"] . " ") ; menu path without main menu localized name
			
			; update submenus (recursive)
			if (o_EditedFavorite.AA.strFavoriteType <> "Group") ; groups have no submenu
				for intKey, oItem in this.AA.oSubMenu.SA
					if oItem.IsContainer()
						oItem.UpdateMenusPathAndLocation(strNewMenuPath) ; RECURSIVE
				
			; Loop, % objEditedFavorite.SubMenu.MaxIndex()
				; if InStr("Menu|Group|External", objEditedFavorite.SubMenu[A_Index].FavoriteType, true)
					; RecursiveUpdateMenuPathAndLocation(objEditedFavorite.SubMenu[A_Index]
						; , objEditedFavorite.SubMenu.MenuPath . g_strMenuPathSeparatorWithSpaces . objEditedFavorite.SubMenu[A_Index].FavoriteName
						; . (objEditedFavorite.SubMenu[A_Index].FavoriteType = "Group" ? " " . g_strGroupIndicatorPrefix . g_strGroupIndicatorSuffix : "") ) ; RECURSIVE
		}
		;---------------------------------------------------------

		;---------------------------------------------------------
		CollectUsageDb()
		; add action to UsageDB
		;---------------------------------------------------------
		{
			if !(g_blnUsageDbEnabled)
				return
			
			Diag(A_ThisFunc, "", "START")
			
			strUsageMenuDateTime := A_Now
			strUsageDbMenuPath :=  A_ThisMenu ; remember this could be older value if favorite was launched by an hotkey
			strUsageDbMenuTrigger :=  A_ThisHotkey ; remember this could be older value if favorite was launched by a menu
			strUsageBdMenuAlternative := (g_blnAlternativeMenu ? g_strAlternativeMenu : "")
			
			strUsageDbMenuTargetClass := g_strTargetClass
			strUsageDbMenuHotkeyTypeDetected := g_strHotkeyTypeDetected
			strUsageDbMenuTargetAppName := this.aaTemp.strTargetAppName
			
			strUsageDbTargetPathExpanded := this.AA.strFavoriteLocation
			if InStr("|Folder|Special|Document|Application", "|" . this.AA.strFavoriteType)
				; for files, check if in path, check envars and relative path; strUsageDbTargetAttributes will be updated again in GetUsageDbTargetFileInfo
				strUsageDbTargetAttributes := FileExistInPath(strUsageDbTargetPathExpanded) ; FileExistInPath expands strUsageDbTargetPathExpanded and returns the file's atributes
			GetUsageDbTargetFileInfo((InStr("|Folder|Special|Document|Application", "|" . this.AA.strFavoriteType) ? strUsageDbTargetPathExpanded : "") ; setting 1st param empty makes remainings empty
				, strUsageDbTargetAttributes, strUsageDbTargetType, strUsageDbTargetDateTime, strUsageDbTargetExtension)
			
			if StrLen(strUsageDbTargetAttributes) or !InStr("Folder|Document|Application", "|" . this.AA.strFavoriteType) ; include Special even if no attributes
				; for Folder, Document and Application, file must exist, not for other types
			{
				strUsageDbMenuFavoriteType := this.AA.strFavoriteType
				strUsageDbMenuFavoriteName := this.AA.strFavoriteName
				strUsageDbMenuParameters := this.AA.strFavoriteArguments
				strUsageDbMenuStartIn := this.AA.strFavoriteAppWorkingDir
				strUsageDbMenuLaunchWith := this.AA.strFavoriteLaunchWith
				intUsageDbMenuLiveLevels := this.AA.intFavoriteFolderLiveLevels
				strUsageDbMenuIconResource := this.AA.strFavoriteIconResource
				strUsageDbMenuShortcut := this.AA.strFavoriteShortcut
				strUsageDbMenuHotstring := this.AA.strFavoriteHotstring
				strUsageDbMenuSoundLocation := this.AA.strFavoriteSoundLocation
				strUsageDbMenuDateCreated := this.AA.strFavoriteDateCreated
				strUsageDbMenuDateModified := this.AA.strFavoriteDateModified
				
				strUsageDbSQL := "INSERT INTO Usage ("
					. "TargetPath,TargetDateTime"
					. ",CollectType,CollectDateTime,CollectPath"
					. ",TargetAttributes,TargetType,TargetExtension"
					. ",MenuTrigger,MenuHotkeyTypeDetected,MenuAlternative,MenuTargetAppName,MenuTargetClass"
					. ",MenuFavoriteType,MenuFavoriteName,MenuOriginalLocation,MenuLiveLevels,MenuShortcut,MenuHotstring"
					. ",MenuIconResource,MenuParameters,MenuStartIn,MenuLaunchWith,MenuSoundLocation"
					. ",MenuDateCreated,MenuDateModified"
					. ") VALUES("
					; target file and date-time
					. "'" . EscapeQuote(strUsageDbTargetPathExpanded) . "'"
					. ",'" . ConvertUsageDbDateFormat(strUsageDbTargetDateTime) . "'"
					
					; collect type, time and menu path
					. ",'Menu'"
					. ",'" . ConvertUsageDbDateFormat(strUsageMenuDateTime) . "'"
					. ",'" . EscapeQuote(strUsageDbMenuPath) . "'"
					
					; target file info
					. ",'" . strUsageDbTargetAttributes . "'"
					. ",'" . strUsageDbTargetType . "'"
					. ",'" . EscapeQuote(strUsageDbTargetExtension) . "'"
					
					; QAP launch info
					. ",'" . EscapeQuote(strUsageDbMenuTrigger) . "'"
					. ",'" . strUsageDbMenuHotkeyTypeDetected . "'"
					. ",'" . EscapeQuote(strUsageBdMenuAlternative) . "'"
					. ",'" . EscapeQuote(strUsageDbMenuTargetAppName) . "'"
					. ",'" . EscapeQuote(strUsageDbMenuTargetClass) . "'"
					
					; QAP favorite info
					. ",'" . strUsageDbMenuFavoriteType . "'"
					. ",'" . EscapeQuote(strUsageDbMenuFavoriteName) . "'"
					. ",'" . EscapeQuote(g_objThisFavorite.FavoriteLocation) . "'" ; original location (before expanding)
					. ",'" . intUsageDbMenuLiveLevels . "'"
					. ",'" . EscapeQuote(strUsageDbMenuShortcut) . "'"
					. ",'" . EscapeQuote(strUsageDbMenuHotstring) . "'"
					
					. ",'" . EscapeQuote(strUsageDbMenuIconResource) . "'"
					. ",'" . EscapeQuote(strUsageDbMenuParameters) . "'"
					. ",'" . EscapeQuote(strUsageDbMenuStartIn) . "'"
					. ",'" . EscapeQuote(strUsageDbMenuLaunchWith) . "'"
					. ",'" . EscapeQuote(strUsageDbMenuSoundLocation) . "'"
					. ",'" . strUsageDbMenuDateCreated . "'"
					. ",'" . strUsageDbMenuDateModified . "'"
					. ");"
				
				if (g_blnUsageDbDebug)
					ToolTip, !!! %strUsageDbSQL%
				
				If !o_UsageDb.Exec(strUsageDbSQL)
				{
					Diag(A_ThisFunc, "SQLite INSERT ACTION Error: " . strUsageDbSQL, "STOP")
					Oops("SQLite INSERT ACTION Error`n`nMessage: " . o_UsageDb.ErrorMsg . "`n`nCode: " . o_UsageDb.ErrorCode . "`nQuery: " . strUsageDbSQL)
					g_blnUsageDbEnabled := false
					return
				}	
				if (g_blnUsageDbDebug)
				{
					Sleep, 2000
					ToolTip
				}
			}
			
			Diag(A_ThisFunc, "", "STOP")
		}
		;---------------------------------------------------------

		;---------------------------------------------------------
		GetUsageDbFavoriteUsage()
		; 2018-08-20 Take 1: one point per occurence of the location in usage (RecentItems or Menu)
		; 2019-05-19: converted to Item class mehod with logic as-is
		;---------------------------------------------------------
		{
			strGetUsageDbSQL := "SELECT COUNT(*) FROM Usage WHERE CollectDateTime >= date('now','-" . o_Settings.Database.intUsageDbDaysInPopular.IniValue . " day') "
				. "GROUP BY TargetPath COLLATE NOCASE HAVING TargetPath='" . EscapeQuote(item.AA.strFavoriteLocation) . "' COLLATE NOCASE;"
			if !o_UsageDb.Query(strGetUsageDbSQL, o_RecordSet)
			{
				Oops("Message: " . o_UsageDb.ErrorMsg . "`nCode: " . o_UsageDb.ErrorCode . "`nQuery: " . strGetUsageDbSQL)
				g_blnUsageDbEnabled := false
				return
			}
			o_RecordSet.Next(o_Row)
			intValue := o_Row[1] ; COUNT(*) is the first (and only) field
			o_RecordSet.Free()
			
			return intValue
		}
		;---------------------------------------------------------
		
/*
		;---------------------------------------------------------
		; Method()
		;---------------------------------------------------------
		; {
		; }
		;---------------------------------------------------------
*/
	}
	;-------------------------------------------------------------
	; === end of class Item ===

}
;---------------------------------------------------------
; === end of class Containers ===

;-------------------------------------------------------------
class Model
/*
TODO
*/

/*
class ClassName
	Methods
		- __New(): 
	Properties
		- :
	Instance variables
		- :
*/
;-------------------------------------------------------------
{
	; Instance variables
		; Instance variables are declared like normal assignments, but the this. prefix is omitted (only directly within the class body).
		; To access an instance variable (even within a method), always specify the target object; for example, this.InstanceVar
		
	; Static/Class Variables
		; Static/class variables belong to the class itself, but can be inherited by derived objects (including sub-classes).
		; They are declared like instance variables, but using the static keyword. Static declarations are evaluated only once, before the auto-execute section, in the order they appear in the script.
		; Each declaration stores a value in the class object. Any variable references in Expression are assumed to be global.
		; To assign to a class variable, always specify the class object; for example, ClassName.ClassVar := Value.
		; If an object x is derived from ClassName and x itself does not contain the key "ClassVar", x.ClassVar may also be used to dynamically retrieve the value of ClassName.ClassVar.
		
	;---------------------------------------------------------
	__Call(function, parameters*)
	; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
	{
		funcRef := Func(funcName := this.__class "." function)
		if CheckParameters(funcRef, function, parameters*) ; if everything is good call the function, else return false
			return funcRef.(this, parameters*) ; everything is good
		else
			return
	}
	;---------------------------------------------------------

	
	;---------------------------------------------------------
	__New()
	;---------------------------------------------------------
	{
	}
	;---------------------------------------------------------
	
	;---------------------------------------------------------
	Method()
	; Each method has a hidden parameter named this, which typically contains a reference to an object derived from the class.
	; Inside a method, the pseudo-keyword base can be used to access the super-class versions of methods or properties which are overridden in a derived class.
	;---------------------------------------------------------
	{
		
	}
	;---------------------------------------------------------
	
	;---------------------------------------------------------
	Property[]
	; obj.Property would call get while obj.Property := value would call set. Within get or set, this refers to the object being invoked. Within set, value contains the value being assigned.
	; https://autohotkey.com/docs/Objects.htm#Custom_Classes_property
	; Lexikos: "The "property" doesn't have a value - a "property" is a set of methods which are called when you get or set the property. Not all properties will store a value - some will compute it,
	; such as from a different property. For instance, a Colour object might have R, G, B and RBG properties, but the first three would be derived from the last one.
	; https://www.autohotkey.com/boards/viewtopic.php?t=9792#p54480
	;---------------------------------------------------------
	{
		get
		{
			return this._propertyname ; Lexikos: "One common convention is to use a single underscore for internal members, as in _propertyname. But it's just a convention."
		}
		set
		{
			return this._propertyname := value
		}
	}
	;---------------------------------------------------------

	;---------------------------------------------------------
	class NestedClass
	; Nested class definitions allow a class object to be stored inside another class object rather than a separate global variable.
	; In the example above, class NestedClass constructs an object and stores it in ClassName.NestedClass.
	;---------------------------------------------------------
	{
		;---------------------------------------------------------
		__Call(function, parameters*)
		; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
		{
			funcRef := Func(funcName := this.__class "." function)
			if CheckParameters(funcRef, function, parameters*) ; if everything is good call the function, else return false
				return funcRef.(this, parameters*) ; everything is good
			else
				return
		}
		;---------------------------------------------------------

		;-----------------------------------------------------
		__New()
		;-----------------------------------------------------
		{
		}
		;-----------------------------------------------------
		
	}
	;---------------------------------------------------------
}
;-------------------------------------------------------------

CheckParameters(funcRef, funcName, parameters*)
; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
{
	if (funcName = "_NewEnum")
		MsgBox, The __Call() is breaking For loops on the class object.
		
	if !IsObject(funcRef) ; check if function exists
		return CheckParametersMsg(funcName, "")
	
	maxIndexFixed := (parameters.MaxIndex() = "" ? 0 : parameters.MaxIndex()) ; if no parameter, MaxIndex() returns "" instead of 0
	
	if (maxIndexFixed < funcRef.MinParams-1) ; check if there are enough parameters
		return CheckParametersMsg(funcRef.Name, "few", parameters[1], maxIndexFixed, funcRef.MinParams-1, funcRef.MaxParams-1)
	
	if (maxIndexFixed > funcRef.MaxParams-1 && !funcRef.IsVariadic) ; check that there aren't too many parameters
		return CheckParametersMsg(funcRef.Name, "many", parameters[1], maxIndexFixed, funcRef.MinParams-1, funcRef.MaxParams-1)
	
	return true
}

CheckParametersMsg(funcName, fewOrMany, firstParam := "", nbPassed := "", minExpected := "", maxExpected := "")
; based on code from LinearSpoon https://www.autohotkey.com/boards/viewtopic.php?t=1435#p9133
{
	if StrLen(fewOrMany)
		Msgbox, 4, Error, % "Function: " . funcName
			. "`nError: too " . fewOrMany . " parameters"
			. (StrLen(firstParam) ? "`nFirst parameter: " . firstParam : "")
			. "`n`nNumber Passed: " . nbPassed
			. "`nExpected Min: " . minExpected
			. "`nExpected Max: " . maxExpected
			. "`n`nContinue?"
	else
		Msgbox, 4, Error, % "Function: " . funcName
			. "`nError: function does not exist"
			. "`n`nContinue?"
	
	IfMsgBox Yes
		return false
	else
		ExitApp
}

